[
   {
      "author_association" : "OWNER",
      "body" : "I believe this issue is identical to #11708. In order for signrawtransaction to sign a P2SH-P2WSH-multisig output, it needs to know both the P2WSH script and the P2SH script.",
      "created_at" : "2018-02-12T23:40:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365101240",
      "id" : 365101240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-12T23:40:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365101240",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "But it should be able to figure out the P2SH script, as explained by @NicolasDorier on Nov 20, 2017 (I can't figure out how to make a link to his specific comment).\r\n\r\nThe current fix for #11708 would require that I provide an additional script to `signrawtransaction`, but where do I get that script? It's not provided to me by `addmultisigaddress`. If I'm going to need it to sign transactions, then it should be. But I shouldn't need it.\r\n\r\nThere are only two possibilities: either it is legacy, or it is p2sh-segwit. Looking at the redeemScript and the scriptPubKey, it can figure out which one it is without being told.\r\n\r\nI still think my approach should work. I should not have to provide both scripts. I think I understand why it doesn't work today, but that is a bug, not a feature.",
      "created_at" : "2018-02-12T23:53:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365103690",
      "id" : 365103690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-12T23:53:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365103690",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
         "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
         "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinhodler",
         "id" : 31543633,
         "login" : "bitcoinhodler",
         "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinhodler"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "@bitcoinhodler In theory, yes, but that's not how the signing logic works at all. It sees a P2SH script, tries to find which redeemscript that hash corresponds to. If it finds that, it'll see a P2WSH program, and try to find which witness script the 256-bit hash corresponds to. If it finds that, it'll try to sign with it.\r\n\r\nYou're certainly right that right now the number of possible combinations is low, and it could just try all of them. I'm not convinced (either way) that this is the right approach though. It may become more complicated when more witness versions exist.\r\n\r\nIn any case, there's a clear shortcoming here and we should address it. `addmultisigaddress` should probbably return all redeemscripts involved, as just `listunspent` is not usable in your case (nor should it be needed).",
      "created_at" : "2018-02-12T23:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365104740",
      "id" : 365104740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-12T23:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365104740",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "What if there were a way to tell `signrawtransaction` that this redeemScript I'm providing is a p2sh-segwit type?\r\n\r\nAnother potential change that would make my ugly workaround less ugly: provide a JSON list of pubkeys from `decodescript`, in addition to the addresses provided today. Then I wouldn't have to parse the asm field to recreate the multisig address in the wallet.\r\n\r\nAnd another potential change that would help me: have `decodescript` show the p2sh-segwit address associated with the decoded script, in addition to today's p2sh address. That way I could figure out for myself (since I know the address) which of the two types it is.",
      "created_at" : "2018-02-13T00:10:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365106898",
      "id" : 365106898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-13T00:10:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365106898",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
         "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
         "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinhodler",
         "id" : 31543633,
         "login" : "bitcoinhodler",
         "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinhodler"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> What if there were a way to tell signrawtransaction that this redeemScript I'm providing is a p2sh-segwit type?\r\n\r\nThat sounds like a complexity the user shouldn't need to deal with. There should be a way to encapsulate all the information needed to sign (apart from the private key) out of addmultisigaddress and co, and pass it as a black box to signrawtransaction.\r\n\r\nI think either signrawtransaction should just infer it, or it comes in the form of a few more data fields to pass along.\r\n\r\n> Another potential change that would make my ugly workaround less ugly: provide a JSON list of pubkeys from decodescript, in addition to the addresses provided today. Then I wouldn't have to parse the asm field to recreate the multisig address in the wallet.\r\n\r\nI don't think decodescript is the best place for this. Giving information about arbitrary scripts will likely become increasingly difficult as more private scripting techniques appear. The right place to analyse a particular script is by the person who created it. It can either come as a side effect out of `addmultisigaddress`. In 0.16, `validateaddress` on any address you created yourself will also include a full analysis, including redeemscripts and public keys used.\r\n",
      "created_at" : "2018-02-13T00:29:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365110188",
      "id" : 365110188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-13T00:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365110188",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Could you try if this fixes things for you? It should make `signrawtransaction` deal with multisig script where only the inner redeemscript is passed (untested).\r\n\r\n```diff\r\n--- a/src/rpc/rawtransaction.cpp\r\n+++ b/src/rpc/rawtransaction.cpp\r\n@@ -848,6 +848,8 @@ UniValue signrawtransaction(const JSONRPCRequest& request)\r\n                     std::vector<unsigned char> rsData(ParseHexV(v, \"redeemScript\"));\r\n                     CScript redeemScript(rsData.begin(), rsData.end());\r\n                     tempKeystore.AddCScript(redeemScript);\r\n+                    // Automatically also add the P2WSH wrapped version of the script (to deal with P2SH-P2WSH).\r\n+                    tempKeystore.AddCScript(GetScriptForWitness(redeemScript));\r\n                 }\r\n             }\r\n         }\r\n```\r\n",
      "created_at" : "2018-02-13T00:47:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365113558",
      "id" : 365113558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-13T00:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365113558",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I went ahead and implemented the \"ugly\" workaround I originally suggested, and it's not as ugly as I feared. I do have to parse the asm field of the decoded script, and then I run `addmultisigaddress` twice: once with type 'legacy' and once with 'p2sh-segwit' (since I don't know which type the user has provided me). After that, assuming I've used `importprivkey` with enough keys, `signrawtransaction` works without complaint for both types of scripts.\r\n\r\nMy immediate problem is solved, but it seems there's a usability or documentation issue here, at the very least.",
      "created_at" : "2018-02-13T08:06:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365181106",
      "id" : 365181106,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-13T08:06:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365181106",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
         "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
         "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinhodler",
         "id" : 31543633,
         "login" : "bitcoinhodler",
         "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinhodler"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Just saw your suggested patch; I tried it and it does indeed solve my original issue.",
      "created_at" : "2018-02-13T08:12:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-365182279",
      "id" : 365182279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-13T08:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365182279",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
         "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
         "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinhodler",
         "id" : 31543633,
         "login" : "bitcoinhodler",
         "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinhodler"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I confirm this is now fixed in v0.16.0.",
      "created_at" : "2018-02-28T18:36:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418#issuecomment-369338010",
      "id" : 369338010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
      "updated_at" : "2018-02-28T18:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369338010",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
         "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
         "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinhodler",
         "id" : 31543633,
         "login" : "bitcoinhodler",
         "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinhodler"
      }
   }
]
