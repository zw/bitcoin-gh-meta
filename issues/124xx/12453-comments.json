[
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery The test uses some for loops, which make it extremely hard to deduce where the test failed.\r\n\r\nI'd suggest adding log statements within the for loops to have \"hard sync points\" in the combined debug log. Alternatively the for loop (https://github.com/bitcoin/bitcoin/blob/cead84b72d27517338ac3c49eaaed4db07352f41/test/functional/p2p_sendheaders.py#L382) could be split up into two function calls, passing `j` as the argument.",
      "created_at" : "2018-03-22T22:04:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12453#issuecomment-375472594",
      "id" : 375472594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12453",
      "updated_at" : "2018-03-22T22:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/375472594",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, logging could be improved here (simplest would be to just add log statements into the for loops). More radically, the test could be refactored to make each of the different test parts a separate method, and have logging each time those methods are entered.\r\n\r\nIn this case, it's not too difficult to track down which iteration we're in, by looking back to the previous log message (\"Part 3: headers announcements can stop after large reorg, and resume after headers/inv from peer...\") and then following the test logic downwards. I can see that we're in the first iteration of the for loop, and we're failing because `check_last_announcement()` on line 387 expects all 8 of the new headers to be announced in a single headers message. In the logs, I see that the node is actually announcing the headers in one headers message with 6 headers, and a second headers message with 2 headers:\r\n\r\n```\r\nnode0 2018-02-16 16:58:36.332323 SendMessages: 6 headers, range (23e5e7b1881996f8d6314f6e686bea8a2f370a79ec2b7bee950b18d88aa32a03, 46a36091bd29305f54fed32c0ef0a58e220efe4d875ec41180d42c149c328419), to peer=3 \r\n...\r\n node0 2018-02-16 16:58:36.334079 SendMessages: 2 headers, range (30a187a89de33c170b4c2c30f315c72d20f81061d2aeb022b63f08c02383a71d, 5ad6f44f33f1527d9ec7d711209698135aadff73e786052175f9460b73b56633), to peer=3\r\n```\r\n\r\nI think it's perfectly legal for the node to send the new headers across multiple P2P messages, so we need to update `check_last_announcement()` to be tolerant of this. I expect we only hit this on travis due to timing windows.",
      "created_at" : "2018-03-23T19:56:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12453#issuecomment-375781183",
      "id" : 375781183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12453",
      "updated_at" : "2018-03-23T19:56:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/375781183",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Only thing left to do is:\r\n\r\n> I think it's perfectly legal for the node to send the new headers across multiple P2P messages, so we need to update check_last_announcement() to be tolerant of this. I expect we only hit this on travis due to timing windows.",
      "created_at" : "2018-04-11T20:15:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12453#issuecomment-380581531",
      "id" : 380581531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12453",
      "updated_at" : "2018-04-11T20:15:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/380581531",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think logging could still be improved as well. #12849 doesn't seem like much of an improvement.",
      "created_at" : "2018-04-11T20:16:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12453#issuecomment-380581887",
      "id" : 380581887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12453",
      "updated_at" : "2018-04-11T20:16:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/380581887",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
