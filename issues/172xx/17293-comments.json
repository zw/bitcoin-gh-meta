[
   {
      "author_association" : "MEMBER",
      "body" : "In the short term, asserting is probably best. The function is simply not intended to be called with argument 0.\r\n\r\nPerhaps longer term it would make sense to (also?) have a function that takes a `max` (and optionally a `min`?) argument, and returns something in that range, inclusive. The advantage is that  it can be used for any range, including up to the limit.",
      "created_at" : "2019-10-29T00:11:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547199890",
      "id" : 547199890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzE5OTg5MA==",
      "updated_at" : "2019-10-29T00:11:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547199890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nNice find!\r\n\r\n@JeremyRubin Have you checked the call sites for the possibility of any of them calling `randrange` with argument `0`?",
      "created_at" : "2019-10-29T09:38:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547335660",
      "id" : 547335660,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzMzNTY2MA==",
      "updated_at" : "2019-10-29T09:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547335660",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/blob/badca85e2c0bf1720fca8a516adbf4b3f1d7e4d9/src/net_processing.cpp#L946-L953\r\n\r\n`g_orphan_list.size() == 0` is impossible here?",
      "created_at" : "2019-10-29T10:49:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547362569",
      "id" : 547362569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzM2MjU2OQ==",
      "updated_at" : "2019-10-29T10:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547362569",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin After taking a quick look at the various direct and indirect users of `randrange` I'm not certain that there are no code paths where `randrange(0)` could be called.\r\n\r\nNote that `GetRand`, `GetRandInt` and `Shuffle` all use `randrange` under the hood.\r\n\r\nThis can be used to analyse the call sites:\r\n\r\n```\r\n$ git grep -E '(randrange|GetRand|GetRandInt|Shuffle)\\(' -- \"*.cpp\" \"*.h\"\r\n```\r\n\r\nAdding `assert(range);` in `randrange` feels a bit risky given its direct and indirect call sites.\r\n\r\nPerhaps `ASSUME(range);` would be appropriate to start with?\r\n\r\nGiven `--enable-debug` or `--enable-fuzzers` then `ASSUME(condition);` fails fatally if `condition` does not hold.\r\n\r\nYou can cherry-pick in `ASSUME(â¦);` from PR #16136.",
      "created_at" : "2019-10-29T11:05:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547368314",
      "id" : 547368314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzM2ODMxNA==",
      "updated_at" : "2019-10-29T11:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547368314",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Seems reasonable for now, ACK https://github.com/bitcoin/bitcoin/pull/17293/commits/a35b6824f3a0bdb68c5aef599c0f17562689970e",
      "created_at" : "2019-10-29T16:13:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547503033",
      "id" : 547503033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzUwMzAzMw==",
      "updated_at" : "2019-10-29T16:13:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547503033",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@practicalswift I did in fact check. The issue came up while I was testing #17292, I accidentally put in randrange(vec.size()) somewhere, and it had the nice effect of crashing my computer :)\r\n\r\nThis lead me to check the rest of the codebase, including that example in net_processing. I did think it was a bug at first, but I think the loops pre-conditions (mapOrphanTransactions.size() > 0 && for every element in mapOrphans there is one in g_orphan_list) imply g_orphan_list.size() != 0.\r\n\r\nI checked the others and they also have pre-conditions that make 0 impossible. edit: I didn't check the tests, just the program code.\r\n\r\n\r\n\r\nI think you are incorrect that assert in randrange is dangerous. It's the other way around: returning a too-big number is dangerous, as it can lead to entire system crashes (as in on my system) as opposed to graceful panics or it can lead to random memory probing and leaking secrets. We should improve all the call sites and maybe do the range projection as sipa notes, but we should not ever return something outside the specified output, even if that means crashing. ",
      "created_at" : "2019-10-29T16:48:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547520500",
      "id" : 547520500,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzUyMDUwMA==",
      "updated_at" : "2019-10-29T16:49:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547520500",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think you are incorrect that assert in randrange is dangerous. It's the other way around: returning a too-big number is dangerous, as it can lead to entire system crashes (as in on my system) as opposed to graceful panics or it can lead to random memory probing and leaking secrets.\r\n\r\nI think it depends on the call site. You're correct in that for some of the call sites an assertion failure is clearly preferable (if we were to trigger this condition) :)",
      "created_at" : "2019-10-29T18:07:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547556964",
      "id" : 547556964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzU1Njk2NA==",
      "updated_at" : "2019-10-29T18:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547556964",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this is a good place for an assertion. Returning anything else is unsafe.\r\nACK a35b6824f3a0bdb68c5aef599c0f17562689970e",
      "created_at" : "2019-10-30T15:29:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17293#issuecomment-547964796",
      "id" : 547964796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17293",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0Nzk2NDc5Ng==",
      "updated_at" : "2019-10-30T15:29:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547964796",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
