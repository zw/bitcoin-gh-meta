[
   {
      "body" : "Apparently attempting to check the checkbox is unnecessary. All that I need to do is open the settings when UPnP is already enabled, wait a moment, and then get the segfault above.",
      "created_at" : "2011-04-14T05:41:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-999354",
      "id" : 999354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-14T05:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "It keeps getting better and better.. All I need to do now is leave the bitcoin client running on the main screen without even opening the settings, and it segfaults as above within a minute.",
      "created_at" : "2011-04-14T05:48:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-999364",
      "id" : 999364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-14T05:48:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "net.cpp:940 gets called when no router/UPnP port mapping device has been found.  I don't know what the UI could have to do with this.  Is it possible the box (un)checking timing lining up just happened to be a coincidence?\r\nAlso, do you have UPnP on on your router when this happens?",
      "created_at" : "2011-04-14T21:51:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1003902",
      "id" : 1003902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-14T21:51:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Yup, I think clicking the UI checkbox has nothing to do with it, since the segfault occurs if the client just sits there for a while doing nothing (see my comment above).\r\n\r\nUPnP is enabled on my router, but no port forwards are enabled.",
      "created_at" : "2011-04-15T06:10:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1005355",
      "id" : 1005355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-15T06:10:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "Hm, I can't reproduce.  What router are you using (do you happen to know what UPnP library it is using?)\nDoes the miniupnpc example client work (it comes with miniupnpc, upnpc_static/shared, try it with -a your internal IPv4 8333 8333 tcp)",
      "created_at" : "2011-04-15T08:32:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1005738",
      "id" : 1005738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-15T08:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "My Linksys WRT54GL router is running dd-wrt. I'm not sure what UPnP library it's using. Interestingly, upnpc doesn't appear to find the router:\n\n    $ ./upnpc-static -a 10.0.0.2 8333 8333 tcp\n    upnpc : miniupnpc library test client. (c) 2006-2010 Thomas Bernard\n    Go to http://miniupnp.free.fr/ or http://miniupnp.tuxfamily.org/\n    for more information.\n    No IGD UPnP Device found on the network !\n\nBut then I disabled my local firewall, and I get this:\n\n    $ ./upnpc-static -a 10.0.0.2 8333 8333 tcp\n    upnpc : miniupnpc library test client. (c) 2006-2010 Thomas Bernard\n    Go to http://miniupnp.free.fr/ or http://miniupnp.tuxfamily.org/\n    for more information.\n    List of UPNP devices found on the network :\n     desc: http://10.0.0.1:5431/dyndev/uuid:0022-6b8c-XX\n     st: urn:schemas-upnp-org:device:InternetGatewayDevice:1\n\n    Found valid IGD : http://10.0.0.1:5431/uuid:0022-6b8c-XX/WANIPConnection:1\n    Local LAN ip address : 10.0.0.2\n    ExternalIPAddress = XX.YY.ZZ.114\n    InternalIP:Port = 10.0.0.2:8333\n    external XX.YY.ZZ.114:8333 TCP is redirected to internal 10.0.0.2:8333\n\n(IPs masked.) So then I tried bitcoin again.. No crash, even after leaving it running for a while! I then stopped bitcoin, re-enabled my firewall, and restarted bitcoin. Sure enough, bitcoin crashed quite reliably within a few seconds.\n\nSo the segfault appears to occur when using UPnP with a firewall that prevents UPnP packets from being sent.\n\nThe firewall configuration is a pretty standard iptables setup. Outgoing-initiated connections are allowed. Most incoming packets are dropped. Packets for existing connections are allowed.",
      "created_at" : "2011-04-15T15:52:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1008472",
      "id" : 1008472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-15T16:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1008472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "Hm, I still can't seem to reproduce this issue.  Can you narrow it down to one individual or set of iptables rules?",
      "created_at" : "2011-04-15T22:39:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1011176",
      "id" : 1011176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-15T22:39:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "If I add a rule to just drop all input packets, and then I start bitcoin, that will trigger the segfault: \r\n\r\n    $ sudo iptables -F\r\n    $ sudo iptables -A INPUT -j DROP\r\n    $ sudo iptables -L -v\r\n    Chain INPUT (policy ACCEPT 1350 packets, 1561K bytes)\r\n     pkts bytes target     prot opt in     out     source               destination      \r\n       69  4595 DROP       all  --  any    any     anywhere             anywhere         \r\n\r\n    Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)\r\n     pkts bytes target     prot opt in     out     source               destination      \r\n\r\n    Chain OUTPUT (policy ACCEPT 1134 packets, 224K bytes)\r\n     pkts bytes target     prot opt in     out     source               destination      \r\n\r\n    Chain fail2ban-ssh (0 references)\r\n     pkts bytes target     prot opt in     out     source               destination      \r\n\r\nAnd then if I remove the drop rule and start bitcoin, no segfault.",
      "created_at" : "2011-04-16T01:49:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1011583",
      "id" : 1011583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T01:49:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "Still cannot reproduce, maybe someone else can?\r\nDo you still get the segfault if you comment out net.cpp:940 (FreeUPNPUrls(&urls), probably creating a memleak)?",
      "created_at" : "2011-04-16T09:34:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1012191",
      "id" : 1012191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T09:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Yes, commenting out that line does prevent the segfault from occurring.",
      "created_at" : "2011-04-16T17:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1014324",
      "id" : 1014324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T17:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "I updated to commit bf3a0902ef98365d803e4a03853dbf0f83511026 and the segfault still occurs.",
      "created_at" : "2011-04-16T17:52:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1014371",
      "id" : 1014371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T17:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "I think I found the problem. At net.cpp:909, UPNP_GetValidIGD() is called to, among other things, initialize the urls parameter. The documentation for miniupnpc.c's UPNP_GetValidIGD() is as follows:\r\n\r\n    /* UPNP_GetValidIGD() :\r\n     * return values :\r\n     *     0 = NO IGD found\r\n     *     1 = A valid connected IGD has been found\r\n     *     2 = A valid IGD has been found but it reported as\r\n     *         not connected\r\n     *     3 = an UPnP device has been found but was not recognized as an IGD\r\n     *\r\n     * In any non zero return case, the urls and data structures\r\n     * passed as parameters are set. Donc forget to call FreeUPNPUrls(urls) to\r\n     * free allocated memory.\r\n     */\r\n\r\nTo me, that suggests that we should only call FreeUPNPUrls(urls) if the UPNP_GetValidIGD() return value is non-zero. However at net.cpp:940, we're calling FreeUPNPUrls(urls) if UPNP_GetValidIGD() returns any value other than 1. And I confirmed that on my machine, with the firewall on, the return value is zero.\r\n\r\nBecause urls is uninitialized at the time FreeUPNPUrls(urls) is called, it's probably trying to free garbage pointers and thus causing a segfault.",
      "created_at" : "2011-04-16T18:32:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1014505",
      "id" : 1014505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T18:32:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17146?v=3",
         "events_url" : "https://api.github.com/users/witten/events{/privacy}",
         "followers_url" : "https://api.github.com/users/witten/followers",
         "following_url" : "https://api.github.com/users/witten/following{/other_user}",
         "gists_url" : "https://api.github.com/users/witten/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/witten",
         "id" : 17146,
         "login" : "witten",
         "organizations_url" : "https://api.github.com/users/witten/orgs",
         "received_events_url" : "https://api.github.com/users/witten/received_events",
         "repos_url" : "https://api.github.com/users/witten/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/witten/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/witten/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/witten"
      }
   },
   {
      "body" : "Looks good to me, added a pull request for that and one other small thing at https://github.com/bitcoin/bitcoin/pull/165",
      "created_at" : "2011-04-16T20:01:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-1014743",
      "id" : 1014743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2011-04-16T20:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I think this bug may have returned -- at least, as of commit 93193c8ff, I'm getting a new seg fault on line 1164 of src/net.cpp, inside this call:\r\n\r\n    FreeUPNPUrls(&urls);\r\n\r\nIn GDB, the value pointed to by `urls` as of the seg fault is:\r\n\r\n    {controlURL = 0x0, ipcondescURL = 0x0, controlURL_CIF = 0x0, controlURL_6FC = 0x0}\r\n\r\nPossibly they're just all NULL because they've already been correctly free()'d by that point?  Or, the problem is that they're all NULL when free()'ing is attempted -- this seems more likely, from what I can see so far.  According to the docs for UPNP_GetValidIGD(), which filled in `urls`, if the function's return value is non-zero, then FreeUPNPUrls() should be called on `urls` later.  Well, we're in the case where the return value is 1 (see `r ==1` conditional earlier in the code), but  FreeUPNPUrls() is definitely not happy, because it is calling free() on an invalid pointer.\r\n\r\nUnfortunately I don't have the libminiupnpc sources at hand, otherwise I'd dig in further, but FWIW the stack trace is:\r\n\r\n    #0  0x00007ffff3827077 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\r\n    #1  0x00007ffff3828458 in __GI_abort () at abort.c:89\r\n    #2  0x00007ffff3864fb4 in __libc_message (do_abort=do_abort@entry=1, fmt=fmt@entry=0x7ffff3957bc0 \"*** Error in `%s': %s: 0x%s ***\\n\") at ../sysdeps/posix/libc_fatal.c:175\r\n    #3  0x00007ffff386a78e in malloc_printerr (action=1, str=0x7ffff3953c7e \"free(): invalid pointer\", ptr=<optimized out>) at malloc.c:4996\r\n    #4  0x00007ffff386b496 in _int_free (av=<optimized out>, p=<optimized out>, have_lock=0) at malloc.c:3840\r\n    #5  0x00007ffff45c5df4 in FreeUPNPUrls () from /usr/lib/x86_64-linux-gnu/libminiupnpc.so.10\r\n    #6  0x0000555555740a7d in ThreadMapPort () at net.cpp:1164\r\n    #7  0x000055555574f1a0 in TraceThread<void (*)()> (name=0x555555903278 \"upnp\", func=0x555555740660 <ThreadMapPort()>) at util.h:207\r\n    #8  0x00007ffff75455ba in ?? () from /usr/lib/x86_64-linux-gnu/libboost_thread.so.1.55.0\r\n    #9  0x00007ffff52140a4 in start_thread (arg=0x7fff99ee2700) at pthread_create.c:309\r\n    #10 0x00007ffff38d7c2d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111\r\n\r\nOne possible clue:\r\n\r\nEarlier in net.cpp:ThreadMapPort(), `devlist` is allocated in this call:\r\n\r\n    #ifndef UPNPDISCOVER_SUCCESS\r\n        /* miniupnpc 1.5 */\r\n        devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0);\r\n    #else\r\n        /* miniupnpc 1.6 */\r\n        int error = 0;\r\n        devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\r\n    #endif\r\n\r\nMy system (Debian GNU/Linux testing distro) appears to have libminiupnpc 1.9, which corresponds to the inaccurately-labeled \"miniupnpc 1.6\" case above.  In that case, an `error` pointer is passed, but is never checked.  Is it possible that if something goes wrong with upnpDiscover(), then later when we pass the resultant `devlist` pointer as the first argument to UPNP_GetValidIGD(), there is something wrong with `devlist` and thus with the results of UPNP_GetValidIGD()?\r\n\r\nI don't have time to debug further right now.  I'll try to look more into it, as soon as I get a chance to build latest libminiupnpc from source and rebuild bitcoin (with full debugging info) against it.  In the meantime, I hope this report helps.\r\n\r\n-Karl",
      "created_at" : "2014-09-07T05:00:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-54737468",
      "id" : 54737468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2014-09-07T05:10:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54737468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/401111?v=3",
         "events_url" : "https://api.github.com/users/kfogel/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kfogel/followers",
         "following_url" : "https://api.github.com/users/kfogel/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kfogel/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kfogel",
         "id" : 401111,
         "login" : "kfogel",
         "organizations_url" : "https://api.github.com/users/kfogel/orgs",
         "received_events_url" : "https://api.github.com/users/kfogel/received_events",
         "repos_url" : "https://api.github.com/users/kfogel/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kfogel/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kfogel/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kfogel"
      }
   },
   {
      "body" : "Okay, bug goes away with latest libminiupnpc-dev.  See https://github.com/bitcoin/bitcoin/issues/4861#issuecomment-54751887 for details.",
      "created_at" : "2014-09-07T16:31:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-54751914",
      "id" : 54751914,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2014-09-07T16:31:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54751914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/401111?v=3",
         "events_url" : "https://api.github.com/users/kfogel/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kfogel/followers",
         "following_url" : "https://api.github.com/users/kfogel/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kfogel/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kfogel",
         "id" : 401111,
         "login" : "kfogel",
         "organizations_url" : "https://api.github.com/users/kfogel/orgs",
         "received_events_url" : "https://api.github.com/users/kfogel/received_events",
         "repos_url" : "https://api.github.com/users/kfogel/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kfogel/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kfogel/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kfogel"
      }
   },
   {
      "body" : "Thanks for reporting this and figuring this out. At least when someone else stumbles on the problem they'll have a place to look.",
      "created_at" : "2014-09-08T07:06:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/156#issuecomment-54783141",
      "id" : 54783141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/156",
      "updated_at" : "2014-09-08T07:06:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54783141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
