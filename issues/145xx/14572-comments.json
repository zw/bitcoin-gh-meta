[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There is some prior discussion about this in another issue, starting at https://github.com/bitcoin/bitcoin/issues/14538#issuecomment-433011130\r\n\r\nI think even with recent fix #14320 for detecting attempts to load already loaded wallets, there are still going to be race conditions and crashes if clients are loading and unloading wallets simultaneously, because underlying code wasn't written to handle this and doesn't have appropriate locking.\r\n\r\nI think incremental fixes are probably possible, but a more comprehensive fix might force all database accesses to go through the `BerkeleyDatabase` object instead of bypassing it with `BerkeleyEnvironment` objects and raw path arguments. I think this could be implemented by:\r\n\r\n1. Changing Verify/Salvage/Recover methods that currently use raw paths and envs to take `BerkeleyDatabase` arguments instead, and constructing `BerkeleyDatabase` earlier before calling them.\r\n\r\n2. Building on 9c945d011abde24f8649d877e694d392e1a5727e from #14552, and having `BerkeleyDatabase` constructor acquire cs_db before inserting itself into the global map, so it not possible to have a race condition that creates conflicting `BerkeleyDatabase` instances.\r\n\r\nAs follow-on cleanup, the changes to Verify/Salvage/Recover should also allow `mapFileUseCount` and `m_fileids` maps to be eliminated and replaced with `BerkeleyDatabase` data members.",
      "created_at" : "2018-10-25T15:08:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433088662",
      "id" : 433088662,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzA4ODY2Mg==",
      "updated_at" : "2018-10-25T15:08:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433088662",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've changed `test/functional/wallet_multiwallet.py` to reproduce the crash with no success:\r\n```py\r\n        while True:\r\n            self.nodes[0].unloadwallet('w1')\r\n            self.nodes[0].loadwallet('w1')\r\n```\r\n",
      "created_at" : "2018-10-25T15:14:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433090945",
      "id" : 433090945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzA5MDk0NQ==",
      "updated_at" : "2018-10-25T15:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433090945",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> \r\n> \r\n> I've changed `test/functional/wallet_multiwallet.py` to reproduce the crash with no success:\r\n> \r\n> ```python\r\n>         while True:\r\n>             self.nodes[0].unloadwallet('w1')\r\n>             self.nodes[0].loadwallet('w1')\r\n> ```\r\n\r\nI am not sure about this test but I am pretty sure it crashes when a request is sent to load a wallet while it is already in process of loading from a previous request",
      "created_at" : "2018-10-25T15:16:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433091829",
      "id" : 433091829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzA5MTgyOQ==",
      "updated_at" : "2018-10-25T15:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433091829",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/11485189?v=4",
         "events_url" : "https://api.github.com/users/furqansiddiqui/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furqansiddiqui/followers",
         "following_url" : "https://api.github.com/users/furqansiddiqui/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furqansiddiqui/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furqansiddiqui",
         "id" : 11485189,
         "login" : "furqansiddiqui",
         "node_id" : "MDQ6VXNlcjExNDg1MTg5",
         "organizations_url" : "https://api.github.com/users/furqansiddiqui/orgs",
         "received_events_url" : "https://api.github.com/users/furqansiddiqui/received_events",
         "repos_url" : "https://api.github.com/users/furqansiddiqui/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furqansiddiqui/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furqansiddiqui/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furqansiddiqui"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furqansiddiqui you mean concurrent `loadwallet` calls? A quick fix is to prevent that, I can create a branch with that so you can test.",
      "created_at" : "2018-10-25T19:20:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433173849",
      "id" : 433173849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzE3Mzg0OQ==",
      "updated_at" : "2018-10-25T19:20:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433173849",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "concurrent loadwallet calls is what it is I believe, yes please let me know when to test, which branch",
      "created_at" : "2018-10-26T06:27:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433300647",
      "id" : 433300647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzMwMDY0Nw==",
      "updated_at" : "2018-10-26T06:27:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433300647",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/11485189?v=4",
         "events_url" : "https://api.github.com/users/furqansiddiqui/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furqansiddiqui/followers",
         "following_url" : "https://api.github.com/users/furqansiddiqui/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furqansiddiqui/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furqansiddiqui",
         "id" : 11485189,
         "login" : "furqansiddiqui",
         "node_id" : "MDQ6VXNlcjExNDg1MTg5",
         "organizations_url" : "https://api.github.com/users/furqansiddiqui/orgs",
         "received_events_url" : "https://api.github.com/users/furqansiddiqui/received_events",
         "repos_url" : "https://api.github.com/users/furqansiddiqui/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furqansiddiqui/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furqansiddiqui/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furqansiddiqui"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furqansiddiqui try this https://github.com/promag/bitcoin/tree/2010-10-loadunloadwallet",
      "created_at" : "2018-10-26T07:22:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-433312606",
      "id" : 433312606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMzMxMjYwNg==",
      "updated_at" : "2018-10-26T07:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/433312606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furqansiddiqui ping.",
      "created_at" : "2018-11-21T23:37:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572#issuecomment-440850709",
      "id" : 440850709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MDg1MDcwOQ==",
      "updated_at" : "2018-11-21T23:37:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/440850709",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
