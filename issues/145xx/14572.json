{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "**Describe the issue**\r\n\r\nMultiple RPC commands to loadwallet crashes daemon without any trace/log. In my implementation, a wallet is dynamically loaded and then released/unloaded at the end of request, the problem arises when 2 or more async requests are sent which calls loadwallet via RPC but daemon is crashed possibly because wallet is in process of being loaded and in meanwhile it receives another request to loadwallet again.\r\n\r\n(RPC specifically because when working in stateless environments i.e. web based apps, users are able to send multiple requests without having to wait for previous requests to finish)\r\n\r\nnote: I have tested and attempted to debug using few methods to find whether crash occurs when requesting to load same wallet too quickly OR multiple wallets too quickly, and so far I merely think daemon crashes on same wallet but this information may not be reliable enough\r\n\r\nHere are logs of successful op, loading wallets alternatively:\r\n\r\n> 2018-10-25T14:37:50Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n> 2018-10-25T14:37:50Z Using wallet wallet.dat\r\n> 2018-10-25T14:37:50Z init message: Loading wallet...\r\n> 2018-10-25T14:37:50Z [wallet1] nFileVersion = 179900\r\n> 2018-10-25T14:37:50Z [wallet1] Keys: 0 plaintext, 4035 encrypted, 4035 w/ metadata, 4035 total. Unknown wallet records: 1\r\n> 2018-10-25T14:37:50Z [wallet1] Wallet completed loading in              45ms\r\n> 2018-10-25T14:37:50Z [wallet1] setKeyPool.size() = 1999\r\n> 2018-10-25T14:37:50Z [wallet1] mapWallet.size() = 15\r\n> 2018-10-25T14:37:50Z [wallet1] mapAddressBook.size() = 34\r\n> 2018-10-25T14:37:50Z [wallet1] Releasing wallet\r\n> 2018-10-25T14:37:50Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n> 2018-10-25T14:37:50Z Using wallet wallet.dat\r\n> 2018-10-25T14:37:50Z init message: Loading wallet...\r\n> 2018-10-25T14:37:50Z [wallet2] nFileVersion = 170000\r\n> 2018-10-25T14:37:50Z [wallet2] Keys: 0 plaintext, 4002 encrypted, 4002 w/ metadata, 4002 total. Unknown wallet records: 1\r\n> 2018-10-25T14:37:50Z [wallet2] Wallet completed loading in              62ms\r\n> 2018-10-25T14:37:50Z [wallet2] setKeyPool.size() = 2000\r\n> 2018-10-25T14:37:50Z [wallet2] mapWallet.size() = 0\r\n> 2018-10-25T14:37:50Z [wallet2] mapAddressBook.size() = 0\r\n> 2018-10-25T14:37:50Z [wallet2] Releasing wallet\r\n> 2018-10-25T14:37:50Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n> 2018-10-25T14:37:50Z Using wallet wallet.dat\r\n> 2018-10-25T14:37:50Z init message: Loading wallet...\r\n> 2018-10-25T14:37:50Z [wallet1] nFileVersion = 179900\r\n> 2018-10-25T14:37:50Z [wallet1] Keys: 0 plaintext, 4035 encrypted, 4035 w/ metadata, 4035 total. Unknown wallet records: 1\r\n> 2018-10-25T14:37:50Z [wallet1] Wallet completed loading in              77ms\r\n> 2018-10-25T14:37:50Z [wallet1] setKeyPool.size() = 1999\r\n> 2018-10-25T14:37:50Z [wallet1] mapWallet.size() = 15\r\n> 2018-10-25T14:37:50Z [wallet1] mapAddressBook.size() = 34\r\n> 2018-10-25T14:37:50Z [wallet1] Releasing wallet\r\n\r\nplease notice time stamps.\r\n\r\nand here is log before crash, when I requests were send to load \"a same\" wallet\r\n\r\n> 2018-10-25T14:40:22Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n> 2018-10-25T14:40:22Z Using wallet wallet.dat\r\n> 2018-10-25T14:40:22Z init message: Loading wallet...\r\n> 2018-10-25T14:40:22Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n> 2018-10-25T14:40:22Z Using wallet wallet.dat\r\n\r\n*crashed* RIP\r\n\r\n**What behavior did you expect?**\r\n\r\n* Daemon to not crash and produce an error message via RPC so implementing apps can make necessary adjustments in their logic and flow\r\n\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572/comments",
   "created_at" : "2018-10-25T14:44:27Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/14572",
   "id" : 373984255,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUzNzM5ODQyNTU=",
   "number" : 14572,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Crash with loading wallet async via RPC",
   "updated_at" : "2018-10-26T07:22:23Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14572",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/11485189?v=4",
      "events_url" : "https://api.github.com/users/furqansiddiqui/events{/privacy}",
      "followers_url" : "https://api.github.com/users/furqansiddiqui/followers",
      "following_url" : "https://api.github.com/users/furqansiddiqui/following{/other_user}",
      "gists_url" : "https://api.github.com/users/furqansiddiqui/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/furqansiddiqui",
      "id" : 11485189,
      "login" : "furqansiddiqui",
      "node_id" : "MDQ6VXNlcjExNDg1MTg5",
      "organizations_url" : "https://api.github.com/users/furqansiddiqui/orgs",
      "received_events_url" : "https://api.github.com/users/furqansiddiqui/received_events",
      "repos_url" : "https://api.github.com/users/furqansiddiqui/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/furqansiddiqui/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/furqansiddiqui/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/furqansiddiqui"
   }
}
