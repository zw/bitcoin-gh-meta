{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Running `p2p_invalid_messages.py` on its own shows a passing test, but it can fail when its run by `test_runner.py`. This is because test_runner checks for an empty stderr and we have some exceptions from the asyncio event loop that aren't caught in our code.\r\n\r\nThe test does a send after we know the socket would have been closed so that any kind of RST will be realized and the connection is closed officially on our end; however, if the the extra send we do is done after the kernel has already ~acknowledged~ started the close, the send error is only caught during asyncio's asynchronous write buffer flushing task and the exception is printed to stderr.\r\n\r\n```\r\n1/1 - p2p_invalid_messages.py failed, Duration: 6 s\r\n\r\nstdout:\r\n2019-02-13T20:21:33.270000Z TestFramework (INFO): Initializing test directory /var/folders/y0/l8_5z4393lg2qlwdjc11n9380000gn/T/test_runner_â¿_ð_20190213_142133/p2p_invalid_messages_0\r\n2019-02-13T20:21:34.068000Z TestFramework (INFO): Sending a bunch of large, junk messages to test memory exhaustion. May take a bit...\r\n2019-02-13T20:21:37.903000Z TestFramework (INFO): Waiting for node to drop junk messages.\r\n2019-02-13T20:21:38.011000Z TestFramework.mininode (WARNING): Connection lost to 127.0.0.1:11000 due to [Errno 41] Protocol wrong type for socket\r\n2019-02-13T20:21:38.116000Z TestFramework (INFO): Sending a message with incorrect size of 2\r\n2019-02-13T20:21:38.277000Z TestFramework (INFO): Sending a message with incorrect size of 77\r\n2019-02-13T20:21:38.433000Z TestFramework (INFO): Sending a message with incorrect size of 78\r\n2019-02-13T20:21:38.596000Z TestFramework (INFO): Sending a message with incorrect size of 79\r\n2019-02-13T20:21:38.972000Z TestFramework (INFO): Stopping nodes\r\n2019-02-13T20:21:39.232000Z TestFramework (INFO): Cleaning up /var/folders/y0/l8_5z4393lg2qlwdjc11n9380000gn/T/test_runner_â¿_ð_20190213_142133/p2p_invalid_messages_0 on exit\r\n2019-02-13T20:21:39.232000Z TestFramework (INFO): Tests successful\r\n\r\n\r\nstderr:\r\nFatal write error on socket transport\r\nprotocol: <test_framework.mininode.P2PDataStore object at 0x102fc8940>\r\ntransport: <_SelectorSocketTransport fd=10 read=polling write=<idle, bufsize=0>>\r\nTraceback (most recent call last):\r\n  File \"/usr/local/Cellar/python/3.7.2_1/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/selector_events.py\", line 857, in write\r\n    n = self._sock.send(data)\r\nOSError: [Errno 41] Protocol wrong type for socket\r\n```\r\n\r\nWe can probably check for close prior to the extra send and I think there's a way to register an exception handler to the event loop for errors that happen outside of what your code is awaiting.",
   "closed_at" : null,
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 7,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15400/comments",
   "created_at" : "2019-02-13T21:29:13Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15400/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/15400",
   "id" : 410011332,
   "labels" : [
      {
         "color" : "d4c5f9",
         "default" : false,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      },
      {
         "color" : "660000",
         "default" : false,
         "id" : 234879,
         "name" : "macOS",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzk=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/macOS"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15400/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU0MTAwMTEzMzI=",
   "number" : 15400,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Tests: p2p_invalid_messages test can fail in runner due to stderr text when socket write buffer flushed",
   "updated_at" : "2019-10-18T13:26:53Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15400",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/577312?v=4",
      "events_url" : "https://api.github.com/users/JustinTArthur/events{/privacy}",
      "followers_url" : "https://api.github.com/users/JustinTArthur/followers",
      "following_url" : "https://api.github.com/users/JustinTArthur/following{/other_user}",
      "gists_url" : "https://api.github.com/users/JustinTArthur/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/JustinTArthur",
      "id" : 577312,
      "login" : "JustinTArthur",
      "node_id" : "MDQ6VXNlcjU3NzMxMg==",
      "organizations_url" : "https://api.github.com/users/JustinTArthur/orgs",
      "received_events_url" : "https://api.github.com/users/JustinTArthur/received_events",
      "repos_url" : "https://api.github.com/users/JustinTArthur/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/JustinTArthur/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/JustinTArthur/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/JustinTArthur"
   }
}
