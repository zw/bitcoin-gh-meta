{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "(summary of a discussion with @sdaftuar and @morcos)\r\n\r\nAs shown by the discussion of #9375, one issue is the expectation that (existing) peers have that `block` messages are never consensus-invalid. This complicates logic significantly, as much of the faster block relay relies on not knowing this ahead of time.\r\n\r\nBIP152 essentially introduces an exception. This leads to the question: is this assumption necessary at all?\r\n\r\nI don't think it is. Block validation is expensive, but producing an (invalid) block is very expensive. At the current difficulty, producing a PoW-valid block with state of the art mining hardware requires over 40000 kWh of energy. Using the difficulty at the last checkpoint (which we want to get rid, but it would be replaced by another mechanism for preventing low-difficulty header bloat), it is still 730 kWh. And that's just for doing a single attack that causes ~seconds of CPU work for network nodes - a persistent one would be prohibitive. Another way of looking at it is that our current protection against this (DoS banning) is likely much cheaper to bypass (get extra IP addresses) than what it already costs to produce invalid blocks.\r\n\r\nSo I'd like to propose that for blocks, we only DoS ban/disconnect for headers with invalid PoW or building on top of a header with invalid PoW. Specifically, a header building on top of an invalid block (with valid header) would be permitted.\r\n\r\nPossible issues that may arise and need separate solutions:\r\n* Header spamming (which is currently prevented by checkpoints, but could be replaced with a different rule - out of scope here).\r\n* Detecting whether all our connections are to nodes that are on different networks. This could be improved by just having rotating connections (is there no issue for this already?) or by marking peers which have a `pindexLastCommonBlock` that over long periods of time remains forked off from out best chain.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9530/comments",
   "created_at" : "2017-01-12T17:02:08Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9530/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/9530",
   "id" : 200423447,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9530/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyMDA0MjM0NDc=",
   "number" : 9530,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "[brainstorm] DoS protection for blocks",
   "updated_at" : "2017-01-15T14:39:00Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9530",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   }
}
