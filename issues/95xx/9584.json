{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Since #7946 we don't hold cs_main while syncing transactions connected in a block with our wallet.  There have been several previously identified open issues such as #9148 and proposed fixes before 0.14.   \r\n\r\nThere are at least two more potential unsolved problems:\r\n1. There is a race condition where if two blocks are connected in different threads the wallet could receive the transactions in the connected blocks out of order.  In particular if there was a reorg, and a wallet transaction appeared on both chains of the reorg, and the wallet received notification of the transaction in the stale block after receiving notification of the transaction in the current tip block, then this could lead to the wallet believing a confirmed transaction is currently conflicted because it will have the wrong `hashBlock`.  One potential scenario that could cause this race is a miner issuing a preciousblock rpc call (for a block tied with the current tip) simultaneously with receiving a new block building off the current tip.\r\n2. `CreateTransaction` calls take cs_main, which used to mean that the wallet, mempool and chainstate were necessarily synced.  However it is unknown whether problems could be caused by trying to create a new transaction while the mempool and chain state might be ahead of where the wallet is synced.  This is probably not an actual problem, but needs further review.\r\n    - Certainly it is possible that transactions might be created which are no longer valid and won't be accepted to the mempool.\r\n    - Additionally it needs to be carefully thought about whether it is ok for the wallet transaction to be created based on chain state information from the current tip but then possibly updated afterwards with stale information.  ",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9584/comments",
   "created_at" : "2017-01-19T16:28:16Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9584/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/9584",
   "id" : 201908454,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9584/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyMDE5MDg0NTQ=",
   "number" : 9584,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Synchronization problems with wallet.",
   "updated_at" : "2017-05-04T02:19:21Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9584",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
      "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
      "followers_url" : "https://api.github.com/users/morcos/followers",
      "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/morcos",
      "id" : 4360349,
      "login" : "morcos",
      "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
      "organizations_url" : "https://api.github.com/users/morcos/orgs",
      "received_events_url" : "https://api.github.com/users/morcos/received_events",
      "repos_url" : "https://api.github.com/users/morcos/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/morcos"
   }
}
