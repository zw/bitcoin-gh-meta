[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19438 (Introduce deploymentstatus by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-26T09:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-767419355",
      "id" : 767419355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzQxOTM1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-19T13:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767419355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-01-26T16:41:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-767670763",
      "id" : 767670763,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzY3MDc2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T16:41:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767670763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The linter was failing on all pull requests with the same error when I pushed so it is likely unrelated to the commits here and will get resolved with the next push. Ready for review.",
      "created_at" : "2021-01-26T20:11:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-767798617",
      "id" : 767798617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Nzc5ODYxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T20:11:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767798617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dhruv Rebase on `master` and the `boost/thread/mutex.hpp` warning will go away: it was fixed in #21010 :)",
      "created_at" : "2021-01-26T21:08:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-767828931",
      "id" : 767828931,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzgyODkzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T21:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767828931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased against master and linter is passing. Thanks, @practicalswift.",
      "created_at" : "2021-01-26T22:20:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-767865079",
      "id" : 767865079,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Nzg2NTA3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T22:20:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767865079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565553753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565553753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `insuficiently` -> `insufficiently`",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-01-27T18:52:44Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {\n+            if (IsWitnessEnabled(block->pprev, params.GetConsensus()) && !(block->nStatus & BLOCK_OPT_WITNESS)) {\n+                // block is insuficiently validated for a segwit client",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565553753",
      "id" : 565553753,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU1Mzc1Mw==",
      "original_commit_id" : "7c919a15ab9efc576fb073f8069225e02ab26ed0",
      "original_line" : 4390,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577657131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565553753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565558170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565558170"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: since we are always using the `NODE_WITNESS` flag, would it make sense to pass it on initialization for [nLocalServices](https://github.com/dhruv/bitcoin/blob/rewindblockindex-2021/src/init.cpp#L899)?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-01-27T18:59:31Z",
      "diff_hunk" : "@@ -1821,11 +1818,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         }\n     }\n \n-    if (chainparams.GetConsensus().SegwitHeight != std::numeric_limits<int>::max()) {\n-        // Advertise witness capabilities.\n-        // The option to not set NODE_WITNESS is only used in the tests and should be removed.\n-        nLocalServices = ServiceFlags(nLocalServices | NODE_WITNESS);\n-    }\n+    nLocalServices = ServiceFlags(nLocalServices | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565558170",
      "id" : 565558170,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU1ODE3MA==",
      "original_commit_id" : "7c919a15ab9efc576fb073f8069225e02ab26ed0",
      "original_line" : 1821,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 577657131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565558170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-01-27T19:25:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-768520278",
      "id" : 768520278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODUyMDI3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T19:25:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768520278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565636451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565636451"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-01-27T21:12:23Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {\n+            if (IsWitnessEnabled(block->pprev, params.GetConsensus()) && !(block->nStatus & BLOCK_OPT_WITNESS)) {\n+                // block is insuficiently validated for a segwit client",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565636451",
      "id" : 565636451,
      "in_reply_to_id" : 565553753,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYzNjQ1MQ==",
      "original_commit_id" : "7c919a15ab9efc576fb073f8069225e02ab26ed0",
      "original_line" : 4390,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577761956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565636451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565636600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565636600"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That makes sense. Thanks!",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-01-27T21:12:42Z",
      "diff_hunk" : "@@ -1821,11 +1818,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         }\n     }\n \n-    if (chainparams.GetConsensus().SegwitHeight != std::numeric_limits<int>::max()) {\n-        // Advertise witness capabilities.\n-        // The option to not set NODE_WITNESS is only used in the tests and should be removed.\n-        nLocalServices = ServiceFlags(nLocalServices | NODE_WITNESS);\n-    }\n+    nLocalServices = ServiceFlags(nLocalServices | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r565636600",
      "id" : 565636600,
      "in_reply_to_id" : 565558170,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYzNjYwMA==",
      "original_commit_id" : "7c919a15ab9efc576fb073f8069225e02ab26ed0",
      "original_line" : 1821,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 577762152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565636600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @ccdle12. Comments addressed. Ready for further review.",
      "created_at" : "2021-01-27T21:13:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-768580874",
      "id" : 768580874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODU4MDg3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T21:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768580874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Makes sense, if the rationale was simply to ensure the block gets redownloaded.\r\n\r\nIf we focus on validation, however, we would want this around for Taproot. But I'm not sure that's what its purpose is.\r\n\r\nRe-validating blocks on upgrade seems like a feature we don't have today, and should be implemented separately from this (without redownloading).\r\n\r\n(Therefore, Concept ACK)",
      "created_at" : "2021-01-28T21:30:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-769411959",
      "id" : 769411959,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTQxMTk1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-28T21:30:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769411959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr You're right, the removed code erases insufficiently validated blocks (which do not have witness data and can't be properly validated by a segwit-aware node) and re-downloads them. AFAICT, with Taproot, the post-activation blocks will have witness data, so we'll need to implement a different function to re-validate the insufficiently validated blocks after upgrade.",
      "created_at" : "2021-01-29T02:29:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-769531849",
      "id" : 769531849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTUzMTg0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T02:29:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769531849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-02-01T22:24:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-771202654",
      "id" : 771202654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTIwMjY1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-01T22:24:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771202654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568664358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568664358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't true. `NeedsIBD()` grabs cs_main and holds throughout. You could change it to requires cs_main, then run this entire block under one cs_main lock.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-02T14:53:04Z",
      "diff_hunk" : "@@ -1687,26 +1687,23 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n+            bool needs_ibd{false};\n+            // Can't hold cs_main while calling NeedsIBD, so retrieve the relevant",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568664358",
      "id" : 568664358,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY2NDM1OA==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1691,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 581426224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568664358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Make `[nodiscard]`?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-02T14:54:07Z",
      "diff_hunk" : "@@ -673,7 +673,7 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+    bool NeedsIBD(const CChainParams& params) LOCKS_EXCLUDED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665203",
      "id" : 568665203,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY2NTIwMw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 676,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 581426224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665552"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps just annotate this function as requiring cs_main and assert that it's held.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-02T14:54:31Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665552",
      "id" : 568665552,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY2NTU1Mg==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4387,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 581426224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you use a range based for loop since you're iterating over all members of this container?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-02T14:54:54Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r568665869",
      "id" : 568665869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY2NTg2OQ==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4388,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 581426224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568665869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569358290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569358290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we really need to iterate on the whole block index from genesis ?\r\n\r\nSegwit activation height has been hardcoded by #16060. I think you can start the witness-valid iteration from the hardcoded height, whatever the network, minus one ?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-03T12:02:36Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {\n+            if (IsWitnessEnabled(block->pprev, params.GetConsensus()) && !(block->nStatus & BLOCK_OPT_WITNESS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569358290",
      "id" : 569358290,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTM1ODI5MA==",
      "original_commit_id" : "bf5c3e132775f648b3b1ca5608406fb34e0cbf45",
      "original_line" : 4389,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 582290452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569358290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569402143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569402143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you commit-split the changes around `segwithheight` from the ones around `NODE_WITNESS` ? Better to review any changes in net_processing on their own. ",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-03T13:14:29Z",
      "diff_hunk" : "@@ -461,11 +461,8 @@ void CRegTestParams::UpdateActivationParametersFromArgs(const ArgsManager& args)\n {\n     if (args.IsArgSet(\"-segwitheight\")) {\n         int64_t height = args.GetArg(\"-segwitheight\", consensus.SegwitHeight);\n-        if (height < -1 || height >= std::numeric_limits<int>::max()) {\n+        if (height < 0 || height >= std::numeric_limits<int>::max()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569402143",
      "id" : 569402143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQwMjE0Mw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 464,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 582290452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569402143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569407592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569407592"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is buggy. Always setting `NODE_WITNESS` to our local service flags doesn't mean we will never meet peers which aren't advertising it. Of course it's unlikely there is that much of those peers deployed but otherwise I believe we'll wrongly unserialize received txn.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-03T13:22:17Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569407592",
      "id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQwNzU5Mg==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582290452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569407592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569408004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569408004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe better to defer those change to #20799, which will achieve the same IIRC but can be reasoned on their own ?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-03T13:22:57Z",
      "diff_hunk" : "@@ -2717,7 +2716,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n+        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569408004",
      "id" : 569408004,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQwODAwNA==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 2719,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582290452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569408004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569445746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569445746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why do you think this is buggy? We'll ~un~serialize using `MSG_WITNESS_FLAG` iff `fHaveWitness` is set to true, which happens if the peer includes `NODE_WITNESS` in its version message.\r\n\r\nEDIT: I wrote \"unserialize\" here when it should be \"serialize\". `GetFetchFlags()` is used to set our serialization when sending messages.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-03T14:15:19Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r569445746",
      "id" : 569445746,
      "in_reply_to_id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ0NTc0Ng==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582407379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569445746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570231459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570231459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we unserialize if `fAllowWitness=true`, `MSG_WITNESS_FLAG` is used by a getdata sender to require serialization of witnesses but not at unserialization itself?\r\n\r\nThat said, you're right that `fHaveWitness` implies they advertise their local services with `NODE_WITNESS`. And those ones are static so it should be good. Further, the conditional could be already reduced to `fHaveWitness` check only, a test node with `-segwitheight== std::numeric_limits<int>::max()` will have `fHaveWitness=false` ?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-04T13:42:23Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570231459",
      "id" : 570231459,
      "in_reply_to_id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDIzMTQ1OQ==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 583401585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570231459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570256904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570256904"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> MSG_WITNESS_FLAG is used by a getdata sender to require serialization of witnesses but not at unserialization itself\r\n\r\nSorry, yes - I wrote \"unserialize\" above when I meant \"serialize\"\r\n\r\n> Further, the conditional could be already reduced to fHaveWitness check only, a test node with -segwitheight== std::numeric_limits<int>::max() will have fHaveWitness=false ?\r\n\r\nI don't think that's right. Before this PR, it's checking that both:\r\n\r\n- we have signaled NODE_WITNESS to the peer\r\n- the peer has signaled NODE_WITNESS to us\r\n\r\nwe can only use witness serialization on the connection when both of those conditions are true.\r\n\r\nAfter this PR, we unconditionally signal NODE_WITNESS to all peers, so we only need to check that they signaled NODE_WITNESS to us (which is what is indicated by fHaveWitness).",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-04T14:16:54Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570256904",
      "id" : 570256904,
      "in_reply_to_id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDI1NjkwNA==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 583435750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570256904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570934275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570934275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gotcha, reading comment L869 in `src/net_processing.cpp` : \"Note that pnode->GetLocalServices() is a reflection of the local services we were offering when the CNode object was created for this peer\" makes me understood this is _our_ local services, not _their_. Renaming the method `GetAnnouncedToPeerServices` or something similar would be clearer.\r\n\r\nBut further, if our local services are static beyond initialization does it make sense to track them per-peer, the same set of flags should be announced to all our peers during a runtime lifecycle ?\r\n\r\n> we can only use witness serialization on the connection when both of those conditions are true.\r\n\r\nDoes BIP144 really require double opt-in to fetch a tx and its witnesses with a getdata ? Not clear reading the BIP no more the getdata processing code.\r\n\r\n```\r\n            // WTX and WITNESS_TX imply we serialize with witness\r\n            int nSendFlags = (inv.IsMsgTx() ? SERIALIZE_TRANSACTION_NO_WITNESS : 0);\r\n            connman.PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *tx));\r\n```\r\n\r\n",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T12:28:59Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570934275",
      "id" : 570934275,
      "in_reply_to_id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDkzNDI3NQ==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 584292660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570934275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570991293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570991293"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm sure there are lots of improvements that could be made around how we track services (and indeed will be made as part of https://github.com/bitcoin/bitcoin/issues/19398). However, that seems orthogonal to this PR. Here, we just want to ensure that mainnet behaviour is unaffected.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T14:08:20Z",
      "diff_hunk" : "@@ -1948,7 +1948,7 @@ void static ProcessGetData(CNode& pfrom, Peer& peer, const CChainParams& chainpa\n \n static uint32_t GetFetchFlags(const CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     uint32_t nFetchFlags = 0;\n-    if ((pfrom.GetLocalServices() & NODE_WITNESS) && State(pfrom.GetId())->fHaveWitness) {\n+    if (State(pfrom.GetId())->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r570991293",
      "id" : 570991293,
      "in_reply_to_id" : 569407592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDk5MTI5Mw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1951,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 584368593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570991293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234335"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:34:32Z",
      "diff_hunk" : "@@ -1687,26 +1687,23 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n+            bool needs_ibd{false};\n+            // Can't hold cs_main while calling NeedsIBD, so retrieve the relevant",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234335",
      "id" : 571234335,
      "in_reply_to_id" : 568664358,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNDMzNQ==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 1691,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 584686624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234543"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Great idea. Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:34:58Z",
      "diff_hunk" : "@@ -673,7 +673,7 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+    bool NeedsIBD(const CChainParams& params) LOCKS_EXCLUDED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234543",
      "id" : 571234543,
      "in_reply_to_id" : 568665203,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNDU0Mw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 676,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 584686873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234627"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:35:09Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571234627",
      "id" : 571234627,
      "in_reply_to_id" : 568665552,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNDYyNw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4387,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 584686986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571234627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571235757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571235757"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I took @ariard's suggestion and started from the `params.SegwitHeight()` - also changed it to a while loop that reads cleaner.\r\n\r\nOut of curiosity, is a defined `[]` operator all that's needed to use a range-based for loop?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:36:45Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571235757",
      "id" : 571235757,
      "in_reply_to_id" : 568665869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNTc1Nw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4388,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 584688232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571235757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571236156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Great idea. Updated to start from `params.SegwitHeight()`",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:37:25Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {\n+            if (IsWitnessEnabled(block->pprev, params.GetConsensus()) && !(block->nStatus & BLOCK_OPT_WITNESS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571236156",
      "id" : 571236156,
      "in_reply_to_id" : 569358290,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNjE1Ng==",
      "original_commit_id" : "bf5c3e132775f648b3b1ca5608406fb34e0cbf45",
      "original_line" : 4389,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 584688694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571236449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done - moved the second commit to #21090 and split it up into several there.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:37:57Z",
      "diff_hunk" : "@@ -461,11 +461,8 @@ void CRegTestParams::UpdateActivationParametersFromArgs(const ArgsManager& args)\n {\n     if (args.IsArgSet(\"-segwitheight\")) {\n         int64_t height = args.GetArg(\"-segwitheight\", consensus.SegwitHeight);\n-        if (height < -1 || height >= std::numeric_limits<int>::max()) {\n+        if (height < 0 || height >= std::numeric_limits<int>::max()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571236449",
      "id" : 571236449,
      "in_reply_to_id" : 569402143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNjQ0OQ==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 464,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 584689037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571238036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571238036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This diff is now moved to #21090 but I left it in because the check is redundant if this code is merged. IIUC, #20799 eliminates the entire conditional so they can both be reasoned for independently?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-05T20:40:57Z",
      "diff_hunk" : "@@ -2717,7 +2716,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n+        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571238036",
      "id" : 571238036,
      "in_reply_to_id" : 569408004,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzODAzNg==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 2719,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 584690961,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571238036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Comments addressed. The second commit has been broken out into #21090. Ready for further review.",
      "created_at" : "2021-02-06T02:42:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-774384254",
      "id" : 774384254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NDM4NDI1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-06T02:42:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/774384254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571711847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571711847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "range-based for loops need an `x.begin()` and `x.end()` (or `begin(x)` and `end(x)`) that return iterators, and the iterators need to accept `++it` and `*it` and be comparable with `!=` -- https://en.cppreference.com/w/cpp/language/range-for ",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-07T22:40:49Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571711847",
      "id" : 571711847,
      "in_reply_to_id" : 568665869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTcxMTg0Nw==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4388,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 585091048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571711847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571925434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571925434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will print the message twice if there are two `CChainState`s.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T10:15:02Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {\n+                LOCK(cs_main);\n+                for (CChainState* chainstate : chainman.GetAll()) {\n+                    if (!fReset) {\n+                        uiInterface.InitMessage(_(\"Checking if IBD is needed...\").translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571925434",
      "id" : 571925434,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTkyNTQzNA==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1694,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 585342914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571925434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571930294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571930294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We can avoid some deep nesting and the need for a temporary variable to pass the result of the predicate out of the loop by using an stl algorithm:\r\n\r\n```diff\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -1686,27 +1686,19 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\r\n                 break;\r\n             }\r\n \r\n-            bool needs_ibd{false};\r\n-            {\r\n-                LOCK(cs_main);\r\n-                for (CChainState* chainstate : chainman.GetAll()) {\r\n-                    if (!fReset) {\r\n-                        uiInterface.InitMessage(_(\"Checking if IBD is needed...\").translated);\r\n-                        if (chainstate->NeedsIBD(chainparams)) {\r\n-                            strLoadError = _(\r\n-                                \"Segwit blocks are insufficiently validated. \"\r\n-                                \"Please delete blocks dir and chain state dir and restart.\");\r\n-                            needs_ibd = true;\r\n-                            break; // out of the per-chainstate loop\r\n-                        }\r\n-                    }\r\n+            if (!fReset) {\r\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\r\n+                LOCK(cs_main);\r\n+                auto chainstates{chainman.GetAll()};\r\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\r\n+                                [&chainparams] (CChainState* cs) {return cs->NeedsIBD(chainparams);})) {\r\n+                    strLoadError = _(\r\n+                        \"Segwit blocks are insufficiently validated. \"\r\n+                        \"Please delete blocks dir and chain state dir and restart.\");\r\n+                    break;\r\n                 }\r\n             }\r\n \r\n-            if (needs_ibd) {\r\n-                break; // out of the chainstate activation do-while\r\n-            }\r\n-\r\n             bool failed_verification = false;\r\n```\r\n\r\nThis is exactly what `std::any_of` is designed for. Instead of creating a boolean, manually iterating through a range, executing a predicate on each member and then setting the boolean and breaking out if the predicate returns true, we can let the standard library do the heavy lifting. That makes the code more expressive by raising the level of abstraction and communicating what we want the code to do, and not what the individual steps to do it are.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T10:21:54Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571930294",
      "id" : 571930294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTkzMDI5NA==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1690,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 585342914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571930294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571931259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571931259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider renaming this function `NeedsRedownload`. All nodes that are starting fresh or restarting after some time need IBD. This function is specifically for nodes that need to delete blocks and redownload them.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T10:23:24Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571931259",
      "id" : 571931259,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTkzMTI1OQ==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 4393,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 585342914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571931259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571932692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571932692"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This loop seems useless. `sync_blocks()` ensures that the nodes have the same block hash at their tip. We assume that if the block hash at the tip is the same then all blocks in the chain are the same (if not, then bitcoin is fundamentally broken).",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T10:25:34Z",
      "diff_hunk" : "@@ -1956,21 +1959,49 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\"Segwit blocks are insufficiently validated. Please delete blocks dir and chain state dir and restart.\"], timeout=10):\n+            self.nodes[2].start([\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+\n+        # As directed, the user deletes the blocks and chainstate directories and restarts the node\n+        datadir = get_datadir_path(self.options.tmpdir, 2)\n+        blocks_dir = os.path.join(datadir, \"regtest\", \"blocks\")\n+        chainstate_dir = os.path.join(datadir, \"regtest\", \"chainstate\")\n+        shutil.rmtree(blocks_dir)\n+        shutil.rmtree(chainstate_dir)\n+\n+        self.start_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n+        # The upgraded node syncs headers and performs IBD\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n         assert softfork_active(self.nodes[2], 'segwit')\n \n-        # Make sure this peer's blocks match those of node0.\n+        # Make sure all peers have the same blocks.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571932692",
      "id" : 571932692,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTkzMjY5Mg==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1997,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 585342914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571932692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572227822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572227822"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T17:23:33Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {\n+                LOCK(cs_main);\n+                for (CChainState* chainstate : chainman.GetAll()) {\n+                    if (!fReset) {\n+                        uiInterface.InitMessage(_(\"Checking if IBD is needed...\").translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572227822",
      "id" : 572227822,
      "in_reply_to_id" : 571925434,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjIyNzgyMg==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1694,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 585740839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572227822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572228350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572228350"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Beautiful change. Thank you for teaching so patiently!",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T17:24:10Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572228350",
      "id" : 572228350,
      "in_reply_to_id" : 571930294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjIyODM1MA==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1690,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 585741444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572228350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572228646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572228646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense. Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T17:24:34Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572228646",
      "id" : 572228646,
      "in_reply_to_id" : 571931259,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjIyODY0Ng==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 4393,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 585741830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572228646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572229363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572229363"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fair enough. I didn't remember that `sync_blocks()` verifies that the best hashes are equal. Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T17:25:33Z",
      "diff_hunk" : "@@ -1956,21 +1959,49 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\"Segwit blocks are insufficiently validated. Please delete blocks dir and chain state dir and restart.\"], timeout=10):\n+            self.nodes[2].start([\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+\n+        # As directed, the user deletes the blocks and chainstate directories and restarts the node\n+        datadir = get_datadir_path(self.options.tmpdir, 2)\n+        blocks_dir = os.path.join(datadir, \"regtest\", \"blocks\")\n+        chainstate_dir = os.path.join(datadir, \"regtest\", \"chainstate\")\n+        shutil.rmtree(blocks_dir)\n+        shutil.rmtree(chainstate_dir)\n+\n+        self.start_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n+        # The upgraded node syncs headers and performs IBD\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n         assert softfork_active(self.nodes[2], 'segwit')\n \n-        # Make sure this peer's blocks match those of node0.\n+        # Make sure all peers have the same blocks.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572229363",
      "id" : 572229363,
      "in_reply_to_id" : 571932692,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjIyOTM2Mw==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1997,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 585742728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572229363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572245344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572245344"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ooops. I guess the lambda needs an annotation too. Something like this maybe:\r\n\r\n```\r\n                if (std::any_of(chainstates.begin(), chainstates.end(),\r\n                                [&chainparams] (CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {return cs->NeedsIBD(chainparams);})) {\r\n```",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T17:47:15Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572245344",
      "id" : 572245344,
      "in_reply_to_id" : 571930294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjI0NTM0NA==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1690,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 585762951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572245344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572452874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572452874"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That worked. For my education, what happened there and how did you know the lambda annotation would help?\r\n\r\nI suspect the annotation is evaluated with the limited scope of the bound variables, so it does not \"know\" about the locks that are acquired in the outer scope. Is that even close?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-08T23:35:16Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r572452874",
      "id" : 572452874,
      "in_reply_to_id" : 571930294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ1Mjg3NA==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1690,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 586020312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572452874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Comments addressed. Rebased. Ready for further review.",
      "created_at" : "2021-02-08T23:35:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-775536087",
      "id" : 775536087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTUzNjA4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-08T23:35:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775536087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575646238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575646238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My mistake. For some reason I thought m_chain was a container here.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-13T09:42:34Z",
      "diff_hunk" : "@@ -4381,143 +4381,19 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsIBD(const CChainParams& params)\n {\n-    AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n-\n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n-\n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n     {\n         LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n+        for (CBlockIndex* block = m_chain.Genesis(); block != nullptr; block = m_chain.Next(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575646238",
      "id" : 575646238,
      "in_reply_to_id" : 568665869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTY0NjIzOA==",
      "original_commit_id" : "79970c929131855666995564f7dfc3c62f5d5d31",
      "original_line" : 4388,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 589956930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575646238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575646403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575646403"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As discussed, there was an error message about `NeedsIBD()` requiring cs_main. Since the compiler does not know that when it's inside the lambda, it's in a scope that already has cs_main, we need to annotate it.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-13T09:44:51Z",
      "diff_hunk" : "@@ -1686,26 +1686,24 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n+            bool needs_ibd{false};\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575646403",
      "id" : 575646403,
      "in_reply_to_id" : 571930294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTY0NjQwMw==",
      "original_commit_id" : "9bae47d529c11b7b87a2a78ccd38ae8bcc60da3c",
      "original_line" : 1690,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 589957043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575646403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 0af05b95e9c829ff581bb76a0998b5a90386e27a",
      "created_at" : "2021-02-13T09:51:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-778592210",
      "id" : 778592210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODU5MjIxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-13T09:51:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778592210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575664861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575664861"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we be more cautious with directly summoning users to delete directories ?\r\n\r\nMaybe we should give a more detailed path (`.bitcoin/blocks`, `.bitcoin/chainstate`) but not sure if it's platform dependent. I just want to minimize the risk of someone deleting by mistake its wallet.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-13T13:02:48Z",
      "diff_hunk" : "@@ -1686,27 +1686,18 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    strLoadError = _(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir and chain state dir and restart.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575664861",
      "id" : 575664861,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTY2NDg2MQ==",
      "original_commit_id" : "0af05b95e9c829ff581bb76a0998b5a90386e27a",
      "original_line" : 1698,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 589966686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575664861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575897776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575897776"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea! Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-15T01:15:06Z",
      "diff_hunk" : "@@ -1686,27 +1686,18 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    strLoadError = _(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir and chain state dir and restart.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r575897776",
      "id" : 575897776,
      "in_reply_to_id" : 575664861,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5Nzc3Ng==",
      "original_commit_id" : "0af05b95e9c829ff581bb76a0998b5a90386e27a",
      "original_line" : 1698,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 590111302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575897776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated to log the blocksdir and chainstate dir to the user so they do not accidentally delete their wallet. Ready for further review.",
      "created_at" : "2021-02-15T01:15:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-778881615",
      "id" : 778881615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODg4MTYxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T01:15:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778881615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576134367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576134367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A `-reindex` should do the same with less effort?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-15T11:45:04Z",
      "diff_hunk" : "@@ -1686,27 +1686,19 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    auto chainstate_dir = GetDataDir() / CHAINSTATE_DIRNAME;\n+                    strLoadError = strprintf(_(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir(%s) and chainstate dir(%s) and restart.\"), GetBlocksDir(), chainstate_dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576134367",
      "id" : 576134367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjEzNDM2Nw==",
      "original_commit_id" : "d9370c1c5bfc2305f327fbfecf95072b75a62a75",
      "original_line" : 1699,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 590402543,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576134367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576370924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576370924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "When a pre-segwit node upgrades to segwit, it has no way to sufficiently validate to the segwit consensus rules from the blocks on disk since witness data was never relayed to it. Help for `-reindex` says \"Rebuild chain state and block index from the blk*.dat files on disk\". Looking at the code also does not suggest to me that `-reindex` would cause the node to re-download.\r\n\r\nAm I missing something?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-15T18:39:27Z",
      "diff_hunk" : "@@ -1686,27 +1686,19 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    auto chainstate_dir = GetDataDir() / CHAINSTATE_DIRNAME;\n+                    strLoadError = strprintf(_(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir(%s) and chainstate dir(%s) and restart.\"), GetBlocksDir(), chainstate_dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576370924",
      "id" : 576370924,
      "in_reply_to_id" : 576134367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjM3MDkyNA==",
      "original_commit_id" : "d9370c1c5bfc2305f327fbfecf95072b75a62a75",
      "original_line" : 1699,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 590695368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576370924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed  d9370c1  to fix failing test.",
      "created_at" : "2021-02-15T18:40:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-779393307",
      "id" : 779393307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTM5MzMwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T18:40:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779393307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576702371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576702371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, I think this is true. `-reindex` will cause the node to try to rebuild the chain state from the block files, which will work only as far as the segwit activation height if the blocks after that are serialized without witness. The node will then try to sync by downloading all blocks from peers as normal. The test passes with the following change:\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_segwit.py b/test/functional/p2p_segwit.py\r\nindex 219c15f673..76d8967a41 100755\r\n--- a/test/functional/p2p_segwit.py\r\n+++ b/test/functional/p2p_segwit.py\r\n@@ -1973,15 +1973,8 @@ class SegWitTest(BitcoinTestFramework):\r\n         with self.nodes[2].assert_debug_log(expected_msgs=[\"Segwit blocks are insufficiently validated. Please delete blocks dir and chain state dir and restart.\"], timeout=10):\r\n             self.nodes[2].start([\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\r\n \r\n-        # As directed, the user deletes the blocks and chainstate directories and restarts the node\r\n-        datadir = get_datadir_path(self.options.tmpdir, 2)\r\n-        blocks_dir = os.path.join(datadir, \"regtest\", \"blocks\")\r\n-        chainstate_dir = os.path.join(datadir, \"regtest\", \"chainstate\")\r\n-        shutil.rmtree(blocks_dir)\r\n-        shutil.rmtree(chainstate_dir)\r\n-\r\n-        self.start_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\r\n-        assert_equal(self.nodes[2].getblockcount(), 0)\r\n+        self.start_node(2, extra_args=[\"-reindex=1\", \"-segwitheight={}\".format(SEGWIT_HEIGHT)])\r\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\r\n         self.connect_nodes(0, 2)\r\n \r\n         # We reconnect more than 100 blocks, give it plenty of time\r\n```\r\n\r\nThere are a bunch of `AcceptBlock` errors since the blocks after height SEGWIT_HEIGHT aren't serialized properly:\r\n\r\n```\r\nnode2 2021-02-16T10:05:38.943607Z [loadblk] ERROR: AcceptBlock: bad-witness-nonce-size, ContextualCheckBlock : invalid witness reserved value size \r\n node2 2021-02-16T10:05:38.943663Z [loadblk] ERROR: AcceptBlock: bad-witness-nonce-size, ContextualCheckBlock : invalid witness reserved value size \r\n node2 2021-02-16T10:05:38.943712Z [loadblk] ERROR: AcceptBlock: bad-witness-nonce-size, ContextualCheckBlock : invalid witness reserved value size \r\n[...]\r\n```\r\n\r\nand when the node connects to its peers, it downloads and syncs to the tip, validating segwit rules as it goes.\r\n\r\nOne downside is that the old blocks are retained on disk and never deleted. However, that was the case before this PR as well.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-16T10:11:13Z",
      "diff_hunk" : "@@ -1686,27 +1686,19 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    auto chainstate_dir = GetDataDir() / CHAINSTATE_DIRNAME;\n+                    strLoadError = strprintf(_(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir(%s) and chainstate dir(%s) and restart.\"), GetBlocksDir(), chainstate_dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576702371",
      "id" : 576702371,
      "in_reply_to_id" : 576134367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjcwMjM3MQ==",
      "original_commit_id" : "d9370c1c5bfc2305f327fbfecf95072b75a62a75",
      "original_line" : 1699,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 591071872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576702371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK d9370c1, thanks for taking the suggestion, Marco one sounds fine to me if you want to take it.",
      "created_at" : "2021-02-16T12:03:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-779793151",
      "id" : 779793151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTc5MzE1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T12:03:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779793151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576963163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576963163"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, what I wasn't thinking about is that it is normal for the block _index_ to not be a 1:1 representation of the blk*.dat files. It happens all the time with reorgs, etc. So, upon `-reindex` the node won't be able to validate `[SEGWIT_HEIGHT, consensusTip]` blocks, will have `tip == SEGWIT_HEIGHT - 1`. It will then proceed to sync headers and therefore re-download `[SEGWIT_HEIGHT, consensusTip]`.\r\n\r\nThank you for the great suggestion @MarcoFalke! Makes for much simpler code. Updated.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-16T16:32:49Z",
      "diff_hunk" : "@@ -1686,27 +1686,19 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    auto chainstate_dir = GetDataDir() / CHAINSTATE_DIRNAME;\n+                    strLoadError = strprintf(_(\n+                        \"Segwit blocks are insufficiently validated. \"\n+                        \"Please delete blocks dir(%s) and chainstate dir(%s) and restart.\"), GetBlocksDir(), chainstate_dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576963163",
      "id" : 576963163,
      "in_reply_to_id" : 576134367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njk2MzE2Mw==",
      "original_commit_id" : "d9370c1c5bfc2305f327fbfecf95072b75a62a75",
      "original_line" : 1699,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 591406565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576963163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576968263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576968263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this change needed?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-16T16:39:24Z",
      "diff_hunk" : "@@ -556,7 +557,7 @@ class CChainState\n         size_t cache_size_bytes,\n         bool in_memory,\n         bool should_wipe,\n-        std::string leveldb_name = \"chainstate\");\n+        std::string leveldb_name = CHAINSTATE_DIRNAME);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576968263",
      "id" : 576968263,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njk2ODI2Mw==",
      "original_commit_id" : "361300e038b4d8b13f76309c8d85b5832d850974",
      "original_line" : 560,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 591413118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576968263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576971728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576971728"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right - it is no longer needed with the `-reindex` change (I was previously using it to create the chainstate dir path). Removed.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-16T16:43:59Z",
      "diff_hunk" : "@@ -556,7 +557,7 @@ class CChainState\n         size_t cache_size_bytes,\n         bool in_memory,\n         bool should_wipe,\n-        std::string leveldb_name = \"chainstate\");\n+        std::string leveldb_name = CHAINSTATE_DIRNAME);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576971728",
      "id" : 576971728,
      "in_reply_to_id" : 576968263,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njk3MTcyOA==",
      "original_commit_id" : "361300e038b4d8b13f76309c8d85b5832d850974",
      "original_line" : 560,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 591417724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576971728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed to use `-reindex` instead of asking the user to delete blocks dir and chainstatedir. Ready for further review!",
      "created_at" : "2021-02-16T16:46:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-779964042",
      "id" : 779964042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTk2NDA0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T16:46:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779964042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r577014215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577014215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(please don't change the branch for this, but if you need to retouch for some other reason) you can use an f-string here:\r\n\r\n```suggestion\r\n            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\r\n```\r\n\r\nf-strings are supported from python 3.6, and have a slightly cleaner syntax.\r\n\r\nYou can also use an f-string in the `extra_args` argument below.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-16T17:43:40Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                'Segwit blocks are insufficiently validated. Please restart with -reindex.'], timeout=10):\n+            self.nodes[2].start([\"-segwitheight={}\".format(SEGWIT_HEIGHT)])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r577014215",
      "id" : 577014215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzAxNDIxNQ==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1972,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 591472314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577014215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578972424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578972424"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps `\"Witness data for blocks after height %d requires validation.Please restart with -reindex.\", params.SegwitHeight` might be better?\r\n\r\nSeems like the commit message should also be updated now this isn't recommending deleting the blocks dir.\r\n\r\nI suppose with assumeutxo, we could conceivably have a `-reindex-while-running` option, that downgraded the current tip to \"assumeutxo-valid\", and did the reindex/redownload in the background until it caught up.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-19T07:10:38Z",
      "diff_hunk" : "@@ -1686,27 +1686,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    strLoadError = _(\"Segwit blocks are insufficiently validated. Please restart with -reindex.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578972424",
      "id" : 578972424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODk3MjQyNA==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1696,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 593912765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578972424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578974287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578974287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm a little surprised this doesn't go from `m_chain.Tip()` backwards to `SegwitHeight`?\r\n\r\nYou're only trying to figure out if any blocks didn't have witness data checked, not which is the lowest one, and if there are any without witness data, the tip should also not have witness data (if the node software that downloaded the tip was segwit aware it would have rewound or demanded a reindex, rather than downloading the tip). I think it's still probably smart to check every block back to SegwitHeight in case of some weird bug in old software, so the normal case wouldn't be any faster.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-19T07:15:43Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params)\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain[params.GetConsensus().SegwitHeight];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578974287",
      "id" : 578974287,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODk3NDI4Nw==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 4398,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 593912765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578974287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578975566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578975566"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this message really needed on every startup, rather than just a message when some action is needed?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-19T07:18:49Z",
      "diff_hunk" : "@@ -1686,27 +1686,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r578975566",
      "id" : 578975566,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODk3NTU2Ng==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1691,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 593912765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578975566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r579597720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579597720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Add a doxygen comment? `/** Check if chain state needs to be redownloaded due to lack of witness data */` ?\r\n\r\nShould be a `const` method, as far as I can see.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-20T05:12:16Z",
      "diff_hunk" : "@@ -684,7 +684,7 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+    [[nodiscard]] bool NeedsRedownload(const CChainParams& params) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r579597720",
      "id" : 579597720,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTU5NzcyMA==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 687,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 593912765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579597720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186625"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for showing me that. Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-27T20:25:14Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                'Segwit blocks are insufficiently validated. Please restart with -reindex.'], timeout=10):\n+            self.nodes[2].start([\"-segwitheight={}\".format(SEGWIT_HEIGHT)])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186625",
      "id" : 584186625,
      "in_reply_to_id" : 577014215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDE4NjYyNQ==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1972,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 600192576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186630"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-27T20:25:18Z",
      "diff_hunk" : "@@ -1686,27 +1686,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\n+                    strLoadError = _(\"Segwit blocks are insufficiently validated. Please restart with -reindex.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186630",
      "id" : 584186630,
      "in_reply_to_id" : 578972424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDE4NjYzMA==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1696,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 600192579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, it's a little more intuitive to go backwards. It's also faster. Updated.\r\n\r\nNote that the code was not checking each block in `[segwit_height, tip]`. It was merely looking for one insufficiently validated block and returning true. It continues to do the same thing which is why going backwards from tip is faster.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-27T20:26:16Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params)\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain[params.GetConsensus().SegwitHeight];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186771",
      "id" : 584186771,
      "in_reply_to_id" : 578974287,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDE4Njc3MQ==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 4398,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 600192651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186805"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice idea. Removed.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-27T20:26:42Z",
      "diff_hunk" : "@@ -1686,27 +1686,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n \n-            if (failed_rewind) {\n-                break; // out of the chainstate activation do-while\n+            if (!fReset) {\n+                uiInterface.InitMessage(_(\"Checking if redownload is needed...\").translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186805",
      "id" : 584186805,
      "in_reply_to_id" : 578975566,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDE4NjgwNQ==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 1691,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 600192683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done and done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-02-27T20:26:54Z",
      "diff_hunk" : "@@ -684,7 +684,7 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+    [[nodiscard]] bool NeedsRedownload(const CChainParams& params) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r584186840",
      "id" : 584186840,
      "in_reply_to_id" : 579597720,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDE4Njg0MA==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 687,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 600192695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584186840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the reviews @ajtowns and @jnewbery. My apologies on the delay. Our twins arrived a few days ago so we are still finding our new routine :)\r\n\r\nComments addressed. Ready for further review.",
      "created_at" : "2021-02-27T20:28:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-787130699",
      "id" : 787130699,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzEzMDY5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-27T20:28:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787130699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK e750a774b8375dcbab9b804e2fd1334f1f62d6e4",
      "created_at" : "2021-02-28T14:14:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-787459091",
      "id" : 787459091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzQ1OTA5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T14:14:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787459091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r585467654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585467654"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In the normal case it checks every block in `[segwit_height, tip]` and returns false because it didn't find a block. :) (Unless I'm very confused?)",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-02T10:59:58Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params)\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain[params.GetConsensus().SegwitHeight];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r585467654",
      "id" : 585467654,
      "in_reply_to_id" : 578974287,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQ2NzY1NA==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 4398,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 601689941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585467654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r585575246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585575246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're correct. I misunderstood what you were saying.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-02T13:44:36Z",
      "diff_hunk" : "@@ -4390,143 +4390,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params)\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain[params.GetConsensus().SegwitHeight];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r585575246",
      "id" : 585575246,
      "in_reply_to_id" : 578974287,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTU3NTI0Ng==",
      "original_commit_id" : "5e818578524ee8419bcaf610cf1394817d867663",
      "original_line" : 4398,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 601828153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585575246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Your latest rebase has reintroduced the `EraseBlockData()` declaration in validation.h L776.",
      "created_at" : "2021-03-04T17:42:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-790800340",
      "id" : 790800340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgwMDM0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T17:42:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790800340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, yes. I was just fixing it while you noticed as well. Thanks, @jnewbery. Rebased. Ready for further review.",
      "created_at" : "2021-03-04T17:56:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-790809870",
      "id" : 790809870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgwOTg3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T18:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790809870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 1aecaac8b46a936634245739efff852f03c32b55",
      "created_at" : "2021-03-04T18:07:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-790817719",
      "id" : 790817719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgxNzcxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T18:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790817719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK 1aecaac",
      "created_at" : "2021-03-09T16:22:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-794115862",
      "id" : 794115862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NDExNTg2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T16:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/794115862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591607496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591607496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\n-    CBlockIndex* block = m_chain.Tip();\r\n+    CBlockIndex* block{m_chain.Tip()};\r\n+    const int segwit_height{params.GetConsensus().SegwitHeight};\r\n \r\n-    while (block != nullptr && block->nHeight >= params.GetConsensus().SegwitHeight) {\r\n+    while (block != nullptr && block->nHeight >= segwit_height) {\r\n```\r\n",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-10T15:14:22Z",
      "diff_hunk" : "@@ -4431,143 +4431,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params) const\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain.Tip();\n \n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n-    {\n-        LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n-            }\n+    while (block != nullptr && block->nHeight >= params.GetConsensus().SegwitHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591607496",
      "id" : 591607496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYwNzQ5Ng==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 4441,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 608827427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591607496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591608342"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591608342"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\n         # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\r\n+        for n in range(2):\r\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\r\n+            assert softfork_active(self.nodes[n], \"segwit\")\r\n-        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\r\n-        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\r\n         assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\r\n-        assert softfork_active(self.nodes[0], 'segwit')\r\n-        assert softfork_active(self.nodes[1], 'segwit')\r\n         assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\r\n```\r\n",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-10T15:15:17Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591608342",
      "id" : 591608342,
      "line" : 1964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYwODM0Mg==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1964,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 10,
      "pull_request_review_id" : 608827427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591608342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591608717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591608717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\n         # The upgraded node syncs headers and performs redownload\r\n-        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\r\n-        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\r\n-        assert softfork_active(self.nodes[0], 'segwit')\r\n-        assert softfork_active(self.nodes[1], 'segwit')\r\n-        assert softfork_active(self.nodes[2], 'segwit')\r\n+        for n in range(2):\r\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\r\n+        for n in range(3):\r\n+            assert softfork_active(self.nodes[n], \"segwit\")\r\n```\r\n",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-10T15:15:41Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n+        # The upgraded node syncs headers and performs redownload\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n         assert softfork_active(self.nodes[2], 'segwit')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591608717",
      "id" : 591608717,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYwODcxNw==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1989,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 608827427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591608717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591611033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591611033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\n-    /** Check if chain state needs to be redownloaded due to lack of witness data */\r\n-    [[nodiscard]] bool NeedsRedownload(const CChainParams& params) const EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n+    /** Whether the chain state needs to be reindexed due to lack of witness data. */\r\n+    [[nodiscard]] bool NeedsReindex(const CChainParams& params) const EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n     bool LoadGenesisBlock(const CChainParams& chainparams);\r\n```",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-10T15:18:07Z",
      "diff_hunk" : "@@ -724,7 +724,9 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+\n+    /** Check if chain state needs to be redownloaded due to lack of witness data */\n+    [[nodiscard]] bool NeedsRedownload(const CChainParams& params) const EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591611033",
      "id" : 591611033,
      "line" : 727,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYxMTAzMw==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 727,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 608827427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591611033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591616226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591616226"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(nit, remove extra blank line)",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-10T15:24:06Z",
      "diff_hunk" : "@@ -1697,27 +1697,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r591616226",
      "id" : 591616226,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYxNjIyNg==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1700,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 608838809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591616226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-11T12:46:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-796710733",
      "id" : 796710733,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjcxMDczMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T12:46:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796710733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-11T20:36:12Z",
      "diff_hunk" : "@@ -4431,143 +4431,22 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params) const\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block = m_chain.Tip();\n \n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n-    {\n-        LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n-            }\n+    while (block != nullptr && block->nHeight >= params.GetConsensus().SegwitHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703846",
      "id" : 592703846,
      "in_reply_to_id" : 591607496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjcwMzg0Ng==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 4441,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 610201526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703901"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-11T20:36:17Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703901",
      "id" : 592703901,
      "in_reply_to_id" : 591608342,
      "line" : 1964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjcwMzkwMQ==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1964,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 10,
      "pull_request_review_id" : 610201600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-11T20:36:22Z",
      "diff_hunk" : "@@ -1956,23 +1956,38 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n+        # The upgraded node syncs headers and performs redownload\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[2].getblockcount())\n+        assert_equal(self.nodes[1].getblockcount(), self.nodes[2].getblockcount())\n+        assert softfork_active(self.nodes[0], 'segwit')\n+        assert softfork_active(self.nodes[1], 'segwit')\n         assert softfork_active(self.nodes[2], 'segwit')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592703937",
      "id" : 592703937,
      "in_reply_to_id" : 591608717,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjcwMzkzNw==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1989,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 610201655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592703937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592705332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592705332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I left it as `NeedsRedownload` as that represents more accurately, what's needed. Restarting with `-reindex` is just the suggestion we make to the user that accomplishes the redownload. To me, `NeedsReindex` suggests merely rebuilding an index from what we have would be enough.\r\n\r\nUpdated the comment though.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-11T20:38:40Z",
      "diff_hunk" : "@@ -724,7 +724,9 @@ class CChainState\n \n     /** Replay blocks that aren't fully applied to the database. */\n     bool ReplayBlocks(const CChainParams& params);\n-    bool RewindBlockIndex(const CChainParams& params) LOCKS_EXCLUDED(cs_main);\n+\n+    /** Check if chain state needs to be redownloaded due to lack of witness data */\n+    [[nodiscard]] bool NeedsRedownload(const CChainParams& params) const EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592705332",
      "id" : 592705332,
      "in_reply_to_id" : 591611033,
      "line" : 727,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjcwNTMzMg==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 727,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 610203420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592705332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592705480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592705480"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-03-11T20:38:53Z",
      "diff_hunk" : "@@ -1697,27 +1697,16 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n-                }\n-            }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r592705480",
      "id" : 592705480,
      "in_reply_to_id" : 591616226,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjcwNTQ4MA==",
      "original_commit_id" : "1aecaac8b46a936634245739efff852f03c32b55",
      "original_line" : 1700,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 610203600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592705480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you for the review @jonatack. Comments addressed. Rebased. Ready for further review.",
      "created_at" : "2021-03-11T20:39:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-797033840",
      "id" : 797033840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzAzMzg0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T21:17:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797033840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 644827722b9eba8af40576505a3d5444272f29c3 per `git range-diff e0bc27a 1aecaac 6448277` and debug build/ran bitcoind\r\n\r\nSmall suggestion to save a few `getblockcount()` calls, happy to re-ACK if you update. Sorry for not noticing on the first pass:\r\n\r\n<details><summary>suggestion</summary><p>\r\n\r\n```diff\r\n         # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\r\n+        node_2_height = self.nodes[2].getblockcount()\r\n         for n in range(2):\r\n-            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\r\n+            assert_equal(self.nodes[n].getblockcount(), node_2_height)\r\n             assert softfork_active(self.nodes[n], \"segwit\")\r\n-        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\r\n+        assert SEGWIT_HEIGHT < node_2_height\r\n         assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\r\n \r\n         # Restarting node 2 should result in a shutdown because the blockchain consists of\r\n@@ -1981,8 +1982,9 @@ class SegWitTest(BitcoinTestFramework):\r\n         self.sync_blocks(timeout=240)\r\n \r\n         # The upgraded node syncs headers and performs redownload\r\n+        node_2_height = self.nodes[2].getblockcount()\r\n         for n in range(2):\r\n-            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\r\n+            assert_equal(self.nodes[n].getblockcount(), node_2_height)\r\n```\r\n</p></details>\r\n",
      "created_at" : "2021-03-12T16:28:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-797601858",
      "id" : 797601858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzYwMTg1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-12T16:28:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797601858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Small suggestion to save a few getblockcount() calls, happy to re-ACK if you update. Sorry for not noticing on the first pass:\r\n\r\nThanks, @jonatack. I will update it if I end up rebasing or addressing other comments.",
      "created_at" : "2021-03-14T22:35:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-798992749",
      "id" : 798992749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5ODk5Mjc0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-14T22:35:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/798992749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review soon.",
      "created_at" : "2021-03-25T14:45:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-806880099",
      "id" : 806880099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjg4MDA5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T14:45:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806880099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard do you mind re-reviewing this? I believe all of your review comments are addressed.",
      "created_at" : "2021-04-08T08:31:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-815566835",
      "id" : 815566835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNTU2NjgzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-08T08:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/815566835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616114589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616114589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps worth verifying the blocks are equivalent, like in the original test?\r\n```suggestion\r\n        height = self.nodes[2].getblockcount()\r\n        blockhash = self.nodes[2].getblockhash(height)\r\n        block = self.nodes[2].getblock(blockhash)\r\n        for n in [0, 1]:\r\n            assert_equal(self.nodes[n].getblockcount(), height)\r\n            assert_equal(self.nodes[n].getblockhash(height), blockhash)\r\n            assert_equal(self.nodes[n].getblock(blockhash), block)\r\n```",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T19:17:51Z",
      "diff_hunk" : "@@ -1956,22 +1956,35 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1\n+        # The upgraded node syncs headers and performs redownload\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616114589",
      "id" : 616114589,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjExNDU4OQ==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1985,
      "original_position" : 41,
      "original_start_line" : 1984,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 639225816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616114589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616123099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616123099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n                                [&chainparams](const CChainState* const cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {\r\n```",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T19:31:55Z",
      "diff_hunk" : "@@ -1698,29 +1698,17 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n+            if (!fReset) {\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616123099",
      "id" : 616123099,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjEyMzA5OQ==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1705,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 639225816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616123099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616129532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616129532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did a quick grep for `BLOCK_OPT_WITNESS` and came across #19806 which added a \"fake\" `BLOCK_OPT_WITNESS` \"so that RewindBlockIndex() doesn't zealously unwind the assumed-valid chain.\" I don't have much background on AssumeUTXO but is there an interaction there? Should that be cleaned up as well?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T19:43:12Z",
      "diff_hunk" : "@@ -4431,143 +4431,23 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params) const\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block{m_chain.Tip()};\n+    const int segwit_height{params.GetConsensus().SegwitHeight};\n \n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n-    {\n-        LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n-            }\n+    while (block != nullptr && block->nHeight >= segwit_height) {\n+        if (!(block->nStatus & BLOCK_OPT_WITNESS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616129532",
      "id" : 616129532,
      "line" : 4443,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjEyOTUzMg==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 4443,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 142,
      "pull_request_review_id" : 639225816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616129532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616139111"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616139111"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no harm in doing this, but I don't think making the pointer const (`CChainstate* const`) is an improvement. In c++, when you pass a pointer, the called function makes a copy of that pointer, so it being const or not communicates nothing to the caller.\r\n\r\nMaking the pointer point to const data (`const CChainstate*`) on the other hand _is_ useful. It means that the function can't mutate the thing that `cs` is pointing to (and can't be called with a pointer to non-const).",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T19:59:42Z",
      "diff_hunk" : "@@ -1698,29 +1698,17 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n+            if (!fReset) {\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616139111",
      "id" : 616139111,
      "in_reply_to_id" : 616123099,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjEzOTExMQ==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1705,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 639257329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616139111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616140260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616140260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`self.sync_blocks()` ensures that all the nodes are synced to the same block (see https://github.com/bitcoin/bitcoin/pull/21009#discussion_r571932692).",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T20:01:52Z",
      "diff_hunk" : "@@ -1956,22 +1956,35 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1\n+        # The upgraded node syncs headers and performs redownload\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616140260",
      "id" : 616140260,
      "in_reply_to_id" : 616114589,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjE0MDI2MA==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1985,
      "original_position" : 41,
      "original_start_line" : 1984,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 639259013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616140260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616185830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616185830"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah true  the latter `const` is what I was going for :D ",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-19T21:20:29Z",
      "diff_hunk" : "@@ -1698,29 +1698,17 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n+            if (!fReset) {\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616185830",
      "id" : 616185830,
      "in_reply_to_id" : 616123099,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjE4NTgzMA==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1705,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 639317930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616185830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616759874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616759874"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is the assert_equal for `getblockcount()` necessary?",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-20T14:50:49Z",
      "diff_hunk" : "@@ -1956,22 +1956,35 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1\n+        # The upgraded node syncs headers and performs redownload\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r616759874",
      "id" : 616759874,
      "in_reply_to_id" : 616114589,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjc1OTg3NA==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1985,
      "original_position" : 41,
      "original_start_line" : 1984,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 640054190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616759874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617660294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617660294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call, @glozow. I'll make a note to look at whether that's still necessary after the merge of this PR.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-21T15:34:40Z",
      "diff_hunk" : "@@ -4431,143 +4431,23 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\n     return true;\n }\n \n-//! Helper for CChainState::RewindBlockIndex\n-void CChainState::EraseBlockData(CBlockIndex* index)\n+bool CChainState::NeedsRedownload(const CChainParams& params) const\n {\n     AssertLockHeld(cs_main);\n-    assert(!m_chain.Contains(index)); // Make sure this block isn't active\n-\n-    // Reduce validity\n-    index->nStatus = std::min<unsigned int>(index->nStatus & BLOCK_VALID_MASK, BLOCK_VALID_TREE) | (index->nStatus & ~BLOCK_VALID_MASK);\n-    // Remove have-data flags.\n-    index->nStatus &= ~(BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO);\n-    // Remove storage location.\n-    index->nFile = 0;\n-    index->nDataPos = 0;\n-    index->nUndoPos = 0;\n-    // Remove various other things\n-    index->nTx = 0;\n-    index->nChainTx = 0;\n-    index->nSequenceId = 0;\n-    // Make sure it gets written.\n-    setDirtyBlockIndex.insert(index);\n-    // Update indexes\n-    setBlockIndexCandidates.erase(index);\n-    auto ret = m_blockman.m_blocks_unlinked.equal_range(index->pprev);\n-    while (ret.first != ret.second) {\n-        if (ret.first->second == index) {\n-            m_blockman.m_blocks_unlinked.erase(ret.first++);\n-        } else {\n-            ++ret.first;\n-        }\n-    }\n-    // Mark parent as eligible for main chain again\n-    if (index->pprev && index->pprev->IsValid(BLOCK_VALID_TRANSACTIONS) && index->pprev->HaveTxsDownloaded()) {\n-        setBlockIndexCandidates.insert(index->pprev);\n-    }\n-}\n-\n-bool CChainState::RewindBlockIndex(const CChainParams& params)\n-{\n-    // Note that during -reindex-chainstate we are called with an empty m_chain!\n \n-    // First erase all post-segwit blocks without witness not in the main chain,\n-    // as this can we done without costly DisconnectTip calls. Active\n-    // blocks will be dealt with below (releasing cs_main in between).\n-    {\n-        LOCK(cs_main);\n-        for (const auto& entry : m_blockman.m_block_index) {\n-            if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\n-                EraseBlockData(entry.second);\n-            }\n-        }\n-    }\n+    // At and above params.SegwitHeight, segwit consensus rules must be validated\n+    CBlockIndex* block{m_chain.Tip()};\n+    const int segwit_height{params.GetConsensus().SegwitHeight};\n \n-    // Find what height we need to reorganize to.\n-    CBlockIndex *tip;\n-    int nHeight = 1;\n-    {\n-        LOCK(cs_main);\n-        while (nHeight <= m_chain.Height()) {\n-            // Although SCRIPT_VERIFY_WITNESS is now generally enforced on all\n-            // blocks in ConnectBlock, we don't need to go back and\n-            // re-download/re-verify blocks from before segwit actually activated.\n-            if (IsWitnessEnabled(m_chain[nHeight - 1], params.GetConsensus()) && !(m_chain[nHeight]->nStatus & BLOCK_OPT_WITNESS)) {\n-                break;\n-            }\n-            nHeight++;\n-        }\n-\n-        tip = m_chain.Tip();\n-    }\n-    // nHeight is now the height of the first insufficiently-validated block, or tipheight + 1\n-\n-    BlockValidationState state;\n-    // Loop until the tip is below nHeight, or we reach a pruned block.\n-    while (!ShutdownRequested()) {\n-        {\n-            LOCK(cs_main);\n-            LOCK(m_mempool.cs);\n-            // Make sure nothing changed from under us (this won't happen because RewindBlockIndex runs before importing/network are active)\n-            assert(tip == m_chain.Tip());\n-            if (tip == nullptr || tip->nHeight < nHeight) break;\n-            if (fPruneMode && !(tip->nStatus & BLOCK_HAVE_DATA)) {\n-                // If pruning, don't try rewinding past the HAVE_DATA point;\n-                // since older blocks can't be served anyway, there's\n-                // no need to walk further, and trying to DisconnectTip()\n-                // will fail (and require a needless reindex/redownload\n-                // of the blockchain).\n-                break;\n-            }\n-\n-            // Disconnect block\n-            if (!DisconnectTip(state, params, nullptr)) {\n-                return error(\"RewindBlockIndex: unable to disconnect block at height %i (%s)\", tip->nHeight, state.ToString());\n-            }\n-\n-            // Reduce validity flag and have-data flags.\n-            // We do this after actual disconnecting, otherwise we'll end up writing the lack of data\n-            // to disk before writing the chainstate, resulting in a failure to continue if interrupted.\n-            // Note: If we encounter an insufficiently validated block that\n-            // is on m_chain, it must be because we are a pruning node, and\n-            // this block or some successor doesn't HAVE_DATA, so we were unable to\n-            // rewind all the way.  Blocks remaining on m_chain at this point\n-            // must not have their validity reduced.\n-            EraseBlockData(tip);\n-\n-            tip = tip->pprev;\n-        }\n-        // Make sure the queue of validation callbacks doesn't grow unboundedly.\n-        LimitValidationInterfaceQueue();\n-\n-        // Occasionally flush state to disk.\n-        if (!FlushStateToDisk(params, state, FlushStateMode::PERIODIC)) {\n-            LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-            return false;\n-        }\n-    }\n-\n-    {\n-        LOCK(cs_main);\n-        if (m_chain.Tip() != nullptr) {\n-            // We can't prune block index candidates based on our tip if we have\n-            // no tip due to m_chain being empty!\n-            PruneBlockIndexCandidates();\n-\n-            CheckBlockIndex(params.GetConsensus());\n-\n-            // FlushStateToDisk can possibly read ::ChainActive(). Be conservative\n-            // and skip it here, we're about to -reindex-chainstate anyway, so\n-            // it'll get called a bunch real soon.\n-            BlockValidationState state;\n-            if (!FlushStateToDisk(params, state, FlushStateMode::ALWAYS)) {\n-                LogPrintf(\"RewindBlockIndex: unable to flush state to disk (%s)\\n\", state.ToString());\n-                return false;\n-            }\n+    while (block != nullptr && block->nHeight >= segwit_height) {\n+        if (!(block->nStatus & BLOCK_OPT_WITNESS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617660294",
      "id" : 617660294,
      "in_reply_to_id" : 616129532,
      "line" : 4443,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY2MDI5NA==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 4443,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 142,
      "pull_request_review_id" : 641243165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:09:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617660294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617953209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617953209"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right. `sync_blocks()` checks for the best block hash as mentioned, so the `getblockcount()` check is really just checking for very unlikely hash collisions. Updated.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-21T23:11:02Z",
      "diff_hunk" : "@@ -1956,22 +1956,35 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1\n+        # The upgraded node syncs headers and performs redownload\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617953209",
      "id" : 617953209,
      "in_reply_to_id" : 616114589,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzk1MzIwOQ==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1985,
      "original_position" : 41,
      "original_start_line" : 1984,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 641628875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-21T23:11:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617953209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617953274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617953274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-21T23:11:11Z",
      "diff_hunk" : "@@ -1698,29 +1698,17 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 break;\n             }\n \n-            bool failed_rewind{false};\n-            // Can't hold cs_main while calling RewindBlockIndex, so retrieve the relevant\n-            // chainstates beforehand.\n-            for (CChainState* chainstate : WITH_LOCK(::cs_main, return chainman.GetAll())) {\n-                if (!fReset) {\n-                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                    // It both disconnects blocks based on the chainstate, and drops block data in\n-                    // BlockIndex() based on lack of available witness data.\n-                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                    if (!chainstate->RewindBlockIndex(chainparams)) {\n-                        strLoadError = _(\n-                            \"Unable to rewind the database to a pre-fork state. \"\n-                            \"You will need to redownload the blockchain\");\n-                        failed_rewind = true;\n-                        break; // out of the per-chainstate loop\n-                    }\n+            if (!fReset) {\n+                LOCK(cs_main);\n+                auto chainstates{chainman.GetAll()};\n+                if (std::any_of(chainstates.begin(), chainstates.end(),\n+                                [&chainparams](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(chainparams); })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617953274",
      "id" : 617953274,
      "in_reply_to_id" : 616123099,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzk1MzI3NA==",
      "original_commit_id" : "644827722b9eba8af40576505a3d5444272f29c3",
      "original_line" : 1705,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 641628919,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:11:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617953274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments from @glozow and simplified the functional test a bit - previous code was checking segwit activation on all nodes, but we only need the check on the upgrading node. Ready for further review.",
      "created_at" : "2021-04-21T23:13:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-824423176",
      "id" : 824423176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDQyMzE3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T23:13:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824423176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617961288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617961288"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So based on the removal of this test code (and the `SEGWIT_HEIGHT - 1` assertion above), the implication seems to be we expect users who are upgrading from pre-segwit to remove their datadir and sync to tip from scratch? Based on the assertions here, `-reindex` will not bring them to tip, so what's the point of telling the user to reindex at all? Or is this behavior specific to the functional tests, and in practice `-reindex` *would* bring the upgraded node to tip? (I'll need to review the reindex code; I can't remember what to expect there.)\r\n\r\nIf we expect users to remove their blocksdir before restarting with `-reindex`, you might consider mentioning that in the error message you've included in `init.cpp`.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-21T23:30:58Z",
      "diff_hunk" : "@@ -1956,22 +1956,33 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n+        # sync_blocks() also verifies the best block hash is the same for all nodes\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r617961288",
      "id" : 617961288,
      "line" : 1974,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzk2MTI4OA==",
      "original_commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "original_line" : 1974,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 39,
      "pull_request_review_id" : 641636847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T23:33:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617961288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-22T07:46:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-824621163",
      "id" : 824621163,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDYyMTE2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T07:46:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824621163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618165170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618165170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reindexing will result in the node discarding the blocks without witness after segwit activation and redownloading them from peers and validating. See https://github.com/bitcoin/bitcoin/pull/21009#discussion_r576134367. The reason the node doesn't sync to tip here is because in our functional tests, the nodes don't make automatic connections to each other. As soon as the nodes are connected, the upgraded node will resync from its peers.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-22T07:51:41Z",
      "diff_hunk" : "@@ -1956,22 +1956,33 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n+        # sync_blocks() also verifies the best block hash is the same for all nodes\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618165170",
      "id" : 618165170,
      "in_reply_to_id" : 617961288,
      "line" : 1974,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODE2NTE3MA==",
      "original_commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "original_line" : 1974,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 39,
      "pull_request_review_id" : 641883109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-22T07:51:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618165170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618489237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618489237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I should have updated the PR description. Updated to now say:\r\n\r\n> This PR introduces NeedsRedownload() which merely checks for insufficiently validated segwit blocks and requests that the user restarts the node with `-reindex`. Reindexing the block files upon restart will make the node rebuild chain state and block index from the `blk*.dat` files on disk. The node won't be able to index the blocks with `BLOCK_OPT_WITNESS`, so they will be missing from the chain and be re-downloaded, with witness data.\r\n\r\nSorry for the confusion. \r\n\r\nAs for the `-reindex` code, the call path is: `src/init.cpp::Threadimport()` -> `validation.cpp:CChainState::LoadExternalBlockFile()` -> `validation.cpp:CChainState::AcceptBlock()` -> `validation.cpp:ContextualCheckBlock()`. The last function tries to [validate for witness commitments](https://github.com/bitcoin/bitcoin/blob/4b5659c6b115315c9fd2902b4edd4b960a5e066e/src/validation.cpp#L3418) and is [unable to](https://github.com/bitcoin/bitcoin/blob/4b5659c6b115315c9fd2902b4edd4b960a5e066e/src/validation.cpp#L3436) thereby causing the block to not be accepted into the chain upon a restart with `-reindex`\r\n\r\nUsing `combine_logs.py` for `test/functional/p2p_segwit.py` you can see lines like:\r\n\r\n```\r\n node2 2021-04-22T14:56:56.543661Z [loadblk] [util/system.h:52] [error] ERROR: AcceptBlock: bad-witness-nonce-size, ContextualCheckBlock : invalid witness reserved value size\r\n node2 2021-04-22T14:56:56.544812Z [loadblk] [util/system.h:52] [error] ERROR: AcceptBlock: bad-witness-nonce-size, ContextualCheckBlock : invalid witness reserved value size\r\n```",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-22T15:07:48Z",
      "diff_hunk" : "@@ -1956,22 +1956,33 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n+        # sync_blocks() also verifies the best block hash is the same for all nodes\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618489237",
      "id" : 618489237,
      "in_reply_to_id" : 617961288,
      "line" : 1974,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ4OTIzNw==",
      "original_commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "original_line" : 1974,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 39,
      "pull_request_review_id" : 642322800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-22T15:13:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618489237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618502626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618502626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks all. Makes sense.",
      "commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "created_at" : "2021-04-22T15:23:43Z",
      "diff_hunk" : "@@ -1956,22 +1956,33 @@ def test_non_standard_witness(self):\n     def test_upgrade_after_activation(self):\n         \"\"\"Test the behavior of starting up a segwit-aware node after the softfork has activated.\"\"\"\n \n-        self.restart_node(2, extra_args=[\"-segwitheight={}\".format(SEGWIT_HEIGHT)])\n+        # All nodes are caught up and node 2 is a pre-segwit node that will soon upgrade.\n+        for n in range(2):\n+            assert_equal(self.nodes[n].getblockcount(), self.nodes[2].getblockcount())\n+            assert softfork_active(self.nodes[n], \"segwit\")\n+        assert SEGWIT_HEIGHT < self.nodes[2].getblockcount()\n+        assert 'segwit' not in self.nodes[2].getblockchaininfo()['softforks']\n+\n+        # Restarting node 2 should result in a shutdown because the blockchain consists of\n+        # insufficiently validated blocks per segwit consensus rules.\n+        self.stop_node(2)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[\n+                f\"Witness data for blocks after height {SEGWIT_HEIGHT} requires validation. Please restart with -reindex.\"], timeout=10):\n+            self.nodes[2].start([f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # As directed, the user restarts the node with -reindex\n+        self.start_node(2, extra_args=[\"-reindex\", f\"-segwitheight={SEGWIT_HEIGHT}\"])\n+\n+        # With the segwit consensus rules, the node is able to validate only up to SEGWIT_HEIGHT - 1\n+        assert_equal(self.nodes[2].getblockcount(), SEGWIT_HEIGHT - 1)\n         self.connect_nodes(0, 2)\n \n         # We reconnect more than 100 blocks, give it plenty of time\n+        # sync_blocks() also verifies the best block hash is the same for all nodes\n         self.sync_blocks(timeout=240)\n \n-        # Make sure that this peer thinks segwit has activated.\n-        assert softfork_active(self.nodes[2], 'segwit')\n-\n-        # Make sure this peer's blocks match those of node0.\n-        height = self.nodes[2].getblockcount()\n-        while height >= 0:\n-            block_hash = self.nodes[2].getblockhash(height)\n-            assert_equal(block_hash, self.nodes[0].getblockhash(height))\n-            assert_equal(self.nodes[0].getblock(block_hash), self.nodes[2].getblock(block_hash))\n-            height -= 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#discussion_r618502626",
      "id" : 618502626,
      "in_reply_to_id" : 617961288,
      "line" : 1974,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODUwMjYyNg==",
      "original_commit_id" : "d831e711cab83c70bf2ded62fe33f484844e73dd",
      "original_line" : 1974,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 39,
      "pull_request_review_id" : 642341443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-22T15:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618502626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK https://github.com/bitcoin/bitcoin/pull/21009/commits/d831e711cab83c70bf2ded62fe33f484844e73dd\r\n\r\nWill be testing locally today.",
      "created_at" : "2021-04-22T15:24:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-824939591",
      "id" : 824939591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDkzOTU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T15:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824939591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Built and ran tests locally. Grepped around for lingering references and [found a few](https://github.com/jamesob/bitcoin/blob/d831e711cab83c70bf2ded62fe33f484844e73dd/src/chain.h#L185) in documentation that can be cleaned up after this PR. Snapshot activation docs should also be changed in a follow-up PR but the existing logic there is still necessary: we still need to \"fake\" `BLOCK_OPT_WITNESS` in the way that we are now to avoid tripping the new `NeedsRedownload()` check.\r\n\r\nThanks for this change @dhruv. Nice work!",
      "created_at" : "2021-04-22T17:29:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-825046470",
      "id" : 825046470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTA0NjQ3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T17:29:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825046470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Cursory code review ACK d831e711cab83c70bf2ded62fe33f484844e73dd. Agree with the direction of the change, thanks for simplifying the logic here.",
      "created_at" : "2021-04-27T08:14:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-827412064",
      "id" : 827412064,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNzQxMjA2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-27T08:14:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827412064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Grepped around for lingering references and [found a few](https://github.com/jamesob/bitcoin/blob/d831e711cab83c70bf2ded62fe33f484844e73dd/src/chain.h#L185) in documentation that can be cleaned up after this PR\r\n\r\n@jamesob I've attempted to update references in #21816",
      "created_at" : "2021-04-30T14:39:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21009#issuecomment-830141204",
      "id" : 830141204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMDE0MTIwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-30T14:39:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/830141204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   }
]
