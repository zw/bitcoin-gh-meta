[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r917088652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/917088652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if it might make sense to split NodeEvictionCandidate into 2 parts: the const properties that don't change (like conn_type/noban) and the non-const state that's intended to be/might be updated?\r\n\r\nMaybe something like:\r\n\r\n```c++\r\nclass NodeEvictionCandidate {\r\n  class Properties {\r\n    NodeId m_id;\r\n    ConnectionType m_conn_type;\r\n    bool m_noban;\r\n    ...\r\n  };\r\n  NodeEvictionCandidate(NodeProperties properties) : m_properties(properties){}\r\nprivate:\r\n  const NodeProperties m_properties;\r\n  bool m_relay_txs;\r\n  bool fBloomFilter;\r\n  ...\r\n};\r\n...\r\nvoid EvictionManagerImpl::AddCandidate(NodeEvictionCandidate::Properties props) {...}\r\n```\r\n\r\nI think that might be more straightforward to use as it's self-documenting, while also allowing for safe lock-free access to the stuff that can't change.\r\n\r\n\r\n\r\nMaybe that's easier said than done though. Thoughts?",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-08T19:31:12Z",
      "diff_hunk" : "@@ -243,6 +244,53 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n EvictionManagerImpl::EvictionManagerImpl() {}\n EvictionManagerImpl::~EvictionManagerImpl() = default;\n \n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r917088652",
      "id" : 917088652,
      "line" : 256,
      "node_id" : "PRRC_kwDOABII5842qamM",
      "original_commit_id" : "964c048e037231bd8aa5ed224e1883293d258d2a",
      "original_line" : 255,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 20,
      "pull_request_review_id" : 1033310967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/917088652/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-08T19:34:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/917088652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25695](https://github.com/bitcoin/bitcoin/pull/25695) (tidy: add modernize-use-using by fanquake)\n* [#25515](https://github.com/bitcoin/bitcoin/pull/25515) (net, test: Virtualise CConnman and add initial PeerManager unit tests by dergoegge)\n* [#25355](https://github.com/bitcoin/bitcoin/pull/25355) (I2P: add support for transient addresses for outbound connections by vasild)\n* [#25174](https://github.com/bitcoin/bitcoin/pull/25174) (net/net_processing: Add thread safety related annotations for CNode and Peer by ajtowns)\n* [#23561](https://github.com/bitcoin/bitcoin/pull/23561) (BIP324: Handshake prerequisites by dhruv)\n* [#23443](https://github.com/bitcoin/bitcoin/pull/23443) (p2p: Erlay support signaling by naumenkogs)\n* [#23352](https://github.com/bitcoin/bitcoin/pull/23352) (test: Extend stale_tip_peer_management test by MarcoFalke)\n* [#18470](https://github.com/bitcoin/bitcoin/pull/18470) (test: Extend stale tip test by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-08T22:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1179407395",
      "id" : 1179407395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585GTFQj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1179407395/reactions"
      },
      "updated_at" : "2022-08-26T13:44:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1179407395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919867767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "please sort alphabetically :)",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:38:47Z",
      "diff_hunk" : "@@ -3,6 +3,7 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #include <bench/bench.h>\n+#include <node/eviction_impl.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919867767",
      "id" : 919867767,
      "line" : 6,
      "node_id" : "PRRC_kwDOABII58421BF3",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 6,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/bench/peer_eviction.cpp",
      "position" : 4,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919867965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "please sort alphabetically :)",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:39:00Z",
      "diff_hunk" : "@@ -12,6 +12,7 @@\n #include <node/connection_types.h>\n #include <consensus/amount.h>\n #include <crypto/siphash.h>\n+#include <node/eviction.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919867965",
      "id" : 919867965,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII58421BI9",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 15,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 4,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919867965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919875639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919875639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add `#include <node/eviction.h>`",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:47:00Z",
      "diff_hunk" : "@@ -39,7 +39,7 @@ struct CNodeStateStats {\n class PeerManager : public CValidationInterface, public NetEventsInterface\n {\n public:\n-    static std::unique_ptr<PeerManager> make(CConnman& connman, AddrMan& addrman,\n+    static std::unique_ptr<PeerManager> make(CConnman& connman, AddrMan& addrman, EvictionManager& evictionman,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919875639",
      "id" : 919875639,
      "line" : 42,
      "node_id" : "PRRC_kwDOABII58421DA3",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 42,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 5,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919875639/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919875639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919880779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919880779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's usual to put forward declarations at the top of the file (see eg addrman.h)",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:52:26Z",
      "diff_hunk" : "@@ -15,55 +15,53 @@\n \n typedef int64_t NodeId;\n \n-struct NodeEvictionCandidate {\n-    NodeId id;\n-    std::chrono::seconds m_connected;\n-    std::chrono::microseconds m_min_ping_time;\n-    std::chrono::seconds m_last_block_time;\n-    std::chrono::seconds m_last_tx_time;\n-    bool fRelevantServices;\n-    bool m_relay_txs;\n-    bool fBloomFilter;\n-    uint64_t nKeyedNetGroup;\n-    bool prefer_evict;\n-    bool m_is_local;\n-    Network m_network;\n-    bool m_noban;\n-    ConnectionType m_conn_type;\n+class EvictionManagerImpl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919880779",
      "id" : 919880779,
      "line" : 18,
      "node_id" : "PRRC_kwDOABII58421ERL",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 18,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/node/eviction.h",
      "position" : 19,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919880779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919880779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919881823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919881823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for the additional newline at the end.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:53:28Z",
      "diff_hunk" : "@@ -15,55 +15,53 @@\n \n typedef int64_t NodeId;\n \n-struct NodeEvictionCandidate {\n-    NodeId id;\n-    std::chrono::seconds m_connected;\n-    std::chrono::microseconds m_min_ping_time;\n-    std::chrono::seconds m_last_block_time;\n-    std::chrono::seconds m_last_tx_time;\n-    bool fRelevantServices;\n-    bool m_relay_txs;\n-    bool fBloomFilter;\n-    uint64_t nKeyedNetGroup;\n-    bool prefer_evict;\n-    bool m_is_local;\n-    Network m_network;\n-    bool m_noban;\n-    ConnectionType m_conn_type;\n+class EvictionManagerImpl;\n+\n+class EvictionManager\n+{\n+private:\n+    const std::unique_ptr<EvictionManagerImpl> m_impl;\n+\n+public:\n+    explicit EvictionManager();\n+    ~EvictionManager();\n+\n+    void AddCandidate(NodeId id, std::chrono::seconds connected,\n+                      uint64_t keyed_net_group, bool prefer_evict,\n+                      bool is_local, Network network,\n+                      bool noban, ConnectionType conn_type);\n+    bool RemoveCandidate(NodeId id);\n+\n+    /**\n+     * Select an inbound peer to evict after filtering out (protecting) peers having\n+     * distinct, difficult-to-forge characteristics. The protection logic picks out\n+     * fixed numbers of desirable peers per various criteria, followed by (mostly)\n+     * ratios of desirable or disadvantaged peers. If any eviction candidates\n+     * remain, the selection logic chooses a peer to evict.\n+     */\n+    [[nodiscard]] std::optional<NodeId> SelectNodeToEvict() const;\n+\n+    /** A ping-pong round trip has completed successfully. Update minimum ping time. */\n+    void UpdateMinPingTime(NodeId id, std::chrono::microseconds ping_time);\n+    std::optional<std::chrono::microseconds> GetMinPingTime(NodeId id) const;\n+\n+    /** A new valid block was received. Update the candidates last block time. */\n+    void UpdateLastBlockTime(NodeId id, std::chrono::seconds block_time);\n+    std::optional<std::chrono::seconds> GetLastBlockTime(NodeId id) const;\n+\n+    /** A new valid transaction was received. Update the candidates last tx time. */\n+    void UpdateLastTxTime(NodeId id, std::chrono::seconds tx_time);\n+    std::optional<std::chrono::seconds> GetLastTxTime(NodeId id) const;\n+\n+    /** Update the candidates relevant services flag. */\n+    void UpdateRelevantServices(NodeId id, bool has_relevant_flags);\n+\n+    /** Update the candidates bloom filter loaded flag. */\n+    void UpdateLoadedBloomFilter(NodeId id, bool bloom_filter_loaded);\n+\n+    /** Set the candidates tx relay status to true. */\n+    void UpdateRelayTxs(NodeId id);\n };\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919881823",
      "id" : 919881823,
      "line" : 65,
      "node_id" : "PRRC_kwDOABII58421Ehf",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 65,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/node/eviction.h",
      "position" : 66,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919881823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919881823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919882461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919882461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for the `explicit` keyword, since this ctor doesn't take any arguments.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:54:08Z",
      "diff_hunk" : "@@ -15,55 +15,53 @@\n \n typedef int64_t NodeId;\n \n-struct NodeEvictionCandidate {\n-    NodeId id;\n-    std::chrono::seconds m_connected;\n-    std::chrono::microseconds m_min_ping_time;\n-    std::chrono::seconds m_last_block_time;\n-    std::chrono::seconds m_last_tx_time;\n-    bool fRelevantServices;\n-    bool m_relay_txs;\n-    bool fBloomFilter;\n-    uint64_t nKeyedNetGroup;\n-    bool prefer_evict;\n-    bool m_is_local;\n-    Network m_network;\n-    bool m_noban;\n-    ConnectionType m_conn_type;\n+class EvictionManagerImpl;\n+\n+class EvictionManager\n+{\n+private:\n+    const std::unique_ptr<EvictionManagerImpl> m_impl;\n+\n+public:\n+    explicit EvictionManager();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919882461",
      "id" : 919882461,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII58421Erd",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 26,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/node/eviction.h",
      "position" : 27,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919882461/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919882461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919884016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919884016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please sort alphabetically.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T09:55:47Z",
      "diff_hunk" : "@@ -22,6 +22,7 @@ class CTxMemPool;\n class ChainstateManager;\n class NetGroupManager;\n class PeerManager;\n+class EvictionManager;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919884016",
      "id" : 919884016,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII58421FDw",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 25,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/context.h",
      "position" : 4,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919884016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919884016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919888455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919888455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a reason not to do this in the `Delete disconnected nodes` loop below?",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:00:20Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919888455",
      "id" : 919888455,
      "line" : 1101,
      "node_id" : "PRRC_kwDOABII58421GJH",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1101,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919888455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1099,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919888455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919903257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919903257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    /** A ping-pong round trip has completed successfully. Update latest ping time. */\r\n```\r\n\r\nIn fact, `m_last_ping_time` may as well be moved into `Peer` since it's not used in any net level logic and is only for RPC/GUI stats. Could be done as a follow-up.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:15:47Z",
      "diff_hunk" : "@@ -582,7 +554,6 @@ class CNode\n     /** A ping-pong round trip has completed successfully. Update latest and minimum ping times. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919903257",
      "id" : 919903257,
      "line" : 554,
      "node_id" : "PRRC_kwDOABII58421JwZ",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 554,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 64,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919903257/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919903257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919912796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919912796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be shortened to\r\n\r\n```suggestion\r\n        if (auto min_ping_time = m_evictionman.GetMinPingTime(pnode->GetId())) {\r\n```\r\n\r\nif you think that's better. Same below.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:22:07Z",
      "diff_hunk" : "@@ -2555,6 +2554,22 @@ void CConnman::GetNodeStats(std::vector<CNodeStats>& vstats) const\n     for (CNode* pnode : m_nodes) {\n         vstats.emplace_back();\n         pnode->CopyStats(vstats.back());\n+\n+        auto min_ping_time{m_evictionman.GetMinPingTime(pnode->GetId())};\n+        if (min_ping_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919912796",
      "id" : 919912796,
      "line" : 2559,
      "node_id" : "PRRC_kwDOABII58421MFc",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 2559,
      "original_position" : 162,
      "original_start_line" : 2558,
      "path" : "src/net.cpp",
      "position" : 162,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919912796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2558,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919912796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919914379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919914379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Grammar nit:\r\n\r\n```suggestion\r\n    /** A new valid block was received. Update the candidate's last block time. */\r\n```\r\n\r\nSame below.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:23:12Z",
      "diff_hunk" : "@@ -15,55 +15,53 @@\n \n typedef int64_t NodeId;\n \n-struct NodeEvictionCandidate {\n-    NodeId id;\n-    std::chrono::seconds m_connected;\n-    std::chrono::microseconds m_min_ping_time;\n-    std::chrono::seconds m_last_block_time;\n-    std::chrono::seconds m_last_tx_time;\n-    bool fRelevantServices;\n-    bool m_relay_txs;\n-    bool fBloomFilter;\n-    uint64_t nKeyedNetGroup;\n-    bool prefer_evict;\n-    bool m_is_local;\n-    Network m_network;\n-    bool m_noban;\n-    ConnectionType m_conn_type;\n+class EvictionManagerImpl;\n+\n+class EvictionManager\n+{\n+private:\n+    const std::unique_ptr<EvictionManagerImpl> m_impl;\n+\n+public:\n+    explicit EvictionManager();\n+    ~EvictionManager();\n+\n+    void AddCandidate(NodeId id, std::chrono::seconds connected,\n+                      uint64_t keyed_net_group, bool prefer_evict,\n+                      bool is_local, Network network,\n+                      bool noban, ConnectionType conn_type);\n+    bool RemoveCandidate(NodeId id);\n+\n+    /**\n+     * Select an inbound peer to evict after filtering out (protecting) peers having\n+     * distinct, difficult-to-forge characteristics. The protection logic picks out\n+     * fixed numbers of desirable peers per various criteria, followed by (mostly)\n+     * ratios of desirable or disadvantaged peers. If any eviction candidates\n+     * remain, the selection logic chooses a peer to evict.\n+     */\n+    [[nodiscard]] std::optional<NodeId> SelectNodeToEvict() const;\n+\n+    /** A ping-pong round trip has completed successfully. Update minimum ping time. */\n+    void UpdateMinPingTime(NodeId id, std::chrono::microseconds ping_time);\n+    std::optional<std::chrono::microseconds> GetMinPingTime(NodeId id) const;\n+\n+    /** A new valid block was received. Update the candidates last block time. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919914379",
      "id" : 919914379,
      "line" : 48,
      "node_id" : "PRRC_kwDOABII58421MeL",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 48,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/node/eviction.h",
      "position" : 49,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919914379/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919914379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919919355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919919355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Once the outbound eviction logic has also been moved into EvictionManager, can these three getters be combined into a single `GetEvictionCandidateStats()` or similar, since they'll only be used for reporting stats to the user. If you think that's a good idea, perhaps add that to the function comment for now.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:28:11Z",
      "diff_hunk" : "@@ -15,55 +15,53 @@\n \n typedef int64_t NodeId;\n \n-struct NodeEvictionCandidate {\n-    NodeId id;\n-    std::chrono::seconds m_connected;\n-    std::chrono::microseconds m_min_ping_time;\n-    std::chrono::seconds m_last_block_time;\n-    std::chrono::seconds m_last_tx_time;\n-    bool fRelevantServices;\n-    bool m_relay_txs;\n-    bool fBloomFilter;\n-    uint64_t nKeyedNetGroup;\n-    bool prefer_evict;\n-    bool m_is_local;\n-    Network m_network;\n-    bool m_noban;\n-    ConnectionType m_conn_type;\n+class EvictionManagerImpl;\n+\n+class EvictionManager\n+{\n+private:\n+    const std::unique_ptr<EvictionManagerImpl> m_impl;\n+\n+public:\n+    explicit EvictionManager();\n+    ~EvictionManager();\n+\n+    void AddCandidate(NodeId id, std::chrono::seconds connected,\n+                      uint64_t keyed_net_group, bool prefer_evict,\n+                      bool is_local, Network network,\n+                      bool noban, ConnectionType conn_type);\n+    bool RemoveCandidate(NodeId id);\n+\n+    /**\n+     * Select an inbound peer to evict after filtering out (protecting) peers having\n+     * distinct, difficult-to-forge characteristics. The protection logic picks out\n+     * fixed numbers of desirable peers per various criteria, followed by (mostly)\n+     * ratios of desirable or disadvantaged peers. If any eviction candidates\n+     * remain, the selection logic chooses a peer to evict.\n+     */\n+    [[nodiscard]] std::optional<NodeId> SelectNodeToEvict() const;\n+\n+    /** A ping-pong round trip has completed successfully. Update minimum ping time. */\n+    void UpdateMinPingTime(NodeId id, std::chrono::microseconds ping_time);\n+    std::optional<std::chrono::microseconds> GetMinPingTime(NodeId id) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919919355",
      "id" : 919919355,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII58421Nr7",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 46,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/node/eviction.h",
      "position" : 47,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919919355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919919355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919920733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919920733"
         }
      },
      "author_association" : "MEMBER",
      "body" : "/me idly wonders whether these setters can be templated to avoid repetitive boilerplate code",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:29:48Z",
      "diff_hunk" : "@@ -238,3 +241,194 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n     // Disconnect from the network group with the most connections\n     return vEvictionCandidates.front().id;\n }\n+\n+EvictionManagerImpl::EvictionManagerImpl() {}\n+EvictionManagerImpl::~EvictionManagerImpl() = default;\n+\n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{\n+        Desig(id) id,\n+        Desig(m_connected) connected,\n+        Desig(m_min_ping_time) std::chrono::microseconds::max(),\n+        Desig(m_last_block_time) 0s,\n+        Desig(m_last_tx_time) 0s,\n+        Desig(fRelevantServices) false,\n+        Desig(m_relay_txs) false,\n+        Desig(fBloomFilter) false,\n+        Desig(nKeyedNetGroup) keyed_net_group,\n+        Desig(prefer_evict) prefer_evict,\n+        Desig(m_is_local) is_local,\n+        Desig(m_network) network,\n+        Desig(m_noban) noban,\n+        Desig(m_conn_type) conn_type,\n+    };\n+    m_candidates.emplace_hint(m_candidates.end(), id, std::move(candidate));\n+}\n+\n+bool EvictionManagerImpl::RemoveCandidate(NodeId id)\n+{\n+    LOCK(m_candidates_mutex);\n+    return m_candidates.erase(id) != 0;\n+}\n+\n+std::optional<NodeId> EvictionManagerImpl::SelectNodeToEvict() const\n+{\n+    std::vector<NodeEvictionCandidate> candidates;\n+    {\n+        LOCK(m_candidates_mutex);\n+        for (const auto& [id, candidate] : m_candidates) {\n+            candidates.push_back(candidate);\n+        }\n+    }\n+    return ::SelectNodeToEvict(std::move(candidates));\n+}\n+\n+void EvictionManagerImpl::UpdateMinPingTime(NodeId id, std::chrono::microseconds ping_time)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919920733",
      "id" : 919920733,
      "line" : 293,
      "node_id" : "PRRC_kwDOABII58421OBd",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 293,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 70,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919920733/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919920733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919923454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919923454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:32:58Z",
      "diff_hunk" : "@@ -2,6 +2,7 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <node/eviction_impl.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919923454",
      "id" : 919923454,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII58421Or-",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 5,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/net_peer_eviction_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919923454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919923454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919928075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928075"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there any reason why this and `ProtectEvictionCandidatesByRatio()` aren't members of `EvictionManagerImpl`? I'm not saying they have to be, but I'm interested in the design choice.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:38:52Z",
      "diff_hunk" : "@@ -0,0 +1,107 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_EVICTION_IMPL_H\n+#define BITCOIN_NODE_EVICTION_IMPL_H\n+\n+#include <node/connection_types.h>\n+#include <net_permissions.h>\n+#include <sync.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <vector>\n+\n+typedef int64_t NodeId;\n+\n+struct NodeEvictionCandidate {\n+    NodeId id;\n+    std::chrono::seconds m_connected;\n+    std::chrono::microseconds m_min_ping_time;\n+    std::chrono::seconds m_last_block_time;\n+    std::chrono::seconds m_last_tx_time;\n+    bool fRelevantServices;\n+    bool m_relay_txs;\n+    bool fBloomFilter;\n+    uint64_t nKeyedNetGroup;\n+    bool prefer_evict;\n+    bool m_is_local;\n+    Network m_network;\n+    bool m_noban;\n+    ConnectionType m_conn_type;\n+};\n+\n+[[nodiscard]] std::optional<NodeId> SelectNodeToEvict(std::vector<NodeEvictionCandidate>&& vEvictionCandidates);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919928075",
      "id" : 919928075,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII58421P0L",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/eviction_impl.h",
      "position" : 36,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928075/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919928413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928413"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:39:17Z",
      "diff_hunk" : "@@ -2,6 +2,7 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <node/eviction_impl.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919928413",
      "id" : 919928413,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII58421P5d",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 5,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/fuzz/node_eviction.cpp",
      "position" : 4,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928413/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919928413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919930592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919930592"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even if you don't do this, I'd suggest marking the const members const, and group them before the mutable members.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T10:42:01Z",
      "diff_hunk" : "@@ -243,6 +244,53 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n EvictionManagerImpl::EvictionManagerImpl() {}\n EvictionManagerImpl::~EvictionManagerImpl() = default;\n \n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r919930592",
      "id" : 919930592,
      "in_reply_to_id" : 917088652,
      "line" : 256,
      "node_id" : "PRRC_kwDOABII58421Qbg",
      "original_commit_id" : "964c048e037231bd8aa5ed224e1883293d258d2a",
      "original_line" : 255,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 20,
      "pull_request_review_id" : 1037066665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919930592/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T10:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919930592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r920342327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920342327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a different set of nodes, so different loop. Do you mean to do it in the same scope?",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-13T17:37:03Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r920342327",
      "id" : 920342327,
      "in_reply_to_id" : 919888455,
      "line" : 1101,
      "node_id" : "PRRC_kwDOABII58422083",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1101,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 1037738516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920342327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1099,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T17:37:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920342327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921073763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921073763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess I don't understand why the node can't be removed from the EvictionManager either:\r\n\r\n- in the loop above, at the point where the node is removed from `m_nodes` and added to `m_nodes_disconnected`; or\r\n- in the loop below, at the point where the node is removed from `m_nodes_disconnected`.\r\n\r\nPerhaps a code comment could be added to explain why.",
      "commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "created_at" : "2022-07-14T11:57:56Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921073763",
      "id" : 921073763,
      "in_reply_to_id" : 919888455,
      "line" : 1101,
      "node_id" : "PRRC_kwDOABII58425nhj",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1101,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 1038748276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921073763/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1099,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-14T11:57:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921073763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921364786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gonna leave this for a follow-up.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T16:48:52Z",
      "diff_hunk" : "@@ -582,7 +554,6 @@ class CNode\n     /** A ping-pong round trip has completed successfully. Update latest and minimum ping times. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921364786",
      "id" : 921364786,
      "in_reply_to_id" : 919903257,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58426uky",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 554,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1039178882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T16:48:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921364985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T16:49:02Z",
      "diff_hunk" : "@@ -2555,6 +2554,22 @@ void CConnman::GetNodeStats(std::vector<CNodeStats>& vstats) const\n     for (CNode* pnode : m_nodes) {\n         vstats.emplace_back();\n         pnode->CopyStats(vstats.back());\n+\n+        auto min_ping_time{m_evictionman.GetMinPingTime(pnode->GetId())};\n+        if (min_ping_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921364985",
      "id" : 921364985,
      "in_reply_to_id" : 919912796,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58426un5",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 2559,
      "original_position" : 162,
      "original_start_line" : 2558,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1039179086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364985/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-14T16:49:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921364985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921369316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921369316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried to do this but the `src/test/net_peer_eviction_tests.cpp` tests sadly rely on no members of `NodeEvictionCandidate` being const. Would like to leave this for a follow up, since it requires changing those tests quite a bit. ",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T16:54:11Z",
      "diff_hunk" : "@@ -243,6 +244,53 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n EvictionManagerImpl::EvictionManagerImpl() {}\n EvictionManagerImpl::~EvictionManagerImpl() = default;\n \n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921369316",
      "id" : 921369316,
      "in_reply_to_id" : 917088652,
      "line" : 255,
      "node_id" : "PRRC_kwDOABII58426vrk",
      "original_commit_id" : "964c048e037231bd8aa5ed224e1883293d258d2a",
      "original_line" : 255,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 32,
      "pull_request_review_id" : 1039185247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921369316/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T16:54:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921369316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921381184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921381184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Cory originally suggested to it this way to untangle the removal from `m_nodes_mutex`. (See https://github.com/bitcoin/bitcoin/pull/25268#discussion_r903003875)\r\n\r\nI think it could make sense to do it in the `Delete disconnected nodes` loop below which is also independent of `m_node_mutex`. Another option would be to do it in `PeerManagerImpl::FinalizeNode()` but that might be weird since we add candidates in `net`.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T17:08:43Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921381184",
      "id" : 921381184,
      "in_reply_to_id" : 919888455,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58426ylA",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1100,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1039202087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921381184/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-14T17:08:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921381184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921404905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921404905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is something that @theuni  originally also had on his branch and i just went with the same design. To me this seems good because some of the tests purely test these functions without needing the eviction manager and adding them as members would require more test refactoring.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T17:24:40Z",
      "diff_hunk" : "@@ -0,0 +1,107 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_EVICTION_IMPL_H\n+#define BITCOIN_NODE_EVICTION_IMPL_H\n+\n+#include <node/connection_types.h>\n+#include <net_permissions.h>\n+#include <sync.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <vector>\n+\n+typedef int64_t NodeId;\n+\n+struct NodeEvictionCandidate {\n+    NodeId id;\n+    std::chrono::seconds m_connected;\n+    std::chrono::microseconds m_min_ping_time;\n+    std::chrono::seconds m_last_block_time;\n+    std::chrono::seconds m_last_tx_time;\n+    bool fRelevantServices;\n+    bool m_relay_txs;\n+    bool fBloomFilter;\n+    uint64_t nKeyedNetGroup;\n+    bool prefer_evict;\n+    bool m_is_local;\n+    Network m_network;\n+    bool m_noban;\n+    ConnectionType m_conn_type;\n+};\n+\n+[[nodiscard]] std::optional<NodeId> SelectNodeToEvict(std::vector<NodeEvictionCandidate>&& vEvictionCandidates);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921404905",
      "id" : 921404905,
      "in_reply_to_id" : 919928075,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII584264Xp",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/eviction_impl.h",
      "position" : 36,
      "pull_request_review_id" : 1039240589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921404905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T17:24:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921404905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921416938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921416938"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that test refactoring would probably be a good thing, since it would ensure that the unit test is not testing a state that EvictionManager can't get into in the product code. In general, that seems like a good model - unit tests use the public methods to update the state of the object being tested, but optionally also have access to const test-only methods to peek inside the state of the object if it's difficult to expose that state in other ways.\r\n\r\nCertainly not required in this PR. Could be done in a follow-up (or not at all).",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T17:39:32Z",
      "diff_hunk" : "@@ -0,0 +1,107 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_EVICTION_IMPL_H\n+#define BITCOIN_NODE_EVICTION_IMPL_H\n+\n+#include <node/connection_types.h>\n+#include <net_permissions.h>\n+#include <sync.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <vector>\n+\n+typedef int64_t NodeId;\n+\n+struct NodeEvictionCandidate {\n+    NodeId id;\n+    std::chrono::seconds m_connected;\n+    std::chrono::microseconds m_min_ping_time;\n+    std::chrono::seconds m_last_block_time;\n+    std::chrono::seconds m_last_tx_time;\n+    bool fRelevantServices;\n+    bool m_relay_txs;\n+    bool fBloomFilter;\n+    uint64_t nKeyedNetGroup;\n+    bool prefer_evict;\n+    bool m_is_local;\n+    Network m_network;\n+    bool m_noban;\n+    ConnectionType m_conn_type;\n+};\n+\n+[[nodiscard]] std::optional<NodeId> SelectNodeToEvict(std::vector<NodeEvictionCandidate>&& vEvictionCandidates);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921416938",
      "id" : 921416938,
      "in_reply_to_id" : 919928075,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII584267Tq",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/eviction_impl.h",
      "position" : 36,
      "pull_request_review_id" : 1039257797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921416938/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T17:39:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921416938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921429991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921429991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks for the explanation.\r\n\r\nI can't see any reason why this call would have to be done outside the `m_nodes_mutex`. EvictionManager should never call into net, so there isn't any chance of a lock inversion. Besides, there are other EvictionManager methods (eg the `Get...()` methods) which are called while holding `m_nodes_mutex`.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-14T17:55:42Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r921429991",
      "id" : 921429991,
      "in_reply_to_id" : 919888455,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58426-fn",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1100,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1039276262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921429991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-14T17:55:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921429991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r931118832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931118832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved this back into the loop above.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-27T14:15:04Z",
      "diff_hunk" : "@@ -1112,6 +1095,11 @@ void CConnman::DisconnectNodes()\n             }\n         }\n     }\n+\n+    for (NodeId id : disconnected_eviction_candidates) {\n+        m_evictionman.RemoveCandidate(id);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r931118832",
      "id" : 931118832,
      "in_reply_to_id" : 919888455,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843f77w",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 1100,
      "original_position" : 122,
      "original_start_line" : 1099,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1052588154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931118832/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-27T14:15:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931118832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r931120933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931120933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tried to come up with a cool way of doing this with templates but didn't end with anything useful.",
      "commit_id" : "ebdb034bbed95fb8bdc5bcd7d91fa5cf7e1cf126",
      "created_at" : "2022-07-27T14:16:48Z",
      "diff_hunk" : "@@ -238,3 +241,194 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n     // Disconnect from the network group with the most connections\n     return vEvictionCandidates.front().id;\n }\n+\n+EvictionManagerImpl::EvictionManagerImpl() {}\n+EvictionManagerImpl::~EvictionManagerImpl() = default;\n+\n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{\n+        Desig(id) id,\n+        Desig(m_connected) connected,\n+        Desig(m_min_ping_time) std::chrono::microseconds::max(),\n+        Desig(m_last_block_time) 0s,\n+        Desig(m_last_tx_time) 0s,\n+        Desig(fRelevantServices) false,\n+        Desig(m_relay_txs) false,\n+        Desig(fBloomFilter) false,\n+        Desig(nKeyedNetGroup) keyed_net_group,\n+        Desig(prefer_evict) prefer_evict,\n+        Desig(m_is_local) is_local,\n+        Desig(m_network) network,\n+        Desig(m_noban) noban,\n+        Desig(m_conn_type) conn_type,\n+    };\n+    m_candidates.emplace_hint(m_candidates.end(), id, std::move(candidate));\n+}\n+\n+bool EvictionManagerImpl::RemoveCandidate(NodeId id)\n+{\n+    LOCK(m_candidates_mutex);\n+    return m_candidates.erase(id) != 0;\n+}\n+\n+std::optional<NodeId> EvictionManagerImpl::SelectNodeToEvict() const\n+{\n+    std::vector<NodeEvictionCandidate> candidates;\n+    {\n+        LOCK(m_candidates_mutex);\n+        for (const auto& [id, candidate] : m_candidates) {\n+            candidates.push_back(candidate);\n+        }\n+    }\n+    return ::SelectNodeToEvict(std::move(candidates));\n+}\n+\n+void EvictionManagerImpl::UpdateMinPingTime(NodeId id, std::chrono::microseconds ping_time)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r931120933",
      "id" : 931120933,
      "in_reply_to_id" : 919920733,
      "line" : 292,
      "node_id" : "PRRC_kwDOABII5843f8cl",
      "original_commit_id" : "2f93a9fc878a8a41643a8776fa72c260aa85ebd5",
      "original_line" : 292,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 69,
      "pull_request_review_id" : 1052591151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931120933/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-27T14:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/931120933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2022-07-27T14:25:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1196830895",
      "id" : 1196830895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585HVjCv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1196830895/reactions"
      },
      "updated_at" : "2022-07-27T14:25:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1196830895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:23:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1203703286",
      "id" : 1203703286,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585Hvw32",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703286/reactions"
      },
      "updated_at" : "2022-08-03T09:23:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r956208202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956208202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, I'd say if the tests rely on non-const values, then the tests need to be reworked somewhat (I assume they're just re-using existing candidates as opposed to creating new ones for the sake of simplicity). Either that or they're testing state-changes that aren't possible.\r\n\r\nAgree that it's not worth refactoring the tests in this PR, but could you maybe organize the members and add a note to the definition of `NodeEvictionCandidate` to make the possible state changes clear? I *think* there are basically 3 types, though I may be oversimplifying:\r\n- These never change after creation\r\n- These may change once\r\n- These may change at any time",
      "commit_id" : "4f8be7050ad263c5d12f6365601541e0b2e2b303",
      "created_at" : "2022-08-26T16:23:44Z",
      "diff_hunk" : "@@ -243,6 +244,53 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n EvictionManagerImpl::EvictionManagerImpl() {}\n EvictionManagerImpl::~EvictionManagerImpl() = default;\n \n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in\n+    // newer candidates being more likely to be evicted.\n+    NodeEvictionCandidate candidate{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r956208202",
      "id" : 956208202,
      "in_reply_to_id" : 917088652,
      "line" : 255,
      "node_id" : "PRRC_kwDOABII5844_pRK",
      "original_commit_id" : "964c048e037231bd8aa5ed224e1883293d258d2a",
      "original_line" : 255,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 32,
      "pull_request_review_id" : 1087203008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956208202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-26T16:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956208202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs a quick linter fix.",
      "created_at" : "2022-08-26T16:26:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1228695604",
      "id" : 1228695604,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585JPGg0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1228695604/reactions"
      },
      "updated_at" : "2022-08-26T16:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1228695604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-26T22:25:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1229011215",
      "id" : 1229011215,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585JQTkP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1229011215/reactions"
      },
      "updated_at" : "2022-08-26T22:25:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1229011215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This has been rebased (including a small linter fix) and is ready for review again!",
      "created_at" : "2022-09-09T17:14:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1242241204",
      "id" : 1242241204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585KCxi0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1242241204/reactions"
      },
      "updated_at" : "2022-09-09T17:14:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1242241204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r968097030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968097030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why don't go further and summarize which parameters actually matter? Or just mention `why` it is so",
      "commit_id" : "29c853614ac7ffbd6ab6c009f297f92149843e32",
      "created_at" : "2022-09-12T08:00:25Z",
      "diff_hunk" : "@@ -243,6 +244,53 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n EvictionManagerImpl::EvictionManagerImpl() {}\n EvictionManagerImpl::~EvictionManagerImpl() = default;\n \n+void EvictionManagerImpl::AddCandidate(NodeId id, std::chrono::seconds connected,\n+                                       uint64_t keyed_net_group, bool prefer_evict,\n+                                       bool is_local, Network network,\n+                                       bool noban, ConnectionType conn_type)\n+{\n+    LOCK(m_candidates_mutex);\n+    // The default values used to initialise the eviction candidates result in",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#discussion_r968097030",
      "id" : 968097030,
      "line" : 253,
      "node_id" : "PRRC_kwDOABII5845s_0G",
      "original_commit_id" : "82eb8d34d5910ac97c151f55dbad7fdb1966f9b1",
      "original_line" : 253,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/eviction.cpp",
      "position" : 18,
      "pull_request_review_id" : 1103640256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25572",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968097030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T08:00:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968097030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, light code review ACK 29c853614ac7ffbd6ab6c009f297f92149843e32.\r\nThis is a great refactor.",
      "created_at" : "2022-09-12T08:17:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25572#issuecomment-1243376621",
      "id" : 1243376621,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25572",
      "node_id" : "IC_kwDOABII585KHGvt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1243376621/reactions"
      },
      "updated_at" : "2022-09-12T08:17:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1243376621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
