[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25218](https://github.com/bitcoin/bitcoin/pull/25218) (refactor: introduce generic 'Result' class and connect it to CreateTransaction and GetNewDestination by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-05-28T15:08:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1140280764",
      "id" : 1140280764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585D9028",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1140280764/reactions"
      },
      "updated_at" : "2022-06-26T17:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1140280764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r887271909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887271909"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please give this function a different name, overloading it based on return type and an extra parameter can be potentially confusing.",
      "commit_id" : "ca8ef4c6f7f9de022e92a586d46a75de486b026d",
      "created_at" : "2022-06-01T20:30:26Z",
      "diff_hunk" : "@@ -20,11 +20,15 @@ const std::string ADDRESS_BCRT1_UNSPENDABLE = \"bcrt1qqqqqqqqqqqqqqqqqqqqqqqqqqqq\n std::string getnewaddress(CWallet& w)\n {\n     constexpr auto output_type = OutputType::BECH32;\n+    return EncodeDestination(getnewaddress(w, output_type));\n+}\n+\n+CTxDestination getnewaddress(CWallet& w, OutputType output_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r887271909",
      "id" : 887271909,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII58404rHl",
      "original_commit_id" : "ca8ef4c6f7f9de022e92a586d46a75de486b026d",
      "original_line" : 26,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/util/wallet.cpp",
      "position" : 7,
      "pull_request_review_id" : 992642144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887271909/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-01T20:30:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887271909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on benchmarking these, however there have been recent complaints that the benchmarks are slow, and  I've noticed these add more fairly slow to run benchmarks:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      359,740,298.60 |                2.78 |    0.0% |     19.79 | `WalletAvailableCoinsMulti`\r\n|      289,759,212.20 |                3.45 |    0.0% |     15.93 | `WalletAvailableCoinsOnlyBech32`\r\n|      559,973,432.00 |                1.79 |    0.0% |     30.80 | `WalletAvailableCoinsOnlyBech32M`\r\n|      196,348,457.20 |                5.09 |    0.0% |     10.80 | `WalletAvailableCoinsOnlyLegacy`\r\n|      304,247,935.40 |                3.29 |    0.0% |     16.73 | `WalletAvailableCoinsOnlyP2SH_SEGWIT`\r\n```\r\nE.g. a total of 94 seconds to the runtime of `bench_bitcoin` with default settings.\r\n",
      "created_at" : "2022-06-01T20:59:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1144128408",
      "id" : 1144128408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585EMgOY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144128408/reactions"
      },
      "updated_at" : "2022-06-01T20:59:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144128408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r887877160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887877160"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah agree, pushed.",
      "commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "created_at" : "2022-06-02T12:07:53Z",
      "diff_hunk" : "@@ -20,11 +20,15 @@ const std::string ADDRESS_BCRT1_UNSPENDABLE = \"bcrt1qqqqqqqqqqqqqqqqqqqqqqqqqqqq\n std::string getnewaddress(CWallet& w)\n {\n     constexpr auto output_type = OutputType::BECH32;\n+    return EncodeDestination(getnewaddress(w, output_type));\n+}\n+\n+CTxDestination getnewaddress(CWallet& w, OutputType output_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r887877160",
      "id" : 887877160,
      "in_reply_to_id" : 887271909,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58406-4o",
      "original_commit_id" : "ca8ef4c6f7f9de022e92a586d46a75de486b026d",
      "original_line" : 26,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/util/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 993434071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887877160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T12:46:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887877160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks laanwj for the review!\r\n\r\nIt's interesting to see other results, locally this are my results:\r\n\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      132,289,908.40 |                7.56 |    0.3% |      7.27 | `WalletAvailableCoinsMulti`\r\n|      104,691,758.40 |                9.55 |    0.1% |      5.77 | `WalletAvailableCoinsOnlyBech32`\r\n|      196,688,875.00 |                5.08 |    0.2% |     10.82 | `WalletAvailableCoinsOnlyBech32M`\r\n|       70,386,791.80 |               14.21 |    0.2% |      3.88 | `WalletAvailableCoinsOnlyLegacy`\r\n|      111,477,558.20 |                8.97 |    0.1% |      6.14 | `WalletAvailableCoinsOnlyP2SH_SEGWIT`\r\n```\r\n\r\nBut let me do something, going to decrease the bench number of iterations from 5 to 2. It should decrease the total time by half.",
      "created_at" : "2022-06-02T12:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1144792814",
      "id" : 1144792814,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585EPCbu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144792814/reactions"
      },
      "updated_at" : "2022-06-02T12:13:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144792814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, decreased the number of iterations to 2. And this are the results:\r\n\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      129,406,083.50 |                7.73 |    0.0% |      2.85 | `WalletAvailableCoinsMulti`\r\n|      105,704,646.00 |                9.46 |    0.2% |      2.33 | `WalletAvailableCoinsOnlyBech32`\r\n|      206,642,667.00 |                4.84 |    0.6% |      4.55 | `WalletAvailableCoinsOnlyBech32M`\r\n|       69,838,895.50 |               14.32 |    0.0% |      1.54 | `WalletAvailableCoinsOnlyLegacy`\r\n|      112,263,500.00 |                8.91 |    0.0% |      2.47 | `WalletAvailableCoinsOnlyP2SH_SEGWIT`\r\n```\r\n\r\nTotal time: ~15 seconds to run the 5 new benchmarks at most here now.\r\nPreviously, with 5 iterations, total time was ~40 seconds. So, you should see more or less a 40% total time decrease there as well.",
      "created_at" : "2022-06-02T12:24:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1144801962",
      "id" : 1144801962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585EPEqq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144801962/reactions"
      },
      "updated_at" : "2022-06-02T12:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144801962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Aside from that, I think that a good future question to ask ourselves would be whether we want to always run all the benchmarks all the time or not. Because, sooner or later, as the project isn't going to stop growing, we could end up sacrificing accuracy, implementing not entirely real scenarios (skipping parts of the flow that is being benchmarked) in favor of decreasing the total bench time (there is where my comment in https://github.com/bitcoin/bitcoin/pull/24924#pullrequestreview-985000006 heads to for example).\r\n\r\nBut well, this is just me thinking out loud.. after #24924, the total bench time will be pretty decent to not have to worry about this for a while.",
      "created_at" : "2022-06-02T12:44:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1144820954",
      "id" : 1144820954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585EPJTa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144820954/reactions"
      },
      "updated_at" : "2022-06-02T12:44:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144820954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r888277799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888277799"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b791c2ae2eb02ff53762ac5ed2b355e5248ac041 \"bench: add benchmark for wallet 'AvailableCoins' function.\"\r\n\r\nThe type of `ScriptPubKeyMan` is not related to the `OutputType`, so having this depend on the OutputType does not make sense. Unfortunately the word \"legacy\" refers to a number of different things within the wallet.\r\n\r\nThe type of wallet is only going to have an effect on how `IsMine` performs, and I don't think that really matters for this measurement.",
      "commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "created_at" : "2022-06-02T18:43:25Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <chainparams.h>\n+#include <consensus/merkle.h>\n+#include <node/context.h>\n+#include <test/util/setup_common.h>\n+#include <test/util/wallet.h>\n+#include <validation.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+using wallet::CWallet;\n+using wallet::CreateMockWalletDatabase;\n+using wallet::DBErrors;\n+using wallet::WALLET_FLAG_DESCRIPTORS;\n+\n+struct TipBlock\n+{\n+    uint256 prev_block_hash;\n+    int64_t prev_block_time;\n+    int tip_height;\n+};\n+\n+TipBlock getTip(const CChainParams& params, const node::NodeContext& context)\n+{\n+    auto tip = context.chainman->ActiveTip();\n+    return (tip) ? TipBlock{tip->GetBlockHash(), tip->GetBlockTime(), tip->nHeight} :\n+           TipBlock{params.GenesisBlock().GetHash(), params.GenesisBlock().GetBlockTime(), 0};\n+}\n+\n+void generateFakeBlock(const CChainParams& params,\n+                       const node::NodeContext& context,\n+                       CWallet& wallet,\n+                       const CScript& coinbase_out_script)\n+{\n+    TipBlock tip{getTip(params, context)};\n+\n+    // Create block\n+    CBlock block;\n+    CMutableTransaction coinbase_tx;\n+    coinbase_tx.vin.resize(1);\n+    coinbase_tx.vin[0].prevout.SetNull();\n+    coinbase_tx.vout.resize(2);\n+    coinbase_tx.vout[0].scriptPubKey = coinbase_out_script;\n+    coinbase_tx.vout[0].nValue = 49 * COIN;\n+    coinbase_tx.vin[0].scriptSig = CScript() << ++tip.tip_height << OP_0;\n+    coinbase_tx.vout[1].scriptPubKey = coinbase_out_script; // extra output\n+    coinbase_tx.vout[1].nValue = 1 * COIN;\n+    block.vtx = {MakeTransactionRef(std::move(coinbase_tx))};\n+\n+    block.nVersion = VERSIONBITS_LAST_OLD_BLOCK_VERSION;\n+    block.hashPrevBlock = tip.prev_block_hash;\n+    block.hashMerkleRoot = BlockMerkleRoot(block);\n+    block.nTime = ++tip.prev_block_time;\n+    block.nBits = params.GenesisBlock().nBits;\n+    block.nNonce = 0;\n+\n+    {\n+        LOCK(::cs_main);\n+        // Add it to the index\n+        CBlockIndex *pindex{context.chainman->m_blockman.AddToBlockIndex(block, context.chainman->m_best_header)};\n+        // add it to the chain\n+        context.chainman->ActiveChain().SetTip(pindex);\n+    }\n+\n+    // notify wallet\n+    wallet.blockConnected(block, tip.tip_height);\n+}\n+\n+static void WalletAvailableCoins(benchmark::Bench& bench, const std::vector<OutputType>& output_type)\n+{\n+    const auto test_setup = MakeNoLogFileContext<const TestingSetup>();\n+\n+    CWallet wallet{test_setup->m_node.chain.get(), \"\", gArgs, CreateMockWalletDatabase()};\n+    {\n+        LOCK(wallet.cs_wallet);\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type > OutputType::LEGACY;})) {\n+            wallet.SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+            wallet.SetupDescriptorScriptPubKeyMans();\n+        }\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type == OutputType::LEGACY;})) {\n+            wallet.SetupLegacyScriptPubKeyMan();\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r888277799",
      "id" : 888277799,
      "line" : 86,
      "node_id" : "PRRC_kwDOABII58408gsn",
      "original_commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : 80,
      "path" : "src/bench/wallet_available_coins.cpp",
      "position" : 86,
      "pull_request_review_id" : 994003830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888277799/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 80,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-02T18:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888277799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r888279929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888279929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b791c2ae2eb02ff53762ac5ed2b355e5248ac041 \"bench: add benchmark for wallet 'AvailableCoins' function.\"\r\n\r\nI don't really think it is useful to have `AvailableCoins` run for different `OutputTypes`. There really isn't any difference for how `AvailableCoins` behaves depending on the `OutputType`.",
      "commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "created_at" : "2022-06-02T18:46:25Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <chainparams.h>\n+#include <consensus/merkle.h>\n+#include <node/context.h>\n+#include <test/util/setup_common.h>\n+#include <test/util/wallet.h>\n+#include <validation.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+using wallet::CWallet;\n+using wallet::CreateMockWalletDatabase;\n+using wallet::DBErrors;\n+using wallet::WALLET_FLAG_DESCRIPTORS;\n+\n+struct TipBlock\n+{\n+    uint256 prev_block_hash;\n+    int64_t prev_block_time;\n+    int tip_height;\n+};\n+\n+TipBlock getTip(const CChainParams& params, const node::NodeContext& context)\n+{\n+    auto tip = context.chainman->ActiveTip();\n+    return (tip) ? TipBlock{tip->GetBlockHash(), tip->GetBlockTime(), tip->nHeight} :\n+           TipBlock{params.GenesisBlock().GetHash(), params.GenesisBlock().GetBlockTime(), 0};\n+}\n+\n+void generateFakeBlock(const CChainParams& params,\n+                       const node::NodeContext& context,\n+                       CWallet& wallet,\n+                       const CScript& coinbase_out_script)\n+{\n+    TipBlock tip{getTip(params, context)};\n+\n+    // Create block\n+    CBlock block;\n+    CMutableTransaction coinbase_tx;\n+    coinbase_tx.vin.resize(1);\n+    coinbase_tx.vin[0].prevout.SetNull();\n+    coinbase_tx.vout.resize(2);\n+    coinbase_tx.vout[0].scriptPubKey = coinbase_out_script;\n+    coinbase_tx.vout[0].nValue = 49 * COIN;\n+    coinbase_tx.vin[0].scriptSig = CScript() << ++tip.tip_height << OP_0;\n+    coinbase_tx.vout[1].scriptPubKey = coinbase_out_script; // extra output\n+    coinbase_tx.vout[1].nValue = 1 * COIN;\n+    block.vtx = {MakeTransactionRef(std::move(coinbase_tx))};\n+\n+    block.nVersion = VERSIONBITS_LAST_OLD_BLOCK_VERSION;\n+    block.hashPrevBlock = tip.prev_block_hash;\n+    block.hashMerkleRoot = BlockMerkleRoot(block);\n+    block.nTime = ++tip.prev_block_time;\n+    block.nBits = params.GenesisBlock().nBits;\n+    block.nNonce = 0;\n+\n+    {\n+        LOCK(::cs_main);\n+        // Add it to the index\n+        CBlockIndex *pindex{context.chainman->m_blockman.AddToBlockIndex(block, context.chainman->m_best_header)};\n+        // add it to the chain\n+        context.chainman->ActiveChain().SetTip(pindex);\n+    }\n+\n+    // notify wallet\n+    wallet.blockConnected(block, tip.tip_height);\n+}\n+\n+static void WalletAvailableCoins(benchmark::Bench& bench, const std::vector<OutputType>& output_type)\n+{\n+    const auto test_setup = MakeNoLogFileContext<const TestingSetup>();\n+\n+    CWallet wallet{test_setup->m_node.chain.get(), \"\", gArgs, CreateMockWalletDatabase()};\n+    {\n+        LOCK(wallet.cs_wallet);\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type > OutputType::LEGACY;})) {\n+            wallet.SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+            wallet.SetupDescriptorScriptPubKeyMans();\n+        }\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type == OutputType::LEGACY;})) {\n+            wallet.SetupLegacyScriptPubKeyMan();\n+        }\n+        if (wallet.LoadWallet() != DBErrors::LOAD_OK) assert(false);\n+    }\n+\n+    // Generate destinations\n+    std::vector<CScript> dest_wallet;\n+    for (auto type : output_type) {\n+        dest_wallet.emplace_back(GetScriptForDestination(getNewDestination(wallet, type)));\n+    }\n+\n+    // Generate chain; each coinbase will have two outputs to fill-up the wallet\n+    const auto& params = Params();\n+    unsigned int chain_size = 1000;\n+    for (unsigned int i = 0; i < chain_size / dest_wallet.size(); ++i) {\n+        for (auto dest : dest_wallet) {\n+            generateFakeBlock(params, test_setup->m_node, wallet, dest);\n+        }\n+    }\n+\n+    // Check available balance\n+    auto bal = wallet::GetAvailableBalance(wallet); // Cache\n+    assert(bal == 50 * COIN * (chain_size - COINBASE_MATURITY));\n+\n+    bench.epochIterations(2).run([&] {\n+        LOCK(wallet.cs_wallet);\n+        std::vector<wallet::COutput> vCoins;\n+        wallet::AvailableCoins(wallet, vCoins);\n+\n+        assert(vCoins.size() == (chain_size - COINBASE_MATURITY) * 2);\n+    });\n+}\n+\n+static void WalletAvailableCoinsOnlyBech32M(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32M}); }\n+static void WalletAvailableCoinsOnlyBech32(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32}); }\n+static void WalletAvailableCoinsOnlyP2SH_SEGWIT(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::P2SH_SEGWIT}); }\n+static void WalletAvailableCoinsOnlyLegacy(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY}); }\n+static void WalletAvailableCoinsMulti(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY, OutputType::BECH32M, OutputType::BECH32, OutputType::P2SH_SEGWIT}); }\n+\n+BENCHMARK(WalletAvailableCoinsOnlyBech32M);\n+BENCHMARK(WalletAvailableCoinsOnlyBech32);\n+BENCHMARK(WalletAvailableCoinsOnlyP2SH_SEGWIT);\n+BENCHMARK(WalletAvailableCoinsOnlyLegacy);\n+BENCHMARK(WalletAvailableCoinsMulti);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r888279929",
      "id" : 888279929,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII58408hN5",
      "original_commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "original_line" : 128,
      "original_position" : 128,
      "original_start_line" : 118,
      "path" : "src/bench/wallet_available_coins.cpp",
      "position" : 128,
      "pull_request_review_id" : 994003830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888279929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-02T18:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888279929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r906879843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906879843"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, wouldn't we be having the same benchmark times for all the cases if that would be the case? (we are adding the same amount of txs and outputs to each of them).\r\n\r\nI mean, your #24699 improves exactly this. The time difference there is for the solving provider and `IsMine` related calls.",
      "commit_id" : "fd583c8184ef2a270e7df13360f78fd9dda258a0",
      "created_at" : "2022-06-26T22:36:21Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <chainparams.h>\n+#include <consensus/merkle.h>\n+#include <node/context.h>\n+#include <test/util/setup_common.h>\n+#include <test/util/wallet.h>\n+#include <validation.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+using wallet::CWallet;\n+using wallet::CreateMockWalletDatabase;\n+using wallet::DBErrors;\n+using wallet::WALLET_FLAG_DESCRIPTORS;\n+\n+struct TipBlock\n+{\n+    uint256 prev_block_hash;\n+    int64_t prev_block_time;\n+    int tip_height;\n+};\n+\n+TipBlock getTip(const CChainParams& params, const node::NodeContext& context)\n+{\n+    auto tip = context.chainman->ActiveTip();\n+    return (tip) ? TipBlock{tip->GetBlockHash(), tip->GetBlockTime(), tip->nHeight} :\n+           TipBlock{params.GenesisBlock().GetHash(), params.GenesisBlock().GetBlockTime(), 0};\n+}\n+\n+void generateFakeBlock(const CChainParams& params,\n+                       const node::NodeContext& context,\n+                       CWallet& wallet,\n+                       const CScript& coinbase_out_script)\n+{\n+    TipBlock tip{getTip(params, context)};\n+\n+    // Create block\n+    CBlock block;\n+    CMutableTransaction coinbase_tx;\n+    coinbase_tx.vin.resize(1);\n+    coinbase_tx.vin[0].prevout.SetNull();\n+    coinbase_tx.vout.resize(2);\n+    coinbase_tx.vout[0].scriptPubKey = coinbase_out_script;\n+    coinbase_tx.vout[0].nValue = 49 * COIN;\n+    coinbase_tx.vin[0].scriptSig = CScript() << ++tip.tip_height << OP_0;\n+    coinbase_tx.vout[1].scriptPubKey = coinbase_out_script; // extra output\n+    coinbase_tx.vout[1].nValue = 1 * COIN;\n+    block.vtx = {MakeTransactionRef(std::move(coinbase_tx))};\n+\n+    block.nVersion = VERSIONBITS_LAST_OLD_BLOCK_VERSION;\n+    block.hashPrevBlock = tip.prev_block_hash;\n+    block.hashMerkleRoot = BlockMerkleRoot(block);\n+    block.nTime = ++tip.prev_block_time;\n+    block.nBits = params.GenesisBlock().nBits;\n+    block.nNonce = 0;\n+\n+    {\n+        LOCK(::cs_main);\n+        // Add it to the index\n+        CBlockIndex *pindex{context.chainman->m_blockman.AddToBlockIndex(block, context.chainman->m_best_header)};\n+        // add it to the chain\n+        context.chainman->ActiveChain().SetTip(pindex);\n+    }\n+\n+    // notify wallet\n+    wallet.blockConnected(block, tip.tip_height);\n+}\n+\n+static void WalletAvailableCoins(benchmark::Bench& bench, const std::vector<OutputType>& output_type)\n+{\n+    const auto test_setup = MakeNoLogFileContext<const TestingSetup>();\n+\n+    CWallet wallet{test_setup->m_node.chain.get(), \"\", gArgs, CreateMockWalletDatabase()};\n+    {\n+        LOCK(wallet.cs_wallet);\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type > OutputType::LEGACY;})) {\n+            wallet.SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+            wallet.SetupDescriptorScriptPubKeyMans();\n+        }\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type == OutputType::LEGACY;})) {\n+            wallet.SetupLegacyScriptPubKeyMan();\n+        }\n+        if (wallet.LoadWallet() != DBErrors::LOAD_OK) assert(false);\n+    }\n+\n+    // Generate destinations\n+    std::vector<CScript> dest_wallet;\n+    for (auto type : output_type) {\n+        dest_wallet.emplace_back(GetScriptForDestination(getNewDestination(wallet, type)));\n+    }\n+\n+    // Generate chain; each coinbase will have two outputs to fill-up the wallet\n+    const auto& params = Params();\n+    unsigned int chain_size = 1000;\n+    for (unsigned int i = 0; i < chain_size / dest_wallet.size(); ++i) {\n+        for (auto dest : dest_wallet) {\n+            generateFakeBlock(params, test_setup->m_node, wallet, dest);\n+        }\n+    }\n+\n+    // Check available balance\n+    auto bal = wallet::GetAvailableBalance(wallet); // Cache\n+    assert(bal == 50 * COIN * (chain_size - COINBASE_MATURITY));\n+\n+    bench.epochIterations(2).run([&] {\n+        LOCK(wallet.cs_wallet);\n+        std::vector<wallet::COutput> vCoins;\n+        wallet::AvailableCoins(wallet, vCoins);\n+\n+        assert(vCoins.size() == (chain_size - COINBASE_MATURITY) * 2);\n+    });\n+}\n+\n+static void WalletAvailableCoinsOnlyBech32M(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32M}); }\n+static void WalletAvailableCoinsOnlyBech32(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32}); }\n+static void WalletAvailableCoinsOnlyP2SH_SEGWIT(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::P2SH_SEGWIT}); }\n+static void WalletAvailableCoinsOnlyLegacy(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY}); }\n+static void WalletAvailableCoinsMulti(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY, OutputType::BECH32M, OutputType::BECH32, OutputType::P2SH_SEGWIT}); }\n+\n+BENCHMARK(WalletAvailableCoinsOnlyBech32M);\n+BENCHMARK(WalletAvailableCoinsOnlyBech32);\n+BENCHMARK(WalletAvailableCoinsOnlyP2SH_SEGWIT);\n+BENCHMARK(WalletAvailableCoinsOnlyLegacy);\n+BENCHMARK(WalletAvailableCoinsMulti);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r906879843",
      "id" : 906879843,
      "in_reply_to_id" : 888279929,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII5842DeNj",
      "original_commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "original_line" : 127,
      "original_position" : 128,
      "original_start_line" : 118,
      "path" : "src/bench/wallet_available_coins.cpp",
      "position" : 127,
      "pull_request_review_id" : 1019485448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906879843/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 117,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-26T22:36:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906879843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r914966747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914966747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, it should be the same benchmark times for all cases, so it doesn't make sense to run it separately for each `OutputType`.",
      "commit_id" : "b2ec705072d85ce73c9aef1110a9afb78c5362cb",
      "created_at" : "2022-07-06T15:16:38Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <chainparams.h>\n+#include <consensus/merkle.h>\n+#include <node/context.h>\n+#include <test/util/setup_common.h>\n+#include <test/util/wallet.h>\n+#include <validation.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+using wallet::CWallet;\n+using wallet::CreateMockWalletDatabase;\n+using wallet::DBErrors;\n+using wallet::WALLET_FLAG_DESCRIPTORS;\n+\n+struct TipBlock\n+{\n+    uint256 prev_block_hash;\n+    int64_t prev_block_time;\n+    int tip_height;\n+};\n+\n+TipBlock getTip(const CChainParams& params, const node::NodeContext& context)\n+{\n+    auto tip = context.chainman->ActiveTip();\n+    return (tip) ? TipBlock{tip->GetBlockHash(), tip->GetBlockTime(), tip->nHeight} :\n+           TipBlock{params.GenesisBlock().GetHash(), params.GenesisBlock().GetBlockTime(), 0};\n+}\n+\n+void generateFakeBlock(const CChainParams& params,\n+                       const node::NodeContext& context,\n+                       CWallet& wallet,\n+                       const CScript& coinbase_out_script)\n+{\n+    TipBlock tip{getTip(params, context)};\n+\n+    // Create block\n+    CBlock block;\n+    CMutableTransaction coinbase_tx;\n+    coinbase_tx.vin.resize(1);\n+    coinbase_tx.vin[0].prevout.SetNull();\n+    coinbase_tx.vout.resize(2);\n+    coinbase_tx.vout[0].scriptPubKey = coinbase_out_script;\n+    coinbase_tx.vout[0].nValue = 49 * COIN;\n+    coinbase_tx.vin[0].scriptSig = CScript() << ++tip.tip_height << OP_0;\n+    coinbase_tx.vout[1].scriptPubKey = coinbase_out_script; // extra output\n+    coinbase_tx.vout[1].nValue = 1 * COIN;\n+    block.vtx = {MakeTransactionRef(std::move(coinbase_tx))};\n+\n+    block.nVersion = VERSIONBITS_LAST_OLD_BLOCK_VERSION;\n+    block.hashPrevBlock = tip.prev_block_hash;\n+    block.hashMerkleRoot = BlockMerkleRoot(block);\n+    block.nTime = ++tip.prev_block_time;\n+    block.nBits = params.GenesisBlock().nBits;\n+    block.nNonce = 0;\n+\n+    {\n+        LOCK(::cs_main);\n+        // Add it to the index\n+        CBlockIndex *pindex{context.chainman->m_blockman.AddToBlockIndex(block, context.chainman->m_best_header)};\n+        // add it to the chain\n+        context.chainman->ActiveChain().SetTip(pindex);\n+    }\n+\n+    // notify wallet\n+    wallet.blockConnected(block, tip.tip_height);\n+}\n+\n+static void WalletAvailableCoins(benchmark::Bench& bench, const std::vector<OutputType>& output_type)\n+{\n+    const auto test_setup = MakeNoLogFileContext<const TestingSetup>();\n+\n+    CWallet wallet{test_setup->m_node.chain.get(), \"\", gArgs, CreateMockWalletDatabase()};\n+    {\n+        LOCK(wallet.cs_wallet);\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type > OutputType::LEGACY;})) {\n+            wallet.SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+            wallet.SetupDescriptorScriptPubKeyMans();\n+        }\n+        if (std::any_of(output_type.begin(), output_type.end(), [](OutputType type){return type == OutputType::LEGACY;})) {\n+            wallet.SetupLegacyScriptPubKeyMan();\n+        }\n+        if (wallet.LoadWallet() != DBErrors::LOAD_OK) assert(false);\n+    }\n+\n+    // Generate destinations\n+    std::vector<CScript> dest_wallet;\n+    for (auto type : output_type) {\n+        dest_wallet.emplace_back(GetScriptForDestination(getNewDestination(wallet, type)));\n+    }\n+\n+    // Generate chain; each coinbase will have two outputs to fill-up the wallet\n+    const auto& params = Params();\n+    unsigned int chain_size = 1000;\n+    for (unsigned int i = 0; i < chain_size / dest_wallet.size(); ++i) {\n+        for (auto dest : dest_wallet) {\n+            generateFakeBlock(params, test_setup->m_node, wallet, dest);\n+        }\n+    }\n+\n+    // Check available balance\n+    auto bal = wallet::GetAvailableBalance(wallet); // Cache\n+    assert(bal == 50 * COIN * (chain_size - COINBASE_MATURITY));\n+\n+    bench.epochIterations(2).run([&] {\n+        LOCK(wallet.cs_wallet);\n+        std::vector<wallet::COutput> vCoins;\n+        wallet::AvailableCoins(wallet, vCoins);\n+\n+        assert(vCoins.size() == (chain_size - COINBASE_MATURITY) * 2);\n+    });\n+}\n+\n+static void WalletAvailableCoinsOnlyBech32M(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32M}); }\n+static void WalletAvailableCoinsOnlyBech32(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::BECH32}); }\n+static void WalletAvailableCoinsOnlyP2SH_SEGWIT(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::P2SH_SEGWIT}); }\n+static void WalletAvailableCoinsOnlyLegacy(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY}); }\n+static void WalletAvailableCoinsMulti(benchmark::Bench& bench) { WalletAvailableCoins(bench, {OutputType::LEGACY, OutputType::BECH32M, OutputType::BECH32, OutputType::P2SH_SEGWIT}); }\n+\n+BENCHMARK(WalletAvailableCoinsOnlyBech32M);\n+BENCHMARK(WalletAvailableCoinsOnlyBech32);\n+BENCHMARK(WalletAvailableCoinsOnlyP2SH_SEGWIT);\n+BENCHMARK(WalletAvailableCoinsOnlyLegacy);\n+BENCHMARK(WalletAvailableCoinsMulti);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r914966747",
      "id" : 914966747,
      "in_reply_to_id" : 888279929,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842iUjb",
      "original_commit_id" : "4029293e8c70c15eb7f64fe5a98e4d96e7de942a",
      "original_line" : 127,
      "original_position" : 128,
      "original_start_line" : 118,
      "path" : "src/bench/wallet_available_coins.cpp",
      "position" : null,
      "pull_request_review_id" : 1030281113,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914966747/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-06T15:16:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914966747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-12T13:15:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1181747756",
      "id" : 1181747756,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585GcAos",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1181747756/reactions"
      },
      "updated_at" : "2022-07-12T13:15:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1181747756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Note: haven't updated this PR because a similar benchmark is introduced in #25685.\r\n\r\nSo, once/if that one gets merged, will rebase this work on top. The amount of changes here will be pretty small.",
      "created_at" : "2022-08-31T14:01:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1232979854",
      "id" : 1232979854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585JfceO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232979854/reactions"
      },
      "updated_at" : "2022-08-31T14:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232979854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Aside from that, I think that a good future question to ask ourselves would be whether we want to always run all the benchmarks all the time or not. Because, sooner or later, as the project isn't going to stop growing, we could end up sacrificing accuracy, implementing not entirely real scenarios...\r\n\r\nI can see you also introduced that idea and the improvement is already merged and available; [good stuff](https://github.com/bitcoin/bitcoin/pull/26158)!",
      "created_at" : "2022-11-08T14:53:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1307343422",
      "id" : 1307343422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585N7Ho-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307343422/reactions"
      },
      "updated_at" : "2022-11-08T14:53:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307343422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/110166421?v=4",
         "events_url" : "https://api.github.com/users/pablomartin4btc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pablomartin4btc/followers",
         "following_url" : "https://api.github.com/users/pablomartin4btc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pablomartin4btc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pablomartin4btc",
         "id" : 110166421,
         "login" : "pablomartin4btc",
         "node_id" : "U_kgDOBpEBlQ",
         "organizations_url" : "https://api.github.com/users/pablomartin4btc/orgs",
         "received_events_url" : "https://api.github.com/users/pablomartin4btc/received_events",
         "repos_url" : "https://api.github.com/users/pablomartin4btc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pablomartin4btc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pablomartin4btc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pablomartin4btc"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "yeah, will rebase + rearrange it in the coming days. Thanks for the ping  .",
      "created_at" : "2022-11-08T21:50:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#issuecomment-1307873880",
      "id" : 1307873880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25234",
      "node_id" : "IC_kwDOABII585N9JJY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307873880/reactions"
      },
      "updated_at" : "2022-11-08T21:50:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307873880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r1049888759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1049888759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is a debugging leftover?",
      "commit_id" : "b2ec705072d85ce73c9aef1110a9afb78c5362cb",
      "created_at" : "2022-12-15T16:43:12Z",
      "diff_hunk" : "@@ -132,11 +132,52 @@ static void WalletCreateTx(benchmark::Bench& bench, const OutputType output_type\n     });\n }\n \n+static void AvailableCoins(benchmark::Bench& bench, const std::vector<OutputType>& output_type)\n+{\n+    const auto test_setup = MakeNoLogFileContext<const TestingSetup>();\n+    CWallet wallet{test_setup->m_node.chain.get(), \"\", gArgs, CreateMockWalletDatabase()};\n+    {\n+        LOCK(wallet.cs_wallet);\n+        wallet.SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+        wallet.SetupDescriptorScriptPubKeyMans();\n+        if (wallet.LoadWallet() != DBErrors::LOAD_OK) assert(false);\n+    }\n+\n+    // Generate destinations\n+    std::vector<CScript> dest_wallet;\n+    for (auto type : output_type) {\n+        dest_wallet.emplace_back(GetScriptForDestination(getNewDestination(wallet, type)));\n+    }\n+\n+    // Generate chain; each coinbase will have two outputs to fill-up the wallet\n+    const auto& params = Params();\n+    unsigned int chain_size = 1000;\n+    for (unsigned int i = 0; i < chain_size / dest_wallet.size(); ++i) {\n+        for (const auto& dest : dest_wallet) {\n+            generateFakeBlock(params, test_setup->m_node, wallet, dest);\n+        }\n+    }\n+\n+    // Check available balance\n+    auto bal = wallet::GetAvailableBalance(wallet); // Cache\n+    assert(bal == 50 * COIN * (chain_size - COINBASE_MATURITY));\n+\n+    bench.epochIterations(2).run([&] {\n+        LOCK(wallet.cs_wallet);\n+        const auto& res = wallet::AvailableCoins(wallet);\n+        std::cout << res.All().size() << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25234#discussion_r1049888759",
      "id" : 1049888759,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII584-lAf3",
      "original_commit_id" : "b2ec705072d85ce73c9aef1110a9afb78c5362cb",
      "original_line" : 168,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/bench/wallet_create_tx.cpp",
      "position" : 37,
      "pull_request_review_id" : 1219599081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25234",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1049888759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-15T16:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1049888759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
