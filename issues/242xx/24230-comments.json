[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-01T17:54:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027125114",
      "id" : 1027125114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849OK96",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027125114/reactions"
      },
      "updated_at" : "2022-02-01T17:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027125114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 8d8cdcb37005030f646ba3c45f7f54f556efb8bf -> 1fcfc73ba4e8180a8667868529774ab7b302ab5d ([`pr/indexy.1`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.1) -> [`pr/indexy.2`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.1-rebase..pr/indexy.2)) due to conflict with #22932. Also fixed some bugs in the last commit ð\r\n",
      "created_at" : "2022-02-01T21:47:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027319018",
      "id" : 1027319018,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849O6Tq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027319018/reactions"
      },
      "updated_at" : "2022-02-01T21:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027319018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/24230).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1038093095), [mzumsande](https://github.com/bitcoin/bitcoin/pull/24230#pullrequestreview-1014141911), [jamesob](https://github.com/bitcoin/bitcoin/pull/24230#pullrequestreview-1196377214), [aureleoules](https://github.com/bitcoin/bitcoin/pull/24230#pullrequestreview-1252096494), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1868061457) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28516](https://github.com/bitcoin/bitcoin/pull/28516) (validation: assumeutxo params for testnet and signet by Sjors)\n* [#28483](https://github.com/bitcoin/bitcoin/pull/28483) (refactor: Return CAutoFile from BlockManager::Open*File() by MarcoFalke)\n* [#28052](https://github.com/bitcoin/bitcoin/pull/28052) (blockstorage: XOR blocksdir *.dat files by MarcoFalke)\n* [#28051](https://github.com/bitcoin/bitcoin/pull/28051) (Get rid of shutdown.cpp/shutdown.h, use SignalInterrupt directly by ryanofsky)\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#26903](https://github.com/bitcoin/bitcoin/pull/26903) (Fix BaseIndex::Commit false error by pstratem)\n* [#26426](https://github.com/bitcoin/bitcoin/pull/26426) (WIP: Fix coinstatsindex overflow issue by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-02-02T04:02:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027553252",
      "id" : 1027553252,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849Pzfk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027553252/reactions"
      },
      "updated_at" : "2023-12-22T20:51:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027553252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 1fcfc73ba4e8180a8667868529774ab7b302ab5d -> c5be433bf3f1a2b5b96cbe00608eff24136e6f51 ([`pr/indexy.2`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.2) -> [`pr/indexy.3`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.3), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.2..pr/indexy.3)) fixing asan error https://cirrus-ci.com/task/5137882733084672 and lint error https://cirrus-ci.com/task/5208251477262336. Did not look into tsan failure https://cirrus-ci.com/task/4574932779663360 and multiprocess blockfilter_index_tests segfault https://cirrus-ci.com/task/4856407756374016, but I think they may be addressed by the asan fix",
      "created_at" : "2022-02-02T20:55:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1028349864",
      "id" : 1028349864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849S1-o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028349864/reactions"
      },
      "updated_at" : "2022-02-02T20:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028349864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated c5be433bf3f1a2b5b96cbe00608eff24136e6f51 -> 3ab1ebeff4328dc1a456a3323d8a41f0200d7be2 ([`pr/indexy.3`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.3) -> [`pr/indexy.4`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.4), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.3..pr/indexy.4)) fixing `blockfilter_index_initial_sync` crash that I could not produce locally but I believe was causing CI failures https://cirrus-ci.com/task/6670649857933312, https://cirrus-ci.com/task/5755856183623680, and https://cirrus-ci.com/task/4981799997669376",
      "created_at" : "2022-02-03T22:39:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1029467943",
      "id" : 1029467943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849XG8n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029467943/reactions"
      },
      "updated_at" : "2022-02-03T22:39:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029467943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743"
         }
      },
      "author_association" : "MEMBER",
      "body" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c : why bother with a pointer here? To make it consistent with `phashBlock` in `CBlockIndex`? I assume it's not just to shave 31 bytes of the `BlockInfo` size?",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T13:26:37Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743",
      "id" : 801627743,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII584vx95f",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 83,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 43,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338: you're using `context()` here, but `src/interfaces/chain.h` suggests that should only be done in a test. Does this need a TODO? Is this resolved in one of the followup PRs?",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T13:52:54Z",
      "diff_hunk" : "@@ -345,9 +350,9 @@ void BaseIndex::Interrupt()\n     m_interrupt();\n }\n \n-bool BaseIndex::Start(CChainState& active_chainstate)\n+bool BaseIndex::Start()\n {\n-    m_chainstate = &active_chainstate;\n+    m_chainstate = &m_chain->context()->chainman->ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113",
      "id" : 801653113,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vyEF5",
      "original_commit_id" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338",
      "original_line" : 355,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "515a1dbce29078a1e90dc3f97bf25b309face9bb: this might warrant a TODO (or note in the commit message) that this `CBlockIndex` is going away in a later commit.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:14:33Z",
      "diff_hunk" : "@@ -209,22 +210,23 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n     return data_size;\n }\n \n-bool BlockFilterIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+bool BlockFilterIndex::CustomAppend(const interfaces::BlockInfo& block)\n {\n     CBlockUndo block_undo;\n     uint256 prev_header;\n \n-    if (pindex->nHeight > 0) {\n+    if (block.height > 0) {\n+        const CBlockIndex* pindex = WITH_LOCK(cs_main, return m_chainstate->m_blockman.LookupBlockIndex(block.hash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097",
      "id" : 801675097,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vyJdZ",
      "original_commit_id" : "515a1dbce29078a1e90dc3f97bf25b309face9bb",
      "original_line" : 219,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15398b1677362f4d98ffc786f1ae9976ad595ea8: comment above needs update",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:29:51Z",
      "diff_hunk" : "@@ -28,7 +30,7 @@ struct IndexSummary {\n  * CValidationInterface and ensures blocks are indexed sequentially according\n  * to their position in the active chain.\n  */\n-class BaseIndex : public CValidationInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396",
      "id" : 801691396,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584vyNcE",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 27,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 30,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15398b1677362f4d98ffc786f1ae9976ad595ea8 nit: \"and reindex\" (I haven't checked if re-index nukes all the indexes, or if it leaves them alone until the previous best block is reached again)",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:46:41Z",
      "diff_hunk" : "@@ -81,6 +81,8 @@ struct BlockInfo {\n     unsigned undo_pos = 0;\n     const CBlock* data = nullptr;\n     const CBlockUndo* undo_data = nullptr;\n+    //! Block is from the tip of the chain (always true except during initial sync)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644",
      "id" : 801711644,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vySYc",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801842132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743\r\n\r\n> [dc4675d](https://github.com/bitcoin/bitcoin/commit/dc4675ddaca8d0d1d40847191cb21ccd116a6a3c) : why bother with a pointer here? To make it consistent with `phashBlock` in `CBlockIndex`? I assume it's not just to shave 31 bytes of the `BlockInfo` size?\r\n\r\nYes, hash is a reference and prev_hash is a pointer to minimize copying and make the struct small. C++ doesn't provide named arguments, so I'm defining the struct as a substitute for named arguments, to make block connected and disconnected declarations more readable and the argument list easier to change in the future.\r\n\r\nThe field types are the same as the argument types that would be used otherwise. `const uint256& hash` could be replaced by `uint256 hash`, and  `const uint256* prev_hash` could be `std::optional<uint256>`, and `const CBlock*` could be `shared_ptr<CBlock>`, but the various block connected and disconnected method implementations don't benefit from getting copies instead of references, or optional instead of pointers, or smart pointers instead of plain pointers, so I'm opting for the cheapest and simplest passing style in each case.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T16:45:22Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801842132",
      "id" : 801842132,
      "in_reply_to_id" : 801627743,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII584vyyPU",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 83,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 43,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113\r\n\r\n> [ae26ae5](https://github.com/bitcoin/bitcoin/commit/ae26ae5d3a1d32ce212d66477b71a5ac03354338): you're using `context()` here, but `src/interfaces/chain.h` suggests that should only be done in a test. Does this need a TODO? Is this resolved in one of the followup PRs?\r\n\r\nGood catch. Now removed this in the last commit and added comment about it being temporary",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:56:52Z",
      "diff_hunk" : "@@ -345,9 +350,9 @@ void BaseIndex::Interrupt()\n     m_interrupt();\n }\n \n-bool BaseIndex::Start(CChainState& active_chainstate)\n+bool BaseIndex::Start()\n {\n-    m_chainstate = &active_chainstate;\n+    m_chainstate = &m_chain->context()->chainman->ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912127",
      "id" : 801912127,
      "in_reply_to_id" : 801653113,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDU_",
      "original_commit_id" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338",
      "original_line" : 355,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097\r\n\r\n> [515a1db](https://github.com/bitcoin/bitcoin/commit/515a1dbce29078a1e90dc3f97bf25b309face9bb): this might warrant a TODO (or note in the commit message) that this `CBlockIndex` is going away in a later commit.\r\n\r\nGood suggestion, added comments to clarify",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:57:40Z",
      "diff_hunk" : "@@ -209,22 +210,23 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n     return data_size;\n }\n \n-bool BlockFilterIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+bool BlockFilterIndex::CustomAppend(const interfaces::BlockInfo& block)\n {\n     CBlockUndo block_undo;\n     uint256 prev_header;\n \n-    if (pindex->nHeight > 0) {\n+    if (block.height > 0) {\n+        const CBlockIndex* pindex = WITH_LOCK(cs_main, return m_chainstate->m_blockman.LookupBlockIndex(block.hash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912871",
      "id" : 801912871,
      "in_reply_to_id" : 801675097,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDgn",
      "original_commit_id" : "515a1dbce29078a1e90dc3f97bf25b309face9bb",
      "original_line" : 219,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396\r\n\r\n> [15398b1](https://github.com/bitcoin/bitcoin/commit/15398b1677362f4d98ffc786f1ae9976ad595ea8): comment above needs update\r\n\r\nGood catch, updated",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:58:12Z",
      "diff_hunk" : "@@ -28,7 +30,7 @@ struct IndexSummary {\n  * CValidationInterface and ensures blocks are indexed sequentially according\n  * to their position in the active chain.\n  */\n-class BaseIndex : public CValidationInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913300",
      "id" : 801913300,
      "in_reply_to_id" : 801691396,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584vzDnU",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 27,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 30,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644\r\n\r\n> [15398b1](https://github.com/bitcoin/bitcoin/commit/15398b1677362f4d98ffc786f1ae9976ad595ea8) nit: \"and reindex\" (I haven't checked if re-index nukes all the indexes, or if it leaves them alone until the previous best block is reached again)\r\n\r\nRephrased the comment to avoid the word sync. This isn't referring to IBD or reindexing globally. It's just referring to notifications from the attachChain / ThreadSync code that runs when the index is loaded. For example if we added an RPC method to start and stop indexes. `chain_tip` would be false for the blocks read after the index was first started, until the sync thread caught up. This would be independent of whether node itself was syncing to the network.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:58:47Z",
      "diff_hunk" : "@@ -81,6 +81,8 @@ struct BlockInfo {\n     unsigned undo_pos = 0;\n     const CBlock* data = nullptr;\n     const CBlockUndo* undo_data = nullptr;\n+    //! Block is from the tip of the chain (always true except during initial sync)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913814",
      "id" : 801913814,
      "in_reply_to_id" : 801711644,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDvW",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review!",
      "created_at" : "2022-02-09T01:10:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1033225564",
      "id" : 1033225564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849lcVc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033225564/reactions"
      },
      "updated_at" : "2022-02-09T01:10:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033225564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated d27072d58207b2648d8f1bf273389aee86db3001 -> 2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5 ([`pr/indexy.5`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.5) -> [`pr/indexy.6`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.6), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.5..pr/indexy.6)) to fix ubsan error https://cirrus-ci.com/task/5606579763412992?logs=ci#L4848",
      "created_at" : "2022-02-09T03:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1033309727",
      "id" : 1033309727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849lw4f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033309727/reactions"
      },
      "updated_at" : "2022-02-09T03:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033309727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802668917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "11310351345e844ae22f9bc00bed00eff7197500 : this constraint of `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` makes sense in the context of indexes, because an index is updated after a block is connected, at which point it will always have undo data. But if we ever need it in other places, it seems a bit odd. Maybe add a comment? Alternatively maybe we should just add `nStatus` or bools for the individual flags we care about? ",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-09T13:37:52Z",
      "diff_hunk" : "@@ -0,0 +1,24 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};\n+    if (index) {\n+        info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n+        info.height = index->nHeight;\n+        LOCK(::cs_main);\n+        info.file_number = index->nStatus & (BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO) ? index->nFile : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802668917",
      "id" : 802668917,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII584v18F1",
      "original_commit_id" : "11310351345e844ae22f9bc00bed00eff7197500",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : 17,
      "pull_request_review_id" : 877470452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T14:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802678422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ade3f4306bba6e40197d645774097c78a5e0681a: this is a nice addition, e.g. `block->hash` is more readable than before when `block` would be a hash.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-09T13:48:02Z",
      "diff_hunk" : "@@ -38,6 +38,12 @@ namespace interfaces {\n class Handler;\n class Wallet;\n \n+//! Hash/height pair to help track and identify blocks.\n+struct BlockKey {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802678422",
      "id" : 802678422,
      "line" : 42,
      "node_id" : "PRRC_kwDOABII584v1-aW",
      "original_commit_id" : "ade3f4306bba6e40197d645774097c78a5e0681a",
      "original_line" : 42,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 5,
      "pull_request_review_id" : 877470452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T14:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803070756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> [1131035](https://github.com/bitcoin/bitcoin/commit/11310351345e844ae22f9bc00bed00eff7197500) : this constraint of `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` makes sense in the context of indexes, because an index is updated after a block is connected, at which point it will always have undo data. But if we ever need it in other places, it seems a bit odd. Maybe add a comment? Alternatively maybe we should just add `nStatus` or bools for the individual flags we care about?\r\n\r\nI guess I'll drop this. I assumed one wouldn't be present without the other, and was basing it on the thing [`CDiskBlockIndex` is doing](https://github.com/bitcoin/bitcoin/blob/5e8e0b3d7f6055e326bda61e60712b530e8920f0/src/chain.h#L392). Most intermediate code which uses this is deleted in the end anyway.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-09T20:41:57Z",
      "diff_hunk" : "@@ -0,0 +1,24 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};\n+    if (index) {\n+        info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n+        info.height = index->nHeight;\n+        LOCK(::cs_main);\n+        info.file_number = index->nStatus & (BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO) ? index->nFile : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803070756",
      "id" : 803070756,
      "in_reply_to_id" : 802668917,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v3eMk",
      "original_commit_id" : "11310351345e844ae22f9bc00bed00eff7197500",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 878029336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T21:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I did review with `--color-moved=dimmed_zebra`, though without `dimmed_zebra` it's slightly more clear and a bigger monitor helps too.\r\n\r\nIt helped to notice that `Init()` is only called from `Start()`. The first four lines that set `locator` are just moved.\r\n\r\nThe two lines after that, which obtain the lock and set `active_chain` are turned into a new function `checkBlocks()` which is called from another new function `attachChain()`.  The end of the original `Init()` function comes back in that the only way `attachChain` can return null is with a prune violation. The middle part is more complicated.\r\n\r\nOne job of `Init()` was to set `m_best_block_index` and `m_synced`. That task has been moved to `blockConnected()`, which is called once by `attachChain()`. That part is a bit hard to follow, though it does look right. Part of the problem is that you need to understand the original logic. \r\n\r\nOnce those two are set, it continue on to find a prune violation. That part is a clear move to `checkBlocks`.\r\n\r\nYou might be able to introduce `checkBlocks()` in a commit before this. If wouldn't make things simpler, but the diff would be more focussed on the boiler plate changes.\r\n\r\n> I wonder if there is something specific which is confusing about this commit, or if you just don't like the boilerplate it adds?\r\n\r\nI'm probably fine with the end result; we'll see when I get to later commits, but I'm not worried about that. It's indeed the change itself that's a bit confusing.\r\n\r\n2504811223597b211aa52b86a6386f4c02286d50: although I can follow along fine, it might make sense to split out the `IgnoreBlockConnected` and `IgnoreChainStateFlushed` helpers first (instead of \"framing\" it as a rename)",
      "created_at" : "2022-02-10T10:38:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1034759315",
      "id" : 1034759315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849rSyT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1034759315/reactions"
      },
      "updated_at" : "2022-02-10T12:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1034759315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2504811223597b211aa52b86a6386f4c02286d50 : IIUC this makes it so the `Handler` that's in `m_handler` (before its moved) is destroyed when this function is done. Why is it insufficient to just call `m_handler->disconnect()`  and have it be destroyed along with `BaseIndex`?\r\n\r\nI guess that's what \"because ... disconnect code may need to lock the mutex\" refers to, but it's not super clear to me why this is.\r\n\r\nRelated to the next d148f9e2abc05c83b60f1d92bcd7884174fa9ae3 where you assert that `m_handler` really needs to be gone by the time destructor on `BaseIndex` is called.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T12:36:29Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739",
      "id" : 803628739,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII584v5mbD",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 401,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 177,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac: I guess you can now defer this until after `commit()`?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T12:49:25Z",
      "diff_hunk" : "@@ -254,7 +254,7 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n     // throw and lead to a graceful shutdown\n     m_best_block_index = new_tip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220",
      "id" : 803639220,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5o-0",
      "original_commit_id" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac",
      "original_line" : 256,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 54,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5: this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:07:09Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628",
      "id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584v5s_M",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 280,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 39,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b : Why this extra condition?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:27:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787",
      "id" : 803672787,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5xLT",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 79,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 13,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b  This seems new...",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:31:03Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866",
      "id" : 803675866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5x7a",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 91,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 26,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b : this also seems new. Maybe belongs in the next commit?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:33:56Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322",
      "id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v5yhy",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 100,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 37,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e359c2666cfd205c2ea84c241bccf565670365c0: I'm a bit puzzled about what `chainStateFlushed` is for in the context of indexing. Right now it doesn't do much other than call `Commit()`. But we weren't calling it here before.\r\n\r\nThe commit title says \"... to chainStateFlushed\" but in reality that function is untouched and only `blockConnected` is changed.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:57:07Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112",
      "id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v532Q",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 24,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739\r\n\r\n> [2504811](https://github.com/bitcoin/bitcoin/commit/2504811223597b211aa52b86a6386f4c02286d50) : IIUC this makes it so the `Handler` that's in `m_handler` (before its moved) is destroyed when this function is done. Why is it insufficient to just call `m_handler->disconnect()` and have it be destroyed along with `BaseIndex`?\r\n> \r\n> I guess that's what \"because ... disconnect code may need to lock the mutex\" refers to, but it's not super clear to me why this is.\r\n\r\nThanks, wrote a more descriptive comment. The disconnect code waits for the last notification to be processed, so if the last notification need to lock m_mutex for any reason there would be a deadlock if this code wasn't releasing it.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:45:40Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815653",
      "id" : 803815653,
      "in_reply_to_id" : 803628739,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII584v6UDl",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 296,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 540,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220\r\n\r\n> [0cefaaa](https://github.com/bitcoin/bitcoin/commit/0cefaaab906e3de84a4e2c5a15e27e56255e17ac): I guess you can now defer this until after `commit()`?\r\n\r\nI guess you're suggesting this code could commit first and update `m_best_block_index` later. I think this may be true currently, but I don't think it's necessarily safe to assume that other indexing code (particularly in `CustomInit` methods) doesn't care about the `m_best_block_index` value or won't depend on it in the future.\r\n\r\nAnyway, the indexing commit code is pretty low quality--it's bad about creating multiple batches, and sharing state inappropriately, and not being atomic--but I'm changing it as little as possible because it's mostly orthogonal to this PR. I do think the PR should make it a little easier to improve committing in the future since at least now it's passing the locator explicitly and it changes the base Commit method to call the custom Commit method instead of the other way around, so the control flow is simpler.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:45:58Z",
      "diff_hunk" : "@@ -254,7 +254,7 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n     // throw and lead to a graceful shutdown\n     m_best_block_index = new_tip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815987",
      "id" : 803815987,
      "in_reply_to_id" : 803639220,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UIz",
      "original_commit_id" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac",
      "original_line" : 256,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112\r\n\r\n> [e359c26](https://github.com/bitcoin/bitcoin/commit/e359c2666cfd205c2ea84c241bccf565670365c0): I'm a bit puzzled about what `chainStateFlushed` is for in the context of indexing.\r\n\r\nIt just calls Commit() to update the best block locator on disk and flush whatever custom state the index may want to save in CustomCommit().\r\n\r\n> Right now it doesn't do much other than call `Commit()`. But we weren't calling it here before.\r\n\r\nIn commit e359c2666cfd205c2ea84c241bccf565670365c0, previous line 201 `Commit(...);` is changing to `notifications->chainStateFlushed(...);` so there should be preserving behavior\r\n\r\n> The commit title says \"... to chainStateFlushed\" but in reality that function is untouched and only `blockConnected` is changed.\r\n\r\nI'm happy to change commit subject and I made some tweaks, but it would help to have more specific suggestions to know what to change. The format of these commits subject lines generally is \"index: Remove [part of indexing code that doesn't belong in indexing]\" or \"index: Move [part of indexing code out of the code that will be moved to the node later]\", so if I rename this subject line I might need to rename the other \"index: Move\" subject lines too. \r\n\r\nIt is often hard to describe changes commits are making in just a few words. The subject lines here are trying to describe the *goal* of each commit, and the commit bodies are trying to itemize the actual changes. A lot of the changes in different commits are pretty similar to each other, so the subject lines are also trying focus on what makes  commits distinct from each other.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:08Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816180",
      "id" : 803816180,
      "in_reply_to_id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UL0",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : Why this extra condition?\r\n\r\nGood catch. This change makes more sense in the earlier commit adding this code, so I moved it. (It wasn't needed before this commit just because IgnoreBlockConnected was always returning true in this case before this commit.)",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:16Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816320",
      "id" : 803816320,
      "in_reply_to_id" : 803672787,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UOA",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 79,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) This seems new...\r\n\r\nThis is not actually new, it's moved from BlockFilterIndex::CustomAppend and CoinStatsIndex::CustomAppend below. The different UndoReadFromDisk calls are being consolidated here",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816498",
      "id" : 803816498,
      "in_reply_to_id" : 803675866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UQy",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 91,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628\r\n\r\n> [d6ebc94](https://github.com/bitcoin/bitcoin/commit/d6ebc941f641d68eabe4c3243eb6769dd2d13cf5): this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.\r\n\r\n~Good suggestion, split this commit~",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-10T15:46:38Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816718",
      "id" : 803816718,
      "in_reply_to_id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584v6UUO",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 271,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 140,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803837847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : this also seems new. Maybe belongs in the next commit?\r\n\r\nThis `if (m_synced)` condition just preserves existing behavior. Now that `ThreadSync` is calling `blockConnected`, `m_synced` is no longer always true at this point. For some reason I don't know (but don't want to change) `ThreadSync` code didn't previously update `m_best_block_index` while it was reading and connecting blocks, and I didn't want to change that. This behavior might have been intended for performance reasons, or error handling reasons, or maybe so RPC indexing status would only report best block of indexing data that had actually been flushed to disk. But in any case nothing should be changing here.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T16:06:11Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803837847",
      "id" : 803837847,
      "in_reply_to_id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v6ZeX",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 148,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 283,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r804287560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : this also seems new. Maybe belongs in the next commit?\r\n\r\nMaybe I should add a comment here like \"Don't update m_best_block_index between flushes if not synced. Unclear why best block is not updated in this case, but this has been longstanding behavior since syncing was introduced in #13033 so care should be taken if changing this.\"",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-11T01:27:43Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r804287560",
      "id" : 804287560,
      "in_reply_to_id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v8HRI",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 148,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 283,
      "pull_request_review_id" : 879698638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:27:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will start reviewing soon",
      "created_at" : "2022-02-13T12:53:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1038093095",
      "id" : 1038093095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII58494Asn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1038093095/reactions"
      },
      "updated_at" : "2022-02-13T12:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1038093095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805348610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739\r\n\r\n> Thanks, wrote a more descriptive comment.\r\n\r\nActually fixed now. I messed up the last push and did not include this change.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-13T15:10:58Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805348610",
      "id" : 805348610,
      "in_reply_to_id" : 803628739,
      "line" : 303,
      "node_id" : "PRRC_kwDOABII584wAKUC",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 303,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 547,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> Maybe I should add a comment\r\n\r\nAdded now\r\n\r\n",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-13T15:20:33Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847",
      "id" : 805349847,
      "in_reply_to_id" : 803678322,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584wAKnX",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 152,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 287,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806464030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: [#24230 (comment)](https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628)\r\n\r\n > [d6ebc94](https://github.com/bitcoin/bitcoin/commit/d6ebc941f641d68eabe4c3243eb6769dd2d13cf5): this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.\r\n\r\nI tried this but couldn't actually figure out how how to do it in a good way. I updated the commit description and I want the commit to reflect fact that block read and block undo read is moving from custom indexes up to the BaseIndex::Rewind. If I add the loop in base class without removing it from the custom indexes, it's less clear that code is just moving.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T05:46:12Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806464030",
      "id" : 806464030,
      "in_reply_to_id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584wEaoe",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 271,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 140,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit dc4675ddaca8d0d1d40847191cb21ccd116a6a3c:\r\nLooks like `undo_pos` is never being used.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T15:12:03Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;\n+    int height = -1;\n+    int file_number = -1;\n+    unsigned data_pos = 0;\n+    unsigned undo_pos = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378",
      "id" : 806939378,
      "line" : 87,
      "node_id" : "PRRC_kwDOABII584wGOry",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 19,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65: \r\nI think that this might be a slight change in behavior: If `m_best_block_index` is nullptr here (which is possible if we get an  interrupt early in init), this will segfault now. Though the old behavior (that a locator to the tip was returned) was not ideal either, see #24117. ",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T15:26:27Z",
      "diff_hunk" : "@@ -211,19 +220,16 @@ void BaseIndex::ThreadSync()\n bool BaseIndex::Commit()\n {\n     CDBBatch batch(GetDB());\n-    if (!CommitInternal(batch) || !GetDB().WriteBatch(batch)) {\n+    bool success = CustomCommit(batch);\n+    if (success) {\n+        GetDB().WriteBestBlock(batch, GetLocator(*m_chain, m_best_block_index.load()->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991",
      "id" : 806961991,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wGUNH",
      "original_commit_id" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65",
      "original_line" : 225,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 23,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-15T19:57:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1040731190",
      "id" : 1040731190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584-CEw2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040731190/reactions"
      },
      "updated_at" : "2022-02-15T19:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040731190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3450df4d01608bd29f443aab3df1eed45108b3b2: I think this incremental processing will mean that in case of a deeper reorg, intermediate blocks are processed twice in `CopyHeightIndexToHashIndex` now, as new_tip and current_tip. Also, there willl be some extra calls to `ReadBlockFromDisk` also for txindex now (which doesn't implement `CustomRemove` logic). But this seems fine to me.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:10:44Z",
      "diff_hunk" : "@@ -244,8 +245,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089",
      "id" : 807318089,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wHrJJ",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 252,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 18,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3450df4d01608bd29f443aab3df1eed45108b3b2: The comment above could be adjusted, CustomRemove now rewinds just one block.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:14:57Z",
      "diff_hunk" : "@@ -118,7 +118,7 @@ class BaseIndex\n \n     /// Rewind index to an earlier chain tip during a chain reorg. The tip must\n     /// be an ancestor of the current best block.\n-    [[nodiscard]] virtual bool CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip) { return true; }\n+    [[nodiscard]] virtual bool CustomRemove(const interfaces::BlockInfo& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009",
      "id" : 807321009,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII584wHr2x",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 121,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 14,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807331690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My impression is that in the old code, the ThreadSync the strategy was to update `m_best_block_index` exactly before calling `Commit()` (and using `pindex` instead of `m_best_block_index` for everything else). So updating it after each `WriteBlock` call was just unnecessary.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:30:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807331690",
      "id" : 807331690,
      "in_reply_to_id" : 803678322,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584wHudq",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 152,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 287,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "36a9a550debc7324954765e60aefc33ab1456e5c: This should probably be conditional on `!m_index.m_synced`, otherwise there would be additional log messages after the index is synced (after most new blocks, since `SYNC_LOG_INTERVAL=30s`).",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:36:06Z",
      "diff_hunk" : "@@ -92,6 +94,12 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = GetTime();\n+    if (m_last_log_time + SYNC_LOG_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711",
      "id" : 807335711,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584wHvcf",
      "original_commit_id" : "36a9a550debc7324954765e60aefc33ab1456e5c",
      "original_line" : 98,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 14,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f56a851e11321ede9c5bcb43cd067c17f9efab39: Adding the condition `if (m_synced)` seems unnecessary at this point, `IgnoreChainStateFlushed` returns right at the beginning if not synced.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T22:06:56Z",
      "diff_hunk" : "@@ -351,10 +360,12 @@ bool BaseIndex::IgnoreChainStateFlushed(const CBlockLocator& locator)\n     // event, log a warning and let the queue clear.\n     const CBlockIndex* best_block_index = m_best_block_index.load();\n     if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n-        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best \" /* Continued */\n-                  \"chain (tip=%s); not writing index locator\\n\",\n-                  __func__, locator_tip_hash.ToString(),\n-                  best_block_index->GetBlockHash().ToString());\n+        if (m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962",
      "id" : 807356962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wH0oi",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 363,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 170,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f56a851e11321ede9c5bcb43cd067c17f9efab39: why the additional `!block.chain_tip` condition? I'd assume if we happen to experience a reorg during initial sync and disconnect the tip, `block.chain_tip=true` and we don't return, but we wouldn't want to process this.\r\nPossibly related: If, at this commit, I am in the middle of syncing an index and at the same time call `invalidateblock` for the tip, my node coredumps with \"`leveldb/db/db_iter.cc:65: virtual leveldb::Slice leveldb::{anonymous}::DBIter::key() const: Assertion `valid_' failed.`\"",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T22:51:10Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378",
      "id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wH7U6",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 42,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807538892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378\r\n\r\n> commit [dc4675d](https://github.com/bitcoin/bitcoin/commit/dc4675ddaca8d0d1d40847191cb21ccd116a6a3c): Looks like `undo_pos` is never being used.\r\n\r\nGreat catch! Removed",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:55:41Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;\n+    int height = -1;\n+    int file_number = -1;\n+    unsigned data_pos = 0;\n+    unsigned undo_pos = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807538892",
      "id" : 807538892,
      "in_reply_to_id" : 806939378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhDM",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991\r\n\r\n> [f631a1b](https://github.com/bitcoin/bitcoin/commit/f631a1b16ac2f58f47942c7cf51fbe8445694f65): I think that this might be a slight change in behavior: If `m_best_block_index` is nullptr here (which is possible if we get an interrupt early in init), this will segfault now. Though the old behavior (that a locator to the tip was returned) was not ideal either, see #24117.\r\n\r\nAbsolutely. Rebasing on your fix from #24117, I believe this should be fixed here as well.\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:56:22Z",
      "diff_hunk" : "@@ -211,19 +220,16 @@ void BaseIndex::ThreadSync()\n bool BaseIndex::Commit()\n {\n     CDBBatch batch(GetDB());\n-    if (!CommitInternal(batch) || !GetDB().WriteBatch(batch)) {\n+    bool success = CustomCommit(batch);\n+    if (success) {\n+        GetDB().WriteBestBlock(batch, GetLocator(*m_chain, m_best_block_index.load()->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539156",
      "id" : 807539156,
      "in_reply_to_id" : 806961991,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhHU",
      "original_commit_id" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65",
      "original_line" : 225,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089\r\n\r\n> [3450df4](https://github.com/bitcoin/bitcoin/commit/3450df4d01608bd29f443aab3df1eed45108b3b2): I think this incremental processing will mean that in case of a deeper reorg, intermediate blocks are processed twice in `CopyHeightIndexToHashIndex` now, as new_tip and current_tip. \r\n\r\nYes, exactly. I fixed commit message to describe this instead of saying \"This commit does not change behavior in any way\"\r\n\r\n> Also, there willl be some extra calls to `ReadBlockFromDisk` also for txindex now (which doesn't implement `CustomRemove` logic). But this seems fine to me.\r\n\r\nOh, this part was not intentional. Changed to remove these block reads. They are wasteful for BlockFilterIndex as well as TxIndex",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:57:19Z",
      "diff_hunk" : "@@ -244,8 +245,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539516",
      "id" : 807539516,
      "in_reply_to_id" : 807318089,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhM8",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 252,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009\r\n\r\n\r\n> 3450df4d01608bd29f443aab3df1eed45108b3b2: The comment above could be adjusted, CustomRemove now rewinds just one block.\r\n\r\nThanks, now noted in comment\r\n\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:58:06Z",
      "diff_hunk" : "@@ -118,7 +118,7 @@ class BaseIndex\n \n     /// Rewind index to an earlier chain tip during a chain reorg. The tip must\n     /// be an ancestor of the current best block.\n-    [[nodiscard]] virtual bool CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip) { return true; }\n+    [[nodiscard]] virtual bool CustomRemove(const interfaces::BlockInfo& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539753",
      "id" : 807539753,
      "in_reply_to_id" : 807321009,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII584wIhQp",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 102,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 99,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847\r\n\r\n> My impression is that in the old code, the ThreadSync the strategy was to update `m_best_block_index` exactly before calling `Commit()` (and using `pindex` instead of `m_best_block_index` for everything else). So updating it after each `WriteBlock` call was just unnecessary.\r\n\r\nI don't think this implies it's unnecessary unless you are assuming `ChainStateFlushed` (which calls `Commit`) is always called immediately after `BlockConnected`, which I think may not always be the case (i.e. during IBD). I'd actually be more worried about removing the `m_best_block_index` assignment here than I would be about assigning it unconditionally. I'd be happy to review another PR which changes this (and happy to rebase this PR on top) but in general I would like to not change `m_best_block_index` semantics in this PR unless it really helps things and we can be very sure it's safe.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:59:29Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540234",
      "id" : 807540234,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wIhYK",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711\r\n\r\n> [36a9a55](https://github.com/bitcoin/bitcoin/commit/36a9a550debc7324954765e60aefc33ab1456e5c): This should probably be conditional on `!m_index.m_synced`, otherwise there would be additional log messages after the index is synced (after most new blocks, since `SYNC_LOG_INTERVAL=30s`).\r\n\r\nYes, good catch. Added this",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:00:42Z",
      "diff_hunk" : "@@ -92,6 +94,12 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = GetTime();\n+    if (m_last_log_time + SYNC_LOG_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540622",
      "id" : 807540622,
      "in_reply_to_id" : 807335711,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIheO",
      "original_commit_id" : "36a9a550debc7324954765e60aefc33ab1456e5c",
      "original_line" : 98,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378\r\n\r\n> [f56a851](https://github.com/bitcoin/bitcoin/commit/f56a851e11321ede9c5bcb43cd067c17f9efab39): why the additional `!block.chain_tip` condition? \r\n\r\nOh no. This is just a bug. It should say `if (!m_index.m_synced && block.chain_tip)`. During sync notifications can come from two different sources;\r\n\r\n1 - The sync thread (with chain_tip = false)\r\n2 - The validation interface (with chain_tip = true)\r\n\r\nWe just want to ignore sync notifications from the validation interface like the comment above says.\r\n\r\n> I'd assume if we happen to experience a reorg during initial sync and disconnect the tip, `block.chain_tip=true` and we don't return, but we wouldn't want to process this.\r\n\r\nMost of the time we won't want to process this but sometimes we might if the reorg happens right at the end of the sync. We just want to process this whenever being called from the sync thread, and not process it when not called from the sync thread during sync. After sync, we always want to process it.\r\n\r\n>  Possibly related: If, at this commit, I am in the middle of syncing an index and at the same time call `invalidateblock` for the tip, my node coredumps with \"`leveldb/db/db_iter.cc:65: virtual leveldb::Slice leveldb::{anonymous}::DBIter::key() const: Assertion `valid_' failed.`\"\r\n\r\nInteresting, it does sound related. I would be curious to know if is fixed now. And maybe I could make this into a test. I'm curious if you made changes to somehow pause the sync to emulate a reorg happening at the same time?",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:01:25Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540885",
      "id" : 807540885,
      "in_reply_to_id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhiV",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807541075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962\r\n\r\n> [f56a851](https://github.com/bitcoin/bitcoin/commit/f56a851e11321ede9c5bcb43cd067c17f9efab39): Adding the condition `if (m_synced)` seems unnecessary at this point, `IgnoreChainStateFlushed` returns right at the beginning if not synced.\r\n\r\nOh, this is actually correct, but the check above should have been removed. The syncing here get simpler after the \r\n\"Rewrite chain sync logic, remove racy init\" commit, but right now chainStateFlushed notification events from the validation interface (not the sync thread) can happen at random times while the sync thread is still syncing, so the check avoids printing in this case while still not committing anything.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:01:57Z",
      "diff_hunk" : "@@ -351,10 +360,12 @@ bool BaseIndex::IgnoreChainStateFlushed(const CBlockLocator& locator)\n     // event, log a warning and let the queue clear.\n     const CBlockIndex* best_block_index = m_best_block_index.load();\n     if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n-        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best \" /* Continued */\n-                  \"chain (tip=%s); not writing index locator\\n\",\n-                  __func__, locator_tip_hash.ToString(),\n-                  best_block_index->GetBlockHash().ToString());\n+        if (m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807541075",
      "id" : 807541075,
      "in_reply_to_id" : 807356962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhlT",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 363,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810294690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I meant \"updating it after each WriteBlock _in the ThreadSync phase_\" is unnecessary. During the Sync phase, validation callbacks are ignored, and ThreadSync does the work - considering that the ThreadSync code in master makes sure that `m_best_block_index` is updated right before each possible `Commit()` call, and never used otherwise (pindex is used for that), I think that an earlier update of `m_best_block_index` after the [`WriteBlock`](https://github.com/bitcoin/bitcoin/blob/5d254a234d8c1569b0161264cc6d5d8d0ce0d864/src/index/base.cpp#L187) call within `ThreadSync` is just not necessary.\r\nSo I was just trying to explain why the longstanding behavior in master makes sense to me. I'm not suggesting to change anything here.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T19:45:15Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810294690",
      "id" : 810294690,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wTB2i",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 887694486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T19:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810300757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Interesting, it does sound related. I would be curious to know if is fixed now. And maybe I could make this into a test. I'm curious if you made changes to somehow pause the sync to emulate a reorg happening at the same time?\r\n\r\nYes, I don't encounter this anymore now. What I did was manual testing on regtest (just adding a `std::this_thread::sleep_for` to `ThreadSync`, giving me the possibility to time my `invalidateblock`) - I don't know if it is possible to somehow make an automated test for this that is not racy.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T19:54:28Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810300757",
      "id" : 810300757,
      "in_reply_to_id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wTDVV",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 887702246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T19:54:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810328899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok. Current behavior in master (which should not be changed here) still does not make sense to me. I don't think it's wrong (though it could be wrong), I just mean it seems inconsistent and strange.\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T20:45:51Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810328899",
      "id" : 810328899,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wTKND",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 887742060,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T20:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578\r\nI think `getTip()` here and in `interfaces.cpp` could move to the next commit (\"Remove SyncWithValidationInterfaceQueue call\") where they are used.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-21T22:23:30Z",
      "diff_hunk" : "@@ -134,6 +134,9 @@ class Chain\n     //! pruned), and contains transactions.\n     virtual bool haveBlockOnDisk(int height) = 0;\n \n+    //! Get tip information.\n+    virtual bool getTip(const FoundBlock& block={}) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743",
      "id" : 811456743,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584wXdjn",
      "original_commit_id" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "original_line" : 138,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 5,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "cec20142450117a40e64a77b8447e0f6294ec9e9: remove \"A\"",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-03T22:28:32Z",
      "diff_hunk" : "@@ -226,17 +226,17 @@ void BaseIndex::ThreadSync()\n     }\n }\n \n-bool BaseIndex::Commit()\n+bool BaseIndex::Commit(const CBlockLocator& locator)\n {\n     // Don't commit anything if we haven't indexed any block yet\n-    // (this could happen if init is interrupted).\n-    if (m_best_block_index == nullptr) {\n+    // (this could happen if init is interrupted).A",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023",
      "id" : 819115023,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584w0rQP",
      "original_commit_id" : "cec20142450117a40e64a77b8447e0f6294ec9e9",
      "original_line" : 232,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 46,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c1bdcdf3388792b7c17e576170167f0be883fa4a: The commit message (\"Move Commit and...\") doesn't describe what's being done here, maybe something like \"Move CustomInit out of Start and error handling code out of ThreadSync to notification handlers\"?",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-05T19:22:41Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296",
      "id" : 820139296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584w4lUg",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 432,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 79,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c1bdcdf3388792b7c17e576170167f0be883fa4a: why both an assert and a conditional? Or did you mean `m_init_result.value()` in the second line? Maybe also consider being explicit (`has_value()`) for the `std::optional<bool>` in the assert to avoid confusion.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-05T19:40:29Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {\n-        return false;\n+        assert(m_notifications->m_init_result);\n+        if (!m_notifications->m_init_result) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011",
      "id" : 820141011,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584w4lvT",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 446,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 82,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-09T12:54:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1062892667",
      "id" : 1062892667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_WnR7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062892667/reactions"
      },
      "updated_at" : "2022-03-09T12:54:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062892667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This pull seems related to areas I've been looking at, will review.",
      "created_at" : "2022-03-09T14:04:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1062953979",
      "id" : 1062953979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_W2P7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062953979/reactions"
      },
      "updated_at" : "2022-03-09T14:04:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062953979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I did some light testing for the final version, and one thing I noticed that the Index Sync now seems to block everything else and makes it impossible to abort gracefully: The wallet is not loaded (so that RPC calls are disabled), and also interrupting bitcoind with SIGINT would not work for me any more.\r\n\r\n@mzumsande I've been trying to reproduce this by modifying the syncchain method, but as far as I can tell, interrupt logic seems to be working as expected. Can you provide more specific steps to reproduce this? It also would help to see log output particularly near \"thread exit\" and \"Shutdown: In progress...\" lines.  If you can get gdb `thread apply all bt` output after sending SIGINT, that would provide a good picture, too.\r\n",
      "created_at" : "2022-03-11T03:59:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1064748312",
      "id" : 1064748312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_dsUY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064748312/reactions"
      },
      "updated_at" : "2022-03-11T03:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064748312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743\r\n\r\n> [fb164ac](https://github.com/bitcoin/bitcoin/commit/fb164ac88e8e5f7b7bb448637a06da6ae299e578) I think `getTip()` here and in `interfaces.cpp` could move to the next commit\r\n\r\nGood catch. Moved this.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:14:56Z",
      "diff_hunk" : "@@ -134,6 +134,9 @@ class Chain\n     //! pruned), and contains transactions.\n     virtual bool haveBlockOnDisk(int height) = 0;\n \n+    //! Get tip information.\n+    virtual bool getTip(const FoundBlock& block={}) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373054",
      "id" : 824373054,
      "in_reply_to_id" : 811456743,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584xIu8-",
      "original_commit_id" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "original_line" : 138,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 64,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023\r\n\r\n> cec20142450117a40e64a77b8447e0f6294ec9e9: remove \"A\"\r\n\r\nThanks, fixed this.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:15:46Z",
      "diff_hunk" : "@@ -226,17 +226,17 @@ void BaseIndex::ThreadSync()\n     }\n }\n \n-bool BaseIndex::Commit()\n+bool BaseIndex::Commit(const CBlockLocator& locator)\n {\n     // Don't commit anything if we haven't indexed any block yet\n-    // (this could happen if init is interrupted).\n-    if (m_best_block_index == nullptr) {\n+    // (this could happen if init is interrupted).A",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373325",
      "id" : 824373325,
      "in_reply_to_id" : 819115023,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvBN",
      "original_commit_id" : "cec20142450117a40e64a77b8447e0f6294ec9e9",
      "original_line" : 232,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296\r\n\r\n> [c1bdcdf](https://github.com/bitcoin/bitcoin/commit/c1bdcdf3388792b7c17e576170167f0be883fa4a): The commit message (\"Move Commit and...\") doesn't describe what's being done here, maybe something like \"Move CustomInit out of Start and error handling code out of ThreadSync to notification handlers\"?\r\n\r\nThanks, fixed this now.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:17:20Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373760",
      "id" : 824373760,
      "in_reply_to_id" : 820139296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvIA",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 432,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011\r\n\r\n> c1bdcdf3388792b7c17e576170167f0be883fa4a: why both an assert and a conditional? Or did you mean `m_init_result.value()` in the second line? Maybe also consider being explicit (`has_value()`) for the `std::optional<bool>` in the assert to avoid confusion.\r\n\r\nGood catch. I was intending to use * operator, but I followed your suggestion instead since that seems more readable.\r\n\r\nNote: bug here was wasn't actually present in the full PR. Bug was temporarily introduced here in commit c1bdcdf3388792b7c17e576170167f0be883fa4a, but fixed by later commit fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:17:45Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {\n-        return false;\n+        assert(m_notifications->m_init_result);\n+        if (!m_notifications->m_init_result) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373902",
      "id" : 824373902,
      "in_reply_to_id" : 820141011,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvKO",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 446,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 4d387545bcc9ea7c158fd6278154c200c2cbec13 -> 016304173ef6864e3c2f1104bd5ffe7595721ca6 ([`pr/indexy.11`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.11) -> [`pr/indexy.12`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.12), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.11..pr/indexy.12)) with lock fix for tsan error https://cirrus-ci.com/task/6456107408293888, and link fix for bitcoin-chainstate error https://cirrus-ci.com/task/4538559129452544\r\n",
      "created_at" : "2022-03-11T07:00:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1064830434",
      "id" : 1064830434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_eAXi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064830434/reactions"
      },
      "updated_at" : "2022-03-11T07:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064830434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @mzumsande I've been trying to reproduce this by modifying the syncchain method, but as far as I can tell, interrupt logic seems to be working as expected. Can you provide more specific steps to reproduce this? It also would help to see log output particularly near \"thread exit\" and \"Shutdown: In progress...\" lines. If you can get gdb `thread apply all bt` output after sending SIGINT, that would provide a good picture, too.\r\n\r\nI tried to reproduce this again, but couldn't anymore. I must have made some error during my tests the last time.\r\nI again tried to interrupt the index sync with SIGINT, SIGKILL and invalidateblock during sync, and everything worked fine. Sorry for the noise.",
      "created_at" : "2022-03-11T17:04:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1065308102",
      "id" : 1065308102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_f0_G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065308102/reactions"
      },
      "updated_at" : "2022-03-11T17:04:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065308102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Sorry for the noise.\r\n\r\nNo, thank you for testing! This was a good exercise for me to try to reproduce. I could see there is a real underlying issue because index sync threads can be greedy in their use of cs_main, and because index sync threads start before wallets are loaded, and wallet loading does not seem to be interruptible, Ctrl-C could become less usable if wallets take longer to load.\r\n\r\nThis PR should be improving the issue, not making it worse, because it is locking cs_main strictly less than previously during index sync. But thread scheduling is not always straightforward, and it's possible even releasing a lock could lead to worse latency, so this is something good to look out for and test.",
      "created_at" : "2022-03-11T17:31:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1065330061",
      "id" : 1065330061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_f6WN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065330061/reactions"
      },
      "updated_at" : "2022-03-11T17:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065330061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Aa^",
      "created_at" : "2022-03-13T23:28:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1066206744",
      "id" : 1066206744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_jQYY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1066206744/reactions"
      },
      "updated_at" : "2022-03-13T23:28:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1066206744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/99647687?v=4",
         "events_url" : "https://api.github.com/users/maxim85200/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maxim85200/followers",
         "following_url" : "https://api.github.com/users/maxim85200/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maxim85200/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maxim85200",
         "id" : 99647687,
         "login" : "maxim85200",
         "node_id" : "U_kgDOBfCAxw",
         "organizations_url" : "https://api.github.com/users/maxim85200/orgs",
         "received_events_url" : "https://api.github.com/users/maxim85200/received_events",
         "repos_url" : "https://api.github.com/users/maxim85200/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maxim85200/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maxim85200/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maxim85200"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-17T07:37:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1070452186",
      "id" : 1070452186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_zc3a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1070452186/reactions"
      },
      "updated_at" : "2022-03-17T07:37:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1070452186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 016304173ef6864e3c2f1104bd5ffe7595721ca6 -> 23d07effca30157779d7d9d324f1ee1a41324e07 ([`pr/indexy.12`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.12) -> [`pr/indexy.13`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.13), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.12-rebase..pr/indexy.13)) due to conflict with #24515",
      "created_at" : "2022-03-18T13:08:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1072393295",
      "id" : 1072393295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_62xP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072393295/reactions"
      },
      "updated_at" : "2022-03-18T13:08:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072393295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 23d07effca30157779d7d9d324f1ee1a41324e07 -> d14e89f701b224977bef3ccde233d86271f7ed9b ([`pr/indexy.13`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.13) -> [`pr\r\n/indexy.14`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.14), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.13..pr/indexy.14)) to fix tsan race in coinstatsindex_unclean_shutdown test https://cirrus-ci.com/task/5516517512052736?logs=ci#L4877, and probably (couldn't reproduce these) fix msan and centos segfaults in the same test https://cirrus-ci.com/task/6642417418895360?logs=ci and https://cirrus-ci.com/task/4953567558631424?logs=ci\r\n",
      "created_at" : "2022-03-18T19:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1072729670",
      "id" : 1072729670,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_8I5G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072729670/reactions"
      },
      "updated_at" : "2022-03-18T19:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072729670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r830350296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830350296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cf5d3404484b08939992566cca0f1151d050a921\r\n\r\nDo we ever expect that `index` will be null? Based on the calls to `MakeBlockInfo`, it doesn't look like it. Make sense to just accept a reference here?\r\n\r\nEdit: okay, I see - in a later commit (when we add `attachChain`), this may be passed a nullptr if we're initializing the handler with an empty datadir.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-18T21:05:03Z",
      "diff_hunk" : "@@ -0,0 +1,23 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r830350296",
      "id" : 830350296,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII584xfiPY",
      "original_commit_id" : "cf5d3404484b08939992566cca0f1151d050a921",
      "original_line" : 17,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : 17,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830350296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830350296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r831443151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831443151"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15daa47ee06b9f334dd2862856f41a2ad4b34a3d\r\n\r\nSad to see a Russ PR that's introducing a new method with PascalCase, but I guess we're matching existing style... :stuck_out_tongue: ",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-21T18:55:03Z",
      "diff_hunk" : "@@ -87,10 +90,8 @@ class BaseIndex : public CValidationInterface\n \n     void ChainStateFlushed(const CBlockLocator& locator) override;\n \n-    const CBlockIndex* CurrentIndex() { return m_best_block_index.load(); };\n-\n     /// Initialize internal state from the database and block index.\n-    [[nodiscard]] virtual bool Init();\n+    [[nodiscard]] virtual bool CustomInit(const std::optional<interfaces::BlockKey>& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r831443151",
      "id" : 831443151,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII584xjtDP",
      "original_commit_id" : "15daa47ee06b9f334dd2862856f41a2ad4b34a3d",
      "original_line" : 92,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 84,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831443151/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831443151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832336236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832336236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0e80167cc848364a456bbfd4cba12891a5f06b35\r\n\r\nMaybe worth doing `Assert(block.data)->vtx.size()` here? Possibly also with `.undo_data` below.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-22T15:29:38Z",
      "diff_hunk" : "@@ -425,13 +410,13 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     }\n \n     // Remove the new UTXOs that were created from the block\n-    for (size_t i = 0; i < block.vtx.size(); ++i) {\n-        const auto& tx{block.vtx.at(i)};\n+    for (size_t i = 0; i < block.data->vtx.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832336236",
      "id" : 832336236,
      "line" : 409,
      "node_id" : "PRRC_kwDOABII584xnHFs",
      "original_commit_id" : "0e80167cc848364a456bbfd4cba12891a5f06b35",
      "original_line" : 409,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 264,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832336236/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832336236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832554320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832554320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "afce60462f6d4ebc7b470ac2860c5d905e406ec7\r\n\r\nMight consider `Assert(...)` here.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-22T19:34:10Z",
      "diff_hunk" : "@@ -182,7 +173,7 @@ bool CoinStatsIndex::CustomAppend(const interfaces::BlockInfo& block)\n \n             // The coinbase tx has no undo data since no former output is spent\n             if (!tx->IsCoinBase()) {\n-                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+                const auto& tx_undo{block.undo_data->vtxundo.at(i - 1)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832554320",
      "id" : 832554320,
      "line" : 178,
      "node_id" : "PRRC_kwDOABII584xn8VQ",
      "original_commit_id" : "afce60462f6d4ebc7b470ac2860c5d905e406ec7",
      "original_line" : 178,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 80,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832554320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832554320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832560945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832560945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf6a0f8ae87a3ea4aec2c5a080f86fc44e0bd19e\r\n\r\nHmm... note to other reviewers, I guess: it wasn't obvious to me that this is equivalent to the original code because it seems like if `m_synced` is somehow set between the conditional below and the next usage of `current_time` (line 117 at time of writing), then this code will behave differently than the original code (i.e. `current_time == 0` but is used in the second conditional). But I read through and verified that an `m_synced` set doesn't happen in between.\r\n\r\nWould be nice to be able to verify that `current_time != 0` in the second usage (line 117), but not mandatory IMO.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-22T19:42:51Z",
      "diff_hunk" : "@@ -92,6 +94,15 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832560945",
      "id" : 832560945,
      "line" : 137,
      "node_id" : "PRRC_kwDOABII584xn98x",
      "original_commit_id" : "bf6a0f8ae87a3ea4aec2c5a080f86fc44e0bd19e",
      "original_line" : 137,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 266,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832560945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832560945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832576147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832576147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess this line could technically result in a double `Commit()` call at some point (based on `blockConnected` -> `m_last_locator_write_time` conditional), but even if that's true it would only happen once per locator-sync-interval AFAICT. So not a big deal.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-22T20:02:18Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832576147",
      "id" : 832576147,
      "in_reply_to_id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xoBqT",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832576147/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832576147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833397453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833397453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c4e0a9dd457018d78dc6be29251aec9d649af56c\r\n\r\nEdit: this criticism is invalidated by later commit 8c0c231840b6a88e470da69c6885e6b6dd088df5\r\n\r\nNow that we've removed the doc here, it'd be nice to have some kind of indication in the `attachChain()` doc (or even inline in the body of the function) that that function is now responsible for starting and setting `m_thread_sync`; as it stands in this commit there isn't any external indication of that.\r\n",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-23T15:22:20Z",
      "diff_hunk" : "@@ -62,19 +62,9 @@ class BaseIndex\n     /// The last block in the chain that the index is in sync with.\n     std::atomic<const CBlockIndex*> m_best_block_index{nullptr};\n \n-    std::thread m_thread_sync;\n-    CThreadInterrupt m_interrupt;\n-\n     /// Read best block locator and check that data needed to sync has not been pruned.\n     bool Init();\n \n-    /// Sync the index with the block index starting from the current best block.\n-    /// Intended to be run in its own thread, m_thread_sync, and can be\n-    /// interrupted with m_interrupt. Once the index gets in sync, the m_synced\n-    /// flag is set and the BlockConnected ValidationInterface callback takes\n-    /// over and the sync thread exits.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833397453",
      "id" : 833397453,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII584xrKLN",
      "original_commit_id" : "c4e0a9dd457018d78dc6be29251aec9d649af56c",
      "original_line" : 66,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 49,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833397453/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833397453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833400046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833400046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c4e0a9dd457018d78dc6be29251aec9d649af56c\r\n\r\n\"sync thread\" in the context of `Chain` is a little ambiguous IMO; maybe say \"index sync thread\"?",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-23T15:24:36Z",
      "diff_hunk" : "@@ -275,6 +275,8 @@ class Chain\n         bool disconnect_data = false;\n         //! Include undo data with block disconnected notifications.\n         bool disconnect_undo_data = false;\n+        //! Name to use for sync thread.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833400046",
      "id" : 833400046,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xrKzu",
      "original_commit_id" : "c4e0a9dd457018d78dc6be29251aec9d649af56c",
      "original_line" : 278,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833400046/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833400046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833430610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833430610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d39c6d00627ddf746e1c37a4d6e07f0a24586034\r\n\r\nThe naming here given the use is somewhat misleading to me; naively, one possible meaning of \"waitForNotifications\" is that we're just waiting for a single notification to come in. What this really does is wait for the validation interface queue to clear, i.e. for any pending indexation to complete. I think something like `waitForEmptyIndexQueue()` or similar might be less confusing.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-23T15:49:03Z",
      "diff_hunk" : "@@ -286,6 +289,9 @@ class Chain\n     //! Register handler for notifications.\n     virtual std::unique_ptr<Handler> handleNotifications(std::shared_ptr<Notifications> notifications) = 0;\n \n+    //! Wait for pending notifications.\n+    virtual void waitForNotifications() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833430610",
      "id" : 833430610,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xrSRS",
      "original_commit_id" : "d39c6d00627ddf746e1c37a4d6e07f0a24586034",
      "original_line" : 293,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833430610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833430610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833664122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833664122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8c0c231840b6a88e470da69c6885e6b6dd088df5\r\n\r\nI'm confused about what this is doing - why is `connect` true here but false in the call above?",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-23T19:47:52Z",
      "diff_hunk" : "@@ -729,68 +729,43 @@ class ChainImpl : public Chain\n     }\n     std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n     {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications being received, it is important\n+        // to connect the notifications proxy asynchronously inside the\n+        // validation queue, so older notifications in the queue are cleared\n+        // before the proxy becomes active.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n         LOCK(cs_main);\n         const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n         const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n         interfaces::BlockInfo block_info = node::MakeBlockInfo(locator_block);\n         block_info.chain_tip = locator_block == active.m_chain.Tip();\n-        // Need to register the ValidationInterface and call blockConnected\n-        // both while holding cs_main, so that callbacks are not missed if\n-        // blockConnected sets m_synced to true.\n         notifications->blockConnected(block_info);\n         if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n-        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications);\n-        if (!block_info.chain_tip) handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name, [&active, locator_block, notifications, handler = handler.get()] {\n-            SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n-            const CBlockIndex* pindex = locator_block;\n-            auto& consensus_params = Params().GetConsensus();\n-            while (!handler->m_interrupt) {\n-                {\n-                    LOCK(cs_main);\n-                    const CBlockIndex* pindex_next = NextSyncBlock(pindex, active.m_chain);\n-                    if (!pindex_next) {\n-                        assert(pindex);\n-                        notifications->blockConnected(node::MakeBlockInfo(pindex));\n-                        notifications->chainStateFlushed(active.m_chain.GetLocator(pindex));\n-                        break;\n-                    }\n-                    if (pindex_next->pprev != pindex) {\n-                        const CBlockIndex* current_tip = pindex;\n-                        const CBlockIndex* new_tip = pindex_next->pprev;\n-                        for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {\n-                            CBlock block;\n-                            interfaces::BlockInfo block_info = node::MakeBlockInfo(iter_tip);\n-                            block_info.chain_tip = false;\n-                            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                                block_info.error = strprintf(\"%s: Failed to read block %s from disk\",\n-                                        __func__, iter_tip->GetBlockHash().ToString());\n-                            } else {\n-                                block_info.data = &block;\n-                            }\n-                            notifications->blockDisconnected(block_info);\n-                            if (handler->m_interrupt) break;\n-                        }\n-                    }\n-                    pindex = pindex_next;\n-                }\n-\n-                CBlock block;\n-                interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex);\n-                block_info.chain_tip = false;\n-                if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n-                    block_info.error = strprintf(\"%s: Failed to read block %s from disk\",\n-                            __func__, pindex->GetBlockHash().ToString());\n-                } else {\n-                    block_info.data = &block;\n-                }\n-                notifications->blockConnected(block_info);\n-            }\n-        });\n+        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n+        if (block_info.chain_tip) {\n+            CallFunctionInValidationInterfaceQueue([proxy = handler->m_proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); });\n+        } else {\n+            handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n+                [&active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n+                SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n+                SyncChain(active.m_chain, locator_block, notifications, interrupt,\n+                          /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n+            });\n+        }\n         return handler;\n     }\n     std::unique_ptr<Handler> handleNotifications(std::shared_ptr<Notifications> notifications) override\n     {\n-        return std::make_unique<NotificationsHandlerImpl>(std::move(notifications));\n+        return std::make_unique<NotificationsHandlerImpl>(std::move(notifications), /*connect=*/true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833664122",
      "id" : 833664122,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xsLR6",
      "original_commit_id" : "8c0c231840b6a88e470da69c6885e6b6dd088df5",
      "original_line" : 768,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833664122/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833664122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833685301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833685301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c7729d1f0ccb17c39c42ee5c7881d469d150c101\r\n\r\nJust so I'm sure I understand, this has the effect of blocking the init thread until the first `blockConnected` call is completed?",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-23T20:16:47Z",
      "diff_hunk" : "@@ -746,21 +755,20 @@ class ChainImpl : public Chain\n         LOCK(cs_main);\n         const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n         const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n-        interfaces::BlockInfo block_info = node::MakeBlockInfo(locator_block);\n-        block_info.chain_tip = locator_block == active.m_chain.Tip();\n-        notifications->blockConnected(block_info);\n-        if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n-        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n-        if (block_info.chain_tip) {\n-            CallFunctionInValidationInterfaceQueue([proxy = handler->m_proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); });\n-        } else {\n-            handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n-                [&active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n-                SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n-                SyncChain(active.m_chain, locator_block, notifications, interrupt,\n-                          /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n-            });\n+        block_info.emplace(MakeBlockInfo(locator_block));\n+        block_info->chain_tip = locator_block == active.m_chain.Tip();\n+        if (!block_info->chain_tip && !checkBlocks(locator_block)) return nullptr;\n+        handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n+        handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n+            [&block_info, &promise, &active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n+            SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n+            notifications->blockConnected(*block_info);\n+            promise.set_value();\n+            SyncChain(active.m_chain, locator_block, notifications, interrupt,\n+                      /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n+        });\n         }\n+        promise.get_future().wait();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833685301",
      "id" : 833685301,
      "line" : 797,
      "node_id" : "PRRC_kwDOABII584xsQc1",
      "original_commit_id" : "c7729d1f0ccb17c39c42ee5c7881d469d150c101",
      "original_line" : 797,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 232,
      "pull_request_review_id" : 914866406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833685301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-24T13:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/833685301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835611937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835611937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833685301\r\n\r\n> [c7729d1](https://github.com/bitcoin/bitcoin/commit/c7729d1f0ccb17c39c42ee5c7881d469d150c101)\r\n> \r\n> Just so I'm sure I understand, this has the effect of blocking the init thread until the first `blockConnected` call is completed?\r\n\r\nYes, added comment. The wallet or index calling attachChain needs be able to find out the sync starting point or last block synced. An alternate approach would be for attachChain to return the starting block. This is approach I took earlier in #15719 https://github.com/bitcoin/bitcoin/blob/2b898a0456d742911c1f74229c9fc64a0012ca42/src/interfaces/chain.h#L260-L261, but it seems like would made things more complicated for callers by adding an output argument, and requiring the caller to update m_synced and m_best_block from multiple places instead of only inside blockConnected.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:10:24Z",
      "diff_hunk" : "@@ -746,21 +755,20 @@ class ChainImpl : public Chain\n         LOCK(cs_main);\n         const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n         const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n-        interfaces::BlockInfo block_info = node::MakeBlockInfo(locator_block);\n-        block_info.chain_tip = locator_block == active.m_chain.Tip();\n-        notifications->blockConnected(block_info);\n-        if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n-        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n-        if (block_info.chain_tip) {\n-            CallFunctionInValidationInterfaceQueue([proxy = handler->m_proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); });\n-        } else {\n-            handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n-                [&active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n-                SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n-                SyncChain(active.m_chain, locator_block, notifications, interrupt,\n-                          /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n-            });\n+        block_info.emplace(MakeBlockInfo(locator_block));\n+        block_info->chain_tip = locator_block == active.m_chain.Tip();\n+        if (!block_info->chain_tip && !checkBlocks(locator_block)) return nullptr;\n+        handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n+        handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n+            [&block_info, &promise, &active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n+            SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n+            notifications->blockConnected(*block_info);\n+            promise.set_value();\n+            SyncChain(active.m_chain, locator_block, notifications, interrupt,\n+                      /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n+        });\n         }\n+        promise.get_future().wait();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835611937",
      "id" : 835611937,
      "in_reply_to_id" : 833685301,
      "line" : 797,
      "node_id" : "PRRC_kwDOABII584xzm0h",
      "original_commit_id" : "c7729d1f0ccb17c39c42ee5c7881d469d150c101",
      "original_line" : 797,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 232,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835611937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835611937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612081"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833664122\r\n\r\n> [8c0c231](https://github.com/bitcoin/bitcoin/commit/8c0c231840b6a88e470da69c6885e6b6dd088df5)\r\n> \r\n> I'm confused about what this is doing - why is `connect` true here but false in the call above?\r\n\r\nSorry, this logic got messy because the notifications proxy now gets registered and unregistered from different threads, and could disconnected from the handler before the register call could happen, and I was trying to deal with cirrus TSAN errors. I rewrote it so it should understandable now.\r\n\r\nTo answer the question, connect was true for the older handleNotifications method because it doesn't care about stale notifications and just wants to connect right away, but false for attachChain because it delays registration to avoid sending stale notifications.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:10:41Z",
      "diff_hunk" : "@@ -729,68 +729,43 @@ class ChainImpl : public Chain\n     }\n     std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n     {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications being received, it is important\n+        // to connect the notifications proxy asynchronously inside the\n+        // validation queue, so older notifications in the queue are cleared\n+        // before the proxy becomes active.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n         LOCK(cs_main);\n         const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n         const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n         interfaces::BlockInfo block_info = node::MakeBlockInfo(locator_block);\n         block_info.chain_tip = locator_block == active.m_chain.Tip();\n-        // Need to register the ValidationInterface and call blockConnected\n-        // both while holding cs_main, so that callbacks are not missed if\n-        // blockConnected sets m_synced to true.\n         notifications->blockConnected(block_info);\n         if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n-        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications);\n-        if (!block_info.chain_tip) handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name, [&active, locator_block, notifications, handler = handler.get()] {\n-            SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n-            const CBlockIndex* pindex = locator_block;\n-            auto& consensus_params = Params().GetConsensus();\n-            while (!handler->m_interrupt) {\n-                {\n-                    LOCK(cs_main);\n-                    const CBlockIndex* pindex_next = NextSyncBlock(pindex, active.m_chain);\n-                    if (!pindex_next) {\n-                        assert(pindex);\n-                        notifications->blockConnected(node::MakeBlockInfo(pindex));\n-                        notifications->chainStateFlushed(active.m_chain.GetLocator(pindex));\n-                        break;\n-                    }\n-                    if (pindex_next->pprev != pindex) {\n-                        const CBlockIndex* current_tip = pindex;\n-                        const CBlockIndex* new_tip = pindex_next->pprev;\n-                        for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {\n-                            CBlock block;\n-                            interfaces::BlockInfo block_info = node::MakeBlockInfo(iter_tip);\n-                            block_info.chain_tip = false;\n-                            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                                block_info.error = strprintf(\"%s: Failed to read block %s from disk\",\n-                                        __func__, iter_tip->GetBlockHash().ToString());\n-                            } else {\n-                                block_info.data = &block;\n-                            }\n-                            notifications->blockDisconnected(block_info);\n-                            if (handler->m_interrupt) break;\n-                        }\n-                    }\n-                    pindex = pindex_next;\n-                }\n-\n-                CBlock block;\n-                interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex);\n-                block_info.chain_tip = false;\n-                if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n-                    block_info.error = strprintf(\"%s: Failed to read block %s from disk\",\n-                            __func__, pindex->GetBlockHash().ToString());\n-                } else {\n-                    block_info.data = &block;\n-                }\n-                notifications->blockConnected(block_info);\n-            }\n-        });\n+        auto handler = std::make_unique<NotificationsHandlerImpl>(notifications, /*connect=*/false);\n+        if (block_info.chain_tip) {\n+            CallFunctionInValidationInterfaceQueue([proxy = handler->m_proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); });\n+        } else {\n+            handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name,\n+                [&active, locator_block, notifications, &interrupt = handler->m_interrupt, proxy = handler->m_proxy] {\n+                SetSyscallSandboxPolicy(SyscallSandboxPolicy::TX_INDEX);\n+                SyncChain(active.m_chain, locator_block, notifications, interrupt,\n+                          /*on_sync=*/[proxy] { CallFunctionInValidationInterfaceQueue([proxy] { if (proxy->connect()) RegisterSharedValidationInterface(proxy); }); });\n+            });\n+        }\n         return handler;\n     }\n     std::unique_ptr<Handler> handleNotifications(std::shared_ptr<Notifications> notifications) override\n     {\n-        return std::make_unique<NotificationsHandlerImpl>(std::move(notifications));\n+        return std::make_unique<NotificationsHandlerImpl>(std::move(notifications), /*connect=*/true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612081",
      "id" : 835612081,
      "in_reply_to_id" : 833664122,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xzm2x",
      "original_commit_id" : "8c0c231840b6a88e470da69c6885e6b6dd088df5",
      "original_line" : 768,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612081/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612218"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833430610\r\n\r\n> [d39c6d0](https://github.com/bitcoin/bitcoin/commit/d39c6d00627ddf746e1c37a4d6e07f0a24586034)\r\n> \r\n> The naming here given the use is somewhat misleading to me; naively, one possible meaning of \"waitForNotifications\" is that we're just waiting for a single notification to come in. What this really does is wait for the validation interface queue to clear, i.e. for any pending indexation to complete. I think something like `waitForEmptyIndexQueue()` or similar might be less confusing.\r\n\r\nChanged from `waitForNotifications` to `waitForPendingNotifications` now. This new name is less consistent with the `waitForNotificationsIfTipChanged` method name immediately below, but it is less ambiguous.\r\n\r\nI think `waitForEmptyIndexQueue()` would be misleading because the queue doesn't need to be empty for this to return. It just waits for currently pending notifications to be processed, not new notifications. It just marks a point in the stream, so the queue may never need to be empty at any point.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:10:57Z",
      "diff_hunk" : "@@ -286,6 +289,9 @@ class Chain\n     //! Register handler for notifications.\n     virtual std::unique_ptr<Handler> handleNotifications(std::shared_ptr<Notifications> notifications) = 0;\n \n+    //! Wait for pending notifications.\n+    virtual void waitForNotifications() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612218",
      "id" : 835612218,
      "in_reply_to_id" : 833430610,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xzm46",
      "original_commit_id" : "d39c6d00627ddf746e1c37a4d6e07f0a24586034",
      "original_line" : 293,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612218/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833400046\r\n\r\n> [c4e0a9d](https://github.com/bitcoin/bitcoin/commit/c4e0a9dd457018d78dc6be29251aec9d649af56c)\r\n> \r\n> \"sync thread\" in the context of `Chain` is a little ambiguous IMO; maybe say \"index sync thread\"?\r\n\r\nChanged comment to \"Name to use for attachChain sync thread\". I would like to use the new attachChain method for wallets as well as indexes (#15719) so this is avoiding the word \"index\".",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:11:16Z",
      "diff_hunk" : "@@ -275,6 +275,8 @@ class Chain\n         bool disconnect_data = false;\n         //! Include undo data with block disconnected notifications.\n         bool disconnect_undo_data = false;\n+        //! Name to use for sync thread.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612361",
      "id" : 835612361,
      "in_reply_to_id" : 833400046,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xzm7J",
      "original_commit_id" : "c4e0a9dd457018d78dc6be29251aec9d649af56c",
      "original_line" : 278,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612361/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r833397453\r\n\r\n> [c4e0a9d](https://github.com/bitcoin/bitcoin/commit/c4e0a9dd457018d78dc6be29251aec9d649af56c)\r\n> \r\n> Edit: this criticism is invalidated by later commit [8c0c231](https://github.com/bitcoin/bitcoin/commit/8c0c231840b6a88e470da69c6885e6b6dd088df5)\r\n> \r\n> Now that we've removed the doc here, it'd be nice to have some kind of indication in the `attachChain()` doc (or even inline in the body of the function) that that function is now responsible for starting and setting `m_thread_sync`; as it stands in this commit there isn't any external indication of that.\r\n\r\nTo improve this, I added some comments and an assert to this commit.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:11:42Z",
      "diff_hunk" : "@@ -62,19 +62,9 @@ class BaseIndex\n     /// The last block in the chain that the index is in sync with.\n     std::atomic<const CBlockIndex*> m_best_block_index{nullptr};\n \n-    std::thread m_thread_sync;\n-    CThreadInterrupt m_interrupt;\n-\n     /// Read best block locator and check that data needed to sync has not been pruned.\n     bool Init();\n \n-    /// Sync the index with the block index starting from the current best block.\n-    /// Intended to be run in its own thread, m_thread_sync, and can be\n-    /// interrupted with m_interrupt. Once the index gets in sync, the m_synced\n-    /// flag is set and the BlockConnected ValidationInterface callback takes\n-    /// over and the sync thread exits.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612595",
      "id" : 835612595,
      "in_reply_to_id" : 833397453,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII584xzm-z",
      "original_commit_id" : "c4e0a9dd457018d78dc6be29251aec9d649af56c",
      "original_line" : 66,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 49,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612595/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612736"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832560945\r\n\r\n> Would be nice to be able to verify that `current_time != 0` in the second usage (line 117), but not mandatory IMO.\r\n\r\nThanks. I added a direct assert that m_synced value didn't change. This is an even stricter check, and ensures that the Commit() call still happens and doesn't get skipped.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:12:00Z",
      "diff_hunk" : "@@ -92,6 +94,15 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612736",
      "id" : 835612736,
      "in_reply_to_id" : 832560945,
      "line" : 137,
      "node_id" : "PRRC_kwDOABII584xznBA",
      "original_commit_id" : "bf6a0f8ae87a3ea4aec2c5a080f86fc44e0bd19e",
      "original_line" : 137,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 266,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612736/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612836"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832554320\r\n\r\n> [afce604](https://github.com/bitcoin/bitcoin/commit/afce60462f6d4ebc7b470ac2860c5d905e406ec7)\r\n> \r\n> Might consider `Assert(...)` here.\r\n\r\nAdded asserts above",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:12:13Z",
      "diff_hunk" : "@@ -182,7 +173,7 @@ bool CoinStatsIndex::CustomAppend(const interfaces::BlockInfo& block)\n \n             // The coinbase tx has no undo data since no former output is spent\n             if (!tx->IsCoinBase()) {\n-                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+                const auto& tx_undo{block.undo_data->vtxundo.at(i - 1)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612836",
      "id" : 835612836,
      "in_reply_to_id" : 832554320,
      "line" : 178,
      "node_id" : "PRRC_kwDOABII584xznCk",
      "original_commit_id" : "afce60462f6d4ebc7b470ac2860c5d905e406ec7",
      "original_line" : 178,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 80,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832336236\r\n\r\n> [0e80167](https://github.com/bitcoin/bitcoin/commit/0e80167cc848364a456bbfd4cba12891a5f06b35)\r\n> \r\n> Maybe worth doing `Assert(block.data)->vtx.size()` here? Possibly also with `.undo_data` below.\r\n\r\nMakes sense, added asserts",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:12:26Z",
      "diff_hunk" : "@@ -425,13 +410,13 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     }\n \n     // Remove the new UTXOs that were created from the block\n-    for (size_t i = 0; i < block.vtx.size(); ++i) {\n-        const auto& tx{block.vtx.at(i)};\n+    for (size_t i = 0; i < block.data->vtx.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835612911",
      "id" : 835612911,
      "in_reply_to_id" : 832336236,
      "line" : 409,
      "node_id" : "PRRC_kwDOABII584xznDv",
      "original_commit_id" : "0e80167cc848364a456bbfd4cba12891a5f06b35",
      "original_line" : 409,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 264,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835612911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835613042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835613042"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r831443151\r\n\r\n> [15daa47](https://github.com/bitcoin/bitcoin/commit/15daa47ee06b9f334dd2862856f41a2ad4b34a3d)\r\n> \r\n> Sad to see a Russ PR that's introducing a new method with PascalCase, but I guess we're matching existing style... stuck_out_tongue\r\n\r\nYeah I like it for new classes mostly. I'm happy you are using this convention in validation code since validation code has lots of standalone functions, and knowing whether you are calling method or a function can really tell you something. In index code there aren't too many standalone functions.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:12:41Z",
      "diff_hunk" : "@@ -87,10 +90,8 @@ class BaseIndex : public CValidationInterface\n \n     void ChainStateFlushed(const CBlockLocator& locator) override;\n \n-    const CBlockIndex* CurrentIndex() { return m_best_block_index.load(); };\n-\n     /// Initialize internal state from the database and block index.\n-    [[nodiscard]] virtual bool Init();\n+    [[nodiscard]] virtual bool CustomInit(const std::optional<interfaces::BlockKey>& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835613042",
      "id" : 835613042,
      "in_reply_to_id" : 831443151,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII584xznFy",
      "original_commit_id" : "15daa47ee06b9f334dd2862856f41a2ad4b34a3d",
      "original_line" : 92,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 84,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835613042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835613042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835614943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835614943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r830350296\r\n\r\n> Edit: okay, I see - in a later commit (when we add `attachChain`), this may be passed a nullptr if we're initializing the handler with an empty datadir.\r\n\r\nRight, in cases where CChain::Tip() is null this just returns a struct with all default values. Alternative would be to return `optional<BlockInfo>` and pass around `optional<BlockInfo>` variables more places. But this would force code to handle nullopt as a special case when in practice the struct values are ignored anyway and the defaults are fine. It's similar to using INT_MAX if you mean to represent infinity. It doesn't capture the meaning perfectly, but the semantics are close enough that it can make sense if it gets rid of special cases and makes code simpler.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:16:47Z",
      "diff_hunk" : "@@ -0,0 +1,23 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835614943",
      "id" : 835614943,
      "in_reply_to_id" : 830350296,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII584xznjf",
      "original_commit_id" : "cf5d3404484b08939992566cca0f1151d050a921",
      "original_line" : 17,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : 17,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835614943/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835614943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835616966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835616966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"indexes, refactor: Move Commit logic out of ThreadSync to notification handlers\" (7add4807d84e89daec20042559b076f9941b9c1a)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r832576147\r\n\r\n> I guess this line could technically result in a double `Commit()` call at some point (based on `blockConnected` -> `m_last_locator_write_time` conditional), but even if that's true it would only happen once per locator-sync-interval AFAICT. So not a big deal.\r\n\r\nThis shouldn't happen because the new `notifications->blockConnected` call is not passing any block data (`block.data == nullptr`, so the `blockConnected` implementation just updates `m_synced` and `m_best_block_index` and doesn't do anything else with the block).\r\n\r\nI added more documentation about different types of `blockConnected` calls in `interfaces/chain.h` but the idea is that a `blockConnected` call with `block.data != nullptr` provides information about a new block that is being connected and needs to be processed, and a call with `block.data == nullptr` just tells you the last block that was already connected, which is useful at the beginning or end of a sync.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-03-25T21:21:13Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r835616966",
      "id" : 835616966,
      "in_reply_to_id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xzoDG",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 922143453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835616966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-28T18:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835616966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-25T19:23:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1108950745",
      "id" : 1108950745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585CGT7Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1108950745/reactions"
      },
      "updated_at" : "2022-04-25T19:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1108950745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-26T20:49:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1110235374",
      "id" : 1110235374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585CLNju",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110235374/reactions"
      },
      "updated_at" : "2022-04-26T20:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110235374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r866785619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/866785619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit 1819bdb7cb0634dad2e07daccfe7e8a122a943d6:\r\nI think that this changed behavior slightly because it changes the order of indexing the block (`CustomAppend`) and periodically updating the index' best block (`Commit`)  - which is better because the indexed data on disk wouldn't be in an inconsistent state temporarily. I opened #25074 to fix this on master.",
      "commit_id" : "3b3f66ec486d6a77175d26e9edd324666e65855a",
      "created_at" : "2022-05-06T12:38:31Z",
      "diff_hunk" : "@@ -101,8 +113,16 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     // best block is not updated here before sync, but this has been\n     // longstanding behavior since syncing was introduced in #13033 so care\n     // should be taken if changing m_best_block_index semantics.\n-    if (m_index.m_synced) {\n+    assert(synced == m_index.m_synced);\n+    if (synced) {\n         m_index.m_best_block_index = pindex;\n+    } else if (m_last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time || m_index.m_interrupt) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r866785619",
      "id" : 866785619,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zqhlT",
      "original_commit_id" : "1819bdb7cb0634dad2e07daccfe7e8a122a943d6",
      "original_line" : 119,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 34,
      "pull_request_review_id" : 964591461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/866785619/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-06T12:38:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/866785619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#pullrequestreview-922143453   \r\n\r\n> > For easier reviewability it would be nice to absorb this into prior commits if possible; i.e. avoid introducing the `Ignore*` methods only to take them away in this commit. Creates a lot of churn to review. But would be curious to know if this is particularly difficult to do for some reason.\r\n> \r\n> This is a really interesting idea and I'm going to give it a try and see what it looks like.\r\n\r\nI've been working on this on and off for weeks and I think I hit a breaking point. My branch is at https://github.com/ryanofsky/bitcoin/commits/wcr-export.2 and the main commit is https://github.com/ryanofsky/bitcoin/commit/2da7ac7d159056f3563b0cb845a2a8e9d64c548d. I backported the synchronous attachChain implementation from a later commit to that earlier commit to avoid the need for the the IgnoreBlockConnected and IgnoreChainFlushed methods\r\n\r\nBut this wrecked absolute havoc on the PR. I got through maybe 60% of the rebase and have had to fix countless conflicts and test failures so far. Then I realized the approach is inherently more messy and complicated because instead of:\r\n\r\n1. Moving the sync thread from indexing code to node code\r\n2. Replacing the racy sync implementation with non-racy sync implementation\r\n\r\nit requires:\r\n\r\n1. Adding non-racy sync thread in the node running after the racy sync thread in the index\r\n2. Moving indexing functionality to racy sync thread to the non-racy sync thread\r\n3. Deleting the non-racy sync thread\r\n\r\nStep 2 seemed doable but was causing lots of bugs and headaches and was leading to bigger commits, making me prefer the original approach more.\r\n\r\nI think the original approach is better by comparison. Yes, there are a few lines in the IgnoreBlockConnected and IgnoreChainFlushed methods which have to be touched up even though they are deleted later. But I don't think there is a good way around this churn that doesn't require changing indexing code and changing the sync implementation in the same commit, when the original approach is able to do these things separately.",
      "created_at" : "2022-05-11T01:36:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1123085722",
      "id" : 1123085722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585C8O2a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1123085722/reactions"
      },
      "updated_at" : "2022-05-11T01:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1123085722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r869810783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869810783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r866785619\r\n\r\n> commit [1819bdb](https://github.com/bitcoin/bitcoin/commit/1819bdb7cb0634dad2e07daccfe7e8a122a943d6): I think that this changed behavior slightly because it changes the order of indexing the block (`CustomAppend`) \r\n\r\nThanks. Good catch and I reviewed your PR\r\n",
      "commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "created_at" : "2022-05-11T02:13:12Z",
      "diff_hunk" : "@@ -101,8 +113,16 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     // best block is not updated here before sync, but this has been\n     // longstanding behavior since syncing was introduced in #13033 so care\n     // should be taken if changing m_best_block_index semantics.\n-    if (m_index.m_synced) {\n+    assert(synced == m_index.m_synced);\n+    if (synced) {\n         m_index.m_best_block_index = pindex;\n+    } else if (m_last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time || m_index.m_interrupt) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r869810783",
      "id" : 869810783,
      "in_reply_to_id" : 866785619,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584z2EJf",
      "original_commit_id" : "1819bdb7cb0634dad2e07daccfe7e8a122a943d6",
      "original_line" : 119,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 968592395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869810783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-11T03:59:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869810783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-16T13:05:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1127648295",
      "id" : 1127648295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585DNown",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127648295/reactions"
      },
      "updated_at" : "2022-05-16T13:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127648295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874092009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874092009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "One general point (if it's too unrelated to this PR, we could also discuss it elsewhere):\r\n\r\nI think that the current way of initialising indexes by calling `FindForkInGlobalIndex()` for the saved locator and setting this as the best block is not compatible with indexes that have state beyond the best block, such as coinstatsindex:\r\nFor this index, we need to call `CustomRemove()` (or `Rewind` on master) to revert the actions of each block and adjust the muhash. This is not done during Init, so the coinstatsindex currently cannot deal with the situation where the saved best block of the index is not part of the best chain.\r\n\r\nOne solution for this would be not to call `FindForkInGlobalIndex` but instead read in the first block stored in the locator and then revert blocks step by step up to the fork point - this is necessary for coinstatsindex, but it adds the additional requirement that all blocks between the forkpoint and the saved block must be available, which is something that e.g. txindex doesn't really need.  \r\n\r\nI did a rough implementation for fixing the coinstatsindex init sequence in [this branch](https://github.com/mzumsande/bitcoin/tree/202205_index_init_rewind), which I think works but (at least on first glance) seems to be really incompatible with the approach here, so I wouldn't just PR it.\r\n\r\nWhat do you think about this problem?",
      "commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "created_at" : "2022-05-16T19:39:22Z",
      "diff_hunk" : "@@ -659,9 +717,96 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* locator_block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        const CChain& active_chain = Assert(m_node.chainman)->ActiveChain();\n+        bool prune_violation = false;\n+        if (!locator_block) {\n+            // make sure we have all block data back to the genesis\n+            prune_violation = m_node.chainman->m_blockman.GetFirstStoredBlock(*active_chain.Tip()) != active_chain.Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = locator_block;\n+            if (!active_chain.Contains(block_to_test)) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = active_chain.FindFork(block_to_test);\n+            }\n+            const CBlockIndex* block = active_chain.Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block && (block->nStatus & BLOCK_HAVE_DATA)) {\n+                if (block_to_test == block) {\n+                    prune_violation = false;\n+                    break;\n+                }\n+                // block->pprev must exist at this point, since block_to_test is part of the chain\n+                // and thus must be encountered when going backwards from the tip\n+                assert(block->pprev);\n+                block = block->pprev;\n+            }\n+        }\n+        return !prune_violation;\n+    }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n+    {\n+        std::unique_ptr<NotificationsHandlerImpl> handler;\n+        std::optional<interfaces::BlockInfo> block_info;\n+        // std::promise to wait for the first blockConnected notification, so\n+        // caller is notified about the starting block before this returns.\n+        // It might be good in the future to return without waiting for this,\n+        // and allow more initialization code to run in parallel.\n+        std::promise<void> promise;\n+        {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being received, it is important to not to register for\n+        // notifications immediately, but to delay registration with\n+        // CallFunctionInValidationInterfaceQueue, registering the notification\n+        // proxy inside the queue, so older notifications in the queue before it\n+        // get processed before the proxy is registered.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n+        LOCK(cs_main);\n+        const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n+        const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874092009",
      "id" : 874092009,
      "line" : 780,
      "node_id" : "PRRC_kwDOABII5840GZXp",
      "original_commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "original_line" : 780,
      "original_position" : 222,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 222,
      "pull_request_review_id" : 974477399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874092009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-16T19:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874092009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874121855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874121855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think that the current way of initialising indexes by calling FindForkInGlobalIndex() for the saved locator and setting this as the best block\r\n\r\nYou're right but this is easy to fix by just replacing `FindForkInGlobalIndex()` call with a `LookupBlockIndex` call. There should be no need to add additional remove/rewind calls, though. Existing code should be aware of forks and how to handle them.",
      "commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "created_at" : "2022-05-16T20:19:30Z",
      "diff_hunk" : "@@ -659,9 +717,96 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* locator_block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        const CChain& active_chain = Assert(m_node.chainman)->ActiveChain();\n+        bool prune_violation = false;\n+        if (!locator_block) {\n+            // make sure we have all block data back to the genesis\n+            prune_violation = m_node.chainman->m_blockman.GetFirstStoredBlock(*active_chain.Tip()) != active_chain.Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = locator_block;\n+            if (!active_chain.Contains(block_to_test)) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = active_chain.FindFork(block_to_test);\n+            }\n+            const CBlockIndex* block = active_chain.Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block && (block->nStatus & BLOCK_HAVE_DATA)) {\n+                if (block_to_test == block) {\n+                    prune_violation = false;\n+                    break;\n+                }\n+                // block->pprev must exist at this point, since block_to_test is part of the chain\n+                // and thus must be encountered when going backwards from the tip\n+                assert(block->pprev);\n+                block = block->pprev;\n+            }\n+        }\n+        return !prune_violation;\n+    }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n+    {\n+        std::unique_ptr<NotificationsHandlerImpl> handler;\n+        std::optional<interfaces::BlockInfo> block_info;\n+        // std::promise to wait for the first blockConnected notification, so\n+        // caller is notified about the starting block before this returns.\n+        // It might be good in the future to return without waiting for this,\n+        // and allow more initialization code to run in parallel.\n+        std::promise<void> promise;\n+        {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being received, it is important to not to register for\n+        // notifications immediately, but to delay registration with\n+        // CallFunctionInValidationInterfaceQueue, registering the notification\n+        // proxy inside the queue, so older notifications in the queue before it\n+        // get processed before the proxy is registered.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n+        LOCK(cs_main);\n+        const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n+        const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874121855",
      "id" : 874121855,
      "in_reply_to_id" : 874092009,
      "line" : 780,
      "node_id" : "PRRC_kwDOABII5840Ggp_",
      "original_commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "original_line" : 780,
      "original_position" : 222,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 222,
      "pull_request_review_id" : 974518738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874121855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-16T20:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874121855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874801114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874801114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Great, thanks! I missed that `NextSyncBlock()` goes back to the fork point already in master during sync. If it's that easy to fix, I might open a PR vs master. Here, this can be resolved.",
      "commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "created_at" : "2022-05-17T13:16:38Z",
      "diff_hunk" : "@@ -659,9 +717,96 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* locator_block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        const CChain& active_chain = Assert(m_node.chainman)->ActiveChain();\n+        bool prune_violation = false;\n+        if (!locator_block) {\n+            // make sure we have all block data back to the genesis\n+            prune_violation = m_node.chainman->m_blockman.GetFirstStoredBlock(*active_chain.Tip()) != active_chain.Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = locator_block;\n+            if (!active_chain.Contains(block_to_test)) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = active_chain.FindFork(block_to_test);\n+            }\n+            const CBlockIndex* block = active_chain.Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block && (block->nStatus & BLOCK_HAVE_DATA)) {\n+                if (block_to_test == block) {\n+                    prune_violation = false;\n+                    break;\n+                }\n+                // block->pprev must exist at this point, since block_to_test is part of the chain\n+                // and thus must be encountered when going backwards from the tip\n+                assert(block->pprev);\n+                block = block->pprev;\n+            }\n+        }\n+        return !prune_violation;\n+    }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n+    {\n+        std::unique_ptr<NotificationsHandlerImpl> handler;\n+        std::optional<interfaces::BlockInfo> block_info;\n+        // std::promise to wait for the first blockConnected notification, so\n+        // caller is notified about the starting block before this returns.\n+        // It might be good in the future to return without waiting for this,\n+        // and allow more initialization code to run in parallel.\n+        std::promise<void> promise;\n+        {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being received, it is important to not to register for\n+        // notifications immediately, but to delay registration with\n+        // CallFunctionInValidationInterfaceQueue, registering the notification\n+        // proxy inside the queue, so older notifications in the queue before it\n+        // get processed before the proxy is registered.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n+        LOCK(cs_main);\n+        const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n+        const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874801114",
      "id" : 874801114,
      "in_reply_to_id" : 874092009,
      "line" : 780,
      "node_id" : "PRRC_kwDOABII5840JGfa",
      "original_commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "original_line" : 780,
      "original_position" : 222,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 222,
      "pull_request_review_id" : 975451115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874801114/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T13:16:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874801114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r875392405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875392405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r874801114\r\n\r\n> Great, thanks! I missed that `NextSyncBlock()` goes back to the fork point already in master during sync. If it's that easy to fix, I might open a PR vs master. Here, this can be resolved.\r\n\r\nYes, this is a good catch and test on your branch looks good, but the fix could be simpler and more generic.\r\n\r\nJust to close the thread, the issue described here is pre-existing, and basically orthogonal to this PR even if it conflicts a little. The issue just happens if there is a reorg away from the last block that was indexed while the index is shut down.",
      "commit_id" : "699877a6c682eafde30b5c6eefa069a1ab7e58f4",
      "created_at" : "2022-05-18T01:29:11Z",
      "diff_hunk" : "@@ -659,9 +717,96 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* locator_block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        const CChain& active_chain = Assert(m_node.chainman)->ActiveChain();\n+        bool prune_violation = false;\n+        if (!locator_block) {\n+            // make sure we have all block data back to the genesis\n+            prune_violation = m_node.chainman->m_blockman.GetFirstStoredBlock(*active_chain.Tip()) != active_chain.Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = locator_block;\n+            if (!active_chain.Contains(block_to_test)) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = active_chain.FindFork(block_to_test);\n+            }\n+            const CBlockIndex* block = active_chain.Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block && (block->nStatus & BLOCK_HAVE_DATA)) {\n+                if (block_to_test == block) {\n+                    prune_violation = false;\n+                    break;\n+                }\n+                // block->pprev must exist at this point, since block_to_test is part of the chain\n+                // and thus must be encountered when going backwards from the tip\n+                assert(block->pprev);\n+                block = block->pprev;\n+            }\n+        }\n+        return !prune_violation;\n+    }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n+    {\n+        std::unique_ptr<NotificationsHandlerImpl> handler;\n+        std::optional<interfaces::BlockInfo> block_info;\n+        // std::promise to wait for the first blockConnected notification, so\n+        // caller is notified about the starting block before this returns.\n+        // It might be good in the future to return without waiting for this,\n+        // and allow more initialization code to run in parallel.\n+        std::promise<void> promise;\n+        {\n+        // Lock cs_main while finding forks and determining which blocks to\n+        // rescan. Release cs_main while processing blocks and while calling\n+        // RegisterSharedValidationInterface in the notifications thread.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being received, it is important to not to register for\n+        // notifications immediately, but to delay registration with\n+        // CallFunctionInValidationInterfaceQueue, registering the notification\n+        // proxy inside the queue, so older notifications in the queue before it\n+        // get processed before the proxy is registered.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be added to the queue after the queue entry which connects the proxy.\n+        AssertLockNotHeld(::cs_main);\n+        LOCK(cs_main);\n+        const CChainState& active = Assert(m_node.chainman)->ActiveChainstate();\n+        const CBlockIndex* locator_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r875392405",
      "id" : 875392405,
      "in_reply_to_id" : 874092009,
      "line" : 780,
      "node_id" : "PRRC_kwDOABII5840LW2V",
      "original_commit_id" : "fd6568f6888bc86985ce626731cd0f9db35889b8",
      "original_line" : 780,
      "original_position" : 222,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 222,
      "pull_request_review_id" : 976258445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875392405/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T01:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875392405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-19T14:31:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1131781055",
      "id" : 1131781055,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585DdZu_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131781055/reactions"
      },
      "updated_at" : "2022-05-19T14:31:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131781055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 699877a6c682eafde30b5c6eefa069a1ab7e58f4 -> 3d33427d7ce832a763d1dc6a264244440c14fe1e ([`pr/indexy.20`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.20) -> [`pr/indexy.21`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.21), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.20-rebase..pr/indexy.21)) due to conflict with #25074",
      "created_at" : "2022-05-19T18:44:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1132072521",
      "id" : 1132072521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585Deg5J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1132072521/reactions"
      },
      "updated_at" : "2022-05-19T18:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1132072521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 3d33427d7ce832a763d1dc6a264244440c14fe1e -> acfb6089041e7ba18f8778eb97e07d1bba2b5686 ([`pr/indexy.21`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.21) -> [`pr/indexy.22`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.22), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.21-rebase..pr/indexy.22)) due to conflict with #24410",
      "created_at" : "2022-06-01T20:21:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1144096475",
      "id" : 1144096475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585EMYbb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144096475/reactions"
      },
      "updated_at" : "2022-06-01T20:21:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144096475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-15T08:01:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1156128904",
      "id" : 1156128904,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585E6SCI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156128904/reactions"
      },
      "updated_at" : "2022-06-15T08:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156128904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased acfb6089041e7ba18f8778eb97e07d1bba2b5686 -> 4b1ab00331f2e62cddfcb8bb23a0c41be8af3dbd ([`pr/indexy.22`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.22) -> [`pr/indexy.23`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.23), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.22-rebase..pr/indexy.23)) due to conflict with #25338 and silent conflict with #24931",
      "created_at" : "2022-06-15T13:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1156464432",
      "id" : 1156464432,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585E7j8w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156464432/reactions"
      },
      "updated_at" : "2022-06-15T13:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156464432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nSUMMARY: ThreadSanitizer: data race src/./serialize.h:418:84 in void Wrapper<VarIntFormatter<(VarIntMode)0>, unsigned int const&>::Serialize<CDataStream>(CDataStream&) const\r\n```\r\n\r\nhttps://cirrus-ci.com/task/6321104825352192?logs=ci#L3331",
      "created_at" : "2022-06-15T17:22:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1156738032",
      "id" : 1156738032,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585E8mvw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156738032/reactions"
      },
      "updated_at" : "2022-06-15T17:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156738032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In general, if there are two threads accessing a variable, and you know the second thread will not access the variable until the first thread is done accessing it, does it matter if no mutex is locked while accessing the variable?\r\n\r\nData race appears to happen reading / writing the `BlockFilterIndex::m_next_filter_pos.nPos` member variable. The variable is incremented in `BlockFilterIndex::CustomAppend` after blockfilter data is written, and it's read in `BlockFilterIndex::CustomCommit` with apparently no synchronization between the two functions. I think there's probably not a real race here. These methods are called from the index sync thread initially, and then the validation thread after that so they are called from two different threads, but the different calls should be synchronized through the validation queue, so I don't think a lock should be necessary just to read this variable. But maybe just adding a lock is the path of least resistance\r\n\r\n",
      "created_at" : "2022-06-15T18:01:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1156772546",
      "id" : 1156772546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585E8vLC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156772546/reactions"
      },
      "updated_at" : "2022-06-15T18:01:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156772546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r902995335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902995335"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "bc39508eb83b33e620a81ca89ed3bade90344840 (\"Remove index prune_violation code\"):\r\nI'm not sure if it's helpful to talk about a locator (which is more of a list of blocks) and call it `locator_block` here, since checkBlocks just accepts a single BlockIndex - it may currently be derived from a locator, but that info isn't really required here - if we stopped using locators and just saved single block hashes, `checkBlocks` wouldn't be affected at all.",
      "commit_id" : "4b1ab00331f2e62cddfcb8bb23a0c41be8af3dbd",
      "created_at" : "2022-06-21T19:33:43Z",
      "diff_hunk" : "@@ -264,6 +265,9 @@ class Chain\n         virtual void chainStateFlushed(const CBlockLocator& locator) {}\n     };\n \n+    //! Check if all blocks needed to sync from locator are present.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r902995335",
      "id" : 902995335,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58410p2H",
      "original_commit_id" : "bc39508eb83b33e620a81ca89ed3bade90344840",
      "original_line" : 268,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 12,
      "pull_request_review_id" : 1014141911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902995335/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T02:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902995335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r904452837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904452837"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "1091e79d7bb57da3b96814fe26101e0bf75e1108 (Move sync thread from index to node)\r\n\r\nI think it would be good to abort early and not start the sync process if `CustomInit` of the initial `blockConnected` call failed (because the index might be corrupted). This is the behavior on master, and otherwise the syncing logic could commit some work like syncing another block, and while we'd still terminate with an InitError because `m_init_result=false` after that, this error might no longer occur at the next startup - the index might now be silently corrupted.",
      "commit_id" : "4b1ab00331f2e62cddfcb8bb23a0c41be8af3dbd",
      "created_at" : "2022-06-23T02:03:13Z",
      "diff_hunk" : "@@ -754,6 +779,53 @@ class ChainImpl : public Chain\n         notifications->blockConnected(block_info);\n         if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n         auto handler = std::make_unique<NotificationsHandlerImpl>(notifications);\n+        assert(!handler->m_thread_sync.joinable());\n+        if (!block_info.chain_tip) handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name, [&active, locator_block, notifications, handler = handler.get()] {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r904452837",
      "id" : 904452837,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58416Nrl",
      "original_commit_id" : "1091e79d7bb57da3b96814fe26101e0bf75e1108",
      "original_line" : 783,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 60,
      "pull_request_review_id" : 1014141911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904452837/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T02:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904452837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r905206741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905206741"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r904452837\r\n\r\n> I think it would be good to abort early and not start the sync process if `CustomInit` of the initial `blockConnected` call failed (because the index might be corrupted).\r\n\r\nGood point. I think I'm missing a `if (!*m_init_result) return m_index.Interrupt();` line after initializing `m_init_result` in `blockConnected()`",
      "commit_id" : "4b1ab00331f2e62cddfcb8bb23a0c41be8af3dbd",
      "created_at" : "2022-06-23T15:59:39Z",
      "diff_hunk" : "@@ -754,6 +779,53 @@ class ChainImpl : public Chain\n         notifications->blockConnected(block_info);\n         if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n         auto handler = std::make_unique<NotificationsHandlerImpl>(notifications);\n+        assert(!handler->m_thread_sync.joinable());\n+        if (!block_info.chain_tip) handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name, [&active, locator_block, notifications, handler = handler.get()] {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r905206741",
      "id" : 905206741,
      "in_reply_to_id" : 904452837,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58419FvV",
      "original_commit_id" : "1091e79d7bb57da3b96814fe26101e0bf75e1108",
      "original_line" : 783,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 60,
      "pull_request_review_id" : 1017279086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905206741/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T16:02:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905206741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Any suggestion about which commits would be good to include in a smaller initial PR?\r\n\r\nMaybe the first 7 commits, which mostly reduce the use of internal types within the existing index code. The commits after that move things to node, which could be another PR.",
      "created_at" : "2022-06-24T14:22:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1165625977",
      "id" : 1165625977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585Fegp5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165625977/reactions"
      },
      "updated_at" : "2022-06-24T14:22:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165625977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r908873600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908873600"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r905206741\r\n\r\nAdded `m_index.Interrupt()` call on failure",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-06-28T19:37:51Z",
      "diff_hunk" : "@@ -754,6 +779,53 @@ class ChainImpl : public Chain\n         notifications->blockConnected(block_info);\n         if (!block_info.chain_tip && !checkBlocks(locator_block)) return nullptr;\n         auto handler = std::make_unique<NotificationsHandlerImpl>(notifications);\n+        assert(!handler->m_thread_sync.joinable());\n+        if (!block_info.chain_tip) handler->m_thread_sync = std::thread(&util::TraceThread, options.thread_name, [&active, locator_block, notifications, handler = handler.get()] {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r908873600",
      "id" : 908873600,
      "in_reply_to_id" : 904452837,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842LE-A",
      "original_commit_id" : "1091e79d7bb57da3b96814fe26101e0bf75e1108",
      "original_line" : 783,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1022302955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908873600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-28T20:04:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908873600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r908874686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908874686"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r902995335\r\n\r\nRenamed from locator_block to start_block",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-06-28T19:39:21Z",
      "diff_hunk" : "@@ -264,6 +265,9 @@ class Chain\n         virtual void chainStateFlushed(const CBlockLocator& locator) {}\n     };\n \n+    //! Check if all blocks needed to sync from locator are present.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r908874686",
      "id" : 908874686,
      "in_reply_to_id" : 902995335,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842LFO-",
      "original_commit_id" : "bc39508eb83b33e620a81ca89ed3bade90344840",
      "original_line" : 268,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 1022302955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908874686/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-28T20:04:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/908874686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Any suggestion about which commits would be good to include in a smaller initial PR?\r\n> \r\n> Maybe the first 7 commits, which mostly reduce the use of internal types within the existing index code. The commits after that move things to node, which could be another PR.\r\n\r\nThanks! Done in #25494",
      "created_at" : "2022-06-28T20:16:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1169189298",
      "id" : 1169189298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585FsGmy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169189298/reactions"
      },
      "updated_at" : "2022-06-28T20:16:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169189298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-18T20:05:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1188247940",
      "id" : 1188247940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585G0zmE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1188247940/reactions"
      },
      "updated_at" : "2022-07-18T20:05:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1188247940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 8ca844e3ad924cf85918a5509f58b0eb9ab4c454 -> 8360eaa0b283ef525d99288bb9763e568cf430bf ([`pr/indexy.24`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.24) -> [`pr/indexy.25`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.25) after base PR #25494 merge",
      "created_at" : "2022-07-19T22:05:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1189597325",
      "id" : 1189597325,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585G59CN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189597325/reactions"
      },
      "updated_at" : "2022-07-19T22:05:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189597325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nindex/coinstatsindex.cpp:20:13: error: using decl 'ReadBlockFromDisk' is unused [misc-unused-using-decls,-warnings-as-errors]\r\nusing node::ReadBlockFromDisk;\r\n            ^\r\n/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/index/coinstatsindex.cpp:20:13: note: remove the using\r\nusing node::ReadBlockFromDisk;\r\n~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~\r\n437 warnings generated.",
      "created_at" : "2022-07-20T05:41:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1189851823",
      "id" : 1189851823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585G67Kv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189851823/reactions"
      },
      "updated_at" : "2022-07-20T05:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189851823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-21T19:20:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1191848002",
      "id" : 1191848002,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585HCihC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191848002/reactions"
      },
      "updated_at" : "2022-07-21T19:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191848002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929172598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929172598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/a035b6500f427cb535058c6718ff41edd961fdc3\r\n\r\n`checkBlocks` is pretty vague; maybe `hasDataFromTipDown()`?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-25T18:21:15Z",
      "diff_hunk" : "@@ -717,6 +717,39 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* start_block) override {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929172598",
      "id" : 929172598,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843Ygx2",
      "original_commit_id" : "a035b6500f427cb535058c6718ff41edd961fdc3",
      "original_line" : 720,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929172598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929172598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929193830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929193830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/de311f9f9ecb64dc83c070e3824c086b918cb09a\r\n\r\nI don't understand what this change does - it isn't obvious to me from the surrounding code that `pindex` isn't the tip.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-25T18:48:42Z",
      "diff_hunk" : "@@ -163,6 +167,7 @@ void BaseIndex::ThreadSync()\n \n             CBlock block;\n             interfaces::BlockInfo block_info = kernel::MakeBlockInfo(pindex);\n+            block_info.chain_tip = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929193830",
      "id" : 929193830,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843Yl9m",
      "original_commit_id" : "de311f9f9ecb64dc83c070e3824c086b918cb09a",
      "original_line" : 170,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929193830/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929193830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929243005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929243005"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/43e03ec21fc2da2bd76912e3aa6981899030c8c2\r\n\r\nIs this comment related to the changes in this commit? It seems like this corresponds to the previous commit.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-25T19:51:27Z",
      "diff_hunk" : "@@ -756,6 +756,9 @@ class ChainImpl : public Chain\n         const CBlockIndex* start_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n         interfaces::BlockInfo block_info = kernel::MakeBlockInfo(start_block);\n         block_info.chain_tip = start_block == active.m_chain.Tip();\n+        // Need to register the ValidationInterface and call blockConnected\n+        // both while holding cs_main, so that callbacks are not missed if\n+        // blockConnected sets m_synced to true.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929243005",
      "id" : 929243005,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843Yx99",
      "original_commit_id" : "43e03ec21fc2da2bd76912e3aa6981899030c8c2",
      "original_line" : 761,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929243005/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929243005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930258487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930258487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/43e03ec21fc2da2bd76912e3aa6981899030c8c2\r\n\r\nFWIW, inverting the conditional here makes it harder to verify the diff because now this block of logic isn't move-only.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-26T17:52:00Z",
      "diff_hunk" : "@@ -69,6 +71,37 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n             m_index.m_synced = true;\n         }\n     }\n+\n+    if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n+\n+    const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+        FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n+                   __func__, m_index.GetName());\n+        return;\n+    }\n+\n+    if (!m_index.CustomAppend(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930258487",
      "id" : 930258487,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII5843cp43",
      "original_commit_id" : "43e03ec21fc2da2bd76912e3aa6981899030c8c2",
      "original_line" : 144,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 282,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930258487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930258487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930306784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930306784"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/00b2300f919060a89bca74f0a908602a6a716f6d\r\n\r\nThis commit fails to compile because `MakeBlockInfo()` is in the `kernel` namespace. I guess this code is moved later on, which resolves the compilation failure.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-26T18:47:19Z",
      "diff_hunk" : "@@ -251,8 +252,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {\n+        interfaces::BlockInfo block_info = node::MakeBlockInfo(iter_tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930306784",
      "id" : 930306784,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843c1rg",
      "original_commit_id" : "00b2300f919060a89bca74f0a908602a6a716f6d",
      "original_line" : 260,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930306784/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930306784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930311965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930311965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/5605e4e1310d244892447755c1194195c2e866da#\r\n\r\nJust making sure this should actually be a copy and not a reference.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-26T18:54:02Z",
      "diff_hunk" : "@@ -158,6 +174,7 @@ void BaseIndex::ThreadSync()\n     const CBlockIndex* pindex = m_best_block_index.load();\n     if (!m_synced) {\n         auto& consensus_params = Params().GetConsensus();\n+        auto notifications = WITH_LOCK(m_mutex, return m_notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930311965",
      "id" : 930311965,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843c28d",
      "original_commit_id" : "5605e4e1310d244892447755c1194195c2e866da",
      "original_line" : 177,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930311965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930311965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 8360eaa0b283ef525d99288bb9763e568cf430bf -> ad9f581fcc7b6e73697f59eb03d10e91d16a09b4 ([`pr/indexy.25`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.25) -> [`pr/indexy.26`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.26), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.25-rebase..pr/indexy.26)) due to conflict with #22485\r\n",
      "created_at" : "2022-07-26T19:05:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1195871814",
      "id" : 1195871814,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585HR45G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1195871814/reactions"
      },
      "updated_at" : "2022-07-26T19:05:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1195871814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930369320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930369320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/ac1369650de26f325076340017745c67bdb34900\r\n\r\nIs this new behavior or inherited?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-07-26T20:10:24Z",
      "diff_hunk" : "@@ -134,6 +148,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930369320",
      "id" : 930369320,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843dE8o",
      "original_commit_id" : "ac1369650de26f325076340017745c67bdb34900",
      "original_line" : 153,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1049878909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930369320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T20:33:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930369320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:24:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1203704369",
      "id" : 1203704369,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585HvxIx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203704369/reactions"
      },
      "updated_at" : "2022-08-03T09:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203704369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r936973455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936973455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929172598\r\n\r\n> `checkBlocks` is pretty vague; maybe `hasDataFromTipDown()`?\r\n\r\nThanks, renamed",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T17:47:22Z",
      "diff_hunk" : "@@ -717,6 +717,39 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool checkBlocks(const CBlockIndex* start_block) override {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r936973455",
      "id" : 936973455,
      "in_reply_to_id" : 929172598,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432RSP",
      "original_commit_id" : "a035b6500f427cb535058c6718ff41edd961fdc3",
      "original_line" : 720,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936973455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936973455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r936974376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936974376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929193830\r\n\r\n> I don't understand what this change does - it isn't obvious to me from the surrounding code that `pindex` isn't the tip.\r\n\r\nThanks, removed this. Nothing is actually looking at this variable so it doesn't do anything. This code is just reading old blocks which are mostly not from the tip of the chain, so this was setting the variable to avoid seeming like they were.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T17:48:36Z",
      "diff_hunk" : "@@ -163,6 +167,7 @@ void BaseIndex::ThreadSync()\n \n             CBlock block;\n             interfaces::BlockInfo block_info = kernel::MakeBlockInfo(pindex);\n+            block_info.chain_tip = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r936974376",
      "id" : 936974376,
      "in_reply_to_id" : 929193830,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432Rgo",
      "original_commit_id" : "de311f9f9ecb64dc83c070e3824c086b918cb09a",
      "original_line" : 170,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936974376/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936974376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937025233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937025233"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930306784\r\n\r\n> This commit fails to compile because `MakeBlockInfo()` is in the `kernel` namespace. I guess this code is moved later on, which resolves the compilation failure.\r\n\r\nThanks! Updated to fix",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T18:50:56Z",
      "diff_hunk" : "@@ -251,8 +252,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {\n+        interfaces::BlockInfo block_info = node::MakeBlockInfo(iter_tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937025233",
      "id" : 937025233,
      "in_reply_to_id" : 930306784,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432d7R",
      "original_commit_id" : "00b2300f919060a89bca74f0a908602a6a716f6d",
      "original_line" : 260,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937025233/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937025233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937037678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937037678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930311965\r\n\r\n> Just making sure this should actually be a copy and not a reference.\r\n\r\nYes a reference to the shared_ptr wouldn't work here because the shared_ptr could be reset at any time from another thread. A copy of the pointer is actually needed",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T19:06:21Z",
      "diff_hunk" : "@@ -158,6 +174,7 @@ void BaseIndex::ThreadSync()\n     const CBlockIndex* pindex = m_best_block_index.load();\n     if (!m_synced) {\n         auto& consensus_params = Params().GetConsensus();\n+        auto notifications = WITH_LOCK(m_mutex, return m_notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937037678",
      "id" : 937037678,
      "in_reply_to_id" : 930311965,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432g9u",
      "original_commit_id" : "5605e4e1310d244892447755c1194195c2e866da",
      "original_line" : 177,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937037678/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937037678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937044459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r929243005\r\n\r\n> Is this comment related to the changes in this commit? It seems like this corresponds to the previous commit.\r\n\r\nThanks, just dropped this. I was looking for someplace to move [this comment](https://github.com/bitcoin/bitcoin/commit/43e03ec21fc2da2bd76912e3aa6981899030c8c2#diff-5251d93616c116c364d2d502ad2a59e901a3512194462fabacc9756f96fd8dddL351-L352) so I moved it here, but it doesn't really work here and is better to prune",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T19:15:31Z",
      "diff_hunk" : "@@ -756,6 +756,9 @@ class ChainImpl : public Chain\n         const CBlockIndex* start_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n         interfaces::BlockInfo block_info = kernel::MakeBlockInfo(start_block);\n         block_info.chain_tip = start_block == active.m_chain.Tip();\n+        // Need to register the ValidationInterface and call blockConnected\n+        // both while holding cs_main, so that callbacks are not missed if\n+        // blockConnected sets m_synced to true.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937044459",
      "id" : 937044459,
      "in_reply_to_id" : 929243005,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432inr",
      "original_commit_id" : "43e03ec21fc2da2bd76912e3aa6981899030c8c2",
      "original_line" : 761,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937044955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044955"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930258487\r\n\r\n> FWIW, inverting the conditional here makes it harder to verify the diff because now this block of logic isn't move-only.\r\n\r\nGood catch, now avoided this",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T19:16:05Z",
      "diff_hunk" : "@@ -69,6 +71,37 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n             m_index.m_synced = true;\n         }\n     }\n+\n+    if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n+\n+    const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+        FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n+                   __func__, m_index.GetName());\n+        return;\n+    }\n+\n+    if (!m_index.CustomAppend(block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937044955",
      "id" : 937044955,
      "in_reply_to_id" : 930258487,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII58432ivb",
      "original_commit_id" : "43e03ec21fc2da2bd76912e3aa6981899030c8c2",
      "original_line" : 144,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 282,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044955/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937044955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937045771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937045771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r930369320\r\n\r\n> Is this new behavior or inherited?\r\n\r\nIt's all inherited behavior. The indexes ignored \"blockDisconnected\" notifications entirely before, so the \"During initial sync, ignore validation interface notifications\" part of this comment happened implicitly. The \"process notifications from sync thread\" part of this comment is referring to new blockDisconnected code below, but that code is just moving from the ThreadSync to here (so ThreadSync can move out of the src/index/ to src/node/ later)",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-08-03T19:17:03Z",
      "diff_hunk" : "@@ -134,6 +148,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r937045771",
      "id" : 937045771,
      "in_reply_to_id" : 930369320,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58432i8L",
      "original_commit_id" : "ac1369650de26f325076340017745c67bdb34900",
      "original_line" : 153,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1060774316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937045771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T20:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937045771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nmusing decl 'ReadBlockFromDisk' is unused [misc-unused-using-decls,-warnings-as-errors]ï¿½[0m\r\nusing node::ReadBlockFromDisk;",
      "created_at" : "2022-08-10T14:07:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1210725837",
      "id" : 1210725837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585IKjXN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1210725837/reactions"
      },
      "updated_at" : "2022-08-10T14:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1210725837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated d83caa15e9b46227da9ad9a36da493bcf1de891b -> 781c4d775880de4190eecb93442148e2d28e61b2 ([`pr/indexy.27`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.27) -> [`pr/indexy.28`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.28), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.27..pr/indexy.28)) adding mutex to fix blockfilterindex tsan errors https://cirrus-ci.com/task/4753821174857728?logs=ci#L3850 and dropped unused using declaration\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1210725837\r\n\r\n> ```\r\n> using decl 'ReadBlockFromDisk' is unused [misc-unused-using-decls,-warnings-as-errors]\r\n> ```\r\n\r\nThanks, fixed",
      "created_at" : "2022-08-15T17:37:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1215466441",
      "id" : 1215466441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585IcovJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1215466441/reactions"
      },
      "updated_at" : "2022-08-15T17:37:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1215466441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-13T14:27:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1245495910",
      "id" : 1245495910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585KPMJm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245495910/reactions"
      },
      "updated_at" : "2022-09-13T14:27:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245495910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 781c4d775880de4190eecb93442148e2d28e61b2 -> 8c66a7cc9a22b350dcdc03cec04c123b45ba7f8a ([`pr/indexy.28`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.28) -> [`pr/indexy.29`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.29), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.28-rebase..pr/indexy.29)) due to conflicts with #25222, #24513, and #25971",
      "created_at" : "2022-09-21T03:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1253157852",
      "id" : 1253157852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585Ksavc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253157852/reactions"
      },
      "updated_at" : "2022-09-21T03:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253157852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-10-10T08:21:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1272950370",
      "id" : 1272950370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585L365i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272950370/reactions"
      },
      "updated_at" : "2022-10-10T08:21:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272950370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 8c66a7cc9a22b350dcdc03cec04c123b45ba7f8a -> b25b01352ec29a5657813be3ba88c321b7c8fa2b ([`pr/indexy.29`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.29) -> [`pr/indexy.30`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.30), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.29-rebase..pr/indexy.30)) due to conflicts with #26215 and #23549",
      "created_at" : "2022-10-13T20:18:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1278132877",
      "id" : 1278132877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585MLsKN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1278132877/reactions"
      },
      "updated_at" : "2022-10-13T20:18:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1278132877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-22T11:15:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1323509407",
      "id" : 1323509407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585O4yaf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1323509407/reactions"
      },
      "updated_at" : "2022-11-22T11:15:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1323509407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased b25b01352ec29a5657813be3ba88c321b7c8fa2b -> f8a26680e902820dc3ee84e1fa91f80c3668a10f ([`pr/indexy.30`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.30) -> [`pr/indexy.31`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.31), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.30-rebase..pr/indexy.31)) due to conflicts with #25957 and #26292",
      "created_at" : "2022-11-28T17:08:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1329448150",
      "id" : 1329448150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585PPcTW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329448150/reactions"
      },
      "updated_at" : "2022-11-28T17:08:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329448150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033933984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033933984"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/2f71f52b9b37b94a03aa203d16eecdca467361ac\r\n\r\nNot a big deal, but curious why this was removed since it was introduced in the previous commit.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-28T18:53:20Z",
      "diff_hunk" : "@@ -271,14 +272,24 @@ class Chain\n         virtual ~Notifications() {}\n         virtual void transactionAddedToMempool(const CTransactionRef& tx, uint64_t mempool_sequence) {}\n         virtual void transactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence) {}\n+        //! Notification sent when new blocks are connected, and also called on\n+        //! startup from attachChain() with the last connected block. The\n+        //! block.data pointer is null for the last connected block and non-null\n+        //! for newly connected blocks after that.\n         virtual void blockConnected(const BlockInfo& block) {}\n         virtual void blockDisconnected(const BlockInfo& block) {}\n         virtual void updatedBlockTip() {}\n         virtual void chainStateFlushed(const CBlockLocator& locator) {}\n     };\n \n-    //! Check if all blocks needed to sync start block to current tip are present.\n-    virtual bool hasDataFromTipDown(const CBlockIndex* start_block) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033933984",
      "id" : 1033933984,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849oJSg",
      "original_commit_id" : "2f71f52b9b37b94a03aa203d16eecdca467361ac",
      "original_line" : 281,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033933984/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033933984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033943433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033943433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/2f71f52b9b37b94a03aa203d16eecdca467361ac\r\n\r\nWouldn't we want to do this check/return before we issue a `blockConnected()` event, or does it not matter because we know that we at least have data for the current tip?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-28T19:03:37Z",
      "diff_hunk" : "@@ -759,6 +758,18 @@ class ChainImpl : public Chain\n         }\n         return !prune_violation;\n     }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override\n+    {\n+        LOCK(cs_main);\n+        const Chainstate& active = Assert(m_node.chainman)->ActiveChainstate();\n+        const CBlockIndex* start_block = locator.IsNull() ? nullptr : active.FindForkInGlobalIndex(locator);\n+        interfaces::BlockInfo block_info = kernel::MakeBlockInfo(start_block);\n+        block_info.chain_tip = start_block == active.m_chain.Tip();\n+        notifications->blockConnected(block_info);\n+        if (!block_info.chain_tip && !hasDataFromTipDown(start_block)) return nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033943433",
      "id" : 1033943433,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849oLmJ",
      "original_commit_id" : "2f71f52b9b37b94a03aa203d16eecdca467361ac",
      "original_line" : 769,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033943433/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033943433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033955263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033955263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/2f71f52b9b37b94a03aa203d16eecdca467361ac\r\n\r\nThe contents of this function are pretty specific to indexes (e.g. we have logic in here that refuses to set up the notifications handler if there isn't data beneath the given tip) and I think the name `attachChain` a little bit generic, so might consider renaming this `attachIndexer()` or something more descriptive.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-28T19:15:40Z",
      "diff_hunk" : "@@ -759,6 +758,18 @@ class ChainImpl : public Chain\n         }\n         return !prune_violation;\n     }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1033955263",
      "id" : 1033955263,
      "line" : 814,
      "node_id" : "PRRC_kwDOABII5849oOe_",
      "original_commit_id" : "2f71f52b9b37b94a03aa203d16eecdca467361ac",
      "original_line" : 814,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 187,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033955263/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033955263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034011918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034011918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/a6d1c22dc1254cbfedda7add573f0d537aefd36c\r\n\r\nMaybe I'm just dense today, but I don't recognize this cpp pattern. Is this some kind of initialization shorthand that's executed once on construction, when we get a valid reference for `m_index`?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-28T20:21:29Z",
      "diff_hunk" : "@@ -58,6 +58,7 @@ class BaseIndexNotifications : public interfaces::Chain::Notifications\n     void chainStateFlushed(const CBlockLocator& locator) override;\n \n     BaseIndex& m_index;\n+    interfaces::Chain::NotifyOptions m_options = m_index.CustomOptions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034011918",
      "id" : 1034011918,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849ocUO",
      "original_commit_id" : "a6d1c22dc1254cbfedda7add573f0d537aefd36c",
      "original_line" : 61,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034011918/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034011918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034775306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034775306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/ecedecac38f231d855e3f663671301d6e1ea7f6b\r\n\r\nIt would be nice to document what this mutex is for and why it's needed. I gather from below that it's guarding m_notifications and m_handler, but it's not clear to me why that's necessary - my guess is that because the guarded state is accessed by both the sync thread and validationinterface callbacks via `Chain`. ",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T13:48:07Z",
      "diff_hunk" : "@@ -94,16 +96,21 @@ class BaseIndex : public CValidationInterface\n \n     virtual bool AllowPrune() const = 0;\n \n+    Mutex m_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034775306",
      "id" : 1034775306,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rWsK",
      "original_commit_id" : "ecedecac38f231d855e3f663671301d6e1ea7f6b",
      "original_line" : 99,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034775306/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034775306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034827606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034827606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/a6d1c22dc1254cbfedda7add573f0d537aefd36c\r\n\r\nTo add some color here, reviewers can verify that in the pre-PR code \r\n- BlockConnected events are ignored while not `m_synced`, and\r\n- ThreadSync() calls Commit() which confusingly updates the best block in the index db (GetDB().WriteBestBlock(...)) but doesn't change m_best_block_index.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T14:29:15Z",
      "diff_hunk" : "@@ -84,16 +85,31 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         return;\n     }\n \n-    if (m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = kernel::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n+        FatalError(\"%s: Failed to write block %s to index\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return m_index.Interrupt();\n+    }\n+    // Only update m_best_block_index between flushes if synced. Unclear why\n+    // best block is not updated here before sync, but this has been\n+    // longstanding behavior since syncing was introduced in #13033 so care\n+    // should be taken if changing m_best_block_index semantics.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034827606",
      "id" : 1034827606,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rjdW",
      "original_commit_id" : "a6d1c22dc1254cbfedda7add573f0d537aefd36c",
      "original_line" : 106,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034827606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034827606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034937153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034937153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/15f83492713abefea3f6ffc7e4c100a6177cc462\r\n\r\nWould it be worth `FatalError()`/`return` from here? I think that is needed to maintain strict behavioral compatibility with the way that ThreadSync() currently behaves, since [`!Rewind()` can be tripped](https://github.com/bitcoin/bitcoin/pull/24230/commits/15f83492713abefea3f6ffc7e4c100a6177cc462#diff-5251d93616c116c364d2d502ad2a59e901a3512194462fabacc9756f96fd8dddL221) for either a failure to retrieve block data OR failure to retrieve undo data.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T15:52:14Z",
      "diff_hunk" : "@@ -136,6 +150,23 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && block.chain_tip) return;\n+\n+    const CBlockIndex* pindex = WITH_LOCK(cs_main, return m_index.m_chainstate->m_blockman.LookupBlockIndex(block.hash));\n+    if (!m_rewind_start) m_rewind_start = pindex;\n+    if (m_rewind_error) return;\n+\n+    CBlockUndo block_undo;\n+    interfaces::BlockInfo block_info = kernel::MakeBlockInfo(pindex, block.data);\n+    if (m_options.disconnect_undo_data && block.height > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            m_rewind_error = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034937153",
      "id" : 1034937153,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849r-NB",
      "original_commit_id" : "15f83492713abefea3f6ffc7e4c100a6177cc462",
      "original_line" : 165,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034937153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034937153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034952930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034952930"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/ed79c47c1385dc2e1b25d3958fa83a231770353d\r\n\r\nShould the equivalent old code in ThreadSync() be removed here in this commit as well?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T16:04:34Z",
      "diff_hunk" : "@@ -80,6 +85,15 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         m_index.SetBestBlockIndex(pindex);\n         if (block.chain_tip) {\n             m_index.m_synced = true;\n+            if (pindex) {\n+                LogPrintf(\"%s is enabled at height %d\\n\", m_index.GetName(), pindex->nHeight);\n+            } else {\n+                LogPrintf(\"%s is enabled\\n\", m_index.GetName());\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034952930",
      "id" : 1034952930,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII5849sCDi",
      "original_commit_id" : "ed79c47c1385dc2e1b25d3958fa83a231770353d",
      "original_line" : 104,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 156,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034952930/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034952930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034972038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034972038"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/ed79c47c1385dc2e1b25d3958fa83a231770353d\r\n\r\nMay be worth a comment that `blockDisconnected` will interrupt below in this case, triggering the related return?",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T16:20:21Z",
      "diff_hunk" : "@@ -266,13 +284,13 @@ void BaseIndex::ThreadSync()\n                         interfaces::BlockInfo block_info = kernel::MakeBlockInfo(iter_tip);\n                         block_info.chain_tip = false;\n                         if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                            FatalError(\"%s: Failed to read block %s from disk\",\n+                            block_info.error = strprintf(\"%s: Failed to read block %s from disk\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034972038",
      "id" : 1034972038,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849sGuG",
      "original_commit_id" : "ed79c47c1385dc2e1b25d3958fa83a231770353d",
      "original_line" : 287,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034972038/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034972038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034973794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034973794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/24230/commits/ed79c47c1385dc2e1b25d3958fa83a231770353d#diff-8e9fef4d0718d085f31da382899d97e3bbefc8d6a72ede95916a0e2fbd1a532fR92\r\n\r\nIt might help to add some documentation for how this is used and under what conditions it is set.",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2022-11-29T16:21:53Z",
      "diff_hunk" : "@@ -89,6 +89,7 @@ struct BlockInfo {\n     const CBlockUndo* undo_data = nullptr;\n     //! Block is from the tip of the chain (always true except when first calling attachChain and reading old blocks).\n     bool chain_tip = true;\n+    std::string error;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1034973794",
      "id" : 1034973794,
      "line" : 93,
      "node_id" : "PRRC_kwDOABII5849sHJi",
      "original_commit_id" : "ed79c47c1385dc2e1b25d3958fa83a231770353d",
      "original_line" : 93,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 14,
      "pull_request_review_id" : 1196377214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034973794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034973794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the feedback, and for trying to tackle this. This is just a quick response and I will work more on this later.\r\n\r\n> I don't feel like I have the horsepower to actually review the latter part of the changeset with much confidence. It'd almost be easier to review the entire thing squashed down IMO. If I ACK'd as-is, I'd be leaning on correctness verification via manual testing and verifying functional coverage.\r\n\r\nYes, this I think this is a good approach, and I think I recommended it previously. The best way to review the whole PR is to look at the squashed code, and make sure it indexing blocks correctly. There's no reason to pore over the individual commits, they are meant to be illustrative, and to communicate which code changes are intended to change application behavior, and which code changes which are intended to be refactoring.\r\n\r\nThe way I would review this would be to read commit descriptions in sequence, look over the code in each commit and make sure it doing what's described with no obvious surprises, and that things that are being described move in a coherent direction and make sense.\r\n\r\nThen I'd review final squashed code in detail and look closely at the final implementation for bugs.\r\n \r\n> I feel bad because you've put a ton of work into this PR, and I don't want to be throwing out \"stop energy;\" I'm just having a really tough time reading through this and convincing myself that I understand it's correct.\r\n> \r\n> Could we somehow characterize in the PR description the general strategy explaining what's happening in the middle commits - i.e. why exactly are we wanting to move code out of ThreadSync and into notification handler classes? I understand that this probably has to do with keeping node code on the node, but getting some kind of clear definition in the PR description might help. I.e. which processes/threads which classes are executed on.\r\n\r\nI'll work on this but the answer is that just that if every individual index and every individual wallet is individually rereading the same blocks on startup it is worse for performance and responsiveness than if they tell the node what blocks they need to read, and let it feed them the data. It can also deduplicate code between wallets and indexes, provide better feedback about overall sync progress, and make it straightforward to write new clients that need to be informed about connected and disconnected blocks and stay in sync with the chain.\r\n\r\n> I don't have a good model that helps me understand, e.g., why we want to avoid `FatalError()` in `ThreadSync()` and instead set `block_info.error`.\r\n\r\nProbably this is an example of something that I need to document better in the context of a specific commit, but in general failure to sync a specific index (or wallet) should just result in failure to load that index not necessarily a fatal error that should bring down the node.\r\n\r\n> * [ ]  [15f8349](https://github.com/bitcoin/bitcoin/commit/15f83492713abefea3f6ffc7e4c100a6177cc462) indexes, refactor: Move Rewind logic out of Rewind to blockDisconnected and ThreadSync\r\n> \r\n> This is the hardest commit for me to follow. It's distributing the contents of `Rewind()` over `ThreadSync()` and `blockDisconnected()`.\r\n> \r\n> I'm not sure how to decompose this to make it easier to follow, but it's a real challenge for me to feel confident about this not changing behavior.\r\n\r\nI don't think this is something that's especially important to check or feel confident about. This reminds me of high school physics tests that would sometimes punish you for showing extra work. If you skipped steps and just started from an equation that seemed like it might give a right answer, that could be a safer than actually thinking about the problem and showing extra work that grader could find fault with.\r\n\r\nIn this case, if I'm looking at a PR that has combination of refactoring changes and behavioral changes, I think it is helpful to know which changes are which, and what the intent is behind various changes, even if in the end I am only looking for serious bugs, and I'm not tediously verifying that there is no behavior change _whatsoever_.\r\n \r\n> Move-only stuff is pretty clear. So now the initial index sync is going to happen all in the node process? Would there be a way to offload this to the index processes?\r\n\r\nIf concern is about performance, this PR by itself shouldn't affect that,  since attachChain is keeping the one thread per index, all threads racing each other to reread the same blocks synchronization model. Moving the block reading code out of the indexes just allows for more coordination and better performance and monitoring in the future.",
      "created_at" : "2022-11-30T04:24:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1331628048",
      "id" : 1331628048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585PXwgQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331628048/reactions"
      },
      "updated_at" : "2022-11-30T04:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331628048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-01-04T20:02:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1371361600",
      "id" : 1371361600,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585RvVFA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1371361600/reactions"
      },
      "updated_at" : "2023-01-04T20:02:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1371361600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1083267771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083267771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nindex/coinstatsindex.cpp:143:37: error: use of undeclared identifier 'pindex'",
      "commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "created_at" : "2023-01-21T09:28:50Z",
      "diff_hunk" : "@@ -146,6 +135,7 @@ bool CoinStatsIndex::CustomAppend(const interfaces::BlockInfo& block)\n \n         // Add the new utxos created from the block\n         assert(block.data);\n+        assert(block.undo_data);\n         for (size_t i = 0; i < block.data->vtx.size(); ++i) {\n             const auto& tx{block.data->vtx.at(i)};\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1083267771",
      "id" : 1083267771,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII585AkVq7",
      "original_commit_id" : "137bbe1478833ccc63f39f794816d35de14025b8",
      "original_line" : 141,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 37,
      "pull_request_review_id" : 1264607249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083267771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-21T09:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083267771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-17T23:35:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1435396100",
      "id" : 1435396100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585VjmgE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435396100/reactions"
      },
      "updated_at" : "2023-02-17T23:35:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435396100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-04-21T10:39:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1517631782",
      "id" : 1517631782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585adTkm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517631782/reactions"
      },
      "updated_at" : "2023-04-21T10:39:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517631782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1188776917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188776917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in d7eef9f49a827e96337febcf20a22b392dc7b51e: Can use `chaiman()`?",
      "commit_id" : "e025bb3f8d229969fdfe16e3c20191a5382c0443",
      "created_at" : "2023-05-09T15:24:13Z",
      "diff_hunk" : "@@ -725,6 +725,39 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    bool hasDataFromTipDown(const CBlockIndex* start_block) override {\n+        LOCK(::cs_main);\n+        const CChain& active_chain = Assert(m_node.chainman)->ActiveChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1188776917",
      "id" : 1188776917,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G20vV",
      "original_commit_id" : "d7eef9f49a827e96337febcf20a22b392dc7b51e",
      "original_line" : 730,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1418909211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188776917/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:24:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188776917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-11T10:33:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1543748608",
      "id" : 1543748608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585cA7wA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543748608/reactions"
      },
      "updated_at" : "2023-05-11T10:33:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543748608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is rebased after #27607, which allowed making a lot of simplifications and improvements. Also, I think the PR is better organized now, so I think I could split off the first commit or first few commits into a separate PR if reviewers would find that helpful.",
      "created_at" : "2023-07-14T19:49:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1636342363",
      "id" : 1636342363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585hiJpb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636342363/reactions"
      },
      "updated_at" : "2023-07-14T19:49:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636342363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll start another review early next week.",
      "created_at" : "2023-07-15T02:21:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1636628331",
      "id" : 1636628331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585hjPdr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636628331/reactions"
      },
      "updated_at" : "2023-07-15T02:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636628331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282008318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282008318"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In c0d1110d:\r\n\r\nGuess that you wrote this because you saw it in a unit test?\r\n\r\nI'm not seeing how this could be possible during the regular node initialization process. We aren't signaling any block prior to initializing the indexes.",
      "commit_id" : "e025bb3f8d229969fdfe16e3c20191a5382c0443",
      "created_at" : "2023-08-02T14:41:10Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282008318",
      "id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MaeT-",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559173712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282008318/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T14:45:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282008318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282048353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282048353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In ba30b60b:\r\n\r\nIsn't this conflicting with the `StartBackgroundSync()` call?\r\n\r\nLet's say that there are new blocks on the notifications queue at this point. By not setting the `m_synced` flag, we allow `ThreadSync()` to start.\r\nThis former one might have some work to do if some of the queued blocks notifications were processed in-between `Init()` and `StartBackgroundSync()`. Then, while this is being done, the validation queue thread might end up setting `m_synced=true`. Which would enable the index new block connection signals reception at the same time that `ThreadSync()` is being executed.",
      "commit_id" : "e025bb3f8d229969fdfe16e3c20191a5382c0443",
      "created_at" : "2023-08-02T15:10:15Z",
      "diff_hunk" : "@@ -140,7 +140,21 @@ bool BaseIndex::Init()\n     // Note: this will latch to true immediately if the user starts up with an empty\n     // datadir and an index enabled. If this is the case, indexation will happen solely\n     // via `BlockConnected` signals until, possibly, the next restart.\n-    m_synced = start_block == active_chain.Tip();\n+    if (start_block == active_chain.Tip()) {\n+        // To prevent race conditions, m_synced = true needs to be set from the\n+        // validationinterface thread and the m_synced = true callback needs to\n+        // be queued while cs_main is held.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being processed, it is important setting m_synced = true\n+        // in queue after they processed.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be queued after the m_synced = true callback.\n+        CallFunctionInValidationInterfaceQueue([this] { m_synced = true; });\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282048353",
      "id" : 1282048353,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MaoFh",
      "original_commit_id" : "ba30b60bcfb8ab5660064acd27ecde40bd3045a3",
      "original_line" : 157,
      "original_position" : 19,
      "original_start_line" : 143,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559236426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282048353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T15:10:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282048353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282083953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282083953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282008318\r\n\r\n> Guess that you wrote this because you saw it in a unit test?\r\n\r\nNo, it I believe it happens pretty reliably when you use `-reindex-chainstate`. I saw it reliably when I ran the `test/functional/feature_coinstatsindex.py` \"[Test that the index works with -reindex-chainstate](https://github.com/bitcoin/bitcoin/blob/2fa60f0b683cefd7956273986dafe3bde00c98fd/test/functional/feature_coinstatsindex.py#L238-L240)\" test and had a bug in the code that disabled this check. It caused the index to be corrupted because the same blocks would be added to the index twice.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-02T15:36:23Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282083953",
      "id" : 1282083953,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Mawxx",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559291719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282083953/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T16:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282083953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282110542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282110542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282048353\r\n\r\n> Isn't this conflicting with the `StartBackgroundSync()` call?\r\n> \r\n> Let's say that there are new blocks on the notifications queue at this point. By not setting the `m_synced` flag, we allow `ThreadSync()` to start.\r\n\r\nYes, that's a good point. I forgot that the m_synced flag is not just used to process notifications, but also to determine whether to start the sync thread.\r\n\r\nIt's hard to imagine this being a problem in pracice, but I think I should tweak the logic to distinguish between \"synced\" and \"ready\" states, where \"synced\" state means index is in sync with the chainstate and \"ready\" state means index is ready to start processing blockconnected notifications.\r\n\r\nEDIT: Later commit \"Move sync thread from index to node\" 0048fd1cbc00205c191dae1a96c44d02f4a7aae0 actually already does this so there is not a race condition in the end, but I it would be good to do it earlier.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-02T15:57:23Z",
      "diff_hunk" : "@@ -140,7 +140,21 @@ bool BaseIndex::Init()\n     // Note: this will latch to true immediately if the user starts up with an empty\n     // datadir and an index enabled. If this is the case, indexation will happen solely\n     // via `BlockConnected` signals until, possibly, the next restart.\n-    m_synced = start_block == active_chain.Tip();\n+    if (start_block == active_chain.Tip()) {\n+        // To prevent race conditions, m_synced = true needs to be set from the\n+        // validationinterface thread and the m_synced = true callback needs to\n+        // be queued while cs_main is held.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being processed, it is important setting m_synced = true\n+        // in queue after they processed.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be queued after the m_synced = true callback.\n+        CallFunctionInValidationInterfaceQueue([this] { m_synced = true; });\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282110542",
      "id" : 1282110542,
      "in_reply_to_id" : 1282048353,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ma3RO",
      "original_commit_id" : "ba30b60bcfb8ab5660064acd27ecde40bd3045a3",
      "original_line" : 157,
      "original_position" : 19,
      "original_start_line" : 143,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559291719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282110542/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T16:11:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282110542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated e025bb3f8d229969fdfe16e3c20191a5382c0443 -> c553d9f0b0f796c30124fddb920b5e8b5b32de11 ([`pr/indexy.41`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.41) -> [`pr/indexy.42`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.42), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.41..pr/indexy.42)) to avoid race condition pointed out by furszy in an intermediate commit: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282110542 which could potentially lead to an assert failure if there was a reorg as indexes are starting up.",
      "created_at" : "2023-08-02T19:11:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1662828515",
      "id" : 1662828515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585jHL_j",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1662828515/reactions"
      },
      "updated_at" : "2023-08-02T19:11:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1662828515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282405497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282405497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I think that know how that could happen. It is not related to the `Init()` call.\r\n\r\nThe background sync process reads blocks directly from the chain index (calling `NextSyncBlock()`). So, what if a block gets connected while `ThreadSync()` is being executed but the event is not dispatched on time.. (before the background sync process finishes)\r\n\r\n1) The block connection event is added to the validation queue.\r\n2) The index background sync process reads the block from the chain and processes it.\r\n3) The validation queue dispatches the block connection event added in (1) to the index. Then... boom: the index received an already processed block.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-02T20:49:42Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282405497",
      "id" : 1282405497,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Mb_R5",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559821533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282405497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T20:49:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282405497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282421606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282421606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's accurate, but I don't think ThreadSync needs to even do anything for this to happen, and no new blocks need to be connected after ThreadSync starts.\r\n\r\nIf `-reindex-chainstate` indexing completes, and `ThreadSync` immediately starts and exits because it detects that the index best block is equal to the chain tip, and no new blocks are connected, there could still be stale block connected notifications in the queue which will cause the index to rewind and add the blocks again. The commit \r\n\"Avoid race, make -reindex-chainstate more efficient\" e5f2641137413da5970007a9b932b5993067b550 changes index startup behavior to just ignore the stale block connected notifications while `m_ready` is `false`, instead of processing them and pointlessly rewinding and reconnecting blocks.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-02T21:09:31Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1282421606",
      "id" : 1282421606,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585McDNm",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1559846738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282421606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-02T21:09:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1282421606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284517464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284517464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah ok, that is also a possibility. Great.\r\n\r\nCould the fix be decoupled into a standalone PR? Sounds like something that we could rapidly merge independently of this PR. It fixes a bug and also makes this work smaller.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-04T14:44:32Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284517464",
      "id" : 1284517464,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MkC5Y",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1563030091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284517464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-04T14:45:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284517464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284581060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284581060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Yeah ok, that is also a possibility. Great.\r\n> \r\n> Could the fix be decoupled into a standalone PR? Sounds like something that we could rapidly merge independently of this PR. It fixes a bug and also makes this work smaller.\r\n\r\nYes, I am definitely looking for suggestions on how many of the first commits it would make sense to split off into a separate PR.\r\n\r\nBut just to be clear, there isn't a bug here, just suboptimal behavior. If -reindex-chainstate is used and there are still block-connected notifications waiting in the queue when the index is started, it doesn't cause any index corruption. It just causes the last few blocks in the index to be rewound, and then appended again, as if there were a reorg",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-04T15:43:56Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284581060",
      "id" : 1284581060,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MkSbE",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1563131487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284581060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-04T15:43:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284581060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284902580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284902580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Yes, I am definitely looking for suggestions on how many of the first commits it would make sense to split off into a separate PR.\r\n\r\nOk cool. I suggested to decouple this commit only because I'm going commit by commit and it seemed like an easy step forward, but will keep moving forward.\r\n\r\n> But just to be clear, there isn't a bug here, just suboptimal behavior. If -reindex-chainstate is used and there are still block-connected notifications waiting in the queue when the index is started, it doesn't cause any index corruption. It just causes the last few blocks in the index to be rewound, and then appended again, as if there were a reorg\r\n\r\nYeah, we are sync. I said \"bug\" because of the unexpected behavior. I don't think that it was programmed to do that.",
      "commit_id" : "c553d9f0b0f796c30124fddb920b5e8b5b32de11",
      "created_at" : "2023-08-04T23:16:11Z",
      "diff_hunk" : "@@ -269,6 +295,38 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n         // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n         // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n         // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        //\n+        // To allow handling reorgs, this only checks that the new block\n+        // connects to ancestor of the current best block, instead of checking\n+        // that it connects to directly to the current block. If there is a\n+        // reorg, Rewind call below will remove existing blocks from the index\n+        // before adding the new one.\n+        //\n+        // The other case where the new block will connect to an ancestor of the\n+        // current block rather than the current block is when the m_synced flag\n+        // is set to true too early. For example if the index is synced to\n+        // height 100, and -reindex-chainstate option is used, there may be\n+        // BlockConnected notifications for blocks 97, 98, 99, and 100 sitting\n+        // in the notifications queue when m_synced gets set to true. When this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1284902580",
      "id" : 1284902580,
      "in_reply_to_id" : 1282008318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Mlg60",
      "original_commit_id" : "c0d1110d2a066f8e97ae33e769e761a10f0f0620",
      "original_line" : 310,
      "original_position" : 49,
      "original_start_line" : 305,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1563650229,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284902580/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-04T23:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284902580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-07T16:35:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1668228919",
      "id" : 1668228919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585jbyc3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668228919/reactions"
      },
      "updated_at" : "2023-08-07T16:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668228919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe a silent merge conflict in a functional test, see CI?\r\n\r\n```\r\nï¿½[0mï¿½[0;31mfeature_index_prune.py                                 | â Failed  | 2401 s",
      "created_at" : "2023-08-17T09:25:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1681939421",
      "id" : 1681939421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585kQFvd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681939421/reactions"
      },
      "updated_at" : "2023-08-17T09:25:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681939421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1304365188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304365188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b96598d9:\r\n\r\nSame as you did for `BlockConnected()`, what about doing the same cleanup on this method?. Check few lines below, we have the same:\r\n\r\n```\r\n// This checks that ChainStateFlushed callbacks are received after BlockConnected. The check may fail\r\n// immediately after the sync thread catches up and sets m_synced. Consider the case where\r\n// there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\r\n// backlog even after the sync thread has caught up to the new chain tip. In this unlikely\r\n// event, log a warning and let the queue clear\r\n```\r\n\r\nwhich is no longer possible, thanks to `m_ready` set in the validation queue thread.\r\n",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-24T13:50:39Z",
      "diff_hunk" : "@@ -356,7 +335,7 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n \n void BaseIndex::ChainStateFlushed(const CBlockLocator& locator)\n {\n-    if (!m_synced) {\n+    if (!m_ready) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1304365188",
      "id" : 1304365188,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NvwiE",
      "original_commit_id" : "b96598d93895e6c6be10e13cabf04935098f8b14",
      "original_line" : 338,
      "original_position" : 97,
      "original_start_line" : 336,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1593654901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304365188/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-24T14:40:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304365188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1304376602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304376602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b96598d9:\r\n\r\nSmall note, the comment that is above the `RegisterValidationInterface()` call is not so accurate anymore.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-24T13:56:47Z",
      "diff_hunk" : "@@ -141,6 +141,21 @@ bool BaseIndex::Init()\n     // datadir and an index enabled. If this is the case, indexation will happen solely\n     // via `BlockConnected` signals until, possibly, the next restart.\n     m_synced = start_block == active_chain.Tip();\n+    if (m_synced) {\n+        // To prevent race conditions, m_ready = true needs to be set from the\n+        // validationinterface thread and the m_ready = true callback needs to\n+        // be queued while cs_main is held.\n+        //\n+        // To prevent older, stale notifications currently in the validation\n+        // queue from being processed, it is important setting m_ready = true\n+        // in queue after they processed.\n+        //\n+        // To prevent new notifications that may be happening in the background\n+        // from being lost, it is important to keep cs_main locked while calling\n+        // CallFunctionInValidationInterfaceQueue, so the new notifications will\n+        // be queued after the m_ready = true callback.\n+        CallFunctionInValidationInterfaceQueue([this] { m_ready = true; });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1304376602",
      "id" : 1304376602,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NvzUa",
      "original_commit_id" : "b96598d93895e6c6be10e13cabf04935098f8b14",
      "original_line" : 157,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1593654901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304376602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T14:40:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304376602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1305674280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305674280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 1a6a2a3f:\r\n\r\nAs we always use the top locator item. What about providing the start block uint256 directly to `attachChain`?.\r\n\r\nAlso, what do you think about working on an index upgrade mechanism to only store the tip's uint256 instead of the locator?.\r\n\r\nIt seems that with it, we will be able to simplify 432febc3.\r\n\r\nUpdate:\r\nMade a quick version of it here: https://github.com/furszy/bitcoin-core/commit/7f2b2eb6c313d64e323edc11931d2786e181c0d8.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-25T13:38:13Z",
      "diff_hunk" : "@@ -731,6 +731,16 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n+    std::unique_ptr<Handler> attachChain(std::shared_ptr<Notifications> notifications, const CBlockLocator& locator, const NotifyOptions& options, const StartSyncFn& start_sync) override\n+    {\n+        LOCK(cs_main);\n+        const Chainstate& active{chainman().ActiveChainstate()};\n+        const CBlockIndex* start_block_index{locator.IsNull() ? nullptr : active.m_blockman.LookupBlockIndex(locator.vHave.at(0))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1305674280",
      "id" : 1305674280,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N0wIo",
      "original_commit_id" : "1a6a2a3fe5a19d706b9df60836b783bb3099deab",
      "original_line" : 738,
      "original_position" : 8,
      "original_start_line" : 734,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1595753171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305674280/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-25T14:36:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305674280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307940708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307940708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In cf491ea0:\r\n\r\nProbably, we should fix the tests that could be depending on this here too. For instance, the `blockfilter_index_init_destroy` unit test isn't interrupting nor stopping the index. \r\nThen, `coinstatsindex_unclean_shutdown` and `txindex_initial_sync` only call `Stop()` without calling `Interrupt()` first.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-28T20:53:40Z",
      "diff_hunk" : "@@ -123,8 +123,11 @@ BaseIndex::BaseIndex(std::unique_ptr<interfaces::Chain> chain, std::string name)\n \n BaseIndex::~BaseIndex()\n {\n-    Interrupt();\n-    Stop();\n+    //! Assert Stop() was called before this base destructor. Notification\n+    //! handlers call pure virtual methods like GetName(), so if they are still\n+    //! being called at this point, they would segfault.\n+    LOCK(m_mutex);\n+    assert(!m_handler);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307940708",
      "id" : 1307940708,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N9Zdk",
      "original_commit_id" : "cf491ea020f8b749f61731c7e705b0360a1d75fc",
      "original_line" : 130,
      "original_position" : 10,
      "original_start_line" : 124,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1599095636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307940708/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-28T20:55:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307940708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307966484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307966484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d260abb8:\r\n\r\nMissing indentation.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-28T21:22:19Z",
      "diff_hunk" : "@@ -326,8 +327,27 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {\n+        interfaces::BlockInfo block_info = kernel::MakeBlockInfo(iter_tip);\n+        if (CustomOptions().disconnect_data) {\n+            if (!m_chainstate->m_blockman.ReadBlockFromDisk(block, *iter_tip)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                             __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+            block_info.data = &block;\n+\t}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307966484",
      "id" : 1307966484,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N9fwU",
      "original_commit_id" : "d260abb89101a2a206ab3b86990a3c4518ae1508",
      "original_line" : 341,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1599149979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307966484/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T21:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307966484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307972744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307972744"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d260abb8:\r\n\r\nNote: now that only one block per `CustomRemove` call is rewinded, we could simplify the loop inside `CopyHeightIndexToHashIndex()`.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-28T21:27:11Z",
      "diff_hunk" : "@@ -285,15 +285,15 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool BlockFilterIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool BlockFilterIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all filters for blocks that are getting disconnected from the\n     // height index to the hash index so we can still find them when the height index entries are\n     // overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307972744",
      "id" : 1307972744,
      "line" : 300,
      "node_id" : "PRRC_kwDOABII585N9hSI",
      "original_commit_id" : "d260abb89101a2a206ab3b86990a3c4518ae1508",
      "original_line" : 296,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 77,
      "pull_request_review_id" : 1599149979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307972744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T21:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307972744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307976654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307976654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 5e2b1ea1:\r\n\r\nThe description says that this commit does not change behavior but this `Interrupt()` call here seems like a behavior change.",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-28T21:30:11Z",
      "diff_hunk" : "@@ -33,6 +33,7 @@ constexpr auto SYNC_LOCATOR_WRITE_INTERVAL{30s};\n template <typename... Args>\n void BaseIndex::FatalErrorf(const char* fmt, const Args&... args)\n {\n+    Interrupt(); // Cancel the sync thread",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307976654",
      "id" : 1307976654,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII585N9iPO",
      "original_commit_id" : "5e2b1ea14823bcc43429a130d8820f7be0f45b4b",
      "original_line" : 36,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 29,
      "pull_request_review_id" : 1599149979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307976654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T21:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307976654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307995721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307995721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a2e87d9d6:\r\n\r\nI asked myself why this `chain_tip` check was placed here few times until saw 5e2b1ea1, which makes `ThreadSync()` re-use this code.\r\n\r\nProbably, it would be helpful for other reviewers to have a comment saying: \"`chain_tip` is used here to let `ThreadSync()` handle reorgs\".",
      "commit_id" : "f74b34f2d4d30f6895cfbeed2ec655a60290e990",
      "created_at" : "2023-08-28T21:51:26Z",
      "diff_hunk" : "@@ -61,12 +61,37 @@ class BaseIndexNotifications : public interfaces::Chain::Notifications\n \n void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n {\n-    m_index.BlockConnected(block);\n+    if (m_index.IgnoreBlockConnected(block)) return;\n+\n+    const CBlockIndex* pindex = &m_index.BlockIndex(block.hash);\n+    const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n+    if (block.chain_tip && best_block_index && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r1307995721",
      "id" : 1307995721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N9m5J",
      "original_commit_id" : "a2e87d9d66902e8f7029ba235c2e2d6aa971c695",
      "original_line" : 68,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 1599180216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307995721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T21:51:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307995721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-05T11:42:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1706459591",
      "id" : 1706459591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585ltoHH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1706459591/reactions"
      },
      "updated_at" : "2023-09-05T11:42:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1706459591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-12T10:34:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1715470930",
      "id" : 1715470930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585mQAJS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715470930/reactions"
      },
      "updated_at" : "2023-09-12T10:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715470930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 855dedc6fc4d2be0acac5ee0f52184761c495355 -> 0d37538507e31468d24ac3249dc09ba6f44d4439 ([`pr/indexy.45`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.45) -> [`pr/indexy.46`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.46), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.45-rebase..pr/indexy.46)) due to conflicts with #28427\r\n",
      "created_at" : "2023-09-12T18:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1716209239",
      "id" : 1716209239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585mS0ZX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716209239/reactions"
      },
      "updated_at" : "2023-09-12T18:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716209239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-14T10:45:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1719214312",
      "id" : 1719214312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585meSDo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719214312/reactions"
      },
      "updated_at" : "2023-09-14T10:45:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719214312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 0d37538507e31468d24ac3249dc09ba6f44d4439 -> 84f38664060bba6326a51c4303e44b524aaf7c85 ([`pr/indexy.46`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.46) -> [`pr/indexy.47`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.47), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.46-rebase..pr/indexy.47)) due to conflict with #28458\r\nUpdated 84f38664060bba6326a51c4303e44b524aaf7c85 -> e09e18601db94107992dfb086c77081ffc5e01ec ([`pr/indexy.47`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.47) -> [`pr/indexy.48`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.48), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.47..pr/indexy.48)) fixing compile error from bad rebase conflict resolution (https://cirrus-ci.com/task/4702319267282944)",
      "created_at" : "2023-09-14T12:37:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1719371249",
      "id" : 1719371249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585me4Xx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719371249/reactions"
      },
      "updated_at" : "2023-09-14T14:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719371249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-26T13:52:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1735588443",
      "id" : 1735588443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585ncvpb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1735588443/reactions"
      },
      "updated_at" : "2023-09-26T13:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1735588443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-12-22T20:51:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1868061457",
      "id" : 1868061457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585vWFsR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1868061457/reactions"
      },
      "updated_at" : "2023-12-22T20:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1868061457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   }
]
