[
   {
      "body" : "nit: Might be worthwhile to print out the cmpctblk version being reconstructed in debug log\r\n\r\nnit aside, utACK https://github.com/bitcoin/bitcoin/pull/8393/commits/1b417c20a6b0205a98268f95e6e19d27def076e9",
      "created_at" : "2016-07-22T16:45:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234594686",
      "id" : 234594686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-22T16:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234594686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "Tested ACK 1b417c2 (I tested this branch extensively before this PR was opened).\r\n\r\n",
      "created_at" : "2016-07-22T16:48:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234595302",
      "id" : 234595302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-22T16:48:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234595302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "utACK 1b417c2 I will write some tests with NBitcoin soon.",
      "created_at" : "2016-07-24T04:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234757666",
      "id" : 234757666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-24T04:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234757666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r72060387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72060387"
         }
      },
      "body" : "This means that prior to segwit activation, blocks found by unupgraded miners will propagate without the benefit of compactblock announcements to upgraded nodes.\r\n\r\nPerhaps it'd be better to instead use the BIP9 LOCKED_IN window to transition from receiving compactblock announcements from any peer regardless of nServices, towards NODE_WITNESS peers, and once ACTIVE state is reached, we enforce that all announcing peers are NODE_WITNESS?\r\n\r\nTo be concrete, here's one suggestion:\r\n 1. before LOCKED_IN, use existing algorithm\r\n 1. after LOCKED_IN, don't allow NODE_WITNESS peers to be evicted by non-WITNESS peers, and preferentially first evict non-WITNESS peers when trying to add a WITNESS peer\r\n 1. after ACTIVATED, evict any non-WITNESS peers we have left making announcements.\r\n\r\nI think this ought to provide a smooth transition, but I actually am not sure we even need that second step, we can probably be a little more disruptive around the LOCKED_IN time to ensure that we're ready at activation.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-07-25T13:12:28Z",
      "diff_hunk" : "@@ -476,16 +479,16 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n }\n \n void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom) {\n-    if (nLocalServices & NODE_WITNESS) {\n-        // Don't ever request compact blocks when segwit is enabled.\n+    if (nLocalServices & ~pfrom->nServices & NODE_WITNESS) {\n+        // Never ask from peers who can't provide witnesses.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r72060387",
      "id" : 72060387,
      "original_commit_id" : "1b417c20a6b0205a98268f95e6e19d27def076e9",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72060387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Reminder for myself: adapt to use the suggestion from BIP152 to just send both sendcmpct version 1 and version 2 (and let the 2 be ignored by pre-witness peers), rather than trying to guess what the peer will want based on service flags. Suggested by @TheBlueMatt",
      "created_at" : "2016-07-25T23:37:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-235118990",
      "id" : 235118990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-25T23:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235118990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Implemented the suggestion above.",
      "created_at" : "2016-07-30T01:34:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-236331258",
      "id" : 236331258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-30T01:34:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/236331258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Fixed a bug found by @sdaftuar (see #8418).",
      "created_at" : "2016-07-30T18:22:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-236381021",
      "id" : 236381021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-30T18:22:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/236381021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "need backport to 0.13",
      "created_at" : "2016-08-04T10:36:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-237516954",
      "id" : 237516954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-04T10:36:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/237516954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8403418?v=3",
         "events_url" : "https://api.github.com/users/jl2012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jl2012/followers",
         "following_url" : "https://api.github.com/users/jl2012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jl2012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jl2012",
         "id" : 8403418,
         "login" : "jl2012",
         "organizations_url" : "https://api.github.com/users/jl2012/orgs",
         "received_events_url" : "https://api.github.com/users/jl2012/received_events",
         "repos_url" : "https://api.github.com/users/jl2012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jl2012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jl2012"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73564353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73564353"
         }
      },
      "body" : "This means that we'd overwrite `fSupportsCmpctWitness` if our peer sends a version 2 message followed by a version 1 message.  If we intend to require a certain ordering of sendcmpct announcements, I think that should be more clearly called out in the BIP (I'll leave a separate comment in bitcoin/bips#423 to indicate the language I suggest improving).  But my initial reaction is that we shouldn't impose this constraint.\r\n\r\nAnyway I'm a bit confused on the interaction here between NODE_WITNESS and how we process sendcmpct messages.  Per BIP 152, if we don't support version 2 compact blocks, we must ignore version 2 sendcmpct messages.  But this code doesn't appear to be written this way (ie this processes version 2 sendcmpct messages, even if NODE_WITNESS is off).\r\n\r\nIn particular, it seems that this code could break if eg it was part of a release (like 0.13.0)  where NODE_WITNESS would not be set, but at some point in the future it had a peer that supported only version 2 compact blocks (as we'd process the version 2 message and think we could communicate with the peer, even though we can't).\r\n",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-08-04T17:19:00Z",
      "diff_hunk" : "@@ -5183,7 +5187,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             LOCK(cs_main);\n             State(pfrom->GetId())->fProvidesHeaderAndIDs = !(nLocalServices & NODE_WITNESS) || (nCMPCTBLOCKVersion == 2);\n             State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            State(pfrom->GetId())->fWantCmpctWitness = (nCMPCTBLOCKVersion == 2);\n+            State(pfrom->GetId())->fSupportsCmpctWitness = (nCMPCTBLOCKVersion == 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73564353",
      "id" : 73564353,
      "original_commit_id" : "8b3343ffc8ed6957a998f53e19512087dc144e0f",
      "original_position" : 58,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73564353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73567190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73567190"
         }
      },
      "body" : "@sdaftuar I think they have to be sent in increasing order, so that the\nreceiver can use the simple \"the last understood sendcmpct counts\" logic.\n\nYou are right that we should ignore v2 sendcmpct messages when we don't\nhave NODE_WITNESS. That would make the behaviour of a non-defined segwit\nnode identical to a pre-segwit node. Agree?\n",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-08-04T17:34:27Z",
      "diff_hunk" : "@@ -5183,7 +5187,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             LOCK(cs_main);\n             State(pfrom->GetId())->fProvidesHeaderAndIDs = !(nLocalServices & NODE_WITNESS) || (nCMPCTBLOCKVersion == 2);\n             State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            State(pfrom->GetId())->fWantCmpctWitness = (nCMPCTBLOCKVersion == 2);\n+            State(pfrom->GetId())->fSupportsCmpctWitness = (nCMPCTBLOCKVersion == 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73567190",
      "id" : 73567190,
      "original_commit_id" : "8b3343ffc8ed6957a998f53e19512087dc144e0f",
      "original_position" : 58,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73567190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73569949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73569949"
         }
      },
      "body" : "@sipa  I guess that's fine.  I noted the language I thought could be clarified to make this more clear in the BIP pr.\r\n\r\nI agree that ignoring v2 messages if we're not NODE_WITNESS should result in the identical behavior we're looking for.\r\n",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-08-04T17:49:49Z",
      "diff_hunk" : "@@ -5183,7 +5187,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             LOCK(cs_main);\n             State(pfrom->GetId())->fProvidesHeaderAndIDs = !(nLocalServices & NODE_WITNESS) || (nCMPCTBLOCKVersion == 2);\n             State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            State(pfrom->GetId())->fWantCmpctWitness = (nCMPCTBLOCKVersion == 2);\n+            State(pfrom->GetId())->fSupportsCmpctWitness = (nCMPCTBLOCKVersion == 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r73569949",
      "id" : 73569949,
      "original_commit_id" : "8b3343ffc8ed6957a998f53e19512087dc144e0f",
      "original_position" : 58,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73569949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar Updated.",
      "created_at" : "2016-08-06T00:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-237992231",
      "id" : 237992231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-06T00:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/237992231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Tested:\r\n* mainnet (this PR) syncing from mainnet (this PR)\r\n* testnet (this PR) syncing from testnet (this PR)\r\n* testnet (this PR, with segwit activation disabled) syncing from testnet (this PR)\r\n* testnet (post-CB, pre-segwit code) syncing from testnet (this PR)\r\n\r\nThey all seem to be using compact blocks for transfer.",
      "created_at" : "2016-08-06T21:46:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-238050528",
      "id" : 238050528,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-06T21:46:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238050528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "re-utACK https://github.com/bitcoin/bitcoin/pull/8393/commits/00fabfeca09659f620b773ea5627c9a8ff4443cb",
      "created_at" : "2016-08-08T20:36:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-238368565",
      "id" : 238368565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-08T20:36:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238368565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "backport: this is for 0.13.1 I suppose?\r\n",
      "created_at" : "2016-08-10T07:03:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-238782906",
      "id" : 238782906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-10T07:03:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238782906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Yes, no need for this in 0.13.0.\n",
      "created_at" : "2016-08-10T07:08:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-238783829",
      "id" : 238783829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-10T07:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238783829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Thoughts on this comment: https://github.com/bitcoin/bitcoin/pull/8393#discussion_r72060387 ?",
      "created_at" : "2016-08-18T14:59:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-240750418",
      "id" : 240750418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-18T14:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240750418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar Unsure... I think it's easier and more transparent to see failure/relay problems as early as possible, and rather at upgrade time than at lockedin time.\r\n\r\nAlso, relay should work fine (and use compact blocks) as soon as a block from an unupgraded miner enters the network of upgraded peers, right? I assume that things like the relay network will even help propagation across that \"boundary\" to occur.",
      "created_at" : "2016-08-25T10:56:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-242348758",
      "id" : 242348758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-08-25T11:02:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242348758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r76421204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76421204"
         }
      },
      "body" : "Thanks. I find this much more readable and understandable than when developers create a function to do this. e.g. IsWitnessEnabled() !",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-08-26T13:50:20Z",
      "diff_hunk" : "@@ -5087,14 +5091,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             pfrom->PushMessage(NetMsgType::SENDHEADERS);\n         }\n         if (pfrom->nVersion >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version-1 cmpctblocks\n+            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n             bool fAnnounceUsingCMPCTBLOCK = false;\n             uint64_t nCMPCTBLOCKVersion = 1;\n             pfrom->PushMessage(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion);\n+            if (nLocalServices & NODE_WITNESS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r76421204",
      "id" : 76421204,
      "original_commit_id" : "00fabfeca09659f620b773ea5627c9a8ff4443cb",
      "original_position" : 66,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76421204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r76421496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76421496"
         }
      },
      "body" : "It is not the same. This condition is about whether a segwit softfork is defined, not whether it has activated.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-08-26T13:52:09Z",
      "diff_hunk" : "@@ -5087,14 +5091,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             pfrom->PushMessage(NetMsgType::SENDHEADERS);\n         }\n         if (pfrom->nVersion >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version-1 cmpctblocks\n+            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n             bool fAnnounceUsingCMPCTBLOCK = false;\n             uint64_t nCMPCTBLOCKVersion = 1;\n             pfrom->PushMessage(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion);\n+            if (nLocalServices & NODE_WITNESS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r76421496",
      "id" : 76421496,
      "original_commit_id" : "00fabfeca09659f620b773ea5627c9a8ff4443cb",
      "original_position" : 66,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76421496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I proposed more specifics on version negotiation at https://github.com/bitcoin/bips/pull/423#issuecomment-244811877 which I believe might require slight implementation tweaks, though nothing significant.",
      "created_at" : "2016-09-05T21:14:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-244811982",
      "id" : 244811982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-05T21:14:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244811982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Added a commit that introduces the ping-pong based waiting described by the latest https://github.com/bitcoin/bips/pull/423.\r\n\r\ncc @TheBlueMatt ",
      "created_at" : "2016-09-06T11:34:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-244923957",
      "id" : 244923957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-06T11:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244923957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I dont think you need the ping? As indicated in the new BIP text, you can know that the peer will respond to your request for a compact block with /at least/ a compact block of version X after you have seen at least that version in one of their announcements. For us, this is sufficient as we only care about them responding with version 2.",
      "created_at" : "2016-09-06T16:04:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-245000594",
      "id" : 245000594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-06T16:04:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245000594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "> Also, relay should work fine (and use compact blocks) as soon as a block from an unupgraded miner enters the network of upgraded peers, right? I assume that things like the relay network will even help propagation across that \"boundary\" to occur.\r\n\r\n@sipa That sounds right to me.  I was thinking that the first miners to upgrade might be at a disadvantage (because they would stop receiving blocks from old miners as quickly as their peers), but I think you're right that the relay network should mitigate that.\r\n",
      "created_at" : "2016-09-07T13:49:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-245286063",
      "id" : 245286063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-07T13:49:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245286063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@TheBlueMatt I believe you're right, and the ping isn't necessary... but thinking about this makes my head hurt, so I feel better with an actual synchronization in place - even if we only need it later.",
      "created_at" : "2016-09-08T11:10:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-245565796",
      "id" : 245565796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-08T11:10:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245565796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I removed the ping at https://github.com/TheBlueMatt/bitcoin/tree/segwitcb . While the proposed BIP text is pretty dense and confusing, the implementation is pretty straightforward: if they have sent us a sendcmpct version 2, we know they will encode things as version 2, so we gate actually requesting any compact blocks on having seen such a message. We also keep a boolean for which version they requested we send them.",
      "created_at" : "2016-09-09T14:43:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-245934077",
      "id" : 245934077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-09T14:43:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245934077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Simplifed the impementation at the branch linked above and added a comment or two after @sdaftuar and @morcos looked over it a bit.",
      "created_at" : "2016-09-13T19:10:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-246791159",
      "id" : 246791159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-13T19:10:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/246791159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2016-09-13T19:12:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-246791742",
      "id" : 246791742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-13T19:12:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/246791742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Reviewed and included @TheBlueMatt's suggested commits, and rebased. I have not tested this, and I likely won't have time for that this week.",
      "created_at" : "2016-09-13T21:04:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-246823913",
      "id" : 246823913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-13T21:04:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/246823913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Feel free to squash commits before release (you almost certainly want this since the different commits implement a different protocol)",
      "created_at" : "2016-09-13T21:29:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-246830820",
      "id" : 246830820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-13T21:29:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/246830820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt Absolutely, I was planning to, especially as some commits revert changes from earlier ones.",
      "created_at" : "2016-09-13T21:30:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-246831271",
      "id" : 246831271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-13T21:30:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/246831271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79166721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79166721"
         }
      },
      "body" : "This prevents changing whether we announce to this peer.  It should be moved out of this `if()` condition, but I'm not sure yet what the condition should be for updating `fPreferHeaderAndIDs`.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-16T13:17:40Z",
      "diff_hunk" : "@@ -5194,12 +5211,22 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     else if (strCommand == NetMsgType::SENDCMPCT)\n     {\n         bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 1;\n+        uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1) {\n+        if (nCMPCTBLOCKVersion == 1 || ((pfrom->GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n             LOCK(cs_main);\n-            State(pfrom->GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n+            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n+            if (!State(pfrom->GetId())->fProvidesHeaderAndIDs) {\n+                State(pfrom->GetId())->fProvidesHeaderAndIDs = true;\n+                State(pfrom->GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+                State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79166721",
      "id" : 79166721,
      "original_commit_id" : "f12b4f7ae8d2df6939101518a02237bfa5f8647d",
      "original_position" : 103,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79166721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79370568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79370568"
         }
      },
      "body" : "Cherry-picked the commit from https://github.com/TheBlueMatt/bitcoin/commits/segwitcb.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-19T11:24:21Z",
      "diff_hunk" : "@@ -5194,12 +5211,22 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n     else if (strCommand == NetMsgType::SENDCMPCT)\n     {\n         bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 1;\n+        uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1) {\n+        if (nCMPCTBLOCKVersion == 1 || ((pfrom->GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n             LOCK(cs_main);\n-            State(pfrom->GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n+            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n+            if (!State(pfrom->GetId())->fProvidesHeaderAndIDs) {\n+                State(pfrom->GetId())->fProvidesHeaderAndIDs = true;\n+                State(pfrom->GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+                State(pfrom->GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79370568",
      "id" : 79370568,
      "original_commit_id" : "f12b4f7ae8d2df6939101518a02237bfa5f8647d",
      "original_position" : 103,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-19T11:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79370568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79693446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79693446"
         }
      },
      "body" : "This condition is already checked before calling this function. Further it isn't clear how this stops our node from asking non-witness nodes to pre-emptively send cmpctblocks once segwit is activated.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-20T19:33:13Z",
      "diff_hunk" : "@@ -465,16 +478,16 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n }\n \n void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n-    if (pfrom->GetLocalServices() & NODE_WITNESS) {\n-        // Don't ever request compact blocks when segwit is enabled.\n+    if (!nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79693446",
      "id" : 79693446,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 38,
      "path" : "src/main.cpp",
      "position" : 38,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-20T19:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79693446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "What's the correct behavior if an old peer sends us a compact block message that is unrequested?  If I understand right, we're not currently checking to confirm that cmpctblock messages are only coming from peers with whom we've negotiated our preferred compact block version.\r\n\r\nAccepting the header seems safe enough, and it's possible for the block to reconstruct correctly (eg if the block has no witness commitment), so there's perhaps no harm in trying to reconstruct, but it's probably not worth sending a GETBLOCKTXN message for missing transactions if the peer isn't using the preferred protocol version?",
      "created_at" : "2016-09-20T23:45:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-248469308",
      "id" : 248469308,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-20T23:45:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/248469308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79925006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79925006"
         }
      },
      "body" : "A node is never prevented from chosing to send us a message, but later in this function is the only place we send a sendcmpct with announce set to true, so no matter how you call this it should be safe (note that we set fSupportsDesiredCmpctVersion based on NODE_WITNESS, not based on current activation status).\r\n\r\nAs for the duplicate check...whatever, up to the PR owner, I suppose :p.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-21T20:28:29Z",
      "diff_hunk" : "@@ -465,16 +478,16 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n }\n \n void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n-    if (pfrom->GetLocalServices() & NODE_WITNESS) {\n-        // Don't ever request compact blocks when segwit is enabled.\n+    if (!nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79925006",
      "id" : 79925006,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 38,
      "path" : "src/main.cpp",
      "position" : 38,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-21T20:28:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79925006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@sdaftuar I think we should emulate the block logic - if a peer sends us a block that is non-witness it should be the same case as if they send us a compact block message when we have negotiated to receive version 1, as that implies that block is a non-witness compact block.\r\n\r\nAlternatively, we could ban them...I suppose I dont care either way.",
      "created_at" : "2016-09-21T20:29:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-248733361",
      "id" : 248733361,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-21T20:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/248733361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79935956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79935956"
         }
      },
      "body" : "I failed to understand that pfrom->nLocalServices is talking about *your own* services. Nevermind.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-21T21:23:38Z",
      "diff_hunk" : "@@ -465,16 +478,16 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n }\n \n void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n-    if (pfrom->GetLocalServices() & NODE_WITNESS) {\n-        // Don't ever request compact blocks when segwit is enabled.\n+    if (!nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r79935956",
      "id" : 79935956,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 38,
      "path" : "src/main.cpp",
      "position" : 38,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-21T21:23:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/79935956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80040266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80040266"
         }
      },
      "body" : "Maybe add \"local\" in both spots?\r\n\r\n> For local witness nodes  \r\n\r\nSemi ambiguous as-is.",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-22T13:32:09Z",
      "diff_hunk" : "@@ -287,10 +287,21 @@ struct CNodeState {\n     bool fPreferHeaders;\n     //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n     bool fPreferHeaderAndIDs;\n-    //! Whether this peer will send us cmpctblocks if we request them\n+    /**\n+      * Whether this peer will send us cmpctblocks if we request them.\n+      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n+      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n+      */\n     bool fProvidesHeaderAndIDs;\n     //! Whether this peer can give us witnesses\n     bool fHaveWitness;\n+    //! Whether this peer wants witnesses in cmpctblocks/blocktxns\n+    bool fWantsCmpctWitness;\n+    /**\n+     * For witness nodes: whether this peer sends witnesses in cmpctblocks/blocktxns",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80040266",
      "id" : 80040266,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 16,
      "path" : "src/main.cpp",
      "position" : 16,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-22T13:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80040266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "nit aside code review ACK https://github.com/bitcoin/bitcoin/pull/8393/commits/2048b69df36a5d1f49db2de6e099209631c1f490\r\n\r\n",
      "created_at" : "2016-09-22T14:07:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-248913652",
      "id" : 248913652,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-09-22T14:07:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/248913652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80048721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80048721"
         }
      },
      "body" : "local also seems unclear to me, how about \"If we've announced NODE_WITNESS to this peer:\" etc?",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-22T14:10:48Z",
      "diff_hunk" : "@@ -287,10 +287,21 @@ struct CNodeState {\n     bool fPreferHeaders;\n     //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n     bool fPreferHeaderAndIDs;\n-    //! Whether this peer will send us cmpctblocks if we request them\n+    /**\n+      * Whether this peer will send us cmpctblocks if we request them.\n+      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n+      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n+      */\n     bool fProvidesHeaderAndIDs;\n     //! Whether this peer can give us witnesses\n     bool fHaveWitness;\n+    //! Whether this peer wants witnesses in cmpctblocks/blocktxns\n+    bool fWantsCmpctWitness;\n+    /**\n+     * For witness nodes: whether this peer sends witnesses in cmpctblocks/blocktxns",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80048721",
      "id" : 80048721,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 16,
      "path" : "src/main.cpp",
      "position" : 16,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-22T14:10:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80048721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80049285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80049285"
         }
      },
      "body" : "ACK",
      "commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "created_at" : "2016-09-22T14:13:13Z",
      "diff_hunk" : "@@ -287,10 +287,21 @@ struct CNodeState {\n     bool fPreferHeaders;\n     //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n     bool fPreferHeaderAndIDs;\n-    //! Whether this peer will send us cmpctblocks if we request them\n+    /**\n+      * Whether this peer will send us cmpctblocks if we request them.\n+      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n+      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n+      */\n     bool fProvidesHeaderAndIDs;\n     //! Whether this peer can give us witnesses\n     bool fHaveWitness;\n+    //! Whether this peer wants witnesses in cmpctblocks/blocktxns\n+    bool fWantsCmpctWitness;\n+    /**\n+     * For witness nodes: whether this peer sends witnesses in cmpctblocks/blocktxns",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r80049285",
      "id" : 80049285,
      "original_commit_id" : "2048b69df36a5d1f49db2de6e099209631c1f490",
      "original_position" : 16,
      "path" : "src/main.cpp",
      "position" : 16,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-09-22T14:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/80049285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
