[
   {
      "body" : "Actually I'm copying/re-writing things from that branch to https://github.com/jtimon/bitcoin/tree/0.12.99-consensus (which contains #8328 #8329 and #8337 ).\r\nI really think we should try to work on a common base...",
      "created_at" : "2016-07-14T11:26:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232638729",
      "id" : 232638729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T11:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232638729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789246"
         }
      },
      "body" : "Do you plan to move GetContextInfo() to libconsensus ? If not, please don't move consensus critical code out of consensus critical functions.",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:27:43Z",
      "diff_hunk" : "@@ -2497,14 +2497,20 @@ bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pin\n }\n \n \n-CConsensusContextInfo GetContextInfo(const CBlockIndex* pindex)\n+CConsensusContextInfo GetContextInfo(const CBlockIndex* pindex, const Consensus::Params consensusParams)\n {\n     assert(pindex);\n     CConsensusContextInfo contextInfo;\n     contextInfo.height = pindex->nHeight;\n     contextInfo.medianTimePast = pindex->GetMedianTimePast();\n     contextInfo.now = GetAdjustedTime();\n     contextInfo.bestBlock = pindex->GetBlockHeader();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789246",
      "id" : 70789246,
      "original_commit_id" : "49c22c5dded7ce673131120c8ff597c265819c19",
      "original_position" : 21,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789717"
         }
      },
      "body" : "There's no logging needed in libconsensus, CValidationState should be enough, see https://github.com/bitcoin/bitcoin/pull/7287/files",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:32:07Z",
      "diff_hunk" : "@@ -3583,11 +3599,11 @@ bool ContextualCheckBlock(const CBlock& block, CValidationState& state, const CC\n             // already does not permit it, it is impossible to trigger in the\n             // witness tree.\n             if (block.vtx[0].wit.vtxinwit.size() != 1 || block.vtx[0].wit.vtxinwit[0].scriptWitness.stack.size() != 1 || block.vtx[0].wit.vtxinwit[0].scriptWitness.stack[0].size() != 32) {\n-                return state.DoS(100, error(\"%s : invalid witness nonce size\", __func__), REJECT_INVALID, \"bad-witness-nonce-size\", true);\n+                return state.DoS(100, logger.error(\"%s : invalid witness nonce size\", __func__), REJECT_INVALID, \"bad-witness-nonce-size\", true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789717",
      "id" : 70789717,
      "original_commit_id" : "36eb1a0e77e16d14d40eb405fa37f2b112a11b30",
      "original_position" : 48,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789905"
         }
      },
      "body" : "If we're not going to try to move the code to the same files, can you please at least use the consensus directory instead of the script one?",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:33:59Z",
      "diff_hunk" : "@@ -4,6 +4,106 @@\n \n #include \"blockvalidator.h\"\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789905",
      "id" : 70789905,
      "original_commit_id" : "71b29a4de8e098f2b4ca5ec7741b7b4f13d30805",
      "original_position" : 3,
      "path" : "src/script/blockvalidator.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70789905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790303"
         }
      },
      "body" : "pow is already a file containing only consensus code and ready for becoming part of the consensus module/package (see makefile) except for its CBlockIndex dependency. Just call CheckProofOfWork from the other consensus code directly, it's ok to include pow.h ",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:37:31Z",
      "diff_hunk" : "@@ -73,22 +73,3 @@ unsigned int CalculateNextWorkRequired(const CBlockIndex* pindexLast, int64_t nF\n \n     return bnNew.GetCompact();\n }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790303",
      "id" : 70790303,
      "original_commit_id" : "5eef3d92beecb72cef6dd6dd4af55ea15dc45b94",
      "original_position" : 3,
      "path" : "src/pow.cpp",
      "position" : 3,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790687"
         }
      },
      "body" : "As discussed the consensusFlags struct seems to just cause unnecessary disruption with no apparent benefit.",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:39:17Z",
      "diff_hunk" : "@@ -2367,30 +2369,29 @@ bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pin\n     int64_t nBIP16SwitchTime = 1333238400;\n     bool fStrictPayToScriptHash = (pindex->GetBlockTime() >= nBIP16SwitchTime);\n \n-    unsigned int flags = fStrictPayToScriptHash ? SCRIPT_VERIFY_P2SH : SCRIPT_VERIFY_NONE;\n+    consensusFlags.scriptFlags = fStrictPayToScriptHash ? SCRIPT_VERIFY_P2SH : SCRIPT_VERIFY_NONE;\n \n     // Start enforcing the DERSIG (BIP66) rules, for block.nVersion=3 blocks,\n     // when 75% of the network has upgraded:\n     if (block.nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_DERSIG;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_DERSIG;\n     }\n \n     // Start enforcing CHECKLOCKTIMEVERIFY, (BIP65) for block.nVersion=4\n     // blocks, when 75% of the network has upgraded:\n     if (block.nVersion >= 4 && IsSuperMajority(4, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;\n     }\n \n     // Start enforcing BIP68 (sequence locks) and BIP112 (CHECKSEQUENCEVERIFY) using versionbits logic.\n-    int nLockTimeFlags = 0;\n     if (VersionBitsState(pindex->pprev, chainparams.GetConsensus(), Consensus::DEPLOYMENT_CSV, versionbitscache) == THRESHOLD_ACTIVE) {\n-        flags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;\n-        nLockTimeFlags |= LOCKTIME_VERIFY_SEQUENCE;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;\n+        consensusFlags.locktimeFlags |= LOCKTIME_VERIFY_SEQUENCE;\n     }\n \n     // Start enforcing WITNESS rules using versionbits logic.\n     if (IsWitnessEnabled(pindex->pprev, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_WITNESS;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790687",
      "id" : 70790687,
      "original_commit_id" : "c5b19d92be869a217a4c8a971c959262aa906d0a",
      "original_position" : 79,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790789"
         }
      },
      "body" : "aren't you changing functionality here?",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:40:30Z",
      "diff_hunk" : "@@ -2528,13 +2528,13 @@ CConsensusFlags GetConsensusFlags(const CBlock& block, const CBlockIndex *pindex\n \n     // Start enforcing the DERSIG (BIP66) rules, for block.nVersion=3 blocks,\n     // when 75% of the network has upgraded:\n-    if (block.nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n+    if (pindex->nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790789",
      "id" : 70790789,
      "original_commit_id" : "95b710aabc271222b669da505fc50abe67413df2",
      "original_position" : 32,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70790789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Thanks @jtimon, it is actually moving very fast now, I'll try to consolidate with the same base a you when the dust in my code will settle. For now I'll fix the pow you just told. How did you do for the logging ? with CValidationState I see you just remove the \"error\" methods ? (I really don't like the \"Logger\" abstraction, but I don't want to remove features either :()\r\n\r\nAlso I broke the consensus somewhere :p",
      "created_at" : "2016-07-14T11:44:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232642369",
      "id" : 232642369,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T11:47:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232642369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791378"
         }
      },
      "body" : "I noticed that the consensus code only depends on the current majorityVersion. So I'm calculating the majorityVersion outside consensus, and I make the check inside. I've not found a better solution for now.",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:45:48Z",
      "diff_hunk" : "@@ -2497,14 +2497,20 @@ bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pin\n }\n \n \n-CConsensusContextInfo GetContextInfo(const CBlockIndex* pindex)\n+CConsensusContextInfo GetContextInfo(const CBlockIndex* pindex, const Consensus::Params consensusParams)\n {\n     assert(pindex);\n     CConsensusContextInfo contextInfo;\n     contextInfo.height = pindex->nHeight;\n     contextInfo.medianTimePast = pindex->GetMedianTimePast();\n     contextInfo.now = GetAdjustedTime();\n     contextInfo.bestBlock = pindex->GetBlockHeader();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791378",
      "id" : 70791378,
      "original_commit_id" : "49c22c5dded7ce673131120c8ff597c265819c19",
      "original_position" : 21,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791621"
         }
      },
      "body" : "no, where it is used, pindex points to the block. (I ran the tests after this change, worked fine)",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:48:33Z",
      "diff_hunk" : "@@ -2528,13 +2528,13 @@ CConsensusFlags GetConsensusFlags(const CBlock& block, const CBlockIndex *pindex\n \n     // Start enforcing the DERSIG (BIP66) rules, for block.nVersion=3 blocks,\n     // when 75% of the network has upgraded:\n-    if (block.nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n+    if (pindex->nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791621",
      "id" : 70791621,
      "original_commit_id" : "95b710aabc271222b669da505fc50abe67413df2",
      "original_position" : 32,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791693"
         }
      },
      "body" : "Agree, I'll fix that at the end.",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T11:49:14Z",
      "diff_hunk" : "@@ -2367,30 +2369,29 @@ bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pin\n     int64_t nBIP16SwitchTime = 1333238400;\n     bool fStrictPayToScriptHash = (pindex->GetBlockTime() >= nBIP16SwitchTime);\n \n-    unsigned int flags = fStrictPayToScriptHash ? SCRIPT_VERIFY_P2SH : SCRIPT_VERIFY_NONE;\n+    consensusFlags.scriptFlags = fStrictPayToScriptHash ? SCRIPT_VERIFY_P2SH : SCRIPT_VERIFY_NONE;\n \n     // Start enforcing the DERSIG (BIP66) rules, for block.nVersion=3 blocks,\n     // when 75% of the network has upgraded:\n     if (block.nVersion >= 3 && IsSuperMajority(3, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_DERSIG;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_DERSIG;\n     }\n \n     // Start enforcing CHECKLOCKTIMEVERIFY, (BIP65) for block.nVersion=4\n     // blocks, when 75% of the network has upgraded:\n     if (block.nVersion >= 4 && IsSuperMajority(4, pindex->pprev, chainparams.GetConsensus().nMajorityEnforceBlockUpgrade, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;\n     }\n \n     // Start enforcing BIP68 (sequence locks) and BIP112 (CHECKSEQUENCEVERIFY) using versionbits logic.\n-    int nLockTimeFlags = 0;\n     if (VersionBitsState(pindex->pprev, chainparams.GetConsensus(), Consensus::DEPLOYMENT_CSV, versionbitscache) == THRESHOLD_ACTIVE) {\n-        flags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;\n-        nLockTimeFlags |= LOCKTIME_VERIFY_SEQUENCE;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;\n+        consensusFlags.locktimeFlags |= LOCKTIME_VERIFY_SEQUENCE;\n     }\n \n     // Start enforcing WITNESS rules using versionbits logic.\n     if (IsWitnessEnabled(pindex->pprev, chainparams.GetConsensus())) {\n-        flags |= SCRIPT_VERIFY_WITNESS;\n+        consensusFlags.scriptFlags |= SCRIPT_VERIFY_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791693",
      "id" : 70791693,
      "original_commit_id" : "c5b19d92be869a217a4c8a971c959262aa906d0a",
      "original_position" : 79,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70791693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "body" : "> How did you do for the logging ? \r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789717\r\n\r\n> with CValidationState I see you just remove the \"error\" methods ?\r\n\r\nLook again to the PR I link you, the messages aren't lost.\r\n\r\n> Also I broke the consensus somewhere :p\r\n\r\nMaybe in https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790789 ?",
      "created_at" : "2016-07-14T11:50:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232643639",
      "id" : 232643639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T11:50:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232643639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Awesome I'll cherry pick your commit and remove my logger.\r\n\r\nEDIT: ho I need to do it for the new methods :(",
      "created_at" : "2016-07-14T11:56:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232644864",
      "id" : 232644864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T11:58:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232644864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "body" : "the consensus break in the time-too-old rule. (block too early)\r\n\r\nEDIT: Found the culprit, in TestValidityBlock I was not using prevIndex for calculating the context.",
      "created_at" : "2016-07-14T11:57:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232644956",
      "id" : 232644956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T12:03:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232644956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "body" : "@jtimon if I understand well https://github.com/bitcoin/bitcoin/pull/7287/files actually I only need to remove error and pass \"false\" to DoS/Invalid ValidationState methods right? Since you are already printing out stuff in the caller ?",
      "created_at" : "2016-07-14T12:14:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232648713",
      "id" : 232648713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8339",
      "updated_at" : "2016-07-14T12:14:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232648713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70815431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70815431"
         }
      },
      "body" : "@jtimon actually, it is not ok, pow is not part of consensus (some methods are linked to CBlockIndex)",
      "commit_id" : "1751baf51679fecc98cc95e71cf4ca24afe818bc",
      "created_at" : "2016-07-14T14:29:21Z",
      "diff_hunk" : "@@ -73,22 +73,3 @@ unsigned int CalculateNextWorkRequired(const CBlockIndex* pindexLast, int64_t nF\n \n     return bnNew.GetCompact();\n }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70815431",
      "id" : 70815431,
      "original_commit_id" : "5eef3d92beecb72cef6dd6dd4af55ea15dc45b94",
      "original_position" : 3,
      "path" : "src/pow.cpp",
      "position" : 3,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8339",
      "updated_at" : "2016-07-14T14:29:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/70815431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   }
]
