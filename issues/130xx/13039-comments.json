[
   {
      "author_association" : "MEMBER",
      "body" : "Strong concept ACK! Nice!",
      "created_at" : "2018-04-20T12:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383082826",
      "id" : 383082826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
      "updated_at" : "2018-04-20T12:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383082826",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183072136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183072136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This value should probably be checked as well: https://msdn.microsoft.com/en-us/library/windows/desktop/aa364439(v=vs.85).aspx",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:40:23Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183072136",
      "id" : 183072136,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 14,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183072136",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183074012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183074012"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can't come up with a specific reason other than \"gut feeling\", but potentially logging to the same disk that just failed to sync feels icky.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:46:48Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync\n+        LogPrintf(\"%s: fdatasync failed: %d\\n\", __func__, errno);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183074012",
      "id" : 183074012,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 19,
      "path" : "src/util.cpp",
      "position" : 23,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183074012",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075035"
         }
      },
      "author_association" : "MEMBER",
      "body" : "|=",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:50:02Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075035",
      "id" : 183075035,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 20,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075035",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't hurt to check the return value here too, but I guess it's not crucial since any error would just propagate to the sync.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:51:40Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075554",
      "id" : 183075554,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075554",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this attempt to close before returning? I assume we're in bad shape already if we get here, but I'm afraid that some one-off sync failure could lead to multiple copies open and weird fd behavior.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:58:50Z",
      "diff_hunk" : "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078031",
      "id" : 183078031,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 7,
      "path" : "src/addrdb.cpp",
      "position" : 7,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078031",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See fclose comment above.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T14:59:47Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078393",
      "id" : 183078393,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078393",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~aaand here~~ :)",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:00:14Z",
      "diff_hunk" : "@@ -4760,7 +4765,8 @@ bool DumpMempool(void)\n         }\n \n         file << mapDeltas;\n-        FileCommit(file.Get());\n+        if (!FileCommit(file.Get()))\n+            throw std::runtime_error(\"FileCommit failed\");\n         file.fclose();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078606",
      "id" : 183078606,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 114004572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183080978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183080978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Whoops, and the logic for these is backwards. They should be:\r\n```c++\r\n flush_failed |= !FileCommit(fileOld);\r\n```",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:07:47Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183080978",
      "id" : 183080978,
      "in_reply_to_id" : 183075035,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 20,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114015709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183080978",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183088864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183088864"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Interestingly, leveldb does not compare the result to EINVAL. Which makes sense for a database, as if writes can't be synchronized at any point, the db can't really ever be trusted.\r\n\r\nI think we might want to operate the same way. If a FlushBlockFile() fails due to a disk/filesystem that can't sync, do we really want to continue with updating the index db?",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:32:51Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183088864",
      "id" : 183088864,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114025306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183088864",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089712"
         }
      },
      "author_association" : "OWNER",
      "body" : "That's not *necessarily* the case, e.g. they might be logging to stdout, or piping the log to something else over the network. Logging the error is extremely important for troubleshooting in any case, even if it might fail.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:35:25Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync\n+        LogPrintf(\"%s: fdatasync failed: %d\\n\", __func__, errno);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089712",
      "id" : 183089712,
      "in_reply_to_id" : 183074012,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 19,
      "path" : "src/util.cpp",
      "position" : 23,
      "pull_request_review_id" : 114026330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089712",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089814"
         }
      },
      "author_association" : "OWNER",
      "body" : "Ah yes this should be flush_ok",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:35:43Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089814",
      "id" : 183089814,
      "in_reply_to_id" : 183075035,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 20,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114026453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089814",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183090593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183090593"
         }
      },
      "author_association" : "OWNER",
      "body" : "leveldb does compare against EINVAL, we had this issue a long time ago where leveldb didn't work with certain filesystems (e.g. NTFS mounted from Linux). This was eventually fixed by adding the compare against EINVAL.\r\nWe certainly don't want to repeat this issue with the block files!\r\n```\r\n$ git grep fsync\r\nutil/env_posix.cc:        if (fsync(fd) < 0 && errno != EINVAL) {\r\n``",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:38:10Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183090593",
      "id" : 183090593,
      "in_reply_to_id" : 183088864,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114027423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183090593",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183091501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183091501"
         }
      },
      "author_association" : "OWNER",
      "body" : "Doesn't CAutofile destructor take care of this?",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:41:21Z",
      "diff_hunk" : "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183091501",
      "id" : 183091501,
      "in_reply_to_id" : 183078031,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 7,
      "path" : "src/addrdb.cpp",
      "position" : 7,
      "pull_request_review_id" : 114028549,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183091501",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183092652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183092652"
         }
      },
      "author_association" : "OWNER",
      "body" : "Will do",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:45:05Z",
      "diff_hunk" : "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183092652",
      "id" : 183092652,
      "in_reply_to_id" : 183075554,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 114029930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183092652",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093281"
         }
      },
      "author_association" : "OWNER",
      "body" : "Ok",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:47:04Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093281",
      "id" : 183093281,
      "in_reply_to_id" : 183072136,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 14,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114030650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093281",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm. leveldb checks the fsync() in SyncDirIfManifest() against EINVAL, but not the fdatasync() in Sync().\r\n\r\nI have no knowledge of the past issue though, so I'll defer to you on that.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:48:02Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093591",
      "id" : 183093591,
      "in_reply_to_id" : 183088864,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114031021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093591",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yep, nevermind missed that this was a CAutofile.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:50:51Z",
      "diff_hunk" : "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094458",
      "id" : 183094458,
      "in_reply_to_id" : 183078031,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 7,
      "path" : "src/addrdb.cpp",
      "position" : 7,
      "pull_request_review_id" : 114032034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T15:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094458",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094671"
         }
      },
      "author_association" : "OWNER",
      "body" : "> as if writes can't be synchronized at any point, the db can't really ever be trusted.\r\n\r\nI don't agree. When shutting down bitcoind and the OS cleanly, `f(data)sync` is a no-op. It's only an issue if there are sudden crashes or power outages. In which case the user will just have to accept potential corruption on crashes when choosing to use a filesystem that doesn't support these things. Certainly for the block files, which are huge and more commonly hosted externally.\r\n\r\nMy intent here is not to break any current usecases.",
      "commit_id" : "36424a4f09de38e1ab54381aa7844781688f5c75",
      "created_at" : "2018-04-20T15:51:37Z",
      "diff_hunk" : "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094671",
      "id" : 183094671,
      "in_reply_to_id" : 183088864,
      "original_commit_id" : "5657cc51624a61d70a402ef353632e3034609432",
      "original_position" : 18,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 114032283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
      "updated_at" : "2018-04-20T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094671",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 36424a4f09de38e1ab54381aa7844781688f5c75 (squash recommended).",
      "created_at" : "2018-04-23T11:52:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383548455",
      "id" : 383548455,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
      "updated_at" : "2018-04-23T11:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383548455",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "squashed 36424a4   cf0277928fa8d955d75f661021845789194dfff7",
      "created_at" : "2018-04-23T12:25:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383556753",
      "id" : 383556753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
      "updated_at" : "2018-04-23T12:26:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383556753",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
