{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "I'm re-opening #11857 as a new pull request because the last one stopped loading for people\r\n\r\n-------------------------------\r\n\r\nThis refactors the tx index code to be in it's own class and get built concurrently with validation code. The main benefit is decoupling and moving the txindex into a separate DB. The primary motivation is to lay the groundwork for other indexers that might be desired (such as the [compact filters](https://github.com/bitcoin/bips/pull/636)). The basic idea is that the TxIndex spins up its own thread, which first syncs the txindex to the current block index, then once in sync the BlockConnected ValidationInterface hook writes new blocks.\r\n\r\n### DB changes\r\n\r\nAt the suggestion of some other developers, the txindex has been split out into a separate database. A data migration runs at startup on any nodes with a legacy txindex. Currently the migration blocks node initialization until complete.\r\n\r\n### Open questions\r\n\r\n- Should the migration of txindex data from the old DB to the new DB block in init or should it happen in a background thread? The downside to backgrounding it is that `getrawtransaction` would return an error message saying the txindex is syncing while the migration is running.\r\n\r\n### Impact\r\n\r\nIn a sample size n=1 test where I synced nodes from scratch, the average time [Index writing](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L1903) was 3.36ms in master and 1.72ms in this branch. The average time between `UpdateTip` log lines for sequential blocks between 400,000 and IBD end on mainnet was 0.297204s in master and 0.286134s in this branch. Most likely this is just variance in IBD times, but I can try with some more trials if people want.",
   "closed_at" : "2018-04-26T01:48:47Z",
   "closed_by" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13033/comments",
   "created_at" : "2018-04-20T00:11:26Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13033/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/13033",
   "id" : 316082387,
   "labels" : [
      {
         "color" : "fbca04",
         "default" : false,
         "id" : 97470796,
         "name" : "UTXO Db and Indexes",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13033/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 13033,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/13033.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13033",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/13033.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13033"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Build txindex in parallel with validation",
   "updated_at" : "2018-04-26T01:48:48Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13033",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
      "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jimpo/followers",
      "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jimpo",
      "id" : 881253,
      "login" : "jimpo",
      "organizations_url" : "https://api.github.com/users/jimpo/orgs",
      "received_events_url" : "https://api.github.com/users/jimpo/received_events",
      "repos_url" : "https://api.github.com/users/jimpo/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jimpo"
   }
}
