[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28538).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/28538#pullrequestreview-1671206009), [sr-gi](https://github.com/bitcoin/bitcoin/pull/28538#pullrequestreview-1669020341) |\n| Stale ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1846900239), [amitiuttarwar](https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1856825484) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24748](https://github.com/bitcoin/bitcoin/pull/24748) (test/BIP324: functional tests for v2 P2P encryption by stratospher)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-09-26T19:13:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1736143850",
      "id" : 1736143850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585ne3Pq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736143850/reactions"
      },
      "updated_at" : "2024-01-05T20:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736143850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1338163650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338163650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`inbound` -> `outbound`",
      "commit_id" : "32f044df80c69dda0313f0432c745effcc3f0a30",
      "created_at" : "2023-09-27T07:28:15Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full inbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1338163650",
      "id" : 1338163650,
      "line" : 3334,
      "node_id" : "PRRC_kwDOABII585PwsHC",
      "original_commit_id" : "6fa1a219db252106247ce317cbda63bf68ff54de",
      "original_line" : 3334,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1645785051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338163650/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T07:33:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338163650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1338613561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338613561"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "oops - fixed!",
      "commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "created_at" : "2023-09-27T13:29:36Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full inbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1338613561",
      "id" : 1338613561,
      "in_reply_to_id" : 1338163650,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyZ85",
      "original_commit_id" : "6fa1a219db252106247ce317cbda63bf68ff54de",
      "original_line" : 3334,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1646540255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338613561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T13:29:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338613561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1340225724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340225724"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 82e7a7dc3b4447e4affe3a98e1af8b478aa4dc04: Perhaps we could mention on this comment that it doesn't apply in case we're running in `-blocksonly` mode.\r\n```suggestion\r\n        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode) unless we are in -blocksonly mode.\r\n```",
      "commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "created_at" : "2023-09-28T14:15:53Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1340225724",
      "id" : 1340225724,
      "line" : 3334,
      "node_id" : "PRRC_kwDOABII585P4ji8",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3334,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1648983811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340225724/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T14:15:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340225724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1340936539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340936539"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Rather than doing this immediaely upon connection (ie, after receiving their VERSION message), would it be better to do it only when we have all our outbound slots filled up (ie, as part of `EvictExtraOutboundPeers`) ?\r\n\r\nAlso, doing the check repeatedy would mean that we could keep blocks-only peers while we're doing IBD, only dropping them when we exit IBD and start caring about tx relay.",
      "commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "created_at" : "2023-09-29T06:13:17Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1340936539",
      "id" : 1340936539,
      "line" : 3337,
      "node_id" : "PRRC_kwDOABII585P7RFb",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1650112112,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340936539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T06:13:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340936539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1341787514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341787514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rather than doing this immediaely upon connection (ie, after receiving their VERSION message), would it be better to do it only when we have all our outbound slots filled up (ie, as part of EvictExtraOutboundPeers) ?\r\n\r\nI like that idea. If for some strange reason we wouldn't be able to find any other peers we wouldn't end up connecting the only ones we have. But I think we would want to start evicting if we are at the limit (so in `CheckForStaleTipAndEvictPeers`), not just if we have exceeded it (`EvictExtraOutboundPeers`).\r\n\r\n> Also, doing the check repeatedy would mean that we could keep blocks-only peers while we're doing IBD, only dropping them when we exit IBD and start caring about tx relay.\r\n\r\nDo we really want that? The main reason to run in `-blocksonly` mode is to save traffic. I would assume that most nodes wouldn't enable listening anyway, but those that do (maybe not even on purpose), maybe it would be nicer not to use them for IBD?",
      "commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "created_at" : "2023-09-29T20:59:17Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1341787514",
      "id" : 1341787514,
      "in_reply_to_id" : 1340936539,
      "line" : 3337,
      "node_id" : "PRRC_kwDOABII585P-g16",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1651470496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341787514/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T20:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341787514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1342512709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342512709"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">start evicting if we are at the limit (so in CheckForStaleTipAndEvictPeers), not just if we have exceeded it (EvictExtraOutboundPeers).\r\n\r\nI agree.\r\n\r\n>Do we really want that? The main reason to run in -blocksonly mode is to save traffic. I would assume that most nodes wouldn't enable listening anyway, but those that do (maybe not even on purpose), maybe it would be nicer not to use them for IBD?\r\n\r\nNot sure about this. You seem to care specifically about those users which do `-blocksonly` and forget to disable inbounds. Perhaps this is better communicated through documentation and logging. I think we should leave them a chance to strengthen the block relaying network.",
      "commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "created_at" : "2023-10-02T10:17:29Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1342512709",
      "id" : 1342512709,
      "in_reply_to_id" : 1340936539,
      "line" : 3337,
      "node_id" : "PRRC_kwDOABII585QBR5F",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1652470431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342512709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T10:17:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342512709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1343278866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343278866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1 to having the logic in eviction instead of connection\r\n\r\nRE IBD: \r\nit seems odd / logically inconsistent to run a node in `-blocksonly` and enable inbounds, so I don't think it's worth overly optimizing for the use case. If we want to improve the user experience, we could have a soft param interaction between the two (independent of these changes)",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-03T00:24:47Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1343278866",
      "id" : 1343278866,
      "in_reply_to_id" : 1340936539,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QEM8S",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1653859586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343278866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T00:25:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343278866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've now changed the approach to @ajtowns suggestion to disconnecting during eviction.",
      "created_at" : "2023-10-04T22:07:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1747715639",
      "id" : 1747715639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585oLAY3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747715639/reactions"
      },
      "updated_at" : "2023-10-04T22:07:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747715639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346531209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531209"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> it seems odd / logically inconsistent to run a node in -blocksonly and enable inbounds, so I don't think it's worth overly optimizing for the use case\r\n\r\nMaybe there is a use case for wanting to help the network by providing inbound capacity, but still minimize traffic at the same time? Although then it often doesn't make a lot of sense to run a non-pruned node - unless you also need the entire chain for selfish purposes (e.g. txindex).\r\nIn any case, I have included the suggestion to not evict while in ibd in the latest push!",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-04T22:13:34Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346531209",
      "id" : 1346531209,
      "in_reply_to_id" : 1340936539,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QQm-J",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1658576755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531209/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-04T22:13:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346531816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531816"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have included this info in the doc for the new spot!",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-04T22:14:27Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346531816",
      "id" : 1346531816,
      "in_reply_to_id" : 1340225724,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QQnHo",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3334,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1658577461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531816/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-04T22:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346531816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346632185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346632185"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do we really want that? The main reason to run in `-blocksonly` mode is to save traffic.\r\n\r\nIn that case you'd be better off doing `-maxuploadtarget` either instead of or in addition to `-blocksonly`?\r\n\r\n> it seems odd / logically inconsistent to run a node in `-blocksonly` and enable inbounds,\r\n\r\nI think it would make sense to expect that if 100% (or 99.9%) of nodes were `-blocksonly` that they would still manage to propagate blocks sensibly, bring up new nodes efficiently, etc. In theory with this PR, we would also be able to propagate txs successfully in the 99.9% `-blocksonly` case.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-05T00:38:09Z",
      "diff_hunk" : "@@ -3330,6 +3330,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         if (!vRecv.empty())\n             vRecv >> fRelay;\n+\n+        // Don't waste any of our full outbound slots on peers that don't want tx relay (because they might be in -blocksonly mode)\n+        if (!fRelay && !m_opts.ignore_incoming_txs && pfrom.IsFullOutboundConn())\n+        {\n+            LogPrint(BCLog::NET, \"peer=%d (full-relay outbound) does not participate in transaction relay; disconnecting\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1346632185",
      "id" : 1346632185,
      "in_reply_to_id" : 1340936539,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QQ_n5",
      "original_commit_id" : "0034a8fa9beae1ffc2a1fbe0c4305d4f933324ac",
      "original_line" : 3337,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1658702432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346632185/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-05T00:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346632185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353428699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353428699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `Dict::pop` can be provided a default. This could be simplified to:\r\n\r\n```suggestion\r\n        txrelay = kwargs.pop('txrelay', True)\r\n```",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-10T21:09:10Z",
      "diff_hunk" : "@@ -368,13 +371,16 @@ def peer_connect(self, *args, services=P2P_SERVICES, send_version=True, **kwargs\n         create_conn = super().peer_connect(*args, **kwargs)\n \n         if send_version:\n-            self.peer_connect_send_version(services)\n+            self.peer_connect_send_version(services, txrelay=True)\n \n         return create_conn\n \n     def peer_accept_connection(self, *args, services=P2P_SERVICES, **kwargs):\n+        txrelay = True\n+        if 'txrelay' in kwargs:\n+            txrelay = kwargs.pop('txrelay')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353428699",
      "id" : 1353428699,
      "line" : 381,
      "node_id" : "PRRC_kwDOABII585Qq67b",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 381,
      "original_position" : 30,
      "original_start_line" : 379,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 30,
      "pull_request_review_id" : 1669020341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353428699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 379,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-11T15:11:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353428699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353431707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353431707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: This can be simplified using the ternary operator\r\n\r\n```suggestion\r\n        vt.relay = P2P_VERSION_RELAY if txrelay else 0\r\n```\r\n\r\nBut also, it may be just simpler to give `txrelay` a default value in the function signature:\r\n\r\n```\r\npeer_connect_send_version(self, services, txrelay=0)\r\n```",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-10T21:13:16Z",
      "diff_hunk" : "@@ -351,12 +351,15 @@ def __init__(self, support_addrv2=False, wtxidrelay=True):\n         # If the peer supports wtxid-relay\n         self.wtxidrelay = wtxidrelay\n \n-    def peer_connect_send_version(self, services):\n+    def peer_connect_send_version(self, services, txrelay):\n         # Send a version msg\n         vt = msg_version()\n         vt.nVersion = P2P_VERSION\n         vt.strSubVer = P2P_SUBVERSION\n-        vt.relay = P2P_VERSION_RELAY\n+        if txrelay:\n+            vt.relay = P2P_VERSION_RELAY\n+        else:\n+            vt.relay = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353431707",
      "id" : 1353431707,
      "line" : 362,
      "node_id" : "PRRC_kwDOABII585Qq7qb",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 362,
      "original_position" : 14,
      "original_start_line" : 359,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 14,
      "pull_request_review_id" : 1669020341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353431707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 359,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-11T15:10:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353431707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353453538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353453538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should make at least two connections here, otherwise we are not making sure that we are actually not disconnecting **all our outbound** instead of just evicting enough to go bellow the limit",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-10T21:33:17Z",
      "diff_hunk" : "@@ -78,6 +78,33 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections=1\n+        self.restart_node(0, [\"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353453538",
      "id" : 1353453538,
      "line" : 90,
      "node_id" : "PRRC_kwDOABII585QrA_i",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 90,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 13,
      "pull_request_review_id" : 1669020341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353453538/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T15:12:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353453538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353461371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353461371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we need to make this change though? It doesn't look like negative numbers are being used anyway, only whether we are above, or at, zero.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-10T21:39:59Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1353461371",
      "id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585QrC57",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1669020341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353461371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T15:10:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353461371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1354990742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354990742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit f3b74d43823a038fb0aa4e0bcb7d4f99a7f90688:\r\n\r\nThe 2 logical paths depending on the value of `extra_outbound_count` could be more clear if this were an `if/else if` block.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-11T13:12:19Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1354990742",
      "id" : 1354990742,
      "line" : 5251,
      "node_id" : "PRRC_kwDOABII585Qw4SW",
      "original_commit_id" : "f3b74d43823a038fb0aa4e0bcb7d4f99a7f90688",
      "original_line" : 5251,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 1671206009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354990742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T13:17:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354990742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1354994889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354994889"
         }
      },
      "author_association" : "MEMBER",
      "body" : "831ed4960bfb1eafb763cb2a52201a97a17f8168: seems like this should be in the `peer_connect_send_version` function docstring?",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-11T13:15:13Z",
      "diff_hunk" : "@@ -673,6 +673,7 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n     def add_outbound_p2p_connection(self, p2p_conn, *, wait_for_verack=True, p2p_idx, connection_type=\"outbound-full-relay\", **kwargs):\n         \"\"\"Add an outbound p2p connection from node. Must be an\n         \"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\" or \"feeler\" connection.\n+        The txrelay arg determines whether our peer will signal support for txrelay in their version message.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1354994889",
      "id" : 1354994889,
      "line" : 676,
      "node_id" : "PRRC_kwDOABII585Qw5TJ",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 676,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 4,
      "pull_request_review_id" : 1671206009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354994889/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T13:17:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354994889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1355464069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355464069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What if there is, at least, a node already flagged to be disconnected? Shouldn't we skip this altogether? Otherwise, it could be the case that we end up evicting more nodes that we really need to",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-11T17:44:48Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1355464069",
      "id" : 1355464069,
      "line" : 5263,
      "node_id" : "PRRC_kwDOABII585Qyr2F",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5263,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 1672063437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355464069/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5258,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-11T17:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355464069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1355494051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355494051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nvm, `ForEachNode` already checks `NodeFullyConnected`",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-11T17:57:59Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1355494051",
      "id" : 1355494051,
      "in_reply_to_id" : 1355464069,
      "line" : 5263,
      "node_id" : "PRRC_kwDOABII585QyzKj",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5263,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 1672122122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355494051/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5258,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-11T17:57:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355494051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1356102682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356102682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Negative numbers mean neither of those code blocks are executed; if it was `max{...,0}` then the \"at zero\" code block would be executed when it shouldn't be.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-12T06:05:03Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1356102682",
      "id" : 1356102682,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585Q1Hwa",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1673093885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356102682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T06:05:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356102682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1356897453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356897453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, because we want to execute code for the case in which we are exactly at the limit, and being under the limit will be mapped to the same value. My bad.\r\n\r\nI have to say though that, after this change, the function name becomes a bit confusing.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-12T14:15:20Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1356897453",
      "id" : 1356897453,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585Q4Jyt",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1674295407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356897453/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T14:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356897453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1357316623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357316623"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I have to say though that, after this change, the function name becomes a bit confusing.\r\n\r\nI had a quick look at changing it to `return full_outbound_peers` and doing the comparison with `m_max_outbound_full_relay` in the caller. Would require exposing the latter value to net_processing, but otherwise seems like it works. Wasn't convinced it was enough of an improvement to bother though.",
      "commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "created_at" : "2023-10-12T19:40:37Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1357316623",
      "id" : 1357316623,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585Q5wIP",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1675033877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357316623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T19:40:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357316623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315038"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "changed to `else if`",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:11:14Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315038",
      "id" : 1361315038,
      "in_reply_to_id" : 1354990742,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585RJATe",
      "original_commit_id" : "f3b74d43823a038fb0aa4e0bcb7d4f99a7f90688",
      "original_line" : 5251,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1681038566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315038/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:11:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Removed the doc, since it's hidden in the `kwargs` anyway (It wasn't when I added it in an earlier revision). Within `peer_connect_send_version` it's kind of self-explanatory, I had added it here to avoid confusion to which side of the connection `txrelay` refers to.\r\n",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:12:06Z",
      "diff_hunk" : "@@ -673,6 +673,7 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n     def add_outbound_p2p_connection(self, p2p_conn, *, wait_for_verack=True, p2p_idx, connection_type=\"outbound-full-relay\", **kwargs):\n         \"\"\"Add an outbound p2p connection from node. Must be an\n         \"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\" or \"feeler\" connection.\n+        The txrelay arg determines whether our peer will signal support for txrelay in their version message.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315532",
      "id" : 1361315532,
      "in_reply_to_id" : 1354994889,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJAbM",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 676,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 1681039336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:12:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, thanks",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:12:18Z",
      "diff_hunk" : "@@ -368,13 +371,16 @@ def peer_connect(self, *args, services=P2P_SERVICES, send_version=True, **kwargs\n         create_conn = super().peer_connect(*args, **kwargs)\n \n         if send_version:\n-            self.peer_connect_send_version(services)\n+            self.peer_connect_send_version(services, txrelay=True)\n \n         return create_conn\n \n     def peer_accept_connection(self, *args, services=P2P_SERVICES, **kwargs):\n+        txrelay = True\n+        if 'txrelay' in kwargs:\n+            txrelay = kwargs.pop('txrelay')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315646",
      "id" : 1361315646,
      "in_reply_to_id" : 1353428699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJAc-",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 381,
      "original_position" : 30,
      "original_start_line" : 379,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 1681039508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:12:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315831"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "used the ternary, I think having a default arg is not ideal here because I'm not sure what should be the default and why.",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:12:37Z",
      "diff_hunk" : "@@ -351,12 +351,15 @@ def __init__(self, support_addrv2=False, wtxidrelay=True):\n         # If the peer supports wtxid-relay\n         self.wtxidrelay = wtxidrelay\n \n-    def peer_connect_send_version(self, services):\n+    def peer_connect_send_version(self, services, txrelay):\n         # Send a version msg\n         vt = msg_version()\n         vt.nVersion = P2P_VERSION\n         vt.strSubVer = P2P_SUBVERSION\n-        vt.relay = P2P_VERSION_RELAY\n+        if txrelay:\n+            vt.relay = P2P_VERSION_RELAY\n+        else:\n+            vt.relay = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361315831",
      "id" : 1361315831,
      "in_reply_to_id" : 1353431707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJAf3",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 362,
      "original_position" : 14,
      "original_start_line" : 359,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 1681039790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:12:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361315831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361316203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361316203"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that's why I didn't include the check here (the similar checks a few lines above aren't necessary either)",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:13:15Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361316203",
      "id" : 1361316203,
      "in_reply_to_id" : 1355464069,
      "line" : 5262,
      "node_id" : "PRRC_kwDOABII585RJAlr",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5262,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 1681040346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361316203/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5257,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361316203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361317540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361317540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, added another connection that is not being disconnected.",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:15:39Z",
      "diff_hunk" : "@@ -78,6 +78,33 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections=1\n+        self.restart_node(0, [\"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361317540",
      "id" : 1361317540,
      "in_reply_to_id" : 1353453538,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJA6k",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 90,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1681042348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361317540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:15:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361317540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed to address feedback.\r\n\r\nI also removed a sub-test with a block-relay-only peer, there isn't really a reason to think that that peer would be disconnected anyway, and it didn't make much sense in that form because we weren't at any connection limit. ",
      "created_at" : "2023-10-16T22:18:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1765361195",
      "id" : 1765361195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585pOUYr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765361195/reactions"
      },
      "updated_at" : "2023-10-16T22:18:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765361195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361320177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361320177"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I could add this if reviewers prefer it. I also thought about renaming, but couldn't really think of a better name than \"GetExtraFullOutboundCount\" that would imply negative return values.",
      "commit_id" : "a361ac4a8ebaa3f02eb25150519f51c7de6396bb",
      "created_at" : "2023-10-16T22:19:45Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1361320177",
      "id" : 1361320177,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585RJBjx",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1681045921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361320177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T22:19:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361320177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417173713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417173713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "is `the newest` enforced by `ForEachNode` iterating? Perhaps make this requirement more clear? Perhaps even add an assert for `m_connected` before `node_to_evict = node->GetId();`",
      "commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "created_at" : "2023-12-06T12:02:07Z",
      "diff_hunk" : "@@ -5246,6 +5247,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417173713",
      "id" : 1417173713,
      "line" : 5252,
      "node_id" : "PRRC_kwDOABII585UeFrR",
      "original_commit_id" : "7ebf72b655ca02017c547de99fde6f297ced47f7",
      "original_line" : 5252,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 1767377965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417173713/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T12:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417173713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417175382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417175382"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Assume `fDisconnect` could be useful here too. Just in case `ForEachNode` gets updated.",
      "commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "created_at" : "2023-12-06T12:03:46Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417175382",
      "id" : 1417175382,
      "in_reply_to_id" : 1355464069,
      "line" : 5262,
      "node_id" : "PRRC_kwDOABII585UeGFW",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5262,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 1767380677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417175382/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5257,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-06T12:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417175382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417178196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417178196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure why anyone would do `maxconnections=1` in practice, but then if their firewall allows to find only one blocksonly node (and they are not in blocksonly), the behavior might be confusing: they will be frequently disconencted from this peer.\r\n\r\nPerhaps, this could be logged if maxconnections=1",
      "commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "created_at" : "2023-12-06T12:06:50Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer2.wait_for_disconnect()\n+        blocksonly_peer1.sync_with_ping()\n+        blocksonly_peer1.peer_disconnect()\n+\n+        self.log.info(\"Check that we don't evict full-relay outbound connections to blocksonly peers if we are blocksonly ourselves\")\n+        self.restart_node(0, [\"-blocksonly\", \"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417178196",
      "id" : 1417178196,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585UeGxU",
      "original_commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "original_line" : 100,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 23,
      "pull_request_review_id" : 1767385600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417178196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T12:06:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417178196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1419441534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419441534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It is enforced by the line\r\n`if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {` (second condition), \r\nnot through `m_connected` but by picking the eligible node with the highest NodeId. I'll add to the comment that \"newest\" means \"highest `Node Id`\", do you think that would be sufficient?\r\n",
      "commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "created_at" : "2023-12-07T18:28:06Z",
      "diff_hunk" : "@@ -5246,6 +5247,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1419441534",
      "id" : 1419441534,
      "in_reply_to_id" : 1417173713,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UmvV-",
      "original_commit_id" : "7ebf72b655ca02017c547de99fde6f297ced47f7",
      "original_line" : 5252,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1770805619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419441534/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T18:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419441534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1419470209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419470209"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree that it makes no sense, if you want just one connection you should pick a node you trust and do `-connect`. Using automatic connections for that means eclipsing yourself - maybe we should warn about that in general?\r\nThat being said, this PR does log disconnection to `-blocksonly` peers, although only in `BCLog::NET` - do you suggest to make it unconditional based on `-maxconnections`? ",
      "commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "created_at" : "2023-12-07T18:52:54Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer2.wait_for_disconnect()\n+        blocksonly_peer1.sync_with_ping()\n+        blocksonly_peer1.peer_disconnect()\n+\n+        self.log.info(\"Check that we don't evict full-relay outbound connections to blocksonly peers if we are blocksonly ourselves\")\n+        self.restart_node(0, [\"-blocksonly\", \"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1419470209",
      "id" : 1419470209,
      "in_reply_to_id" : 1417178196,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585Um2WB",
      "original_commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "original_line" : 100,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 23,
      "pull_request_review_id" : 1770843832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419470209/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T18:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419470209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1420214407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420214407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds good",
      "commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "created_at" : "2023-12-08T10:04:04Z",
      "diff_hunk" : "@@ -5246,6 +5247,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1420214407",
      "id" : 1420214407,
      "in_reply_to_id" : 1417173713,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UpsCH",
      "original_commit_id" : "7ebf72b655ca02017c547de99fde6f297ced47f7",
      "original_line" : 5252,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1772032960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420214407/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-08T10:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420214407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1420216477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420216477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the idea was to log `if maxconnect is set to 1`, so at the startup (setting this argument) time.\r\nI don't insist though.",
      "commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "created_at" : "2023-12-08T10:05:47Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer2.wait_for_disconnect()\n+        blocksonly_peer1.sync_with_ping()\n+        blocksonly_peer1.peer_disconnect()\n+\n+        self.log.info(\"Check that we don't evict full-relay outbound connections to blocksonly peers if we are blocksonly ourselves\")\n+        self.restart_node(0, [\"-blocksonly\", \"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1420216477",
      "id" : 1420216477,
      "in_reply_to_id" : 1417178196,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585Upsid",
      "original_commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "original_line" : 100,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 23,
      "pull_request_review_id" : 1772035693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420216477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-08T10:05:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420216477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 840a022\r\n\r\nNot sure if you noticed [this idea](https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1417175382), might be a worthy precaution.",
      "created_at" : "2023-12-08T10:07:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1846900239",
      "id" : 1846900239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585uFXYP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1846900239/reactions"
      },
      "updated_at" : "2023-12-08T10:07:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1846900239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423210717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423210717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full outbound limit\")\r\n```",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-11T22:50:39Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423210717",
      "id" : 1423210717,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U1Hjd",
      "original_commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "original_line" : 81,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1776309045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423210717/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T23:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423210717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423241016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423241016"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think this is testing the expected behavior. The test node is currently started up in `blocksonly` mode, so won't enter the new conditional in `EvictExtraOutboundPeers` regardless of the `extra_outbound_count` check. To get the test to fail, I added a restart. So right now, this 1st new test and the 3rd new test are the same thing.\r\n\r\nMy suggestion is to break these 3 new tests into a separate subtest that restarts with `-noblocksonly` to help make it clear what the preconditions are. \r\n\r\n\r\ndiff that edits the condition to get the existing test to fail, and then adds the restart so it actually fails:\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex b4f3dbc0ba..a29e296a16 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -5252,7 +5252,7 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\r\n     // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\r\n     // This is not done if we are in -blocksonly mode ourselves or still in IBD,\r\n     // because then we don't care if our peer supports tx relay.\r\n-    else if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\r\n+    else if (extra_outbound_count <= 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\r\n         std::optional<NodeId> node_to_evict;\r\n         m_connman.ForEachNode([&node_to_evict](CNode* node) {\r\n             if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\r\ndiff --git a/test/functional/p2p_blocksonly.py b/test/functional/p2p_blocksonly.py\r\nindex 5b455a7e3a..c2fd395d68 100755\r\n--- a/test/functional/p2p_blocksonly.py\r\n+++ b/test/functional/p2p_blocksonly.py\r\n@@ -79,6 +79,7 @@ class P2PBlocksOnly(BitcoinTestFramework):\r\n         self.generate(self.nodes[0], 1)\r\n\r\n         self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\r\n+        self.restart_node(0, [\"-noblocksonly\"])\r\n         blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\r\n         # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\r\n         self.nodes[0].mockscheduler(46)\r\n```\r\n\r\n",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-11T23:39:44Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423241016",
      "id" : 1423241016,
      "in_reply_to_id" : 1423210717,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U1O84",
      "original_commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "original_line" : 81,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1776309045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423241016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T23:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423241016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423245744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423245744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "imo users should get an error if they set `-maxconnections` to less than 8, or at least a \"this is unsafe. are you SURE?!\". but that's probably getting off topic here :) ",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-11T23:48:30Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer2.wait_for_disconnect()\n+        blocksonly_peer1.sync_with_ping()\n+        blocksonly_peer1.peer_disconnect()\n+\n+        self.log.info(\"Check that we don't evict full-relay outbound connections to blocksonly peers if we are blocksonly ourselves\")\n+        self.restart_node(0, [\"-blocksonly\", \"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423245744",
      "id" : 1423245744,
      "in_reply_to_id" : 1417178196,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII585U1QGw",
      "original_commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "original_line" : 104,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 34,
      "pull_request_review_id" : 1776309045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423245744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T23:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423245744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423252977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423252977"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "updating `ForEachNode` to no longer check `NodeFullyConnected` seems pretty intrusive & like all callers would need to be carefully checked, so imo it doesn't seem super valuable to repeat the check here. but cost of redundant check is also pretty low so doesn't seem like a big deal either way. ",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T00:01:56Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423252977",
      "id" : 1423252977,
      "in_reply_to_id" : 1355464069,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U1R3x",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5261,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1776372254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423252977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-12T00:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423252977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423253383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423253383"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "maybe `GetFullOutboundDelta` ? ",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T00:02:42Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423253383",
      "id" : 1423253383,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585U1R-H",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1776372829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423253383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T00:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1423253383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424568910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424568910"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I also don't see that as a real risk, but I do see the problem that whoever reads this code (or decides to use `ForEachNode` somewhere else) could easily get confused, especially since some callers check again for `fDisconnect`.\r\nI added a refactor commit renaming `ForEachNode()` to `ForEachFullyConnectedNode()` and removing the duplicate checks / comments. What do you think about that approach? ",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T21:01:02Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424568910",
      "id" : 1424568910,
      "in_reply_to_id" : 1355464069,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U6TJO",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5261,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1778428581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424568910/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-12T21:11:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424568910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424570189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424570189"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, I missed that we are already in blocksonly mode! I moved the added tests to a new `blocksonly_peer_tests` subtest as suggested.",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T21:02:36Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424570189",
      "id" : 1424570189,
      "in_reply_to_id" : 1423210717,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U6TdN",
      "original_commit_id" : "840a022700910f9ab61e8aff367451dc01a37875",
      "original_line" : 81,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1778430814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424570189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T21:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424570189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424575234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424575234"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd agree with adding this warning, but yeah, this PR is not the best place for it.",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T21:08:26Z",
      "diff_hunk" : "@@ -78,6 +78,31 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full oubound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer2.wait_for_disconnect()\n+        blocksonly_peer1.sync_with_ping()\n+        blocksonly_peer1.peer_disconnect()\n+\n+        self.log.info(\"Check that we don't evict full-relay outbound connections to blocksonly peers if we are blocksonly ourselves\")\n+        self.restart_node(0, [\"-blocksonly\", \"-maxconnections=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424575234",
      "id" : 1424575234,
      "in_reply_to_id" : 1417178196,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII585U6UsC",
      "original_commit_id" : "cd7c42e64bbbc52b6dbd60fdb9233949f20ba94d",
      "original_line" : 104,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 34,
      "pull_request_review_id" : 1778438956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424575234/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T21:08:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424575234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[840a022 ](https://github.com/bitcoin/bitcoin/commit/840a022700910f9ab61e8aff367451dc01a37875)to [d636e38](https://github.com/bitcoin/bitcoin/commit/d636e38d79a4c3950da91090b1f787163f11e24d):\r\nAddressed feedback, and also added a new commit to rename `ForEachNode` and remove duplicate checks, see https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424568910.\r\n\r\nToDo: address https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1423253383",
      "created_at" : "2023-12-12T21:10:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1852816314",
      "id" : 1852816314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585ub7u6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852816314/reactions"
      },
      "updated_at" : "2023-12-12T21:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852816314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424611995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424611995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I like that name! I missed your comment in the most recent push, but will change it tomorrow!",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-12T21:50:15Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424611995",
      "id" : 1424611995,
      "in_reply_to_id" : 1353461371,
      "line" : 2414,
      "node_id" : "PRRC_kwDOABII585U6dqb",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2414,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 1778494532,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424611995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T21:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424611995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424997744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424997744"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To be clear, i suggested literally having `Assume(fDisconnect)`, not an extra `if` check (that would actually make code worse).\r\n\r\nEven if you refactor it into `ForEachFullyConnectedNode`, I think this `Assume(fDisconnect)` is kinda useful âÂ because who knows what exactly `ForEachFullyConnectedNode` means :)\r\n\r\nBut I'm fine either way, either you rename or add `Assume` (both are ideal i think :))",
      "commit_id" : "d636e38d79a4c3950da91090b1f787163f11e24d",
      "created_at" : "2023-12-13T08:20:23Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1424997744",
      "id" : 1424997744,
      "in_reply_to_id" : 1355464069,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U771w",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5261,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1779072627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424997744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-13T08:20:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424997744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1425865265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "hm, I think this comment can be a bit misleading for people who don't readily have the full context. the setup tests peers who set the version relay bool to false, indicating they don't want tx messages. if they are running bitcoind, that means they are running in blocksonly mode, but from the POV of the tests we don't actually know that. I think it could be helpful to clarify that in the comment here, and then can continue to use the var naming of \"blocksonly\" in the test. ",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-13T20:44:05Z",
      "diff_hunk" : "@@ -78,6 +79,34 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+    # Tests in which our peer is blocksonly",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1425865265",
      "id" : 1425865265,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U_Pox",
      "original_commit_id" : "70782ab70d7959da272f0696e4b4b2b3bdc8bd5e",
      "original_line" : 82,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1780458476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T21:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1425878915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425878915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I added a refactor commit renaming ForEachNode() to ForEachFullyConnectedNode() and removing the duplicate checks / comments.\r\n\r\nI like it, I find it clear",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-13T20:59:32Z",
      "diff_hunk" : "@@ -5246,6 +5247,28 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    if (extra_outbound_count == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {\n+        std::optional<NodeId> node_to_evict;\n+        m_connman.ForEachNode([&node_to_evict](CNode* node) {\n+            if (!node->IsFullOutboundConn() || node->m_relays_txs) return;\n+            if (!node_to_evict.has_value() || *node_to_evict < node->GetId()) {\n+                node_to_evict = node->GetId();\n+            }\n+        });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1425878915",
      "id" : 1425878915,
      "in_reply_to_id" : 1355464069,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U_S-D",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 5256,
      "original_position" : 27,
      "original_start_line" : 5258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1780458476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425878915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-13T21:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425878915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1427157449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427157449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-14T19:06:30Z",
      "diff_hunk" : "@@ -78,6 +79,34 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+    # Tests in which our peer is blocksonly",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1427157449",
      "id" : 1427157449,
      "in_reply_to_id" : 1425865265,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VELHJ",
      "original_commit_id" : "70782ab70d7959da272f0696e4b4b2b3bdc8bd5e",
      "original_line" : 82,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 1782526493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427157449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-14T19:06:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427157449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[d636e38 ](https://github.com/bitcoin/bitcoin/commit/d636e38d79a4c3950da91090b1f787163f11e24d)to 2a17ac3:\r\nRenamed `GetExtraFullOutboundCount` to `GetFullOutboundDelta` since it can now return negative values, plust small doc change in the test.\r\n[2a17ac3 ](https://github.com/bitcoin/bitcoin/commit/2a17ac3aa95b9df9a5a7ea0c0784618fa1820033)to [ad4866](https://github.com/bitcoin/bitcoin/commit/ad48667ec8e8d563550df768d0b45abf800662d9):\r\nRebased due to conflict. ",
      "created_at" : "2023-12-14T19:07:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1856427821",
      "id" : 1856427821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585uptct",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856427821/reactions"
      },
      "updated_at" : "2023-12-14T19:12:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856427821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1427158995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427158995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done now!",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-14T19:08:22Z",
      "diff_hunk" : "@@ -2410,7 +2411,7 @@ int CConnman::GetExtraFullOutboundCount() const\n             }\n         }\n     }\n-    return std::max(full_outbound_peers - m_max_outbound_full_relay, 0);\n+    return full_outbound_peers - m_max_outbound_full_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1427158995",
      "id" : 1427158995,
      "in_reply_to_id" : 1353461371,
      "line" : 2367,
      "node_id" : "PRRC_kwDOABII585VELfT",
      "original_commit_id" : "831ed4960bfb1eafb763cb2a52201a97a17f8168",
      "original_line" : 2367,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 20,
      "pull_request_review_id" : 1782529091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427158995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-14T19:08:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427158995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-14T22:34:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1856825484",
      "id" : 1856825484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585urOiM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856825484/reactions"
      },
      "updated_at" : "2023-12-14T22:34:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856825484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429773492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429773492"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1393bf67b26c000483c750258ca9d1daeab8a2cb\r\n\r\nnot super clear why we won't do this `if full_outbound_delta > 0`?\r\nMaybe a comment explaining why this could be possible in the first place could help (probably above the first if block).\r\nEven now it's hard to tell if it's possible to be over the limit most-of-the-time, let alone if we add some new complexity for being over the limit more frequently (for some security reason or whatever).",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-18T09:27:32Z",
      "diff_hunk" : "@@ -5241,6 +5242,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    else if (full_outbound_delta == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429773492",
      "id" : 1429773492,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII585VOJy0",
      "original_commit_id" : "1393bf67b26c000483c750258ca9d1daeab8a2cb",
      "original_line" : 5250,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 1786301565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429773492/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-18T09:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429773492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429781523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429781523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "68769ff7c3252c7cfb8758459218979eacba7acb\r\n\r\nYou could expand this test by adding some irrelevant peers (e.g. ADDRFETCH), but no big deal.",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-18T09:32:14Z",
      "diff_hunk" : "@@ -78,6 +79,34 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+    # Tests with an outbound peer that sets txrelay to false (which they do if they are in blocksonly mode)\n+    def blocksonly_peer_tests(self):\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full outbound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429781523",
      "id" : 1429781523,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585VOLwT",
      "original_commit_id" : "68769ff7c3252c7cfb8758459218979eacba7acb",
      "original_line" : 92,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 22,
      "pull_request_review_id" : 1786301565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429781523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-18T09:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429781523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429786276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429786276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ad48667ec8e8d563550df768d0b45abf800662d9\r\n\r\ngotta drop the second condition here?",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-18T09:35:09Z",
      "diff_hunk" : "@@ -2020,7 +2020,7 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         m_most_recent_block_txs = std::move(most_recent_block_txs);\n     }\n \n-    m_connman.ForEachNode([this, pindex, &lazy_ser, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    m_connman.ForEachFullyConnectedNode([this, pindex, &lazy_ser, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n         AssertLockHeld(::cs_main);\n \n         if (pnode->GetCommonVersion() < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429786276",
      "id" : 1429786276,
      "line" : 2026,
      "node_id" : "PRRC_kwDOABII585VOM6k",
      "original_commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "original_line" : 2026,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1786301565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429786276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-18T09:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429786276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429789777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429789777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ad48667ec8e8d563550df768d0b45abf800662d9\r\n\r\nmight update this too `if (!Assume(state)) return` and drop the comment if you feel like it :)",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2023-12-18T09:36:54Z",
      "diff_hunk" : "@@ -5194,12 +5194,11 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n         NodeId worst_peer = -1;\n         int64_t oldest_block_announcement = std::numeric_limits<int64_t>::max();\n \n-        m_connman.ForEachNode([&](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_connman.GetNodesMutex()) {\n+        m_connman.ForEachFullyConnectedNode([&](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_connman.GetNodesMutex()) {\n             AssertLockHeld(::cs_main);\n \n-            // Only consider outbound-full-relay peers that are not already\n-            // marked for disconnection\n-            if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+            // Only consider outbound-full-relay peers\n+            if (!pnode->IsFullOutboundConn()) return;\n             CNodeState *state = State(pnode->GetId());\n             if (state == nullptr) return; // shouldn't be possible, but just in case",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429789777",
      "id" : 1429789777,
      "line" : 5203,
      "node_id" : "PRRC_kwDOABII585VONxR",
      "original_commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "original_line" : 5203,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 1786301565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429789777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-18T09:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1429789777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1440903038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1440903038"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, I think the main reason was to avoid interaction with the existing extra-full-outbound eviction.\r\nWhich raises the question whether there should be any interaction?\r\nShould nodes that are protected from that (either because `m_protect` is true or because they are the only ones for their network) also be made exempt from this new disconnection due to not supporting tx relay?\r\nI'm not really sure about that: It would be unfortunate if the non-tx-relaying outbound peer would be the only one with the best chain, but how realistic would such a scenario be?",
      "commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "created_at" : "2024-01-03T20:19:04Z",
      "diff_hunk" : "@@ -5241,6 +5242,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    else if (full_outbound_delta == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1440903038",
      "id" : 1440903038,
      "in_reply_to_id" : 1429773492,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII585V4m9-",
      "original_commit_id" : "1393bf67b26c000483c750258ca9d1daeab8a2cb",
      "original_line" : 5250,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 1803013157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1440903038/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-03T20:19:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1440903038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443312604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443312604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> not super clear why we won't do this if full_outbound_delta > 0?\r\n\r\n> Which raises the question whether there should be any interaction?\r\n\r\nI think this would create a weird interaction. The current approach of this PR is trying to make the 8 full-outbound connections relay transactions, given we already have blocks-only connections, so we should not waste full-outbound slots for this purpose. However, our full-outbound connection protection criteria is based on whether they have provided valid blocks with enough accumulated work and it has nothing to do with how good they are at providing transactions (there is also the recently added network diversity criteria, more about that later). \r\n\r\nThis raises the question of what we value the most, having 8 full-outbound peers relaying transactions or our protected peers (and under what criteria). If the former is valued the most, we could merge this under `full_outbound_delta > 0` but pick a node not taking the protection criteria into account (which raises the question of how useful the protection is to start with). If the latter is prioritized, then we exclude the protected peers first and then run the eviction over the remaining. This slightly changes the goal of the PR, given we may not achieve 8 transaction-relaying outbound peers. Finally, there are the additional protected peers for network diversity. Depending on how this is treated we may end up with an even smaller number of full-outbounds relaying transactions (`8 - 4 - n` where `n` represents the number of networks we support).",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-05T19:48:43Z",
      "diff_hunk" : "@@ -5241,6 +5242,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    else if (full_outbound_delta == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443312604",
      "id" : 1443312604,
      "in_reply_to_id" : 1429773492,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII585WBzPc",
      "original_commit_id" : "1393bf67b26c000483c750258ca9d1daeab8a2cb",
      "original_line" : 5250,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1806742527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443312604/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-05T20:28:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443312604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443336121"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443336121"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I agree - I think that there are colliding goals, my thinking is as follows:\r\n1) The `m_protect` protection attempts to prevent pathological situations where we wouldn't have enough peers with the honest best chain (that shouldn't happen normally even without the protection, but would be very serious if they did)\r\n2) The network-specific protection aims to be connected to all networks we support, to help the interconnection, and also to reduce the risk of eclipse attacks. Ideally, that means relaying both blocks and transactions from one network to another.\r\n3) The added code attempts to make sure we have as many full-outbound peers actually participating in tx relay asÂ possible, mostly for selfish reasons (e.g. privacy, fee estimation) \r\n\r\nThese goals conflict. I'm pretty confident that 3) should take precedence over 2), because the network-specific protection isn't really about this particular peer, we just want any connection to that network, and would be happy to exchange a current peer that doesn't support tx-relay with a tx-relaying peer from that same network.\r\n\r\nI'm kind of torn between 1) and 2). It would be easy to exempt non-tx-relaying `m_protect` peers from disconnection, but that would mean that we could end up with up to 4 of these peers permanently.",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-05T20:19:51Z",
      "diff_hunk" : "@@ -5241,6 +5242,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    else if (full_outbound_delta == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443336121",
      "id" : 1443336121,
      "in_reply_to_id" : 1429773492,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII585WB4-5",
      "original_commit_id" : "1393bf67b26c000483c750258ca9d1daeab8a2cb",
      "original_line" : 5250,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1806784291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443336121/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-05T20:25:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443336121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443337020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337020"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I tried it, but it turned out to be annoying because in the test we simulate being at the full outbound limit by artificially running with a lower `-maxconnections`. If we now also add an unrelated peer like ADDRFETCH , it would make the test fail because we don't have enough slots  in `semOutbound`. ",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-05T20:21:00Z",
      "diff_hunk" : "@@ -78,6 +79,34 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+    # Tests with an outbound peer that sets txrelay to false (which they do if they are in blocksonly mode)\n+    def blocksonly_peer_tests(self):\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full outbound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443337020",
      "id" : 1443337020,
      "in_reply_to_id" : 1429781523,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585WB5M8",
      "original_commit_id" : "68769ff7c3252c7cfb8758459218979eacba7acb",
      "original_line" : 92,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 22,
      "pull_request_review_id" : 1806785543,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337020/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-05T20:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443337547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337547"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, thanks - I had missed this!",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-05T20:21:17Z",
      "diff_hunk" : "@@ -2020,7 +2020,7 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         m_most_recent_block_txs = std::move(most_recent_block_txs);\n     }\n \n-    m_connman.ForEachNode([this, pindex, &lazy_ser, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    m_connman.ForEachFullyConnectedNode([this, pindex, &lazy_ser, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n         AssertLockHeld(::cs_main);\n \n         if (pnode->GetCommonVersion() < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443337547",
      "id" : 1443337547,
      "in_reply_to_id" : 1429786276,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585WB5VL",
      "original_commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "original_line" : 2026,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1806786394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337547/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-05T20:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443337547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443338184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443338184"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I'd prefer to not do it here, for my taste it's not related enough to the core of this PR.",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-05T20:22:21Z",
      "diff_hunk" : "@@ -5194,12 +5194,11 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n         NodeId worst_peer = -1;\n         int64_t oldest_block_announcement = std::numeric_limits<int64_t>::max();\n \n-        m_connman.ForEachNode([&](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_connman.GetNodesMutex()) {\n+        m_connman.ForEachFullyConnectedNode([&](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_connman.GetNodesMutex()) {\n             AssertLockHeld(::cs_main);\n \n-            // Only consider outbound-full-relay peers that are not already\n-            // marked for disconnection\n-            if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+            // Only consider outbound-full-relay peers\n+            if (!pnode->IsFullOutboundConn()) return;\n             CNodeState *state = State(pnode->GetId());\n             if (state == nullptr) return; // shouldn't be possible, but just in case",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1443338184",
      "id" : 1443338184,
      "in_reply_to_id" : 1429789777,
      "line" : 5203,
      "node_id" : "PRRC_kwDOABII585WB5fI",
      "original_commit_id" : "ad48667ec8e8d563550df768d0b45abf800662d9",
      "original_line" : 5203,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 1806787530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443338184/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-05T20:22:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1443338184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated to address feedback, I would love to hear more opinions on the protection issue discussed in the threat following https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1429773492",
      "created_at" : "2024-01-05T20:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#issuecomment-1879217526",
      "id" : 1879217526,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28538",
      "node_id" : "IC_kwDOABII585wApV2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1879217526/reactions"
      },
      "updated_at" : "2024-01-05T20:24:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1879217526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1446322434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446322434"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "68769ff: nit if you retouch.\r\n```suggestion\r\nwith self.nodes[0].assert_debug_log(expected_msgs=[\"disconnecting full outbound peer not participating in tx relay: peer=1\"]):\r\n            self.nodes[0].mockscheduler(46)\r\n            blocksonly_peer2.wait_for_disconnect()\r\n```",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-09T16:28:27Z",
      "diff_hunk" : "@@ -78,6 +79,34 @@ def blocksonly_mode_tests(self):\n         self.nodes[0].disconnect_p2ps()\n         self.generate(self.nodes[0], 1)\n \n+    # Tests with an outbound peer that sets txrelay to false (which they do if they are in blocksonly mode)\n+    def blocksonly_peer_tests(self):\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        self.log.info(\"Check that we sustain full-relay outbound connections to blocksonly peers when not at the full outbound limit\")\n+        blocksonly_peer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        # Trigger CheckForStaleTipAndEvictPeers, which is scheduled every 45s (EXTRA_PEER_CHECK_INTERVAL)\n+        self.nodes[0].mockscheduler(46)\n+        blocksonly_peer.sync_with_ping()\n+        blocksonly_peer.peer_disconnect()\n+\n+        self.log.info(\"Check that we evict full-relay outbound connections to blocksonly peers at the full outbound limit\")\n+        # Simulate the situation of being at the max limit of full-outbound connections by setting -maxconnections to a low value\n+        self.restart_node(0, [\"-noblocksonly\", \"-maxconnections=2\"])\n+        # Have one blocksonly peer that is not being disconnected\n+        blocksonly_peer1 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, txrelay=False)\n+        blocksonly_peer2 = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=2, txrelay=False)\n+        self.nodes[0].mockscheduler(46)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1446322434",
      "id" : 1446322434,
      "line" : 98,
      "node_id" : "PRRC_kwDOABII585WNSEC",
      "original_commit_id" : "68769ff7c3252c7cfb8758459218979eacba7acb",
      "original_line" : 98,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 28,
      "pull_request_review_id" : 1811535657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446322434/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T16:41:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446322434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1446331630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446331630"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> It would be easy to exempt non-tx-relaying m_protect peers from disconnection, but that would mean that we could end up with up to 4 of these peers permanently.\r\n\r\n[commit message](https://github.com/bitcoin/bitcoin/pull/11490/commits/5a6d00c6defc587e22c93e63029fdd538ce8858d) where `m_protect` was introduced says \"we pick 4 of our outbound peers and do not subject them to this logic, to be more conservative. We don't wish to permit temporary network issues (or an attacker) to excessively disrupt network topology.\"\r\n\r\nwondering how someone can disrupt network topology with this and if it's still relevant.",
      "commit_id" : "8f074589f5c2f03969fc2d3dd929385a81fba94c",
      "created_at" : "2024-01-09T16:35:59Z",
      "diff_hunk" : "@@ -5241,6 +5242,27 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             }\n         }\n     }\n+    // If we are at the max full outbound limit but not above, check if any peers\n+    // don't support tx relay (they might be in -blocksonly mode) - if so,\n+    // evict the newest of them (highest Node Id) so we can fill the slot with a tx-relaying outbound peer\n+    // This is not done if we are in -blocksonly mode ourselves or still in IBD,\n+    // because then we don't care if our peer supports tx relay.\n+    else if (full_outbound_delta == 0 && !m_opts.ignore_incoming_txs && !m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28538#discussion_r1446331630",
      "id" : 1446331630,
      "in_reply_to_id" : 1429773492,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII585WNUTu",
      "original_commit_id" : "1393bf67b26c000483c750258ca9d1daeab8a2cb",
      "original_line" : 5250,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1811535657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28538",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446331630/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T16:41:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446331630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   }
]
