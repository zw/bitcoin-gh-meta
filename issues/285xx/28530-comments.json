[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28530).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [theuni](https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1762037778) |\n| Stale ACK | [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/28530#pullrequestreview-1645987781), [stickies-v](https://github.com/bitcoin/bitcoin/pull/28530#pullrequestreview-1687744024) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-09-25T15:51:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1734024910",
      "id" : 1734024910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585nWx7O",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1734024910/reactions"
      },
      "updated_at" : "2023-10-19T14:55:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1734024910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336094386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336094386"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can delete this too, since it's a class",
      "commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "created_at" : "2023-09-25T15:58:09Z",
      "diff_hunk" : "@@ -36,50 +34,27 @@ static const unsigned int MAX_DISCONNECTED_TX_POOL_SIZE = 20'000;\n  * of the list. After trimming, transactions can be re-added to the mempool from the back of the\n  * list to the front without running into missing inputs.\n  */\n-class DisconnectedBlockTransactions {\n+class DisconnectedBlockTransactions\n+{\n private:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336094386",
      "id" : 1336094386,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Poy6y",
      "original_commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "original_line" : 39,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.h",
      "position" : 27,
      "pull_request_review_id" : 1642517394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336094386/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T12:59:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336094386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336095581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336095581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A bit more accurate:\r\n```suggestion\r\n    /* Maximum allowed total DynamicMemoryUsage, in bytes. To be enforced in AddTransactionsFromBlock.  */\r\n```",
      "commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "created_at" : "2023-09-25T15:59:06Z",
      "diff_hunk" : "@@ -36,50 +34,27 @@ static const unsigned int MAX_DISCONNECTED_TX_POOL_SIZE = 20'000;\n  * of the list. After trimming, transactions can be re-added to the mempool from the back of the\n  * list to the front without running into missing inputs.\n  */\n-class DisconnectedBlockTransactions {\n+class DisconnectedBlockTransactions\n+{\n private:\n     /** Cached dynamic memory usage for the CTransactions (memory for the shared pointers is\n      * included in the container calculations). */\n-    uint64_t cachedInnerUsage = 0;\n+    uint64_t cachedInnerUsage{0};\n+    /* Maximum memory usage in bytes of the transactions stored  */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336095581",
      "id" : 1336095581,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585PozNd",
      "original_commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "original_line" : 43,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.h",
      "position" : 32,
      "pull_request_review_id" : 1642517394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336095581/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T12:59:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336095581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336128164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336128164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Question: what's the benefit of moving to cpp file? I thought maybe it saves users from including some things, but it seems about the same.",
      "commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "created_at" : "2023-09-25T16:25:12Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1336128164",
      "id" : 1336128164,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Po7Kk",
      "original_commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 1,
      "pull_request_review_id" : 1642517394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336128164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-09-26T12:59:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336128164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1337400713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337400713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Motivation is from @stickies-v  review comment https://github.com/bitcoin/bitcoin/pull/28385#pullrequestreview-1629400522\r\nIts a better practice to have interfaces in a `.h` and implementation code in `.cpp` file, allows for more efficient compilation by preventing redundant recompilation of unchanged code, ensuring faster build times I think.\r\n\r\nI dont think there will be need to have implementation code in the header files.\r\nhttps://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#source-code-organization",
      "commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "created_at" : "2023-09-26T15:24:40Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1337400713",
      "id" : 1337400713,
      "in_reply_to_id" : 1336128164,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Ptx2J",
      "original_commit_id" : "8c315c754137f491b2ec63de86393d20eeaaf7c3",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 1,
      "pull_request_review_id" : 1644579236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337400713/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-09-26T15:24:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337400713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added a commit to address review comment https://github.com/bitcoin/bitcoin/pull/28385#discussion_r1346498993\r\n\r\nAnd rebased due to #28567  being merged for CI to be green",
      "created_at" : "2023-10-05T11:01:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1748661730",
      "id" : 1748661730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585oOnXi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1748661730/reactions"
      },
      "updated_at" : "2023-10-05T11:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1748661730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Thanks for opening a followup! Did you want to pick up the memusage unit test too? ([9dcef47](https://github.com/bitcoin/bitcoin/commit/9dcef47e4d52b15ffe88be7ddf5ea626121e5f0d) or a new one)\r\n\r\nAdded the the test.\r\n",
      "created_at" : "2023-10-10T13:38:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1755448427",
      "id" : 1755448427,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585oogRr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1755448427/reactions"
      },
      "updated_at" : "2023-10-10T13:38:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1755448427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1352548693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352548693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@glozow \r\nthe `ENTRY_USAGE_OVERESTIMATE` in https://github.com/bitcoin/bitcoin/commit/9dcef47e4d52b15ffe88be7ddf5ea626121e5f0d is a bit much and two transaction are being added to `disconnectpool` for the first  test that check that its big enough for one transaction.\r\nSo reduced the overestimate to `TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*)`",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-10T13:40:32Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1352548693",
      "id" : 1352548693,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585QnkFV",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 39,
      "pull_request_review_id" : 1667756758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352548693/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T13:41:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352548693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1352583664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352583664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Makes sense to me - the numbers were a little bit off when I originally wrote that test. Thanks for fixing :+1: ",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-10T14:04:17Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1352583664",
      "id" : 1352583664,
      "in_reply_to_id" : 1352548693,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Qnsnw",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 39,
      "pull_request_review_id" : 1667812094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352583664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T14:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352583664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @theuni @stickies-v who made some of the suggestions being addressed and reviewed the test previously",
      "created_at" : "2023-10-11T09:05:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1757204566",
      "id" : 1757204566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585ovNBW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757204566/reactions"
      },
      "updated_at" : "2023-10-11T09:05:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757204566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1355039645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355039645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit on 436f53fd5b2ac1b3d9e11634d7f690dd32598844 commit message: it's not \"ensure\" so much as \"assume\"",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-11T13:46:47Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1355039645",
      "id" : 1355039645,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585QxEOd",
      "original_commit_id" : "436f53fd5b2ac1b3d9e11634d7f690dd32598844",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 1,
      "pull_request_review_id" : 1671289917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355039645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-10-13T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355039645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1355050588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355050588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "72ebef1677a0ae61a1ca9dcde576553fb6e99fa6 newline?",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-11T13:54:22Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        cachedInnerUsage += RecursiveDynamicUsage(**block_it);\n+    }\n+    return LimitMemoryUsage();\n+}\n+\n+void DisconnectedBlockTransactions::removeForBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    // Short-circuit in the common case of a block being added to the tip\n+    if (queuedTx.empty()) {\n+        return;\n+    }\n+    for (const auto& tx : vtx) {\n+        auto iter{iters_by_txid.find(tx->GetHash())};\n+        if (iter != iters_by_txid.end()) {\n+            auto list_iter{iter->second};\n+            iters_by_txid.erase(iter);\n+            cachedInnerUsage -= RecursiveDynamicUsage(**list_iter);\n+            queuedTx.erase(list_iter);\n+        }\n+    }\n+}\n+\n+void DisconnectedBlockTransactions::clear()\n+{\n+    cachedInnerUsage = 0;\n+    iters_by_txid.clear();\n+    queuedTx.clear();\n+}\n+\n+std::list<CTransactionRef> DisconnectedBlockTransactions::take()\n+{\n+    std::list<CTransactionRef> ret{std::move(queuedTx)};\n+    clear();\n+    return ret;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1355050588",
      "id" : 1355050588,
      "line" : 86,
      "node_id" : "PRRC_kwDOABII585QxG5c",
      "original_commit_id" : "72ebef1677a0ae61a1ca9dcde576553fb6e99fa6",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 86,
      "pull_request_review_id" : 1671289917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355050588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355050588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356794101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356794101"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "iwyu [says](https://api.cirrus-ci.com/v1/task/6063597319618560/logs/ci.log):\r\n\r\n\r\n```\r\nkernel/disconnected_transactions.cpp should add these lines:\r\n#include <assert.h>                  // for assert\r\n#include <algorithm>                 // for max\r\n#include <memory>                    // for __shared_ptr_access, shared_ptr\r\n#include <utility>                   // for move, pair\r\n#include \"memusage.h\"                // for DynamicUsage\r\n#include \"primitives/transaction.h\"  // for CTransactionRef, CTransaction\r\n#include \"util/hasher.h\"             // for SaltedTxidHasher\r\n```",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:09:12Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356794101",
      "id" : 1356794101,
      "line" : 7,
      "node_id" : "PRRC_kwDOABII585Q3wj1",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 7,
      "original_position" : 7,
      "original_start_line" : 5,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 7,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356794101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356794101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356806566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356806566"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\r\n        assert(inserted);  // callers may never pass multiple transactions with the same txid\r\n```",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:15:51Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        auto emplace_result = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(emplace_result.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356806566",
      "id" : 1356806566,
      "line" : 51,
      "node_id" : "PRRC_kwDOABII585Q3zmm",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 51,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356806566/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 50,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356806566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356827417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356827417"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure this is worth moving, would just leave in the header",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:28:46Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356827417",
      "id" : 1356827417,
      "line" : 10,
      "node_id" : "PRRC_kwDOABII585Q34sZ",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : 9,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 10,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356827417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 9,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356827417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356847691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356847691"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We're not actually exiting though?\r\n\r\n```suggestion\r\n        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\r\n        return;\r\n```",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:42:24Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356847691",
      "id" : 1356847691,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585Q39pL",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 16,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356847691/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356847691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356863523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356863523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think these numbers need to be better documented. I think this means that we're overestimating by 8 pointers? Why 8? Why do we need a safety margin? Labeling assumptions would be helpful to (future) reviewers.\r\n\r\nAlternatively, would it make sense to use a relative safety margin (i.e. TX_USAGE * 1.1) instead of an absolute one?",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:51:34Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356863523",
      "id" : 1356863523,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Q4Bgj",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 39,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356863523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356863523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356866786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356866786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit (in other places too):\r\n```suggestion\r\n        auto evicted_txns{disconnectpool.AddTransactionsFromBlock(two_txns)};\r\n```",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:53:08Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356866786",
      "id" : 1356866786,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585Q4CTi",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 46,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356866786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356866786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356870250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356870250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't really understand this docstring, what does it mean?",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T13:55:06Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1356870250",
      "id" : 1356870250,
      "line" : 44,
      "node_id" : "PRRC_kwDOABII585Q4DJq",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 44,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 44,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356870250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356870250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1357025332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357025332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note for other reviewers: these are the memory allocation numbers I'm getting on my machine:\r\n\r\n```\r\n(lldb) p MAP_1\r\n(const size_t) 32\r\n(lldb) p MAP_100\r\n(const size_t) 832\r\n(lldb) p TX_USAGE\r\n(const size_t) 640\r\n(lldb) p ENTRY_USAGE_OVERESTIMATE\r\n(const size_t) 896\r\n```",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T15:44:11Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1357025332",
      "id" : 1357025332,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Q4pA0",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 1,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357025332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-10-18T14:06:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357025332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1357036001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357036001"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's a good test to have but arguably not a `disconnectpool_memory_limits`. I think this could be a separate test case (and i also wouldn't be opposed to unit testing the rest of the interface, i.e. `AddTransactionsFromBlock`, `removeForBlock`, `take`, `clear`.",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-12T15:52:57Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAP_1 + ENTRY_USAGE_OVERESTIMATE);\n+\n+        // Only 1 transaction can be kept\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+        // Transactions are added from back to front and eviction is FIFO.\n+        BOOST_CHECK_EQUAL(block_vtx.at(1), evicted_txns.front());\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions with a comfortable maximum memory usage so that nothing is evicted.\n+    // Record usage so we can check size limiting in the next test.\n+    size_t usage_full{0};\n+    {\n+        const size_t USAGE_100_OVERESTIMATE{MAP_100 + ENTRY_USAGE_OVERESTIMATE * 100};\n+        DisconnectedBlockTransactions disconnectpool{USAGE_100_OVERESTIMATE};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK_EQUAL(evicted_txns.size(), 0);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= USAGE_100_OVERESTIMATE);\n+\n+        usage_full = disconnectpool.DynamicMemoryUsage();\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions that's just a little too small for all of the transactions.\n+    {\n+        const size_t MAX_MEMUSAGE_99{usage_full - sizeof(void*)};\n+        DisconnectedBlockTransactions disconnectpool{MAX_MEMUSAGE_99};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAX_MEMUSAGE_99);\n+\n+        // Only 1 transaction needed to be evicted\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+\n+        // Transactions are added from back to front and eviction is FIFO.\n+        // The last transaction of block_vtx should be the first to be evicted.\n+        BOOST_CHECK_EQUAL(block_vtx.back(), evicted_txns.front());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1357036001",
      "id" : 1357036001,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585Q4rnh",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 84,
      "original_position" : 84,
      "original_start_line" : 82,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 84,
      "pull_request_review_id" : 1674135076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357036001/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 82,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357036001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for your review @stickies-v, will drop the commits as you suggested and address comments.",
      "created_at" : "2023-10-12T16:40:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1759978996",
      "id" : 1759978996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585o5yX0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1759978996/reactions"
      },
      "updated_at" : "2023-10-12T16:40:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1759978996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358293479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358293479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well the good news is it looks like it passes on 32bit, so maybe just remove this block?",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-13T13:48:09Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358293479",
      "id" : 1358293479,
      "in_reply_to_id" : 1356847691,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585Q9enn",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 16,
      "pull_request_review_id" : 1671289917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358293479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358293479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358298767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358298767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I meant don't pass in all 100 transactions because the memory usage won't be what we expect and iirc all of them will be evicted. The function works by first allocating 100 buckets, adding all of the transactions, and then trimming. If we add all 100, there's much more overhead and we end up not having room for anything.",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-13T13:51:56Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358298767",
      "id" : 1358298767,
      "in_reply_to_id" : 1356870250,
      "line" : 44,
      "node_id" : "PRRC_kwDOABII585Q9f6P",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 44,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 44,
      "pull_request_review_id" : 1671289917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358298767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358298767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358301740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358301740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The 8 pointers isn't to create an overestimation margin, it's to account for the approximate usage of the data structures (pointers in the list nodes, etc.)",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-13T13:54:25Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358301740",
      "id" : 1358301740,
      "in_reply_to_id" : 1356863523,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Q9gos",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 39,
      "pull_request_review_id" : 1671289917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358301740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358301740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358347902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358347902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe a comment like this would suffice?\r\n```\r\n// Our overall formula is unordered map overhead + usage per entry.\r\n// Implementations may vary, but we're trying to guess the usage of data structures:\r\n// list: per entry x (2 pointers + element itself, which is a CTransactionRef)\r\n// unordered map: hashtable overhead + per entry x (3 pointers + value itself, which is an iterator)\r\n// Usage per entry is thus approximately `TX_USAGE` + 6 pointers. Add another 2 pointers as a safety margin.\r\n```",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T14:31:58Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358347902",
      "id" : 1358347902,
      "in_reply_to_id" : 1356863523,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII585Q9r5-",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 40,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 40,
      "pull_request_review_id" : 1676636051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358347902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T14:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358347902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358440407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed but Ive used used, `already_exist`  instead since that what the boolean represent and what cpp reference describe the boolean",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:51:21Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        auto emplace_result = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(emplace_result.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358440407",
      "id" : 1358440407,
      "in_reply_to_id" : 1356806566,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-CfX",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676784440,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440407/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358440629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:51:36Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358440629",
      "id" : 1358440629,
      "in_reply_to_id" : 1356847691,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-Ci1",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676784829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:51:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358440629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358443133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443133"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added the comment but I think, its word to also explain whats the pointers represent\r\n```\r\n// Our overall formula is unordered map overhead + usage per entry.\r\n// Implementations may vary, but we're trying to guess the usage of data structures:\r\n// list: per entry x (2 pointers (prev, next) + element itself, which is a CTransactionRef)\r\n// unordered map: hashtable overhead + per entry x (3 pointers (key, value, internal structure for book keeping) + value itself, which is an iterator)\r\n// Usage per entry is thus approximately `TX_USAGE` + 6 pointers. Add another 2 pointers as a safety margin.\r\n```\r\nBut not so sure if its correct for unordered map, I added as you suggested, if you think the explanation is worth it happy to repush",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-13T15:54:11Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358443133",
      "id" : 1358443133,
      "in_reply_to_id" : 1356863523,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII585Q-DJ9",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 40,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 40,
      "pull_request_review_id" : 1676788845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443133/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T16:10:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358443450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed thank you",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:54:27Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358443450",
      "id" : 1358443450,
      "in_reply_to_id" : 1356866786,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-DO6",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676789372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443450/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358443450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358446052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358446052"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "[I don't think so](https://en.cppreference.com/w/cpp/container/unordered_map/emplace)?\r\n\r\n> Returns a pair consisting of an iterator to the inserted element, or the already-existing element if no insertion happened, and a bool denoting whether the insertion took place (true if insertion happened, false if it did not).\r\n\r\nConceptually, we exactly want to ensure that the txid does _not_ exist yet, which is the opposite of what you're stating now.",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:55:53Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        auto emplace_result = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(emplace_result.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358446052",
      "id" : 1358446052,
      "in_reply_to_id" : 1356806566,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-D3k",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676793255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358446052/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358446052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, this checks the order in which transaction are evicted, do you think it should be in its own commit?",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-13T15:57:22Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAP_1 + ENTRY_USAGE_OVERESTIMATE);\n+\n+        // Only 1 transaction can be kept\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+        // Transactions are added from back to front and eviction is FIFO.\n+        BOOST_CHECK_EQUAL(block_vtx.at(1), evicted_txns.front());\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions with a comfortable maximum memory usage so that nothing is evicted.\n+    // Record usage so we can check size limiting in the next test.\n+    size_t usage_full{0};\n+    {\n+        const size_t USAGE_100_OVERESTIMATE{MAP_100 + ENTRY_USAGE_OVERESTIMATE * 100};\n+        DisconnectedBlockTransactions disconnectpool{USAGE_100_OVERESTIMATE};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK_EQUAL(evicted_txns.size(), 0);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= USAGE_100_OVERESTIMATE);\n+\n+        usage_full = disconnectpool.DynamicMemoryUsage();\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions that's just a little too small for all of the transactions.\n+    {\n+        const size_t MAX_MEMUSAGE_99{usage_full - sizeof(void*)};\n+        DisconnectedBlockTransactions disconnectpool{MAX_MEMUSAGE_99};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAX_MEMUSAGE_99);\n+\n+        // Only 1 transaction needed to be evicted\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+\n+        // Transactions are added from back to front and eviction is FIFO.\n+        // The last transaction of block_vtx should be the first to be evicted.\n+        BOOST_CHECK_EQUAL(block_vtx.back(), evicted_txns.front());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447526",
      "id" : 1358447526,
      "in_reply_to_id" : 1357036001,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII585Q-EOm",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 85,
      "original_position" : 84,
      "original_start_line" : 82,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 85,
      "pull_request_review_id" : 1676795657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447526/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 83,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T16:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thanks updated",
      "commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "created_at" : "2023-10-13T15:57:32Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447666",
      "id" : 1358447666,
      "in_reply_to_id" : 1355039645,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Q-EQy",
      "original_commit_id" : "436f53fd5b2ac1b3d9e11634d7f690dd32598844",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 1,
      "pull_request_review_id" : 1676795901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-10-13T15:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447931"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added ð¯ ",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:57:48Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        cachedInnerUsage += RecursiveDynamicUsage(**block_it);\n+    }\n+    return LimitMemoryUsage();\n+}\n+\n+void DisconnectedBlockTransactions::removeForBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    // Short-circuit in the common case of a block being added to the tip\n+    if (queuedTx.empty()) {\n+        return;\n+    }\n+    for (const auto& tx : vtx) {\n+        auto iter{iters_by_txid.find(tx->GetHash())};\n+        if (iter != iters_by_txid.end()) {\n+            auto list_iter{iter->second};\n+            iters_by_txid.erase(iter);\n+            cachedInnerUsage -= RecursiveDynamicUsage(**list_iter);\n+            queuedTx.erase(list_iter);\n+        }\n+    }\n+}\n+\n+void DisconnectedBlockTransactions::clear()\n+{\n+    cachedInnerUsage = 0;\n+    iters_by_txid.clear();\n+    queuedTx.clear();\n+}\n+\n+std::list<CTransactionRef> DisconnectedBlockTransactions::take()\n+{\n+    std::list<CTransactionRef> ret{std::move(queuedTx)};\n+    clear();\n+    return ret;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358447931",
      "id" : 1358447931,
      "in_reply_to_id" : 1355050588,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-EU7",
      "original_commit_id" : "72ebef1677a0ae61a1ca9dcde576553fb6e99fa6",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676796319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447931/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:57:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358447931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358449113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358449113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "its now in the header thanks",
      "commit_id" : "6d922c349a526c979ef613e5d36bb309b2299f29",
      "created_at" : "2023-10-13T15:58:34Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358449113",
      "id" : 1358449113,
      "in_reply_to_id" : 1356827417,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-EnZ",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : 9,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676798141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358449113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T15:58:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358449113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358463515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358463515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes you are right, my bad.\r\nupdated",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-13T16:07:16Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>\n+\n+DisconnectedBlockTransactions::DisconnectedBlockTransactions(size_t max_mem_usage)\n+    : m_max_mem_usage{max_mem_usage} {}\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};\n+        auto emplace_result = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(emplace_result.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358463515",
      "id" : 1358463515,
      "in_reply_to_id" : 1356806566,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-IIb",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676818773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358463515/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T16:16:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358463515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358476196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358476196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added Thanks",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-13T16:16:28Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <core_memusage.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1358476196",
      "id" : 1358476196,
      "in_reply_to_id" : 1356794101,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Q-LOk",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 6,
      "original_position" : 7,
      "original_start_line" : 5,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1676836228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358476196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-13T16:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1358476196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Force pushed https://github.com/bitcoin/bitcoin/commit/225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272 to 8faa980089\r\n- Dropped the first two commits.\r\n- Added missing include in `kernel/disconnected_transactions.cpp`.\r\n- Updated  https://github.com/bitcoin/bitcoin/pull/28385#discussion_r1346498993 to destructure and capture the result of the emplace then assert.\r\n- Move the `kernel/disconnected_transactions.cpp` constructor back to header.\r\n- Removed the early return in [src/test/disconnected_transactions.cpp](https://github.com/bitcoin/bitcoin/pull/28530/files#diff-3cd57ed0ff682b234d9991ad80eaf492edd9f4b01f9ea822d6344fee0eac183f) since it passes on 32 bit.\r\n- Added a comment https://github.com/bitcoin/bitcoin/pull/28530/files#diff-3cd57ed0ff682b234d9991ad80eaf492edd9f4b01f9ea822d6344fee0eac183f to explain how `ENTRY_USAGE_OVERESTIMATE` is calculated.\r\n- Updated PR OP.\r\n\r\n",
      "created_at" : "2023-10-13T16:29:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1761790362",
      "id" : 1761790362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585pAsma",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761790362/reactions"
      },
      "updated_at" : "2023-10-13T16:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761790362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK the first 3 commits. I'll pass on re-reviewing the test commit and confusing myself about memory accounting again :)",
      "created_at" : "2023-10-13T18:52:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1762037778",
      "id" : 1762037778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585pBpAS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762037778/reactions"
      },
      "updated_at" : "2023-10-13T18:52:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762037778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360652324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360652324"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: we don't mention these `// for ...` usage statements because they are cumbersome to maintain manually",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-16T13:16:32Z",
      "diff_hunk" : "@@ -0,0 +1,88 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <assert.h> // for assert",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360652324",
      "id" : 1360652324,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII585RGegk",
      "original_commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 5,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360652324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360652324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360656141"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360656141"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also, we generally first include the \"own\" header, then the project headers, then the stdlib headers, so that would mean:\r\n\r\n```cpp\r\n#include <kernel/disconnected_transactions.h>\r\n\r\n#include <assert.h>\r\n#include <core_memusage.h>\r\n#include <memusage.h>\r\n#include <primitives/transaction.h>\r\n#include <util/hasher.h>\r\n\r\n#include <memory>\r\n#include <utility>\r\n```",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-16T13:19:34Z",
      "diff_hunk" : "@@ -0,0 +1,88 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <assert.h> // for assert",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360656141",
      "id" : 1360656141,
      "in_reply_to_id" : 1360652324,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII585RGfcN",
      "original_commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 5,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360656141/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360656141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360662329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360662329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is not a move-only change (list initialization). Same [here](https://github.com/bitcoin/bitcoin/pull/28530/commits/6d1948a08cc1a4792d77e3de6820754e5dc67698#diff-c453a52b2f97617d542ca32879371edc366fbef85d4e9cbc39bea1762959bce9R84) and [here](https://github.com/bitcoin/bitcoin/pull/28530/commits/6d1948a08cc1a4792d77e3de6820754e5dc67698#diff-c453a52b2f97617d542ca32879371edc366fbef85d4e9cbc39bea1762959bce9R65-R67). You can check this yourself by inspecting the commit with `--color-moved=zebra  --color-moved-ws=\"allow-indentation-change\"`. Would revert the list initialization change.",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-16T13:24:20Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <assert.h> // for assert\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <memory>     // for __shared_ptr_access, shared_ptr\n+#include <memusage.h> // for DynamicUsage\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+#include <utility> // for move, pair\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1360662329",
      "id" : 1360662329,
      "line" : 51,
      "node_id" : "PRRC_kwDOABII585RGg85",
      "original_commit_id" : "6d1948a08cc1a4792d77e3de6820754e5dc67698",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : 51,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360662329/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 50,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360662329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363744503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363744503"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In combination with [the fix suggested here](https://github.com/bitcoin/bitcoin/pull/28385#discussion_r1363659227), what do you think about this?\r\n\r\nIt makes all the assumptions explicit in code (except for the pointers which are documented in docstring). It also removes the safety margin. I think we can leave that out until/if we observe it causing issues, e.g. on certain platforms?\r\n\r\n<details>\r\n<summary>git diff on 8faa9800891c8b3eaef051ad9f0dc4d61475cebe</summary>\r\n\r\n```diff\r\ndiff --git a/src/test/disconnected_transactions.cpp b/src/test/disconnected_transactions.cpp\r\nindex b488866a37..bae9850de9 100644\r\n--- a/src/test/disconnected_transactions.cpp\r\n+++ b/src/test/disconnected_transactions.cpp\r\n@@ -34,10 +34,14 @@ BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\r\n \r\n     // Our overall formula is unordered map overhead + usage per entry.\r\n     // Implementations may vary, but we're trying to guess the usage of data structures:\r\n-    // list: per entry x (2 pointers (next pointer and prev pointer) + element itself, which is a CTransactionRef)\r\n-    // unordered map: hashtable overhead + per entry x (3 pointers + value itself, which is an iterator)\r\n-    // Usage per entry is thus approximately `TX_USAGE` + 6 pointers. Add another 2 pointers as a safety margin.\r\n-    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\r\n+    const size_t ENTRY_USAGE_OVERESTIMATE{\r\n+        TX_USAGE\r\n+        // list entry: 2 pointers (next pointer and prev pointer) + element itself\r\n+        + memusage::MallocUsage((2 * sizeof(void*)) + sizeof(decltype(block_vtx)::value_type))\r\n+        // unordered map: 1 pointer for the hashtable + key and value\r\n+        + memusage::MallocUsage(sizeof(void*) + sizeof(decltype(temp_map)::key_type)\r\n+                                + sizeof(decltype(temp_map)::value_type))\r\n+    };\r\n \r\n     // DisconnectedBlockTransactions that's just big enough for 1 transaction.\r\n     {\r\n\r\n```\r\n<details>",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-18T12:02:38Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363744503",
      "id" : 1363744503,
      "in_reply_to_id" : 1356863523,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII585RSRb3",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 40,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 40,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363744503/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363744503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363785879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363785879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, that makes sense. I didn't understand what the alternative was or what the allocation referred to exactly, so here's a suggestion to make this more explicit:\r\n```\r\n        // Add just 2 (and not all 100) transactions to keep the unordered map's hashtable overhead\r\n        // to a minimum and avoid all (instead of all but 1) transactions getting evicted\r\n```",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-18T12:22:02Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363785879",
      "id" : 1363785879,
      "in_reply_to_id" : 1356870250,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585RSbiX",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 45,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 45,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363785879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363785879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363790049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363790049"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's fine to have just a single test commit here. Testing the interface just could use a separate test from the memory management test.",
      "commit_id" : "8faa9800891c8b3eaef051ad9f0dc4d61475cebe",
      "created_at" : "2023-10-18T12:23:35Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAP_1 + ENTRY_USAGE_OVERESTIMATE);\n+\n+        // Only 1 transaction can be kept\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+        // Transactions are added from back to front and eviction is FIFO.\n+        BOOST_CHECK_EQUAL(block_vtx.at(1), evicted_txns.front());\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions with a comfortable maximum memory usage so that nothing is evicted.\n+    // Record usage so we can check size limiting in the next test.\n+    size_t usage_full{0};\n+    {\n+        const size_t USAGE_100_OVERESTIMATE{MAP_100 + ENTRY_USAGE_OVERESTIMATE * 100};\n+        DisconnectedBlockTransactions disconnectpool{USAGE_100_OVERESTIMATE};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK_EQUAL(evicted_txns.size(), 0);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= USAGE_100_OVERESTIMATE);\n+\n+        usage_full = disconnectpool.DynamicMemoryUsage();\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions that's just a little too small for all of the transactions.\n+    {\n+        const size_t MAX_MEMUSAGE_99{usage_full - sizeof(void*)};\n+        DisconnectedBlockTransactions disconnectpool{MAX_MEMUSAGE_99};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAX_MEMUSAGE_99);\n+\n+        // Only 1 transaction needed to be evicted\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+\n+        // Transactions are added from back to front and eviction is FIFO.\n+        // The last transaction of block_vtx should be the first to be evicted.\n+        BOOST_CHECK_EQUAL(block_vtx.back(), evicted_txns.front());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1363790049",
      "id" : 1363790049,
      "in_reply_to_id" : 1357036001,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII585RScjh",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 85,
      "original_position" : 84,
      "original_start_line" : 82,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 85,
      "pull_request_review_id" : 1679965520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363790049/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 83,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T12:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363790049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364161799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364161799"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added together with a clarification comment that we should overestimate if their is issues on other platform",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:18:51Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364161799",
      "id" : 1364161799,
      "in_reply_to_id" : 1356863523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RT3UH",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 40,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685532670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364161799/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:19:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364161799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364164143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364164143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added thank you.",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:19:57Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364164143",
      "id" : 1364164143,
      "in_reply_to_id" : 1356870250,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RT34v",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 45,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685536155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364164143/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:19:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364164143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364166193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364166193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed the test, I will like to limit this to `disconnectpool_memory_limits` test.",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:21:11Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAP_1 + ENTRY_USAGE_OVERESTIMATE);\n+\n+        // Only 1 transaction can be kept\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+        // Transactions are added from back to front and eviction is FIFO.\n+        BOOST_CHECK_EQUAL(block_vtx.at(1), evicted_txns.front());\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions with a comfortable maximum memory usage so that nothing is evicted.\n+    // Record usage so we can check size limiting in the next test.\n+    size_t usage_full{0};\n+    {\n+        const size_t USAGE_100_OVERESTIMATE{MAP_100 + ENTRY_USAGE_OVERESTIMATE * 100};\n+        DisconnectedBlockTransactions disconnectpool{USAGE_100_OVERESTIMATE};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK_EQUAL(evicted_txns.size(), 0);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= USAGE_100_OVERESTIMATE);\n+\n+        usage_full = disconnectpool.DynamicMemoryUsage();\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions that's just a little too small for all of the transactions.\n+    {\n+        const size_t MAX_MEMUSAGE_99{usage_full - sizeof(void*)};\n+        DisconnectedBlockTransactions disconnectpool{MAX_MEMUSAGE_99};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAX_MEMUSAGE_99);\n+\n+        // Only 1 transaction needed to be evicted\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+\n+        // Transactions are added from back to front and eviction is FIFO.\n+        // The last transaction of block_vtx should be the first to be evicted.\n+        BOOST_CHECK_EQUAL(block_vtx.back(), evicted_txns.front());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364166193",
      "id" : 1364166193,
      "in_reply_to_id" : 1357036001,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585RT4Yx",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 88,
      "original_position" : 84,
      "original_start_line" : 82,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 88,
      "pull_request_review_id" : 1685539305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364166193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 86,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364166193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364167270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364167270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks removed",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:21:45Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <assert.h> // for assert\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <memory>     // for __shared_ptr_access, shared_ptr\n+#include <memusage.h> // for DynamicUsage\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+#include <utility> // for move, pair\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(*queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it{vtx.rbegin()}; block_it != vtx.rend(); ++block_it) {\n+        auto it{queuedTx.insert(queuedTx.end(), *block_it)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364167270",
      "id" : 1364167270,
      "in_reply_to_id" : 1360662329,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RT4pm",
      "original_commit_id" : "6d1948a08cc1a4792d77e3de6820754e5dc67698",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : 50,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685541032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364167270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364167270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364195945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364195945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't know how useful this comment is. For `ENTRY_USAGE_ESTIMATE`, we're just hardcoding how we calculate things in `memusage`, so this should always match, I think? I'd be fine removing it tbh.",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:36:53Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    // Our overall formula is unordered map overhead + usage per entry.\n+    // Implementations may vary, but we're trying to guess the usage of data structures.\n+    // No safety margin is added. It is assumed that this is an accurate guess. If this\n+    // estimate causes issues on other platforms, then we may consider adding an additional\n+    // pointer as safety margin.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364195945",
      "id" : 1364195945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RT_pp",
      "original_commit_id" : "3c00943bb7c3b7dcb7fb5485a9b4ef6a04221fa0",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : 35,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685593150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364195945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:40:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364195945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364196987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364196987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're not adding it in a new test, I would leave it in here, it's a useful check.",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:37:33Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    if (sizeof(void*) != 8) {\n+        BOOST_TEST_MESSAGE(\"Exiting disconnected_transactions memory usage test early due to unsupported arch\");\n+    }\n+\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    const size_t ENTRY_USAGE_OVERESTIMATE{TX_USAGE + 8 * memusage::MallocUsage(sizeof(void*))};\n+\n+    // DisconnectedBlockTransactions that's just big enough for 1 transaction.\n+    {\n+        DisconnectedBlockTransactions disconnectpool{MAP_1 + ENTRY_USAGE_OVERESTIMATE};\n+        // Just 2 transactions because the allocation depends on the number of txns passed in.\n+        std::vector<CTransactionRef> two_txns({block_vtx.at(0), block_vtx.at(1)});\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(two_txns);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAP_1 + ENTRY_USAGE_OVERESTIMATE);\n+\n+        // Only 1 transaction can be kept\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+        // Transactions are added from back to front and eviction is FIFO.\n+        BOOST_CHECK_EQUAL(block_vtx.at(1), evicted_txns.front());\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions with a comfortable maximum memory usage so that nothing is evicted.\n+    // Record usage so we can check size limiting in the next test.\n+    size_t usage_full{0};\n+    {\n+        const size_t USAGE_100_OVERESTIMATE{MAP_100 + ENTRY_USAGE_OVERESTIMATE * 100};\n+        DisconnectedBlockTransactions disconnectpool{USAGE_100_OVERESTIMATE};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK_EQUAL(evicted_txns.size(), 0);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= USAGE_100_OVERESTIMATE);\n+\n+        usage_full = disconnectpool.DynamicMemoryUsage();\n+\n+        disconnectpool.clear();\n+    }\n+\n+    // DisconnectedBlockTransactions that's just a little too small for all of the transactions.\n+    {\n+        const size_t MAX_MEMUSAGE_99{usage_full - sizeof(void*)};\n+        DisconnectedBlockTransactions disconnectpool{MAX_MEMUSAGE_99};\n+        auto evicted_txns = disconnectpool.AddTransactionsFromBlock(block_vtx);\n+        BOOST_CHECK(disconnectpool.DynamicMemoryUsage() <= MAX_MEMUSAGE_99);\n+\n+        // Only 1 transaction needed to be evicted\n+        BOOST_CHECK_EQUAL(1, evicted_txns.size());\n+\n+        // Transactions are added from back to front and eviction is FIFO.\n+        // The last transaction of block_vtx should be the first to be evicted.\n+        BOOST_CHECK_EQUAL(block_vtx.back(), evicted_txns.front());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364196987",
      "id" : 1364196987,
      "in_reply_to_id" : 1357036001,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585RT_57",
      "original_commit_id" : "225c9c3b25d24d0f8e7730fc17ae6a7b49a2b272",
      "original_line" : 88,
      "original_position" : 84,
      "original_start_line" : 82,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : 88,
      "pull_request_review_id" : 1685593150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364196987/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 86,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:40:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364196987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364202305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364202305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think you meant to remove this? It reverts f4254e209801d6a790b5f0c251c0b32154a4e3cc",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T16:40:29Z",
      "diff_hunk" : "@@ -51,9 +51,8 @@ size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n     iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n     for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n         auto it = queuedTx.insert(queuedTx.end(), *block_it);\n-        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n-        assert(inserted); // callers may never pass multiple transactions with the same txid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364202305",
      "id" : 1364202305,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RUBNB",
      "original_commit_id" : "73ed6fc0537650731cbf7c27636b3aaf8b6fec0c",
      "original_line" : 55,
      "original_position" : 14,
      "original_start_line" : 54,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685593150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364202305/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T16:40:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364202305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364240492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364240492"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T17:06:43Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    // Our overall formula is unordered map overhead + usage per entry.\n+    // Implementations may vary, but we're trying to guess the usage of data structures.\n+    // No safety margin is added. It is assumed that this is an accurate guess. If this\n+    // estimate causes issues on other platforms, then we may consider adding an additional\n+    // pointer as safety margin.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364240492",
      "id" : 1364240492,
      "in_reply_to_id" : 1364195945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RUKhs",
      "original_commit_id" : "3c00943bb7c3b7dcb7fb5485a9b4ef6a04221fa0",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : 35,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685667792,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364240492/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T17:06:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364240492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364241363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364241363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "interactive rebase mistake, fixed in latest push.",
      "commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "created_at" : "2023-10-18T17:07:23Z",
      "diff_hunk" : "@@ -51,9 +51,8 @@ size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n     iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n     for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n         auto it = queuedTx.insert(queuedTx.end(), *block_it);\n-        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n-        assert(inserted); // callers may never pass multiple transactions with the same txid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1364241363",
      "id" : 1364241363,
      "in_reply_to_id" : 1364202305,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RUKvT",
      "original_commit_id" : "73ed6fc0537650731cbf7c27636b3aaf8b6fec0c",
      "original_line" : 55,
      "original_position" : 14,
      "original_start_line" : 54,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1685668921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364241363/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-10-18T17:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364241363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365538646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365538646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: f4254e209801d6a790b5f0c251c0b32154a4e3cc has a docstring but 070f172a877a7c03fec5c9b1a032106b9a80b329 removes it:\r\n\r\n```suggestion\r\n        assert(inserted); // callers may never pass multiple transactions with the same txid\r\n```\r\n\r\ntip to avoid these issues is to run through your commits one-by-one especially after doing rebase operations etc, it's a pretty common mistake",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T13:28:03Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <assert.h>\n+#include <core_memusage.h>\n+#include <memusage.h>\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+\n+#include <memory>\n+#include <utility>\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n+        auto it = queuedTx.insert(queuedTx.end(), *block_it);\n+        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(inserted);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365538646",
      "id" : 1365538646,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZHdW",
      "original_commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1687744024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365538646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T13:32:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365538646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365542799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365542799"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: exceeds line length",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T13:30:29Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    // Our overall formula is unordered map overhead + usage per entry.\n+    // Implementations may vary, but we're trying to guess the usage of data structures.\n+    const size_t ENTRY_USAGE_ESTIMATE{\n+        TX_USAGE\n+        // list entry: 2 pointers (next pointer and prev pointer) + element itself\n+        + memusage::MallocUsage((2 * sizeof(void*)) + sizeof(decltype(block_vtx)::value_type))\n+        // unordered map: 1 pointer for the hashtable + key and value\n+        + memusage::MallocUsage(sizeof(void*) + sizeof(decltype(temp_map)::key_type) + sizeof(decltype(temp_map)::value_type))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365542799",
      "id" : 1365542799,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZIeP",
      "original_commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "original_line" : 42,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1687744024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365542799/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T13:32:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365542799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365694028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365694028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, will avoid.",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T14:57:18Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <assert.h>\n+#include <core_memusage.h>\n+#include <memusage.h>\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+\n+#include <memory>\n+#include <utility>\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n+        auto it = queuedTx.insert(queuedTx.end(), *block_it);\n+        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(inserted);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365694028",
      "id" : 1365694028,
      "in_reply_to_id" : 1365538646,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZtZM",
      "original_commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1687982436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365694028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T14:57:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365694028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365695297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365695297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin-core-review-club/bitcoin/tree/pr28368/contrib/devtools#clang-format-diffpy\r\nIt was short before but contributor guide clang format e9906c105dffbb864e8c5f7680334480cdd19cd9\r\nmade the line longer?",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T14:58:03Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <boost/test/unit_test.hpp>\n+#include <core_memusage.h>\n+#include <kernel/disconnected_transactions.h>\n+#include <test/util/setup_common.h>\n+\n+BOOST_FIXTURE_TEST_SUITE(disconnected_transactions, TestChain100Setup)\n+\n+//! Tests that DisconnectedBlockTransactions limits its own memory properly\n+BOOST_AUTO_TEST_CASE(disconnectpool_memory_limits)\n+{\n+    // Use the coinbase transactions from TestChain100Setup. It doesn't matter whether these\n+    // transactions would realistically be in a block together, they just need distinct txids and\n+    // uniform size for this test to work.\n+    std::vector<CTransactionRef> block_vtx(m_coinbase_txns);\n+    BOOST_CHECK_EQUAL(block_vtx.size(), 100);\n+\n+    // Roughly estimate sizes to sanity check that DisconnectedBlockTransactions::DynamicMemoryUsage\n+    // is within an expected range.\n+\n+    // Overhead for the hashmap depends on number of buckets\n+    std::unordered_map<uint256, CTransaction*, SaltedTxidHasher> temp_map;\n+    temp_map.reserve(1);\n+    const size_t MAP_1{memusage::DynamicUsage(temp_map)};\n+    temp_map.reserve(100);\n+    const size_t MAP_100{memusage::DynamicUsage(temp_map)};\n+\n+    const size_t TX_USAGE{RecursiveDynamicUsage(block_vtx.front())};\n+    for (const auto& tx : block_vtx)\n+        BOOST_CHECK_EQUAL(RecursiveDynamicUsage(tx), TX_USAGE);\n+\n+    // Our overall formula is unordered map overhead + usage per entry.\n+    // Implementations may vary, but we're trying to guess the usage of data structures.\n+    const size_t ENTRY_USAGE_ESTIMATE{\n+        TX_USAGE\n+        // list entry: 2 pointers (next pointer and prev pointer) + element itself\n+        + memusage::MallocUsage((2 * sizeof(void*)) + sizeof(decltype(block_vtx)::value_type))\n+        // unordered map: 1 pointer for the hashtable + key and value\n+        + memusage::MallocUsage(sizeof(void*) + sizeof(decltype(temp_map)::key_type) + sizeof(decltype(temp_map)::value_type))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365695297",
      "id" : 1365695297,
      "in_reply_to_id" : 1365542799,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZttB",
      "original_commit_id" : "e9906c105dffbb864e8c5f7680334480cdd19cd9",
      "original_line" : 42,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1687984250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365695297/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T14:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365695297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365709045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365709045"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm this didn't get cherry-picked properly from https://github.com/stickies-v/bitcoin/commit/87f3f28b3acfc329eaed0b0cce6ff589271bfefd#diff-daf5057c112d6ec1338dd535558cd0f4e21e9a3e0241b610d88068fe2baba362R113 , probably because of rebase?",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T15:07:32Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <assert.h>\n+#include <core_memusage.h>\n+#include <memusage.h>\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+\n+#include <memory>\n+#include <utility>\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n+        auto it = queuedTx.insert(queuedTx.end(), *block_it);\n+        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(inserted); // callers may never pass multiple transactions with the same txid\n+        cachedInnerUsage += RecursiveDynamicUsage(*block_it);\n+    }\n+    return LimitMemoryUsage();\n+}\n+\n+void DisconnectedBlockTransactions::removeForBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    // Short-circuit in the common case of a block being added to the tip\n+    if (queuedTx.empty()) {\n+        return;\n+    }\n+    for (const auto& tx : vtx) {\n+        auto iter = iters_by_txid.find(tx->GetHash());\n+        if (iter != iters_by_txid.end()) {\n+            auto list_iter = iter->second;\n+            iters_by_txid.erase(iter);\n+            cachedInnerUsage -= RecursiveDynamicUsage(**list_iter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365709045",
      "id" : 1365709045,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZxD1",
      "original_commit_id" : "2c4089559196e8263fa16d55bd85a920530eb382",
      "original_line" : 72,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1688005954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365709045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T15:07:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365709045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365722351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365722351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, fixed.",
      "commit_id" : "9b3da70bd06b45482e7211aa95637a72bd115553",
      "created_at" : "2023-10-19T15:17:20Z",
      "diff_hunk" : "@@ -0,0 +1,90 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <kernel/disconnected_transactions.h>\n+\n+#include <assert.h>\n+#include <core_memusage.h>\n+#include <memusage.h>\n+#include <primitives/transaction.h>\n+#include <util/hasher.h>\n+\n+#include <memory>\n+#include <utility>\n+\n+// It's almost certainly a logic bug if we don't clear out queuedTx before\n+// destruction, as we add to it while disconnecting blocks, and then we\n+// need to re-process remaining transactions to ensure mempool consistency.\n+// For now, assert() that we've emptied out this object on destruction.\n+// This assert() can always be removed if the reorg-processing code were\n+// to be refactored such that this assumption is no longer true (for\n+// instance if there was some other way we cleaned up the mempool after a\n+// reorg, besides draining this object).\n+DisconnectedBlockTransactions::~DisconnectedBlockTransactions()\n+{\n+    assert(queuedTx.empty());\n+    assert(iters_by_txid.empty());\n+    assert(cachedInnerUsage == 0);\n+}\n+\n+std::vector<CTransactionRef> DisconnectedBlockTransactions::LimitMemoryUsage()\n+{\n+    std::vector<CTransactionRef> evicted;\n+\n+    while (!queuedTx.empty() && DynamicMemoryUsage() > m_max_mem_usage) {\n+        evicted.emplace_back(queuedTx.front());\n+        cachedInnerUsage -= RecursiveDynamicUsage(queuedTx.front());\n+        iters_by_txid.erase(queuedTx.front()->GetHash());\n+        queuedTx.pop_front();\n+    }\n+    return evicted;\n+}\n+\n+size_t DisconnectedBlockTransactions::DynamicMemoryUsage() const\n+{\n+    return cachedInnerUsage + memusage::DynamicUsage(iters_by_txid) + memusage::DynamicUsage(queuedTx);\n+}\n+\n+[[nodiscard]] std::vector<CTransactionRef> DisconnectedBlockTransactions::AddTransactionsFromBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    iters_by_txid.reserve(iters_by_txid.size() + vtx.size());\n+    for (auto block_it = vtx.rbegin(); block_it != vtx.rend(); ++block_it) {\n+        auto it = queuedTx.insert(queuedTx.end(), *block_it);\n+        auto [_, inserted] = iters_by_txid.emplace((*block_it)->GetHash(), it);\n+        assert(inserted); // callers may never pass multiple transactions with the same txid\n+        cachedInnerUsage += RecursiveDynamicUsage(*block_it);\n+    }\n+    return LimitMemoryUsage();\n+}\n+\n+void DisconnectedBlockTransactions::removeForBlock(const std::vector<CTransactionRef>& vtx)\n+{\n+    // Short-circuit in the common case of a block being added to the tip\n+    if (queuedTx.empty()) {\n+        return;\n+    }\n+    for (const auto& tx : vtx) {\n+        auto iter = iters_by_txid.find(tx->GetHash());\n+        if (iter != iters_by_txid.end()) {\n+            auto list_iter = iter->second;\n+            iters_by_txid.erase(iter);\n+            cachedInnerUsage -= RecursiveDynamicUsage(**list_iter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#discussion_r1365722351",
      "id" : 1365722351,
      "in_reply_to_id" : 1365709045,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RZ0Tv",
      "original_commit_id" : "2c4089559196e8263fa16d55bd85a920530eb382",
      "original_line" : 72,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/kernel/disconnected_transactions.cpp",
      "position" : null,
      "pull_request_review_id" : 1688027402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28530",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365722351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T15:17:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365722351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "\r\n> edit: PR description needs updating, would change title to `tests, bugfix` and add the bugfix in the description, as well as the \"assume duplicate transactions are not added to `iters_by_txid`\" commit\r\n\r\nThank you @stickies-v , I updated the PR description and address review comments.\r\n",
      "created_at" : "2023-10-19T16:44:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28530#issuecomment-1771360048",
      "id" : 1771360048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28530",
      "node_id" : "IC_kwDOABII585plM8w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771360048/reactions"
      },
      "updated_at" : "2023-10-19T16:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771360048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   }
]
