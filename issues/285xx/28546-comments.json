[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28546).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1751333090) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#27307](https://github.com/bitcoin/bitcoin/pull/27307) (wallet: track mempool conflicts with wallet transactions by ishaanam)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-09-27T17:22:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1737800496",
      "id" : 1737800496,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585nlLsw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737800496/reactions"
      },
      "updated_at" : "2023-10-24T03:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737800496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 3bb306142b7a66c8727bd19e8f0fb72c582bcdc2 -> e03b0fe72a8b1034e5221c8aed6fb31ddd056603 ([`pr/mig.1`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.1) -> [`pr/mig.2`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/mig.1..pr/mig.2)) just adding code comment",
      "created_at" : "2023-09-28T17:45:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739760491",
      "id" : 1739760491,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585nsqNr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739760491/reactions"
      },
      "updated_at" : "2023-09-28T17:45:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739760491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hmm, I wonder if we should instead make both the watchonly and solvables wallets with empty contexts (no chain), and then reload them when migration is done? That would also solve this problem.",
      "created_at" : "2023-09-28T18:04:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739785283",
      "id" : 1739785283,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585nswRD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739785283/reactions"
      },
      "updated_at" : "2023-09-28T18:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739785283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Hmm, I wonder if we should instead make both the watchonly and solvables wallets with empty contexts (no chain), and then reload them when migration is done? That would also solve this problem.\r\n\r\nYes, that would be less fragile than the current approach. Also I'm not sure why the main wallet needs to be created with an empty context anyway. It seems like the best solution would just be to create all the wallets normally and not need to reload any of them.\r\n\r\nI do think the other changes in this PR make sense no matter how this issue is fixed, though. And I like that the fix implemented in this PR (0648dbbe092169b488e4db0d385aaa9d2726ddfe) is just a one line change.",
      "created_at" : "2023-09-28T18:29:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739817232",
      "id" : 1739817232,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585ns4EQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739817232/reactions"
      },
      "updated_at" : "2023-09-28T18:29:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739817232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated e03b0fe72a8b1034e5221c8aed6fb31ddd056603 -> dbed701d75a4a55cb34d797cfbae6910075ebec0 ([`pr/mig.2`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.2) -> [`pr/mig.3`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.3), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/mig.2..pr/mig.3)) fixing a comment typo",
      "created_at" : "2023-09-28T18:42:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739834527",
      "id" : 1739834527,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585ns8Sf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739834527/reactions"
      },
      "updated_at" : "2023-09-28T18:42:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739834527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Yes, that would be less fragile than the current approach. Also I'm not sure why the main wallet needs to be created with an empty context anyway. It seems like the best solution would just be to create all the wallets normally and not need to reload any of them.\r\n\r\nIt has an empty context so that there isn't any possibility for an inconsistent state if a block and transaction is found.",
      "created_at" : "2023-09-28T18:48:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739840995",
      "id" : 1739840995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585ns93j",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739840995/reactions"
      },
      "updated_at" : "2023-09-28T18:48:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739840995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It has an empty context so that there isn't any possibility for an inconsistent state if a block and transaction is found.\r\n\r\nI see, so a way to prevent the wallet from changing while it is being migrated.\r\n\r\nIn that case, I think building all the wallets offline and then reloading them like you suggested does make sense. Would be happy to review a PR if you have an idea of how to implement that. (Feel free to take any changes from this PR if they'd be useful. Or we could fix the bug directly with this PR and then make the change the loading in a later PR.)",
      "created_at" : "2023-09-28T19:12:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1739869439",
      "id" : 1739869439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585ntEz_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739869439/reactions"
      },
      "updated_at" : "2023-09-28T19:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739869439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK dbed701d75a4a55cb34d797cfbae6910075ebec0",
      "created_at" : "2023-10-06T19:52:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1751333090",
      "id" : 1751333090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585oYzji",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751333090/reactions"
      },
      "updated_at" : "2023-10-06T19:52:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751333090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28546#discussion_r1350322154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28546"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350322154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "not really for this PR but.. shouldn't we also need to transfer the other wtx members too?\r\nLike `mapValue` (for the \"replaced_by_txid\" and \"replaces_txid\"), `nTimeReceived`, `nTimeSmart`, `fFromMe`.",
      "commit_id" : "dbed701d75a4a55cb34d797cfbae6910075ebec0",
      "created_at" : "2023-10-09T13:37:44Z",
      "diff_hunk" : "@@ -3908,6 +3894,15 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n             if (data.watchonly_wallet) {\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n+                    // Need to update WalletTx state before moving the\n+                    // transaction from the main wallet to the watchonly wallet,\n+                    // because the main wallet is an offline wallet created with\n+                    // a dummy context, and doesn't know heights of confirmed\n+                    // and conflicted blocks (values are set to -1). Calling\n+                    // updateState will look up missing height values so the\n+                    // watchonly wallet can function correctly after the\n+                    // migration without needing to be reloaded.\n+                    wtx->updateState(data.watchonly_wallet->chain());\n                     // Add to watchonly wallet\n                     if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#discussion_r1350322154",
      "id" : 1350322154,
      "line" : 3907,
      "node_id" : "PRRC_kwDOABII585QfEfq",
      "original_commit_id" : "dbed701d75a4a55cb34d797cfbae6910075ebec0",
      "original_line" : 3907,
      "original_position" : 50,
      "original_start_line" : 3905,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 1664474576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28546",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350322154/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3905,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-09T13:38:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350322154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I believe we can move to #28609, it fixes this issue and others in a more comprehensive manner.",
      "created_at" : "2023-10-11T14:12:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1757785542",
      "id" : 1757785542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585oxa3G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757785542/reactions"
      },
      "updated_at" : "2023-10-11T14:12:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757785542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removing from the 26.0 milestone in favor of #28609.",
      "created_at" : "2023-10-23T14:36:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1775350701",
      "id" : 1775350701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585p0bOt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1775350701/reactions"
      },
      "updated_at" : "2023-10-23T14:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1775350701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased dbed701d75a4a55cb34d797cfbae6910075ebec0 -> f06016d77d848133fc6568f287bb86b644c9fa69 ([`pr/mig.3`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.3) -> [`pr/mig.4`](https://github.com/ryanofsky/bitcoin/commits/pr/mig.4), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/mig.3-rebase..pr/mig.4)) due to conflict with #28609. Also dropped commit cdd66441a0dddefe566da480a7015dbae299b4bb which is no longer neccessary after #28609.\r\n\r\nAlso updated title and PR description since the original bug was fixed #28609, and now this PR is just adding asserts and cleanup to prevent related bugs. Original description was:\r\n\r\n>**bugfix: watchonly wallets created after migration have incorrect height values**\r\n>\r\n>During migration, `CWalletTx` objects that no longer belong to the migrated wallet are moved to a watchonly wallet. But because the migrated wallet is offline (has null `m_chain`), the `confirmed_block_height` and `conflicting_block_height` values in these transactions are -1. These values need to be updated before they are moved to the watchonly wallet, because the watchonly wallet is online, and remains loaded after the migration is complete. Not updating these values could lead to the watchonly wallet returning incorrect information and potentially triggering assert failures.\r\n>\r\n>The problem is only temporary since the height values would be refreshed the next time the watchonly wallet is loaded, but it is worth fixing to avoid unpredictable behavior.\r\n>\r\n>Noticed while reviewing #28542, and looking for other cases where negative confirmed_block_height and conflicting_block_height values might be used.\r\n>\r\n>An easy way to test this bug is to revert the bugfix in the second commit. Then the assert added in the third commit will trigger a crash when `getwalletinfo` is called in [`wallet_migration.py`](https://github.com/bitcoin/bitcoin/blob/c9f288244b8d183e09a917025922b99e3368ef78/test/functional/wallet_migration.py#L250)",
      "created_at" : "2023-10-23T22:15:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1776107120",
      "id" : 1776107120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585p3T5w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776107120/reactions"
      },
      "updated_at" : "2023-10-23T23:35:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776107120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do you think the first commit is still necessary? I'm not seeing a reason for doing it when no other piece of code will use it.\r\n\r\nI think the first commit is useful to make it clear that some of the CWalletTx fields aren't serialized in the wallet and need to be loaded separately from the blocks database, and to have one function responsible for loading them. Otherwise the fields are just set conditionally in LoadToWallet away from the rest of transaction state code. The new function could also be useful in the future if we want to add more fields to transaction objects to improve conflict tracking, or if we want to add features that avoid keeping all transactions in memory. It's also a move-only change that should be easy to review.",
      "created_at" : "2023-10-23T23:45:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1776226893",
      "id" : 1776226893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585p3xJN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776226893/reactions"
      },
      "updated_at" : "2023-10-23T23:45:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776226893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Wouldn't be clearer to move the non-serialized members to optional?\r\n> \r\n> But other than that, what make some noise on me about the approach is that we would be \"hiding\" a `cs_main` locking cause. Because `chain.findBlock()` locks the mutex internally. Which, I know that it is currently not really important, but maybe in the future we would like to batch calls that lock `cs_main` as much as possible in the wallet.\r\n\r\nVery much agree it makes sense to make locking and lookups explicit, and this change helps that, doesn't hurt it. It moves lookups to a function that explicitly is meant to do lookups, and explicitly takes a Chain parameter and doesn't have access to other wallet state. (CWalletTx used to have a CWallet* backpointer, but this was removed in b11a195ef450bd138aa03204a5e74fdd3ddced26 to force this explicitness.) The current block lookup code before this PR is in the middle of a `CWallet::LoadToWallet` function which is messier and is able to do the lookup because it has full access to the monolithic CWallet class.\r\n\r\nTaking your batching example, if you wanted to look up the block heights as a batch, instead of between loading each transaction, this change gets closer to that goal, because it moves the lookup code out of the per-transaction LoadToWallet to function to a separate function exactly like you would do if you were making that change.\r\n\r\nOn your first idea of making heights use std::optional instead of -1 when they are uninitialized, that would be a fine change but it would not make code more explicit or improve code organization, so I see it as being more shallow. It would be complementary though.",
      "created_at" : "2023-10-24T21:31:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1778073410",
      "id" : 1778073410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585p-z9C",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778073410/reactions"
      },
      "updated_at" : "2023-10-24T21:31:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778073410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> (CWalletTx used to have a CWallet* backpointer, but this was removed in https://github.com/bitcoin/bitcoin/commit/b11a195ef450bd138aa03204a5e74fdd3ddced26 to force this explicitness.)\r\n\r\nThanks for that. Looks ugly.\r\n\r\n> Taking your batching example, if you wanted to look up the block heights as a batch, instead of between loading each transaction, this change gets closer to that goal, because it moves the lookup code out of the per-transaction LoadToWallet to function to a separate function exactly like you would do if you were making that change.\r\n\r\nIn this example, I'm not sure if I would place it inside `transaction.h`. I would rather keep that file exclusively for primitive data.\r\nThis way, we can avoid providing access to the chain interface class (or to its declaration) in places that shouldn't have access to it, such as the `walletdb.cpp` loading process. The function wouldn't be member of `CWalletTx`; It would probably take the chain + a vector of wtx references for updating.\r\n\r\nedit:\r\nstill.. thinking it further, `walletdb.cpp` will continue having access to the chain interface class because it includes `wallet.h`..\r\nso, cross that point out.",
      "created_at" : "2023-10-24T22:53:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28546#issuecomment-1778179422",
      "id" : 1778179422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28546",
      "node_id" : "IC_kwDOABII585p_N1e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778179422/reactions"
      },
      "updated_at" : "2023-10-24T23:07:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778179422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
