[
   {
      "author_association" : "MEMBER",
      "body" : "Requested by @MarcoFalke @sdaftuar and @theuni . Review very much appreciated :pray: ",
      "created_at" : "2020-09-07T17:18:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688444546",
      "id" : 688444546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ0NDU0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:18:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688444546",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is currently not possible to not have `node.peerman`. I think an `Ensure..()` like `EnsureMempool` would be good. It doesn't really make sense to call `getpeerinfo` without a peerman anyway?",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-07T17:25:02Z",
      "diff_hunk" : "@@ -156,7 +156,10 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n     for (const CNodeStats& stats : vstats) {\n         UniValue obj(UniValue::VOBJ);\n         CNodeStateStats statestats;\n-        bool fStateStats = GetNodeStateStats(stats.nodeid, statestats);\n+        bool fStateStats{false};\n+        if (node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529215",
      "id" : 484529215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyOTIxNQ==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 483673436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529215",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats);\r\n```\r\n\r\nnit for new code",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-07T17:25:42Z",
      "diff_hunk" : "@@ -93,7 +126,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      */\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message);\n \n+    /** Get statistics from node state */\n+    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529374",
      "id" : 484529374,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyOTM3NA==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 130,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483673436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529374",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've done something slightly different and checked existence at the top of this function. Let me know what you think.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-07T18:08:44Z",
      "diff_hunk" : "@@ -156,7 +156,10 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n     for (const CNodeStats& stats : vstats) {\n         UniValue obj(UniValue::VOBJ);\n         CNodeStateStats statestats;\n-        bool fStateStats = GetNodeStateStats(stats.nodeid, statestats);\n+        bool fStateStats{false};\n+        if (node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537675",
      "id" : 484537675,
      "in_reply_to_id" : 484529215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzNzY3NQ==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 483681660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537675",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed. Thanks!",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-07T18:09:37Z",
      "diff_hunk" : "@@ -93,7 +126,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      */\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message);\n \n+    /** Get statistics from node state */\n+    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537830",
      "id" : 484537830,
      "in_reply_to_id" : 484529374,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzNzgzMA==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 130,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483681814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537830",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-07T18:34:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688467825",
      "id" : 688467825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ2NzgyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T18:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688467825",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: decoupling is good!",
      "created_at" : "2020-09-07T19:23:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688482583",
      "id" : 688482583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4MjU4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688482583",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "322e87b6039877ed3457baea93cc87d78f3f4d96\r\n```suggestion\r\n     * by the m_peer_mutex. Once a shared pointer reference is\r\n```",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T09:36:28Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */\n+    Mutex m_peer_mutex;\n+    /**\n+     * Map of all Peer objects, keyed by peer id. This map is protected\n+     * by the global m_peer_mutex. Once a shared pointer reference is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785195",
      "id" : 484785195,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NTE5NQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 184,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483963562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785195",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "322e87b6039877ed3457baea93cc87d78f3f4d96\r\nnit: This comment duplicates the code :) Consider to drop it.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T09:37:33Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785821",
      "id" : 484785821,
      "line" : 199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NTgyMQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 199,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 78,
      "pull_request_review_id" : 483963562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785821",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484816918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484816918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good catch. Fixed.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T10:32:10Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */\n+    Mutex m_peer_mutex;\n+    /**\n+     * Map of all Peer objects, keyed by peer id. This map is protected\n+     * by the global m_peer_mutex. Once a shared pointer reference is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484816918",
      "id" : 484816918,
      "in_reply_to_id" : 484785195,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNjkxOA==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 184,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 484004756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484816918",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484817325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484817325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Normally I'd agree with removing unnecessary commenting, but I think it's useful for every member variable to have a doxygen comment. Happy to go either way if others think it should be dropped.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T10:32:57Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484817325",
      "id" : 484817325,
      "in_reply_to_id" : 484785821,
      "line" : 199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNzMyNQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 199,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 78,
      "pull_request_review_id" : 484005300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484817325",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484838191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484838191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm for keeping it, it's better for consistency to have a comment for every one.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T11:14:10Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484838191",
      "id" : 484838191,
      "in_reply_to_id" : 484785821,
      "line" : 199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzODE5MQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 199,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 78,
      "pull_request_review_id" : 484031953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484838191",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484981819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484981819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does it change something if  this check is moved above at the `m_context->connman` level ? You may save one more control flow.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T14:50:47Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484981819",
      "id" : 484981819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4MTgxOQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : null,
      "pull_request_review_id" : 484220356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484981819",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484983468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484983468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a bit confusing to have `GetNodeStateStats` which is actually a member of `PeerManager`, and still have a `CNodeState`, even if inside this function you effectively fetch it. Maybe rename `GetNodeProcessingStats` ?",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T14:52:56Z",
      "diff_hunk" : "@@ -953,7 +953,7 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n+bool PeerManager::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484983468",
      "id" : 484983468,
      "line" : 855,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4MzQ2OA==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 855,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 107,
      "pull_request_review_id" : 484220356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484983468",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485038136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485038136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Does it change something if this check is moved above at the `m_context->connman` level ? You may save one more control flow.\r\n\r\nWhy increase code block with locked `::cs_main`?",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T16:10:25Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485038136",
      "id" : 485038136,
      "in_reply_to_id" : 484981819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzODEzNg==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : null,
      "pull_request_review_id" : 484293681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485038136",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485039519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485039519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the name right now is fine. It's getting stats related to the node's state.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T16:12:40Z",
      "diff_hunk" : "@@ -953,7 +953,7 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n+bool PeerManager::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485039519",
      "id" : 485039519,
      "in_reply_to_id" : 484983468,
      "line" : 855,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzOTUxOQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 855,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 107,
      "pull_request_review_id" : 484295439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485039519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485048559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485048559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Does it change something if this check is moved above at the m_context->connman level ? You may save one more control flow.\r\n\r\nYes, it's a try lock. It's possible that we're not able to take the lock, and therefore that we're not able to get the node state stats, but we'd still get the node stats. If we move the try above the m_context->connman level, then if we couldn't get the cs_main lock, we wouldn't be able to get any stats.\r\n\r\nEventually, none of the statistics should require cs_main, so the try lock can be removed entirely.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-08T16:27:09Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485048559",
      "id" : 485048559,
      "in_reply_to_id" : 484981819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA0ODU1OQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : null,
      "pull_request_review_id" : 484306707,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485048559",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-09T08:14:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-689404986",
      "id" : 689404986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTQwNDk4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T08:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689404986",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20295 (rpc: getblockfrompeer by Sjors)\n* #20217 (net: Remove g_relay_txes by jnewbery)\n* #19858 (Periodically make block-relay connections and sync headers by sdaftuar)\n* #19829 (net processing: Move block inventory state to net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:46:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-695215523",
      "id" : 695215523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxNTUyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-07T20:21:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695215523",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r493008783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/493008783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using ```GetPeerRef()``` with an encapsulated lock for ```m_peer_map```, then manually locking the private mutex 3 lines later looks strange. It also requires two locks... all the drawbacks of mutex encapsulation without exploiting the benefits :)\r\n\r\nSince misbehavior changes to the peer will go unobserved after this point anyway, why not just take and remove with a single lock?\r\n\r\nSomething like (untested):\r\n```c++\r\nPeerRef PeerManager::RemovePeer(NodeId id)\r\n{\r\n    PeerRef ret;\r\n    {\r\n        LOCK(m_peer_mutex);\r\n        auto it = m_peer_map.find(id);\r\n        if (it != m_peer_map.end()) {\r\n            ret = std::move(it->second);\r\n            m_peer_map.erase(it);\r\n        }\r\n    }\r\n    return ret;\r\n}\r\n```",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-22T20:19:54Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r493008783",
      "id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwODc4Mw==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 493814969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/493008783",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494167048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494167048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that's much better. Thank you!\r\n\r\nI've implemented this within `GetPeerRef()` to avoid the code duplication, and also added another commit that tidies up `FinalizeNode()` a bit more. Let me know what you think.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-24T09:22:04Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494167048",
      "id" : 494167048,
      "in_reply_to_id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2NzA0OA==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 495380221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494167048",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494218405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494218405"
         }
      },
      "author_association" : "MEMBER",
      "body" : "EDIT: The comment below is wrong. I introduced a different bug when implementing this as Cory points out below.\r\n\r\n~oops. There's a bug in the code above which caused this to fail. You can't move the shared_ptr out of the map and then erase it. More precisely, I think something like the following is happening:~\r\n\r\n- ~`ret = std::move(it->second);` means `ret` is reset to be a shared pointer to `Peer`. It steals the refcount from `it->second`, since `std::move(it->second)` is an rvalue. `std::move` doesn't do anything to the map entry.~\r\n- ~the entry is then erased from the map, decrementing the refcount to zero and destructing the `Peer` object.~\r\n\r\n~Removing the `std::move` fixed this.~",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-24T10:50:37Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494218405",
      "id" : 494218405,
      "in_reply_to_id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxODQwNQ==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 495445622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494218405",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494574969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494574969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This undoes this assumption: https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467079107 , which I'm still not convinced is a good idea.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-24T19:56:15Z",
      "diff_hunk" : "@@ -864,23 +864,18 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n-    fUpdateConnectionTime = false;\n+    PeerRef peer = RemovePeer(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494574969",
      "id" : 494574969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NDk2OQ==",
      "original_commit_id" : "658ca700ffc4ccb92df6a7b69df7a0a25fb82094",
      "original_line" : 867,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 495905693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494574969",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494816208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494816208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, removed that commit",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-09-25T08:01:09Z",
      "diff_hunk" : "@@ -864,23 +864,18 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n-    fUpdateConnectionTime = false;\n+    PeerRef peer = RemovePeer(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r494816208",
      "id" : 494816208,
      "in_reply_to_id" : 494574969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNjIwOA==",
      "original_commit_id" : "658ca700ffc4ccb92df6a7b69df7a0a25fb82094",
      "original_line" : 867,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 496195024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/494816208",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499749803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is really uninteresting minutia, but @jnewbery and I happened to get into a discussion/debate about it today so I'm following up with details. Everyone else can safely ignore this as boring.\r\n\r\nI don't believe the comment above is correct. If removing the ```std::move``` helps, I'm wondering if there might be another issue causing problems.\r\n\r\n> - ret = std::move(it->second); means ret is reset to be a shared pointer to Peer. It steals the refcount from it->second, since std::move(it->second) is an rvalue. std::move doesn't do anything to the map entry.\r\n\r\nIndeed ```std::move``` doesn't do anything to the map entry as it's essentially just a cast, but the ```operator=``` does likely (definitely?) reset it.\r\nSee [libc++'s implementation of shared_ptr's move assignment operator](https://github.com/llvm/llvm-project/blob/master/libcxx/include/memory#L3967), which [calls the move constructor](https://github.com/llvm/llvm-project/blob/master/libcxx/include/memory#L3845), where the rhs is null'd.\r\n\r\n\r\n> - the entry is then erased from the map, decrementing the refcount to zero and destructing the Peer object.\r\n\r\nWe can write a quick test to see that the refcount never hits zero after removal from the map, that copy vs. move refcounts are different as we would expect them to be, and that a shared_ptr moved from a map's value is still safe to use:\r\n```c++\r\n#include <cassert>\r\n#include <cstdio>\r\n#include <map>\r\n#include <memory>\r\n#include <string>\r\n\r\nstatic std::shared_ptr<std::string> copytest()\r\n{\r\n    std::map<char, std::shared_ptr<std::string> > foo;\r\n    foo.emplace('c', std::make_shared<std::string>(\"hello\"));\r\n    auto it = foo.find('c');\r\n    std::shared_ptr<std::string> ret;\r\n    if (it != foo.end()) {\r\n        assert(it->second.use_count() == 1);\r\n        ret = it->second;\r\n        assert(it->second != nullptr); // <------------------\r\n        assert(ret.use_count() == 2);  // <------------------\r\n        foo.erase(it);\r\n        assert(ret.use_count() == 1);\r\n    }\r\n    return ret;\r\n}\r\n\r\nstatic std::shared_ptr<std::string> movetest()\r\n{\r\n    std::map<char, std::shared_ptr<std::string> > foo;\r\n    foo.emplace('c', std::make_shared<std::string>(\"world\"));\r\n    auto it = foo.find('c');\r\n    std::shared_ptr<std::string> ret;\r\n    if (it != foo.end()) {\r\n        assert(it->second.use_count() == 1);\r\n        ret = std::move(it->second);\r\n        assert(it->second == nullptr); // <------------------\r\n        assert(ret.use_count() == 1);  // <------------------\r\n        foo.erase(it);\r\n        assert(ret.use_count() == 1);\r\n    }\r\n    return ret;\r\n}\r\n\r\nint main()\r\n{\r\n    auto copyptr = copytest();\r\n    assert(copyptr.use_count() == 1);\r\n    auto moveptr = movetest();\r\n    assert(moveptr.use_count() == 1);\r\n\r\n    printf(\"%s %s!\\n\", copyptr->c_str(), moveptr->c_str());\r\n}\r\n```\r\n\r\nNote that this doesn't actually prove that the map itself is still in working order after the move+removal, but I don't see why that should break anything.\r\n\r\nLastly, we have cases in our code where we move from a map's value. One example: https://github.com/bitcoin/bitcoin/blob/master/src/net.cpp#L1012\r\n\r\n**tl;dr**: If moving a ```shared_ptr``` out of a mapped value causes a problem that a copy doesn't, we should make sure to understand why and potentially audit other places where we do it as well.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-10-05T17:12:29Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499749803",
      "id" : 499749803,
      "in_reply_to_id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0OTgwMw==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502258906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749803",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499754354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499754354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Aha, I think I found the problem. From your previous version of this commit:\r\n```c++\r\n...\r\n    if (it != m_peer_map.end()) {\r\n        ret = std::move(it->second);\r\n        if (erase) m_peer_map.erase(it);\r\n    }\r\n    return ret;\r\n```\r\nMoving only makes sense when erasing.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-10-05T17:20:28Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499754354",
      "id" : 499754354,
      "in_reply_to_id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1NDM1NA==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502264735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499754354",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499806616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499806616"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is (mostly) a style preference, but I'm not a fan of adding a boolean option to substantially change the functionality of a function as opposed to just creating two functions. GetPeerRef() is logically a read-only operation.\r\n\r\nIt's also easier easy to slip up and make mistakes like this one: https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499754354 ;)",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-10-05T18:58:20Z",
      "diff_hunk" : "@@ -909,11 +907,16 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id, bool erase)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r499806616",
      "id" : 499806616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwNjYxNg==",
      "original_commit_id" : "2ce2ec188a4cb163ff77f2834a9e401cbee53995",
      "original_line" : 910,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502334736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499806616",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r501585667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501585667"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed, the failure was caused by that. Sorry for the noise (and for casting aspersions on your code!)",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-10-08T09:42:05Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r501585667",
      "id" : 501585667,
      "in_reply_to_id" : 493008783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4NTY2Nw==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 504605754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501585667",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r501605336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501605336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You got me. I've made it a separate function.\r\n\r\n> GetPeerRef() is logically a read-only operation.\r\n\r\nGood point. I've made it `const` (and made the mutex `mutable`)\r\n",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-10-08T10:13:28Z",
      "diff_hunk" : "@@ -909,11 +907,16 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id, bool erase)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r501605336",
      "id" : 501605336,
      "in_reply_to_id" : 499806616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNTMzNg==",
      "original_commit_id" : "2ce2ec188a4cb163ff77f2834a9e401cbee53995",
      "original_line" : 910,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 504630812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501605336",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @theuni. I've addressed your comment.",
      "created_at" : "2020-10-08T10:13:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-705473240",
      "id" : 705473240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNTQ3MzI0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-08T10:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/705473240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-19T02:49:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-711480474",
      "id" : 711480474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTQ4MDQ3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T02:49:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711480474",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-10-19T08:10:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-711808191",
      "id" : 711808191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTgwODE5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T08:10:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711808191",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-11-19T11:14:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-730303039",
      "id" : 730303039,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDMwMzAzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T11:14:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730303039",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-01T09:43:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-736358591",
      "id" : 736358591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjM1ODU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T09:43:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736358591",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-12-01T11:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-736503375",
      "id" : 736503375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjUwMzM3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T11:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736503375",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-02T13:15:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-737223455",
      "id" : 737223455,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzIyMzQ1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-02T13:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737223455",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r535077391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535077391"
         }
      },
      "author_association" : "MEMBER",
      "body" : "aedd418fed7abfd00cc731bd57ed5b013259eb5a\r\n\r\nTo be precise, it may return an [empty](https://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr) shared pointer rather `nullptr`.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-03T10:35:44Z",
      "diff_hunk" : "@@ -143,6 +143,10 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      *  May return nullptr if the Peer object can't be found. */\n     PeerRef GetPeerRef(NodeId id) const;\n \n+    /** Get a shared pointer to the Peer object and remove it from m_peer_map.\n+     *  May return nullptr if the Peer object can't be found. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r535077391",
      "id" : 535077391,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3NzM5MQ==",
      "original_commit_id" : "aedd418fed7abfd00cc731bd57ed5b013259eb5a",
      "original_line" : 147,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 543818354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535077391",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r535083417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535083417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6bfcef3797d4d105180e325033929684f84cfc08\r\n\r\nWhy are these changes required? What are benefits to return an empty shared pointer instead `nullptr`-constructed one? Btw, in all caller places the return value is checked for `nullptr`, not being empty.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-03T10:41:08Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r535083417",
      "id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4MzQxNw==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 543818354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535083417",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code Review ACK aedd418\r\n\r\n-----\r\n\r\nPrivate members >> Anon-namespaced statics/functions\r\n\r\nEspecially when the functionality is strongly intertwined with the class of which it's being made a member.",
      "created_at" : "2020-12-03T16:39:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-738126619",
      "id" : 738126619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczODEyNjYxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-03T16:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/738126619",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536045568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536045568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-04T11:53:32Z",
      "diff_hunk" : "@@ -143,6 +143,10 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      *  May return nullptr if the Peer object can't be found. */\n     PeerRef GetPeerRef(NodeId id) const;\n \n+    /** Get a shared pointer to the Peer object and remove it from m_peer_map.\n+     *  May return nullptr if the Peer object can't be found. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536045568",
      "id" : 536045568,
      "in_reply_to_id" : 535077391,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NTU2OA==",
      "original_commit_id" : "aedd418fed7abfd00cc731bd57ed5b013259eb5a",
      "original_line" : 147,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 544893589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536045568",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536045912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536045912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This makes is clear that NRVO can be used, since there's only one return statement. I'm not sure if the previous version would have used copy elision.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-04T11:54:11Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536045912",
      "id" : 536045912,
      "in_reply_to_id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NTkxMg==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 544894037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536045912",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and addressed outstanding review comments.",
      "created_at" : "2020-12-04T11:55:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-738743686",
      "id" : 738743686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczODc0MzY4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-04T11:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/738743686",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536049347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536049347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This also avoids duplicate lookup on m_peer_map :+1:",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-04T12:00:18Z",
      "diff_hunk" : "@@ -790,11 +790,9 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n-        PeerRef peer = GetPeerRef(nodeid);\n+        PeerRef peer = RemovePeer(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536049347",
      "id" : 536049347,
      "line" : 793,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0OTM0Nw==",
      "original_commit_id" : "5a1f08ce1f4d49fe85b8571cd5da1b1096339a89",
      "original_line" : 793,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 75,
      "pull_request_review_id" : 544898224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536049347",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536140554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536140554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a little awkward because of the comment in RemovePeer:\r\n```c++\r\n/** Get a shared pointer to the Peer object and remove it from m_peer_map.\r\n *  May return an empty shared_ptr if the Peer object can't be found. */\r\n```\r\nMight be worth of a comment explaining that _at this point_ the peer is guaranteed to exist, but not afterwards. Then again, that's kinda what the assert means. Shrug.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-04T14:31:58Z",
      "diff_hunk" : "@@ -842,11 +790,9 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n-        PeerRef peer = GetPeerRef(nodeid);\n+        PeerRef peer = RemovePeer(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536140554",
      "id" : 536140554,
      "line" : 794,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MDU1NA==",
      "original_commit_id" : "4fe77ae9aab73d8de6c40d504e079e30eff45f91",
      "original_line" : 794,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 545008571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536140554",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536156231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536156231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "+1 for considering this!\r\n\r\nI'd be curious to know if compilers are allowed to rearrange the code before deciding how many return statements there are. I could see this going either way.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-04T14:54:20Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536156231",
      "id" : 536156231,
      "in_reply_to_id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1NjIzMQ==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 545028349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536156231",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536646781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536646781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Considering the before-change code, to be precise, in C++17 in a return statement, when the operand is a prvalue (the result of the ternary conditional expression), elision of copy/move operations is [mandatory](https://en.cppreference.com/w/cpp/language/copy_elision).\r\n\r\nOTOH, NRVO is non-mandatory.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-05T10:08:10Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r536646781",
      "id" : 536646781,
      "in_reply_to_id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjY0Njc4MQ==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 545575187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/536646781",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537453217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537453217"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @hebasto! Yes, I think you're right. If I'm reading it correctly, the result of the conditional operator is a prvalue (item 5 in https://en.cppreference.com/w/cpp/language/operator_other#Conditional_operator since 4 doesn't apply), and copy elision is mandatory for returning a prvalue.\r\n\r\nI've reverted this.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-07T12:02:33Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537453217",
      "id" : 537453217,
      "in_reply_to_id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzIxNw==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 546083773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:02:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537453217",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537454856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537454856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> ... and copy elision is mandatory for returning a prvalue.\r\n\r\nGood to have C++17 :)",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-07T12:05:13Z",
      "diff_hunk" : "@@ -835,11 +835,13 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-PeerRef PeerManager::GetPeerRef(NodeId id)\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n {\n+    PeerRef ret;\n     LOCK(m_peer_mutex);\n     auto it = m_peer_map.find(id);\n-    return it != m_peer_map.end() ? it->second : nullptr;\n+    if (it != m_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537454856",
      "id" : 537454856,
      "in_reply_to_id" : 535083417,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NDg1Ng==",
      "original_commit_id" : "6bfcef3797d4d105180e325033929684f84cfc08",
      "original_line" : 842,
      "original_position" : 12,
      "original_start_line" : 840,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 546085750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:05:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537454856",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537458391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537458391"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, I think it's ok for now. Happy to change this if you decide you feel more strongly about it.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-07T12:11:13Z",
      "diff_hunk" : "@@ -842,11 +790,9 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n-        PeerRef peer = GetPeerRef(nodeid);\n+        PeerRef peer = RemovePeer(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537458391",
      "id" : 537458391,
      "in_reply_to_id" : 536140554,
      "line" : 794,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODM5MQ==",
      "original_commit_id" : "4fe77ae9aab73d8de6c40d504e079e30eff45f91",
      "original_line" : 794,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 546089823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-07T12:11:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537458391",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @hebasto @promag @theuni and @dongcarl. I've addressed all comments, so this should now be ready for re-review.",
      "created_at" : "2020-12-07T12:12:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-739880094",
      "id" : 739880094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczOTg4MDA5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-07T12:12:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/739880094",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537460651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537460651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54\r\nI'm curios is it possible to force the mandatory copy/move elision for the return value here as well?",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2020-12-07T12:15:18Z",
      "diff_hunk" : "@@ -887,7 +833,26 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n+PeerRef PeerManager::GetPeerRef(NodeId id) const\n+{\n+    LOCK(m_peer_mutex);\n+    auto it = m_peer_map.find(id);\n+    return it != m_peer_map.end() ? it->second : nullptr;\n+}\n+\n+PeerRef PeerManager::RemovePeer(NodeId id)\n+{\n+    PeerRef ret;\n+    LOCK(m_peer_mutex);\n+    auto it = m_peer_map.find(id);\n+    if (it != m_peer_map.end()) {\n+        ret = std::move(it->second);\n+        m_peer_map.erase(it);\n+    }\n+    return ret;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r537460651",
      "id" : 537460651,
      "line" : 853,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MDY1MQ==",
      "original_commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "original_line" : 853,
      "original_position" : 105,
      "original_start_line" : 843,
      "path" : "src/net_processing.cpp",
      "position" : 105,
      "pull_request_review_id" : 546092494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : 843,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-07T12:15:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537460651",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Re-ACK 3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54.",
      "created_at" : "2020-12-08T19:23:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-740894306",
      "id" : 740894306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MDg5NDMwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-08T19:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/740894306",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re-ACK 3025ca9\r\n\r\n-----\r\n\r\n1. Disambiguated between nullptr and empty shared_ptr\r\n2. Reverted refactoring in PeerManager::GetPeerRef\r\n3. Made `Peer` constructor `explicit`",
      "created_at" : "2020-12-09T13:11:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-741760526",
      "id" : 741760526,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTc2MDUyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T13:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741760526",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r708937645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708937645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm getting bitcoind crashing due to this assert. It appears that sometimes FinalizeNode gets called twice (from DeleteNode()). Perhaps nRefCount is being increased between the two occurances. This only seems to happen though when there's a delay between them due to UpdateTip(). It's probably a bug I've introduced somewhere, but just leaving this comment as a \"heads up\".",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2021-09-15T08:00:08Z",
      "diff_hunk" : "@@ -842,11 +790,9 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n-        PeerRef peer = GetPeerRef(nodeid);\n+        PeerRef peer = RemovePeer(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r708937645",
      "id" : 708937645,
      "line" : 794,
      "node_id" : "PRRC_kwDOABII584qQYet",
      "original_commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "original_line" : 794,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 754789488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T08:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708937645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "node_id" : "MDQ6VXNlcjE1MzAyODM=",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r709030496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709030496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. I expect if the bug was present in master we'd have seen it in CI or from a user report.",
      "commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "created_at" : "2021-09-15T09:54:54Z",
      "diff_hunk" : "@@ -842,11 +790,9 @@ void PeerManager::FinalizeNode(const CNode& node, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n-        PeerRef peer = GetPeerRef(nodeid);\n+        PeerRef peer = RemovePeer(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r709030496",
      "id" : 709030496,
      "in_reply_to_id" : 708937645,
      "line" : 794,
      "node_id" : "PRRC_kwDOABII584qQvJg",
      "original_commit_id" : "3025ca9e7743d9b96c22e9c6ed7ef051dcea7e54",
      "original_line" : 794,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 754910612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T09:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709030496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
