[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r485866325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485866325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit bc872e44e29f7108720072a7d37ce06fb069ba4f: Doesn't it make more sense to pass it as `this` (i.e. make it a member function)?\r\n\r\nI've done that in #19909 (commit facd88a77189f6953d28a6743e0c68175bc18f9e)\r\n\r\nConceptually it makes little sense for chainman to be optional. Why would you want to run a node with validation disabled? So, if you don't like to make it a member function, I'd say to at least pass it as reference.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-09T19:36:08Z",
      "diff_hunk" : "@@ -1559,7 +1559,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 chainman.m_total_coinstip_cache = nCoinCacheUsage;\n                 chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n-                UnloadBlockIndex(node.mempool.get());\n+                UnloadBlockIndex(node.mempool.get(), &chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r485866325",
      "id" : 485866325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2NjMyNQ==",
      "original_commit_id" : "bc872e44e29f7108720072a7d37ce06fb069ba4f",
      "original_line" : 1562,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 485345020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485866325",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK; helps reduce globals, supports fuzzing.",
      "created_at" : "2020-09-09T19:57:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-689786686",
      "id" : 689786686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTc4NjY4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T19:57:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689786686",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-10T00:55:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-689904588",
      "id" : 689904588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTkwNDU4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-10T00:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689904588",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r486483452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486483452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think in this particular instance, I prefer the latter solution of passing `chainman` as a reference, simply because `UnloadBlockIndex` touches so many validation globals that are not owned by `chainman`. Perhaps in the future when we move those globals into `chainman` or some other validation-container class, it would make more sense to do so.\r\n\r\nI was worried about callers (to `UnloadBlockIndex`) who only have a pointer to `chainman`, but the only caller I see that only has a pointer to `chainman` is `~TestingSetup`, and it already looks like it makes the assumption that `m_node.chainman` is not null (see the `m_node.chainman->Reset()` line in `~TestingSetup`). Will make the change and take a look at your PR too.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-10T16:38:34Z",
      "diff_hunk" : "@@ -1559,7 +1559,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 chainman.m_total_coinstip_cache = nCoinCacheUsage;\n                 chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n-                UnloadBlockIndex(node.mempool.get());\n+                UnloadBlockIndex(node.mempool.get(), &chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r486483452",
      "id" : 486483452,
      "in_reply_to_id" : 485866325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MzQ1Mg==",
      "original_commit_id" : "bc872e44e29f7108720072a7d37ce06fb069ba4f",
      "original_line" : 1562,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 486118979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486483452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Move the doxygen comments here (this comment made sense when it was next to a forward declaration, but now that the declaration is in the header file, it should have the doxygen comment)",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-13T17:42:19Z",
      "diff_hunk" : "@@ -407,6 +407,12 @@ class BlockManager {\n     /** Create a new block index entry for a given block hash */\n     CBlockIndex* InsertBlockIndex(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Mark one block file as pruned (modify associated database entries)\n+    void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    // See definition for documentation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556665",
      "id" : 487556665,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjY2NQ==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 413,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487326578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556665",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did you consider moving this logic to the `BlockManager` dtor instead of here? There's only ever one `BlockManager` instance (inside `ChainstateManager`), so destruction will happen at the same time. All the logic in this function is on `BlockManager` data.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-13T17:44:02Z",
      "diff_hunk" : "@@ -914,6 +917,15 @@ class ChainstateManager\n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    ~ChainstateManager() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556828",
      "id" : 487556828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjgyOA==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 921,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487326578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556828",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove useless comment.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-13T17:44:24Z",
      "diff_hunk" : "@@ -914,6 +917,15 @@ class ChainstateManager\n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    ~ChainstateManager() {\n+        // block headers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556868",
      "id" : 487556868,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1Njg2OA==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 922,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487326578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556868",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        for (auto it = BlockIndex().begin; it != BlockIndex().end(); ++it) {\r\n```",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-13T17:45:07Z",
      "diff_hunk" : "@@ -914,6 +917,15 @@ class ChainstateManager\n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    ~ChainstateManager() {\n+        // block headers\n+        BlockMap::iterator it1 = BlockIndex().begin();\n+        for (; it1 != BlockIndex().end(); it1++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487556989",
      "id" : 487556989,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1Njk4OQ==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 924,
      "original_position" : 40,
      "original_start_line" : 923,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487326578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487556989",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487577035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487577035"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, can't you just call `BlockManager::Unload()` in the `BlockManager` dtor?",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-13T21:02:29Z",
      "diff_hunk" : "@@ -914,6 +917,15 @@ class ChainstateManager\n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    ~ChainstateManager() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r487577035",
      "id" : 487577035,
      "in_reply_to_id" : 487556828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3NzAzNQ==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 921,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487339580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487577035",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I get this warning: \r\n\r\n```\r\nqt/test/apptests.cpp:87:45: warning: passing variable 'g_chainman' by reference requires holding mutex 'cs_main' [-Wthread-safety-reference]\r\n    UnloadBlockIndex(/* mempool */ nullptr, g_chainman);\r\n                                            ^\r\n```\r\n\r\nAnother proposed change: pass as a ref instead (I see this was discussed above).",
      "created_at" : "2020-09-13T22:57:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-691737398",
      "id" : 691737398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MTczNzM5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-13T23:02:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/691737398",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488013284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488013284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved in cdd2063bbe8b8df4db42c81ee7913e2dc0b2387a",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-14T15:15:42Z",
      "diff_hunk" : "@@ -407,6 +407,12 @@ class BlockManager {\n     /** Create a new block index entry for a given block hash */\n     CBlockIndex* InsertBlockIndex(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Mark one block file as pruned (modify associated database entries)\n+    void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    // See definition for documentation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488013284",
      "id" : 488013284,
      "in_reply_to_id" : 487556665,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMzI4NA==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 413,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487878280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488013284",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488013483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488013483"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved in 4668ded6d6ea4299d998abbb57543f37519812e2",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-14T15:15:59Z",
      "diff_hunk" : "@@ -914,6 +917,15 @@ class ChainstateManager\n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    ~ChainstateManager() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488013483",
      "id" : 488013483,
      "in_reply_to_id" : 487556828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMzQ4Mw==",
      "original_commit_id" : "86cb85e77fb960452f904190a3eec892dc7185ef",
      "original_line" : 921,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 487878533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488013483",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you MarcoFalke, jnewbery, and Empact for the code review!\r\n\r\nMarco: `ChainstateManager` is now passed in as a reference in 577ec184bd47b3e88a1d3e60b4d2045bd51328b4\r\njnewbery: Thanks for the detailed review! See the review comments for resolutions\r\nEmpact: Good find. I'm turning on `-Werror=thread-safety` by default now and that particular problem is fixed in 577ec184bd47b3e88a1d3e60b4d2045bd51328b4\r\n\r\n-----\r\n\r\nNote: I will push a commit to remove the comments and assertions in 84d983656f1927955e516a94366b7c216bacded3 once I get the first Code Review ACK.",
      "created_at" : "2020-09-14T15:22:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-692129520",
      "id" : 692129520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MjEyOTUyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-14T15:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692129520",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488599503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488599503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: no need for extra line break.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T11:42:54Z",
      "diff_hunk" : "@@ -3957,22 +3993,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune)\n     }\n }\n \n-/* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */\n-static void FindFilesToPruneManual(ChainstateManager& chainman, std::set<int>& setFilesToPrune, int nManualPruneHeight)\n+void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n {\n     assert(fPruneMode && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (::ChainActive().Tip() == nullptr)\n+    if (chain_tip_height < 0)\n         return;\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488599503",
      "id" : 488599503,
      "line" : 3965,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5OTUwMw==",
      "original_commit_id" : "cdd2063bbe8b8df4db42c81ee7913e2dc0b2387a",
      "original_line" : 3965,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 69,
      "pull_request_review_id" : 488595575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488599503",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488599779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488599779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: when touching lines, fix code to match style guide (here, join the line below with this or add braces)",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T11:43:23Z",
      "diff_hunk" : "@@ -3957,22 +3993,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune)\n     }\n }\n \n-/* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */\n-static void FindFilesToPruneManual(ChainstateManager& chainman, std::set<int>& setFilesToPrune, int nManualPruneHeight)\n+void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n {\n     assert(fPruneMode && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (::ChainActive().Tip() == nullptr)\n+    if (chain_tip_height < 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488599779",
      "id" : 488599779,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5OTc3OQ==",
      "original_commit_id" : "cdd2063bbe8b8df4db42c81ee7913e2dc0b2387a",
      "original_line" : 4001,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 488595575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488599779",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488604129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488604129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree conceptually that UnloadBlockIndex should eventually be a member function of chainman, but also agree that we don't need to do everything in one PR.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T11:50:51Z",
      "diff_hunk" : "@@ -1559,7 +1559,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n                 chainman.m_total_coinstip_cache = nCoinCacheUsage;\n                 chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n-                UnloadBlockIndex(node.mempool.get());\n+                UnloadBlockIndex(node.mempool.get(), &chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488604129",
      "id" : 488604129,
      "in_reply_to_id" : 485866325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYwNDEyOQ==",
      "original_commit_id" : "bc872e44e29f7108720072a7d37ce06fb069ba4f",
      "original_line" : 1562,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 488601128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488604129",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488737959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488737959"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Pass in chainman to UnloadBlockIndex\" (577ec184bd47b3e88a1d3e60b4d2045bd51328b4)\r\n\r\nre: [META] This is a pure refactor commit.\r\n\r\nTrivial: I'd call this \"mostly pure refactor\" instead of \"pure refactor\" because cs_main is no longer released between UnloadBlockIndex and chainstate reset (which I think is nontrivial, closing various coin views)\r\n\r\nAm also curious about origin of `[META]` tags. They seems funny because I'd expect a meta comment in the commit description to be a comment about the commit description (:exploding_head:), not a comment about the commit. Anyway, I like the tags and they seem good for describing changes in a uniform way.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T14:59:46Z",
      "diff_hunk" : "@@ -84,8 +84,11 @@ void AppTests::appTests()\n     // Reset global state to avoid interfering with later tests.\n     LogInstance().DisconnectTestLogger();\n     AbortShutdown();\n-    UnloadBlockIndex(/* mempool */ nullptr);\n-    WITH_LOCK(::cs_main, g_chainman.Reset());\n+    {\n+        LOCK(cs_main);\n+        UnloadBlockIndex(/* mempool */ nullptr, g_chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488737959",
      "id" : 488737959,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODczNzk1OQ==",
      "original_commit_id" : "577ec184bd47b3e88a1d3e60b4d2045bd51328b4",
      "original_line" : 89,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/qt/test/apptests.cpp",
      "position" : 8,
      "pull_request_review_id" : 488777314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488737959",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488746432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488746432"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Move FindFilesToPrune{,Manual} to BlockManager\" (84d983656f1927955e516a94366b7c216bacded3)\r\n\r\nNice way of verifying, and didn't know about std::addressof!",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T15:10:45Z",
      "diff_hunk" : "@@ -2284,14 +2281,53 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // Previously, we called the global function ::ChainActive() in\n+            // FindFilesToPrune{,Manual} to get the tip height and to determine\n+            // whether or not a tip even exists. Now, we are simply passing in\n+            // m_chain.Height() (which returns -1 if the tip doesn't exist). To\n+            // make sure we're not changing behaviour, let's check that\n+            // ::ChainActive() is the same object as m_chain (not just\n+            // identical).\n+            //\n+            // This comment and the following assert will be removed in a\n+            // subsequent commit, as they're just meant to demonstrate\n+            // correctness (you can run tests against it and see that nothing\n+            // exit unexpectedly).\n+            assert(std::addressof(::ChainActive()) == std::addressof(m_chain));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488746432",
      "id" : 488746432,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0NjQzMg==",
      "original_commit_id" : "84d983656f1927955e516a94366b7c216bacded3",
      "original_line" : 2296,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 488777314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488746432",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488874237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488874237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved in fe07ba16511bd119b6ed744e68adfb3210a84254",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T18:23:51Z",
      "diff_hunk" : "@@ -3957,22 +3993,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune)\n     }\n }\n \n-/* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */\n-static void FindFilesToPruneManual(ChainstateManager& chainman, std::set<int>& setFilesToPrune, int nManualPruneHeight)\n+void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n {\n     assert(fPruneMode && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (::ChainActive().Tip() == nullptr)\n+    if (chain_tip_height < 0)\n         return;\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488874237",
      "id" : 488874237,
      "in_reply_to_id" : 488599503,
      "line" : 3965,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NDIzNw==",
      "original_commit_id" : "cdd2063bbe8b8df4db42c81ee7913e2dc0b2387a",
      "original_line" : 3965,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 69,
      "pull_request_review_id" : 488949580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488874237",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488874403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488874403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved in 597ec8a853df20fc68892b5f1131d27a1f2cf0e5",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T18:24:07Z",
      "diff_hunk" : "@@ -3957,22 +3993,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune)\n     }\n }\n \n-/* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */\n-static void FindFilesToPruneManual(ChainstateManager& chainman, std::set<int>& setFilesToPrune, int nManualPruneHeight)\n+void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n {\n     assert(fPruneMode && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (::ChainActive().Tip() == nullptr)\n+    if (chain_tip_height < 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488874403",
      "id" : 488874403,
      "in_reply_to_id" : 488599779,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NDQwMw==",
      "original_commit_id" : "cdd2063bbe8b8df4db42c81ee7913e2dc0b2387a",
      "original_line" : 4001,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 488949768,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488874403",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488876301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488876301"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved in 74f73c783d46b012f375d819e2cd09c792820cd5 (I just removed that comment since \"mostly pure refactor\" isn't too meaningful :smile: \r\n\r\nFor the `[META]` tags, I literally just came up with it randomly, mostly to describe high-level things that apply to the entire commit or things that reference other commits.",
      "commit_id" : "75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-15T18:27:29Z",
      "diff_hunk" : "@@ -84,8 +84,11 @@ void AppTests::appTests()\n     // Reset global state to avoid interfering with later tests.\n     LogInstance().DisconnectTestLogger();\n     AbortShutdown();\n-    UnloadBlockIndex(/* mempool */ nullptr);\n-    WITH_LOCK(::cs_main, g_chainman.Reset());\n+    {\n+        LOCK(cs_main);\n+        UnloadBlockIndex(/* mempool */ nullptr, g_chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#discussion_r488876301",
      "id" : 488876301,
      "in_reply_to_id" : 488737959,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NjMwMQ==",
      "original_commit_id" : "577ec184bd47b3e88a1d3e60b4d2045bd51328b4",
      "original_line" : 89,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/qt/test/apptests.cpp",
      "position" : 8,
      "pull_request_review_id" : 488952177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-15T18:27:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488876301",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Got a [code review ACK](https://github.com/bitcoin/bitcoin/pull/19927#pullrequestreview-488777314), just pushed a version which:\r\n1. Has a [last commit](75142a7bd7890f2e14920dbe9701ada2cbc2326f) which removes the review-only comments + assertions\r\n2. Adds a [style-only commit](597ec8a853df20fc68892b5f1131d27a1f2cf0e5) which makes the code I moved conform to our style guide\r\n\r\nThis is now ready for final review and (hopefully) merge.",
      "created_at" : "2020-09-15T18:30:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-692895586",
      "id" : 692895586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5Mjg5NTU4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-15T18:31:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692895586",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "code review ACK 75142a7bd7890f2e14920dbe9701ada2cbc2326f",
      "created_at" : "2020-09-16T08:20:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-693252979",
      "id" : 693252979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzI1Mjk3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T08:20:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693252979",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19909 (txmempool: Remove unused clear() member function by MarcoFalke)\n* #18731 (refactor: Make CCheckQueue RAII-styled by hebasto)\n* #18710 (Add local thread pool to CCheckQueue by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:42:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-695215048",
      "id" : 695215048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxNTA0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-22T19:49:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695215048",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Previously those methods were private (`static` in a cpp file), so I am a bit worried about exposing them as public member functions to all of Bitcoin Core (rpc, net_processing, ...). \r\n\r\nWhat do you think about turning them `private` again?\r\n\r\nE.g.\r\n\r\n```diff\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex cc5e36acfc..bc9b136039 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -357,7 +357,12 @@ struct CBlockIndexWorkComparator\r\n  * This data is used mostly in `CChainState` - information about, e.g.,\r\n  * candidate tips is not maintained here.\r\n  */\r\n-class BlockManager {\r\n+class BlockManager\r\n+{\r\n+    friend CChainState;\r\n+    void FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height);\r\n+    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, bool is_ibd);\r\n+\r\n public:\r\n     BlockMap m_block_index GUARDED_BY(cs_main);\r\n \r\n@@ -411,24 +416,6 @@ public:\r\n     //! Mark one block file as pruned (modify associated database entries)\r\n     void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n-    /* Calculate the block/rev files to delete based on height specified by user with RPC command pruneblockchain */\r\n-    void FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height);\r\n-    /**\r\n-     * Prune block and undo files (blk???.dat and undo???.dat) so that the disk space used is less than a user-defined target.\r\n-     * The user sets the target (in MB) on the command line or in config file.  This will be run on startup and whenever new\r\n-     * space is allocated in a block or undo file, staying below the target. Changing back to unpruned requires a reindex\r\n-     * (which in this case means the blockchain must be re-downloaded.)\r\n-     *\r\n-     * Pruning functions are called from FlushStateToDisk when the global fCheckForPruning flag has been set.\r\n-     * Block and undo files are deleted in lock-step (when blk00003.dat is deleted, so is rev00003.dat.)\r\n-     * Pruning cannot take place until the longest chain is at least a certain length (100000 on mainnet, 1000 on testnet, 1000 on regtest).\r\n-     * Pruning will never delete a block within a defined distance (currently 288) from the active chain's tip.\r\n-     * The block index is updated by unsetting HAVE_DATA and HAVE_UNDO for any blocks that were stored in the deleted files.\r\n-     * A db flag records the fact that at least some block files have been pruned.\r\n-     *\r\n-     * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\r\n-     */\r\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, bool is_ibd);\r\n     /**\r\n      * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\r\n      * that it doesn't descend from an invalid block, and then add it to m_block_index.\r\n",
      "created_at" : "2020-09-20T08:08:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-695758685",
      "id" : 695758685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTc1ODY4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-20T08:08:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695758685",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cr ACK 75142a7bd7890f2e14920dbe9701ada2cbc2326f \r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\ncr ACK 75142a7bd7890f2e14920dbe9701ada2cbc2326f \r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUhyqwv/eNXZQ6DzY+d3CX83lRRCFbjD3zfjQ0o0dT2SBGnP4oaG6gI+fwzUQacl\r\nZdtAZ3JEhJU6RDFs+gMun19ldVP7SG+RhJAGHRZgNuWzT0VvC/I1USyK/QZ7Rb53\r\nG2Rz7oSIMTZ9X88kVBuBVYPphSalSVKDTwbPoV5tYUn96Z753aG768FS1pop6Lvx\r\nLwFLLVWjN8hpA1UAinh57qIAy9Jr21jA1bGcUG5M8AydqTlwA1pTig80Yktn5cvb\r\nMe9FWSLHqifUHR2Js8TUjwykChul18d/8C9C4kmOynDeH4b+n7nmYFP1Ynrh458X\r\nP71pSb0vcVFK1fXnFFVh3z493Is2vpGxxuZino4RPvK4+53G7fJ41xlL78r+2cRk\r\ngKrBAukJNMM02RRwdQ1W+4jSpcZcf8PHLUNSg7BVOP5AFLcCekvhExVLIJJO9LiS\r\nQ5jNu4OQSVEuoZhjbmoeHQhgPe+lrd3LYWvPtpJveos24+gTNSS3KWFD1IB3QvzK\r\nHIpk9O5/\r\n=izRp\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `3230012495f1048f1411855fc06225652a1358399085dc6b400e304c7f82dadb  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401083230012495f1048f1411855fc06225652a1358399085dc6b400e304c7f82dadbf01013255e7a96728bed9b4f3c17ee1ce96008fff010057b6b712b35e5da800f897e8b9e753a08f1045f670e6ff008d9dec54e95a7ad710083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff0104d400ed7649431e136461dee16a397c808f1045f670e6df0086215af5b970539220083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6dfff0104fe0a6d7756d26a1ad8de59d3e0f835f08f1045f670e6df008fb8f52995c50205e0083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df0107c2543e58756487877c7da29d6ab3c5908f1045f670e6ff0082c828ef742ef5b560083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2020-09-20T08:11:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-695758925",
      "id" : 695758925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTc1ODkyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-20T08:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695758925",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Made `FindFilesToPrune{,Manual}` private per Marco's [comment](https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-695758685).\r\n\r\nPrevious code reviewers: this change can be reviewed with:\r\n\r\n```sh\r\ngit diff 75142a7 72a1d5c\r\n```",
      "created_at" : "2020-09-21T17:35:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-696262568",
      "id" : 696262568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NjI2MjU2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-21T17:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696262568",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 72a1d5c6f3 \r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nre-ACK 72a1d5c6f3 \r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUhTrAv+Ky3GNUn0kO04zX+7dsU23mPYIvAUJ/SRXBtSQID9lNph+93gmf29iMWM\r\n3eOnDT1KhSINP5mHGRX9j4loYTh2VxUE9Hwqzc/em4bfh+QcE/Fyjxx6uArGVZBQ\r\ncYCEwsoQ51nbp9/Yftt2UFQzjjtHXtEGn7KO++u2WDzpOtL8vdxOZTK+e0Xb6Gbd\r\nXJSDGf2D6YeAhElyMETc6TJQ3/E7nHTWurNjXVR/C6EbeeVzrTlaLmGVGUBqWcAf\r\nqcQjVHB3qrQHrXfr+bK6XlSOJ4/60T+Q801mX2AeUK4ygpgcsVpWquaviC1DqzfM\r\nkdrdssVPW9b5yuUM8ciaPxLTiXBqyzKVaUA8Q3CADsQClStA7MOfUItmo9HUs/Lz\r\nVWughvafPFfI+cbHkR3rvvvMcPza12/9sYYfCi+xHfw1CaMnjs5lvDD0Cw4ShGMH\r\nh/vJzV/MFnDquVrg/T1Cam1zkXf3bxGsc7K/mJh3wO99Kgf9X9nlS7Y77eQIeWx2\r\nbzQoIo/G\r\n=9glt\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `bcdea3595c56b92fa07e06e3a4cdb3a9a7439cb78f42e7fcdf109c35f3d1dd79  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e892940108bcdea3595c56b92fa07e06e3a4cdb3a9a7439cb78f42e7fcdf109c35f3d1dd79f0108ff9d29c43c3d6dc694e93253a4531cc08fff0106dae1a5708a642bbde08f35182544b7908f1045f6b952bf0085abce0ed22949f0e0083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6df010c306f28c43b05661189d352bbe487e0008f1045f6b952cf008329198c87a3d41430083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2020-09-23T18:34:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19927#issuecomment-697853851",
      "id" : 697853851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5Nzg1Mzg1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T18:34:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697853851",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
