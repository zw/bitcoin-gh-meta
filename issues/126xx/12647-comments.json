[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This looks fine to me. It looks like the existing leak scenarios are for fatal errors, but more RAII pointer types is good in my opinion.\r\n\r\nIt's kind of weird that you're putting this in a `std::unique_ptr` and then later on giving the raw pointer to a `WalletRescanReserver()`; for that pattern I would have expected to see a `std::shared_ptr`. That being said `WalletRescanReserver()` looks like kind of a mess in general (e.g. it uses a mutex to access `fScanningWallet` in `reserve()`, but not in `isReserved()`).\r\n\r\nutACK 9378d89",
      "created_at" : "2018-03-11T02:26:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#issuecomment-372084114",
      "id" : 372084114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12647",
      "updated_at" : "2018-03-11T02:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372084114",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173665252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173665252"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Use MakeUnique?",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-11T18:57:58Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173665252",
      "id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102892132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173665252",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173665264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173665264"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Release on return?",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-11T18:58:27Z",
      "diff_hunk" : "@@ -4101,7 +4098,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n         LogPrintf(\"mapAddressBook.size() = %u\\n\",  walletInstance->mapAddressBook.size());\n     }\n \n-    return walletInstance;\n+    walletInstance->m_last_block_processed = chainActive.Tip();\n+\n+    CWallet* wallet_ptr = walletInstance.release();\n+    RegisterValidationInterface(wallet_ptr);\n+    return wallet_ptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173665264",
      "id" : 173665264,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102892132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173665264",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173671198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671198"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any particular reason? I did it this way so that it would be released before `RegisterValidationInterface` creates a global reference. Basically, if RegisterValidationInterface failed for some reason, a memory leak is probably better than a segfault. I don't feel too strongly though.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-11T21:51:04Z",
      "diff_hunk" : "@@ -4101,7 +4098,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n         LogPrintf(\"mapAddressBook.size() = %u\\n\",  walletInstance->mapAddressBook.size());\n     }\n \n-    return walletInstance;\n+    walletInstance->m_last_block_processed = chainActive.Tip();\n+\n+    CWallet* wallet_ptr = walletInstance.release();\n+    RegisterValidationInterface(wallet_ptr);\n+    return wallet_ptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173671198",
      "id" : 173671198,
      "in_reply_to_id" : 173665264,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102897769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671198",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@eklitzke Thanks for the review. I think it is OK to use a `unique_ptr` there because `reserver` only exists within the lifetime of `walletInstance` so it will go out of scope before `walletInstance` releases or frees the allocated CWallet.",
      "created_at" : "2018-03-11T23:21:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#issuecomment-372159063",
      "id" : 372159063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12647",
      "updated_at" : "2018-03-11T23:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372159063",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173677594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173677594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why? This is exactly what MakeUnique does, except that this constructs one unique_ptr, whereas `std::unique_ptr<CWallet> walletInstance = MakeUnique<...>(...)` would construct two.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T00:51:21Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173677594",
      "id" : 173677594,
      "in_reply_to_id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102904307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173677594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173678990"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173678990"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why do you say it would construct two?",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T01:19:06Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173678990",
      "id" : 173678990,
      "in_reply_to_id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102905801,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173678990",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173696251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173696251"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MakeUnique` constructs one (the right-hand side), then the left hand side is created using the move constructor.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T05:20:14Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173696251",
      "id" : 173696251,
      "in_reply_to_id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102925560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173696251",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173739323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173739323"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the compiler will optimize the copy initialization. Anyway, there are [several advantages](https://stackoverflow.com/a/37514601) and we are using MakeUnique so that we can replace with std::make_unique when we switch to c++14.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T09:52:32Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173739323",
      "id" : 173739323,
      "in_reply_to_id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102975738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173739323",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173740488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173740488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> RegisterValidationInterface failed for some reason\r\n\r\nWe would want to shutdown no? Anyway leave as it is then.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T09:56:15Z",
      "diff_hunk" : "@@ -4101,7 +4098,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n         LogPrintf(\"mapAddressBook.size() = %u\\n\",  walletInstance->mapAddressBook.size());\n     }\n \n-    return walletInstance;\n+    walletInstance->m_last_block_processed = chainActive.Tip();\n+\n+    CWallet* wallet_ptr = walletInstance.release();\n+    RegisterValidationInterface(wallet_ptr);\n+    return wallet_ptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173740488",
      "id" : 173740488,
      "in_reply_to_id" : 173665264,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 102977037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173740488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173844570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173844570"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, you're right about the compiler optimization. Didn't realize that. http://en.cppreference.com/w/cpp/language/copy_elision",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-12T15:45:48Z",
      "diff_hunk" : "@@ -3929,7 +3929,7 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n \n     int64_t nStart = GetTimeMillis();\n     bool fFirstRun = true;\n-    CWallet *walletInstance = new CWallet(name, CWalletDBWrapper::Create(path));\n+    std::unique_ptr<CWallet> walletInstance(new CWallet(name, CWalletDBWrapper::Create(path)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r173844570",
      "id" : 173844570,
      "in_reply_to_id" : 173665252,
      "original_commit_id" : "9378d89cbb9741493411d61bc1cffa4d02204dc5",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 103100383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173844570",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 7dc50d4. In the future we could move `CreateWalletFromFile` to `CWalletManager` (introduced in #12587).",
      "created_at" : "2018-03-13T14:18:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#issuecomment-372681020",
      "id" : 372681020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12647",
      "updated_at" : "2018-03-13T14:18:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372681020",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r174875670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174875670"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think you want to move the m_last_block_processed line above, because rescan code below will access it.\r\n\r\nI'm also not sure it's a great idea to be moving the `RegisterValidationInterface` call. It may work for now, but create a race condition if we allow loading wallets after node startup (see #10740).\r\n\r\nI think I'd suggest a more limited change than what's implemented here:\r\n\r\n* Creating the wallet above with:\r\n\r\n```c++\r\nauto wallet_deleter = MakeUnique<CWallet>(...);\r\nCWallet* walletInstance = wallet_deleter.get();\r\n```\r\n\r\n* And changing this line to:\r\n\r\n```c++\r\nRegisterValidationInterface(wallet_deleter.release());\r\n```",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-15T17:56:46Z",
      "diff_hunk" : "@@ -4025,9 +4025,6 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n             pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n     }\n \n-    walletInstance->m_last_block_processed = chainActive.Tip();\n-    RegisterValidationInterface(walletInstance);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r174875670",
      "id" : 174875670,
      "original_commit_id" : "7dc50d40c8bd21f96a2e513b76830d381d2271c8",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 104308944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174875670",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r175234932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175234932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't see where `m_last_block_processed` is accessed in the rescan code. It seems to me it's just used to implement `BlockUntilSyncedToCurrentChain`.\r\n\r\nThe RegisterValidationInterface call is tricky. I agree moving it down only works if the wallets are all loaded *before* the Connman starts, as is the case right now, but it would break if wallets are loaded/unloaded via RPC. Once way to handle it could be to call `UnregisterValidationInterface` in the `CWallet` destructor (even without calling `RegisterValidationInterface` in the constructor). In that case, we could leave the register call where it is. What do you think of that?",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-16T23:18:21Z",
      "diff_hunk" : "@@ -4025,9 +4025,6 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n             pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n     }\n \n-    walletInstance->m_last_block_processed = chainActive.Tip();\n-    RegisterValidationInterface(walletInstance);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r175234932",
      "id" : 175234932,
      "in_reply_to_id" : 174875670,
      "original_commit_id" : "7dc50d40c8bd21f96a2e513b76830d381d2271c8",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 104741983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175234932",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r175803851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175803851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r174875670\r\n\r\n> I don't see where m_last_block_processed is accessed in the rescan code. It seems to me it's just used to implement BlockUntilSyncedToCurrentChain.\r\n\r\nYou're right. I misremembered and it should be fine to move this, if that's desirable.\r\n\r\n>  Once way to handle it could be to call UnregisterValidationInterface in the CWallet destructor (even without calling RegisterValidationInterface in the constructor). In that case, we could leave the register call where it is. What do you think of that?\r\n\r\nSeems good. Would fix the immediate problem and also help with dynamic loading.",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-03-20T15:12:19Z",
      "diff_hunk" : "@@ -4025,9 +4025,6 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n             pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n     }\n \n-    walletInstance->m_last_block_processed = chainActive.Tip();\n-    RegisterValidationInterface(walletInstance);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r175803851",
      "id" : 175803851,
      "in_reply_to_id" : 174875670,
      "original_commit_id" : "7dc50d40c8bd21f96a2e513b76830d381d2271c8",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 105393589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-03T03:13:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175803851",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> WalletRescanReserver() looks like kind of a mess in general (e.g. it uses a mutex to access fScanningWallet in reserve(), but not in isReserved()).\r\n\r\nThis should be fine because it's an atomic bool.",
      "created_at" : "2018-03-20T15:16:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#issuecomment-374635862",
      "id" : 374635862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12647",
      "updated_at" : "2018-03-20T15:16:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374635862",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r179790601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179790601"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this doesn't work because UnregisterValidationInterface tries to call virtual methods, which isn't something you can do in c++ in the middle of object destruction. I ran into this problem in #10973\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/0bdf0e330d5d16e8e6a93d7d4ad663db812c4c91/src/interface/chain.cpp#L163-L169\r\n\r\n",
      "commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "created_at" : "2018-04-06T15:17:02Z",
      "diff_hunk" : "@@ -789,6 +789,10 @@ class CWallet final : public CCryptoKeyStore, public CValidationInterface\n \n     ~CWallet()\n     {\n+        // Even if RegisterValidationInstance was never called on this instance,\n+        // the unregister call is safe to make and is a no-op.\n+        UnregisterValidationInterface(this);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12647#discussion_r179790601",
      "id" : 179790601,
      "original_commit_id" : "effd82a08f2bf36b680c84b3929aa8414952f204",
      "original_position" : 6,
      "path" : "src/wallet/wallet.h",
      "position" : 6,
      "pull_request_review_id" : 110103748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12647",
      "updated_at" : "2018-04-06T15:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179790601",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
