{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "As noted in https://github.com/bitcoin/bitcoin/issues/11368 if too many connections are made to the RPC interface, then other code will fail on open(2) syscalls with EMFILE. The result can be that the block database gets into an inconsistent state.\r\n\r\nOn many Linux distributions, by default, each process has 1024 file descriptors; these are shared between open files and network connections. The main init code attempts to apportion them between uses, but neglects to constrain the RPC layer: https://github.com/bitcoin/bitcoin/blob/master/src/init.cpp#L907\r\n\r\nUnfortunately, libevent does not allow a natural way to bound the number of file-descriptors used by the evhttp server. Therefore, we have to resort to requesting to stop new connections by disabling the accept listener in the epoll event structure. This is not a good way to control load, and more connections are accepted until the next epoll cycle is triggered, but it does stop an unbounded number of connections from being created, and does prevent a high number of connections to the RPC layer from damaging the rest of the system.\r\n\r\nTo avoid problems of a similar nature, the second patch additionally raises the rlimit of number of file descriptors as high as it can go.\r\n\r\nTo repro the database crash and validate the fix, the following node.js fragment:\r\n```\r\nvar uri = 'http://127.0.0.1:8332/rest/block/000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f.json'\r\nfor (var message = 0; message < 10000; message++) {\r\n    request(uri)\r\n}\r\n```\r\n\r\nThe messages around the database crash due to open(2) failing due to too many open files\r\n \r\n> 2017-11-26 19:35:55 libevent: Error from accept() call: Too many open files\r\n> 2017-11-26 19:35:55 ERROR: WriteBlockToDisk: OpenBlockFile failed\r\n> 2017-11-26 19:35:55 libevent: timeout_next: event: 0x7f59001dcef0, in 15 seconds, 475453 useconds\r\n> 2017-11-26 19:35:55 *** Failed to write block\r\n> 2017-11-26 19:35:55 libevent: epoll_dispatch: epoll_wait reports 1\r\n> 2017-11-26 19:35:55 Error: Error: A fatal internal error occurred, see debug.log for details\r\n",
   "closed_at" : null,
   "closed_by" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
      "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
      "followers_url" : "https://api.github.com/users/DrahtBot/followers",
      "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/DrahtBot",
      "id" : 39886733,
      "login" : "DrahtBot",
      "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
      "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
      "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
      "repos_url" : "https://api.github.com/users/DrahtBot/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/DrahtBot"
   },
   "comments" : 20,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11785/comments",
   "created_at" : "2017-11-29T05:26:29Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11785/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/11785",
   "id" : 277633964,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11785/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MTU1MjUyNTM4",
   "number" : 11785,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/11785.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11785",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/11785.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11785"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Raise the open fd limit to the maximum allowed",
   "updated_at" : "2018-07-20T20:30:20Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11785",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/37696?v=4",
      "events_url" : "https://api.github.com/users/vii/events{/privacy}",
      "followers_url" : "https://api.github.com/users/vii/followers",
      "following_url" : "https://api.github.com/users/vii/following{/other_user}",
      "gists_url" : "https://api.github.com/users/vii/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/vii",
      "id" : 37696,
      "login" : "vii",
      "node_id" : "MDQ6VXNlcjM3Njk2",
      "organizations_url" : "https://api.github.com/users/vii/orgs",
      "received_events_url" : "https://api.github.com/users/vii/received_events",
      "repos_url" : "https://api.github.com/users/vii/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/vii/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/vii/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/vii"
   }
}
