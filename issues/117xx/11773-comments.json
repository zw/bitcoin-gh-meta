[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153699992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153699992"
         }
      },
      "author_association" : "NONE",
      "body" : "Unsure if you guys adhere directly to PEP8 but this comment looks like it could be removed, seems redundant.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2017-11-29T06:04:18Z",
      "diff_hunk" : "@@ -10,74 +10,65 @@\n 3) Invalid block with bad coinbase value should be rejected and not\n re-requested.\n \"\"\"\n-\n-from test_framework.test_framework import ComparisonTestFramework\n-from test_framework.util import *\n-from test_framework.comptool import TestManager, TestInstance, RejectResult\n-from test_framework.blocktools import *\n import copy\n-import time\n \n-# Use the ComparisonTestFramework with 1 node: only use --testbinary.\n-class InvalidBlockRequestTest(ComparisonTestFramework):\n+from test_framework.blocktools import create_block, create_coinbase, create_transaction\n+from test_framework.messages import COIN\n+from test_framework.mininode import NetworkThread, P2PStub\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n \n-    ''' Can either run this test as 1 node with expected answers, or two and compare them. \n-        Change the \"outcome\" variable from each TestInstance object to only do the comparison. '''\n+class InvalidBlockRequestTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[\"-whitelist=127.0.0.1\"]]\n \n     def run_test(self):\n-        test = TestManager(self, self.options.tmpdir)\n-        test.add_all_connections(self.nodes)\n-        self.tip = None\n-        self.block_time = None\n-        NetworkThread().start() # Start up network handling in another thread\n-        test.run()\n-\n-    def get_tests(self):\n-        if self.tip is None:\n-            self.tip = int(\"0x\" + self.nodes[0].getbestblockhash(), 0)\n-        self.block_time = int(time.time())+1\n-\n-        '''\n-        Create a new block with an anyone-can-spend coinbase\n-        '''\n+        # Add p2p connection to node0\n+        node = self.nodes[0]  # convenience reference to the node\n+        node.add_p2p_connection(P2PStub())\n+\n+        NetworkThread().start()  # Start up network handling in another thread",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153699992",
      "id" : 153699992,
      "original_commit_id" : "36cfdb9dbbb4a078590a4cd99e09e1136c59f317",
      "original_position" : 48,
      "path" : "test/functional/invalidblockrequest.py",
      "position" : null,
      "pull_request_review_id" : 79743968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153699992",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153700278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153700278"
         }
      },
      "author_association" : "NONE",
      "body" : "Would imagine this would be best moved inline as opposed to on it's own line to keep convention with inline comments like on line 32 and 29.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2017-11-29T06:07:06Z",
      "diff_hunk" : "@@ -10,74 +10,65 @@\n 3) Invalid block with bad coinbase value should be rejected and not\n re-requested.\n \"\"\"\n-\n-from test_framework.test_framework import ComparisonTestFramework\n-from test_framework.util import *\n-from test_framework.comptool import TestManager, TestInstance, RejectResult\n-from test_framework.blocktools import *\n import copy\n-import time\n \n-# Use the ComparisonTestFramework with 1 node: only use --testbinary.\n-class InvalidBlockRequestTest(ComparisonTestFramework):\n+from test_framework.blocktools import create_block, create_coinbase, create_transaction\n+from test_framework.messages import COIN\n+from test_framework.mininode import NetworkThread, P2PStub\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n \n-    ''' Can either run this test as 1 node with expected answers, or two and compare them. \n-        Change the \"outcome\" variable from each TestInstance object to only do the comparison. '''\n+class InvalidBlockRequestTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[\"-whitelist=127.0.0.1\"]]\n \n     def run_test(self):\n-        test = TestManager(self, self.options.tmpdir)\n-        test.add_all_connections(self.nodes)\n-        self.tip = None\n-        self.block_time = None\n-        NetworkThread().start() # Start up network handling in another thread\n-        test.run()\n-\n-    def get_tests(self):\n-        if self.tip is None:\n-            self.tip = int(\"0x\" + self.nodes[0].getbestblockhash(), 0)\n-        self.block_time = int(time.time())+1\n-\n-        '''\n-        Create a new block with an anyone-can-spend coinbase\n-        '''\n+        # Add p2p connection to node0\n+        node = self.nodes[0]  # convenience reference to the node\n+        node.add_p2p_connection(P2PStub())\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        node.p2p.wait_for_verack()\n+\n+        best_block = node.getblock(node.getbestblockhash())\n+        tip = int(\"0x\" + node.getbestblockhash(), 0)\n+        height = best_block[\"height\"] + 1\n+        block_time = best_block[\"time\"] + 1\n+\n+        self.log.info(\"Create a new block with an anyone-can-spend coinbase\")\n+\n         height = 1\n-        block = create_block(self.tip, create_coinbase(height), self.block_time)\n-        self.block_time += 1\n+        block = create_block(tip, create_coinbase(height), block_time)\n+        block_time += 1\n         block.solve()\n         # Save the coinbase for later",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153700278",
      "id" : 153700278,
      "original_commit_id" : "36cfdb9dbbb4a078590a4cd99e09e1136c59f317",
      "original_position" : 64,
      "path" : "test/functional/invalidblockrequest.py",
      "position" : null,
      "pull_request_review_id" : 79743968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153700278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153701261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153701261"
         }
      },
      "author_association" : "NONE",
      "body" : "Would assume this block comment should be moved into a docstring block like in test/functional/test_framework/mininode.py P2PStub class. Seems like the standard are great in there, I'm assuming that's down to this section being a refactor.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2017-11-29T06:17:49Z",
      "diff_hunk" : "@@ -10,74 +10,65 @@\n 3) Invalid block with bad coinbase value should be rejected and not\n re-requested.\n \"\"\"\n-\n-from test_framework.test_framework import ComparisonTestFramework\n-from test_framework.util import *\n-from test_framework.comptool import TestManager, TestInstance, RejectResult\n-from test_framework.blocktools import *\n import copy\n-import time\n \n-# Use the ComparisonTestFramework with 1 node: only use --testbinary.\n-class InvalidBlockRequestTest(ComparisonTestFramework):\n+from test_framework.blocktools import create_block, create_coinbase, create_transaction\n+from test_framework.messages import COIN\n+from test_framework.mininode import NetworkThread, P2PStub\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n \n-    ''' Can either run this test as 1 node with expected answers, or two and compare them. \n-        Change the \"outcome\" variable from each TestInstance object to only do the comparison. '''\n+class InvalidBlockRequestTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[\"-whitelist=127.0.0.1\"]]\n \n     def run_test(self):\n-        test = TestManager(self, self.options.tmpdir)\n-        test.add_all_connections(self.nodes)\n-        self.tip = None\n-        self.block_time = None\n-        NetworkThread().start() # Start up network handling in another thread\n-        test.run()\n-\n-    def get_tests(self):\n-        if self.tip is None:\n-            self.tip = int(\"0x\" + self.nodes[0].getbestblockhash(), 0)\n-        self.block_time = int(time.time())+1\n-\n-        '''\n-        Create a new block with an anyone-can-spend coinbase\n-        '''\n+        # Add p2p connection to node0\n+        node = self.nodes[0]  # convenience reference to the node\n+        node.add_p2p_connection(P2PStub())\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        node.p2p.wait_for_verack()\n+\n+        best_block = node.getblock(node.getbestblockhash())\n+        tip = int(\"0x\" + node.getbestblockhash(), 0)\n+        height = best_block[\"height\"] + 1\n+        block_time = best_block[\"time\"] + 1\n+\n+        self.log.info(\"Create a new block with an anyone-can-spend coinbase\")\n+\n         height = 1\n-        block = create_block(self.tip, create_coinbase(height), self.block_time)\n-        self.block_time += 1\n+        block = create_block(tip, create_coinbase(height), block_time)\n+        block_time += 1\n         block.solve()\n         # Save the coinbase for later\n-        self.block1 = block\n-        self.tip = block.sha256\n+        block1 = block\n+        tip = block.sha256\n         height += 1\n-        yield TestInstance([[block, True]])\n-\n-        '''\n-        Now we need that block to mature so we can spend the coinbase.\n-        '''\n-        test = TestInstance(sync_every_block=False)\n-        for i in range(100):\n-            block = create_block(self.tip, create_coinbase(height), self.block_time)\n-            block.solve()\n-            self.tip = block.sha256\n-            self.block_time += 1\n-            test.blocks_and_transactions.append([block, True])\n-            height += 1\n-        yield test\n-\n-        '''\n-        Now we use merkle-root malleability to generate an invalid block with\n-        same blockheader.\n-        Manufacture a block with 3 transactions (coinbase, spend of prior\n-        coinbase, spend of that spend).  Duplicate the 3rd transaction to \n-        leave merkle root and blockheader unchanged but invalidate the block.\n-        '''\n-        block2 = create_block(self.tip, create_coinbase(height), self.block_time)\n-        self.block_time += 1\n+        node.p2p.send_blocks_and_test([block1], node, True)\n+\n+        self.log.info(\"Mature the block.\")\n+        node.generate(100)\n+\n+        best_block = node.getblock(node.getbestblockhash())\n+        tip = int(\"0x\" + node.getbestblockhash(), 0)\n+        height = best_block[\"height\"] + 1\n+        block_time = best_block[\"time\"] + 1\n+\n+        # Use merkle-root malleability to generate an invalid block with",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153701261",
      "id" : 153701261,
      "original_commit_id" : "36cfdb9dbbb4a078590a4cd99e09e1136c59f317",
      "original_position" : 104,
      "path" : "test/functional/invalidblockrequest.py",
      "position" : null,
      "pull_request_review_id" : 79743968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153701261",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153701345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153701345"
         }
      },
      "author_association" : "NONE",
      "body" : "Newly added whitespace can be removed.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2017-11-29T06:18:49Z",
      "diff_hunk" : "@@ -4,68 +4,50 @@\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid transactions.\n \n-In this test we connect to one node over p2p, and test tx requests.\n-\"\"\"\n-\n-from test_framework.test_framework import ComparisonTestFramework\n-from test_framework.comptool import TestManager, TestInstance, RejectResult\n-from test_framework.blocktools import *\n+In this test we connect to one node over p2p, and test tx requests.\"\"\"\n import time\n \n+from test_framework.blocktools import create_block, create_coinbase, create_transaction\n+from test_framework.mininode import NetworkThread, P2PStub\n+from test_framework.messages import COIN\n+from test_framework.test_framework import BitcoinTestFramework\n \n+class InvalidTxRequestTest(BitcoinTestFramework):\n \n-# Use the ComparisonTestFramework with 1 node: only use --testbinary.\n-class InvalidTxRequestTest(ComparisonTestFramework):\n-\n-    ''' Can either run this test as 1 node with expected answers, or two and compare them. \n-        Change the \"outcome\" variable from each TestInstance object to only do the comparison. '''\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[\"-whitelist=127.0.0.1\"]]\n \n     def run_test(self):\n-        test = TestManager(self, self.options.tmpdir)\n-        test.add_all_connections(self.nodes)\n-        self.tip = None\n-        self.block_time = None\n-        NetworkThread().start() # Start up network handling in another thread\n-        test.run()\n+        # Add p2p connection to node0\n+        node = self.nodes[0]  # convenience reference to the node\n+        node.add_p2p_connection(P2PStub())\n+\n+        NetworkThread().start()  # Start up network handling in another thread",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r153701345",
      "id" : 153701345,
      "original_commit_id" : "36cfdb9dbbb4a078590a4cd99e09e1136c59f317",
      "original_position" : 41,
      "path" : "test/functional/invalidtxrequest.py",
      "position" : null,
      "pull_request_review_id" : 79743968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153701345",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for your input @JohnVonNeumann. Three of your nits are on comments that are already in the code, and the last is to revert a pep8 fix (pep8 states that 'inline comments should be separated by at least two spaces from the statement. They should start with a # and a single space.')\r\n\r\nthe invalidtxrequest and invalidblockrequest refactors are covered by #11771 and #11772. If you have functional review of those tests, can you leave comments in those PRs?",
      "created_at" : "2017-11-29T13:25:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-347859204",
      "id" : 347859204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2017-11-29T13:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/347859204",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Is it typically best off to leave preexisting nits for other PRs? Is that something I could fix myself and submit as a PR? Would that be the typical way to address it? I assume you look to keep the PRs clean otherwise people would just keep bringing up little things and it would be difficult to tell what was actually being added in the PR itself?\r\n\r\nApologies on the last PEP8 spacing comment too! I missed that part when reading the docs!\r\n\r\nWill have a look at the other PRs and comment in those. Thanks for the feedback as well.\r\n\r\nEDIT: Also sorry for not seeing that you had asked for #11771 and #11772 to be reviewed first, I didn't read the PR notes thoroughly, will keep an eye on them better from now on.",
      "created_at" : "2017-11-29T18:48:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-347957605",
      "id" : 347957605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2017-11-29T18:53:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/347957605",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Is it typically best off to leave preexisting nits for other PRs? Is that something I could fix myself and submit as a PR? Would that be the typical way to address it? I assume you look to keep the PRs clean otherwise people would just keep bringing up little things and it would be difficult to tell what was actually being added in the PR itself?\r\n\r\nI usually clean up style nits as I go, and precede functional-change commits with tidy-up commits as I have in this PR.\r\n\r\nThe nits you've raised are more your personal preference than following any particular style convention, so I don't think there's any benefit for you to open a PR for them.",
      "created_at" : "2017-11-29T18:52:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-347958810",
      "id" : 347958810,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2017-11-29T18:52:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/347958810",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Ok this makes sense, although I disagree that all my comments were related directly to my personal preference, for me it was just about keeping the standards throughout the code, for example with the redundant inline comment, I don't see any of them throughout the newly written code, so it would make sense to not have them in the old code. However, you are probably right, and I'll happily defer to your experience. \r\n\r\nI'll try and make my reviews more valuable.\r\n\r\nCheers",
      "created_at" : "2017-11-29T18:58:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-347960754",
      "id" : 347960754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2017-11-29T18:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/347960754",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/18162779?v=4",
         "events_url" : "https://api.github.com/users/JohnVonNeumann/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JohnVonNeumann/followers",
         "following_url" : "https://api.github.com/users/JohnVonNeumann/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JohnVonNeumann/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JohnVonNeumann",
         "id" : 18162779,
         "login" : "JohnVonNeumann",
         "organizations_url" : "https://api.github.com/users/JohnVonNeumann/orgs",
         "received_events_url" : "https://api.github.com/users/JohnVonNeumann/received_events",
         "repos_url" : "https://api.github.com/users/JohnVonNeumann/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JohnVonNeumann/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JohnVonNeumann/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JohnVonNeumann"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This requires rebase, but I'll leave it as it is until #11771 is reviewed/merged.",
      "created_at" : "2017-12-02T16:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-348702673",
      "id" : 348702673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2017-12-02T16:24:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/348702673",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r158128644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158128644"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tidy up p2pfullblocktest\"\r\n\r\nCan you note that this option was removed in the commit message (and maybe say why it wasn't useful?)",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2017-12-20T20:32:32Z",
      "diff_hunk" : "@@ -94,228 +96,123 @@ def set_test_params(self):\n         self.tip = None\n         self.blocks = {}\n \n-    def add_options(self, parser):\n-        super().add_options(parser)\n-        parser.add_option(\"--runbarelyexpensive\", dest=\"runbarelyexpensive\", default=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r158128644",
      "id" : 158128644,
      "original_commit_id" : "a9554710e65484d7973b706829be67faff53c357",
      "original_position" : 15,
      "path" : "test/functional/p2p-fullblocktest.py",
      "position" : null,
      "pull_request_review_id" : 84888774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158128644",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r168069256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/168069256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep. Added to commit message.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-02-14T03:23:13Z",
      "diff_hunk" : "@@ -94,228 +96,123 @@ def set_test_params(self):\n         self.tip = None\n         self.blocks = {}\n \n-    def add_options(self, parser):\n-        super().add_options(parser)\n-        parser.add_option(\"--runbarelyexpensive\", dest=\"runbarelyexpensive\", default=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r168069256",
      "id" : 168069256,
      "in_reply_to_id" : 158128644,
      "original_commit_id" : "a9554710e65484d7973b706829be67faff53c357",
      "original_position" : 15,
      "path" : "test/functional/p2p-fullblocktest.py",
      "position" : null,
      "pull_request_review_id" : 96376342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/168069256",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased now that #11771 has been merged.",
      "created_at" : "2018-02-14T03:23:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-365484221",
      "id" : 365484221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-02-14T03:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365484221",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK",
      "created_at" : "2018-02-15T18:47:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-366023674",
      "id" : 366023674,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-02-15T18:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/366023674",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14220652?v=4",
         "events_url" : "https://api.github.com/users/conscott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/conscott/followers",
         "following_url" : "https://api.github.com/users/conscott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/conscott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/conscott",
         "id" : 14220652,
         "login" : "conscott",
         "organizations_url" : "https://api.github.com/users/conscott/orgs",
         "received_events_url" : "https://api.github.com/users/conscott/received_events",
         "repos_url" : "https://api.github.com/users/conscott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/conscott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/conscott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/conscott"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 061f4d8cfba58d299dd913bd96f88bddebae8276\r\n\r\nThanks for a very nice cleanup! Looking forward to seeing this merged!",
      "created_at" : "2018-02-15T18:49:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-366024380",
      "id" : 366024380,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-02-15T18:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/366024380",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I saw Travis fail on this, but the trace wasn't printed because of https://github.com/bitcoin/bitcoin/pull/12438.\r\n\r\nI reran the job and it passed. It seems that there may be an intermittent failure in the test. I'll rebase on master to get #12438 and try kicking Travis a few times.",
      "created_at" : "2018-02-15T18:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-366025989",
      "id" : 366025989,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-02-15T18:55:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/366025989",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2018-03-19T13:33:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-374212872",
      "id" : 374212872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-19T13:33:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374212872",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175510431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175510431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Could mention in a comment that this is only needed because `connect_p2p` assumes the thread is already running.\r\n\r\nnit: Could rename `connect_p2p` to `reconnect_p2p`, since it only works when the thread is already running?",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T17:01:22Z",
      "diff_hunk" : "@@ -82,46 +71,42 @@ def serialize(self, with_witness=False):\n         return r\n \n     def normal_serialize(self):\n-        r = b\"\"\n-        r += super(CBrokenBlock, self).serialize()\n-        return r\n+        return super().serialize()\n \n-class FullBlockTest(ComparisonTestFramework):\n-    # Can either run this test as 1 node with expected answers, or two and compare them.\n-    # Change the \"outcome\" variable from each TestInstance object to only do the comparison.\n+class FullBlockTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[]]\n+\n+    def run_test(self):\n+        node = self.nodes[0]  # convenience reference to the node\n+\n+        network_thread_start()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175510431",
      "id" : 175510431,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 69,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105051384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175510431",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175521812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175521812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why are you changing this comment?\r\n\r\nBlock 7 spends the output 2 (c.f. line 165)",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T17:33:39Z",
      "diff_hunk" : "@@ -149,60 +134,60 @@ def get_tests(self):\n         self.move_tip(1)\n         b3 = self.next_block(3, spend=out[1])\n         txout_b3 = PreviousSpendableOutput(b3.vtx[1], 0)\n-        yield self.rejected()\n+        self.sync_blocks([b3], False)\n \n         # Now we add another block to make the alternative chain longer.\n         #\n         #     genesis -> b1 (0) -> b2 (1)\n         #                      \\-> b3 (1) -> b4 (2)\n         self.log.info(\"Reorg to a longer chain\")\n-        self.next_block(4, spend=out[2])\n-        yield self.accepted()\n+        b4 = self.next_block(4, spend=out[2])\n+        self.sync_blocks([b4])\n \n         # ... and back to the first chain.\n         #     genesis -> b1 (0) -> b2 (1) -> b5 (2) -> b6 (3)\n         #                      \\-> b3 (1) -> b4 (2)\n         self.move_tip(2)\n-        self.next_block(5, spend=out[2])\n+        b5 = self.next_block(5, spend=out[2])\n         self.save_spendable_output()\n-        yield self.rejected()\n+        self.sync_blocks([b5], False)\n \n         self.log.info(\"Reorg back to the original chain\")\n-        self.next_block(6, spend=out[3])\n-        yield self.accepted()\n+        b6 = self.next_block(6, spend=out[3])\n+        self.sync_blocks([b6], True)\n \n         # Try to create a fork that double-spends\n         #     genesis -> b1 (0) -> b2 (1) -> b5 (2) -> b6 (3)\n-        #                                          \\-> b7 (2) -> b8 (4)\n+        #                                          \\-> b7 (3) -> b8 (4)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175521812",
      "id" : 175521812,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 169,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105051384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175521812",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175525042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175525042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment above `(b12 added last)` is no longer true with this change.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T17:42:57Z",
      "diff_hunk" : "@@ -214,17 +199,12 @@ def get_tests(self):\n         b12 = self.next_block(12, spend=out[3])\n         self.save_spendable_output()\n         b13 = self.next_block(13, spend=out[4])\n-        # Deliver the block header for b12, and the block b13.\n-        # b13 should be accepted but the tip won't advance until b12 is delivered.\n-        yield TestInstance([[CBlockHeader(b12), None], [b13, False]])\n-\n         self.save_spendable_output()\n-        # b14 is invalid, but the node won't know that until it tries to connect\n-        # Tip still can't advance because b12 is missing\n-        self.next_block(14, spend=out[5], additional_coinbase_value=1)\n-        yield self.rejected()\n+        b14 = self.next_block(14, spend=out[5], additional_coinbase_value=1)\n+        self.sync_blocks([b12, b13, b14], False, 16, b'bad-cb-amount', reconnect=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175525042",
      "id" : 175525042,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 226,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105051384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175525042",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175531218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175531218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why are you changing this to `1`? We are building blocks on top of block with id `88`, so naming them `\"alt89\"` ... seems appropriate.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:00:40Z",
      "diff_hunk" : "@@ -1201,33 +1186,30 @@ def get_tests(self):\n             tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n             b = self.update_block(i, [tx])\n             assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n-            test1.blocks_and_transactions.append([self.tip, True])\n+            blocks.append(b)\n             self.save_spendable_output()\n             spend = self.get_spendable_output()\n \n-        yield test1\n+        self.sync_blocks(blocks, True, timeout=180)\n         chain1_tip = i\n \n         # now create alt chain of same length\n         self.move_tip(88)\n-        test2 = TestInstance(sync_every_block=False)\n-        for i in range(89, LARGE_REORG_SIZE + 89):\n-            self.next_block(\"alt\" + str(i))\n-            test2.blocks_and_transactions.append([self.tip, False])\n-        yield test2\n+        blocks2 = []\n+        for i in range(1, LARGE_REORG_SIZE + 1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175531218",
      "id" : 175531218,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 1052,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105051384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175531218",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175533248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175533248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 06d512f11998d9b935edf8b032eb76e491cfb7cc:\r\n\r\nWhy are you adding this comment? The `ser_uint256` symbol is not imported and it will unsurprisingly be all zeros, since it was set to 0.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:06:34Z",
      "diff_hunk" : "@@ -598,77 +577,78 @@ def get_tests(self):\n         self.tip = b46\n         assert 46 not in self.blocks\n         self.blocks[46] = b46\n-        yield self.rejected(RejectResult(16, b'bad-blk-length'))\n+        # s = ser_uint256(b46.hashMerkleRoot)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175533248",
      "id" : 175533248,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 509,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105077927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175533248",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 1f7a8662cdf2c7775942e3abc90c3745c2adaecc\r\n\r\nGitHub hiding my review is probably a bug on their end.",
      "created_at" : "2018-03-19T18:09:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-374311412",
      "id" : 374311412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-19T18:09:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374311412",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175535906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175535906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In the last commit:\r\n\r\nI think you meant `inspect.getsource`, since the line itself won't help when the file name is unknown. And the Traceback already shows the line number and file name (as well as the predicate, in case it fits into a single line).",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:15:18Z",
      "diff_hunk" : "@@ -218,8 +219,12 @@ def wait_until(predicate, *, attempts=float('inf'), timeout=float('inf'), lock=N\n         time.sleep(0.05)\n \n     # Print the cause of the timeout\n-    assert_greater_than(attempts, attempt)\n-    assert_greater_than(timeout, time.time())\n+    predicate_source = inspect.getsourcelines(predicate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175535906",
      "id" : 175535906,
      "original_commit_id" : "1f7a8662cdf2c7775942e3abc90c3745c2adaecc",
      "original_position" : 26,
      "path" : "test/functional/test_framework/util.py",
      "position" : 26,
      "pull_request_review_id" : 105081074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175535906",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good. Done both.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:15:35Z",
      "diff_hunk" : "@@ -82,46 +71,42 @@ def serialize(self, with_witness=False):\n         return r\n \n     def normal_serialize(self):\n-        r = b\"\"\n-        r += super(CBrokenBlock, self).serialize()\n-        return r\n+        return super().serialize()\n \n-class FullBlockTest(ComparisonTestFramework):\n-    # Can either run this test as 1 node with expected answers, or two and compare them.\n-    # Change the \"outcome\" variable from each TestInstance object to only do the comparison.\n+class FullBlockTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[]]\n+\n+    def run_test(self):\n+        node = self.nodes[0]  # convenience reference to the node\n+\n+        network_thread_start()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536022",
      "id" : 175536022,
      "in_reply_to_id" : 175510431,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 69,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105081209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536022",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Imo we could do without `inspect`, since it doesn't seem to add information unless I am missing something.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:16:34Z",
      "diff_hunk" : "@@ -218,8 +219,12 @@ def wait_until(predicate, *, attempts=float('inf'), timeout=float('inf'), lock=N\n         time.sleep(0.05)\n \n     # Print the cause of the timeout\n-    assert_greater_than(attempts, attempt)\n-    assert_greater_than(timeout, time.time())\n+    predicate_source = inspect.getsourcelines(predicate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536419",
      "id" : 175536419,
      "in_reply_to_id" : 175535906,
      "original_commit_id" : "1f7a8662cdf2c7775942e3abc90c3745c2adaecc",
      "original_position" : 26,
      "path" : "test/functional/test_framework/util.py",
      "position" : 26,
      "pull_request_review_id" : 105081570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536419",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes - you're right. Fixed",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:18:02Z",
      "diff_hunk" : "@@ -149,60 +134,60 @@ def get_tests(self):\n         self.move_tip(1)\n         b3 = self.next_block(3, spend=out[1])\n         txout_b3 = PreviousSpendableOutput(b3.vtx[1], 0)\n-        yield self.rejected()\n+        self.sync_blocks([b3], False)\n \n         # Now we add another block to make the alternative chain longer.\n         #\n         #     genesis -> b1 (0) -> b2 (1)\n         #                      \\-> b3 (1) -> b4 (2)\n         self.log.info(\"Reorg to a longer chain\")\n-        self.next_block(4, spend=out[2])\n-        yield self.accepted()\n+        b4 = self.next_block(4, spend=out[2])\n+        self.sync_blocks([b4])\n \n         # ... and back to the first chain.\n         #     genesis -> b1 (0) -> b2 (1) -> b5 (2) -> b6 (3)\n         #                      \\-> b3 (1) -> b4 (2)\n         self.move_tip(2)\n-        self.next_block(5, spend=out[2])\n+        b5 = self.next_block(5, spend=out[2])\n         self.save_spendable_output()\n-        yield self.rejected()\n+        self.sync_blocks([b5], False)\n \n         self.log.info(\"Reorg back to the original chain\")\n-        self.next_block(6, spend=out[3])\n-        yield self.accepted()\n+        b6 = self.next_block(6, spend=out[3])\n+        self.sync_blocks([b6], True)\n \n         # Try to create a fork that double-spends\n         #     genesis -> b1 (0) -> b2 (1) -> b5 (2) -> b6 (3)\n-        #                                          \\-> b7 (2) -> b8 (4)\n+        #                                          \\-> b7 (3) -> b8 (4)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175536935",
      "id" : 175536935,
      "in_reply_to_id" : 175521812,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 169,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105082174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175536935",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175537883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175537883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes - removed",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:20:53Z",
      "diff_hunk" : "@@ -214,17 +199,12 @@ def get_tests(self):\n         b12 = self.next_block(12, spend=out[3])\n         self.save_spendable_output()\n         b13 = self.next_block(13, spend=out[4])\n-        # Deliver the block header for b12, and the block b13.\n-        # b13 should be accepted but the tip won't advance until b12 is delivered.\n-        yield TestInstance([[CBlockHeader(b12), None], [b13, False]])\n-\n         self.save_spendable_output()\n-        # b14 is invalid, but the node won't know that until it tries to connect\n-        # Tip still can't advance because b12 is missing\n-        self.next_block(14, spend=out[5], additional_coinbase_value=1)\n-        yield self.rejected()\n+        b14 = self.next_block(14, spend=out[5], additional_coinbase_value=1)\n+        self.sync_blocks([b12, b13, b14], False, 16, b'bad-cb-amount', reconnect=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175537883",
      "id" : 175537883,
      "in_reply_to_id" : 175525042,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 226,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105083229,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175537883",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175538493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175538493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:22:39Z",
      "diff_hunk" : "@@ -598,77 +577,78 @@ def get_tests(self):\n         self.tip = b46\n         assert 46 not in self.blocks\n         self.blocks[46] = b46\n-        yield self.rejected(RejectResult(16, b'bad-blk-length'))\n+        # s = ser_uint256(b46.hashMerkleRoot)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175538493",
      "id" : 175538493,
      "in_reply_to_id" : 175533248,
      "original_commit_id" : "06d512f11998d9b935edf8b032eb76e491cfb7cc",
      "original_position" : 509,
      "path" : "test/functional/feature_block.py",
      "position" : null,
      "pull_request_review_id" : 105083829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175538493",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175541170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175541170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this provides useful information when the `wait_until()` fails.\r\n\r\nWithout this change:\r\n\r\n```\r\n2018-03-19T18:29:56.324000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/test_framework.py\", line 126, in main\r\n    self.run_test()\r\n  File \"./feature_block.py\", line 502, in run_test\r\n    self.sync_blocks([b40], False, 16, b'bad-blk-sigops', reconnect=True)\r\n  File \"./feature_block.py\", line 1315, in sync_blocks\r\n    self.nodes[0].p2p.send_blocks_and_test(blocks, self.nodes[0], success=success, reject_code=reject_code, reject_reason=reject_reason, request_block=request_block, timeout=timeout)\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/mininode.py\", line 553, in send_blocks_and_test\r\n    wait_until(lambda: self.reject_code_received == reject_code, lock=mininode_lock, timeout=1)\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/util.py\", line 222, in wait_until\r\n    assert_greater_than(timeout, time.time())\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/util.py\", line 42, in assert_greater_than\r\n    raise AssertionError(\"%s <= %s\" % (str(thing1), str(thing2)))\r\nAssertionError: 1521484196.279766 <= 1521484196.3246927\r\n```\r\n\r\nWith this change:\r\n\r\n```\r\n2018-03-19T18:27:45.353000Z TestFramework (INFO): Reject a block with too many P2SH sigops\r\n2018-03-19T18:27:48.557000Z TestFramework.utils (ERROR): wait_until() failed. Predicate: (['            wait_until(lambda: self.reject_code_received == reject_code, lock=mininode_lock, timeout=1)\\n'], 553)\r\n2018-03-19T18:27:48.557000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/test_framework.py\", line 126, in main\r\n    self.run_test()\r\n  File \"./feature_block.py\", line 502, in run_test\r\n    self.sync_blocks([b40], False, 16, b'bad-blk-sigops', reconnect=True)\r\n  File \"./feature_block.py\", line 1315, in sync_blocks\r\n    self.nodes[0].p2p.send_blocks_and_test(blocks, self.nodes[0], success=success, reject_code=reject_code, reject_reason=reject_reason, request_block=request_block, timeout=timeout)\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/mininode.py\", line 553, in send_blocks_and_test\r\n    wait_until(lambda: self.reject_code_received == reject_code, lock=mininode_lock, timeout=1)\r\n  File \"/home/ubuntu/bitcoin/test/functional/test_framework/util.py\", line 227, in wait_until\r\n    raise AssertionError(\"Predicate {} not true after {} seconds\".format(predicate_source, timeout))\r\nAssertionError: Predicate (['            wait_until(lambda: self.reject_code_received == reject_code, lock=mininode_lock, timeout=1)\\n'], 553) not true after 1 seconds\r\n```",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:31:02Z",
      "diff_hunk" : "@@ -218,8 +219,12 @@ def wait_until(predicate, *, attempts=float('inf'), timeout=float('inf'), lock=N\n         time.sleep(0.05)\n \n     # Print the cause of the timeout\n-    assert_greater_than(attempts, attempt)\n-    assert_greater_than(timeout, time.time())\n+    predicate_source = inspect.getsourcelines(predicate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r175541170",
      "id" : 175541170,
      "in_reply_to_id" : 175535906,
      "original_commit_id" : "1f7a8662cdf2c7775942e3abc90c3745c2adaecc",
      "original_position" : 26,
      "path" : "test/functional/test_framework/util.py",
      "position" : 26,
      "pull_request_review_id" : 105087015,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-19T18:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175541170",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @MarcoFalke - I think I've addressed your comments",
      "created_at" : "2018-03-19T18:32:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-374318731",
      "id" : 374318731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-19T18:32:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374318731",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks re-utACK 265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-19T18:47:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-374323597",
      "id" : 374323597,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-19T18:47:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374323597",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Test re-ACK 265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-20T13:27:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-374596825",
      "id" : 374596825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-20T13:27:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374596825",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14220652?v=4",
         "events_url" : "https://api.github.com/users/conscott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/conscott/followers",
         "following_url" : "https://api.github.com/users/conscott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/conscott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/conscott",
         "id" : 14220652,
         "login" : "conscott",
         "organizations_url" : "https://api.github.com/users/conscott/orgs",
         "received_events_url" : "https://api.github.com/users/conscott/received_events",
         "repos_url" : "https://api.github.com/users/conscott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/conscott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/conscott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/conscott"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ready for merge?",
      "created_at" : "2018-03-27T13:20:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376522188",
      "id" : 376522188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-27T13:20:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376522188",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs more (re) acks\n\nOn Tue, Mar 27, 2018, 09:21 jamesob <notifications@github.com> wrote:\n\n> Ready for merge?\n>\n> \n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376522188>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AGGmv32N2D39OikZv_aEbDkLMcUm6iy6ks5tijzTgaJpZM4Qr7m3>\n> .\n>\n",
      "created_at" : "2018-03-27T14:48:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376553468",
      "id" : 376553468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-27T14:48:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376553468",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky @practicalswift - care to reACK?",
      "created_at" : "2018-03-27T14:53:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376555284",
      "id" : 376555284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-27T14:53:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376555284",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177537490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177537490"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm pretty sure this functionality gets repeated in several other tests. If so, we should move this somewhere more general and consolidate usages later on.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-27T19:04:01Z",
      "diff_hunk" : "@@ -1133,161 +1063,259 @@ def update_block(block_number, new_transactions):\n         #    To get around this issue, we construct transactions which are not signed and which\n         #    spend to OP_TRUE.  If the standard-ness rules change, this test would need to be\n         #    updated.  (Perhaps to spend to a P2SH OP_TRUE script)\n-        #\n-        tip(76)\n-        block(77)\n-        tx77 = create_and_sign_tx(out[24].tx, out[24].n, 10*COIN)\n-        update_block(77, [tx77])\n-        yield accepted()\n-        save_spendable_output()\n-\n-        block(78)\n-        tx78 = create_tx(tx77, 0, 9*COIN)\n-        update_block(78, [tx78])\n-        yield accepted()\n-\n-        block(79)\n-        tx79 = create_tx(tx78, 0, 8*COIN)\n-        update_block(79, [tx79])\n-        yield accepted()\n+        self.log.info(\"Test transaction resurrection during a re-org\")\n+        self.move_tip(76)\n+        b77 = self.next_block(77)\n+        tx77 = self.create_and_sign_transaction(out[24].tx, out[24].n, 10 * COIN)\n+        b77 = self.update_block(77, [tx77])\n+        self.sync_blocks([b77], True)\n+        self.save_spendable_output()\n+\n+        b78 = self.next_block(78)\n+        tx78 = self.create_tx(tx77, 0, 9 * COIN)\n+        b78 = self.update_block(78, [tx78])\n+        self.sync_blocks([b78], True)\n+\n+        b79 = self.next_block(79)\n+        tx79 = self.create_tx(tx78, 0, 8 * COIN)\n+        b79 = self.update_block(79, [tx79])\n+        self.sync_blocks([b79], True)\n \n         # mempool should be empty\n         assert_equal(len(self.nodes[0].getrawmempool()), 0)\n \n-        tip(77)\n-        block(80, spend=out[25])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(77)\n+        b80 = self.next_block(80, spend=out[25])\n+        self.sync_blocks([b80], False, request_block=False)\n+        self.save_spendable_output()\n \n-        block(81, spend=out[26])\n-        yield rejected() # other chain is same length\n-        save_spendable_output()\n+        b81 = self.next_block(81, spend=out[26])\n+        self.sync_blocks([b81], False, request_block=False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(82, spend=out[27])\n-        yield accepted()  # now this chain is longer, triggers re-org\n-        save_spendable_output()\n+        b82 = self.next_block(82, spend=out[27])\n+        self.sync_blocks([b82], True)  # now this chain is longer, triggers re-org\n+        self.save_spendable_output()\n \n         # now check that tx78 and tx79 have been put back into the peer's mempool\n         mempool = self.nodes[0].getrawmempool()\n         assert_equal(len(mempool), 2)\n         assert(tx78.hash in mempool)\n         assert(tx79.hash in mempool)\n \n-\n         # Test invalid opcodes in dead execution paths.\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28)\n         #\n-        block(83)\n+        self.log.info(\"Accept a block with invalid opcodes in dead execution paths\")\n+        b83 = self.next_block(83)\n         op_codes = [OP_IF, OP_INVALIDOPCODE, OP_ELSE, OP_TRUE, OP_ENDIF]\n         script = CScript(op_codes)\n-        tx1 = create_and_sign_tx(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n+        tx1 = self.create_and_sign_transaction(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n \n-        tx2 = create_and_sign_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        tx2 = self.create_and_sign_transaction(tx1, 0, 0, CScript([OP_TRUE]))\n         tx2.vin[0].scriptSig = CScript([OP_FALSE])\n         tx2.rehash()\n \n-        update_block(83, [tx1, tx2])\n-        yield accepted()\n-        save_spendable_output()\n-\n+        b83 = self.update_block(83, [tx1, tx2])\n+        self.sync_blocks([b83], True)\n+        self.save_spendable_output()\n \n         # Reorg on/off blocks that have OP_RETURN in them (and try to spend them)\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28) -> b84 (29) -> b87 (30) -> b88 (31)\n         #                                    \\-> b85 (29) -> b86 (30)            \\-> b89a (32)\n         #\n-        #\n-        block(84)\n-        tx1 = create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n+        self.log.info(\"Test re-orging blocks with OP_RETURN in them\")\n+        b84 = self.next_block(84)\n+        tx1 = self.create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.calc_sha256()\n         self.sign_tx(tx1, out[29].tx, out[29].n)\n         tx1.rehash()\n-        tx2 = create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n+        tx2 = self.create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n         tx2.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx3 = create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n+        tx3 = self.create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n         tx3.vout.append(CTxOut(0, CScript([OP_TRUE])))\n-        tx4 = create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n+        tx4 = self.create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n         tx4.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx5 = create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n+        tx5 = self.create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n \n-        update_block(84, [tx1,tx2,tx3,tx4,tx5])\n-        yield accepted()\n-        save_spendable_output()\n+        b84 = self.update_block(84, [tx1, tx2, tx3, tx4, tx5])\n+        self.sync_blocks([b84], True)\n+        self.save_spendable_output()\n \n-        tip(83)\n-        block(85, spend=out[29])\n-        yield rejected()\n+        self.move_tip(83)\n+        b85 = self.next_block(85, spend=out[29])\n+        self.sync_blocks([b85], False)  # other chain is same length\n \n-        block(86, spend=out[30])\n-        yield accepted()\n+        b86 = self.next_block(86, spend=out[30])\n+        self.sync_blocks([b86], True)\n \n-        tip(84)\n-        block(87, spend=out[30])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(84)\n+        b87 = self.next_block(87, spend=out[30])\n+        self.sync_blocks([b87], False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(88, spend=out[31])\n-        yield accepted()\n-        save_spendable_output()\n+        b88 = self.next_block(88, spend=out[31])\n+        self.sync_blocks([b88], True)\n+        self.save_spendable_output()\n \n         # trying to spend the OP_RETURN output is rejected\n-        block(\"89a\", spend=out[32])\n-        tx = create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n-        update_block(\"89a\", [tx])\n-        yield rejected()\n-\n-\n-        #  Test re-org of a week's worth of blocks (1088 blocks)\n-        #  This test takes a minute or two and can be accomplished in memory\n-        #\n-        if self.options.runbarelyexpensive:\n-            tip(88)\n-            LARGE_REORG_SIZE = 1088\n-            test1 = TestInstance(sync_every_block=False)\n-            spend=out[32]\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                b = block(i, spend)\n-                tx = CTransaction()\n-                script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n-                script_output = CScript([b'\\x00' * script_length])\n-                tx.vout.append(CTxOut(0, script_output))\n-                tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n-                b = update_block(i, [tx])\n-                assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n-                test1.blocks_and_transactions.append([self.tip, True])\n-                save_spendable_output()\n-                spend = get_spendable_output()\n-\n-            yield test1\n-            chain1_tip = i\n-\n-            # now create alt chain of same length\n-            tip(88)\n-            test2 = TestInstance(sync_every_block=False)\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                block(\"alt\"+str(i))\n-                test2.blocks_and_transactions.append([self.tip, False])\n-            yield test2\n-\n-            # extend alt chain to trigger re-org\n-            block(\"alt\" + str(chain1_tip + 1))\n-            yield accepted()\n-\n-            # ... and re-org back to the first chain\n-            tip(chain1_tip)\n-            block(chain1_tip + 1)\n-            yield rejected()\n-            block(chain1_tip + 2)\n-            yield accepted()\n-\n-            chain1_tip += 2\n+        b89a = self.next_block(\"89a\", spend=out[32])\n+        tx = self.create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        b89a = self.update_block(\"89a\", [tx])\n+        self.sync_blocks([b89a], False, 16, b'bad-txns-inputs-missingorspent', reconnect=True)\n+\n+        self.log.info(\"Test a re-org of one week's worth of blocks (1088 blocks)\")\n+\n+        self.move_tip(88)\n+        LARGE_REORG_SIZE = 1088\n+        blocks = []\n+        spend = out[32]\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            b = self.next_block(i, spend)\n+            tx = CTransaction()\n+            script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n+            script_output = CScript([b'\\x00' * script_length])\n+            tx.vout.append(CTxOut(0, script_output))\n+            tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n+            b = self.update_block(i, [tx])\n+            assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n+            blocks.append(b)\n+            self.save_spendable_output()\n+            spend = self.get_spendable_output()\n+\n+        self.sync_blocks(blocks, True, timeout=180)\n+        chain1_tip = i\n+\n+        # now create alt chain of same length\n+        self.move_tip(88)\n+        blocks2 = []\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            blocks2.append(self.next_block(\"alt\" + str(i)))\n+        self.sync_blocks(blocks2, False, request_block=False)\n+\n+        # extend alt chain to trigger re-org\n+        block = self.next_block(\"alt\" + str(chain1_tip + 1))\n+        self.sync_blocks([block], True, timeout=180)\n+\n+        # ... and re-org back to the first chain\n+        self.move_tip(chain1_tip)\n+        block = self.next_block(chain1_tip + 1)\n+        self.sync_blocks([block], False, request_block=False)\n+        block = self.next_block(chain1_tip + 2)\n+        self.sync_blocks([block], True, timeout=180)\n+\n+    # Helper methods\n+    ################\n+\n+    def add_transactions_to_block(self, block, tx_list):\n+        [tx.rehash() for tx in tx_list]\n+        block.vtx.extend(tx_list)\n+\n+    # this is a little handier to use than the version in blocktools.py\n+    def create_tx(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        return create_transaction(spend_tx, n, b\"\", value, script)\n+\n+    # sign a transaction, using the key we know about\n+    # this signs input 0 in tx, which is assumed to be spending output n in spend_tx\n+    def sign_tx(self, tx, spend_tx, n):\n+        scriptPubKey = bytearray(spend_tx.vout[n].scriptPubKey)\n+        if (scriptPubKey[0] == OP_TRUE):  # an anyone-can-spend\n+            tx.vin[0].scriptSig = CScript()\n+            return\n+        (sighash, err) = SignatureHash(spend_tx.vout[n].scriptPubKey, tx, 0, SIGHASH_ALL)\n+        tx.vin[0].scriptSig = CScript([self.coinbase_key.sign(sighash) + bytes(bytearray([SIGHASH_ALL]))])\n+\n+    def create_and_sign_transaction(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        tx = self.create_tx(spend_tx, n, value, script)\n+        self.sign_tx(tx, spend_tx, n)\n+        tx.rehash()\n+        return tx\n+\n+    def next_block(self, number, spend=None, additional_coinbase_value=0, script=CScript([OP_TRUE]), solve=True):\n+        if self.tip is None:\n+            base_block_hash = self.genesis_hash\n+            block_time = int(time.time()) + 1\n+        else:\n+            base_block_hash = self.tip.sha256\n+            block_time = self.tip.nTime + 1\n+        # First create the coinbase\n+        height = self.block_heights[base_block_hash] + 1\n+        coinbase = create_coinbase(height, self.coinbase_pubkey)\n+        coinbase.vout[0].nValue += additional_coinbase_value\n+        coinbase.rehash()\n+        if spend is None:\n+            block = create_block(base_block_hash, coinbase, block_time)\n+        else:\n+            coinbase.vout[0].nValue += spend.tx.vout[spend.n].nValue - 1  # all but one satoshi to fees\n+            coinbase.rehash()\n+            block = create_block(base_block_hash, coinbase, block_time)\n+            tx = create_transaction(spend.tx, spend.n, b\"\", 1, script)  # spend 1 satoshi\n+            self.sign_tx(tx, spend.tx, spend.n)\n+            self.add_transactions_to_block(block, [tx])\n+            block.hashMerkleRoot = block.calc_merkle_root()\n+        if solve:\n+            block.solve()\n+        self.tip = block\n+        self.block_heights[block.sha256] = height\n+        assert number not in self.blocks\n+        self.blocks[number] = block\n+        return block\n+\n+    # save the current tip so it can be spent by a later block\n+    def save_spendable_output(self):\n+        self.log.debug(\"saving spendable output %s\" % self.tip.vtx[0])\n+        self.spendable_outputs.append(self.tip)\n+\n+    # get an output that we previously marked as spendable\n+    def get_spendable_output(self):\n+        self.log.debug(\"getting spendable output %s\" % self.spendable_outputs[0].vtx[0])\n+        return PreviousSpendableOutput(self.spendable_outputs.pop(0).vtx[0], 0)\n+\n+    # move the tip back to a previous block\n+    def move_tip(self, number):\n+        self.tip = self.blocks[number]\n+\n+    # adds transactions to the block and updates state\n+    def update_block(self, block_number, new_transactions):\n+        block = self.blocks[block_number]\n+        self.add_transactions_to_block(block, new_transactions)\n+        old_sha256 = block.sha256\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Update the internal state just like in next_block\n+        self.tip = block\n+        if block.sha256 != old_sha256:\n+            self.block_heights[block.sha256] = self.block_heights[old_sha256]\n+            del self.block_heights[old_sha256]\n+        self.blocks[block_number] = block\n+        return block\n+\n+    def reconnect_p2p(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177537490",
      "id" : 177537490,
      "original_commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "original_position" : 1832,
      "path" : "test/functional/feature_block.py",
      "position" : 1832,
      "pull_request_review_id" : 107426126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-27T19:05:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177537490",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177549532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177549532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, but let's save that for a future PR.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-27T19:44:58Z",
      "diff_hunk" : "@@ -1133,161 +1063,259 @@ def update_block(block_number, new_transactions):\n         #    To get around this issue, we construct transactions which are not signed and which\n         #    spend to OP_TRUE.  If the standard-ness rules change, this test would need to be\n         #    updated.  (Perhaps to spend to a P2SH OP_TRUE script)\n-        #\n-        tip(76)\n-        block(77)\n-        tx77 = create_and_sign_tx(out[24].tx, out[24].n, 10*COIN)\n-        update_block(77, [tx77])\n-        yield accepted()\n-        save_spendable_output()\n-\n-        block(78)\n-        tx78 = create_tx(tx77, 0, 9*COIN)\n-        update_block(78, [tx78])\n-        yield accepted()\n-\n-        block(79)\n-        tx79 = create_tx(tx78, 0, 8*COIN)\n-        update_block(79, [tx79])\n-        yield accepted()\n+        self.log.info(\"Test transaction resurrection during a re-org\")\n+        self.move_tip(76)\n+        b77 = self.next_block(77)\n+        tx77 = self.create_and_sign_transaction(out[24].tx, out[24].n, 10 * COIN)\n+        b77 = self.update_block(77, [tx77])\n+        self.sync_blocks([b77], True)\n+        self.save_spendable_output()\n+\n+        b78 = self.next_block(78)\n+        tx78 = self.create_tx(tx77, 0, 9 * COIN)\n+        b78 = self.update_block(78, [tx78])\n+        self.sync_blocks([b78], True)\n+\n+        b79 = self.next_block(79)\n+        tx79 = self.create_tx(tx78, 0, 8 * COIN)\n+        b79 = self.update_block(79, [tx79])\n+        self.sync_blocks([b79], True)\n \n         # mempool should be empty\n         assert_equal(len(self.nodes[0].getrawmempool()), 0)\n \n-        tip(77)\n-        block(80, spend=out[25])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(77)\n+        b80 = self.next_block(80, spend=out[25])\n+        self.sync_blocks([b80], False, request_block=False)\n+        self.save_spendable_output()\n \n-        block(81, spend=out[26])\n-        yield rejected() # other chain is same length\n-        save_spendable_output()\n+        b81 = self.next_block(81, spend=out[26])\n+        self.sync_blocks([b81], False, request_block=False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(82, spend=out[27])\n-        yield accepted()  # now this chain is longer, triggers re-org\n-        save_spendable_output()\n+        b82 = self.next_block(82, spend=out[27])\n+        self.sync_blocks([b82], True)  # now this chain is longer, triggers re-org\n+        self.save_spendable_output()\n \n         # now check that tx78 and tx79 have been put back into the peer's mempool\n         mempool = self.nodes[0].getrawmempool()\n         assert_equal(len(mempool), 2)\n         assert(tx78.hash in mempool)\n         assert(tx79.hash in mempool)\n \n-\n         # Test invalid opcodes in dead execution paths.\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28)\n         #\n-        block(83)\n+        self.log.info(\"Accept a block with invalid opcodes in dead execution paths\")\n+        b83 = self.next_block(83)\n         op_codes = [OP_IF, OP_INVALIDOPCODE, OP_ELSE, OP_TRUE, OP_ENDIF]\n         script = CScript(op_codes)\n-        tx1 = create_and_sign_tx(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n+        tx1 = self.create_and_sign_transaction(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n \n-        tx2 = create_and_sign_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        tx2 = self.create_and_sign_transaction(tx1, 0, 0, CScript([OP_TRUE]))\n         tx2.vin[0].scriptSig = CScript([OP_FALSE])\n         tx2.rehash()\n \n-        update_block(83, [tx1, tx2])\n-        yield accepted()\n-        save_spendable_output()\n-\n+        b83 = self.update_block(83, [tx1, tx2])\n+        self.sync_blocks([b83], True)\n+        self.save_spendable_output()\n \n         # Reorg on/off blocks that have OP_RETURN in them (and try to spend them)\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28) -> b84 (29) -> b87 (30) -> b88 (31)\n         #                                    \\-> b85 (29) -> b86 (30)            \\-> b89a (32)\n         #\n-        #\n-        block(84)\n-        tx1 = create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n+        self.log.info(\"Test re-orging blocks with OP_RETURN in them\")\n+        b84 = self.next_block(84)\n+        tx1 = self.create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.calc_sha256()\n         self.sign_tx(tx1, out[29].tx, out[29].n)\n         tx1.rehash()\n-        tx2 = create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n+        tx2 = self.create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n         tx2.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx3 = create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n+        tx3 = self.create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n         tx3.vout.append(CTxOut(0, CScript([OP_TRUE])))\n-        tx4 = create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n+        tx4 = self.create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n         tx4.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx5 = create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n+        tx5 = self.create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n \n-        update_block(84, [tx1,tx2,tx3,tx4,tx5])\n-        yield accepted()\n-        save_spendable_output()\n+        b84 = self.update_block(84, [tx1, tx2, tx3, tx4, tx5])\n+        self.sync_blocks([b84], True)\n+        self.save_spendable_output()\n \n-        tip(83)\n-        block(85, spend=out[29])\n-        yield rejected()\n+        self.move_tip(83)\n+        b85 = self.next_block(85, spend=out[29])\n+        self.sync_blocks([b85], False)  # other chain is same length\n \n-        block(86, spend=out[30])\n-        yield accepted()\n+        b86 = self.next_block(86, spend=out[30])\n+        self.sync_blocks([b86], True)\n \n-        tip(84)\n-        block(87, spend=out[30])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(84)\n+        b87 = self.next_block(87, spend=out[30])\n+        self.sync_blocks([b87], False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(88, spend=out[31])\n-        yield accepted()\n-        save_spendable_output()\n+        b88 = self.next_block(88, spend=out[31])\n+        self.sync_blocks([b88], True)\n+        self.save_spendable_output()\n \n         # trying to spend the OP_RETURN output is rejected\n-        block(\"89a\", spend=out[32])\n-        tx = create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n-        update_block(\"89a\", [tx])\n-        yield rejected()\n-\n-\n-        #  Test re-org of a week's worth of blocks (1088 blocks)\n-        #  This test takes a minute or two and can be accomplished in memory\n-        #\n-        if self.options.runbarelyexpensive:\n-            tip(88)\n-            LARGE_REORG_SIZE = 1088\n-            test1 = TestInstance(sync_every_block=False)\n-            spend=out[32]\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                b = block(i, spend)\n-                tx = CTransaction()\n-                script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n-                script_output = CScript([b'\\x00' * script_length])\n-                tx.vout.append(CTxOut(0, script_output))\n-                tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n-                b = update_block(i, [tx])\n-                assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n-                test1.blocks_and_transactions.append([self.tip, True])\n-                save_spendable_output()\n-                spend = get_spendable_output()\n-\n-            yield test1\n-            chain1_tip = i\n-\n-            # now create alt chain of same length\n-            tip(88)\n-            test2 = TestInstance(sync_every_block=False)\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                block(\"alt\"+str(i))\n-                test2.blocks_and_transactions.append([self.tip, False])\n-            yield test2\n-\n-            # extend alt chain to trigger re-org\n-            block(\"alt\" + str(chain1_tip + 1))\n-            yield accepted()\n-\n-            # ... and re-org back to the first chain\n-            tip(chain1_tip)\n-            block(chain1_tip + 1)\n-            yield rejected()\n-            block(chain1_tip + 2)\n-            yield accepted()\n-\n-            chain1_tip += 2\n+        b89a = self.next_block(\"89a\", spend=out[32])\n+        tx = self.create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        b89a = self.update_block(\"89a\", [tx])\n+        self.sync_blocks([b89a], False, 16, b'bad-txns-inputs-missingorspent', reconnect=True)\n+\n+        self.log.info(\"Test a re-org of one week's worth of blocks (1088 blocks)\")\n+\n+        self.move_tip(88)\n+        LARGE_REORG_SIZE = 1088\n+        blocks = []\n+        spend = out[32]\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            b = self.next_block(i, spend)\n+            tx = CTransaction()\n+            script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n+            script_output = CScript([b'\\x00' * script_length])\n+            tx.vout.append(CTxOut(0, script_output))\n+            tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n+            b = self.update_block(i, [tx])\n+            assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n+            blocks.append(b)\n+            self.save_spendable_output()\n+            spend = self.get_spendable_output()\n+\n+        self.sync_blocks(blocks, True, timeout=180)\n+        chain1_tip = i\n+\n+        # now create alt chain of same length\n+        self.move_tip(88)\n+        blocks2 = []\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            blocks2.append(self.next_block(\"alt\" + str(i)))\n+        self.sync_blocks(blocks2, False, request_block=False)\n+\n+        # extend alt chain to trigger re-org\n+        block = self.next_block(\"alt\" + str(chain1_tip + 1))\n+        self.sync_blocks([block], True, timeout=180)\n+\n+        # ... and re-org back to the first chain\n+        self.move_tip(chain1_tip)\n+        block = self.next_block(chain1_tip + 1)\n+        self.sync_blocks([block], False, request_block=False)\n+        block = self.next_block(chain1_tip + 2)\n+        self.sync_blocks([block], True, timeout=180)\n+\n+    # Helper methods\n+    ################\n+\n+    def add_transactions_to_block(self, block, tx_list):\n+        [tx.rehash() for tx in tx_list]\n+        block.vtx.extend(tx_list)\n+\n+    # this is a little handier to use than the version in blocktools.py\n+    def create_tx(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        return create_transaction(spend_tx, n, b\"\", value, script)\n+\n+    # sign a transaction, using the key we know about\n+    # this signs input 0 in tx, which is assumed to be spending output n in spend_tx\n+    def sign_tx(self, tx, spend_tx, n):\n+        scriptPubKey = bytearray(spend_tx.vout[n].scriptPubKey)\n+        if (scriptPubKey[0] == OP_TRUE):  # an anyone-can-spend\n+            tx.vin[0].scriptSig = CScript()\n+            return\n+        (sighash, err) = SignatureHash(spend_tx.vout[n].scriptPubKey, tx, 0, SIGHASH_ALL)\n+        tx.vin[0].scriptSig = CScript([self.coinbase_key.sign(sighash) + bytes(bytearray([SIGHASH_ALL]))])\n+\n+    def create_and_sign_transaction(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        tx = self.create_tx(spend_tx, n, value, script)\n+        self.sign_tx(tx, spend_tx, n)\n+        tx.rehash()\n+        return tx\n+\n+    def next_block(self, number, spend=None, additional_coinbase_value=0, script=CScript([OP_TRUE]), solve=True):\n+        if self.tip is None:\n+            base_block_hash = self.genesis_hash\n+            block_time = int(time.time()) + 1\n+        else:\n+            base_block_hash = self.tip.sha256\n+            block_time = self.tip.nTime + 1\n+        # First create the coinbase\n+        height = self.block_heights[base_block_hash] + 1\n+        coinbase = create_coinbase(height, self.coinbase_pubkey)\n+        coinbase.vout[0].nValue += additional_coinbase_value\n+        coinbase.rehash()\n+        if spend is None:\n+            block = create_block(base_block_hash, coinbase, block_time)\n+        else:\n+            coinbase.vout[0].nValue += spend.tx.vout[spend.n].nValue - 1  # all but one satoshi to fees\n+            coinbase.rehash()\n+            block = create_block(base_block_hash, coinbase, block_time)\n+            tx = create_transaction(spend.tx, spend.n, b\"\", 1, script)  # spend 1 satoshi\n+            self.sign_tx(tx, spend.tx, spend.n)\n+            self.add_transactions_to_block(block, [tx])\n+            block.hashMerkleRoot = block.calc_merkle_root()\n+        if solve:\n+            block.solve()\n+        self.tip = block\n+        self.block_heights[block.sha256] = height\n+        assert number not in self.blocks\n+        self.blocks[number] = block\n+        return block\n+\n+    # save the current tip so it can be spent by a later block\n+    def save_spendable_output(self):\n+        self.log.debug(\"saving spendable output %s\" % self.tip.vtx[0])\n+        self.spendable_outputs.append(self.tip)\n+\n+    # get an output that we previously marked as spendable\n+    def get_spendable_output(self):\n+        self.log.debug(\"getting spendable output %s\" % self.spendable_outputs[0].vtx[0])\n+        return PreviousSpendableOutput(self.spendable_outputs.pop(0).vtx[0], 0)\n+\n+    # move the tip back to a previous block\n+    def move_tip(self, number):\n+        self.tip = self.blocks[number]\n+\n+    # adds transactions to the block and updates state\n+    def update_block(self, block_number, new_transactions):\n+        block = self.blocks[block_number]\n+        self.add_transactions_to_block(block, new_transactions)\n+        old_sha256 = block.sha256\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Update the internal state just like in next_block\n+        self.tip = block\n+        if block.sha256 != old_sha256:\n+            self.block_heights[block.sha256] = self.block_heights[old_sha256]\n+            del self.block_heights[old_sha256]\n+        self.blocks[block_number] = block\n+        return block\n+\n+    def reconnect_p2p(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177549532",
      "id" : 177549532,
      "in_reply_to_id" : 177537490,
      "original_commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "original_position" : 1832,
      "path" : "test/functional/feature_block.py",
      "position" : 1832,
      "pull_request_review_id" : 107440420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-27T19:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177549532",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "4 ACKs. Ready for merge @MarcoFalke ?",
      "created_at" : "2018-03-27T19:45:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376650940",
      "id" : 376650940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-27T19:45:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376650940",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177557271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177557271"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, definitely later.",
      "commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-27T20:14:02Z",
      "diff_hunk" : "@@ -1133,161 +1063,259 @@ def update_block(block_number, new_transactions):\n         #    To get around this issue, we construct transactions which are not signed and which\n         #    spend to OP_TRUE.  If the standard-ness rules change, this test would need to be\n         #    updated.  (Perhaps to spend to a P2SH OP_TRUE script)\n-        #\n-        tip(76)\n-        block(77)\n-        tx77 = create_and_sign_tx(out[24].tx, out[24].n, 10*COIN)\n-        update_block(77, [tx77])\n-        yield accepted()\n-        save_spendable_output()\n-\n-        block(78)\n-        tx78 = create_tx(tx77, 0, 9*COIN)\n-        update_block(78, [tx78])\n-        yield accepted()\n-\n-        block(79)\n-        tx79 = create_tx(tx78, 0, 8*COIN)\n-        update_block(79, [tx79])\n-        yield accepted()\n+        self.log.info(\"Test transaction resurrection during a re-org\")\n+        self.move_tip(76)\n+        b77 = self.next_block(77)\n+        tx77 = self.create_and_sign_transaction(out[24].tx, out[24].n, 10 * COIN)\n+        b77 = self.update_block(77, [tx77])\n+        self.sync_blocks([b77], True)\n+        self.save_spendable_output()\n+\n+        b78 = self.next_block(78)\n+        tx78 = self.create_tx(tx77, 0, 9 * COIN)\n+        b78 = self.update_block(78, [tx78])\n+        self.sync_blocks([b78], True)\n+\n+        b79 = self.next_block(79)\n+        tx79 = self.create_tx(tx78, 0, 8 * COIN)\n+        b79 = self.update_block(79, [tx79])\n+        self.sync_blocks([b79], True)\n \n         # mempool should be empty\n         assert_equal(len(self.nodes[0].getrawmempool()), 0)\n \n-        tip(77)\n-        block(80, spend=out[25])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(77)\n+        b80 = self.next_block(80, spend=out[25])\n+        self.sync_blocks([b80], False, request_block=False)\n+        self.save_spendable_output()\n \n-        block(81, spend=out[26])\n-        yield rejected() # other chain is same length\n-        save_spendable_output()\n+        b81 = self.next_block(81, spend=out[26])\n+        self.sync_blocks([b81], False, request_block=False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(82, spend=out[27])\n-        yield accepted()  # now this chain is longer, triggers re-org\n-        save_spendable_output()\n+        b82 = self.next_block(82, spend=out[27])\n+        self.sync_blocks([b82], True)  # now this chain is longer, triggers re-org\n+        self.save_spendable_output()\n \n         # now check that tx78 and tx79 have been put back into the peer's mempool\n         mempool = self.nodes[0].getrawmempool()\n         assert_equal(len(mempool), 2)\n         assert(tx78.hash in mempool)\n         assert(tx79.hash in mempool)\n \n-\n         # Test invalid opcodes in dead execution paths.\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28)\n         #\n-        block(83)\n+        self.log.info(\"Accept a block with invalid opcodes in dead execution paths\")\n+        b83 = self.next_block(83)\n         op_codes = [OP_IF, OP_INVALIDOPCODE, OP_ELSE, OP_TRUE, OP_ENDIF]\n         script = CScript(op_codes)\n-        tx1 = create_and_sign_tx(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n+        tx1 = self.create_and_sign_transaction(out[28].tx, out[28].n, out[28].tx.vout[0].nValue, script)\n \n-        tx2 = create_and_sign_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        tx2 = self.create_and_sign_transaction(tx1, 0, 0, CScript([OP_TRUE]))\n         tx2.vin[0].scriptSig = CScript([OP_FALSE])\n         tx2.rehash()\n \n-        update_block(83, [tx1, tx2])\n-        yield accepted()\n-        save_spendable_output()\n-\n+        b83 = self.update_block(83, [tx1, tx2])\n+        self.sync_blocks([b83], True)\n+        self.save_spendable_output()\n \n         # Reorg on/off blocks that have OP_RETURN in them (and try to spend them)\n         #\n         #  -> b81 (26) -> b82 (27) -> b83 (28) -> b84 (29) -> b87 (30) -> b88 (31)\n         #                                    \\-> b85 (29) -> b86 (30)            \\-> b89a (32)\n         #\n-        #\n-        block(84)\n-        tx1 = create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n+        self.log.info(\"Test re-orging blocks with OP_RETURN in them\")\n+        b84 = self.next_block(84)\n+        tx1 = self.create_tx(out[29].tx, out[29].n, 0, CScript([OP_RETURN]))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.vout.append(CTxOut(0, CScript([OP_TRUE])))\n         tx1.calc_sha256()\n         self.sign_tx(tx1, out[29].tx, out[29].n)\n         tx1.rehash()\n-        tx2 = create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n+        tx2 = self.create_tx(tx1, 1, 0, CScript([OP_RETURN]))\n         tx2.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx3 = create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n+        tx3 = self.create_tx(tx1, 2, 0, CScript([OP_RETURN]))\n         tx3.vout.append(CTxOut(0, CScript([OP_TRUE])))\n-        tx4 = create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n+        tx4 = self.create_tx(tx1, 3, 0, CScript([OP_TRUE]))\n         tx4.vout.append(CTxOut(0, CScript([OP_RETURN])))\n-        tx5 = create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n+        tx5 = self.create_tx(tx1, 4, 0, CScript([OP_RETURN]))\n \n-        update_block(84, [tx1,tx2,tx3,tx4,tx5])\n-        yield accepted()\n-        save_spendable_output()\n+        b84 = self.update_block(84, [tx1, tx2, tx3, tx4, tx5])\n+        self.sync_blocks([b84], True)\n+        self.save_spendable_output()\n \n-        tip(83)\n-        block(85, spend=out[29])\n-        yield rejected()\n+        self.move_tip(83)\n+        b85 = self.next_block(85, spend=out[29])\n+        self.sync_blocks([b85], False)  # other chain is same length\n \n-        block(86, spend=out[30])\n-        yield accepted()\n+        b86 = self.next_block(86, spend=out[30])\n+        self.sync_blocks([b86], True)\n \n-        tip(84)\n-        block(87, spend=out[30])\n-        yield rejected()\n-        save_spendable_output()\n+        self.move_tip(84)\n+        b87 = self.next_block(87, spend=out[30])\n+        self.sync_blocks([b87], False)  # other chain is same length\n+        self.save_spendable_output()\n \n-        block(88, spend=out[31])\n-        yield accepted()\n-        save_spendable_output()\n+        b88 = self.next_block(88, spend=out[31])\n+        self.sync_blocks([b88], True)\n+        self.save_spendable_output()\n \n         # trying to spend the OP_RETURN output is rejected\n-        block(\"89a\", spend=out[32])\n-        tx = create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n-        update_block(\"89a\", [tx])\n-        yield rejected()\n-\n-\n-        #  Test re-org of a week's worth of blocks (1088 blocks)\n-        #  This test takes a minute or two and can be accomplished in memory\n-        #\n-        if self.options.runbarelyexpensive:\n-            tip(88)\n-            LARGE_REORG_SIZE = 1088\n-            test1 = TestInstance(sync_every_block=False)\n-            spend=out[32]\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                b = block(i, spend)\n-                tx = CTransaction()\n-                script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n-                script_output = CScript([b'\\x00' * script_length])\n-                tx.vout.append(CTxOut(0, script_output))\n-                tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n-                b = update_block(i, [tx])\n-                assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n-                test1.blocks_and_transactions.append([self.tip, True])\n-                save_spendable_output()\n-                spend = get_spendable_output()\n-\n-            yield test1\n-            chain1_tip = i\n-\n-            # now create alt chain of same length\n-            tip(88)\n-            test2 = TestInstance(sync_every_block=False)\n-            for i in range(89, LARGE_REORG_SIZE + 89):\n-                block(\"alt\"+str(i))\n-                test2.blocks_and_transactions.append([self.tip, False])\n-            yield test2\n-\n-            # extend alt chain to trigger re-org\n-            block(\"alt\" + str(chain1_tip + 1))\n-            yield accepted()\n-\n-            # ... and re-org back to the first chain\n-            tip(chain1_tip)\n-            block(chain1_tip + 1)\n-            yield rejected()\n-            block(chain1_tip + 2)\n-            yield accepted()\n-\n-            chain1_tip += 2\n+        b89a = self.next_block(\"89a\", spend=out[32])\n+        tx = self.create_tx(tx1, 0, 0, CScript([OP_TRUE]))\n+        b89a = self.update_block(\"89a\", [tx])\n+        self.sync_blocks([b89a], False, 16, b'bad-txns-inputs-missingorspent', reconnect=True)\n+\n+        self.log.info(\"Test a re-org of one week's worth of blocks (1088 blocks)\")\n+\n+        self.move_tip(88)\n+        LARGE_REORG_SIZE = 1088\n+        blocks = []\n+        spend = out[32]\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            b = self.next_block(i, spend)\n+            tx = CTransaction()\n+            script_length = MAX_BLOCK_BASE_SIZE - len(b.serialize()) - 69\n+            script_output = CScript([b'\\x00' * script_length])\n+            tx.vout.append(CTxOut(0, script_output))\n+            tx.vin.append(CTxIn(COutPoint(b.vtx[1].sha256, 0)))\n+            b = self.update_block(i, [tx])\n+            assert_equal(len(b.serialize()), MAX_BLOCK_BASE_SIZE)\n+            blocks.append(b)\n+            self.save_spendable_output()\n+            spend = self.get_spendable_output()\n+\n+        self.sync_blocks(blocks, True, timeout=180)\n+        chain1_tip = i\n+\n+        # now create alt chain of same length\n+        self.move_tip(88)\n+        blocks2 = []\n+        for i in range(89, LARGE_REORG_SIZE + 89):\n+            blocks2.append(self.next_block(\"alt\" + str(i)))\n+        self.sync_blocks(blocks2, False, request_block=False)\n+\n+        # extend alt chain to trigger re-org\n+        block = self.next_block(\"alt\" + str(chain1_tip + 1))\n+        self.sync_blocks([block], True, timeout=180)\n+\n+        # ... and re-org back to the first chain\n+        self.move_tip(chain1_tip)\n+        block = self.next_block(chain1_tip + 1)\n+        self.sync_blocks([block], False, request_block=False)\n+        block = self.next_block(chain1_tip + 2)\n+        self.sync_blocks([block], True, timeout=180)\n+\n+    # Helper methods\n+    ################\n+\n+    def add_transactions_to_block(self, block, tx_list):\n+        [tx.rehash() for tx in tx_list]\n+        block.vtx.extend(tx_list)\n+\n+    # this is a little handier to use than the version in blocktools.py\n+    def create_tx(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        return create_transaction(spend_tx, n, b\"\", value, script)\n+\n+    # sign a transaction, using the key we know about\n+    # this signs input 0 in tx, which is assumed to be spending output n in spend_tx\n+    def sign_tx(self, tx, spend_tx, n):\n+        scriptPubKey = bytearray(spend_tx.vout[n].scriptPubKey)\n+        if (scriptPubKey[0] == OP_TRUE):  # an anyone-can-spend\n+            tx.vin[0].scriptSig = CScript()\n+            return\n+        (sighash, err) = SignatureHash(spend_tx.vout[n].scriptPubKey, tx, 0, SIGHASH_ALL)\n+        tx.vin[0].scriptSig = CScript([self.coinbase_key.sign(sighash) + bytes(bytearray([SIGHASH_ALL]))])\n+\n+    def create_and_sign_transaction(self, spend_tx, n, value, script=CScript([OP_TRUE])):\n+        tx = self.create_tx(spend_tx, n, value, script)\n+        self.sign_tx(tx, spend_tx, n)\n+        tx.rehash()\n+        return tx\n+\n+    def next_block(self, number, spend=None, additional_coinbase_value=0, script=CScript([OP_TRUE]), solve=True):\n+        if self.tip is None:\n+            base_block_hash = self.genesis_hash\n+            block_time = int(time.time()) + 1\n+        else:\n+            base_block_hash = self.tip.sha256\n+            block_time = self.tip.nTime + 1\n+        # First create the coinbase\n+        height = self.block_heights[base_block_hash] + 1\n+        coinbase = create_coinbase(height, self.coinbase_pubkey)\n+        coinbase.vout[0].nValue += additional_coinbase_value\n+        coinbase.rehash()\n+        if spend is None:\n+            block = create_block(base_block_hash, coinbase, block_time)\n+        else:\n+            coinbase.vout[0].nValue += spend.tx.vout[spend.n].nValue - 1  # all but one satoshi to fees\n+            coinbase.rehash()\n+            block = create_block(base_block_hash, coinbase, block_time)\n+            tx = create_transaction(spend.tx, spend.n, b\"\", 1, script)  # spend 1 satoshi\n+            self.sign_tx(tx, spend.tx, spend.n)\n+            self.add_transactions_to_block(block, [tx])\n+            block.hashMerkleRoot = block.calc_merkle_root()\n+        if solve:\n+            block.solve()\n+        self.tip = block\n+        self.block_heights[block.sha256] = height\n+        assert number not in self.blocks\n+        self.blocks[number] = block\n+        return block\n+\n+    # save the current tip so it can be spent by a later block\n+    def save_spendable_output(self):\n+        self.log.debug(\"saving spendable output %s\" % self.tip.vtx[0])\n+        self.spendable_outputs.append(self.tip)\n+\n+    # get an output that we previously marked as spendable\n+    def get_spendable_output(self):\n+        self.log.debug(\"getting spendable output %s\" % self.spendable_outputs[0].vtx[0])\n+        return PreviousSpendableOutput(self.spendable_outputs.pop(0).vtx[0], 0)\n+\n+    # move the tip back to a previous block\n+    def move_tip(self, number):\n+        self.tip = self.blocks[number]\n+\n+    # adds transactions to the block and updates state\n+    def update_block(self, block_number, new_transactions):\n+        block = self.blocks[block_number]\n+        self.add_transactions_to_block(block, new_transactions)\n+        old_sha256 = block.sha256\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Update the internal state just like in next_block\n+        self.tip = block\n+        if block.sha256 != old_sha256:\n+            self.block_heights[block.sha256] = self.block_heights[old_sha256]\n+            del self.block_heights[old_sha256]\n+        self.blocks[block_number] = block\n+        return block\n+\n+    def reconnect_p2p(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#discussion_r177557271",
      "id" : 177557271,
      "in_reply_to_id" : 177537490,
      "original_commit_id" : "265d7c44b1aae06aee93f745a865807732218a73",
      "original_position" : 1832,
      "path" : "test/functional/feature_block.py",
      "position" : 1832,
      "pull_request_review_id" : 107449977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11773",
      "updated_at" : "2018-03-27T20:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177557271",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 265d7c44b1aae06aee93f745a865807732218a73",
      "created_at" : "2018-03-27T20:35:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11773#issuecomment-376666080",
      "id" : 376666080,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11773",
      "updated_at" : "2018-03-27T20:35:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376666080",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
