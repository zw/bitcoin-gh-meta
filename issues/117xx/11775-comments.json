[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Obviously this cleans up some of the interface gook from #10286, and adds some more docs that probably could have been there. Next up after this one is moving alll the remaining events all into the background thread, with associated net_processing cleanups in the process.",
      "created_at" : "2017-11-27T20:29:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#issuecomment-347317891",
      "id" : 347317891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11775",
      "updated_at" : "2017-11-27T20:29:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/347317891",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r153686716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153686716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Split removeRecursive into calculate/remove steps\r\n\r\nstyle: Capitalize function name.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2017-11-29T03:31:46Z",
      "diff_hunk" : "@@ -492,6 +492,8 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const;\n \n+    void calculateRemoveRecursive(const CTransaction &tx, setEntries &stage);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r153686716",
      "id" : 153686716,
      "original_commit_id" : "188179e008cd953bf3bd4b651ded54cb6fd60f8d",
      "original_position" : 4,
      "path" : "src/txmempool.h",
      "position" : 20,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/153686716",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased.",
      "created_at" : "2017-12-13T22:34:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#issuecomment-351547020",
      "id" : 351547020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11775",
      "updated_at" : "2017-12-13T22:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351547020",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThough I'm nervous about backgrounding more stuff before safeguarding against outside (unsynchronized) access. For example, the mempool/feeestimator may now be significantly ahead of what the wallet has processed. So calling CreateTransaction when we're in the middle of connecting 10 blocks seems... dangerous, even with the BlockUntilSyncedToCurrentChain hack.\r\n",
      "created_at" : "2017-12-19T00:13:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#issuecomment-352598832",
      "id" : 352598832,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11775",
      "updated_at" : "2017-12-19T00:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/352598832",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm? If anything the fee estimator should be at much lower risk there than for wallet...at worst you'll get out of date fee estimates...something you'd get anyway because you're calling the fee estimator in the middle of syncing stuff. Note that #11824 also keeps the queue depth at no more than 10, though I dont really want to rely on that and would prefer to implement the dump/reload-from-disk proposal suggested at https://github.com/bitcoin/bitcoin/pull/11775/files#diff-e8d9e22d9683f73a9fb8399be0dab640R145",
      "created_at" : "2017-12-19T00:34:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#issuecomment-352602229",
      "id" : 352602229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11775",
      "updated_at" : "2017-12-19T00:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/352602229",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased.",
      "created_at" : "2018-03-27T21:13:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#issuecomment-376677416",
      "id" : 376677416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11775",
      "updated_at" : "2018-03-27T21:13:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/376677416",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178595675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178595675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Split removeRecursive into calculate/remove steps\r\n\r\nShould this AssertLockHeld?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T17:23:54Z",
      "diff_hunk" : "@@ -470,11 +470,8 @@ void CTxMemPool::CalculateDescendants(txiter entryit, setEntries &setDescendants\n     }\n }\n \n-void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReason reason)\n+void CTxMemPool::calculateRemoveRecursive(const CTransaction &origTx, setEntries &setAllRemoves)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178595675",
      "id" : 178595675,
      "original_commit_id" : "f0d6d0bb6b34c18762ab0c30b970875698519f55",
      "original_position" : 5,
      "path" : "src/txmempool.cpp",
      "position" : 63,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178595675",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178597496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178597496"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Track the set of transactions removed/conflicted in removeForBlock\r\n\r\nI think this `reserve` call could be less performant than skipping it if there are a sufficient number of conflicting inputs. https://stackoverflow.com/a/1742961",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T17:30:57Z",
      "diff_hunk" : "@@ -551,7 +551,13 @@ void CTxMemPool::removeConflicts(const CTransaction &tx)\n             if (txConflict != tx)\n             {\n                 ClearPrioritisation(txConflict.GetHash());\n-                removeRecursive(txConflict, MemPoolRemovalReason::CONFLICT);\n+                setEntries set_removes;\n+                calculateRemoveRecursive(txConflict, set_removes);\n+                txn_removed.reserve(txn_removed.size() + set_removes.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178597496",
      "id" : 178597496,
      "original_commit_id" : "b3a9ecb5684cda9a0bb9bb64a9946d5e2b259a8c",
      "original_position" : 16,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178597496",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178607413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178607413"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: BlockConnected(vtxConflicted) -> New MempoolInterface callback\r\n\r\nWhy not just move that logic here from BlockConnected as well?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:08:13Z",
      "diff_hunk" : "@@ -1226,7 +1226,16 @@ void CWallet::TransactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolR\n     }\n }\n \n-void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+void CWallet::MempoolUpdatedForBlockConnect(const std::vector<CTransactionRef>& tx_removed_in_block, const std::vector<CTransactionRef>& tx_removed_conflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    for (const CTransactionRef& ptx : tx_removed_conflicted) {\n+        SyncTransaction(ptx);\n+        TransactionRemovedFromMempool(ptx, MemPoolRemovalReason::CONFLICT);\n+    }\n+    // We can ignore tx_removed_in_block, we'll get it in BlockConnected",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178607413",
      "id" : 178607413,
      "original_commit_id" : "a897ff03aef495d3ede6f11cafc2672563650678",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178607413",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178609180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178609180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Add txn_replaced to Added callback, remove lReplaced ATMP arg\r\n\r\nnit: Space after `if`",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:14:45Z",
      "diff_hunk" : "@@ -197,7 +197,8 @@ void Shutdown()\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (peerLogic) UnregisterValidationInterface(peerLogic.get());\n-    if (g_connman) g_connman->Stop();\n+    if (peerLogic) UnregisterMempoolInterface(peerLogic.get());\n+    if(g_connman) g_connman->Stop();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178609180",
      "id" : 178609180,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178609180",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178611267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178611267"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Add txn_replaced to Added callback, remove lReplaced ATMP arg\r\n\r\nIt wasn't obvious to me what ATMP stood for. I think it would be better to spell out `AddToMemoryPool` for clarity.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:23:08Z",
      "diff_hunk" : "@@ -418,8 +418,10 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry,\n \n void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n {\n-    if (reason != MemPoolRemovalReason::BLOCK && reason != MemPoolRemovalReason::CONFLICT) {\n+    if (reason != MemPoolRemovalReason::BLOCK && reason != MemPoolRemovalReason::CONFLICT &&\n+        reason != MemPoolRemovalReason::REPLACED) {\n         // BLOCK and CONFLICT callbacks are generated in removeForBlock\n+        // REPLACED txn are included in TransactionAddedToMempool from ATMP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178611267",
      "id" : 178611267,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 8,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178611267",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178615598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178615598"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Add txn_replaced to Added callback, remove lReplaced ATMP arg\r\n\r\nThis method takes a `std::shared_ptr` while `MempoolUpdatedForBlockConnect` takes rvalue refs and constructs the `std::shared_ptr`s itself. I think these should be consistent.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:39:47Z",
      "diff_hunk" : "@@ -152,9 +152,9 @@ void CMainSignals::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInd\n     });\n }\n \n-void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx) {\n-    m_internals->m_schedulerClient.AddToProcessQueue([ptx, this] {\n-        m_internals->TransactionAddedToMempool(ptx);\n+void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx, const std::shared_ptr<std::vector<CTransactionRef>>& txn_replaced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178615598",
      "id" : 178615598,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 34,
      "path" : "src/validationinterface.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178615598",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\ntypo: thransaction",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:46:53Z",
      "diff_hunk" : "@@ -70,6 +70,28 @@ void SyncWithValidationInterfaceQueue();\n  * called on the thread generating the callbacks.\n  */\n class MempoolInterface {\n+public:\n+    /**\n+     * Information about a newly-added-to-mempool transaction.\n+     */\n+    struct NewMempoolTransactionInfo {\n+        //!A shared pointer to the transaction which was added.\n+        CTransactionRef m_tx;\n+        //! The fee the added thransaction paid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617351",
      "id" : 178617351,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 11,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617351",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nnit: space after bang",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:47:07Z",
      "diff_hunk" : "@@ -70,6 +70,28 @@ void SyncWithValidationInterfaceQueue();\n  * called on the thread generating the callbacks.\n  */\n class MempoolInterface {\n+public:\n+    /**\n+     * Information about a newly-added-to-mempool transaction.\n+     */\n+    struct NewMempoolTransactionInfo {\n+        //!A shared pointer to the transaction which was added.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617393",
      "id" : 178617393,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 9,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617393",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nnit: Remove braces or move statement body onto newline.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:49:24Z",
      "diff_hunk" : "@@ -599,6 +589,7 @@ void CTxMemPool::removeForBlock(const std::vector<CTransactionRef>& vtx, unsigne\n         removeConflicts(*tx, txn_conflicts);\n         ClearPrioritisation(tx->GetHash());\n     }\n+    if (minerPolicyEstimator) {minerPolicyEstimator->processBlock(nBlockHeight, txn_removed_in_block);}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178617924",
      "id" : 178617924,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 32,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178617924",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178618284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178618284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nnit: Move closing brace onto newline.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:50:52Z",
      "diff_hunk" : "@@ -443,7 +443,8 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n     mapLinks.erase(it);\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n-    if (minerPolicyEstimator) {minerPolicyEstimator->removeTx(hash, false);}\n+    if (reason != MemPoolRemovalReason::BLOCK && minerPolicyEstimator) {\n+        minerPolicyEstimator->removeTx(hash);}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178618284",
      "id" : 178618284,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 6,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178618284",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178618859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178618859"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nstyle: s/inBlock/in_block/",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:53:07Z",
      "diff_hunk" : "@@ -504,20 +505,24 @@ void TxConfirmStats::removeTx(unsigned int entryHeight, unsigned int nBestSeenHe\n     }\n }\n \n+void CBlockPolicyEstimator::removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178618859",
      "id" : 178618859,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 25,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178618859",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178620537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178620537"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nAny particular reason to move this up here rather than leave it in the second `private` section where it is now?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T18:59:34Z",
      "diff_hunk" : "@@ -185,20 +186,30 @@ class CBlockPolicyEstimator\n      */\n     static constexpr double FEE_SPACING = 1.05;\n \n+    struct TxStatsInfo",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178620537",
      "id" : 178620537,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 12,
      "path" : "src/policy/fees.h",
      "position" : 25,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178620537",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178622043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178622043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nI'd move this erase immediately after the `removeTx` above and define `double fee_per_k = (double)pos->second.m_fee_per_k;` as a variable up there as well.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T19:06:06Z",
      "diff_hunk" : "@@ -577,43 +582,45 @@ void CBlockPolicyEstimator::processTransaction(const CTxMemPoolEntry& entry, boo\n     CFeeRate feeRate(entry.GetFee(), entry.GetTxSize());\n \n     mapMemPoolTxs[hash].blockHeight = txHeight;\n+    mapMemPoolTxs[hash].m_fee_per_k = feeRate.GetFeePerK();\n     unsigned int bucketIndex = feeStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n-    mapMemPoolTxs[hash].bucketIndex = bucketIndex;\n     unsigned int bucketIndex2 = shortStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex2);\n     unsigned int bucketIndex3 = longStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex3);\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxMemPoolEntry* entry)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n {\n-    if (!removeTx(entry->GetTx().GetHash(), true)) {\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    removeTx(pos, true);\n \n     // How many blocks did it take for miners to include this transaction?\n     // blocksToConfirm is 1-based, so a transaction included in the earliest\n     // possible block has confirmation count of 1\n-    int blocksToConfirm = nBlockHeight - entry->GetHeight();\n+    int blocksToConfirm = nBlockHeight - pos->second.blockHeight;\n     if (blocksToConfirm <= 0) {\n         // This can't happen because we don't process transactions from a block with a height\n         // lower than our greatest seen height\n         LogPrint(BCLog::ESTIMATEFEE, \"Blockpolicy error Transaction had negative blocksToConfirm\\n\");\n+        mapMemPoolTxs.erase(pos);\n         return false;\n     }\n \n-    // Feerates are stored and reported as BTC-per-kb:\n-    CFeeRate feeRate(entry->GetFee(), entry->GetTxSize());\n+    feeStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    shortStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    longStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n \n-    feeStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    shortStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    longStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n+    mapMemPoolTxs.erase(pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178622043",
      "id" : 178622043,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 97,
      "path" : "src/policy/fees.cpp",
      "position" : 153,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178622043",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178623164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178623164"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Make fee estimation not need CTxMemPoolEntry is block processing\r\n\r\nI don't really like that this method has the same name as the other `removeTx` because it's responsibilities are different.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T19:11:06Z",
      "diff_hunk" : "@@ -185,20 +186,30 @@ class CBlockPolicyEstimator\n      */\n     static constexpr double FEE_SPACING = 1.05;\n \n+    struct TxStatsInfo\n+    {\n+        unsigned int blockHeight;\n+        CAmount m_fee_per_k;\n+        TxStatsInfo() : blockHeight(0), m_fee_per_k(0) {}\n+    };\n+\n+    /** Remove a transaction from the mempool tracking stats*/\n+    void removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178623164",
      "id" : 178623164,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 20,
      "path" : "src/policy/fees.h",
      "position" : 34,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178623164",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178636650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178636650"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Track witness hash malleation in fee estimator\r\n\r\nWhy don't we want to record the blocks to confirm in this case?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T20:10:45Z",
      "diff_hunk" : "@@ -580,13 +581,20 @@ void CBlockPolicyEstimator::TransactionRemovedFromMempool(const CTransactionRef\n     removeTxNotInBlock(tx->GetHash());\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTransactionRef& tx)\n {\n-    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(tx->GetHash());\n     if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    if (pos->second.witness_hash != tx->GetWitnessHash()) {\n+        // In the case that we saw a tx which had its witness malleated,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178636650",
      "id" : 178636650,
      "original_commit_id" : "68d7445e2350b1f3cd8ad0bc79bd06c79c23ad00",
      "original_position" : 22,
      "path" : "src/policy/fees.cpp",
      "position" : 123,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178636650",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178639530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178639530"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Process fee estimates in the background via MempoolInterface\r\n\r\nUse SyncWithValidationInterfaceQueue?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T20:22:18Z",
      "diff_hunk" : "@@ -77,6 +84,13 @@ BOOST_AUTO_TEST_CASE(BlockPolicyEstimates)\n         block.clear();\n         // Check after just a few txs that combining buckets works as expected\n         if (blocknum == 3) {\n+            // Wait for fee estimator to catch up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178639530",
      "id" : 178639530,
      "original_commit_id" : "9266c936b747e564859275165e5e12983ed56301",
      "original_position" : 40,
      "path" : "src/test/policyestimator_tests.cpp",
      "position" : 41,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178639530",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178639756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178639756"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Process fee estimates in the background via MempoolInterface\r\n\r\nMake the callbacks protected?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-02T20:23:09Z",
      "diff_hunk" : "@@ -196,20 +197,18 @@ class CBlockPolicyEstimator\n     /** Remove a transaction from the mempool tracking stats*/\n     void removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock);\n \n+    /** Helper method to quickly remove transactions that left mempool without going in a block */\n+    void removeTxNotInBlock(const uint256& hash);\n+\n public:\n     /** Create new BlockPolicyEstimator and initialize stats tracking classes with default values */\n     CBlockPolicyEstimator();\n     ~CBlockPolicyEstimator();\n \n-    /** Process all the transactions that have been included in a block */\n-    void processBlock(unsigned int nBlockHeight,\n-                      const std::vector<CTransactionRef>& txn_removed_in_block);\n-\n-    /** Process a transaction accepted to the mempool*/\n-    void processTransaction(const CTxMemPoolEntry& entry, bool validFeeEstimate);\n-\n-    /** Remove a transaction from the mempool tracking stats*/\n-    bool removeTx(uint256 hash);\n+    // MempoolInterface functions:\n+    void TransactionAddedToMempool(const NewMempoolTransactionInfo& info, const std::vector<CTransactionRef>& txn_replaced) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r178639756",
      "id" : 178639756,
      "original_commit_id" : "9266c936b747e564859275165e5e12983ed56301",
      "original_position" : 39,
      "path" : "src/policy/fees.h",
      "position" : null,
      "pull_request_review_id" : 79728713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178639756",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:29Z",
      "diff_hunk" : "@@ -196,20 +197,18 @@ class CBlockPolicyEstimator\n     /** Remove a transaction from the mempool tracking stats*/\n     void removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock);\n \n+    /** Helper method to quickly remove transactions that left mempool without going in a block */\n+    void removeTxNotInBlock(const uint256& hash);\n+\n public:\n     /** Create new BlockPolicyEstimator and initialize stats tracking classes with default values */\n     CBlockPolicyEstimator();\n     ~CBlockPolicyEstimator();\n \n-    /** Process all the transactions that have been included in a block */\n-    void processBlock(unsigned int nBlockHeight,\n-                      const std::vector<CTransactionRef>& txn_removed_in_block);\n-\n-    /** Process a transaction accepted to the mempool*/\n-    void processTransaction(const CTxMemPoolEntry& entry, bool validFeeEstimate);\n-\n-    /** Remove a transaction from the mempool tracking stats*/\n-    bool removeTx(uint256 hash);\n+    // MempoolInterface functions:\n+    void TransactionAddedToMempool(const NewMempoolTransactionInfo& info, const std::vector<CTransactionRef>& txn_replaced) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550906",
      "id" : 179550906,
      "in_reply_to_id" : 178639756,
      "original_commit_id" : "9266c936b747e564859275165e5e12983ed56301",
      "original_position" : 39,
      "path" : "src/policy/fees.h",
      "position" : null,
      "pull_request_review_id" : 109816870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550906",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This was written before that existed. Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:30Z",
      "diff_hunk" : "@@ -77,6 +84,13 @@ BOOST_AUTO_TEST_CASE(BlockPolicyEstimates)\n         block.clear();\n         // Check after just a few txs that combining buckets works as expected\n         if (blocknum == 3) {\n+            // Wait for fee estimator to catch up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550914",
      "id" : 179550914,
      "in_reply_to_id" : 178639530,
      "original_commit_id" : "9266c936b747e564859275165e5e12983ed56301",
      "original_position" : 40,
      "path" : "src/test/policyestimator_tests.cpp",
      "position" : 41,
      "pull_request_review_id" : 109816876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550914",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550928"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because we don't know how long its been around/it waited.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:30Z",
      "diff_hunk" : "@@ -580,13 +581,20 @@ void CBlockPolicyEstimator::TransactionRemovedFromMempool(const CTransactionRef\n     removeTxNotInBlock(tx->GetHash());\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTransactionRef& tx)\n {\n-    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(tx->GetHash());\n     if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    if (pos->second.witness_hash != tx->GetWitnessHash()) {\n+        // In the case that we saw a tx which had its witness malleated,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550928",
      "id" : 179550928,
      "in_reply_to_id" : 178636650,
      "original_commit_id" : "68d7445e2350b1f3cd8ad0bc79bd06c79c23ad00",
      "original_position" : 22,
      "path" : "src/policy/fees.cpp",
      "position" : 123,
      "pull_request_review_id" : 109816881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550928",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550944"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Happy to rename it, but honestly I dont remember what the different responsibilities are. Its been so long since I wrote this I dont know how it works anymore. Any suggestions?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:32Z",
      "diff_hunk" : "@@ -185,20 +186,30 @@ class CBlockPolicyEstimator\n      */\n     static constexpr double FEE_SPACING = 1.05;\n \n+    struct TxStatsInfo\n+    {\n+        unsigned int blockHeight;\n+        CAmount m_fee_per_k;\n+        TxStatsInfo() : blockHeight(0), m_fee_per_k(0) {}\n+    };\n+\n+    /** Remove a transaction from the mempool tracking stats*/\n+    void removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550944",
      "id" : 179550944,
      "in_reply_to_id" : 178623164,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 20,
      "path" : "src/policy/fees.h",
      "position" : 34,
      "pull_request_review_id" : 109816897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550944",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550956"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would also need to copy blockHeight as well, at which point you'd just be copying the whole struct so that you can remove it.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:33Z",
      "diff_hunk" : "@@ -577,43 +582,45 @@ void CBlockPolicyEstimator::processTransaction(const CTxMemPoolEntry& entry, boo\n     CFeeRate feeRate(entry.GetFee(), entry.GetTxSize());\n \n     mapMemPoolTxs[hash].blockHeight = txHeight;\n+    mapMemPoolTxs[hash].m_fee_per_k = feeRate.GetFeePerK();\n     unsigned int bucketIndex = feeStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n-    mapMemPoolTxs[hash].bucketIndex = bucketIndex;\n     unsigned int bucketIndex2 = shortStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex2);\n     unsigned int bucketIndex3 = longStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex3);\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxMemPoolEntry* entry)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n {\n-    if (!removeTx(entry->GetTx().GetHash(), true)) {\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    removeTx(pos, true);\n \n     // How many blocks did it take for miners to include this transaction?\n     // blocksToConfirm is 1-based, so a transaction included in the earliest\n     // possible block has confirmation count of 1\n-    int blocksToConfirm = nBlockHeight - entry->GetHeight();\n+    int blocksToConfirm = nBlockHeight - pos->second.blockHeight;\n     if (blocksToConfirm <= 0) {\n         // This can't happen because we don't process transactions from a block with a height\n         // lower than our greatest seen height\n         LogPrint(BCLog::ESTIMATEFEE, \"Blockpolicy error Transaction had negative blocksToConfirm\\n\");\n+        mapMemPoolTxs.erase(pos);\n         return false;\n     }\n \n-    // Feerates are stored and reported as BTC-per-kb:\n-    CFeeRate feeRate(entry->GetFee(), entry->GetTxSize());\n+    feeStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    shortStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    longStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n \n-    feeStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    shortStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    longStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n+    mapMemPoolTxs.erase(pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550956",
      "id" : 179550956,
      "in_reply_to_id" : 178622043,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 97,
      "path" : "src/policy/fees.cpp",
      "position" : 153,
      "pull_request_review_id" : 109816907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550956",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550962"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably just a change in code between when I wrote this and now.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:34Z",
      "diff_hunk" : "@@ -185,20 +186,30 @@ class CBlockPolicyEstimator\n      */\n     static constexpr double FEE_SPACING = 1.05;\n \n+    struct TxStatsInfo",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550962",
      "id" : 179550962,
      "in_reply_to_id" : 178620537,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 12,
      "path" : "src/policy/fees.h",
      "position" : 25,
      "pull_request_review_id" : 109816912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550962",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:36Z",
      "diff_hunk" : "@@ -504,20 +505,24 @@ void TxConfirmStats::removeTx(unsigned int entryHeight, unsigned int nBestSeenHe\n     }\n }\n \n+void CBlockPolicyEstimator::removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550965",
      "id" : 179550965,
      "in_reply_to_id" : 178618859,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 25,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 109816914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550965",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550967"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:36Z",
      "diff_hunk" : "@@ -443,7 +443,8 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n     mapLinks.erase(it);\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n-    if (minerPolicyEstimator) {minerPolicyEstimator->removeTx(hash, false);}\n+    if (reason != MemPoolRemovalReason::BLOCK && minerPolicyEstimator) {\n+        minerPolicyEstimator->removeTx(hash);}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550967",
      "id" : 179550967,
      "in_reply_to_id" : 178618284,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 6,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 109816918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550967",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550974"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:38Z",
      "diff_hunk" : "@@ -599,6 +589,7 @@ void CTxMemPool::removeForBlock(const std::vector<CTransactionRef>& vtx, unsigne\n         removeConflicts(*tx, txn_conflicts);\n         ClearPrioritisation(tx->GetHash());\n     }\n+    if (minerPolicyEstimator) {minerPolicyEstimator->processBlock(nBlockHeight, txn_removed_in_block);}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550974",
      "id" : 179550974,
      "in_reply_to_id" : 178617924,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 32,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 109816927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550974",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:39Z",
      "diff_hunk" : "@@ -70,6 +70,28 @@ void SyncWithValidationInterfaceQueue();\n  * called on the thread generating the callbacks.\n  */\n class MempoolInterface {\n+public:\n+    /**\n+     * Information about a newly-added-to-mempool transaction.\n+     */\n+    struct NewMempoolTransactionInfo {\n+        //!A shared pointer to the transaction which was added.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550986",
      "id" : 179550986,
      "in_reply_to_id" : 178617393,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 9,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 109816935,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550986",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550992"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:41Z",
      "diff_hunk" : "@@ -70,6 +70,28 @@ void SyncWithValidationInterfaceQueue();\n  * called on the thread generating the callbacks.\n  */\n class MempoolInterface {\n+public:\n+    /**\n+     * Information about a newly-added-to-mempool transaction.\n+     */\n+    struct NewMempoolTransactionInfo {\n+        //!A shared pointer to the transaction which was added.\n+        CTransactionRef m_tx;\n+        //! The fee the added thransaction paid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550992",
      "id" : 179550992,
      "in_reply_to_id" : 178617351,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 11,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 109816944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550992",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Obviousy avoiding the move is a bit more performant, hence its use here. The use of the move in MempoolUpdatedForBlockConnect was to reduce diff size.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:42Z",
      "diff_hunk" : "@@ -152,9 +152,9 @@ void CMainSignals::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInd\n     });\n }\n \n-void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx) {\n-    m_internals->m_schedulerClient.AddToProcessQueue([ptx, this] {\n-        m_internals->TransactionAddedToMempool(ptx);\n+void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx, const std::shared_ptr<std::vector<CTransactionRef>>& txn_replaced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550993",
      "id" : 179550993,
      "in_reply_to_id" : 178615598,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 34,
      "path" : "src/validationinterface.cpp",
      "position" : null,
      "pull_request_review_id" : 109816947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550993",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:42Z",
      "diff_hunk" : "@@ -418,8 +418,10 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry,\n \n void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n {\n-    if (reason != MemPoolRemovalReason::BLOCK && reason != MemPoolRemovalReason::CONFLICT) {\n+    if (reason != MemPoolRemovalReason::BLOCK && reason != MemPoolRemovalReason::CONFLICT &&\n+        reason != MemPoolRemovalReason::REPLACED) {\n         // BLOCK and CONFLICT callbacks are generated in removeForBlock\n+        // REPLACED txn are included in TransactionAddedToMempool from ATMP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179550998",
      "id" : 179550998,
      "in_reply_to_id" : 178611267,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 8,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 109816953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179550998",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551004"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:44Z",
      "diff_hunk" : "@@ -197,7 +197,8 @@ void Shutdown()\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (peerLogic) UnregisterValidationInterface(peerLogic.get());\n-    if (g_connman) g_connman->Stop();\n+    if (peerLogic) UnregisterMempoolInterface(peerLogic.get());\n+    if(g_connman) g_connman->Stop();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551004",
      "id" : 179551004,
      "in_reply_to_id" : 178609180,
      "original_commit_id" : "cd74b8f63a376c5c342a3c35d115b496d05fc64a",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 109816959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551004",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551005"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because we still need it in BlockConnected - there may be txn that weren't in our mempool that got confirmed, so copying it would be useless.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:44Z",
      "diff_hunk" : "@@ -1226,7 +1226,16 @@ void CWallet::TransactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolR\n     }\n }\n \n-void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+void CWallet::MempoolUpdatedForBlockConnect(const std::vector<CTransactionRef>& tx_removed_in_block, const std::vector<CTransactionRef>& tx_removed_conflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    for (const CTransactionRef& ptx : tx_removed_conflicted) {\n+        SyncTransaction(ptx);\n+        TransactionRemovedFromMempool(ptx, MemPoolRemovalReason::CONFLICT);\n+    }\n+    // We can ignore tx_removed_in_block, we'll get it in BlockConnected",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551005",
      "id" : 179551005,
      "in_reply_to_id" : 178607413,
      "original_commit_id" : "a897ff03aef495d3ede6f11cafc2672563650678",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 109816963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551005",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch. Removed.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:46Z",
      "diff_hunk" : "@@ -551,7 +551,13 @@ void CTxMemPool::removeConflicts(const CTransaction &tx)\n             if (txConflict != tx)\n             {\n                 ClearPrioritisation(txConflict.GetHash());\n-                removeRecursive(txConflict, MemPoolRemovalReason::CONFLICT);\n+                setEntries set_removes;\n+                calculateRemoveRecursive(txConflict, set_removes);\n+                txn_removed.reserve(txn_removed.size() + set_removes.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551014",
      "id" : 179551014,
      "in_reply_to_id" : 178597496,
      "original_commit_id" : "b3a9ecb5684cda9a0bb9bb64a9946d5e2b259a8c",
      "original_position" : 16,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 109816974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551014",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551017"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done (bonus: also fixed the whitespace issues in that commit).",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:46Z",
      "diff_hunk" : "@@ -470,11 +470,8 @@ void CTxMemPool::CalculateDescendants(txiter entryit, setEntries &setDescendants\n     }\n }\n \n-void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReason reason)\n+void CTxMemPool::calculateRemoveRecursive(const CTransaction &origTx, setEntries &setAllRemoves)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551017",
      "id" : 179551017,
      "in_reply_to_id" : 178595675,
      "original_commit_id" : "f0d6d0bb6b34c18762ab0c30b970875698519f55",
      "original_position" : 5,
      "path" : "src/txmempool.cpp",
      "position" : 63,
      "pull_request_review_id" : 109816979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551017",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551028"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This PR was created long before the introduction of that part of the style guide, so it matches the capitalization of removeRecursive.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-05T18:02:48Z",
      "diff_hunk" : "@@ -492,6 +492,8 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const;\n \n+    void calculateRemoveRecursive(const CTransaction &tx, setEntries &stage);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179551028",
      "id" : 179551028,
      "in_reply_to_id" : 153686716,
      "original_commit_id" : "188179e008cd953bf3bd4b651ded54cb6fd60f8d",
      "original_position" : 4,
      "path" : "src/txmempool.h",
      "position" : 20,
      "pull_request_review_id" : 109816990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-05T18:02:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179551028",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179636457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179636457"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually, it's fine leaving this one as is because in the later commit (Process fee estimates in the background via MempoolInterface), the other `removeTx` gets renamed to `removeTxNotInBlock`.\r\n\r\nNot really necessary, but maybe rename the other function to `removeTxNotInBlock` in this commit instead of a later commit to avoid the confusion here.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-06T00:41:27Z",
      "diff_hunk" : "@@ -185,20 +186,30 @@ class CBlockPolicyEstimator\n      */\n     static constexpr double FEE_SPACING = 1.05;\n \n+    struct TxStatsInfo\n+    {\n+        unsigned int blockHeight;\n+        CAmount m_fee_per_k;\n+        TxStatsInfo() : blockHeight(0), m_fee_per_k(0) {}\n+    };\n+\n+    /** Remove a transaction from the mempool tracking stats*/\n+    void removeTx(std::map<uint256, TxStatsInfo>::iterator pos, bool inBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179636457",
      "id" : 179636457,
      "in_reply_to_id" : 178623164,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 20,
      "path" : "src/policy/fees.h",
      "position" : 34,
      "pull_request_review_id" : 109919902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-06T00:41:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179636457",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179636911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179636911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I think copying the struct for the sake of simplifying the control flow (by only erasing in one place) is actually good. Also would just make it more readable to have a descriptive variable name like `tx_info` instead of `pos->second`.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-06T00:45:20Z",
      "diff_hunk" : "@@ -577,43 +582,45 @@ void CBlockPolicyEstimator::processTransaction(const CTxMemPoolEntry& entry, boo\n     CFeeRate feeRate(entry.GetFee(), entry.GetTxSize());\n \n     mapMemPoolTxs[hash].blockHeight = txHeight;\n+    mapMemPoolTxs[hash].m_fee_per_k = feeRate.GetFeePerK();\n     unsigned int bucketIndex = feeStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n-    mapMemPoolTxs[hash].bucketIndex = bucketIndex;\n     unsigned int bucketIndex2 = shortStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex2);\n     unsigned int bucketIndex3 = longStats->NewTx(txHeight, (double)feeRate.GetFeePerK());\n     assert(bucketIndex == bucketIndex3);\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxMemPoolEntry* entry)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n {\n-    if (!removeTx(entry->GetTx().GetHash(), true)) {\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    removeTx(pos, true);\n \n     // How many blocks did it take for miners to include this transaction?\n     // blocksToConfirm is 1-based, so a transaction included in the earliest\n     // possible block has confirmation count of 1\n-    int blocksToConfirm = nBlockHeight - entry->GetHeight();\n+    int blocksToConfirm = nBlockHeight - pos->second.blockHeight;\n     if (blocksToConfirm <= 0) {\n         // This can't happen because we don't process transactions from a block with a height\n         // lower than our greatest seen height\n         LogPrint(BCLog::ESTIMATEFEE, \"Blockpolicy error Transaction had negative blocksToConfirm\\n\");\n+        mapMemPoolTxs.erase(pos);\n         return false;\n     }\n \n-    // Feerates are stored and reported as BTC-per-kb:\n-    CFeeRate feeRate(entry->GetFee(), entry->GetTxSize());\n+    feeStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    shortStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n+    longStats->Record(blocksToConfirm, (double)pos->second.m_fee_per_k);\n \n-    feeStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    shortStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n-    longStats->Record(blocksToConfirm, (double)feeRate.GetFeePerK());\n+    mapMemPoolTxs.erase(pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179636911",
      "id" : 179636911,
      "in_reply_to_id" : 178622043,
      "original_commit_id" : "f54c193f920cfa8ade3b65dab72ddd09f6eda697",
      "original_position" : 97,
      "path" : "src/policy/fees.cpp",
      "position" : 153,
      "pull_request_review_id" : 109920383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-06T00:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179636911",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179887104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179887104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand. We have the record of when the tx entered the mempool (albeit with different witness data). How does the malleated witness change things?",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-06T22:08:14Z",
      "diff_hunk" : "@@ -580,13 +581,20 @@ void CBlockPolicyEstimator::TransactionRemovedFromMempool(const CTransactionRef\n     removeTxNotInBlock(tx->GetHash());\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTransactionRef& tx)\n {\n-    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(tx->GetHash());\n     if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    if (pos->second.witness_hash != tx->GetWitnessHash()) {\n+        // In the case that we saw a tx which had its witness malleated,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179887104",
      "id" : 179887104,
      "in_reply_to_id" : 178636650,
      "original_commit_id" : "68d7445e2350b1f3cd8ad0bc79bd06c79c23ad00",
      "original_position" : 22,
      "path" : "src/policy/fees.cpp",
      "position" : 123,
      "pull_request_review_id" : 110222360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-06T22:08:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179887104",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179919250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179919250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because clearly there was a propagation issue. We dont know whether the lower-feerate version (or some other version) was the one most miners saw or the higher-feerate version. Better to just ignore it.",
      "commit_id" : "4c526df6c1d7cc1e231770a2c65b5d0161fb6428",
      "created_at" : "2018-04-07T15:16:53Z",
      "diff_hunk" : "@@ -580,13 +581,20 @@ void CBlockPolicyEstimator::TransactionRemovedFromMempool(const CTransactionRef\n     removeTxNotInBlock(tx->GetHash());\n }\n \n-bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const uint256& hash)\n+bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTransactionRef& tx)\n {\n-    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(hash);\n+    std::map<uint256, TxStatsInfo>::iterator pos = mapMemPoolTxs.find(tx->GetHash());\n     if (pos == mapMemPoolTxs.end()) {\n         // This transaction wasn't being tracked for fee estimation\n         return false;\n     }\n+    if (pos->second.witness_hash != tx->GetWitnessHash()) {\n+        // In the case that we saw a tx which had its witness malleated,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11775#discussion_r179919250",
      "id" : 179919250,
      "in_reply_to_id" : 178636650,
      "original_commit_id" : "68d7445e2350b1f3cd8ad0bc79bd06c79c23ad00",
      "original_position" : 22,
      "path" : "src/policy/fees.cpp",
      "position" : 123,
      "pull_request_review_id" : 110258087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11775",
      "updated_at" : "2018-04-07T15:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179919250",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
