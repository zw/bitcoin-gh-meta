[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2021-07-02T01:41:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872651861",
      "id" : 872651861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY1MTg2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T08:38:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872651861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> There are measures to limit the influence attackers can have on the addrman database (bucket restrictions based on IPs), but still - **there is no need to permit them to feed us addresses at a rate that's orders of magnitude larger than what is common on the network today**, especially as it will cause us to spam our peers too.\r\n\r\nConcept ACK",
      "created_at" : "2021-07-02T03:08:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872679319",
      "id" : 872679319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY3OTMxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T03:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872679319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-07-02T08:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872802081",
      "id" : 872802081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjgwMjA4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T08:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872802081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for default initialization value here if this is set in the initialization list in the only ctor.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T10:45:40Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032",
      "id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjkyMTAzMg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find this line quite difficult to parse. I think the intention is that we don't cap m_addr_token_bucket to MAX_ADDR_TO_SEND (in the case where it was incremented because we sent a getaddr). Is this easier to read:\r\n\r\n```diff\r\n         // Update/increment addr rate limiting bucket.\r\n         const auto current_time = GetTime<std::chrono::microseconds>();\r\n-        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n-        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\r\n+            // Don't increment bucket if it's already full\r\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\r\n+        }\r\n         peer->m_addr_token_timestamp = current_time;\r\n-        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));\r\n \r\n         for (CAddress& addr : vAddr)\r\n         {\r\n```",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:28:36Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964",
      "id" : 662943964,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0Mzk2NA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is necessary. The `add_[outbound_]p2p_connection()` methods already do a sync_with_ping.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:29:49Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636",
      "id" : 662944636,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NDYzNg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 70,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using the `assert_equal()`/`assert_greater_than()`/`assert_greater_than_or_equal()` helper functions (they give more helpful output if the test fails).",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:31:42Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737",
      "id" : 662945737,
      "line" : 244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NTczNw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 244,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 74,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not necessarily for this PR) should the other tests be updated to use random IP addresses? I guess you're doing this and not reusing setup_addr_msg() in case the addresses returned may result in addrman bucket collisions?",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:22Z",
      "diff_hunk" : "@@ -75,6 +79,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531",
      "id" : 662949531,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTUzMQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 82,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 28,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            assert (addr_count_3 <= addr_count_2)\r\n```\r\n\r\n(or better yet, use `assert_greater_than_or_equal()`)",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:58Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_1 <= tokens\n+            assert addr_count_1 <= addr_count_0 + 600\n+            assert (addr_count_1 > addr_count_0) == (tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_2 <= tokens\n+            assert addr_count_2 <= addr_count_1 + 600\n+            assert (addr_count_2 > addr_count_1) == (tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_3 <= tokens\n+            assert addr_count_3 <= addr_count_2 + 10\n+            assert (addr_count_3 > addr_count_2) == False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805",
      "id" : 662949805,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTgwNQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 266,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 96,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\r\n```\r\n\r\nDoes this compile? If yes, the constructor can be left untouched.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T13:06:55Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155",
      "id" : 662999155,
      "in_reply_to_id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5OTE1NQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698167580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T13:06:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's not equivalent however. The current code permits the token bucket to exceed MAX_ADDR_TO_SEND (through GETADDR request), without having the automatic increment cropping it again.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T15:47:08Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105234",
      "id" : 663105234,
      "in_reply_to_id" : 662943964,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEwNTIzNA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 698314011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T15:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried to reuse it, but things fail because the existing setup_addr_message are limited to 256 addresses, and when I tried to generalize it, some of the other tests started failing.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T15:48:16Z",
      "diff_hunk" : "@@ -75,6 +79,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105927",
      "id" : 663105927,
      "in_reply_to_id" : 662949531,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEwNTkyNw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 82,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 28,
      "pull_request_review_id" : 698314916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T15:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, it works.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:51:47Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139663",
      "id" : 663139663,
      "in_reply_to_id" : 662921032,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTY2Mw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698359194,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, much better.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:51:57Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139730",
      "id" : 663139730,
      "in_reply_to_id" : 662943964,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTczMA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698359287,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:51:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gone.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:52:05Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139801",
      "id" : 663139801,
      "in_reply_to_id" : 662944636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTgwMQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698359381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:52:11Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139843",
      "id" : 663139843,
      "in_reply_to_id" : 662945737,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTg0Mw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 244,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698359449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:52:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663141174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663141174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or even better: `assert_equal(addr_count_2, addr_count_3)`. Done.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:54:48Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_1 <= tokens\n+            assert addr_count_1 <= addr_count_0 + 600\n+            assert (addr_count_1 > addr_count_0) == (tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_2 <= tokens\n+            assert addr_count_2 <= addr_count_1 + 600\n+            assert (addr_count_2 > addr_count_1) == (tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_3 <= tokens\n+            assert addr_count_3 <= addr_count_2 + 10\n+            assert (addr_count_3 > addr_count_2) == False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663141174",
      "id" : 663141174,
      "in_reply_to_id" : 662949805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzE0MTE3NA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 266,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698361128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663141174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Compiled the branch but don't want to run [test/functional/p2p_addr_relay.py](https://github.com/sipa/bitcoin/blob/202106_rate_limit_addr/test/functional/p2p_addr_relay.py). I want to test it manually on testnet.\r\n\r\n1. Can we do `send_and_ping` used in the test with some RPC?\r\n2. How can we try this on testnet? I am assuming: Compile branch, run two nodes on testnet, use `addnode`, spam other node with random addresses (not sure how to do this?) and compare the results for `getnodeaddresses` doing same on master branch.",
      "created_at" : "2021-07-02T17:04:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873138272",
      "id" : 873138272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzEzODI3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T17:04:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873138272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@prayank23 No, it's testing a P2P aspect, you can't do that through RPC. There is the `addpeeraddress` RPC for injecting new addresses, but it doesn't have (or need) the same rate limiting.",
      "created_at" : "2021-07-02T17:13:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873143328",
      "id" : 873143328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzE0MzMyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T17:13:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873143328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK to introducing a rate limiting mechanism for addr relay, some general questions about the approach:\r\n\r\nThe approach of a constant counter increase doesn't scale with the total number of self-announcing nodes in the network, while addr traffic to a node probably does (or at least should?). Did you consider the possibility of an adaptive rate limiting approach (e.g. let the token counter increase based on recently observed addr frequency from outbound peers or something like that) that could adapt to changes in network size or in the general efficiency of gossip relay over time - or would that be too complicated/have some other downsides?\r\n\r\nChoosing the rate limit of0.1 addr/sbased on current observations of 0.005-0.025 addr/s also kind of says that we are happy with the current efficiency of addr gossip - are we though? (#21528 would likely increase it, though I'm not sure by how much)\r\n\r\nIt would be great to have some historical references about observed addr/s rate (to see whether it has changed significantly over the years with increasing SPV nodes, introduction of block-relay-only connections etc.), but I would assume this kind of data doesn't exist anywhere...\r\n",
      "created_at" : "2021-07-02T19:11:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873208395",
      "id" : 873208395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzIwODM5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T19:21:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873208395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande Those are reasonable points. My thinking is mostly that some limit here is necessary, and if this appears to be too restrictive as the network or other aspects of addr relay change, they can be revisited - those are unlikely to cause dramatic changes in short periods of time. I think an adaptive limit is too easily exploited.",
      "created_at" : "2021-07-02T19:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873214929",
      "id" : 873214929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzIxNDkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T19:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873214929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So sorry for that accidental close / open ",
      "created_at" : "2021-07-03T19:00:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873454941",
      "id" : 873454941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzQ1NDk0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T19:00:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873454941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So sorry for that accidental close / open \n\nWhy do you have these privileges?",
      "created_at" : "2021-07-03T19:05:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873455720",
      "id" : 873455720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzQ1NTcyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T19:05:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873455720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663559469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663559469"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why the condition `pfrom.addr != addr` in addition to starting with `m_addr_token_bucket{1.0}`? Shouldn't self-announcements from our peer consume a token too?",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:35:07Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (pfrom.addr != addr && !pfrom.HasPermission(NetPermissionFlags::Addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663559469",
      "id" : 663559469,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU1OTQ2OQ==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2808,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663559469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560244"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this could fail intermittently in the \"inbound\" case, where we have just 1 token. The first addr of the shuffled message consumes the token, but if `IsRoutable()` happens to be false for this random address, it won't be accepted to addrman (`CAddrMan::Add_()`), and other addrs of the message won't be either because there are no tokens left. ",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:42:35Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560244",
      "id" : 663560244,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU2MDI0NA==",
      "original_commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "original_line" : 251,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 82,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What is the reason for adding the `Shuffle` here, considering that the token counter grows deterministically and our peer could calculate anyway how many addrs of the packet we would process/discard if they cared to keep track of that?",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:50:31Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560937",
      "id" : 663560937,
      "line" : 2801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU2MDkzNw==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2801,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664232247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664232247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a leftover from an earlier iteration where I didn't have the `m_addr_token_bucket{1.0}` initialization. I've removed it.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T04:47:18Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (pfrom.addr != addr && !pfrom.HasPermission(NetPermissionFlags::Addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664232247",
      "id" : 664232247,
      "in_reply_to_id" : 663559469,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzMjI0Nw==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2808,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 699531352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T04:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664232247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664237309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664237309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the test to generate only routable IPs.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T05:03:46Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664237309",
      "id" : 664237309,
      "in_reply_to_id" : 663560244,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzNzMwOQ==",
      "original_commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "original_line" : 251,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 82,
      "pull_request_review_id" : 699537302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T05:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664237309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664238361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664238361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The idea is that if we're going to be dropping some part of incoming messages because of rate-limiting, we should do it uniformly. This isn't to stop any kind of attack, but to give slightly fairer treatment to existing nodes on the network, which don't randomize on sending (there is random replacement once the outgoing buffer hits 1000, but that is rarely if ever hit under normal network conditions).",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T05:07:27Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664238361",
      "id" : 664238361,
      "in_reply_to_id" : 663560937,
      "line" : 2801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzODM2MQ==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2801,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 699538711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T05:07:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664238361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
