[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30116).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30277](https://github.com/bitcoin/bitcoin/pull/30277) ([DO NOT MERGE] Erlay: bandwidth-efficient transaction relay protocol (Full implementation) by sr-gi)\n* [#30111](https://github.com/bitcoin/bitcoin/pull/30111) (locks: introduce mutex for tx download, flush rejection filters on UpdatedBlockTip by glozow)\n* [#30110](https://github.com/bitcoin/bitcoin/pull/30110) (refactor: TxDownloadManager by glozow)\n* [#29575](https://github.com/bitcoin/bitcoin/pull/29575) (net_processing: make any misbehavior trigger immediate discouragement by sipa)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-05-15T20:01:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2113359903",
      "id" : 2113359903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII585991Af",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113359903/reactions"
      },
      "updated_at" : "2024-06-13T06:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113359903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've talked to @naumenkogs about picking this up and he was happy about it. I'm happy to close this if he changes his mind.",
      "created_at" : "2024-05-15T20:05:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2113365602",
      "id" : 2113365602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII585992Zi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113365602/reactions"
      },
      "updated_at" : "2024-05-15T20:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113365602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602301949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602301949"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" 7c047d30cb0eadc8a424cb01de2fcd0978e22206: What is the step 2? This comment seems a little confuse because I couldn't find it as I see for Step 1.",
      "commit_id" : "ac5dc0aa512e78a1cc90e0ab182eedaec68b0444",
      "created_at" : "2024-05-15T22:03:28Z",
      "diff_hunk" : "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602301949",
      "id" : 1602301949,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII585fgS_9",
      "original_commit_id" : "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "original_line" : 85,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 21,
      "pull_request_review_id" : 2059094027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602301949/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-15T22:03:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602301949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602304001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602304001"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" https://github.com/bitcoin/bitcoin/commit/7c047d30cb0eadc8a424cb01de2fcd0978e22206: Perhaps adding a log when removing from set?",
      "commit_id" : "ac5dc0aa512e78a1cc90e0ab182eedaec68b0444",
      "created_at" : "2024-05-15T22:06:35Z",
      "diff_hunk" : "@@ -115,10 +138,55 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (peer_state->m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        // The caller currently keeps track of the per-peer transaction announcements, so it\n+        // should not attempt to add same tx to the set twice. However, if that happens, we will\n+        // simply ignore it.\n+        if (peer_state->m_local_set.insert(wtxid).second) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                        \"Now the set contains %i transactions.\\n\",\n+                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+        }\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const Wtxid& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602304001",
      "id" : 1602304001,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585fgTgB",
      "original_commit_id" : "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "original_line" : 180,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 155,
      "pull_request_review_id" : 2059097014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602304001/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-15T22:06:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602304001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603304486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603304486"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"add bench for ShouldFanoutTo\" 3f59bf83a41b7787f9c43c277b5e62f327a72c3e: `net.h` include seems unnecessary.",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-16T13:02:43Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603304486",
      "id" : 1603304486,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fkHwm",
      "original_commit_id" : "3f59bf83a41b7787f9c43c277b5e62f327a72c3e",
      "original_line" : 7,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/bench/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 2060684244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603304486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-16T13:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603304486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603383480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603383480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this refers to the steps listed at the beginning of the file. Not all of them are covered yet. This PR leaves this right before 2 AFAICT",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-16T13:44:15Z",
      "diff_hunk" : "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603383480",
      "id" : 1603383480,
      "in_reply_to_id" : 1602301949,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII585fkbC4",
      "original_commit_id" : "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "original_line" : 85,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 21,
      "pull_request_review_id" : 2060823307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603383480/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-16T14:57:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603383480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603525767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603525767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated to track both successful and unsuccessful deletions (in debug log, to prevent unnecessarily spamming the logs)",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-16T14:51:59Z",
      "diff_hunk" : "@@ -115,10 +138,55 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (peer_state->m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        // The caller currently keeps track of the per-peer transaction announcements, so it\n+        // should not attempt to add same tx to the set twice. However, if that happens, we will\n+        // simply ignore it.\n+        if (peer_state->m_local_set.insert(wtxid).second) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                        \"Now the set contains %i transactions.\\n\",\n+                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+        }\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const Wtxid& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603525767",
      "id" : 1603525767,
      "in_reply_to_id" : 1602304001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fk9yH",
      "original_commit_id" : "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "original_line" : 180,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 2060823307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603525767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-16T15:04:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603525767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603536079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603536079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-16T14:57:37Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603536079",
      "id" : 1603536079,
      "in_reply_to_id" : 1603304486,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585flATP",
      "original_commit_id" : "3f59bf83a41b7787f9c43c277b5e62f327a72c3e",
      "original_line" : 7,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/bench/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 2060823307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603536079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-16T14:57:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603536079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603548036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603548036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My bad, missed that. Thanks.",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-16T15:02:42Z",
      "diff_hunk" : "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603548036",
      "id" : 1603548036,
      "in_reply_to_id" : 1602301949,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII585flDOE",
      "original_commit_id" : "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "original_line" : 85,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 21,
      "pull_request_review_id" : 2061100687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603548036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-16T15:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603548036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610144238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610144238"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" 2e29e9beeebcadfc7afc56a28791456d40551bed: I think `MAX_SET_SIZE` could be in `txreconciliation.h` then we can use it in the tests.\r\n\r\n```diff\r\n-/**\r\n- * Maximum number of wtxids stored in a peer local set, bounded to protect the memory use of\r\n- * reconciliation sets and short ids mappings, and CPU used for sketch computation.\r\n- */\r\n-constexpr size_t MAX_SET_SIZE = 3000;\r\n \r\n /**\r\n  * Maximum number of transactions for which we store assigned fanout targets.\r\ndiff --git a/src/node/txreconciliation.h b/src/node/txreconciliation.h\r\nindex c2cdf9875f..648b6369c0 100644\r\n--- a/src/node/txreconciliation.h\r\n+++ b/src/node/txreconciliation.h\r\n@@ -14,6 +14,12 @@\r\n /** Supported transaction reconciliation protocol version */\r\n static constexpr uint32_t TXRECONCILIATION_VERSION{1};\r\n \r\n+/**\r\n+ * Maximum number of wtxids stored in a peer local set, bounded to protect the memory use of\r\n+ * reconciliation sets and short ids mappings, and CPU used for sketch computation.\r\n+ */\r\n+constexpr size_t MAX_SET_SIZE = 3000;\r\n+\r\n enum class ReconciliationRegisterResult {\r\n     NOT_FOUND,\r\n     SUCCESS,\r\ndiff --git a/src/test/txreconciliation_tests.cpp b/src/test/txreconciliation_tests.cpp\r\nindex a0071e4388..8befe0d36e 100644\r\n--- a/src/test/txreconciliation_tests.cpp\r\n+++ b/src/test/txreconciliation_tests.cpp\r\n@@ -115,7 +115,7 @@ BOOST_AUTO_TEST_CASE(AddToSetTest)\r\n     BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\r\n     BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\r\n \r\n-    for (size_t i = 0; i < 3000; ++i)\r\n+    for (size_t i = 0; i < MAX_SET_SIZE; ++i)\r\n         BOOST_REQUIRE(tracker.AddToSet(peer_id1, Wtxid::FromUint256(frc.rand256())));\r\n     BOOST_REQUIRE(!tracker.AddToSet(peer_id1, Wtxid::FromUint256(frc.rand256())));\r\n```",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-22T14:51:48Z",
      "diff_hunk" : "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610144238",
      "id" : 1610144238,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII585f-Nnu",
      "original_commit_id" : "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "original_line" : 110,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 83,
      "pull_request_review_id" : 2071518907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610144238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-22T14:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610144238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610159034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610159034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've been talking to @sipa about this recently and I think the limit may not be necessary if the approach for when to compute the reconciliation sets is changed. I'm may get rid of it, but if not, I'll take this",
      "commit_id" : "bc8e7d76a62bf2e4d8a43f47b86d4195f91c8636",
      "created_at" : "2024-05-22T14:59:17Z",
      "diff_hunk" : "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610159034",
      "id" : 1610159034,
      "in_reply_to_id" : 1610144238,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII585f-RO6",
      "original_commit_id" : "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "original_line" : 110,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 83,
      "pull_request_review_id" : 2071544864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610159034/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-22T14:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610159034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1620894922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1620894922"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ended up taking this, since the limit will be kept in the end.\r\n\r\nThanks!",
      "commit_id" : "d4b9fc669d5a9d659a96c6437833b30a62f558e0",
      "created_at" : "2024-05-30T15:05:35Z",
      "diff_hunk" : "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1620894922",
      "id" : 1620894922,
      "in_reply_to_id" : 1610144238,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585gnOTK",
      "original_commit_id" : "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "original_line" : 110,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 2088540718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1620894922/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-30T15:05:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1620894922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've slightly extended the approach adding 3 commits to deal with short id collisions, which were not taken into account. Some of this may be squashable, I've added them separately for now so they are easy to diff/review.\r\n\r\nThis would be missing an additional commit/amend to deal with https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445, which I overlooked when addressing the outstanding comments",
      "created_at" : "2024-05-31T16:29:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2142608188",
      "id" : 2142608188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII585_tZs8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142608188/reactions"
      },
      "updated_at" : "2024-05-31T16:29:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142608188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\n At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25659971810</sub>",
      "created_at" : "2024-05-31T16:32:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2142612746",
      "id" : 2142612746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII585_ta0K",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142612746/reactions"
      },
      "updated_at" : "2024-05-31T16:32:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142612746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I added two more commits, moving the fanout/reconciling logic to `RelayTransaction` instead of send message, plus dealing with ancestors in mempool, instead of descendants (which seemed to be the wrong approach).\r\n\r\nI'm moving this to draft for now until I clean it a bit, plus get some feedback on the approach",
      "created_at" : "2024-06-07T18:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2155312276",
      "id" : 2155312276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII586Ad3SU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155312276/reactions"
      },
      "updated_at" : "2024-06-07T18:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155312276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\n At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25955152377</sub>",
      "created_at" : "2024-06-08T05:17:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2155814489",
      "id" : 2155814489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII586Afx5Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155814489/reactions"
      },
      "updated_at" : "2024-06-08T05:17:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155814489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1634736227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634736227"
         }
      },
      "author_association" : "NONE",
      "body" : "What is the intention behind moving salt calculation out of PreRegisterPeer ? Now if PreRegisterPeer is not executed due to lock being held we are doing meaningless computation .",
      "commit_id" : "edb007255bb01526e63637f6d5fe5a6b413d1607",
      "created_at" : "2024-06-11T11:58:34Z",
      "diff_hunk" : "@@ -390,7 +425,13 @@ TxReconciliationTracker::~TxReconciliationTracker() = default;\n \n uint64_t TxReconciliationTracker::PreRegisterPeer(NodeId peer_id)\n {\n-    return m_impl->PreRegisterPeer(peer_id);\n+    const uint64_t local_salt{GetRand(UINT64_MAX)};\n+    return m_impl->PreRegisterPeer(peer_id, local_salt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1634736227",
      "id" : 1634736227,
      "line" : 460,
      "node_id" : "PRRC_kwDOABII585hcBhj",
      "original_commit_id" : "f71575cf4321443219ffede00ad598600f558994",
      "original_line" : 429,
      "original_position" : 85,
      "original_start_line" : 393,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 413,
      "pull_request_review_id" : 2110226626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634736227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 153,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-06-11T12:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634736227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94048855?v=4",
         "events_url" : "https://api.github.com/users/Prabhat1308/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Prabhat1308/followers",
         "following_url" : "https://api.github.com/users/Prabhat1308/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Prabhat1308/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Prabhat1308",
         "id" : 94048855,
         "login" : "Prabhat1308",
         "node_id" : "U_kgDOBZsSVw",
         "organizations_url" : "https://api.github.com/users/Prabhat1308/orgs",
         "received_events_url" : "https://api.github.com/users/Prabhat1308/received_events",
         "repos_url" : "https://api.github.com/users/Prabhat1308/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Prabhat1308/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Prabhat1308/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Prabhat1308"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1634738029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634738029"
         }
      },
      "author_association" : "NONE",
      "body" : "Since this function is to be called once per peer , we should add a check if there exists a state for this peer .",
      "commit_id" : "edb007255bb01526e63637f6d5fe5a6b413d1607",
      "created_at" : "2024-06-11T12:00:13Z",
      "diff_hunk" : "@@ -144,14 +144,12 @@ class TxReconciliationTracker::Impl\n public:\n     explicit Impl(uint32_t recon_version, CSipHasher hasher) : m_recon_version(recon_version), m_deterministic_randomizer(std::move(hasher)) {}\n \n-    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    uint64_t PreRegisterPeer(NodeId peer_id, uint64_t local_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1634738029",
      "id" : 1634738029,
      "line" : 151,
      "node_id" : "PRRC_kwDOABII585hcB9t",
      "original_commit_id" : "f71575cf4321443219ffede00ad598600f558994",
      "original_line" : 151,
      "original_position" : 9,
      "original_start_line" : 149,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 125,
      "pull_request_review_id" : 2110226626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634738029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 149,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-11T12:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634738029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94048855?v=4",
         "events_url" : "https://api.github.com/users/Prabhat1308/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Prabhat1308/followers",
         "following_url" : "https://api.github.com/users/Prabhat1308/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Prabhat1308/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Prabhat1308",
         "id" : 94048855,
         "login" : "Prabhat1308",
         "node_id" : "U_kgDOBZsSVw",
         "organizations_url" : "https://api.github.com/users/Prabhat1308/orgs",
         "received_events_url" : "https://api.github.com/users/Prabhat1308/received_events",
         "repos_url" : "https://api.github.com/users/Prabhat1308/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Prabhat1308/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Prabhat1308/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Prabhat1308"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1635224220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635224220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The purpose is for `PreRegisterPeer` to be callable with a fixed salt (via `PreRegisterPeerWithSalt`), so collisions can be tested. This is just moving it out of the `PImpl`, the effects on the external caller should be the same",
      "commit_id" : "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "created_at" : "2024-06-11T17:09:10Z",
      "diff_hunk" : "@@ -390,7 +425,13 @@ TxReconciliationTracker::~TxReconciliationTracker() = default;\n \n uint64_t TxReconciliationTracker::PreRegisterPeer(NodeId peer_id)\n {\n-    return m_impl->PreRegisterPeer(peer_id);\n+    const uint64_t local_salt{GetRand(UINT64_MAX)};\n+    return m_impl->PreRegisterPeer(peer_id, local_salt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1635224220",
      "id" : 1635224220,
      "in_reply_to_id" : 1634736227,
      "line" : 462,
      "node_id" : "PRRC_kwDOABII585hd4qc",
      "original_commit_id" : "f71575cf4321443219ffede00ad598600f558994",
      "original_line" : 462,
      "original_position" : 85,
      "original_start_line" : 393,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 415,
      "pull_request_review_id" : 2111021554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635224220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 153,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-06-11T17:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635224220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This should be ready for review now.",
      "created_at" : "2024-06-13T20:01:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2166667309",
      "id" : 2166667309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
      "node_id" : "IC_kwDOABII586BJLgt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2166667309/reactions"
      },
      "updated_at" : "2024-06-13T20:01:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2166667309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1638809793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638809793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is pending. Happy get get feedback on how many to pick (either hardcoded or based on what)",
      "commit_id" : "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "created_at" : "2024-06-13T20:02:50Z",
      "diff_hunk" : "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1638809793",
      "id" : 1638809793,
      "line" : 2370,
      "node_id" : "PRRC_kwDOABII585hrkDB",
      "original_commit_id" : "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "original_line" : 2370,
      "original_position" : 202,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 202,
      "pull_request_review_id" : 2116801594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638809793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-13T20:02:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638809793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   }
]
