[
   {
      "body" : "Why do you keep insisting on having all block files in a single continuous chunk? I implemented pre-allocating specifically to address the excessive fragmentation the previous mechanism seemed to cause on some platform, but it's unreasonable to want every file to only be one chunk.\r\n\r\nI'll consider this if you can show benchmark results that this helps. PS: block and undo files are almost never accessed in the new code, contrary to 0.7 which needed them all the time for validation.\r\n\r\nA patch to just implement AllocateFileRange specifically for Windows is no problem at all.",
      "created_at" : "2012-12-12T19:23:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11304647",
      "id" : 11304647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-12T19:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11304647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Because I have the code and it's working fine, as it does, what it is intended for. Why is something unreasonable, if it's possible to do via some rather simple OS-calls?\r\n\r\nI added some code to print to the log when ReadFromDisk() and WriteToDisk() are called and at least ReadFromDisk() seems rather sequential during startup (talking about ``Verifying last 2500 blocks at level 1`` and ``Rescanning last 199 blocks...``).\r\n\r\nEven if it is not a big increase for the Bitcoin client, it helps to lower overall fragmentation of users disks.\r\n\r\nEdit: Can you tell me how big undo files can grow at max?",
      "created_at" : "2012-12-12T20:19:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11307634",
      "id" : 11307634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-12T20:19:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11307634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "NACK. 88 more lines of code to maintain is a greater cost than the potential benefit here.\r\n",
      "created_at" : "2012-12-12T20:38:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11308362",
      "id" : 11308362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-12T20:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11308362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "First of all, dealing with fragmentation is a reasonable request. It's not Windows-specific by the way - if you don't allocate a file in one go, it will lead to fragmentation on just about every system and every filesystem. Pre-allocation is the solution to this, and it's already implemented. If Windows has a better way for pre-allocating than writing zeroes, sure provide an optimized version for that specific function in util.cpp - that's what it's there for.\r\n\r\nBut please:\r\n * Don't put platform-specific stuff in the block management code because you fear 100 fragments will hurt you. If it does, we need to increase the pre-allocation size perhaps.\r\n * Don't allocate entire files without knowing you'll need it. That's just wasted space. For the block files this is limited (as they grow anyway, so you're on average only 64 MiB above needed), but for undo files it's simply not known how large they'll grow (they contain the undo data corresponding to the block with the same number). Making them any specific size will either be a permanent waste, or not enough.\r\n",
      "created_at" : "2012-12-12T20:43:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11308525",
      "id" : 11308525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-12T20:43:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11308525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa At least you try to clarify your position... though I don't agree on the 100 fragments part. The undofile size is a reasonable comment, but for blockfiles a to be filled 128MB file is clearly not wasted space. I'll keep using this with my local build, but guess I won't create a pull for that CAutoFile thing as I dislike Gavins dictatorial nature on patches, I put quite some time in...",
      "created_at" : "2012-12-12T20:49:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11308767",
      "id" : 11308767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-12T20:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11308767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@Diapolo my suggestion:\r\n  1) implement AllocateFileRange for Windows (just inside the function body, using macros) that doesn't try to do more than that function intends.\r\n  2) If, after benchmarking with 1) you can still observe a noticable slowdown, we can increase the chunk size for Windows - or make it configurable in the first place.\r\n\r\nThat should have exactly the same effect as your current code, in something like 10 lines of code.",
      "created_at" : "2012-12-13T11:50:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2098#issuecomment-11331735",
      "id" : 11331735,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2098",
      "updated_at" : "2012-12-13T11:50:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11331735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
