[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292361"
         }
      },
      "body" : "New line missing",
      "commit_id" : "f180394a25c2fd0e82e5723971d91084f429b534",
      "created_at" : "2016-03-16T07:42:30Z",
      "diff_hunk" : "@@ -0,0 +1,142 @@\n+// Copyright (c) 2012-2016 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include \"addrman.h\"\n+#include \"test/test_bitcoin.h\"\n+#include <string>\n+#include <boost/test/unit_test.hpp>\n+#include \"hash.h\"\n+#include \"serialize.h\"\n+#include \"streams.h\"\n+#include \"net.h\"\n+#include \"chainparams.h\"\n+\n+using namespace std;\n+\n+class CAddrManSerializationTest : public CAddrMan\n+{\n+public:\n+    virtual void Serialize(CDataStream &s, int nType, int nVersionDummy) const = 0;\n+};\n+\n+class CAddrManUncorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        CAddrMan::Serialize(s, nType, nVersionDummy);\n+    }\n+};\n+\n+class CAddrManCorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        // Produces corrupt output that claims addrman has 20 addrs when it only has one addr.\n+        unsigned char nVersion = 1;\n+        s << nVersion;\n+        s << ((unsigned char)32);\n+        s << nKey;\n+\n+        s << 10; // nNew\n+        s << 10; // nTried\n+\n+        int nUBuckets = ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30);\n+        s << nUBuckets;\n+\n+        CAddress addr = CAddress(CService(\"252.1.1.1\",7777));\n+        CAddrInfo info = CAddrInfo(addr, CNetAddr(\"252.2.2.2\"));\n+        s << info;\n+    }\n+};\n+\n+CDataStream AddrmanToStream(CAddrManSerializationTest& addrman)\n+{\n+    CDataStream ssPeersIn(SER_DISK, CLIENT_VERSION);\n+    ssPeersIn << FLATDATA(Params().MessageStart());\n+    ssPeersIn << addrman;\n+    string str = ssPeersIn.str();\n+    vector<unsigned char> vchData(str.begin(), str.end());\n+    return CDataStream(vchData, SER_DISK, CLIENT_VERSION);\n+}\n+\n+BOOST_FIXTURE_TEST_SUITE(addrman_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(caddrdb_deserialiation)\n+{\n+    CAddrManUncorrupted addrmanUncorrupted;\n+\n+    CService addr1 = CService(\"250.7.1.1\", 8333);\n+    CService addr2 = CService(\"250.7.2.2\", 9999);\n+    CService addr3 = CService(\"250.7.3.3\", 9999);\n+\n+    // Add three addresses to new table.\n+    addrmanUncorrupted.Add(CAddress(addr1), CService(\"252.5.1.1\", 8333));\n+    addrmanUncorrupted.Add(CAddress(addr2), CService(\"252.5.1.1\", 8333));\n+    addrmanUncorrupted.Add(CAddress(addr3), CService(\"252.5.1.1\", 8333));\n+\n+    // Test that the deserialization does not throw an exception.\n+    CDataStream ssPeers1 = AddrmanToStream(addrmanUncorrupted);\n+    bool exceptionThrown = false;\n+    CAddrMan addrman1;\n+\n+    BOOST_CHECK(addrman1.size() == 0);\n+    try {\n+        unsigned char pchMsgTmp[4];\n+        ssPeers1 >> FLATDATA(pchMsgTmp);\n+        ssPeers1 >> addrman1;\n+    }\n+    catch (const std::exception& e) {\n+        exceptionThrown = true;\n+    }\n+    BOOST_CHECK(addrman1.size() == 3);\n+\n+    BOOST_CHECK(exceptionThrown == false);\n+\n+    // Test that CAddrDB::Read creates an addrman with the correct number of addrs.\n+    CDataStream ssPeers2 = AddrmanToStream(addrmanUncorrupted);\n+    uint256 hashIn = Hash(ssPeers2.begin(), ssPeers2.end());\n+\n+    CAddrMan addrman2;\n+    CAddrDB adb;\n+    BOOST_CHECK(addrman2.size() == 0);\n+    adb.Read(addrman2, ssPeers2, hashIn);\n+    BOOST_CHECK(addrman2.size() == 3);\n+}\n+\n+\n+BOOST_AUTO_TEST_CASE(caddrdb_corrupted_deserialiation)\n+{\n+    CAddrManCorrupted addrmanCorrupted;\n+\n+    // Test that the deserialization of corrupted addrman throws an exception.\n+    CDataStream ssPeers1 = AddrmanToStream(addrmanCorrupted);\n+    bool exceptionThrown = false;\n+    CAddrMan addrman1;\n+    BOOST_CHECK(addrman1.size() == 0);\n+    try {\n+        unsigned char pchMsgTmp[4];\n+        ssPeers1 >> FLATDATA(pchMsgTmp);\n+        ssPeers1 >> addrman1;\n+    }\n+    catch (const std::exception& e) {\n+        exceptionThrown = true;\n+    }\n+    // Even through de-serialization failed adddrman is not left in a clean state.\n+    BOOST_CHECK(addrman1.size() == 1);\n+    BOOST_CHECK(exceptionThrown);\n+\n+    // Test that CAddrDB::Read leaves addrman in a clean state if de-serialization fails.\n+    CDataStream ssPeers2 = AddrmanToStream(addrmanCorrupted);\n+    uint256 hashIn = Hash(ssPeers2.begin(), ssPeers2.end());\n+\n+    CAddrMan addrman2;\n+    CAddrDB adb;\n+    BOOST_CHECK(addrman2.size() == 0);\n+    adb.Read(addrman2, ssPeers2, hashIn);\n+\n+    BOOST_CHECK(addrman2.size() == 0); \n+}\n+\n+BOOST_AUTO_TEST_SUITE_END()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292361",
      "id" : 56292361,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 142,
      "path" : "src/test/net_tests.cpp",
      "position" : 142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-16T13:02:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292422"
         }
      },
      "body" : "strange test name ;-) `z` missing",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T07:43:13Z",
      "diff_hunk" : "@@ -0,0 +1,142 @@\n+// Copyright (c) 2012-2016 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include \"addrman.h\"\n+#include \"test/test_bitcoin.h\"\n+#include <string>\n+#include <boost/test/unit_test.hpp>\n+#include \"hash.h\"\n+#include \"serialize.h\"\n+#include \"streams.h\"\n+#include \"net.h\"\n+#include \"chainparams.h\"\n+\n+using namespace std;\n+\n+class CAddrManSerializationTest : public CAddrMan\n+{\n+public:\n+    virtual void Serialize(CDataStream &s, int nType, int nVersionDummy) const = 0;\n+};\n+\n+class CAddrManUncorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        CAddrMan::Serialize(s, nType, nVersionDummy);\n+    }\n+};\n+\n+class CAddrManCorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        // Produces corrupt output that claims addrman has 20 addrs when it only has one addr.\n+        unsigned char nVersion = 1;\n+        s << nVersion;\n+        s << ((unsigned char)32);\n+        s << nKey;\n+\n+        s << 10; // nNew\n+        s << 10; // nTried\n+\n+        int nUBuckets = ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30);\n+        s << nUBuckets;\n+\n+        CAddress addr = CAddress(CService(\"252.1.1.1\",7777));\n+        CAddrInfo info = CAddrInfo(addr, CNetAddr(\"252.2.2.2\"));\n+        s << info;\n+    }\n+};\n+\n+CDataStream AddrmanToStream(CAddrManSerializationTest& addrman)\n+{\n+    CDataStream ssPeersIn(SER_DISK, CLIENT_VERSION);\n+    ssPeersIn << FLATDATA(Params().MessageStart());\n+    ssPeersIn << addrman;\n+    string str = ssPeersIn.str();\n+    vector<unsigned char> vchData(str.begin(), str.end());\n+    return CDataStream(vchData, SER_DISK, CLIENT_VERSION);\n+}\n+\n+BOOST_FIXTURE_TEST_SUITE(addrman_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(caddrdb_deserialiation)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292422",
      "id" : 56292422,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 66,
      "path" : "src/test/net_tests.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292683"
         }
      },
      "body" : "You test addrman, not net. Please name the file `addrman_tests.cpp`.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T07:47:08Z",
      "diff_hunk" : "@@ -60,6 +60,7 @@ BITCOIN_TESTS =\\\n   test/merkle_tests.cpp \\\n   test/miner_tests.cpp \\\n   test/multisig_tests.cpp \\\n+  test/net_tests.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56292683",
      "id" : 56292683,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 4,
      "path" : "src/Makefile.test.include",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56292683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "body" : "Travis fails with:\r\n\r\n```\r\ntest/net_tests.cpp(93): error: in \"addrman_tests/caddrdb_deserialiation\": check addrman1.size() == 3 has failed\r\ntest/net_tests.cpp(105): error: in \"addrman_tests/caddrdb_deserialiation\": check addrman2.size() == 3 has failed\r\n```\r\n\r\nBut only in one configuration.",
      "created_at" : "2016-03-16T07:49:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-197200010",
      "id" : 197200010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-16T08:01:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/197200010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56324033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56324033"
         }
      },
      "body" : "I am testing CAddrDB, which is called from and lives in net.h and net.cpp not CAddrMan.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T12:23:37Z",
      "diff_hunk" : "@@ -60,6 +60,7 @@ BITCOIN_TESTS =\\\n   test/merkle_tests.cpp \\\n   test/miner_tests.cpp \\\n   test/multisig_tests.cpp \\\n+  test/net_tests.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56324033",
      "id" : 56324033,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 4,
      "path" : "src/Makefile.test.include",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56324033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56324926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56324926"
         }
      },
      "body" : "No strong opinion: IMO we don't need to use an identical filename for what is tested in the test. I think `addrman_tests.cpp` would be more clear.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T12:32:11Z",
      "diff_hunk" : "@@ -60,6 +60,7 @@ BITCOIN_TESTS =\\\n   test/merkle_tests.cpp \\\n   test/miner_tests.cpp \\\n   test/multisig_tests.cpp \\\n+  test/net_tests.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56324926",
      "id" : 56324926,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 4,
      "path" : "src/Makefile.test.include",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56324926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Concept ACK, more tests are better. Haven't verified the tests though.",
      "created_at" : "2016-03-16T12:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-197298916",
      "id" : 197298916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-16T12:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/197298916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56325375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56325375"
         }
      },
      "body" : "Thanks. I changed it to caddrdb_read, since that is a better descriptor of what I am testing.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T12:36:03Z",
      "diff_hunk" : "@@ -0,0 +1,142 @@\n+// Copyright (c) 2012-2016 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include \"addrman.h\"\n+#include \"test/test_bitcoin.h\"\n+#include <string>\n+#include <boost/test/unit_test.hpp>\n+#include \"hash.h\"\n+#include \"serialize.h\"\n+#include \"streams.h\"\n+#include \"net.h\"\n+#include \"chainparams.h\"\n+\n+using namespace std;\n+\n+class CAddrManSerializationTest : public CAddrMan\n+{\n+public:\n+    virtual void Serialize(CDataStream &s, int nType, int nVersionDummy) const = 0;\n+};\n+\n+class CAddrManUncorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        CAddrMan::Serialize(s, nType, nVersionDummy);\n+    }\n+};\n+\n+class CAddrManCorrupted : public CAddrManSerializationTest\n+{\n+public:\n+    void Serialize(CDataStream &s, int nType, int nVersionDummy) const\n+    {\n+        // Produces corrupt output that claims addrman has 20 addrs when it only has one addr.\n+        unsigned char nVersion = 1;\n+        s << nVersion;\n+        s << ((unsigned char)32);\n+        s << nKey;\n+\n+        s << 10; // nNew\n+        s << 10; // nTried\n+\n+        int nUBuckets = ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30);\n+        s << nUBuckets;\n+\n+        CAddress addr = CAddress(CService(\"252.1.1.1\",7777));\n+        CAddrInfo info = CAddrInfo(addr, CNetAddr(\"252.2.2.2\"));\n+        s << info;\n+    }\n+};\n+\n+CDataStream AddrmanToStream(CAddrManSerializationTest& addrman)\n+{\n+    CDataStream ssPeersIn(SER_DISK, CLIENT_VERSION);\n+    ssPeersIn << FLATDATA(Params().MessageStart());\n+    ssPeersIn << addrman;\n+    string str = ssPeersIn.str();\n+    vector<unsigned char> vchData(str.begin(), str.end());\n+    return CDataStream(vchData, SER_DISK, CLIENT_VERSION);\n+}\n+\n+BOOST_FIXTURE_TEST_SUITE(addrman_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(caddrdb_deserialiation)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56325375",
      "id" : 56325375,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 66,
      "path" : "src/test/net_tests.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56325375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56326921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56326921"
         }
      },
      "body" : "If someone feels strongly I'm happy to move it to addrman_tests.cpp. I wrote all the tests in addrman_tests and choose to put this test in net_tests since it feels more common to net than addrman.\r\n\r\nIdeally CAddrDB, CBanDB and other files which manage interaction with the data directory should be refactored into a common file/class but that is much larger task (for instance CBanDB is very tightly coupled to net.cpp).",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-16T12:49:38Z",
      "diff_hunk" : "@@ -60,6 +60,7 @@ BITCOIN_TESTS =\\\n   test/merkle_tests.cpp \\\n   test/miner_tests.cpp \\\n   test/multisig_tests.cpp \\\n+  test/net_tests.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r56326921",
      "id" : 56326921,
      "original_commit_id" : "cb1b0556be47689623e7e252b9f8f04cffbde5ff",
      "original_position" : 4,
      "path" : "src/Makefile.test.include",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/56326921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "@paveljanik The non-determinism of the test passing is worrying especially because the test that was failing was not testing new behavior. I haven't been able to replicate this failure locally, any idea what is happening with it?",
      "created_at" : "2016-03-16T15:10:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-197375145",
      "id" : 197375145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-16T15:10:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/197375145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "Can someone add the labels bug and data corruption.",
      "created_at" : "2016-03-16T15:12:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-197376035",
      "id" : 197376035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-16T15:12:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/197376035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "Concept ACK.\r\n\r\nInstead of relying on the output of CAddrDB::Read to be \"clean\" in case of an error I'd prefer a different approach, though: ignore and reset its output when the function fails. In my experience this is a more robust approach - it's easy to forget resetting it in some code path. In a lot of APIs the output of failing functions is thus undefined.\r\n",
      "created_at" : "2016-03-24T16:20:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-200908357",
      "id" : 200908357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-24T16:20:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/200908357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj I'm not sure I follow, do you want the \"clearing\" to happen closer to the source of the error? In the serialization code? ",
      "created_at" : "2016-03-24T21:48:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-201039632",
      "id" : 201039632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-24T21:48:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201039632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "@EthanHeilman At the call site:\r\n```\r\n        if (adb.Read(addrman))\r\n            LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman.size(), GetTimeMillis() - nStart);\r\n        else {\r\n            addrman.clear(); // Addrman can be in an inconsistent state after failure, reset it\r\n            LogPrintf(\"Invalid or missing peers.dat; recreating\\n\");\r\n            DumpAddresses();\r\n        }\r\n```\r\nIt's hard to *guarantee* that `adb.Read` won't leave the passed addrman in an inconsistent state after failure in all possible internal code paths. This would at least catch all possible cases.\r\n\r\nThe cleanest way if we had a clean slate, I think, would be to have Read return an `AddrMan*` which is `null` if an error happened, then instantiate a new one on faiilure. But as we have that global object that's too impactful.\r\n",
      "created_at" : "2016-03-25T09:51:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-201223722",
      "id" : 201223722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-25T09:51:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201223722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj Good idea, I amended the commit to include addrman.Clear in StartNode's Read() error condition.\r\n\r\n",
      "created_at" : "2016-03-25T16:27:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-201350876",
      "id" : 201350876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-03-25T16:27:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201350876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57460774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57460774"
         }
      },
      "body" : "Could make sense to move the hash check to the outer read function - after all, it's not part of the inner stream but of the wrapping file.\r\nWould simplify testing as there'd be no need to pass hashIn here.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-25T16:31:15Z",
      "diff_hunk" : "@@ -2331,6 +2332,11 @@ bool CAddrDB::Read(CAddrMan& addr)\n \n     CDataStream ssPeers(vchData, SER_DISK, CLIENT_VERSION);\n \n+    return Read(addr, ssPeers, hashIn);\n+}\n+\n+bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers, uint256& hashIn)\n+{\n     // verify stored checksum matches input data\n     uint256 hashTmp = Hash(ssPeers.begin(), ssPeers.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57460774",
      "id" : 57460774,
      "original_commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "original_position" : 18,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T16:31:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57460774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57464394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57464394"
         }
      },
      "body" : "My thinking with passing hashIn as a parameter was that it would allow me to write a test on the \"inner read\" to verify an error is thrown if hashIn is not the same as the hash of ssPeers. Something like:\r\n\r\n```c++ \r\nBOOST_AUTO_TEST_CASE(caddrdb_hash)\r\n{\r\n    CAddrManUncorrupted addrmanUncorrupted;\r\n    CService addr1 = CService(\"250.7.1.1\", 8333);\r\n    addrmanUncorrupted.Add(CAddress(addr1), CService(\"252.5.1.1\", 8333));\r\n\r\n    // Test that the de-serialization does not throw an exception.\r\n    CDataStream ssPeers1 = AddrmanToStream(addrmanUncorrupted);\r\n\r\n    addrmanUncorrupted.Add(CAddress(addr3), CService(\"253.3.3.33\", 8333));\r\n    CDataStream ssPeersDiff = AddrmanToStream(addrmanUncorrupted);\r\n    uint256 badHashIn = Hash(ssPeersDiff.begin(), ssPeersDiff.end());\r\n\r\n    CAddrDB adb;\r\n    CAddrMan addrman;\r\n    adb.Read(addrman, ssPeers2, badHashIn); // Assert this throws an exception since the hashes don't match\r\n}\r\n```\r\nbut I decided to wait until I had more time to work on it.\r\n\r\nHow interested are you in a system for mocking out filesystem objects rather than having to do everything at the stream level?",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-25T17:07:03Z",
      "diff_hunk" : "@@ -2331,6 +2332,11 @@ bool CAddrDB::Read(CAddrMan& addr)\n \n     CDataStream ssPeers(vchData, SER_DISK, CLIENT_VERSION);\n \n+    return Read(addr, ssPeers, hashIn);\n+}\n+\n+bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers, uint256& hashIn)\n+{\n     // verify stored checksum matches input data\n     uint256 hashTmp = Hash(ssPeers.begin(), ssPeers.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57464394",
      "id" : 57464394,
      "original_commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "original_position" : 18,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T17:07:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57464394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57468001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57468001"
         }
      },
      "body" : "Ok, yes, that makes sense.\r\n\r\n> How interested are you in a system for mocking out filesystem objects rather than having to do everything at the stream level?\r\n\r\nDepends on the (non-test) code impact. I'm not entirely sure that is necessary - e.g. you could create a temporary file and make it read that.",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-25T17:36:39Z",
      "diff_hunk" : "@@ -2331,6 +2332,11 @@ bool CAddrDB::Read(CAddrMan& addr)\n \n     CDataStream ssPeers(vchData, SER_DISK, CLIENT_VERSION);\n \n+    return Read(addr, ssPeers, hashIn);\n+}\n+\n+bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers, uint256& hashIn)\n+{\n     // verify stored checksum matches input data\n     uint256 hashTmp = Hash(ssPeers.begin(), ssPeers.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57468001",
      "id" : 57468001,
      "original_commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "original_position" : 18,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T17:36:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57468001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57476892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57476892"
         }
      },
      "body" : ">Depends on the (non-test) code impact. \r\n\r\nIt is on my list of things to investigate, but I was considering creating a class which wraps File/fopen and can be mocked out in unitests similar to RandomInt in addrman.h.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/addrman.h#L239\r\n\r\nI share your concern as this would require a big diff when all the instances of File are replaced with mockable File. I assume this is a problem others have solved so I'm looking into alternates.\r\n\r\n>I'm not entirely sure that is necessary - e.g. you could create a temporary file and make it read that.\r\n\r\nYMMV, but in my experience tmp files in unittests cause hard to debug test failures due to filesystem weirdness and added state (file deletes sometimes fail). ",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-25T18:51:51Z",
      "diff_hunk" : "@@ -2331,6 +2332,11 @@ bool CAddrDB::Read(CAddrMan& addr)\n \n     CDataStream ssPeers(vchData, SER_DISK, CLIENT_VERSION);\n \n+    return Read(addr, ssPeers, hashIn);\n+}\n+\n+bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers, uint256& hashIn)\n+{\n     // verify stored checksum matches input data\n     uint256 hashTmp = Hash(ssPeers.begin(), ssPeers.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57476892",
      "id" : 57476892,
      "original_commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "original_position" : 18,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-25T18:51:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57476892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57510529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57510529"
         }
      },
      "body" : "> YMMV, but in my experience tmp files in unittests cause hard to debug test failures due to filesystem weirdness and added state (file deletes sometimes fail).\r\n\r\nI agree. It's somewhat preferable to not clutter files around the place.\r\nOn the other hand it actually tests the filesystem interaction then :)\r\n\r\n> I share your concern as this would require a big diff when all the instances of File are replaced with mockable File.\r\n\r\nC++ has some support for this by replacing inputs/outputs streams by string streams, unfortunately - or not, I'm not entirely up to date of the pros and cons of it - we don't really use C++'s file API.\r\n\r\nWe mainly use `fopen` and `FILE*`. Note that on some platforms (including Linux and MacOSX IIRC) for FILE* there is: [fmemopen, open_memstream](http://linux.die.net/man/3/open_memstream). May be interesting.\r\n\r\nThen one could change the APIs to take a FILE* instead of filename. On platforms without the function it could fall back to a temporary file, on platforms with the function it can use a memory stream.\r\n",
      "commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "created_at" : "2016-03-26T07:22:59Z",
      "diff_hunk" : "@@ -2331,6 +2332,11 @@ bool CAddrDB::Read(CAddrMan& addr)\n \n     CDataStream ssPeers(vchData, SER_DISK, CLIENT_VERSION);\n \n+    return Read(addr, ssPeers, hashIn);\n+}\n+\n+bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers, uint256& hashIn)\n+{\n     // verify stored checksum matches input data\n     uint256 hashTmp = Hash(ssPeers.begin(), ssPeers.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#discussion_r57510529",
      "id" : 57510529,
      "original_commit_id" : "a7c4eb7ef7ff4519cbdc17d5ca37478b1d6eb753",
      "original_position" : 18,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7696",
      "updated_at" : "2016-03-26T07:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/57510529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Does this pull-request need any additional changes?",
      "created_at" : "2016-04-18T19:20:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-211538159",
      "id" : 211538159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-04-18T19:20:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/211538159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "I still don't really like passing the hash into bool CAddrDB::Read, I think it makes for an awful API :)",
      "created_at" : "2016-04-19T13:33:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-211924495",
      "id" : 211924495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-04-19T13:33:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/211924495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj I removed hash from CAddrDB::Read ",
      "created_at" : "2016-05-04T23:26:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7696#issuecomment-217037535",
      "id" : 217037535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7696",
      "updated_at" : "2016-05-04T23:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217037535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   }
]
