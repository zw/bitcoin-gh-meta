[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [instagibbs](https://github.com/bitcoin/bitcoin/pull/27476#pullrequestreview-1407953553) |\n| Approach ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27476#pullrequestreview-1395486586) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27018](https://github.com/bitcoin/bitcoin/pull/27018) (mempool / miner: regularly flush <=0-fee entries and mine everything in the mempool by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-04-17T16:28:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1511703508",
      "id" : 1511703508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585aGsPU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1511703508/reactions"
      },
      "updated_at" : "2023-05-01T19:28:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1511703508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe move most of the text in the PR description into a comment? \"Review this first\" and \"Alternatives considered\" stuff is useful here, but doesn't seem useful for the merge commit message?",
      "created_at" : "2023-04-18T06:28:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1512510817",
      "id" : 1512510817,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585aJxVh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1512510817/reactions"
      },
      "updated_at" : "2023-04-18T06:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1512510817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "**Alternatives Considered**\r\n\r\nFeel free to suggest more alternatives, but note potential problems.\r\n\r\n(1) Call TrimToSize() at smart intervals, e.g. when a timestamp changes (since packages are submitted with the same timestamp), or every ~25 transactions, or when we hit a certain threshold above maxmempool.\r\n(2) When a transaction fails for fee-related reasons, try again with bypass_limits=true, and then schedule a flush for later.\r\n(3) Create a new mempool.dat format, which contains a list of packages instead of transactions (package can have 1 transaction).\r\n(4) When loading, load into a buffer and use AncestorPackage \"packageifier\" (in https://github.com/bitcoin/bitcoin/pull/26711) to group them into packages and submit them together.\r\n\r\nTheir disadvantages:\r\n\r\n-    (1, 2) The implementation is a bit hacky. Some strategies may fail.\r\n-    (3, 4) The implementation is quite complex.\r\n-    (1, 2) When shrinking maxmempool, we won't always pick the top transactions by descendant feerate. Since mempool min feerate depends on the feerate of the last package removed + incremental, we can end up rejecting something with feerate 1sat/vB higher than what we keep. Essentially, we have a bias for earlier transactions. This is weird behavior (and makes it quite annoying to write tests).\r\n-    (1, 2) We need to add various bits of code to track things evicting each other to accurately report which transactions made it in and which didn't.\r\n-    (1, 2) Doesn't work for ephemeral anchors (https://github.com/bitcoin/bitcoin/pull/26403). We could work around this by adding another flag to bypass \"unspent anchor\" checks but... also a bit ugly.\r\n\r\nWe can also pick one of the more complex solutions to implement later (I expect people are going to be interested in (3) since it's the most future-proof). This problem shouldn't be very common right now. For the most part, it doesn't really matter if the \"bottom\" of your mempool doesn't match others'.",
      "created_at" : "2023-04-20T15:08:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1516503220",
      "id" : 1516503220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585aZAC0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516503220/reactions"
      },
      "updated_at" : "2023-04-20T15:08:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516503220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe move most of the text in the PR description into a comment? \"Review this first\" and \"Alternatives considered\" stuff is useful here, but doesn't seem useful for the merge commit message?\r\n\r\nMoved \"alternatives considered.\" I prefer putting \"review this first\" at the top so reviewers see it as soon as possible. It will go away if/when I rebase, so definitely before any merging happens.",
      "created_at" : "2023-04-20T15:11:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1516508803",
      "id" : 1516508803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585aZBaD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516508803/reactions"
      },
      "updated_at" : "2023-04-20T15:11:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516508803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1173589155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173589155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Afaict we currently import mempool txs from disk in the background and allow the node to make connections and sync the chain in parallel. Seems like this commit changes that by locking cs_main for the entire import duration. Not sure about the consequences.\r\n\r\nPotentially relevant for #27460 as well.",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-04-21T10:03:35Z",
      "diff_hunk" : "@@ -63,6 +63,7 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n         }\n         uint64_t num;\n         file >> num;\n+        LOCK2(cs_main, pool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1173589155",
      "id" : 1173589155,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585F84yj",
      "original_commit_id" : "0a4ecc9d552e8d36a980c16f823eb6bb4cb14966",
      "original_line" : 66,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 4,
      "pull_request_review_id" : 1395486586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173589155/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T10:06:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173589155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1181800707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181800707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`removed` is a bit confusing since it will likely bail without doing anything. `to_remove_rate`?",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-01T18:53:42Z",
      "diff_hunk" : "@@ -1058,17 +1058,23 @@ void CTxMemPool::TrimToSize(size_t sizelimit, std::vector<COutPoint>* pvNoSpends\n \n     unsigned nTxnRemoved = 0;\n     CFeeRate maxFeeRateRemoved(0);\n-    while (!mapTx.empty() && DynamicMemoryUsage() > sizelimit) {\n+    while (!mapTx.empty()) {\n         indexed_transaction_set::index<descendant_score>::type::iterator it = mapTx.get<descendant_score>().begin();\n \n+        CFeeRate removed(it->GetModFeesWithDescendants(), it->GetSizeWithDescendants());\n+        // Skim away everything paying effectively zero fees, regardless of mempool size.\n+        // Above that feerate, just trim until memory is within limits.\n+        if (removed >= m_min_relay_feerate && DynamicMemoryUsage() <= sizelimit) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1181800707",
      "id" : 1181800707,
      "line" : 1067,
      "node_id" : "PRRC_kwDOABII585GcNkD",
      "original_commit_id" : "d627adb4bdb861fd8ee74e2e8f68a52b4d020b7a",
      "original_line" : 1067,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 11,
      "pull_request_review_id" : 1407953553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181800707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-01T19:28:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181800707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1181824474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181824474"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To recap, this disallows a wallet(or other TrimToSize caller) from trimming a parent before the child is entered into the mempool?\r\n\r\nWith debug builds, this draws out the startup time of bitcoind by ~1.5 minutes with 300MB mempool. ~30 seconds on non-debug build.\r\n",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-01T19:27:53Z",
      "diff_hunk" : "@@ -63,6 +63,7 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n         }\n         uint64_t num;\n         file >> num;\n+        LOCK2(cs_main, pool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1181824474",
      "id" : 1181824474,
      "in_reply_to_id" : 1173589155,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585GcTXa",
      "original_commit_id" : "0a4ecc9d552e8d36a980c16f823eb6bb4cb14966",
      "original_line" : 66,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 4,
      "pull_request_review_id" : 1407953553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181824474/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-01T19:28:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181824474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this for now to (1) focus on more important functionality (2) defer the decision-making to when we have more information on usage and/or better eviction.\r\n- The \"trim stuff below minrelayfeerate\" thing isn't very good... as established, we might evict things we shouldn't, etc.\r\n- This isn't strictly necessary yet until package relay is deployed.\r\n- It might be too early to decide on a solution. Perhaps with EA and actual package relay usage, we'll end up wanting to reformat mempool.dat anyway. Or maybe, with other improvements to mempool, we will have a simpler solution that achieves everything we want.\r\n\r\nStill tracking this as a \"todo\" item in #27463, but will defer until later.",
      "created_at" : "2023-05-01T20:46:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1530227211",
      "id" : 1530227211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585bNWoL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1530227211/reactions"
      },
      "updated_at" : "2023-05-01T20:46:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1530227211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182176759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182176759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think locking `cs_main` or `pool.cs` for this long is okay.",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-02T07:19:06Z",
      "diff_hunk" : "@@ -63,6 +63,7 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n         }\n         uint64_t num;\n         file >> num;\n+        LOCK2(cs_main, pool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182176759",
      "id" : 1182176759,
      "in_reply_to_id" : 1173589155,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585GdpX3",
      "original_commit_id" : "0a4ecc9d552e8d36a980c16f823eb6bb4cb14966",
      "original_line" : 66,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 4,
      "pull_request_review_id" : 1408532061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182176759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-02T09:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182176759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182180279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182180279"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We currently only do `bypass_limits` for txs from a reorg; not even packages can bypass limits otherwise. I think leaving `bypass_limits=false` for loading from mempool.dat should be fine until that changes?",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-02T07:23:13Z",
      "diff_hunk" : "@@ -77,8 +78,12 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n                 pool.PrioritiseTransaction(tx->GetHash(), amountdelta);\n             }\n             if (nTime > TicksSinceEpoch<std::chrono::seconds>(now - pool.m_expiry)) {\n-                LOCK(cs_main);\n-                const auto& accepted = AcceptToMemoryPool(active_chainstate, tx, nTime, /*bypass_limits=*/false, /*test_accept=*/false);\n+                // Use bypass_limits=true to skip feerate checks, and call TrimToSize() at the very",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182180279",
      "id" : 1182180279,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585GdqO3",
      "original_commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "original_line" : 81,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 14,
      "pull_request_review_id" : 1408532061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182180279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-02T09:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182180279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182181426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182181426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This may be evicting txs that were present in the mempool prior to the import, in which case it will overestimate `failed` and underestimate `count`?",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-02T07:24:32Z",
      "diff_hunk" : "@@ -104,6 +109,13 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n         for (const auto& i : mapDeltas) {\n             pool.PrioritiseTransaction(i.first, i.second);\n         }\n+        const auto size_before_trim{pool.size()};\n+        // Ensure the maximum memory limits are ultimately enforced and any transactions below\n+        // minimum feerates are evicted, since bypass_limits was set to true during ATMP calls.\n+        pool.TrimToSize(pool.m_max_size_bytes);\n+        const auto num_evicted{size_before_trim - pool.size()};\n+        count -= num_evicted;\n+        failed += num_evicted;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182181426",
      "id" : 1182181426,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII585Gdqgy",
      "original_commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "original_line" : 118,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 33,
      "pull_request_review_id" : 1408532061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182181426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-02T09:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182181426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182182757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182182757"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If `bypass_limits` is left as false, I think these changes are not necessary?",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-02T07:26:02Z",
      "diff_hunk" : "@@ -1058,17 +1058,23 @@ void CTxMemPool::TrimToSize(size_t sizelimit, std::vector<COutPoint>* pvNoSpends\n \n     unsigned nTxnRemoved = 0;\n     CFeeRate maxFeeRateRemoved(0);\n-    while (!mapTx.empty() && DynamicMemoryUsage() > sizelimit) {\n+    while (!mapTx.empty()) {\n         indexed_transaction_set::index<descendant_score>::type::iterator it = mapTx.get<descendant_score>().begin();\n \n+        CFeeRate removed(it->GetModFeesWithDescendants(), it->GetSizeWithDescendants());\n+        // Skim away everything paying effectively zero fees, regardless of mempool size.\n+        // Above that feerate, just trim until memory is within limits.\n+        if (removed >= m_min_relay_feerate && DynamicMemoryUsage() <= sizelimit) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182182757",
      "id" : 1182182757,
      "in_reply_to_id" : 1181800707,
      "line" : 1067,
      "node_id" : "PRRC_kwDOABII585Gdq1l",
      "original_commit_id" : "d627adb4bdb861fd8ee74e2e8f68a52b4d020b7a",
      "original_line" : 1067,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 11,
      "pull_request_review_id" : 1408532061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182182757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-02T09:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182182757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182298691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182298691"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To be clear I agree that this was not the right thing to do.",
      "commit_id" : "2c0931b8f45706193de7b7b8ebd822577e4d8279",
      "created_at" : "2023-05-02T09:14:29Z",
      "diff_hunk" : "@@ -63,6 +63,7 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n         }\n         uint64_t num;\n         file >> num;\n+        LOCK2(cs_main, pool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#discussion_r1182298691",
      "id" : 1182298691,
      "in_reply_to_id" : 1173589155,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585GeHJD",
      "original_commit_id" : "0a4ecc9d552e8d36a980c16f823eb6bb4cb14966",
      "original_line" : 66,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 4,
      "pull_request_review_id" : 1408720699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27476",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182298691/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-02T09:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1182298691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for writing up a full review @ajtowns. Will keep this feedback in mind for the future if/when we get to this bridge again.\r\n\r\n> implement cluster mempool first and export mempool.dat in chunks from highest to lowest fee; when importing, assume that the mempool contains chunks from highest score to lowest, build up a chunk to import; once it's over the mempool minfee, import the txs immediately; if it's over 1MvB and still under the mempool minfee, drop it and stop attempting to import txs from this mempool.dat entirely?\r\n\r\nYeah I'm pretty optimistic that cluster mempool will provide a natural solution like this.",
      "created_at" : "2023-05-02T09:21:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1531154152",
      "id" : 1531154152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585bQ47o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531154152/reactions"
      },
      "updated_at" : "2023-05-02T09:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531154152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Yeah I'm pretty optimistic that cluster mempool will provide a natural solution like this.\r\n\r\nProbably, but I suspect ephemeral anchors or similar will be ready before we've got all the i's dotted and t's crossed on cluster mempool, so some stop gap patch will be worthwhile. Still, we can cross that bridge once we get there.",
      "created_at" : "2023-05-02T10:52:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1531265734",
      "id" : 1531265734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27476",
      "node_id" : "IC_kwDOABII585bRULG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531265734/reactions"
      },
      "updated_at" : "2023-05-02T10:52:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531265734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
