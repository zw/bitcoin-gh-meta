[
   {
      "author_association" : "MEMBER",
      "body" : "Non-determinism is bad :-(\r\n\r\nIs there a specific subset of the tests that exhibit this behaviour, or is it across the board?",
      "created_at" : "2018-10-01T08:46:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-425832541",
      "id" : 425832541,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNTgzMjU0MQ==",
      "updated_at" : "2018-10-01T08:47:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/425832541",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Marco, how would you suggest fixing this? I imagine adding options to use fixed seeds when choosing random test behaviors would fix some problems, and disabling tests like practicalswift suggested could be a fallback in other cases.",
      "created_at" : "2018-10-04T04:36:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-426882606",
      "id" : 426882606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjg4MjYwNg==",
      "updated_at" : "2018-10-04T04:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426882606",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I have no idea on how to solve this, since some (unit) tests are inherently racy with regard to coverage.\r\n\r\nSee for example:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2796c6e5ec9055545e987023b04eb5ebe64d5320/src/validation.cpp#L2677-L2679\r\n\r\nwhich is sometimes hit and other times not.",
      "created_at" : "2018-10-04T07:38:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-426916136",
      "id" : 426916136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjkxNjEzNg==",
      "updated_at" : "2018-10-04T07:38:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426916136",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Assuming cases like this aren't very common, we could add a `-test-determinism` debug option and change the condition to:\r\n\r\n```c++\r\nif (GetMainSignals().CallbacksPending() > 10 && !g_test_determinism)\r\n```\r\n\r\nThis would be similar to the `g_debug_lockorder_abort` flag, which also modifies behavior for the sake of testing.",
      "created_at" : "2018-10-04T08:59:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-426940085",
      "id" : 426940085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjk0MDA4NQ==",
      "updated_at" : "2018-10-04T08:59:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426940085",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky That is a very good idea. That would also serve as a documentation on where these issues are expected to be encountered. And documenting the issues is the first step towards fixing them :-)",
      "created_at" : "2018-10-04T09:07:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-426942760",
      "id" : 426942760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjk0Mjc2MA==",
      "updated_at" : "2018-10-04T09:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426942760",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think a first step would be to see which tests are the problematic ones (as suggested by @practicalswift earlier), then see where and why they are causing indeterminism and then see how to fix each instance best.\r\n\r\nSo maybe run coverage reports for each unit test case, the util tests, and each functional test script thrice or so and see if they differ?",
      "created_at" : "2018-10-04T09:12:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-426944368",
      "id" : 426944368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjk0NDM2OA==",
      "updated_at" : "2018-10-04T09:12:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426944368",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alternatively, the coverage reports should just run in a (virtual) environment that always executes deterministically",
      "created_at" : "2018-12-04T23:12:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-444295596",
      "id" : 444295596,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NDI5NTU5Ng==",
      "updated_at" : "2018-12-04T23:12:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/444295596",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've worked on this and this is the current status:\r\n\r\nI'm now able to run `src/test/test_bitcoin`, `src/qt/test/test_bitcoin-qt` and `src/bench/bench_bitcoin -evals=1 -scaling=0` with 100% determinism with regards to line coverage.\r\n\r\nMore specifically I'm getting exactly the same set of covered lines across hundreds of test runs. (A line is covered if it is executed at least once during a test run.)\r\n\r\nI had to patch the following files to achieve determinism:\r\n* `src/qt/rpcconsole.cpp` (`RPCConsole::setClientModel`)\r\n* `src/qt/trafficgraphwidget.cpp` (`TrafficGraphWidget::updateRates`)\r\n* `src/test/test_bitcoin.{cpp,h}` (`BasicTestingSetup::BasicTestingSetup`)\r\n* `src/validation.cpp` (`CChainState::ActivateBestChain`)\r\n* `src/wallet/wallet.cpp` (`GetLocktimeForNewTransaction`)\r\n\r\nAdditionally I had to disable the following ten unit tests which were non-deterministic also in the presence of said patches:\r\n* `bloom_tests/rolling_bloom`\r\n* `coins_tests/updatecoins_simulation_test`\r\n* `coinselector_tests/knapsack_solver_test`\r\n* `denialofservice_tests/DoS_mapOrphans`\r\n* `scheduler_tests/manythreads`\r\n* `scheduler_tests/singlethreadedscheduler_ordered`\r\n* `tx_validationcache_tests/tx_mempool_block_doublespend`\r\n* `txindex_tests/txindex_initial_sync`\r\n* `validation_block_tests/processnewblock_signals_ordering`\r\n* `wallet_tests/ListCoins`\r\n\r\nI'm currently using `#ifdef DETERMINISTIC_COVERAGE_MODE_UNSAFE_FOR_PRODUCTION` to keep my changes opt-in.\r\n\r\nFor example:\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 6a26bf9ba..61a5558ff 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -2677,6 +2677,9 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\r\n     do {\r\n         boost::this_thread::interruption_point();\r\n\r\n+#ifdef DETERMINISTIC_COVERAGE_MODE_UNSAFE_FOR_PRODUCTION\r\n+        // Skip validation queue drain to achieve line coverage determinism in tests.\r\n+#else\r\n         if (GetMainSignals().CallbacksPending() > 10) {\r\n             // Block until the validation queue drains. This should largely\r\n             // never happen in normal operation, however may happen during\r\n@@ -2686,6 +2689,7 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\r\n             // probably have a DEBUG_LOCKORDER test for this in the future.\r\n             SyncWithValidationInterfaceQueue();\r\n         }\r\n+#endif\r\n\r\n         {\r\n             LOCK(cs_main);\r\n```\r\n\r\nIs that a sensible approach?",
      "created_at" : "2019-01-30T17:44:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-459039434",
      "id" : 459039434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1OTAzOTQzNA==",
      "updated_at" : "2019-01-30T17:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/459039434",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've also written a shell script that runs the test suite up to `N` times and errors if line coverage non-determinism is detected in any of the runs.",
      "created_at" : "2019-01-30T17:50:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-459041363",
      "id" : 459041363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1OTA0MTM2Mw==",
      "updated_at" : "2019-01-30T17:50:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/459041363",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Wow, thanks for working on this. I am definitely interested in seeing the helper script and patch.",
      "created_at" : "2019-01-30T17:58:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14343#issuecomment-459044323",
      "id" : 459044323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14343",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1OTA0NDMyMw==",
      "updated_at" : "2019-01-30T17:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/459044323",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
