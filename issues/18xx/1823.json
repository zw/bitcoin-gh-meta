{
   "assignee" : null,
   "body" : "The problem\n===========\n\n`SetCompact` as currently implemented interprets the compact number `0x01810000` as `-1` instead of `0x81`, because it is implemented using `BN_mpi2bn`, which interprets the highest bit in the first byte of its input as sign and this is not compensated for.  Ã¢ÂÂ  Currently this is not a problem as none of the bitcoin-implementations I've looked at generate compact numbers with the `0x00800000` bit set.  Many contain a matching bug in their compact encoding routines.\n\nSatoshi:\n * `CBigNum.GetCompact(0x81)` => `0x02008100`\n * `CBigNum.SetCompact(0x01810000)` => `-1`\n\n Defensive encoding.\n Decoding results in negative number with highest bit stripped.\n\nbitcoinj:\n * No compact encoding.\n * `Utils.decodeCompactBits(0x01810000)` => `-1`\n\n Decoding will lead to `Block::getDifficultyTargetAsInteger()` throwing a `VerificationException`.\n\nbitcoinjs:\n * `encodeDiffBits(0x80)` => `0x02008000`\n * `decodeDiffBits(0x01810000)` => `0x81` (OK)\n\n Defensive encoding and correct decoding\n\nlibbitcoin:\n * `big_number::compact(0x80)` => `0x02008000`\n * `big_number::set_compact(0x01810000)` => `-1`\n\n Defensive encoding.\n Decoding results in block_work() returning 0 and\n validate_block::check_proof_of_work returning false.\n\nThis branch\n===========\n\nThe first commit adds several test cases for `GetCompact()` and `SetCompact()`, including one showcasing the erroneous decoding.\n\nThe second commit reimplements `GetCompact()` and `SetCompact()` using shifts instead of going through the MPI-representation.\n\n`GetCompact()` now is careful not to generate compact numbers with the `0x00800000` bit set (`GetCompact(0xff)` yields `0x0200ff00` instead of `0x01ff0000`).  It results in identical compact numbers for positive inputs as the old code.\n\n`SetCompact` now interprets the compact number `0x01810000` as `0x81` instead of `-1`.",
   "closed_at" : "2012-11-13T20:32:32Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/523218?v=3",
      "events_url" : "https://api.github.com/users/roques/events{/privacy}",
      "followers_url" : "https://api.github.com/users/roques/followers",
      "following_url" : "https://api.github.com/users/roques/following{/other_user}",
      "gists_url" : "https://api.github.com/users/roques/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/roques",
      "id" : 523218,
      "login" : "roques",
      "organizations_url" : "https://api.github.com/users/roques/orgs",
      "received_events_url" : "https://api.github.com/users/roques/received_events",
      "repos_url" : "https://api.github.com/users/roques/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/roques/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/roques/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/roques"
   },
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1823/comments",
   "created_at" : "2012-09-13T14:38:18Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1823/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/1823",
   "id" : 6849012,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1823/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 1823,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/1823.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1823",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/1823.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1823"
   },
   "state" : "closed",
   "title" : "CBigNum::GetCompact / SetCompact",
   "updated_at" : "2012-11-13T20:32:32Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1823",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/523218?v=3",
      "events_url" : "https://api.github.com/users/roques/events{/privacy}",
      "followers_url" : "https://api.github.com/users/roques/followers",
      "following_url" : "https://api.github.com/users/roques/following{/other_user}",
      "gists_url" : "https://api.github.com/users/roques/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/roques",
      "id" : 523218,
      "login" : "roques",
      "organizations_url" : "https://api.github.com/users/roques/orgs",
      "received_events_url" : "https://api.github.com/users/roques/received_events",
      "repos_url" : "https://api.github.com/users/roques/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/roques/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/roques/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/roques"
   }
}
