[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26415](https://github.com/bitcoin/bitcoin/pull/26415) (rpc,rest: faster getblock and rest_block by reading raw block by andrewtoth)\n* [#26288](https://github.com/bitcoin/bitcoin/pull/26288) (Enable -Wstring-concatenation and -Wstring-conversion on clang builds by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-10-17T18:29:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#issuecomment-1281302316",
      "id" : 1281302316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26316",
      "node_id" : "IC_kwDOABII585MXx8s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281302316/reactions"
      },
      "updated_at" : "2022-10-28T22:40:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281302316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r999228331"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999228331"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nstd::shared_mutex g_unlinkfiles_mutex;\r\n```\r\n\r\nWould be more inline with our naming conventions.\r\n\r\nBut generally I think we should be removing globals instead of adding more. In this case, we could make `ReadBlockFromDisk`, `ReadRawBlockFromDisk`, `UndoReadFromDisk`, `UnlinkPrunedFiles` methods of `BlockManager` and have the mutex owned by that as well. I have not scoped out how big of a refactor that would be but I think that would be preferable.",
      "commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "created_at" : "2022-10-19T10:05:47Z",
      "diff_hunk" : "@@ -29,6 +30,7 @@ std::atomic_bool fImporting(false);\n std::atomic_bool fReindex(false);\n bool fPruneMode = false;\n uint64_t nPruneTarget = 0;\n+std::shared_mutex cs_UnlinkFiles;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r999228331",
      "id" : 999228331,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5847jwOr",
      "original_commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "original_line" : 33,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 12,
      "pull_request_review_id" : 1147251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999228331/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T10:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999228331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">Reading the block file will fail if (a) the file was removed or (b) if CBlockIndex::nStatus does not have the BLOCK_HAVE_DATA bit set at the time of calling GetBlockPos() in ReadBlockFromDisk. In this PR you cover (a) but not (b), is that right? BlockManager::PruneOneBlockFile unsets the bit during pruning before UnlinkPrunedFiles is called, so it seems to like the race could still happen.\r\n\r\nYes, that sounds right to me. However, after this change https://github.com/bitcoin/bitcoin/issues/17161 will not really be a problem. Since getting the block position inside `ReadBlockFromDisk` will return an empty position if `nStatus` does not have `BLOCK_HAVE_DATA`, the read will fail. Having the read fail should be fine as long as the error can be handled gracefully (like RPC/REST/ZMQ/net_processing) but in validation code `cs_main` should remain locked so it can't happen.\r\n\r\nThe real issue this solves is on Windows where if after `pindex->GetBlockPos()` is called and the file is opened then the files are unlinked. This will cause the file to not be removed. From https://en.cppreference.com/w/cpp/io/c/remove\r\n>If the file is currently open by the current or another process, the behavior of this function is implementation-defined\r\n\r\nI think we should just avoid that happening altogether since \"implementation-defined\" sounds scary. This was suggested in https://github.com/bitcoin/bitcoin/pull/11913#pullrequestreview-88290878 and mentioned in https://github.com/bitcoin/bitcoin/pull/13903#issuecomment-420806441 as well.\r\n\r\nAnother strategy could be to not unset `CBlockIndex::nFile` and `CBlockIndex::nDataPos` when calling `BlockManager::PruneOneBlockFile` and then not check for `BLOCK_HAVE_DATA` in `CBlockIndex::GetBlockPos()`. That way a read will still succeed even if the block is set to be pruned but the file has not been removed. Then `nFile` and `nDataPos` can be zeroed in `UnlinkPrunedFiles`. But that seems like a bigger change for not much more benefit.",
      "created_at" : "2022-10-19T14:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#issuecomment-1284082907",
      "id" : 1284082907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26316",
      "node_id" : "IC_kwDOABII585MiYzb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284082907/reactions"
      },
      "updated_at" : "2022-10-19T15:00:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284082907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1000954807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000954807"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "All places have access to the `BlockManager` fairly easily so it should be straightforward refactor, with the exception of `CZMQPublishRawBlockNotifier::NotifyBlock`. I have no idea how I will get a handle to the `BlockManager` from there :/.",
      "commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "created_at" : "2022-10-20T17:59:05Z",
      "diff_hunk" : "@@ -29,6 +30,7 @@ std::atomic_bool fImporting(false);\n std::atomic_bool fReindex(false);\n bool fPruneMode = false;\n uint64_t nPruneTarget = 0;\n+std::shared_mutex cs_UnlinkFiles;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1000954807",
      "id" : 1000954807,
      "in_reply_to_id" : 999228331,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5847qVu3",
      "original_commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "original_line" : 33,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 12,
      "pull_request_review_id" : 1149734590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000954807/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-20T17:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000954807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1003629353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003629353"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I created https://github.com/bitcoin/bitcoin/pull/26375 to remove needing to read a block from `CZMQPublishRawBlockNotifier::NotifyBlock` entirely. After that or something like it the refactor can be done much more easily. Marking as draft until that is merged.",
      "commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "created_at" : "2022-10-24T18:33:13Z",
      "diff_hunk" : "@@ -29,6 +30,7 @@ std::atomic_bool fImporting(false);\n std::atomic_bool fReindex(false);\n bool fPruneMode = false;\n uint64_t nPruneTarget = 0;\n+std::shared_mutex cs_UnlinkFiles;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1003629353",
      "id" : 1003629353,
      "in_reply_to_id" : 999228331,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII58470isp",
      "original_commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "original_line" : 33,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 12,
      "pull_request_review_id" : 1153595316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003629353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T18:33:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003629353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1013466589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013466589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The refactor should be after and separate from the fix.",
      "commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "created_at" : "2022-11-03T22:49:39Z",
      "diff_hunk" : "@@ -29,6 +30,7 @@ std::atomic_bool fImporting(false);\n std::atomic_bool fReindex(false);\n bool fPruneMode = false;\n uint64_t nPruneTarget = 0;\n+std::shared_mutex cs_UnlinkFiles;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#discussion_r1013466589",
      "id" : 1013466589,
      "in_reply_to_id" : 999228331,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5848aEXd",
      "original_commit_id" : "ad67092f923b5d97c527fb214a3a290e8147bfc1",
      "original_line" : 33,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 12,
      "pull_request_review_id" : 1167755463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26316",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013466589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T22:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013466589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This seems like only a partial fix, since we should be checking `BLOCK_HAVE_DATA` within the lock. Otherwise, there's still a race after we check it and the block is read, where the block could be pruned.\r\n\r\nOTOH, maybe we should just handle missing block files more gracefully than a failed assertion...",
      "created_at" : "2022-11-03T22:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26316#issuecomment-1302766622",
      "id" : 1302766622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26316",
      "node_id" : "IC_kwDOABII585NpqQe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1302766622/reactions"
      },
      "updated_at" : "2022-11-03T22:54:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1302766622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
