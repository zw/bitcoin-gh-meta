[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/25390).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1557425242) |\n| Approach ACK | [w0xlt](https://github.com/bitcoin/bitcoin/pull/25390#pullrequestreview-1009041664), [ajtowns](https://github.com/bitcoin/bitcoin/pull/25390#pullrequestreview-1145740612) |\n| Stale ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/25390#pullrequestreview-1390434676) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28075](https://github.com/bitcoin/bitcoin/pull/28075) (util: Remove DirIsWritable, GetUniquePath by maflcko)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-06-16T15:04:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1157765950",
      "id" : 1157765950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FAhs-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157765950/reactions"
      },
      "updated_at" : "2023-10-23T18:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157765950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems like a potentially useful alternative to clang thread safety annotations. The `ThreadSafePtr<T>` class forces code to lock a mutex when accessing data, just like TSA annotations do, except unlike TSA annotations, it doesn't rely on a nonstandard compiler extension, or suffer from quirks that come from doing a limited static analysis.\r\n\r\n`ThreadSafePtr<T>` is obviously not a complete substitute for thread safety annotations since it only handles the simple case where a single non-recursive Mutex is used to protect access to a single variable. But the variable can have any C++ type (primitive, container, or struct), so it's probably flexible enough for a lot of cases.\r\n\r\nI don't think the `ThreadSafePtr<T>` is the best name because `xxx_ptr<T>` implies the type is some kind of lightweight reference to the `T`, not a container which holds the `T`. I would call it something like `Synced<T>` or `LockedData<T>`. (An analogy here would be `std::optional<T>`, which is not called `std::optional_ptr<T>`, even though it has `*` and `->` members, because it's purpose is to be a container, not a pointer. The class is named after what it's used for not what kind of members it has.)",
      "created_at" : "2022-06-16T17:28:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1157945376",
      "id" : 1157945376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FBNgg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157945376/reactions"
      },
      "updated_at" : "2022-06-16T17:28:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157945376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899366531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sync: introduce a thread safe smart pointer\" (3d77fdb3127649d560c8f39d8ab83d32c9d0dff6)\r\n\r\nI think it would be an improvement to just give these methods a normal name like `Lock` instead of making them operators. Calling code would change from:\r\n\r\n```c++\r\nauto v_locked = *v;\r\nfor (auto& i : v_locked) ...\r\n```\r\n\r\nto \r\n\r\n```c++\r\nauto v_locked = v.Lock();\r\nfor (auto& i : v_locked) ...\r\n```\r\n\r\nwhich would be clearer and simpler. Proxy class is the actual class acting like a pointer so it needs `*` and `->` methods. But outer `ThreadSafePtr` class is not really a pointer at all, but a container, so there is not a concrete reason it needs to have `*` and `->` members unless that's an aesthetic preference.",
      "commit_id" : "e577177a339d5a833ba82c9656fa0291ad05b001",
      "created_at" : "2022-06-16T17:42:39Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }\n+\n+    Proxy operator*() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator*() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899366531",
      "id" : 899366531,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII5841mz6D",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 490,
      "original_position" : 91,
      "original_start_line" : 486,
      "path" : "src/sync.h",
      "position" : 91,
      "pull_request_review_id" : 1009459470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 486,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-16T18:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899380437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sync: introduce a thread safe smart pointer\" (3d77fdb3127649d560c8f39d8ab83d32c9d0dff6)\r\n\r\nI'm pretty sure the const version of these -> and * methods are unusable and will always lead to compile errors if you ever tried to call them. If you want to allow accessing contents of const `ThreadSafePtr` objects, probably you need to introduce Proxy/ConstProxy classes similar to c++ iterator/const_interator classes. Otherwise you could drop these const methods.",
      "commit_id" : "e577177a339d5a833ba82c9656fa0291ad05b001",
      "created_at" : "2022-06-16T17:59:12Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899380437",
      "id" : 899380437,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII5841m3TV",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 487,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 88,
      "pull_request_review_id" : 1009459470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-16T18:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems like a non-starter to me? It's not even able to detect obvious double locks at compile-time:\r\n\r\n```c++\r\n    ThreadSafePtr<std::map<int, int>> m;\r\n    m->emplace(5, 25);\r\n    {\r\n        auto m_locked = *m;\r\n        m_locked->emplace(6, 36);\r\n        m->emplace(7, 49);  // double lock\r\n\r\n        auto m_locked2 = *m; // double lock\r\n        m_locked->emplace(9, 81);\r\n        m_locked2->emplace(10, 100);\r\n    }\r\n```\r\n\r\nEven if it weren't worse at catching bugs, it doesn't seem like an improvement over writing:\r\n\r\n```c++\r\n    Mutex mut;\r\n    std::map<int, int> m GUARDED_BY(mut);\r\n\r\n    WITH_LOCK(mut, m.emplace(5, 25));\r\n    {\r\n        LOCK(mut);\r\n        m.emplace(6, 36);\r\n        m.emplace(7, 49);  // no double lock\r\n\r\n        LOCK(mut); // double lock - detected at compile time\r\n        m.emplace(9, 81);\r\n        m.emplace(10, 100);\r\n    }\r\n```",
      "created_at" : "2022-06-17T02:55:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1158434634",
      "id" : 1158434634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FDE9K",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158434634/reactions"
      },
      "updated_at" : "2022-06-17T02:55:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158434634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It's not even able to detect obvious double locks at compile-time: \r\n\r\nI assume it can be annotated just like any other lock. Agree implementation should fix this, though.\r\n\r\n> Even if it weren't worse at catching bugs, it doesn't seem like an improvement over writing\r\n\r\nWell one improvement is that it enforces locking on all compilers, unlike the clang annotations. The code itself doesn't seem much better or worse in this case for this very simple data structure, but it's probably is worth experimenting with for chains and chainstates and mempools, etc to be able to avoid logic bugs, distinguish different uses of cs_main for different purposes, and not just have LOCK(cs_main) everywhere what no indication about what exactly is being locked or why.\r\n\r\nLooking at your examples, though I would even more want to replace the `*m` syntax with `m.Lock()` as suggested previously to make usage more obvious.",
      "created_at" : "2022-06-17T04:21:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1158475359",
      "id" : 1158475359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FDO5f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158475359/reactions"
      },
      "updated_at" : "2022-06-17T04:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158475359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r901851921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901851921"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I removed them because they are not needed (currently). In a previous incarnation of this I had it working with `const ThreadSafePtr`, but removed the complications that were required for that.\r\n\r\nCan always extend it (restore these) if `const` objects are necessary.",
      "commit_id" : "a870b2b89190c95102db89ff060a012836508fb3",
      "created_at" : "2022-06-20T16:43:10Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r901851921",
      "id" : 901851921,
      "in_reply_to_id" : 899380437,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841wSsR",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 487,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1012544031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901851921/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-20T16:43:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901851921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r901853708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901853708"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Renamed `operator*()` to `Lock()`. The `operator->()` is needed in order to cause a chained `->` calls.\r\n\r\nNotice that the call:\r\n\r\n```cpp\r\n(*g_my_net_addr)[my_net_addr_entry] = lsi;\r\n```\r\n\r\nnow becomes:\r\n\r\n```cpp\r\ng_my_net_addr.Lock()[my_net_addr_entry] = lsi;\r\n```",
      "commit_id" : "a870b2b89190c95102db89ff060a012836508fb3",
      "created_at" : "2022-06-20T16:46:10Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }\n+\n+    Proxy operator*() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator*() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r901853708",
      "id" : 901853708,
      "in_reply_to_id" : 899366531,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841wTIM",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 490,
      "original_position" : 91,
      "original_start_line" : 486,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1012546455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901853708/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-20T16:46:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901853708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`e577177a33...a870b2b891`: address suggestions and remove optional commit that was a kind of scope creep for this PR - `net: simplify logic around reachable networks and -onlynet`, it will make it in a followup.\r\n\r\n@ryanofsky very insightful review, thanks for the suggestions!\r\n\r\n> This seems like a potentially useful alternative to clang thread safety annotations. The `ThreadSafePtr<T>` class forces code to lock a mutex when accessing data, just like TSA annotations do, except...\r\n\r\nHmm, right, I did not think of this from that perspective. In addition - TSA do not actually \"force\" anything, they emit a mere warning if compiled with `clang`. They do nothing for gcc. And if `-Werror` is not used to turn the warning into an error, then they can be missed/ignored.\r\n\r\nI see this as a complementary to TSA.\r\n\r\n> I don't think the `ThreadSafePtr<T>` is the best name because `xxx_ptr<T>` implies the type is some kind of lightweight reference to the `T`, not a container which holds the `T`. I would call it something like `Synced<T>` ...\r\n\r\nRenamed to `Synced<T>`, thanks!",
      "created_at" : "2022-06-20T16:54:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1160665973",
      "id" : 1160665973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FLlt1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160665973/reactions"
      },
      "updated_at" : "2022-06-20T16:54:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160665973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I assume it can be annotated just like any other lock. Agree implementation should fix this, though.\r\n\r\nI think you'd have to mark the `Synced` object as being lock itself (`LOCKABLE`), and mark the `Proxy` class as being a RAII guard (`SCOPED_LOCKABLE`), with the constructor/destructor annotated appropriately (`EXCLUSIVE_LOCK_FUNCTION(ref_to_scoped_obj)` and `UNLOCK_FUNCTION()`), and with the functions that create the Proxy (`Lock` and `operator->`) annotated with negative constraints (`EXCLUSIVE_LOCKS_REQUIRED(!this)`)? I've got pretty low confidence that that will actually work as hoped/expected though...\r\n\r\n> Well one improvement is that it enforces locking on all compilers, unlike the clang annotations.\r\n\r\nWe already enforce locking is correct via compiling with clang in CI; it's certainly an improvement to get those warnings earlier for anyone who's not using clang or doesn't have the options enabled, but [EDIT: oops, didn't finish the thought:] not at the cost of losing some checks entirely.\r\n",
      "created_at" : "2022-06-23T09:06:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1164151295",
      "id" : 1164151295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FY4n_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164151295/reactions"
      },
      "updated_at" : "2022-06-23T11:17:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164151295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't see any obvious benefit here, looking at the comparison with current code in https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1158434634 ",
      "created_at" : "2022-06-23T09:49:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1164194609",
      "id" : 1164194609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FZDMx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164194609/reactions"
      },
      "updated_at" : "2022-06-23T09:49:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164194609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`a870b2b891...7b05e787cf`: use `LOCK(synced)` at call sites and remove more `GlobalMutex`es.\r\n\r\nThe benefit is not at the call sites - they can use different flavors of syntax sugar but all of them more or less boil down to the same thing. I changed it to use `{ LOCK(foo); foo->Method1(); foo->Method2(); ... }` so that it is not possible to misuse like @ajtowns suggested [above](https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1158434634).\r\n\r\nThe `Synced<T>` abstraction is similar to what is suggested in [this comment](https://github.com/bitcoin/bitcoin/pull/24931#discussion_r890636987) but it does so in a generic way to avoid code repetition. Its benefit is twofold:\r\n\r\n1. It avoids code repetition at the implementation sites. Namely this:\r\n\r\n<details>\r\n<summary>Lots of repetitions (92 lines)</summary>\r\n\r\n```cpp\r\nclass Foo\r\n{\r\npublic:\r\n    void PushBack(x)\r\n    {\r\n        LOCK(m_mutex);\r\n        m_data.push_back(x);\r\n    }\r\n\r\n    size_t Size()\r\n    {\r\n        LOCK(m_mutex);\r\n        return m_data.size();\r\n    }\r\n\r\n    // maybe also other methods if needed...\r\n\r\n    auto Lock()\r\n    {\r\n        return DebugLock<Mutex>{m_mutex, \"Foo::m_mutex\", __FILE__, __LINE__};\r\n    }\r\n\r\nprivate:\r\n    Mutex m_mutex;\r\n    std::vector<int> m_data;\r\n};\r\n\r\nclass Bar\r\n{\r\npublic:\r\n    void PushBack(x)\r\n    {\r\n        LOCK(m_mutex);\r\n        m_data.push_back(x);\r\n    }\r\n\r\n    size_t Size()\r\n    {\r\n        LOCK(m_mutex);\r\n        return m_data.size();\r\n    }\r\n\r\n    // maybe also other methods if needed...\r\n\r\n    auto Lock()\r\n    {\r\n        return DebugLock<Mutex>{m_mutex, \"Bar::m_mutex\", __FILE__, __LINE__};\r\n    }\r\n\r\nprivate:\r\n    Mutex m_mutex;\r\n    std::vector<std::string> m_data;\r\n};\r\n\r\nclass Baz\r\n{\r\npublic:\r\n    void Insert(x)\r\n    {\r\n        LOCK(m_mutex);\r\n        m_data.insert(x);\r\n    }\r\n\r\n    size_t Size()\r\n    {\r\n        LOCK(m_mutex);\r\n        return m_data.size();\r\n    }\r\n\r\n    // maybe also other methods if needed...\r\n\r\n    auto Lock()\r\n    {\r\n        return DebugLock<Mutex>{m_mutex, \"Baz::m_mutex\", __FILE__, __LINE__};\r\n    }\r\n\r\nprivate:\r\n    Mutex m_mutex;\r\n    std::set<std::string> m_data;\r\n};\r\n```\r\n</details>\r\n\r\nbecomes this:\r\n\r\n<details>\r\n<summary>Short (3 lines)</summary>\r\n\r\n```cpp\r\nSynced<std::vector<int>> Foo;\r\nSynced<std::vector<std::string>> Bar;\r\nSynced<std::set<std::string>> Baz;\r\n```\r\n</details>\r\n\r\n2. The mutex is properly encapsulated. With a global mutex and a global variable annotated with `GUARDED_BY()` it is indeed not possible to add new code that accesses the variable without protection (if using Clang and `-Wthread-safety-analysis` and `-Werror`), but it is possible to abuse the mutex and start using it to protect some more, possibly unrelated stuff (we already have this in the current code).\r\n",
      "created_at" : "2022-06-29T10:04:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1169788319",
      "id" : 1169788319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FuY2f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169788319/reactions"
      },
      "updated_at" : "2022-07-13T06:29:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169788319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ah, looks like this is `std::atomic` for structs/classes then",
      "created_at" : "2022-06-29T10:13:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1169797417",
      "id" : 1169797417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FubEp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169797417/reactions"
      },
      "updated_at" : "2022-06-29T10:13:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169797417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ah, looks like this is `std::atomic` for structs/classes then\r\n\r\nRight, kind of. `std::atomic` can be used for any trivially copyable structs/classes too and if necessary it will use a mutex internally. The difference is that reading from an `atomic` would read it in a safe way from the memory and would return a copy of the stored object. So if we call a method of the stored object the mutex will be released before the method is called and the method will be called on the copy. `atomic` also does not provide a way to lock for longer time, spanning calls to multiple methods.",
      "created_at" : "2022-06-29T11:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1169846509",
      "id" : 1169846509,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FunDt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169846509/reactions"
      },
      "updated_at" : "2022-06-29T11:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169846509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919129254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919129254"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sync: introduce a thread safe smart container\" (618809ab6b1f1c67ea3e299626f1ccb89f55d9f1)\r\n\r\nIt seems like you could avoid this `m_owner` stuff by just replacing `Mutex` with `RecursiveMutex` below. Otherwise this code just seems like it is implementing `RecursiveMutex` on top of `Mutex`, which only makes it more complex and probably less efficient than using `RecursiveMutex` directly.\r\n\r\nMaybe it would be better to disallow double locking and use clang thread annotations to prevent obvious cases of double locking at compile time. But maybe this is not possible. And allowing double locking doesn't seem like an inherently bad thing here apart from the slight performance overhead. Code fragility problems associated with recursive mutex usage don't seem like they would be an problem here since the mutex is private and the class has a limited interface.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-07-12T15:44:27Z",
      "diff_hunk" : "@@ -400,4 +405,178 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects the owned object with a mutex.\n+ * Every time the container is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * for (auto& i : v.Lock()) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not change between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_owner{}, m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object.\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            // Avoid double-lock if the current thread is already the owner.\n+            // This read of parent.m_owner is unprotected but that is ok because\n+            // the result of the comparison to the current thread cannot be\n+            // changed by other, concurrently executing, threads.\n+            : m_lock{parent.m_owner == std::this_thread::get_id() ? nullptr : &parent.m_mutex,\n+                     mutex_name,\n+                     file_name,\n+                     line},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919129254",
      "id" : 919129254,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842yMym",
      "original_commit_id" : "618809ab6b1f1c67ea3e299626f1ccb89f55d9f1",
      "original_line" : 464,
      "original_position" : 79,
      "original_start_line" : 457,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1036036999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919129254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-12T16:06:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919129254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919824769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919824769"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree. Simplified this by removing `m_owner` and using `RecursiveMutex`.\r\n\r\nThis reduced the `Synced` implementation from 110 to 58 lines (excluding comments).\r\n\r\nIt is possible to further reduce it by removing `Synced::UniqueLock` but then call sites would have to use `auto lock = foo.Lock();` instead of the sweet `LOCK(foo);`. I think either way is fine.\r\n\r\n> Maybe it would be better to disallow double locking and use clang thread annotations to prevent obvious cases of double locking at compile time. But maybe this is not possible.\r\n\r\nI will look at this again, but last time I tried I couldn't do that - stumbled on some limitations and bizarre behavior that looked like a bug in the thread safety annotations. Notice that even now some cases are prevented at compile time, like:\r\n\r\n```cpp\r\nLOCK(foo);\r\n...\r\nLOCK(foo);\r\n```",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-07-13T08:54:51Z",
      "diff_hunk" : "@@ -400,4 +405,178 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects the owned object with a mutex.\n+ * Every time the container is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * for (auto& i : v.Lock()) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not change between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_owner{}, m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object.\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            // Avoid double-lock if the current thread is already the owner.\n+            // This read of parent.m_owner is unprotected but that is ok because\n+            // the result of the comparison to the current thread cannot be\n+            // changed by other, concurrently executing, threads.\n+            : m_lock{parent.m_owner == std::this_thread::get_id() ? nullptr : &parent.m_mutex,\n+                     mutex_name,\n+                     file_name,\n+                     line},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919824769",
      "id" : 919824769,
      "in_reply_to_id" : 919129254,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584202mB",
      "original_commit_id" : "618809ab6b1f1c67ea3e299626f1ccb89f55d9f1",
      "original_line" : 464,
      "original_position" : 79,
      "original_start_line" : 457,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1037006128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919824769/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T08:54:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919824769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`7b05e787cf...acb21a5a24`: simplify the implementation of `Synced`, as suggested [above](https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919129254).",
      "created_at" : "2022-07-13T08:57:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1182955925",
      "id" : 1182955925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585GgnmV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1182955925/reactions"
      },
      "updated_at" : "2022-07-13T08:57:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1182955925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-13T16:27:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1183432281",
      "id" : 1183432281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585Gib5Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1183432281/reactions"
      },
      "updated_at" : "2022-07-13T16:27:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1183432281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`acb21a5a24...4b870a1538`: rebase due to conflicts",
      "created_at" : "2022-07-14T07:18:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1184085863",
      "id" : 1184085863,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585Gk7dn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1184085863/reactions"
      },
      "updated_at" : "2022-07-14T07:18:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1184085863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`4b870a1538...135ca49e24`: Further simplify the `Synced` class:\r\n\r\n* Inherit `Synced` from `RecursiveMutex`. This allows the removal of the member `Synced::m_mutex` and the type `Synced::UniqueLock`\r\n* Inherit `Synced::Proxy` from `::UniqueLock<RecursiveMutex>`. This allows the removal of the member `Synced::Proxy::m_lock`.\r\n\r\nAfter the above changes there are two methods with similar names:\r\n* `Synced::lock()`, inherited from `RecursiveMutex`, it just locks the object\r\n* `Synced::Lock()`, it locks the object and returns a scoped lockable.\r\n\r\nTo avoid confusion, rename the latter to `operator*()`. This way constructs like `foo.Lock()[x]` become `(*foo)[x]` which looks better to me.\r\n\r\nNow the `Synced` class is 47 lines (excluding comments).\r\n",
      "created_at" : "2022-07-21T10:22:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1191312357",
      "id" : 1191312357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585HAfvl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191312357/reactions"
      },
      "updated_at" : "2022-07-21T10:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191312357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`135ca49e24...11ac578f91`: use `MutexType` instead of `M` in templates because `MutexType` is already used elsewhere in `sync.h`",
      "created_at" : "2022-07-21T11:25:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1191366795",
      "id" : 1191366795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585HAtCL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191366795/reactions"
      },
      "updated_at" : "2022-07-21T11:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191366795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r978269158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978269158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "After a lot of poking at this, I believe what's necessary to make clang's thread safety logic actually notice that this function grabs a lock is to annotate the move constructor of `Proxy`, ie `Proxy(Proxy&&) EXCLUSIVE_LOCK_FUNCTION(mutex) = default`. https://reviews.llvm.org/D41933?id=129496\r\n\r\nUnfortunately, I don't think that's sufficient to avoid clang getting confused about aliasing; at least the ways I've tried haven't worked.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-23T05:07:40Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r978269158",
      "id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846TzPm",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1117913698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978269158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T17:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978269158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r982661098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982661098"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think we should be doing more recursive mutex stuff (they're harder to reason about, and less efficient any time that matters). I haven't been able to figure out a way of doing this sensibly otherwise, however -- clang just gets too confused about aliasing.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-28T17:03:13Z",
      "diff_hunk" : "@@ -400,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r982661098",
      "id" : 982661098,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII5846kjfq",
      "original_commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "original_line" : 432,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 56,
      "pull_request_review_id" : 1117913698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982661098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T17:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982661098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983367668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983367668"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, me too. Clang keeps emitting bogus warnings about loops like `for (auto& a : *obj)` for everything I tried, so I gave up. It has its limitations after all.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-29T10:30:58Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983367668",
      "id" : 983367668,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846nP_0",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1125046640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983367668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T10:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983367668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983384482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983384482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It used `Mutex` before and mimicked a `RecursiveMutex`, but I totally agree with @ryanofsky's [comment](https://github.com/bitcoin/bitcoin/pull/25390#discussion_r919129254) and changed it to `RecursiveMutex`.\r\n\r\nEven before that there was another approach which did not need a recursive mutex, and double locking was not allowed, but [you did not like that](https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1158434634).",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-29T10:48:14Z",
      "diff_hunk" : "@@ -400,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983384482",
      "id" : 983384482,
      "in_reply_to_id" : 982661098,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII5846nUGi",
      "original_commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "original_line" : 432,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 56,
      "pull_request_review_id" : 1125068091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983384482/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T10:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983384482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983877979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983877979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In my opinion: we shouldn't allow double locking (for almost all locks), and should give compile time errors when double locking is attempted. I'd love to see a variant of this that achieved both those things.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-29T18:06:47Z",
      "diff_hunk" : "@@ -400,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983877979",
      "id" : 983877979,
      "in_reply_to_id" : 982661098,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII5846pMlb",
      "original_commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "original_line" : 432,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 56,
      "pull_request_review_id" : 1125785021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983877979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T18:06:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983877979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983913168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983913168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh!! How about this:\r\n\r\n```c++\r\ntemplate<typename T>\r\nstruct Guarded\r\n{\r\nprivate:\r\n    mutable Mutex m;\r\n    T obj GUARDED_BY(m);\r\npublic:\r\n    class SCOPED_LOCKABLE Proxy\r\n    {\r\n    private:\r\n        Guarded& g;\r\n    public:\r\n        Proxy(Guarded& g) EXCLUSIVE_LOCK_FUNCTION(g.m) : g{g}\r\n        {\r\n            g.m.lock();\r\n        }\r\n        ~Proxy() UNLOCK_FUNCTION() { g.m.unlock(); }\r\n\r\n        T& operator*() { return g.obj; }\r\n        T* operator->() { return &g.obj; }\r\n    };\r\n};\r\n\r\n#define PROXY(name, guarded) decltype(guarded)::Proxy name{guarded};\r\n\r\nGuarded<uint32_t> global_i;\r\nGuarded<std::vector<uint32_t>> global_nums;\r\nvoid foo()\r\n{\r\n    PROXY(p, global_i);\r\n    *p = 5;\r\n    *p += 6;\r\n    // PROXY(p2, global_i); // error: acquiring mutex 'global_i.m' that is already held [-Werror,-Wthread-safety-analysis]\r\n    // *p2 = 9;\r\n}\r\n\r\nint64_t lock_already_held(Guarded<std::vector<uint32_t>>::Proxy &p)\r\n{\r\n    int64_t j = 0;\r\n    for (auto i : *p) { j += i; }\r\n    return j;\r\n}\r\n\r\nint64_t bar()\r\n{\r\n    PROXY(p, global_nums);\r\n    int64_t j = 0;\r\n    for (auto i : *p) { j += i; }\r\n    return j + lock_already_held(p);\r\n}\r\n```\r\n\r\nThat:\r\n\r\n * gives compile time errors if you try accessing without a lock\r\n * doesn't require recursive locks\r\n * gives clang compile time errors if you try double locking\r\n\r\nwhich hits everything I wanted, and doesn't even seem too klunky. Perhaps needs some additional work to handle `const`.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-29T18:48:14Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983913168",
      "id" : 983913168,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846pVLQ",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1125836760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983913168/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T18:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983913168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r984000714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984000714"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re; https://github.com/bitcoin/bitcoin/pull/25390#discussion_r983913168\r\n\r\nThis suggestion seems very good. I'm still not sure how broadly useful this locking container would be, but I agree having recursive mutex semantics (however they are implemented) would make using it less safe, so better to avoid that if possible.\r\n\r\nAbout the `Guarded`/`PROXY` suggestion specifically:\r\n\r\n- I wonder if `PROXY` macro is necessary. Could `Guarded` class just have a `auto Lock() { return Proxy{*this}; }` method instead? It seems like that could work just as well in a `for` loop or `auto nums = global_nums->Lock()` statement.\r\n- Maybe rename `s/PROXY/GUARDED_LOCK/` so macro name and class name match. This would also be more consistent with other locking macro names `WAIT_LOCK` and `TRY_LOCK` \r\n- Maybe switch `PROXY(name, guarded)` argument order for consistency with `WAIT_LOCK` and `TRY_LOCK` where the new variable name argument is last, and the existing mutex argument is first.\r\n",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-29T20:35:14Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r984000714",
      "id" : 984000714,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846pqjK",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1125965581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984000714/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T20:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984000714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r984106710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984106710"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the macro is necessary -- otherwise `return Proxy{*this}` means you have to annotate the `Proxy(Proxy&&)` move constructor, but the only thing you can annotate that with is locking its internal reference to `g.m` but that then creates an alias of the mutex which prevents clang from detecting when double locking is happening since clang can't tell that two different invocations are locking aliases of the same lock.\r\n\r\nChanging the name and the argument order makes lots of sense, I just posted it as soon as I found something that worked. `Guarded<T>` probably isn't a great name either. (I think it makes sense for `Proxy` to match whatever the macro is named)",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-09-30T00:01:59Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r984106710",
      "id" : 984106710,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846qEbW",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1126113893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984106710/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T00:01:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984106710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r985802251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985802251"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about this:\r\n\r\n```cpp\r\ntemplate <typename T>\r\nclass Synced\r\n{\r\npublic:\r\n    template <typename... Args>\r\n    Synced(Args... args) : m_obj{args...}\r\n    {\r\n    }\r\n\r\n    class SCOPED_LOCKABLE Proxy : ::UniqueLock<Mutex>\r\n    {\r\n    public:\r\n        Proxy(Synced& parent) EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\r\n            : ::UniqueLock<Mutex>{parent.m_mutex, \"...\", \"...\", 123}, m_parent{parent}\r\n        {\r\n        }\r\n\r\n        ~Proxy() UNLOCK_FUNCTION() {}\r\n\r\n        T& operator*()\r\n        {\r\n            return m_parent.m_obj;\r\n        }\r\n\r\n        T* operator->()\r\n        {\r\n            return &m_parent.m_obj;\r\n        }\r\n\r\n    private:\r\n        Synced& m_parent;\r\n    };\r\n\r\nprivate:\r\n    mutable Mutex m_mutex;\r\n    T m_obj GUARDED_BY(m_mutex);\r\n};\r\n\r\n#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced}\r\n```\r\n\r\nWith example usage:\r\n\r\n```cpp\r\nSynced<std::vector<int>> synced{1, 2, 3, 4};\r\n\r\n{\r\n    SYNCED_LOCK(synced, p);\r\n\r\n    p->push_back(5);\r\n}\r\n\r\n{\r\n    SYNCED_LOCK(synced, p);\r\n\r\n    std::cout << (*p)[0] << std::endl;\r\n\r\n    for (auto& i : *p) {\r\n        std::cout << i << std::endl;\r\n    }\r\n}\r\n```\r\n\r\nWe lose the sweet syntax:\r\n\r\n```cpp\r\nSynced<std::vector<int>> synced{1, 2, 3, 4};\r\n\r\nsynced->push_back(5);\r\n```\r\n\r\ncompared to the other variants, but this would still offer simplifications in higher level code and if you are ok with it, then I am fine.\r\n",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-03T13:46:53Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r985802251",
      "id" : 985802251,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846wiYL",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1128402641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985802251/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-03T13:51:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985802251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986153213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986153213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure what the differences are between you're quoting above vs what I suggested? They currently look pretty much the same to me? (I was going to check that `begin`/`end`/`op[]` didn't create double locking issues, but you've gotten rid of them already)\r\n\r\nI think it'd be worth adding `LIFETIMEBOUND` annotations (from attributes.h) as well. Perhaps you should delete the move constructor for `Synced`?\r\n\r\nI agree `synced->push_back(5)` is pretty, but it seems likely to be bug prone to me: consider `it = synced_map->find(key)` -- the lock will be released as soon as the iterator is returned, allowing `it` to be immediately invalidated. So I kind of think we should just count ourselves lucky that we can't make it work and callers have to be explicit about the lock scope...",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-03T19:37:33Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986153213",
      "id" : 986153213,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846x4D9",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1128915124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986153213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-03T19:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986153213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986156191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986156191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It might be nice to have a `ConstProxy` variant too, so that if you have a `const` reference to an object containing a `Synced<foo>` you can still access have synced access to the object as `const foo`. On the other hand, maybe better to worry about that when an actual use comes up.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-03T19:41:27Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986156191",
      "id" : 986156191,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846x4yf",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1128919465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986156191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-03T19:41:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986156191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986218855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986218855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`Proxy : ::UniqueLock<Mutex>` -- isn't it better to say `private` explicitly? (Guess who just assumed it defaulted to `public` until the compiler told him otherwise...)",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-03T20:52:05Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986218855",
      "id" : 986218855,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846yIFn",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1129009189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986218855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-03T20:52:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986218855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986548377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986548377"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I'm not sure what the differences are between you're quoting above vs what I suggested?\r\n\r\nYes, they are pretty much the same. The question was maybe more directed to @ryanofsky - if he is ok with that. I want to avoid pushing another iteration of this PR and it to be shot by somebody shortly after :) If you both agree on the above, then lets do that!\r\n\r\nTo-polish: LIFETIMEBOUND, delete the Synced move constructor, consider const, explicit inheritance type.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-04T07:59:19Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r986548377",
      "id" : 986548377,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII5846zYiZ",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1129459998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986548377/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-04T07:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/986548377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r987678673"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987678673"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you made `m_obj` and `m_mutex` be protected instead of private, that would allow you to write:\r\n\r\n```c++\r\nclass MyFoo : public Synced<foo>\r\n{\r\npublic:\r\n    int pretty() EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return m_obj.pretty(); }\r\n};\r\n```\r\n\r\nand then do `i = myfoo.pretty();` -- gets you the same end result as the `synced->pretty()` stuff, but only for things you explicitly add a wrapper for, which at least also gives you a chance to make sure it's actually safe to be used in isolation?",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-05T08:43:45Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r987678673",
      "id" : 987678673,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII58463sfR",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1131084530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987678673/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-05T08:44:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987678673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r987701975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987701975"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, I wouldn't add features that are not used anywhere, but `s/private/protected` is not actually more code. Makes sense if somebody wants to inherit it and do more involved things.\r\n\r\nTo-polish: LIFETIMEBOUND, delete the Synced move constructor, consider const, explicit inheritance type, protected `m_mutex` and `m_obj`.\r\n\r\n@ryanofsky, what do you think?",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-05T09:09:05Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r987701975",
      "id" : 987701975,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII58463yLX",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1131117742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987701975/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-05T09:09:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/987701975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r988059337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988059337"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> To-polish: LIFETIMEBOUND, delete the Synced move constructor, consider const, explicit inheritance type, protected `m_mutex` and `m_obj`.\r\n> \r\n> @ryanofsky, what do you think?\r\n\r\nAll of these tweaks sound good to me.\r\n\r\nGenerally speaking about the PR as a whole, I'm skeptical the `Synced` class will be broadly useful, but I think it's a simple enough utility that can be used in a few places without many drawbacks, and that it's worth experimenting with. I was more interested in the class previously when I thought it was a locking pointer enforcing use of an external mutex (that could be used to migrate code away from using `cs_main`), than a locking container that just used an internal mutex. But it seems like a good thing to use in places where it fits.",
      "commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "created_at" : "2022-10-05T15:26:01Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r988059337",
      "id" : 988059337,
      "in_reply_to_id" : 978269158,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII58465JbJ",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 95,
      "pull_request_review_id" : 1131632960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988059337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-05T15:27:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988059337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-10-11T03:08:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1274029456",
      "id" : 1274029456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585L8CWQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274029456/reactions"
      },
      "updated_at" : "2022-10-11T03:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274029456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`11ac578f91...70dac32e76`: rebase due to conflicts + update as per the discussion in https://github.com/bitcoin/bitcoin/pull/25390#discussion_r978269158\r\n",
      "created_at" : "2022-10-12T09:50:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1275894327",
      "id" : 1275894327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585MDJo3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1275894327/reactions"
      },
      "updated_at" : "2022-10-12T09:50:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1275894327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r993246868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993246868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done - in the latest incarnation no double locking is allowed.",
      "commit_id" : "70dac32e76dc87d87d0d23f2da0ff5532d5bf040",
      "created_at" : "2022-10-12T09:51:05Z",
      "diff_hunk" : "@@ -400,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r993246868",
      "id" : 993246868,
      "in_reply_to_id" : 982661098,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847M76U",
      "original_commit_id" : "11ac578f9132ed76191d03d5100fc88b6ada6a8a",
      "original_line" : 432,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1138790112,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993246868/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-12T09:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993246868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r993256070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993256070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated, I only left the `const` stuff away, since it is not needed now and can be added later if needed.\r\n\r\nFor the usefulness of the `Synced` class, see the OP, I updated it with some of the benefits.",
      "commit_id" : "70dac32e76dc87d87d0d23f2da0ff5532d5bf040",
      "created_at" : "2022-10-12T10:00:23Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r993256070",
      "id" : 993256070,
      "in_reply_to_id" : 978269158,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847M-KG",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1138803669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993256070/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-12T10:22:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993256070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r997762368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997762368"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, when used with shared locks, it seems like clang's thread safety analysis doesn't actually prevent you from calling non-const member functions of a `GUARDED_BY` object when only holding the lock in shared mode (it does prevent you from doing `a = b`, just not `a.set(b)`). So if you take a shared lock over a vector, then resize it and invalidate everyone elses iterators, clang thinks it's all fine.\r\n\r\nWhich I think means that if we wanted to do shared locking more broadly, then this method might be the safest way we have of it: ie have `SYNCED_SHARED(foo,  fooproxy)` take a shared lock and have `*fooproxy` give a `const Foo&` so you can't accidently modify `foo` while you're potentially sharing it with other threads.\r\n\r\nEDIT: for possible future reference, just doing this looks like it works sensibly:\r\n\r\n```c++\r\nclass Synced\r\n{\r\n...\r\n    class SCOPED_LOCKABLE ConstProxy : public ::UniqueLock<Mutex>\r\n    {\r\n    public:\r\n        ConstProxy(const Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\r\n            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\r\n            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\r\n        {\r\n        }\r\n\r\n        ~ConstProxy() UNLOCK_FUNCTION() {}\r\n\r\n        const T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\r\n\r\n        const T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\r\n\r\n    private:\r\n        const Synced& m_parent;\r\n    };\r\n...\r\n};\r\n\r\n#define SYNCED_SHARED(synced, name) decltype(synced)::ConstProxy name{synced, #synced, __FILE__, __LINE__}\r\n```\r\n\r\nTweaking that to use a `std::shared_lock` instead of `unique_lock` and marking it as `SHARED_LOCK_FUNCTION` instead of exclusive would let us use shared locks pretty easily and safely, I think.\r\n",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-10-18T06:21:09Z",
      "diff_hunk" : "@@ -398,4 +398,104 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access.\n+ * For example, the following is safe:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * // v is locked for the entire duration of the loop\n+ * for (auto& i : *v) {\n+ *     i *= 10;\n+ * }\n+ *\n+ * {\n+ *     LOCK(v);\n+ *     size_t size = v->size();\n+ *     // The container will not be changed by another thread between the two size() calls.\n+ *     assert(size == v->size());\n+ * }\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced : public RecursiveMutex\n+{\n+public:\n+    /**\n+     * Construct the smart container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class Proxy : ::UniqueLock<RecursiveMutex>\n+    {\n+    public:\n+        Proxy(Synced& parent, const char* mutex_name, const char* file_name, int line)\n+            : ::UniqueLock<RecursiveMutex>{parent, mutex_name, file_name, line},\n+              m_obj_ref{parent.m_obj}\n+        {\n+        }\n+\n+        T* operator->() { return &m_obj_ref; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return m_obj_ref[key];\n+        }\n+\n+        auto begin() { return m_obj_ref.begin(); }\n+\n+        auto end() { return m_obj_ref.end(); }\n+\n+    private:\n+        T& m_obj_ref;\n+    };\n+\n+    /**\n+     * Access `m_obj`, holding `this` locked for the duration of the access.\n+     * This causes a chain of `operator->()` calls:\n+     * 1. `Synced::operator->()` is called, which returns `Proxy` (the\n+     * constructor of `Proxy` locks `this`), then\n+     * 2. `Proxy::operator->()` is called, which returns a raw pointer to\n+     * `m_obj` which is dereferenced in order to call the relevant method.\n+     */\n+    Proxy operator->()\n+    {\n+        return Proxy{*this, \"Synced::operator->()\", __FILE__, __LINE__};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r997762368",
      "id" : 997762368,
      "in_reply_to_id" : 978269158,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847eKVA",
      "original_commit_id" : "bca6b06341b089c89fbd5647fdc868258b8c9d5a",
      "original_line" : 483,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1145151729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997762368/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:35:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997762368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998159732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998159732"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems clearer to write that as two lines (`SYNCED_LOCK(); return ..`) to me.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-10-18T12:44:56Z",
      "diff_hunk" : "@@ -325,14 +330,17 @@ void SetReachable(enum Network net, bool reachable)\n {\n     if (net == NET_UNROUTABLE || net == NET_INTERNAL)\n         return;\n-    LOCK(g_maplocalhost_mutex);\n-    vfLimited[net] = !reachable;\n+    SYNCED_LOCK(g_reachable_networks, p);\n+    if (reachable) {\n+        p->insert(net);\n+    } else {\n+        p->erase(net);\n+    }\n }\n \n bool IsReachable(enum Network net)\n {\n-    LOCK(g_maplocalhost_mutex);\n-    return !vfLimited[net];\n+    return WITH_SYNCED_LOCK(g_reachable_networks, p, return p->count(net) > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998159732",
      "id" : 998159732,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847frV0",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 343,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1145740612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998159732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T08:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998159732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998164319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998164319"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder if hardcoding the proxy name would be better; something like:\r\n\r\n```c++\r\n#define SYNCED_LOCK(synced) decltype(synced)::Proxy synced##_proxy{synced, #synced, __FILE__, __LINE__}\r\n``` \r\n\r\nthen you write `SYNCED_LOCK(foo); foo_proxy->bar()` and don't have to choose a name, and don't have to worry about remembering what `p` was a proxy for.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-10-18T12:48:54Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { SYNCED_LOCK(v, p); p->push_back(7); }};\n+ * std::thread t2{[&v]() { SYNCED_LOCK(v, p); p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, p);\n+ * const size_t size = p->size();\n+ * for (auto& i : *p) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == p->size());\n+ *\n+ * std::cout << (*p)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998164319",
      "id" : 998164319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fsdf",
      "original_commit_id" : "c6f1d58b0489c733b6029cca9a70606145155b32",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1145740612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998164319/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T08:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998164319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998202653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998202653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changing this from a bool array to an unordered set seems surprising, and inverting the logic means introducing an extra place that has to be modified when adding new nets. Wouldn't `Synced<std::bitset<NET_MAX>> g_limited_networks` make more sense?",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-10-18T13:14:38Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998202653",
      "id" : 998202653,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5847f10d",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 125,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 1145740612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998202653/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T08:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998202653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998213646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998213646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "An alternative approach to splitting these two entries between separate mutexes would be to create an additional struct:\r\n\r\n```c++\r\nstruct NetworkReachability\r\n{\r\n    std::map<CNetAddr, LocalServiceInfo> local_addrs;\r\n    std::set<Network> reachable_nets;\r\n};\r\nSynced<NetworkReachability> g_network_reachability;\r\n```\r\n\r\nand then `SYNCED_LOCK(g_network_reachability, p);` lets you access `p->local_addrs` or `p->reachable_nets`. Hard to see it making much practical difference here either way though.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-10-18T13:21:56Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998213646",
      "id" : 998213646,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII5847f4gO",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 126,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 31,
      "pull_request_review_id" : 1145740612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998213646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T08:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998213646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`70dac32e76...c3e4c34219`: rebase and address suggestions",
      "created_at" : "2022-11-02T13:08:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1300379783",
      "id" : 1300379783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585NgjiH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1300379783/reactions"
      },
      "updated_at" : "2022-11-02T13:08:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1300379783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011738259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011738259"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T13:08:53Z",
      "diff_hunk" : "@@ -325,14 +330,17 @@ void SetReachable(enum Network net, bool reachable)\n {\n     if (net == NET_UNROUTABLE || net == NET_INTERNAL)\n         return;\n-    LOCK(g_maplocalhost_mutex);\n-    vfLimited[net] = !reachable;\n+    SYNCED_LOCK(g_reachable_networks, p);\n+    if (reachable) {\n+        p->insert(net);\n+    } else {\n+        p->erase(net);\n+    }\n }\n \n bool IsReachable(enum Network net)\n {\n-    LOCK(g_maplocalhost_mutex);\n-    return !vfLimited[net];\n+    return WITH_SYNCED_LOCK(g_reachable_networks, p, return p->count(net) > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011738259",
      "id" : 1011738259,
      "in_reply_to_id" : 998159732,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848TeaT",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 343,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1165214971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011738259/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T13:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011738259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011742090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011742090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sometimes the hardcoded name could become too long/verbose for a too short scope: e.g. `g_reachable_networks_proxy` or `g_reachable_networks_locked` when it is just used on the line below and nowhere else.\r\n\r\nI added now the possibility to call `SYNCED_LOCK()` with 1 or 2 arguments and opted for a `_locked` suffix instead of `_proxy` for the 1-arg case. So the callers have complete flexibility on how to call it.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T13:11:43Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { SYNCED_LOCK(v, p); p->push_back(7); }};\n+ * std::thread t2{[&v]() { SYNCED_LOCK(v, p); p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, p);\n+ * const size_t size = p->size();\n+ * for (auto& i : *p) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == p->size());\n+ *\n+ * std::cout << (*p)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011742090",
      "id" : 1011742090,
      "in_reply_to_id" : 998164319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848TfWK",
      "original_commit_id" : "c6f1d58b0489c733b6029cca9a70606145155b32",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1165219536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011742090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T13:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011742090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011743933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011743933"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My reasoning is that the most natural way to express this is to have a list of networks that are reachable (or unreachable if the logic is to be inverted) and `std::set` is the best way to do that. Having an array of `bool`s is a bit hackish as it requires that all enums are sequential and start at `0` and requires the existence of `NET_MAX` which smells bad. My plan is to remove `NET_MAX`. Ideally, enum lables should be used without depending on their specific integer values.\r\n\r\nAnyway, if this is controveral I will ditch that change and leave it as `vfLimited[NET_MAX]` since it is not the main topic of this PR. Should I?",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T13:13:04Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011743933",
      "id" : 1011743933,
      "in_reply_to_id" : 998202653,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5848Tfy9",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 125,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 1165221632,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011743933/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T13:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011743933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011745178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011745178"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> ... separate mutexes ...\r\n\r\nWhat you propose will use just one mutex? Anyway, the list of reachable networks is unrelated to the list of local addresses. I do not think they should be grouped into one `struct` or protected by the same mutex.\r\n",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T13:13:59Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011745178",
      "id" : 1011745178,
      "in_reply_to_id" : 998213646,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII5848TgGa",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 126,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 31,
      "pull_request_review_id" : 1165223092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011745178/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T13:13:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011745178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011820462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011820462"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That does not compile on windows: https://cirrus-ci.com/task/4559637407072256?logs=build#L814 :-/\r\n\r\nIf you are ok with this, I will fall back to the 2-arg macro. Then the caller can pick the name depending on their preferences - `p`, `foo_proxy`, `foo_locked` or whatever.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T14:06:32Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { SYNCED_LOCK(v, p); p->push_back(7); }};\n+ * std::thread t2{[&v]() { SYNCED_LOCK(v, p); p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, p);\n+ * const size_t size = p->size();\n+ * for (auto& i : *p) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == p->size());\n+ *\n+ * std::cout << (*p)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1011820462",
      "id" : 1011820462,
      "in_reply_to_id" : 998164319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848Tyeu",
      "original_commit_id" : "c6f1d58b0489c733b6029cca9a70606145155b32",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1165317969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011820462/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T14:06:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1011820462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1012389456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012389456"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, it was an \"alternative .. to .. separate mutexes\". Mostly intended to show using this pattern doesn't require moving everything to a dedicated mutex if that's not desired. In this case, like I said \"hard to see it making much practical difference\" though.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-02T23:50:53Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1012389456",
      "id" : 1012389456,
      "in_reply_to_id" : 998213646,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII5848V9ZQ",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 126,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 31,
      "pull_request_review_id" : 1166137516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012389456/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T23:50:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012389456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1012393276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012393276"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you want naming it to be optional, probably better to have different macros, same as `LOCK(m)` and `WAIT_LOCK(m,g)`. I'm not really sure what I prefer here.",
      "commit_id" : "c3e4c34219264ad0676977c1de02f5da2af30c59",
      "created_at" : "2022-11-03T00:00:19Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { SYNCED_LOCK(v, p); p->push_back(7); }};\n+ * std::thread t2{[&v]() { SYNCED_LOCK(v, p); p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, p);\n+ * const size_t size = p->size();\n+ * for (auto& i : *p) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == p->size());\n+ *\n+ * std::cout << (*p)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1012393276",
      "id" : 1012393276,
      "in_reply_to_id" : 998164319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848V-U8",
      "original_commit_id" : "c6f1d58b0489c733b6029cca9a70606145155b32",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1166142677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012393276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T00:00:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012393276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`c3e4c34219...0f457d2bdd`: rebase and go back to a single macro `SYNCED_LOCK()` with 2 arguments.",
      "created_at" : "2022-11-08T13:08:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1307191594",
      "id" : 1307191594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585N6ikq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307191594/reactions"
      },
      "updated_at" : "2022-11-08T13:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307191594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1016616242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016616242"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, I am leaving it as it is and marking this as resolved. I think it is natural to guard unrelated things with separate mutexes.",
      "commit_id" : "0f457d2bdde73a245e732b6d0c4d174867590d17",
      "created_at" : "2022-11-08T13:12:33Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1016616242",
      "id" : 1016616242,
      "in_reply_to_id" : 998213646,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII5848mFUy",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 126,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 31,
      "pull_request_review_id" : 1172097338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016616242/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T13:12:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016616242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1016618877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016618877"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I went back to what it was before - `SYNCED_LOCK(object, name)`. The 1-arg macro was used in just one place and it did not compile on windows, not worth it. By selecting the name the caller can choose whether to use a short one for small scopes of a few lines, or a longer and more descriptive one for bigger scopes.",
      "commit_id" : "0f457d2bdde73a245e732b6d0c4d174867590d17",
      "created_at" : "2022-11-08T13:15:05Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { SYNCED_LOCK(v, p); p->push_back(7); }};\n+ * std::thread t2{[&v]() { SYNCED_LOCK(v, p); p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, p);\n+ * const size_t size = p->size();\n+ * for (auto& i : *p) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == p->size());\n+ *\n+ * std::cout << (*p)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1016618877",
      "id" : 1016618877,
      "in_reply_to_id" : 998164319,
      "line" : 466,
      "node_id" : "PRRC_kwDOABII5848mF99",
      "original_commit_id" : "c6f1d58b0489c733b6029cca9a70606145155b32",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 77,
      "pull_request_review_id" : 1172101345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016618877/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T13:15:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016618877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`0f457d2bdd...6c0bcd0928`: update comment",
      "created_at" : "2022-11-08T16:34:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1307499020",
      "id" : 1307499020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585N7toM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307499020/reactions"
      },
      "updated_at" : "2022-11-08T16:34:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307499020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1017546338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017546338"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "enums are sequential and automatically start at 0; and `NET_MAX` is added for precisely that purpose. That's the way these things are designed to be used, it's not hackish or a bad smell...",
      "commit_id" : "6c0bcd0928f16ff6bcd6d0943656b5fd1d36665a",
      "created_at" : "2022-11-09T07:48:35Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1017546338",
      "id" : 1017546338,
      "in_reply_to_id" : 998202653,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5848poZi",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 125,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 1173494530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017546338/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-09T07:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017546338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1020279585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020279585"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I disagree, but that discussion is for another PR. I reverted it back to what it is in `master` - an array of `bool`s.",
      "commit_id" : "f8f7e62f8167c1ca9214710aca6e39e601d21b00",
      "created_at" : "2022-11-11T14:43:04Z",
      "diff_hunk" : "@@ -115,7 +117,10 @@ bool fDiscover = true;\n bool fListen = true;\n GlobalMutex g_maplocalhost_mutex;\n std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+static Synced<std::unordered_set<Network>> g_reachable_networks{\n+    NET_UNROUTABLE, NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS, NET_INTERNAL};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1020279585",
      "id" : 1020279585,
      "in_reply_to_id" : 998202653,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58480Dsh",
      "original_commit_id" : "121bee1947f86ebab858cf016ae28ae6c11663ab",
      "original_line" : 125,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1177431099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020279585/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-11T14:43:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020279585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`6c0bcd0928...f8f7e62f81`: don't change the type of the variable that holds the list of reachable networks (an array of `bool`s), see https://github.com/bitcoin/bitcoin/pull/25390#discussion_r998202653",
      "created_at" : "2022-11-11T14:45:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1311779599",
      "id" : 1311779599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585OMCsP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1311779599/reactions"
      },
      "updated_at" : "2022-11-11T14:45:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1311779599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-01-30T19:15:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1409196552",
      "id" : 1409196552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585T_qII",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1409196552/reactions"
      },
      "updated_at" : "2023-01-30T19:15:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1409196552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`f8f7e62f81...3db109e794`: rebase due to conflicts\r\n\r\n@ajtowns, I think I addressed all your suggestions?",
      "created_at" : "2023-02-01T15:04:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1412208407",
      "id" : 1412208407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585ULJcX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412208407/reactions"
      },
      "updated_at" : "2023-02-01T15:04:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412208407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-17T19:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1435123287",
      "id" : 1435123287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585Vij5X",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435123287/reactions"
      },
      "updated_at" : "2023-02-17T19:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435123287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`3db109e794...e42ce20c65`: rebase due to conflicts",
      "created_at" : "2023-02-24T14:09:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1443734529",
      "id" : 1443734529,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585WDaQB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1443734529/reactions"
      },
      "updated_at" : "2023-02-24T14:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1443734529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-04-03T14:05:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1494388560",
      "id" : 1494388560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585ZEo9Q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1494388560/reactions"
      },
      "updated_at" : "2023-04-03T14:05:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1494388560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`e42ce20c65...ebfe47e594`: rebase due to conflicts",
      "created_at" : "2023-04-07T16:21:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1500433830",
      "id" : 1500433830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585Zbs2m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500433830/reactions"
      },
      "updated_at" : "2023-04-07T16:21:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500433830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Light Approach ACK after reading the code and the excellent review discussions. It looks like this has been progressively honed and improved quite a bit. Will test and review.",
      "created_at" : "2023-04-18T15:17:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1513345887",
      "id" : 1513345887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585aM9Nf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1513345887/reactions"
      },
      "updated_at" : "2023-04-18T15:17:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1513345887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170236041"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170236041"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "a49907318fff6d Naming nit, would this be better plural i.e. `g_my_net_addrs`, `g_local_addrs` or `g_my_local_addrs`?",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-18T15:46:01Z",
      "diff_hunk" : "@@ -115,9 +116,14 @@ static const uint64_t RANDOMIZER_ID_ADDRCACHE = 0x1cf2e4ddd306dda9ULL; // SHA256\n //\n bool fDiscover = true;\n bool fListen = true;\n-GlobalMutex g_maplocalhost_mutex;\n-std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(g_maplocalhost_mutex);\n-static bool vfLimited[NET_MAX] GUARDED_BY(g_maplocalhost_mutex) = {};\n+\n+/**\n+ * The local network addresses of this node.\n+ */\n+Synced<std::map<CNetAddr, LocalServiceInfo>> g_my_net_addr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170236041",
      "id" : 1170236041,
      "line" : 123,
      "node_id" : "PRRC_kwDOABII585FwGKJ",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 123,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 1390434676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170236041/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T16:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170236041",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170240470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170240470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Style nit, unsure, would it be a good idea to use named args in the `WITH_SYNCED_LOCK` and `SYNCED_LOCK` calls? More verbose but more clear, though it's not too non-intuitive.\r\n\r\n```suggestion\r\n    WITH_SYNCED_LOCK(g_my_net_addr, /*name=*/p, /*code=*/p->erase(addr));\r\n```",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-18T15:48:44Z",
      "diff_hunk" : "@@ -318,23 +323,20 @@ bool AddLocal(const CNetAddr &addr, int nScore)\n \n void RemoveLocal(const CService& addr)\n {\n-    LOCK(g_maplocalhost_mutex);\n     LogPrintf(\"RemoveLocal(%s)\\n\", addr.ToStringAddrPort());\n-    mapLocalHost.erase(addr);\n+    WITH_SYNCED_LOCK(g_my_net_addr, p, p->erase(addr));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170240470",
      "id" : 1170240470,
      "line" : 327,
      "node_id" : "PRRC_kwDOABII585FwHPW",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 327,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 1390434676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170240470/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T16:22:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170240470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170242796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170242796"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice cleanup.",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-18T15:50:07Z",
      "diff_hunk" : "@@ -660,13 +660,12 @@ static RPCHelpMan getnetworkinfo()\n     }\n     UniValue localAddresses(UniValue::VARR);\n     {\n-        LOCK(g_maplocalhost_mutex);\n-        for (const std::pair<const CNetAddr, LocalServiceInfo> &item : mapLocalHost)\n-        {\n+        SYNCED_LOCK(g_my_net_addr, p);\n+        for (const auto& [addr, service_info] : *p) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170242796",
      "id" : 1170242796,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII585FwHzs",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 664,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 8,
      "pull_request_review_id" : 1390434676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170242796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T16:09:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170242796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170250884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170250884"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "373df61bc56 Style nit, unsure, would something like `local_instance` or `local_name` read better than `name` if callers use named args? Feel free to ignore.",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-18T15:54:57Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { WITH_SYNCED_LOCK(v, p, p->push_back(7); }};\n+ * std::thread t2{[&v]() { WITH_SYNCED_LOCK(v, p, p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, v_locked);\n+ * const size_t size = v_locked->size();\n+ * for (auto& i : *v_locked) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == v_locked->size());\n+ *\n+ * std::cout << (*v_locked)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170250884",
      "id" : 1170250884,
      "line" : 466,
      "node_id" : "PRRC_kwDOABII585FwJyE",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 77,
      "pull_request_review_id" : 1390434676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170250884/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T16:09:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170250884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170892009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170892009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that's a bit too verbose.",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-19T07:02:21Z",
      "diff_hunk" : "@@ -318,23 +323,20 @@ bool AddLocal(const CNetAddr &addr, int nScore)\n \n void RemoveLocal(const CService& addr)\n {\n-    LOCK(g_maplocalhost_mutex);\n     LogPrintf(\"RemoveLocal(%s)\\n\", addr.ToStringAddrPort());\n-    mapLocalHost.erase(addr);\n+    WITH_SYNCED_LOCK(g_my_net_addr, p, p->erase(addr));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170892009",
      "id" : 1170892009,
      "in_reply_to_id" : 1170240470,
      "line" : 327,
      "node_id" : "PRRC_kwDOABII585FymTp",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 327,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 1391381278,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170892009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T07:02:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170892009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170894501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170894501"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Named args at call sites look too verbose to me and here a short `name` is ok because the scope if very limited - only used on one line.",
      "commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "created_at" : "2023-04-19T07:05:09Z",
      "diff_hunk" : "@@ -397,4 +398,77 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A generic container that protects an owned object with a mutex.\n+ * This is like a mutex with an extension - owning an object of arbitrary type\n+ * and providing a dereference operation which gives access to the owned object\n+ * and transparently locks the mutex for the duration of the access. For example:\n+ *\n+ * @code{.cpp}\n+ * Synced<std::vector<int>> v{4, 5, 6};\n+ *\n+ * std::thread t1{[&v]() { WITH_SYNCED_LOCK(v, p, p->push_back(7); }};\n+ * std::thread t2{[&v]() { WITH_SYNCED_LOCK(v, p, p->push_back(8); }};\n+ *\n+ * SYNCED_LOCK(v, v_locked);\n+ * const size_t size = v_locked->size();\n+ * for (auto& i : *v_locked) {\n+ *     i *= 10;\n+ * }\n+ * // The container will not be changed by another thread between the two size() calls.\n+ * assert(size == v_locked->size());\n+ *\n+ * std::cout << (*v_locked)[0] << std::endl;\n+ *\n+ * @endcode\n+ */\n+template <typename T>\n+class Synced\n+{\n+public:\n+    /**\n+     * Construct the container and its internal object of type T,\n+     * passing `args...` to T's constructor.\n+     */\n+    template <typename... Args>\n+    Synced(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds the parent locked for the duration of its\n+     * lifetime and provides access to the internal object.\n+     */\n+    class SCOPED_LOCKABLE Proxy : public ::UniqueLock<Mutex>\n+    {\n+    public:\n+        Proxy(Synced& parent LIFETIMEBOUND, const char* name, const char* file, int line)\n+            EXCLUSIVE_LOCK_FUNCTION(parent.m_mutex)\n+            : ::UniqueLock<Mutex>{parent.m_mutex, name, file, line}, m_parent{parent}\n+        {\n+        }\n+\n+        ~Proxy() UNLOCK_FUNCTION() {}\n+\n+        T& operator*() LIFETIMEBOUND { return m_parent.m_obj; }\n+\n+        T* operator->() LIFETIMEBOUND { return &m_parent.m_obj; }\n+\n+    private:\n+        Synced& m_parent;\n+    };\n+\n+protected:\n+    mutable Mutex m_mutex;\n+    T m_obj GUARDED_BY(m_mutex);\n+};\n+\n+#define SYNCED_LOCK(synced, name) decltype(synced)::Proxy name{synced, #synced, __FILE__, __LINE__}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r1170894501",
      "id" : 1170894501,
      "in_reply_to_id" : 1170250884,
      "line" : 466,
      "node_id" : "PRRC_kwDOABII585Fym6l",
      "original_commit_id" : "ebfe47e5942fa5e0ce21b44511258b6dfa4cf621",
      "original_line" : 466,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 77,
      "pull_request_review_id" : 1391385235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170894501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T07:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170894501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ~0. While the first commit introduces new code in `sync.h` that needs maintaining and unit test coverage, the following commits do not demonstrate convincing reasons for it.\r\n\r\n> but it is possible to abuse the mutex and start using it to protect some more, possibly unrelated stuff (we already have this in the current code).\r\n\r\nConcept ACK on improving this.",
      "created_at" : "2023-05-22T15:26:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1557425242",
      "id" : 1557425242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585c1Gxa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1557425242/reactions"
      },
      "updated_at" : "2023-05-22T15:26:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1557425242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-13T19:32:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1634795089",
      "id" : 1634795089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585hcP5R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1634795089/reactions"
      },
      "updated_at" : "2023-07-13T19:32:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1634795089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`ebfe47e594...38c0d628e0`: rebase due to conflicts\r\n\r\n@hebasto, if the purpose of the low level code is to make the higher level code more robust and less bug-prone, then I think `Synced` achieves this. The pattern:\r\n\r\n```cpp\r\nMutex m;\r\nType my_variable GUARDED_BY(m);\r\n```\r\n\r\nis very common. The `Synced` structure encapsulates both, enforces the idiom and makes it impossible to \"to abuse the mutex and start using it to protect some more, possibly unrelated stuff\".\r\n\r\nIt also helps remove `GlobalMutex` usages. `GlobalMutex` could be [confusing](https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1259704670).",
      "created_at" : "2023-07-19T15:11:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1642275801",
      "id" : 1642275801,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585h4yPZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1642275801/reactions"
      },
      "updated_at" : "2023-07-19T15:11:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1642275801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-21T17:29:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1730010857",
      "id" : 1730010857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585nHd7p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1730010857/reactions"
      },
      "updated_at" : "2023-09-21T17:29:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1730010857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`38c0d628e0...b749c4d2ca`: rebase due to conflicts",
      "created_at" : "2023-10-05T13:38:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1748920813",
      "id" : 1748920813,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585oPmnt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1748920813/reactions"
      },
      "updated_at" : "2023-10-05T13:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1748920813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-19T18:36:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1771517511",
      "id" : 1771517511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585plzZH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771517511/reactions"
      },
      "updated_at" : "2023-10-19T18:36:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771517511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`b749c4d2ca...92a444d0d7`: rebase due to conflicts, drop commit 93e60b9a0c3ee44fbf1f64c91e908c3e507d1d7f `net: detach vfLimited from g_maplocalhost_mutex` because `vfLimited` + `SetReachable()` have already been encapsulated (see 6e308651c441cbf8763c67cc099c538c333c2872 from #27071).",
      "created_at" : "2023-10-23T12:21:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1775072072",
      "id" : 1775072072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585pzXNI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1775072072/reactions"
      },
      "updated_at" : "2023-10-23T12:21:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1775072072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-12-13T11:20:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1853732117",
      "id" : 1853732117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585ufbUV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853732117/reactions"
      },
      "updated_at" : "2023-12-13T11:20:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853732117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`92a444d0d7...f3489638dc`: rebase due to conflicts",
      "created_at" : "2023-12-13T14:35:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1854032522",
      "id" : 1854032522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585ugkqK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1854032522/reactions"
      },
      "updated_at" : "2023-12-13T14:35:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1854032522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
