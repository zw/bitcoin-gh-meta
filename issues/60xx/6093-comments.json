[
   {
      "body" : "Good catch. I already fixed this once before, people really shouldn't be touching this 'magic' code. Maybe add a comment referring to the issue.",
      "created_at" : "2015-05-01T12:15:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98120925",
      "id" : 98120925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T12:15:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98120925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "This will likely bring back issue #3136 (solved by #5877). You should imbue *some* locale on WIN32, I'm not sure which one, but indeed `C` is wrong.\r\nMaybe the result of `std::locale(\"\")`? what does boost lazily initialize it to?",
      "created_at" : "2015-05-01T12:21:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98122033",
      "id" : 98122033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T12:28:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98122033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Right. This is not the right approach.\r\nWas trying to go down the rabbit hole of win/unicode handling...\r\nCan't find a solution. It seems that it could also be a compiler wchar issue.\r\nIt looks like that the default locale is `C`?\r\n\r\nI could also guess that it might be connected to https://github.com/bitcoin/bitcoin/blob/master/src/util.cpp#L672 `SHGetSpecialFolderPathA`. The A stands for ANSI. There is also a SHGetSpecialFolderPathW equivalent which supports WCHAR.",
      "created_at" : "2015-05-01T13:03:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98128744",
      "id" : 98128744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98128744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "In windows the file system locale depends on the user locale. I think it only works if boost uses the same locale as windows. But I'm not sure anymore how this was determined. I got it to work once, hence it worked in 0.10...\r\n(using the W* functions is out of the question unless you use them *everywhere* and that'd involve a lot of platform specific code as well as widechar to UTF-8 conversion)\r\n",
      "created_at" : "2015-05-01T13:48:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98138377",
      "id" : 98138377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:48:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98138377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@jonasschnelli: using the \"C\" locale to imbue `boost::filesystem::path` indeed triggers the failure on Windows in this context.\r\n\r\nThere is more than one problem tackled by `SetupEnvironment()`:\r\n\r\n1. On POSIX systems, messed up environment settings can cause a failure ([Python test](https://gist.github.com/dexX7/ab3f7411a9040e96d55c)).\r\n2. During the deinitialization, an internal facet pointer of `boost::path` is deleted, and if `boost::path` was not initialized by the main thread, it causes failures such as #3136 (and related).\r\n\r\nThe current situation:\r\n\r\n1. As default, the \"C\" locale is used.\r\n2. On POSIX systems, the environment locale is used (via `std::locale(\"\")`).\r\n3. On POSIX systems, to detect bad environment settings, an exception thrown by `std::locale(\"\")` is caught.\r\n4. On POSIX systems, and if there are bad environment settings, the \"C\" locale is used as fallback.\r\n5. As workaround, to explicitly force the initialization of the internal facet pointer by the main thread, `boost::filesystem::path::imbue()` is called.\r\n6. Bad initialization of `boost::filesystem::boost::path` can result in exceptions, which are currently not caught.\r\n7. On Windows systems, the \"C\" locale appearingly does not cover the whole character set, which can result in (6), as shown by #6078.\r\n\r\nIn practise, the current 0.10.1 can result in a failure on Russian (and other) Windows, and earlier versions are affected by the deinitialization issue, resulting in faulty Boost test executions, as well as other failures during the shutdown, such as the crash reported in the context of rebuilding the block database.",
      "created_at" : "2015-05-01T13:54:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98139231",
      "id" : 98139231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98139231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "Arguably the new problem is worse, as it prevents people from running the client at all with some characters in their data directories, instead of a rare shutdown race. What about:\r\n```c++\r\n    std::locale loc(\"C\");\r\n    // On most POSIX systems (e.g. Linux, but not BSD) the environment's locale\r\n    // may be invalid, in which case the \"C\" locale is used as fallback.\r\n    try {\r\n        loc = std::locale(\"\"); // Raises a runtime error if current locale is invalid\r\n    } catch (const std::runtime_error&) {\r\n#if !defined(WIN32) && !defined(MAC_OSX) && !defined(__FreeBSD__) && !defined(__OpenBSD__)\r\n        setenv(\"LC_ALL\", \"C\", 1);\r\n#endif\r\n    }\r\n    // The path locale is lazy initialized and to avoid deinitialization errors \r\n    // in multithreading environments, it is set explicitly by the main thread.\r\n    boost::filesystem::path::imbue(loc);\r\n```\r\nThis would imbue the system locale on all platforms and should avoid the race condition, as well as the data directory problems. Needs to be tested though..\r\n",
      "created_at" : "2015-05-01T15:47:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98162584",
      "id" : 98162584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T15:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98162584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj i tried you proposed code and it does not fix the problem. Maybe it would be worth to revert #5877 and find a proper solution.\r\n\r\nWhat really surprises me: At least since 0.9.2 (didn't try further down), bitcoind and Bitcoin-Qt does not run with a datadir-path containing special Chinese or other Asian chars (Windows only).",
      "created_at" : "2015-05-01T16:33:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98173470",
      "id" : 98173470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T16:33:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98173470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "boost::filesystem::path::imbue() returns the \"previously used locale\", which should be the \"right one\", if called in a pristine environment, or to put it another way: if imbue() wouldn't be called at all, then this appears to be the one fs::path would use.\r\n\r\nIn the following patch, a dummy locale is used to extract the internal locale, to use it explicitly, which seems to be a preferable choice, because the goal is not to modify the locale at all, but to prevent deinitialization issues, and the bad-environment-fallback also kicks in earlier.\r\n\r\n```diff\r\ndiff --git a/src/util.cpp b/src/util.cpp\r\nindex 4fea18b..68fb326 100644\r\n--- a/src/util.cpp\r\n+++ b/src/util.cpp\r\n@@ -713,18 +713,20 @@ void RenameThread(const char* name)\r\n \r\n void SetupEnvironment()\r\n {\r\n-    std::locale loc(\"C\");\r\n     // On most POSIX systems (e.g. Linux, but not BSD) the environment's locale\r\n     // may be invalid, in which case the \"C\" locale is used as fallback.\r\n #if !defined(WIN32) && !defined(MAC_OSX) && !defined(__FreeBSD__) && !defined(__OpenBSD__)\r\n     try {\r\n-        loc = std::locale(\"\"); // Raises a runtime error if current locale is invalid\r\n+        std::locale(\"\"); // Raises a runtime error if current locale is invalid\r\n     } catch (const std::runtime_error&) {\r\n         setenv(\"LC_ALL\", \"C\", 1);\r\n     }\r\n #endif\r\n     // The path locale is lazy initialized and to avoid deinitialization errors \r\n     // in multithreading environments, it is set explicitly by the main thread.\r\n+    // A dummy locale is used to extract the internal default locale, used by\r\n+    // boost::filesystem::path, which is then used to explicitly imbue the path.\r\n+    std::locale loc = boost::filesystem::path::imbue(std::locale::classic());\r\n     boost::filesystem::path::imbue(loc);\r\n }\r\n ```\r\n\r\nI tested 0.9.3, 0.10.1, another patch and this one, and it's behavior appears to be similar to 0.9.3 (i.e. it can handle paths, which 0.10.1 can't handle).\r\n\r\nExample paths and test results:\r\n\r\n- https://gist.github.com/dexX7/7394a947b29c7d84c710#file-results_bitcoind-log\r\n- https://gist.github.com/dexX7/7394a947b29c7d84c710#file-results_bitcoin-qt-log\r\n\r\nNeither the newly patched version, 0.9.3, or 0.10.0, are able to use `\"E:\\LocaleTests\\ÃÂÃÂ·ÃÂ·ÃÂ°\"` as datadir.\r\n\r\nWhen choosing `\"E:\\LocaleTests\\ÃÂÃÂ·ÃÂ·ÃÂ°\"` as datadir via bitcoin-qt 0.9.3, then the error message is in German, while the patched version, as well as bitcoin-qt 0.10.0, shows an English message, even though the rest of the UI is actually translated.",
      "created_at" : "2015-05-01T17:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98185779",
      "id" : 98185779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T17:46:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98185779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "I think that's a bit circuitous. It works, but not for obvious reasons.\r\n\r\nThe returned loc from boost is the classic locale plus custom boost facet for windows. Otherwise, you could just replace the first call with std::locale().\r\n\r\nThe below is greatly simplified and I think it does what we want. Note that std::locale::global(\"\") does not work as intended on windows, presumably because we're statically linking libstdc++. The basic C setlocale() does though.\r\n\r\n```\r\nvoid SetupEnvironment()\r\n{\r\n    if (!setlocale(LC_ALL, \"\"))\r\n    {\r\n        setenv(\"LC_ALL\", \"C\", 1);\r\n        setlocale(LC_ALL, \"C\");\r\n    }\r\n    boost::filesystem::path::imbue(std::locale());\r\n}\r\n```\r\nAll we're really trying to accomplish here is to teach boost how to handle locale-specific char conversions for paths, right? Afaik we don't mess with c++ locales elsewhere.\r\n\r\nThe above accomplishes that, won't throw exceptions, and I believe it's portable. Tested and verified with a Chinese profile/username/locale on win7, and on Linux with a busted locale via ```LC_LANG=bad ./bitcoind```",
      "created_at" : "2015-05-01T20:23:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98225181",
      "id" : 98225181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T20:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98225181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni: when building on Ubuntu 14.04, with `HOST=x86_64-w64-mingw32`, and the dependency packages provided via `depends`, I had to wrap `setenv` with ` #if !defined(WIN32) ...`, because it would otherwise cause a build error.\r\n\r\nBack on Windows 8.1 x64, when [using bitcoin-qt.exe](https://gist.github.com/dexX7/7394a947b29c7d84c710#file-results_bitcoin-qt-log), the tricky paths, such as `..\\ÃÂ` and `..\\Ã¢ÂÂ¬@ÃÂ¤ÃÂ®`, are accepted and work very well, however, when using `..\\ÃÂÃÂ·ÃÂ·ÃÂ°`, a runtime error is raised.\r\n\r\nI was not able to use that path with any version or patch, though 0.9.3, and the build with the dummy-workaround, respond with `\"Error: Specified data directory \"E:\\LocaleTests\\????\" does not exist.\"` instead.\r\n\r\nThe [behavior of bitcoind.exe](https://gist.github.com/dexX7/7394a947b29c7d84c710#file-results_bitcoind-log) 0.9.3, the dummy-workaround patch, and your simple patch appears to be similar.",
      "created_at" : "2015-05-01T21:30:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98242672",
      "id" : 98242672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T21:30:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98242672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "Updated this PR with @theunis solution (fixed: added a `#if !defined(WIN32)` for `setenv()`).\r\nBuilt through gitian: https://builds.jonasschnelli.ch/pulls/6093/\r\n\r\nWon't run on win7 with a username containing Chinese chars (as it was with 0.9.3, 0.10.0, probably it was always like this).\r\n**But won't also run on win7 with a username containing Russian chars (where 0.9.3 and 0.10.0 was running okay).**\r\n\r\nShort term we need a solution to fix #6078 without reintroducing #3136.\r\nLong term we need a solution who can handle all possible windows charsets.\r\n\r\n![bildschirmfoto 2015-05-02 um 10 37 53](https://cloud.githubusercontent.com/assets/178464/7440490/1b7b6286-f0b8-11e4-8827-34c38133e0eb.png)\r\n\r\n![bildschirmfoto 2015-05-02 um 10 43 54](https://cloud.githubusercontent.com/assets/178464/7440491/25ff10c2-f0b8-11e4-8dc3-859966287b2d.png)\r\n",
      "created_at" : "2015-05-02T08:45:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98333186",
      "id" : 98333186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-02T08:45:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98333186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Ok, I've done more debugging here.\r\ntl;dr: After poking some more with even more variables, I think @dexX7's change is the right one.\r\n\r\n@jonasschnelli It works fine for me with a Chinese username. Turns out there's another variable: selected system \"Format\" in system location settings. Looks like that's what influences the default locale at runtime rather than the system locale.\r\n\r\nSome testing using ```printf(\"locale %s:\"setlocale(LC_ALL,NULL))```:\r\nWith a Chinese format selected:```locale: Chinese (Simplified)_People's Republic of China.936```\r\nWith English selected: ```English_United States.1252```\r\n\r\nSo.. makes sense. Locale is per-user.\r\n\r\nWhen the Format is set to Chinese, a Chinese username works.\r\nWhen the format is left (default?) in English, the Chinese username doesn't work.\r\n\r\nThis is the case because when we use the user's locale (Format), paths for that language should just work.\r\n\r\nHowever.\r\n\r\nUsing @dexX7's trick, Chinese username with English Format does work. This is because of boost's usage of its own codecvt, which queries the Win API for the codepage type: https://github.com/boostorg/filesystem/blob/boost-1.55.0/src/windows_file_codecvt.cpp#L39\r\n\r\nSo it looks like that's actually the way to go.",
      "created_at" : "2015-05-02T14:43:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98367514",
      "id" : 98367514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-02T14:43:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98367514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni: my idea was basically to get access and capture the whole following block, which uses different facets, depending on the OS and build: [boost-1.55.0/src/path.cpp#L792-L873](https://github.com/boostorg/filesystem/blob/boost-1.55.0/src/path.cpp#L792-L873), and then use it to properly \"initialize\" Boost path by the main thread with the correct locale, after taking care of bad environment settings.\r\n\r\nNevertheless, it would probably make sense to catch the exception, or handle failures related to the datadir. In your simpler solution I can trigger a runtime error, if I use the path `\"E:\\LocaleTests\\ÃÂÃÂ·ÃÂ·ÃÂ°\"` (which is a legit path) on a German localized Windows, while 0.9.3 and my patch results in `\"Error: Specified data directory \"E:\\LocaleTests\\????\" does not exist.\"`. I'm not entirely sure, where this is coming from, but ideally there should be a more expressive user faced message, with clear instructions to use a \"compatible\" path, if possible\r\n\r\nFWIW: https://github.com/dexX7/bitcoin/commit/c9a37843bc58bce12ece6bcf896339eeadc58ccd\r\n\r\n@laanwj's words are still ringing in my ear.. :/\r\n\r\n> This more and more looks like just some occult incantation to ward off the evil spirits of bad locales :)",
      "created_at" : "2015-05-02T16:14:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98374385",
      "id" : 98374385,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-02T16:14:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98374385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "Can't we all just agree to go back to EBCDIC?",
      "created_at" : "2015-05-02T16:16:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98374467",
      "id" : 98374467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-02T16:16:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98374467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I preferred [PETSCII](https://en.wikipedia.org/wiki/PETSCII) :)\r\n\r\nQuestion: at least for the 0.10 branch, can you code this so that it doesn't affect behavior on non-Windows? I'd hate to release a 'fix' then break the Linux issue again, where an invalid locale prevents the application from starting.\r\n\r\n> Using @dexX7's trick, Chinese username with English Format does work. This is because of boost's usage of its own codecvt, which queries the Win API for the codepage type: https://github.com/boostorg/filesystem/blob/boost-1.55.0/src/windows_file_codecvt.cpp#L39\r\n\r\nPhew -- that's suble. Thanks for shedding some light on this dark matter. I agree that @dexX7's swap-the-locale trick, though circuitous. seems to be the best way forward.",
      "created_at" : "2015-05-04T08:49:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98639063",
      "id" : 98639063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-04T09:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98639063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6093#discussion_r29572542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6093"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/29572542"
         }
      },
      "body" : "Please correct instead of remove the comments. Esoteric knowledge about locales is needed to understand this on reading, heck, *we* will have forgotten about the rationale for this in a few months.",
      "commit_id" : "426ee48f866a438a850d281ed94ac771febee4d0",
      "created_at" : "2015-05-04T08:52:55Z",
      "diff_hunk" : "@@ -726,19 +726,14 @@ void RenameThread(const char* name)\n \n void SetupEnvironment()\n {\n-    std::locale loc(\"C\");\n-    // On most POSIX systems (e.g. Linux, but not BSD) the environment's locale\n-    // may be invalid, in which case the \"C\" locale is used as fallback.\n-#if !defined(WIN32) && !defined(MAC_OSX) && !defined(__FreeBSD__) && !defined(__OpenBSD__)\n-    try {\n-        loc = std::locale(\"\"); // Raises a runtime error if current locale is invalid\n-    } catch (const std::runtime_error&) {\n+    if (!setlocale(LC_ALL, \"\"))\n+    {\n+#if !defined(WIN32)\n         setenv(\"LC_ALL\", \"C\", 1);\n-    }\n #endif\n-    // The path locale is lazy initialized and to avoid deinitialization errors ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#discussion_r29572542",
      "id" : 29572542,
      "original_commit_id" : "426ee48f866a438a850d281ed94ac771febee4d0",
      "original_position" : 17,
      "path" : "src/util.cpp",
      "position" : 17,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6093",
      "updated_at" : "2015-05-04T08:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/29572542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Updated to make use of @dexX7 solution (https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98185779).\r\nI think this is okay for 0.11.\r\n\r\nIf there are no complains, i'll open a PR for the 0.10 branch with the same solution but only touching Win32 behavior (some ifdefs).",
      "created_at" : "2015-05-04T12:10:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98689436",
      "id" : 98689436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-04T12:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98689436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@dexX7 Thanks for sticking with this and explaining the issue well. It looks like it took me a little while to figure out exactly what you already had, I just had to work through it myself for it to make sense. Nice detective work!\r\n\r\n@laanwj Agreed on making it windows only for 0.10, and on adding comments.\r\n\r\nAdditionally, we're depending on internal boost workings here that may change in the future, I wonder if it'd be worthwhile to add a quick test to use './bitcoind.exe -datadir=c:\\something\\non-latin'. Sadly, I don't think we could trust wine to faithfully reproduce the issue, but at least we'd have a set of tests that could be run manually.\r\n\r\nIf that's possible, we'd probably want to bake it into the test_bitcoin.exe binary to rule out python/shell middle-man issues.\r\n\r\nEdit: thinking on it a little more, using -datadir for a test is overkill. We could just add a quick unit-test to add a subdir inside the current profile and touch a file in there.",
      "created_at" : "2015-05-04T13:58:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98713996",
      "id" : 98713996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-04T14:01:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98713996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
