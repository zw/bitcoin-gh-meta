[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73729297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73729297"
         }
      },
      "body" : "Can you add comments explaining what J and W are?",
      "commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "created_at" : "2016-08-05T17:29:32Z",
      "diff_hunk" : "@@ -26,7 +26,7 @@ class CCheckQueueControl;\n   * the master is done adding work, it temporarily joins the worker pool\n   * as an N'th worker, until all jobs are done.\n   */\n-template <typename T>\n+template <typename T, size_t J size_t W>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73729297",
      "id" : 73729297,
      "original_commit_id" : "3517995753e3ab0debbcc1dd11d81ad04073a032",
      "original_position" : 5,
      "path" : "src/checkqueue.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-31T01:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73729297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73730081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73730081"
         }
      },
      "body" : "You're viewing an outdated diff, I just did this for a clean interface change then implementation change set of commits. They are unused here.",
      "commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "created_at" : "2016-08-05T17:34:20Z",
      "diff_hunk" : "@@ -26,7 +26,7 @@ class CCheckQueueControl;\n   * the master is done adding work, it temporarily joins the worker pool\n   * as an N'th worker, until all jobs are done.\n   */\n-template <typename T>\n+template <typename T, size_t J size_t W>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73730081",
      "id" : 73730081,
      "original_commit_id" : "3517995753e3ab0debbcc1dd11d81ad04073a032",
      "original_position" : 5,
      "path" : "src/checkqueue.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-31T01:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73730081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73731807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73731807"
         }
      },
      "body" : "These error messages can indicate the failed type (bool/long/llong)?",
      "commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "created_at" : "2016-08-05T17:44:04Z",
      "diff_hunk" : "@@ -5,179 +5,437 @@\n #ifndef BITCOIN_CHECKQUEUE_H\n #define BITCOIN_CHECKQUEUE_H\n \n-#include <algorithm>\n #include <vector>\n+#include \"util.h\"\n+#include \"utiltime.h\"\n+#include <atomic>\n+#include <thread>\n+#include <chrono>\n+#include <sstream>\n+#include <iostream>\n+// This should be ignored eventually, but needs testing to ensure this works on more platforms\n+static_assert(ATOMIC_BOOL_LOCK_FREE, \"shared_status not lock free\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73731807",
      "id" : 73731807,
      "original_commit_id" : "d8ba250b5e337a83c38bbd1c7772122f10f47fc4",
      "original_position" : 14,
      "path" : "src/checkqueue.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-31T01:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73731807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73778855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73778855"
         }
      },
      "body" : "I added a commit which changes them from static_asserts to warnings. I'm unsure if the warning is properly x-platform; seems to not be a consistent thing. In any case, not being lockfree only effects performance, not correctness.",
      "commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "created_at" : "2016-08-06T02:02:07Z",
      "diff_hunk" : "@@ -5,179 +5,437 @@\n #ifndef BITCOIN_CHECKQUEUE_H\n #define BITCOIN_CHECKQUEUE_H\n \n-#include <algorithm>\n #include <vector>\n+#include \"util.h\"\n+#include \"utiltime.h\"\n+#include <atomic>\n+#include <thread>\n+#include <chrono>\n+#include <sstream>\n+#include <iostream>\n+// This should be ignored eventually, but needs testing to ensure this works on more platforms\n+static_assert(ATOMIC_BOOL_LOCK_FREE, \"shared_status not lock free\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r73778855",
      "id" : 73778855,
      "original_commit_id" : "d8ba250b5e337a83c38bbd1c7772122f10f47fc4",
      "original_position" : 14,
      "path" : "src/checkqueue.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-31T01:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/73778855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "Pull tester failure seems to be semi-related to https://github.com/bitcoin/bitcoin/issues/8425.",
      "created_at" : "2016-08-07T18:17:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238098662",
      "id" : 238098662,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-07T18:17:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238098662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "@JeremyRubin I don't think so. `bitcoind` segfaults in Travis with this PR (and all rpc tests fail). In #8425 there is just a failure in one test.",
      "created_at" : "2016-08-07T19:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238103794",
      "id" : 238103794,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-07T22:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238103794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa So when I run tests one by one they seem to not fail; when I run them using rpc_tests.py they do fail. Let me know if you have any ideas why this might be the case.",
      "created_at" : "2016-08-07T20:55:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238107909",
      "id" : 238107909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-07T20:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238107909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "@JeremyRubin You can try `qa/pull-tester/rpc-tests.py -parallel=1` to mimic running them by one by one.",
      "created_at" : "2016-08-07T21:10:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238108724",
      "id" : 238108724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-07T21:10:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238108724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "@sipa I'm flattered that you tagged me (always an honor to be tagged by\nyou or any other big name in Bitcoin dev), but this isn't my pull\nrequest.  :)\n\n",
      "created_at" : "2016-08-07T21:48:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238110716",
      "id" : 238110716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-07T21:48:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238110716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/244188?v=3",
         "events_url" : "https://api.github.com/users/JeremyRand/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRand/followers",
         "following_url" : "https://api.github.com/users/JeremyRand/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRand/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRand",
         "id" : 244188,
         "login" : "JeremyRand",
         "organizations_url" : "https://api.github.com/users/JeremyRand/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRand/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRand/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRand/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRand/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRand"
      }
   },
   {
      "body" : "Thanks @MarcoFalke.\r\n\r\nRunning with `-parallel=1` all tests pass, except for rawtransactions which failed with \r\n\r\n```\r\nrawtransactions.py:\r\nInitializing test directory /tmp/testricvjc8u/29\r\nStopping nodes\r\nCleaning up\r\nTests successful\r\n\r\nstderr:\r\n Error: Unable to start HTTP server. See debug log for details.\r\n\r\nPass: False, Duration: 21 s\r\n```\r\nThere's nothing in the tmpdir.\r\n\r\n\r\nRerunning rawtransactions alone (many times) it didn't fail so I think it's random failure as seen in https://github.com/bitcoin/bitcoin/issues/8425.\r\n\r\n\r\n\r\n\r\n",
      "created_at" : "2016-08-08T01:15:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-238122042",
      "id" : 238122042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-08-08T01:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/238122042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r74707973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74707973"
         }
      },
      "body" : ",'Val\"",
      "commit_id" : "da570c42a9ac6684a43a20c2d0bf09fa5146f41f",
      "created_at" : "2016-08-14T20:34:10Z",
      "diff_hunk" : "@@ -294,6 +293,8 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_Correct)\n                 control.Add(vChecks);\n             }\n         }\n+        small_queue->TEST_dump_log(nScriptCheckThreads);\n+        small_queue->TEST_erase_log();\n         if (FakeJobCheckCompletion::n_calls != i) {\n             BOOST_REQUIRE(FakeJobCheckCompletion::n_calls == i);\n             BOOST_TEST_MESSAGE(\"Failure on trial \" << i << \" expected, got \" << FakeJobCheckCompletion::n_calls);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r74707973",
      "id" : 74707973,
      "original_commit_id" : "da570c42a9ac6684a43a20c2d0bf09fa5146f41f",
      "original_position" : 72,
      "path" : "src/test/checkqueue_tests.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-14T20:34:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74707973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19338428?v=3",
         "events_url" : "https://api.github.com/users/PrinceofOrange/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PrinceofOrange/followers",
         "following_url" : "https://api.github.com/users/PrinceofOrange/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PrinceofOrange/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PrinceofOrange",
         "id" : 19338428,
         "login" : "PrinceofOrange",
         "organizations_url" : "https://api.github.com/users/PrinceofOrange/orgs",
         "received_events_url" : "https://api.github.com/users/PrinceofOrange/received_events",
         "repos_url" : "https://api.github.com/users/PrinceofOrange/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PrinceofOrange/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PrinceofOrange/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PrinceofOrange"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r74707986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74707986"
         }
      },
      "body" : "1.1",
      "commit_id" : "da570c42a9ac6684a43a20c2d0bf09fa5146f41f",
      "created_at" : "2016-08-14T20:35:26Z",
      "diff_hunk" : "@@ -0,0 +1,305 @@\n+// Copyright (c) 2012-2015 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"util.h\"\n+#include \"utiltime.h\"\n+#include \"main.h\"\n+\n+#include \"test/test_bitcoin.h\"\n+#include \"checkqueue.h\"\n+#include <boost/test/unit_test.hpp>\n+#include <atomic>\n+#include <thread>\n+#include <vector>\n+\n+#include <unordered_set>\n+#include <memory>\n+#include \"random.h\"\n+BOOST_FIXTURE_TEST_SUITE(checkqueue_tests, TestingSetup)\n+\n+\n+class RAII_ThreadGroup {\n+    std::vector<std::thread> threadGroup;\n+    public:\n+    template <typename Callable>\n+    void create_thread(Callable c) {\n+        std::thread t(c);\n+        threadGroup.push_back(std::move(t));\n+    };\n+    void join_all(){\n+        for (auto& t: threadGroup)\n+            t.join();\n+        threadGroup.clear();\n+    };\n+    ~RAII_ThreadGroup() {\n+        join_all();\n+    };\n+\n+};\n+\n+struct FakeJob {\n+};\n+typedef CCheckQueue<FakeJob, (size_t)1000, MAX_SCRIPTCHECK_THREADS, true, true> Standard_Queue;\n+struct FakeJobCheckCompletion {\n+    static std::atomic<size_t> n_calls;\n+    bool operator()()\n+    {\n+        ++n_calls;\n+        return true;\n+    }\n+    void swap(FakeJobCheckCompletion& x){};\n+};\n+std::atomic<size_t> FakeJobCheckCompletion::n_calls {0};\n+typedef CCheckQueue<FakeJobCheckCompletion, (size_t)100, MAX_SCRIPTCHECK_THREADS, true, true> Correct_Queue;\n+\n+struct FailingJob {\n+    bool f;\n+    bool call_state;\n+    size_t tag;\n+    static std::atomic<size_t> n_calls;\n+    FailingJob(bool fails) : f(fails), call_state(false), tag(0xdeadbeef){};\n+    FailingJob() : f(true), call_state(false){};\n+    bool operator()()\n+    {\n+        n_calls++;\n+        call_state = true;\n+        return !f;\n+    }\n+    void swap(FailingJob& x)\n+    {\n+        std::swap(f, x.f);\n+\n+        std::swap(call_state, x.call_state);\n+        std::swap(tag, x.tag);\n+    };\n+};\n+std::atomic<size_t> FailingJob::n_calls {0};\n+typedef CCheckQueue<FailingJob, (size_t)1000, MAX_SCRIPTCHECK_THREADS, true, true> Failing_Queue;\n+struct FakeJobNoWork {\n+    bool operator()()\n+    {\n+        return true;\n+    }\n+    void swap(FakeJobNoWork& x){};\n+};\n+typedef CCheckQueue<FakeJobNoWork, (size_t)1000, MAX_SCRIPTCHECK_THREADS, true, true> Consume_Queue;\n+\n+typedef typename Standard_Queue::JOB_TYPE JT; // This is a \"recursive template\" hack\n+typedef CCheckQueue_Internals::job_array<Standard_Queue> J;\n+typedef CCheckQueue_Internals::round_barrier<Standard_Queue> B;\n+BOOST_AUTO_TEST_CASE(test_CheckQueue_Catches_Failure)\n+{\n+    fPrintToConsole = true;\n+    auto fail_queue = std::unique_ptr<Failing_Queue>(new Failing_Queue());\n+\n+    fail_queue->init(nScriptCheckThreads);\n+\n+    for (size_t i = 10; i < 1001; ++i) {\n+        FailingJob::n_calls = 0;\n+        CCheckQueueControl<Failing_Queue> control(fail_queue.get());\n+        size_t checksum = 0;\n+\n+        std::vector<FailingJob> vChecks;\n+        vChecks.reserve(i);\n+        for (size_t x = 0; x < i; ++x)\n+            vChecks.push_back(FailingJob{});\n+        if (i > 0)\n+            vChecks[0].f = true;\n+        while (!vChecks.empty()) {\n+            size_t r = GetRand(10);\n+            std::vector<FailingJob> vChecks2;\n+            vChecks2.reserve(r);\n+            for (size_t k = 0; k < r && !vChecks.empty(); k++) {\n+                vChecks2.emplace_back(vChecks.back());\n+                vChecks.pop_back();\n+            }\n+            checksum += vChecks2.size();\n+            control.Add(vChecks2);\n+        }\n+        BOOST_REQUIRE(checksum == i);\n+        bool success = control.Wait();\n+        if (success && i > 0) {\n+            size_t nChecked = 0;\n+            auto jobs = fail_queue->TEST_introspect_jobs()->TEST_get_checks();\n+            for (size_t x = 0; x < i; ++x)\n+                if ((*jobs)[x].call_state)\n+                    nChecked++;\n+            fail_queue->TEST_dump_log(nScriptCheckThreads);\n+            fail_queue->TEST_erase_log();\n+            BOOST_REQUIRE(!success);\n+        } else if (i == 0) {\n+            fail_queue->TEST_erase_log();\n+            BOOST_REQUIRE(success);\n+        }\n+        fail_queue->TEST_erase_log();\n+    }\n+    fPrintToConsole = false;\n+}\n+BOOST_AUTO_TEST_CASE(test_CheckQueue_PriorityWorkQueue)\n+{\n+    CCheckQueue_Internals::PriorityWorkQueue<Standard_Queue> work(0, 16);\n+    auto m = 0;\n+    work.add(100);\n+    size_t x = 0;\n+    work.pop(x, false);\n+    BOOST_REQUIRE(x == 0);\n+    work.pop(x, false);\n+    BOOST_REQUIRE(x == 16);\n+    m = 2;\n+    while (work.pop(x, false)) {\n+        ++m;\n+    }\n+    BOOST_REQUIRE(m == 100);\n+    work.add(200);\n+    std::unordered_set<size_t> results;\n+    while (work.pop(x, false)) {\n+        results.insert(x);\n+        ++m;\n+    }\n+    for (auto i = 100; i < 200; ++i) {\n+        BOOST_REQUIRE(results.count(i));\n+        results.erase(i);\n+    }\n+    BOOST_REQUIRE(results.empty());\n+    BOOST_REQUIRE(m == 200);\n+\n+    work.add(300);\n+    work.pop(x, false);\n+    work.add(400);\n+    do {\n+        results.insert(x);\n+        ++m;\n+    } while (work.pop(x, false));\n+    for (auto i = 200; i < 400; ++i) {\n+        BOOST_REQUIRE(results.count(i));\n+        results.erase(i);\n+    }\n+    for (auto i : results)\n+        BOOST_TEST_MESSAGE(\"\" << i);\n+\n+    BOOST_REQUIRE(results.empty());\n+    BOOST_REQUIRE(m == 400);\n+}\n+\n+BOOST_AUTO_TEST_CASE(test_CheckQueue_job_array)\n+{\n+    auto jobs = std::shared_ptr<J>(new J());\n+    std::atomic<size_t> m;\n+    for (size_t i = 0; i < Standard_Queue::MAX_JOBS; ++i)\n+        jobs->reset_flag(i);\n+    m = 0;\n+    std::thread t([&](std::atomic<size_t>& m) {\n+        for (size_t i = 0; i < Standard_Queue::MAX_JOBS; ++i)\n+            m += jobs->reserve(i) ? 1 : 0;\n+    }, std::ref(m));\n+\n+\n+    std::thread t2([&](std::atomic<size_t>& m) {\n+        for (size_t i = 0; i < Standard_Queue::MAX_JOBS; ++i)\n+            m += jobs->reserve(i) ? 1 : 0;\n+    }, std::ref(m));\n+    t.join();\n+    t2.join();\n+\n+    BOOST_REQUIRE(m == Standard_Queue::MAX_JOBS);\n+}\n+BOOST_AUTO_TEST_CASE(test_CheckQueue_round_barrier)\n+{\n+    RAII_ThreadGroup threadGroup;\n+    auto barrier = std::shared_ptr<B>(new B());\n+    barrier->init(nScriptCheckThreads);\n+    for (int i = 0; i < nScriptCheckThreads; ++i)\n+        barrier->reset(i);\n+\n+    for (int i = 0; i < nScriptCheckThreads; ++i) \n+        threadGroup.create_thread([&, i]() {\n+            barrier->finished(i);\n+            barrier->wait_all_finished();\n+        });\n+\n+    threadGroup.join_all();\n+\n+}\n+\n+BOOST_AUTO_TEST_CASE(test_CheckQueue_consume)\n+{\n+    auto fast_queue = std::shared_ptr<Consume_Queue>(new Consume_Queue());\n+    fast_queue->init(nScriptCheckThreads);\n+    std::array<std::atomic<size_t>, MAX_SCRIPTCHECK_THREADS> results;\n+    std::atomic<int> spawned{0};\n+\n+    RAII_ThreadGroup threadGroup;\n+\n+    for (auto& a : results)\n+        a = 0;\n+    for (int i = 0; i < nScriptCheckThreads; ++i) {\n+        threadGroup.create_thread([&, i]() {\n+            ++spawned;\n+            results[i] = fast_queue->TEST_consume(i);\n+        });\n+    }\n+\n+    threadGroup.create_thread([&]() {\n+        while (spawned != nScriptCheckThreads);\n+        for (auto y = 0; y < 10; ++y) {\n+            std::vector<FakeJobNoWork> w;\n+            for (auto x = 0; x< 100; ++x) {\n+                w.push_back(FakeJobNoWork{});\n+            }\n+            fast_queue->Add(w);\n+            MilliSleep(1);\n+        }\n+        fast_queue->TEST_set_masterJoined(true);\n+    });\n+\n+    threadGroup.join_all();\n+\n+\n+\n+    for (auto a = 0; a < nScriptCheckThreads; ++a) {\n+        auto v = results[a].load();\n+        if (v != 1000) {\n+            BOOST_TEST_MESSAGE(\"Error, Got: \" << v);\n+            BOOST_REQUIRE(v == 1000);\n+        }\n+    }\n+    size_t count = fast_queue->TEST_count_set_flags();\n+    BOOST_TEST_MESSAGE(\"Got: \" << count);\n+    BOOST_REQUIRE(count == 1000);\n+}\n+\n+\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r74707986",
      "id" : 74707986,
      "original_commit_id" : "da570c42a9ac6684a43a20c2d0bf09fa5146f41f",
      "original_position" : 273,
      "path" : "src/test/checkqueue_tests.cpp",
      "position" : 273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-08-14T20:35:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74707986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19338428?v=3",
         "events_url" : "https://api.github.com/users/PrinceofOrange/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PrinceofOrange/followers",
         "following_url" : "https://api.github.com/users/PrinceofOrange/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PrinceofOrange/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PrinceofOrange",
         "id" : 19338428,
         "login" : "PrinceofOrange",
         "organizations_url" : "https://api.github.com/users/PrinceofOrange/orgs",
         "received_events_url" : "https://api.github.com/users/PrinceofOrange/received_events",
         "repos_url" : "https://api.github.com/users/PrinceofOrange/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PrinceofOrange/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PrinceofOrange/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PrinceofOrange"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r77268274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77268274"
         }
      },
      "body" : "I tend to prefer else over continue, but it is understandable is just to avoid the re-indent and minimize disruption.\r\nI would the continue be gone \"for free\" when/if  CheckInputs needs a reindent (btw, unrelated, we've been owing one to Consensus::CheckTxInputs for a while...)",
      "commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "created_at" : "2016-09-01T22:50:19Z",
      "diff_hunk" : "@@ -1996,11 +1994,12 @@ bool CheckInputs(const CTransaction& tx, CValidationState &state, const CCoinsVi\n                 assert(coins);\n \n                 // Verify signature\n-                CScriptCheck check(*coins, tx, i, flags, cacheStore);\n-                if (pvChecks) {\n-                    pvChecks->push_back(CScriptCheck());\n-                    check.swap(pvChecks->back());\n-                } else if (!check()) {\n+                if (emplacer) {\n+                    emplacer(CScriptCheck(*coins, tx, i, flags, cacheStore));\n+                    continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#discussion_r77268274",
      "id" : 77268274,
      "original_commit_id" : "72e42967b02f387286e144d8b272df95424aaccc",
      "original_position" : 28,
      "path" : "src/main.cpp",
      "position" : 28,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8464",
      "updated_at" : "2016-09-01T22:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77268274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Randomly noting this won't interfere with #8498 at all (well, probably in obvious-to-resolve ways).\r\nutACK main.o is all I can give for now.\r\n\r\nI heard %10 to 20% benchmark improvement...happy to benchmark if someone provides dumbed down instructions or they exist already and I missed them. ping @TheBlueMatt \r\n",
      "created_at" : "2016-09-01T22:54:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-244236835",
      "id" : 244236835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-09-01T22:57:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244236835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "@jtimon in an hour or less i should have a refactored version which has benchmarks added as commit one so you can test benching on all versions.",
      "created_at" : "2016-09-01T23:15:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-244240623",
      "id" : 244240623,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-09-01T23:15:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244240623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "@laanwj I'd like to get https://github.com/bitcoin/bitcoin/pull/8632 and some variant of https://github.com/bitcoin/bitcoin/pull/8633 merged if possible before I PR the new version, otherwise when I push the cleaned up version I won't pass tests due to timeouts.\r\n\r\nYou can see the restructured version here if anyone wants to review right away: https://github.com/bitcoin/bitcoin/compare/master...JeremyRubin:lockfree-checkqueue-restructured",
      "created_at" : "2016-09-02T00:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-244255663",
      "id" : 244255663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-09-02T00:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244255663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "Some benchmarks from the new version BTW:\r\n\r\nBefore\r\n\r\n    #Benchmark,count,min,max,average\r\n    CCheckQueueSpeed,6144,0.000019055791199,0.000413492321968,0.000275931825551\r\n    CCheckQueueSpeedPrevectorJob,416,0.001668065786362,0.004345431923866,0.002541266954862\r\n\r\nAfter: \r\n\r\n    #Benchmark,count,min,max,average\r\n    CCheckQueueSpeed,6144,0.000050746137276,0.000491065904498,0.000192628746542\r\n    CCheckQueueSpeedPrevectorJob,768,0.000427763909101,0.003052964806557,0.001347809719543\r\n\r\n\r\nCCheckQueueSpeed is a trivial fake job (benchmark slightly unfair, as the emplacement vs resize call probably costs the time). New code takes 70% of the time.\r\n\r\nCCheckQueueSpeedPrevectorJob is a job that contains a prevector that (deterministically randomly) is either direct or indirect. My code takes 50% of the time.\r\n\r\n\r\n",
      "created_at" : "2016-09-02T01:09:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8464#issuecomment-244257294",
      "id" : 244257294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8464",
      "updated_at" : "2016-09-02T01:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244257294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   }
]
