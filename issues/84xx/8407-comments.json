[
   {
      "body" : "Fixes #https://github.com/bitcoin/bitcoin/issues/8406",
      "created_at" : "2016-07-26T12:08:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235248563",
      "id" : 235248563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-26T12:08:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235248563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "I like this solution; can you please move the upgrader to a separate function? I'm sure this won't be the last time we need this.\r\n",
      "created_at" : "2016-07-26T12:31:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235253144",
      "id" : 235253144,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-26T12:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235253144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72239826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72239826"
         }
      },
      "body" : "To reduce the scope for spurious settings changes, I think it makes sense to compare the version to a specific version (where the default was changed) for each upgrader case.\r\nE.g.\r\n```c++\r\nint settingsVersion = settings.value(strSettingsVersionKey);\r\nif (settingsVersion < 130000 && settings.contains(\"nDatabaseCache\") && settings.value(\"nDatabaseCache\") == 100)\r\n```",
      "commit_id" : "8fe0aba2ccf034a289ee93ad26f497a723269dc4",
      "created_at" : "2016-07-26T12:36:34Z",
      "diff_hunk" : "@@ -85,6 +85,21 @@ void OptionsModel::Init(bool resetSettings)\n     // If SoftSetArg() or SoftSetBoolArg() return false we were overridden\n     // by command-line and show this in the UI.\n \n+\n+    // Migration of default values\n+    // Check if the QSettings container was already loaded with this client version\n+    static const char strSettingsVersionKey[] = \"nSettingsVersion\";\n+    if (!settings.contains(strSettingsVersionKey) || settings.value(strSettingsVersionKey) < CLIENT_VERSION)\n+    {\n+        // -dbcache was bumped from 100 to 300 in 0.13\n+        // see https://github.com/bitcoin/bitcoin/pull/8273\n+        // force people to upgrade to the new value if they are using 100MB\n+        if (settings.contains(\"nDatabaseCache\") && settings.value(\"nDatabaseCache\") == 100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72239826",
      "id" : 72239826,
      "original_commit_id" : "2ca37bf1e1b6cd54ec9ec29f4fdfb2dad08b723e",
      "original_position" : 13,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407",
      "updated_at" : "2016-07-26T14:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72239826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72240943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72240943"
         }
      },
      "body" : "Would it be possible to treat a value of 0 (on disk) as \"default\", and\nwhenever a value equal to the current software default is to be written,\nwrite 0 instead?\n\nThat would simplify future changes...\n",
      "commit_id" : "8fe0aba2ccf034a289ee93ad26f497a723269dc4",
      "created_at" : "2016-07-26T12:44:04Z",
      "diff_hunk" : "@@ -85,6 +85,21 @@ void OptionsModel::Init(bool resetSettings)\n     // If SoftSetArg() or SoftSetBoolArg() return false we were overridden\n     // by command-line and show this in the UI.\n \n+\n+    // Migration of default values\n+    // Check if the QSettings container was already loaded with this client version\n+    static const char strSettingsVersionKey[] = \"nSettingsVersion\";\n+    if (!settings.contains(strSettingsVersionKey) || settings.value(strSettingsVersionKey) < CLIENT_VERSION)\n+    {\n+        // -dbcache was bumped from 100 to 300 in 0.13\n+        // see https://github.com/bitcoin/bitcoin/pull/8273\n+        // force people to upgrade to the new value if they are using 100MB\n+        if (settings.contains(\"nDatabaseCache\") && settings.value(\"nDatabaseCache\") == 100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72240943",
      "id" : 72240943,
      "original_commit_id" : "2ca37bf1e1b6cd54ec9ec29f4fdfb2dad08b723e",
      "original_position" : 13,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407",
      "updated_at" : "2016-07-26T14:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72240943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Factored out, fixed @laanwj finding (explicit < 130000 check).",
      "created_at" : "2016-07-26T13:51:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235273705",
      "id" : 235273705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-26T13:51:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235273705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Added another commit that will ensure that the current default value will never be written to the disk.\r\nThis would simplify future changes.",
      "created_at" : "2016-07-26T14:01:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235276569",
      "id" : 235276569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-26T14:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235276569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72257114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72257114"
         }
      },
      "body" : "Just thought of this: we need to handle the case `!settings.contains(strSettingsVersionKey)` inside the if() as well.\r\n```c++\r\nint settingsVersion = settings.contains(strSettingsVersionKey) ? settings.value(strSettingsVersionKey) : 0;\r\nif (settingsVersion < CLIENT_VERSION) {\r\n    if (settingsVersion < 130000 && settings.contains(\"nDatabaseCache\") && settings.value(\"nDatabaseCache\") == 100)\r\n    ....\r\n}\r\n```\r\nMakes the code slightly cleaner as well",
      "commit_id" : "8fe0aba2ccf034a289ee93ad26f497a723269dc4",
      "created_at" : "2016-07-26T14:14:43Z",
      "diff_hunk" : "@@ -429,3 +429,21 @@ bool OptionsModel::isRestartRequired()\n     QSettings settings;\n     return settings.value(\"fRestartRequired\", false).toBool();\n }\n+\n+void OptionsModel::checkAndMigrate()\n+{\n+    // Migration of default values\n+    // Check if the QSettings container was already loaded with this client version\n+    QSettings settings;\n+    static const char strSettingsVersionKey[] = \"nSettingsVersion\";\n+    if (!settings.contains(strSettingsVersionKey) || settings.value(strSettingsVersionKey) < CLIENT_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#discussion_r72257114",
      "id" : 72257114,
      "original_commit_id" : "8fe0aba2ccf034a289ee93ad26f497a723269dc4",
      "original_position" : 49,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8407",
      "updated_at" : "2016-07-26T14:14:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72257114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Not sure about the second commit. If we're going to do something like that, we need a structured solution that will never write the default value for any setting to disk - as it's likely that next time we want to change the default for another option, and then singling out dbcache won't help at all.\r\nI think the upgrade approach is fine really.",
      "created_at" : "2016-07-26T14:16:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235281151",
      "id" : 235281151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-26T14:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235281151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Removed the second commit after discussion with @laanwj on IRC.",
      "created_at" : "2016-07-27T11:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8407#issuecomment-235556734",
      "id" : 235556734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8407",
      "updated_at" : "2016-07-27T11:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235556734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
