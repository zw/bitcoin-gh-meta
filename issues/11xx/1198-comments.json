[
   {
      "body" : "Nice.\r\n\r\nSuggestion: when an error occurs while reading the address file, log it but don't escalate it. A corrupted file can easily be rebuilt, after all (and would remove one source of fatal startup errors).\r\n",
      "created_at" : "2012-05-05T08:03:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5525282",
      "id" : 5525282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-05T08:03:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5525282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I'd prefer addrman.{cpp,h} to be very self-contained and only have knowledge about the data structure and serialization, not how it's stored and certainly not where. The reason is that this may be useful to other projects (e.g. dns seeds) that don't have the same uti.h (addrman only depends on it because of the locking primitives).\r\n\r\nAlso, the IP address table is not critical, so incomplete writes in case of a crash during dumping may not be much of an issue, but it will certainly occur. I think we either want to defend against it (by making a failed read/deserialization not fatal) or by avoiding it (first writing to ipaddr.dat.new, and then atomically move it to ipaddr.dat). Or maybe both...\r\n\r\nEdit: don't get me wrong, I definitely want this!",
      "created_at" : "2012-05-05T11:36:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5526380",
      "id" : 5526380,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-05T11:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5526380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "1) Yes, error diagnostic -- particularly for a corrupted or truncated file -- should be expanded, made more verbose.\r\n\r\n2) Yes, the code should do something like write to temp file, then rename.  I have said as much on IRC several times.  Windows apparently uses ReplaceFile(), while Unix uses rename().\r\n\r\n3) I/O implemented inside CAddrMan was intentionally remaining consistent with CBlock::Read/Write*Disk() etc.  If we wanted to change that, that's OK.  Just noting the logic behind the decision.\r\n",
      "created_at" : "2012-05-05T20:45:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5530368",
      "id" : 5530368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-05T20:45:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5530368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "2) Or boost::filesystem::rename() ?\r\n3) Ok, that's just a minor design issue; it can always be changed later on in several places to do it in a consistent way.",
      "created_at" : "2012-05-05T22:23:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531016",
      "id" : 5531016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-05T22:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5531016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Googling for \"boost filesystem rename atomic\" seems to indicate that overwrite-via-rename is explicitly forbidden in the boost code.  See e.g., http://lists.boost.org/boost-users/2008/01/33451.php\r\n\r\nWould be happy to use boost if possible, but I think we will be forced to #ifdef WINDOWS { ReplaceFile() }\r\n",
      "created_at" : "2012-05-06T00:07:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531569",
      "id" : 5531569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-06T00:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5531569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "The first answer here is helpful: http://stackoverflow.com/questions/3156841/boostfilesystemrename-cannot-create-a-file-when-that-file-already-exists\r\n\r\nSeems that in boost::filesystem v3 the behaviour is correct. The problem is that we still support v2...",
      "created_at" : "2012-05-06T00:27:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531658",
      "id" : 5531658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-06T00:27:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5531658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "First run with this pullreq included, I get \"Error loading ipaddr.dat\" and quit. How can I start it for the first time? :)\r\n\r\nEdit: Confirmed ipaddr.dat doesn't exist yet.",
      "created_at" : "2012-05-06T18:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5537982",
      "id" : 5537982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-06T18:23:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5537982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "Now, that's what I meant with not escalating the error...\r\n",
      "created_at" : "2012-05-06T18:34:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5538096",
      "id" : 5538096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-06T18:34:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5538096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Should ipaddr.dat (451 KB) be much larger than addr.dat (7.3 KB)?",
      "created_at" : "2012-05-06T19:15:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5539860",
      "id" : 5539860,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-06T19:15:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5539860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "Added fix: do not die, if ipaddr.dat is missing\r\n",
      "created_at" : "2012-05-07T05:47:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5544289",
      "id" : 5544289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-07T05:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5544289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "OK, ipaddr.dat is now renamed into place.  All concerns have been addressed in the latest rebase.\n\nAdditional comments?",
      "created_at" : "2012-05-12T05:21:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5665388",
      "id" : 5665388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-12T05:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5665388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "operator<< can fail and throw an exception if the file is not in the correct format (or there's a bug). I think you'll need a try catch in/around addrman.ReadFromDisk.",
      "created_at" : "2012-05-12T16:30:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5669758",
      "id" : 5669758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-12T16:30:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5669758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Added a new commit, re-creating CAddrDB.",
      "created_at" : "2012-05-13T05:10:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5674051",
      "id" : 5674051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-13T05:10:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5674051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813363"
         }
      },
      "body" : "Without catch block, won't the exception just get thrown further?",
      "commit_id" : "928d3a011cc66c7f907c4d053f674ea77dc611cc",
      "created_at" : "2012-05-13T13:36:14Z",
      "diff_hunk" : "@@ -730,72 +728,60 @@ bool CTxDB::LoadBlockIndex()\n }\n \n \n-\n-\n-\n-//\n-// CAddrDB\n-//\n-\n-bool CAddrDB::WriteAddrman(const CAddrMan& addrman)\n+CAddrDB::CAddrDB()\n {\n-    return Write(string(\"addrman\"), addrman);\n+    pathAddr = GetDataDir() / \"ipaddr.dat\";\n }\n \n-bool CAddrDB::LoadAddresses()\n+bool CAddrDB::Write(const CAddrMan& addr)\n {\n-    if (Read(string(\"addrman\"), addrman))\n-    {\n-        printf(\"Loaded %i addresses\\n\", addrman.size());\n-        return true;\n+    // Generate random temporary filename\n+    unsigned short randv = 0;\n+    RAND_bytes((unsigned char *)&randv, sizeof(randv));\n+    std::string tmpfn = strprintf(\"ipaddr.dat.%04x\", randv);\n+\n+    // open temp file, and associate with CAutoFile\n+    boost::filesystem::path pathTmp = GetDataDir() / tmpfn;\n+    FILE *file = fopen(pathTmp.string().c_str(), \"wb\");\n+    CAutoFile fileout = CAutoFile(file, SER_DISK, CLIENT_VERSION);\n+    if (!fileout)\n+        return error(\"CAddrman::Write() : CAutoFile failed\");\n+\n+    // Write and commit addrman data\n+    try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813363",
      "id" : 813363,
      "original_commit_id" : "500b644f3be8c172ddb6fb9fd78891d8492daefe",
      "original_position" : 56,
      "path" : "src/db.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198",
      "updated_at" : "2012-05-17T02:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813659"
         }
      },
      "body" : "I don't understand your question.  The 'catch' statement immediately follows 'try'; scroll down a bit in the diff.\n",
      "commit_id" : "928d3a011cc66c7f907c4d053f674ea77dc611cc",
      "created_at" : "2012-05-13T18:51:46Z",
      "diff_hunk" : "@@ -730,72 +728,60 @@ bool CTxDB::LoadBlockIndex()\n }\n \n \n-\n-\n-\n-//\n-// CAddrDB\n-//\n-\n-bool CAddrDB::WriteAddrman(const CAddrMan& addrman)\n+CAddrDB::CAddrDB()\n {\n-    return Write(string(\"addrman\"), addrman);\n+    pathAddr = GetDataDir() / \"ipaddr.dat\";\n }\n \n-bool CAddrDB::LoadAddresses()\n+bool CAddrDB::Write(const CAddrMan& addr)\n {\n-    if (Read(string(\"addrman\"), addrman))\n-    {\n-        printf(\"Loaded %i addresses\\n\", addrman.size());\n-        return true;\n+    // Generate random temporary filename\n+    unsigned short randv = 0;\n+    RAND_bytes((unsigned char *)&randv, sizeof(randv));\n+    std::string tmpfn = strprintf(\"ipaddr.dat.%04x\", randv);\n+\n+    // open temp file, and associate with CAutoFile\n+    boost::filesystem::path pathTmp = GetDataDir() / tmpfn;\n+    FILE *file = fopen(pathTmp.string().c_str(), \"wb\");\n+    CAutoFile fileout = CAutoFile(file, SER_DISK, CLIENT_VERSION);\n+    if (!fileout)\n+        return error(\"CAddrman::Write() : CAutoFile failed\");\n+\n+    // Write and commit addrman data\n+    try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813659",
      "id" : 813659,
      "original_commit_id" : "500b644f3be8c172ddb6fb9fd78891d8492daefe",
      "original_position" : 56,
      "path" : "src/db.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198",
      "updated_at" : "2012-05-17T02:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813661"
         }
      },
      "body" : "Apologies, I misread the diff. Ignore my comment.",
      "commit_id" : "928d3a011cc66c7f907c4d053f674ea77dc611cc",
      "created_at" : "2012-05-13T18:55:27Z",
      "diff_hunk" : "@@ -730,72 +728,60 @@ bool CTxDB::LoadBlockIndex()\n }\n \n \n-\n-\n-\n-//\n-// CAddrDB\n-//\n-\n-bool CAddrDB::WriteAddrman(const CAddrMan& addrman)\n+CAddrDB::CAddrDB()\n {\n-    return Write(string(\"addrman\"), addrman);\n+    pathAddr = GetDataDir() / \"ipaddr.dat\";\n }\n \n-bool CAddrDB::LoadAddresses()\n+bool CAddrDB::Write(const CAddrMan& addr)\n {\n-    if (Read(string(\"addrman\"), addrman))\n-    {\n-        printf(\"Loaded %i addresses\\n\", addrman.size());\n-        return true;\n+    // Generate random temporary filename\n+    unsigned short randv = 0;\n+    RAND_bytes((unsigned char *)&randv, sizeof(randv));\n+    std::string tmpfn = strprintf(\"ipaddr.dat.%04x\", randv);\n+\n+    // open temp file, and associate with CAutoFile\n+    boost::filesystem::path pathTmp = GetDataDir() / tmpfn;\n+    FILE *file = fopen(pathTmp.string().c_str(), \"wb\");\n+    CAutoFile fileout = CAutoFile(file, SER_DISK, CLIENT_VERSION);\n+    if (!fileout)\n+        return error(\"CAddrman::Write() : CAutoFile failed\");\n+\n+    // Write and commit addrman data\n+    try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813661",
      "id" : 813661,
      "original_commit_id" : "500b644f3be8c172ddb6fb9fd78891d8492daefe",
      "original_position" : 56,
      "path" : "src/db.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1198",
      "updated_at" : "2012-05-17T02:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/813661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ACK",
      "created_at" : "2012-05-16T15:25:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5743658",
      "id" : 5743658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-16T15:25:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5743658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Added commits:\n\n1. rename to \"peers.dat\", the consensus on IRC\n2. add file header, which includes a magic number (pchMessageStart) and sha256 checksum\n",
      "created_at" : "2012-05-16T19:47:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5750053",
      "id" : 5750053,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-16T19:47:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5750053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Rebased, and fixed one final nasty bug.",
      "created_at" : "2012-05-16T23:30:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5754849",
      "id" : 5754849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-16T23:30:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5754849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Collapsed multiple commits into two.  A couple minor cleanups.",
      "created_at" : "2012-05-17T02:13:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5756821",
      "id" : 5756821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1198",
      "updated_at" : "2012-05-17T02:13:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5756821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   }
]
