{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Fixes #23852\r\n\r\nThis allows pruning to work during the `-loadblock` import process.\r\n\r\nAn example use case is where you have a clean set of block files and you want to create a pruned node from them, but you don't want to alter the input set of block files.\r\n\r\n#23852 noted that pruning was not working reliably during the loadblock import process. The reason why the loadblock process was not pruning regularly as it progressed is that the pruning process (`BlockManager::FindFilesToPrune`) checks the tip height of the active chainstate, and `CChainState::ActivateBestChain` was not called (which updates that tip height) in `ThreadImport` until after all the import files were processed.\r\n\r\nAn example bash command line that makes it easy to import a bunch of block files:\r\n```\r\n./src/qt/bitcoin-qt -debug -logthreadnames -datadir=/tmp/btc -prune=550 -loadblock=/readonly/btc/main/blk{00000..00043}.dat\r\n```\r\n\r\nOne interesting side note is that `CChainState::ActivateBestChain` can be called while the import process is running (in the `loadblk` thread) by concurrent network message processing activity in the `msghand` thread. For example, one way to reproduce this easily is with the `getblockfrompeer` RPC (requesting a block with height greater than 100000) run from a node connected to an importing node. There are other ways too, but this is an easy way. I only mention this to explain how the `max_prune_height=225719` log message in the original issue came to occur.",
   "closed_at" : "2022-06-15T11:23:26Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
      "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mruddy/followers",
      "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mruddy",
      "id" : 6440430,
      "login" : "mruddy",
      "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
      "organizations_url" : "https://api.github.com/users/mruddy/orgs",
      "received_events_url" : "https://api.github.com/users/mruddy/received_events",
      "repos_url" : "https://api.github.com/users/mruddy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mruddy"
   },
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957/comments",
   "created_at" : "2022-04-24T12:33:06Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24957",
   "id" : 1213642052,
   "labels" : [
      {
         "color" : "6060aa",
         "default" : false,
         "description" : null,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5842rtlq",
   "number" : 24957,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24957.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24957",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24957.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24957"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957/timeline",
   "title" : "prune, import: allow pruning to work during loadblock import",
   "updated_at" : "2022-06-15T11:23:26Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24957",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
      "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mruddy/followers",
      "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mruddy",
      "id" : 6440430,
      "login" : "mruddy",
      "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
      "organizations_url" : "https://api.github.com/users/mruddy/orgs",
      "received_events_url" : "https://api.github.com/users/mruddy/received_events",
      "repos_url" : "https://api.github.com/users/mruddy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mruddy"
   }
}
