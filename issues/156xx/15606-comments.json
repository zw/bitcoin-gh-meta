[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [MarcoFalke](https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-487166998), [Sjors](https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-487289941) |\n| Approach ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-714340245) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27576](https://github.com/bitcoin/bitcoin/pull/27576) (kernel: Remove args, chainparams, chainparamsbase from kernel library by TheCharlatan)\n* [#27570](https://github.com/bitcoin/bitcoin/pull/27570) (refactor: Remove need to pass chainparams to BlockManager methods by MarcoFalke)\n* [#27491](https://github.com/bitcoin/bitcoin/pull/27491) (refactor: Move chain constants to the util library by TheCharlatan)\n* [#27357](https://github.com/bitcoin/bitcoin/pull/27357) (validation: Move warningcache to ChainstateManager and rename to m_warningcache by dimitaracev)\n* [#27277](https://github.com/bitcoin/bitcoin/pull/27277) (Move log messages: tx enqueue to mempool, allocation to blockstorage by Sjors)\n* [#27125](https://github.com/bitcoin/bitcoin/pull/27125) (refactor, kernel: Decouple ArgsManager from blockstorage by TheCharlatan)\n* [#27039](https://github.com/bitcoin/bitcoin/pull/27039) (blockstorage: do not flush block to disk if it is already there by pinheadmz)\n* [#27008](https://github.com/bitcoin/bitcoin/pull/27008) (assumeutxo: keep cache when flushing snapshot (#17487 followup) by jamesob)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (refactor: Make `CCheckQueue` RAII-styled by hebasto)\n* [#26045](https://github.com/bitcoin/bitcoin/pull/26045) (rpc: Optimize serialization disk space of dumptxoutset by aureleoules)\n* [#25977](https://github.com/bitcoin/bitcoin/pull/25977) (refactor: Replace `std::optional<bilingual_str>` with `util::Result` by ryanofsky)\n* [#25970](https://github.com/bitcoin/bitcoin/pull/25970) (Add headerssync tuning parameters optimization script to repo by sipa)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#25193](https://github.com/bitcoin/bitcoin/pull/25193) (indexes: Read the locator's top block during init, allow interaction with reindex-chainstate by mzumsande)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2019-03-15T15:07:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-473322663",
      "id" : 473322663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MzMyMjY2Mw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473322663/reactions"
      },
      "updated_at" : "2023-05-05T10:19:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473322663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Presumably the snapshot would be taken relatively close to the current tip but far enough away to avoid meaningful reorgs, say 10,000 blocks deep.\r\n\r\nTo be clear, the snapshot can't be terribly recent for the user of it or it breaks the security model. Assume valid only has any security at all if there is time for the review and communication about review to happen, which means a human timescale of at least weeks.\r\n\r\nProbably the assumption should be that snapshots are created pretty close to tip, just far enough to avoid wasting time in reorgs (even 6 blocks would be fine) but the users aren't using them until they are quite a bit older, likely using the second to most recent available one.\r\n\r\n> We don't serve blocks or transactions to the network while we're operating with an unvalidated snapshot-based chain.\r\n\r\nWe shouldn't do that.  The worst that getting it wrong does is getting us disconnected from peers, which isn't particularly cosmic (and at least we might notice that something is going wrong).  The downside of it is that not forwarding transactions shoots our privacy in the head, since any transaction we're emitting would be one we created.\r\n\r\n> When we attempt to load a wallet with a BestBlock locator lower than the base of a snapshot and the snapshot has not yet been validated, we refuse to load the wallet.\r\n\r\nSounds good.\r\n\r\n>  compare it with the claimed hash in the snapshot metadata.\r\n\r\nThis is a zero security approach.  You can't just ask the user for a value and then accept that. The attack is to reorg the chain and then announce to everyone that there is a node bug and you need to run this command to continue, we specifically engineered out that possibility in assumevalid.  This isn't hypothetical, this is exactly what we've seen happen in ethereum w/ fastsync.\r\n\r\nThis is a fine setup for testing your PR however!    Ultimately we should get it to a state where a (FEC-split) copy of the state is loaded from the network and where it can be tested against a publicly reviewed constants configured in the software and/or blockchain.",
      "created_at" : "2019-03-15T19:39:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-473416823",
      "id" : 473416823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MzQxNjgyMw==",
      "updated_at" : "2019-03-15T19:39:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473416823",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Probably the assumption should be that snapshots are created pretty close to tip, just far enough to avoid wasting time in reorgs (even 6 blocks would be fine) but the users aren't using them until they are quite a bit older, likely using the second to most recent available one.\r\n\r\nYep - I figured that we'd update the assumeutxo hash in lockstep with assumevalid's.\r\n\r\n> We shouldn't do that. The worst that getting it wrong does is getting us disconnected from peers, which isn't particularly cosmic (and at least we might notice that something is going wrong). The downside of it is that not forwarding transactions shoots our privacy in the head [...]\r\n\r\nGood points, will fix that.\r\n\r\n> This is a zero security approach. You can't just ask the user for a value and then accept that.\r\n\r\nAgreed - the check I do there is just for sanity. Deciding on an initial hardcoded `assumeutxo` hash seems corequisite to allowing snapshots to be loadable through RPC (or any other means).\r\n",
      "created_at" : "2019-03-19T14:11:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-474387827",
      "id" : 474387827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NDM4NzgyNw==",
      "updated_at" : "2019-03-19T14:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/474387827",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-03-21T08:25:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-475144784",
      "id" : 475144784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTE0NDc4NA==",
      "updated_at" : "2019-03-21T08:25:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475144784",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There are so many code changes here, and it seems like 80% of them are just renames. I know you are putting off really breaking this up and restructuring it, but maybe you could start by just splitting b2a735d00d3c297cdfdd93609c12537497025ca1 in two commits: one that adds the new classes and function arguments and brute force renames without changing behavior, and a smaller one with the new functionality. That way reviewers could see the more interesting changes without having to go through all the mind-numbing renames.",
      "created_at" : "2019-03-26T19:39:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-476815777",
      "id" : 476815777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NjgxNTc3Nw==",
      "updated_at" : "2019-03-26T19:39:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/476815777",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the suggestion, @ryanofsky. I spent the last few days reconstructing the changeset into sensible commits - hopefully it's easier to understand this way.\r\n\r\nMost of the early commits are just shuffling stuff around (though all of it strictly necessary AFAICT). I've phrased the changes as much as possible as scripted-diffs and move-onlys. In replaying the changes, I found a few unnecessary diffs to omit.\r\n\r\nIf anyone has additional suggestions for how this could be made easier to review, I'm all ears, though I'm not holding my breath waiting until some Concept (N)ACKs roll in on #15605. ",
      "created_at" : "2019-03-30T01:41:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-478194695",
      "id" : 478194695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODE5NDY5NQ==",
      "updated_at" : "2019-03-30T01:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478194695",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r270963373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270963373"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-only: make the CChainState interface public\" (77e5c902168ca2191448c5f8924b6831dc2717b9)\r\n\r\nBetter to drop anonymous namespace. It doesn't actually hide any functionality and causes warnings:\r\n\r\n```\r\n./validation.h:487:7: warning: âCChainStateâ has a field âCChainState::setBlockIndexCandidatesâ whose type uses the anonymous namespace [-Wsubobject-linkage]\r\n```\r\n",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-01T17:03:11Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r270963373",
      "id" : 270963373,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDk2MzM3Mw==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_line" : 451,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270963373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271006988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271006988"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: introduce unused ChainActive()\" (b5627060df9c7876d91391e34c84a7e4fb1ff378)\r\n\r\nLine seems unrelated to this commit. Maybe move to commit that first uses this.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-01T18:59:57Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_mai\n /** The currently-connected chain of blocks (protected by cs_main). */\n extern CChain& chainActive;\n \n+extern CChainState g_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271006988",
      "id" : 271006988,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAwNjk4OA==",
      "original_commit_id" : "b5627060df9c7876d91391e34c84a7e4fb1ff378",
      "original_line" : 617,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271006988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271010773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271010773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: introduce ChainstateActive()\" (612d1b5df556eb70eb5fb670d166a1d7927e6efc)\r\n\r\nThis is returning a pointer, but none of the places calling it are checking null, so it seems like it'd be better to return a reference instead. Also would make `ChainstateActive()` more consistent with `ChainActive()`",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-01T19:10:52Z",
      "diff_hunk" : "@@ -60,6 +60,8 @@\n \n CChainState g_chainstate;\n \n+CChainState* ChainstateActive() { return &g_chainstate; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271010773",
      "id" : 271010773,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxMDc3Mw==",
      "original_commit_id" : "612d1b5df556eb70eb5fb670d166a1d7927e6efc",
      "original_line" : 63,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271010773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271014661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271014661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does `CBlockIndexWorkComparator` have to be in the header or would it be sufficient to forward declare and put the implementation in the cpp file only?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-01T19:22:48Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271014661",
      "id" : 271014661,
      "in_reply_to_id" : 270963373,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxNDY2MQ==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_line" : 451,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221299363,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271014661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271018669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271018669"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It has to be in the header because it affects the layout of the CChainState object.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-01T19:34:55Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271018669",
      "id" : 271018669,
      "in_reply_to_id" : 270963373,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxODY2OQ==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_line" : 451,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221304557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271018669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271434904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271434904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: FlushStateToDisk -> CChainState\" (c9d13d26314e2368562a1612bc0c89f3099c4154)\r\n\r\nCould keep this comment, I think it applies to the whole block of function declarations.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T18:16:44Z",
      "diff_hunk" : "@@ -158,15 +158,6 @@ std::unique_ptr<CCoinsViewDB> pcoinsdbview;\n std::unique_ptr<CCoinsViewCache> pcoinsTip;\n std::unique_ptr<CBlockTreeDB> pblocktree;\n \n-enum class FlushStateMode {\n-    NONE,\n-    IF_NEEDED,\n-    PERIODIC,\n-    ALWAYS\n-};\n-\n-// See definition for documentation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271434904",
      "id" : 271434904,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQzNDkwNA==",
      "original_commit_id" : "c9d13d26314e2368562a1612bc0c89f3099c4154",
      "original_line" : 201,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271434904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271440899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271440899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: FlushStateToDisk -> CChainState\" (c9d13d26314e2368562a1612bc0c89f3099c4154)\r\n\r\nI think it'd be better not to have these default parameters and chain guessing code:\r\n\r\n```c++\r\nif (!chainstate) {\r\n    chainstate = ::ChainstateActive();\r\n}\r\n```\r\n\r\nIt seems like choosing a chain implicitly makes the call sites less straightforward, and increases the risk of a bug due to using the wrong chain.\r\n\r\nAlso, I don't think having these defaults arguments would be a good idea even if they made the diff smaller, but I think they might actually make it bigger, since these functions aren't called very many places.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T18:31:26Z",
      "diff_hunk" : "@@ -290,9 +291,9 @@ void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n \n /** Flush all state, indexes and buffers to disk. */\n-void FlushStateToDisk();\n+void FlushStateToDisk(CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271440899",
      "id" : 271440899,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQ0MDg5OQ==",
      "original_commit_id" : "c9d13d26314e2368562a1612bc0c89f3099c4154",
      "original_line" : 294,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271440899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271504421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271504421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: IsInitialBlockDownload -> CChainState\" (e9fab103e6f81cf32b09618ea9a70540616f7da8)\r\n\r\nWould call this `m_cached_in_ibd` or something to indicate the value may not be up to date. I could imagine incorrect code that checks `m_in_ibd` when it should be calling `IsInitialBlockDownload` instead. Calling this \"cached\" would make the bug more obvious. \r\n\r\nCould also update the comment above to suggest calling IsInitialBlockDownload instead of accessing this variable.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T21:33:04Z",
      "diff_hunk" : "@@ -540,6 +538,14 @@ class CChainState {\n      */\n     CCriticalSection m_cs_chainstate;\n \n+    /**\n+     * Is this chainstate undergoing initial block download?\n+     *\n+     * Mutable because we need to be able to mark IsInitialBlockDownload()\n+     * const, which toggles this for caching purposes.\n+     */\n+    mutable std::atomic<bool> m_is_ibd;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271504421",
      "id" : 271504421,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNDQyMQ==",
      "original_commit_id" : "e9fab103e6f81cf32b09618ea9a70540616f7da8",
      "original_line" : 547,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271504421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271506825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271506825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nI think this comment makes more sense in the place where it was written previously (in class definition rather than in GetCoin method implementation).",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T21:40:59Z",
      "diff_hunk" : "@@ -258,3 +258,21 @@ const Coin& AccessByTxid(const CCoinsViewCache& view, const uint256& txid)\n     }\n     return coinEmpty;\n }\n+\n+bool CCoinsViewErrorCatcher::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    try {\n+        return CCoinsViewBacked::GetCoin(outpoint, coin);\n+    } catch(const std::runtime_error& e) {\n+        for (auto f : m_err_callbacks) {\n+            f();\n+        }\n+        LogPrintf(\"Error reading from database: %s\\n\", e.what());\n+        // Starting the shutdown sequence and returning false to the caller would be\n+        // interpreted as 'entry not found' (as opposed to unable to read data), and\n+        // could lead to invalid interpretation. Just exit immediately, as we can't\n+        // continue anyway, and all writes should be atomic.\n+        std::abort();\n+    }\n+\n+    // Writes do not need similar protection, as failure to write is handled by the caller.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271506825",
      "id" : 271506825,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNjgyNQ==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_line" : 277,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271506825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271507466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271507466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nSpacing seems off, maybe use clang-format for the new code.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T21:43:04Z",
      "diff_hunk" : "@@ -311,4 +313,28 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction& tx, int nHeight, bool\n //! lookups to database, so it should be used with care.\n const Coin& AccessByTxid(const CCoinsViewCache& cache, const uint256& txid);\n \n+/**\n+ * This is a minimally invasive approach to shutdown on LevelDB read errors from the\n+ * chainstate, while keeping user interface out of the common library, which is shared\n+ * between bitcoind, and bitcoin-qt and non-server tools.\n+*/\n+class CCoinsViewErrorCatcher final : public CCoinsViewBacked\n+{\n+public:\n+    typedef std::function<void()> Function;\n+\n+    explicit CCoinsViewErrorCatcher(CCoinsView* view) : CCoinsViewBacked(view) {}\n+\n+    void AddReadErrCallback(const Function f) {\n+      m_err_callbacks.push_back(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271507466",
      "id" : 271507466,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNzQ2Ng==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_line" : 329,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271507466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271508985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271508985"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nNot a big deal, but it would be nice to avoid copies:\r\n\r\n```\r\nvoid AddReadErrCallback(Function f) {\r\n    m_err_callbacks.emplace_back(std::move(f));\r\n}\r\n```",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T21:48:04Z",
      "diff_hunk" : "@@ -311,4 +313,28 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction& tx, int nHeight, bool\n //! lookups to database, so it should be used with care.\n const Coin& AccessByTxid(const CCoinsViewCache& cache, const uint256& txid);\n \n+/**\n+ * This is a minimally invasive approach to shutdown on LevelDB read errors from the\n+ * chainstate, while keeping user interface out of the common library, which is shared\n+ * between bitcoind, and bitcoin-qt and non-server tools.\n+*/\n+class CCoinsViewErrorCatcher final : public CCoinsViewBacked\n+{\n+public:\n+    typedef std::function<void()> Function;\n+\n+    explicit CCoinsViewErrorCatcher(CCoinsView* view) : CCoinsViewBacked(view) {}\n+\n+    void AddReadErrCallback(const Function f) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271508985",
      "id" : 271508985,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwODk4NQ==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_line" : 328,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271508985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271513853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271513853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata into BlockMetadataManager\" (155ee896520e51b8a13d6904e3a14b5fa50295c0)\r\n\r\nIt seems like a step backwards to be replacing a local reference with a global reference. I get that BlockMetadataManager is a singleton shared between multiple chainstates, but I think it's a mistake to add global references to it all over the code. If you could add a `BlockMetadataManager& m_blockmetaman` member to CChainState (also needs forward declaration and initialization in constructor), and replace \r\n`g_blockmetaman` with `m_blockmetaman` where possible, I think it would help make relationship between the classes clearer, and also be a step in the direction of making validation code more testable and possible to break apart.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-02T22:04:54Z",
      "diff_hunk" : "@@ -1148,7 +1209,7 @@ void static InvalidChainFound(CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(c\n void CChainState::InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state) {\n     if (!state.CorruptionPossible()) {\n         pindex->nStatus |= BLOCK_FAILED_VALID;\n-        m_failed_blocks.insert(pindex);\n+        g_blockmetaman.m_failed_blocks.insert(pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271513853",
      "id" : 271513853,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUxMzg1Mw==",
      "original_commit_id" : "155ee896520e51b8a13d6904e3a14b5fa50295c0",
      "original_line" : 1212,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271513853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-03T17:19:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-479580954",
      "id" : 479580954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTU4MDk1NA==",
      "updated_at" : "2019-04-03T17:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479580954",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271901526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271901526"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: have CCoins* data managed under CChainState\" (525df322de8e6803f41a56aff16bfc1ebe95f845)\r\n\r\nI don't see any problems with this change, but it seems strange that previous code called pcoinsdbview.reset() and pcoinscatcher.reset() above, and then reset them again here, when it could have just set them once above like this commit is doing now.\r\n\r\nJust asking for reassurance that previous code didn't intentionally reset these twice, since now they're only set once.\r\n\r\nI guess this is ok assuming `fReset || fReindexChainState` has the same value above?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T19:41:02Z",
      "diff_hunk" : "@@ -1501,33 +1505,23 @@ bool AppInitMain(InitInterfaces& interfaces)\n                 // At this point we're either in reindex or we've loaded a useful\n                 // block tree into mapBlockIndex!\n \n-                pcoinsdbview.reset(new CCoinsViewDB(nCoinDBCache, false, fReset || fReindexChainState));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271901526",
      "id" : 271901526,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkwMTUyNg==",
      "original_commit_id" : "525df322de8e6803f41a56aff16bfc1ebe95f845",
      "original_line" : 1521,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271901526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271905870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271905870"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: have CCoins* data managed under CChainState\" (525df322de8e6803f41a56aff16bfc1ebe95f845)\r\n\r\nNote: I was confused why `init.cpp` seemed to sometimes use `::ChainstateActive()->` and other places use `g_chainstate.` for apparently no reason. I think I would have preferred using `g_chainstate.` in the init.cpp file consistently and reserving `ChainstateActive` for network and validation code. But I think it doesn't matter ultimately because `g_chainstate` is replaced in a later commit by `g_chainman`.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T19:52:59Z",
      "diff_hunk" : "@@ -228,7 +226,7 @@ void Shutdown(InitInterfaces& interfaces)\n     }\n \n     // FlushStateToDisk generates a ChainStateFlushed callback, which we should avoid missing\n-    if (pcoinsTip != nullptr) {\n+    if (::ChainstateActive()->CoinsCache() != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271905870",
      "id" : 271905870,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkwNTg3MA==",
      "original_commit_id" : "525df322de8e6803f41a56aff16bfc1ebe95f845",
      "original_line" : 229,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271905870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271910014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271910014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: have CCoins* data managed under CChainState\" (525df322de8e6803f41a56aff16bfc1ebe95f845)\r\n\r\nMinor point, but I like the old name `CoinsTip` better than the new name `CoinsCache`. Just imagining seeing this code for the first time, I would expect the \"db\" object to be the object I should be reading and writing state to, and the \"cache\" object to be something used for optimization that I shouldn't mess around with.\r\n\r\nIn reality though, almost all code should be using the \"cache\" object and ignoring the \"db\" object, so I think \"cache\" is not a great name and \"tip\" would be better shorthand because this is the view you should be using if you care about data at the state of the tip.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:04:51Z",
      "diff_hunk" : "@@ -520,21 +545,40 @@ class CChainState {\n      */\n     mutable std::atomic<bool> m_is_ibd;\n \n+    //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n+    std::unique_ptr<CoinsViews> m_coins_views;\n+\n public:\n+    CChainState(\n+        /* parameters forwarded to CoinsViews */\n+        size_t cache_size_bytes,\n+        bool in_memory,\n+        bool should_wipe,\n+        std::string leveldb_name = \"chainstate\"\n+        ) : m_is_ibd(false)\n+    {\n+        m_coins_views.reset(new CoinsViews(\n+            leveldb_name, cache_size_bytes, in_memory, should_wipe));\n+    }\n+\n     /**\n      * The current chain of blockheaders we consult and build on.\n      *\n      * @see CChain, CBlockIndex.\n      */\n     CChain m_chain;\n+\n     /**\n      * The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS (for itself and all ancestors) and\n      * as good as our current tip or better. Entries may be failed, though, and pruning nodes may be\n      * missing the data for the block.\n      */\n     std::set<CBlockIndex*, CBlockIndexWorkComparator> setBlockIndexCandidates;\n \n-    CBlockIndex *pindexBestInvalid = nullptr;\n+    CCoinsViewCache* CoinsCache() { return m_coins_views->m_cacheview.get(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271910014",
      "id" : 271910014,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxMDAxNA==",
      "original_commit_id" : "525df322de8e6803f41a56aff16bfc1ebe95f845",
      "original_line" : 669,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271910014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271911197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271911197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: have CCoins* data managed under CChainState\" (525df322de8e6803f41a56aff16bfc1ebe95f845)\r\n\r\nI think these three functions should be returning references instead of pointers, and maybe asserting the underlying unique_ptrs are set, since no callers are ever checking to see if the pointers are null.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:08:19Z",
      "diff_hunk" : "@@ -520,21 +545,40 @@ class CChainState {\n      */\n     mutable std::atomic<bool> m_is_ibd;\n \n+    //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n+    std::unique_ptr<CoinsViews> m_coins_views;\n+\n public:\n+    CChainState(\n+        /* parameters forwarded to CoinsViews */\n+        size_t cache_size_bytes,\n+        bool in_memory,\n+        bool should_wipe,\n+        std::string leveldb_name = \"chainstate\"\n+        ) : m_is_ibd(false)\n+    {\n+        m_coins_views.reset(new CoinsViews(\n+            leveldb_name, cache_size_bytes, in_memory, should_wipe));\n+    }\n+\n     /**\n      * The current chain of blockheaders we consult and build on.\n      *\n      * @see CChain, CBlockIndex.\n      */\n     CChain m_chain;\n+\n     /**\n      * The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS (for itself and all ancestors) and\n      * as good as our current tip or better. Entries may be failed, though, and pruning nodes may be\n      * missing the data for the block.\n      */\n     std::set<CBlockIndex*, CBlockIndexWorkComparator> setBlockIndexCandidates;\n \n-    CBlockIndex *pindexBestInvalid = nullptr;\n+    CCoinsViewCache* CoinsCache() { return m_coins_views->m_cacheview.get(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271911197",
      "id" : 271911197,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxMTE5Nw==",
      "original_commit_id" : "525df322de8e6803f41a56aff16bfc1ebe95f845",
      "original_line" : 669,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271911197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271912920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271912920"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-only: move coins statistics utils out of RPC\" (56ad8d226539a44daef02f479fab1820c536731f)\r\n\r\nMaybe preserve the original copyright right years if you are moving existing code to a new file.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:13:14Z",
      "diff_hunk" : "@@ -0,0 +1,73 @@\n+// Copyright (c) 2019 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271912920",
      "id" : 271912920,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxMjkyMA==",
      "original_commit_id" : "56ad8d226539a44daef02f479fab1820c536731f",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271912920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271915175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271915175"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validationinterface: add unused CChainState parameter\" (0b33ff5bcba7f2aa357a1a12fe1e1452c23defb7)\r\n\r\nWill these new chainstate parameters ever be null? Is any implementation ever going to check that they are not null before using them? Would suggest changing to `const CChainState& chainstate` to avoid mishaps otherwise.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:19:35Z",
      "diff_hunk" : "@@ -86,7 +87,11 @@ class CValidationInterface {\n      *\n      * Called on a background thread.\n      */\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n+    virtual void UpdatedBlockTip(\n+        const CChainState* chainstate,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271915175",
      "id" : 271915175,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxNTE3NQ==",
      "original_commit_id" : "0b33ff5bcba7f2aa357a1a12fe1e1452c23defb7",
      "original_line" : 91,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271915175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271916764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271916764"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"chain: add unused CChain::FakeNTx\" (ebc844e8a1bacfe603db85ef4deae6e1f109cd57)\r\n\r\nNote: I don't know if this comment is true, but it _feels_ true.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:24:01Z",
      "diff_hunk" : "@@ -459,6 +459,9 @@ class CChain {\n     /** Set/initialize a chain with a given tip. */\n     void SetTip(CBlockIndex *pindex);\n \n+    /** Ensure all members of this chain have a truthy nTx/nChainTx value. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271916764",
      "id" : 271916764,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxNjc2NA==",
      "original_commit_id" : "ebc844e8a1bacfe603db85ef4deae6e1f109cd57",
      "original_line" : 462,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271916764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271917898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271917898"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"chain: add unused CChain::FakeNTx\" (ebc844e8a1bacfe603db85ef4deae6e1f109cd57)\r\n\r\nIt seems really unfortunate that this is necessary just to report progress. Are there alternative ways to change the progress function so this would not be required?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:27:24Z",
      "diff_hunk" : "@@ -20,6 +20,20 @@ void CChain::SetTip(CBlockIndex *pindex) {\n     }\n }\n \n+void CChain::FakeNTx(unsigned int nChainTx) {\n+    for (CBlockIndex* index : vChain) {\n+        if (!index->nTx) {\n+            index->nTx = 1;\n+        }\n+        index->nChainTx = index->pprev ? index->pprev->nChainTx + index->nTx : 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271917898",
      "id" : 271917898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxNzg5OA==",
      "original_commit_id" : "ebc844e8a1bacfe603db85ef4deae6e1f109cd57",
      "original_line" : 28,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271917898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271919012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271919012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add unused SnapshotMetadata class\" (50d8e7c910edec10dcf08beec577c3efd67f2276)\r\n\r\nWould add comments to describe these other fields.\r\n\r\nIn particular, I'm curious why `m_validation_complete` would be a field that gets serialized as opposed to a memory-only state.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-03T20:30:25Z",
      "diff_hunk" : "@@ -657,6 +658,46 @@ bool InvalidateBlock(CValidationState& state, const CChainParams& chainparams, C\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Serialized version of a UTXO set from which an assumed-valid CChainState\n+ * can be constructed.\n+ */\n+class SnapshotMetadata\n+{\n+public:\n+    CDiskBlockIndex m_base_blockheader;\n+    uint256 m_utxo_contents_hash = {};\n+    uint64_t m_coins_count = 0;\n+    /**\n+     * Necessary to \"fake\" the base nChainTx so that we can estimate progress during\n+     * snapshot IBD.\n+     */\n+    unsigned int m_nchaintx = 0;\n+    bool m_validation_complete = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271919012",
      "id" : 271919012,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTkxOTAxMg==",
      "original_commit_id" : "50d8e7c910edec10dcf08beec577c3efd67f2276",
      "original_line" : 846,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222413883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271919012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272220495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272220495"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add dumptxoutset\" (71a65a08213b0159d4e4df2199d9993547f163e4)\r\n\r\nDo you want to allow overwriting existing files? If so, should include a comment saying it's intentional, since this could be potentially dangerous (overwriting wallet files, etc). If not, should check `fs::exists(path)`.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T14:54:30Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272220495",
      "id" : 272220495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjIyMDQ5NQ==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2297,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272220495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272223330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272223330"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add dumptxoutset\" (71a65a08213b0159d4e4df2199d9993547f163e4)\r\n\r\nDo you want to allow path to be relative? If not, should error when `fs::path(path).is_relative()`. If so, should probably interpret path relative to a known location like the datadir (`fs::path path = fs::absolute(request.params[0].get_str(), GetDataDir())`), instead of relative to whatever the current directory was when starting bitcoind or bitcoin-qt.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T15:00:03Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272223330",
      "id" : 272223330,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjIyMzMzMA==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2254,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272223330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272224035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272224035"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add dumptxoutset\" (71a65a08213b0159d4e4df2199d9993547f163e4)\r\n\r\nNot sure, but it might be useful to mention if this flushes the cache.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T15:01:34Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272224035",
      "id" : 272224035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjIyNDAzNQ==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2245,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272224035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272226729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272226729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add dumptxoutset\" (71a65a08213b0159d4e4df2199d9993547f163e4)\r\n\r\nCan you add a comment about synchronization and atomicity here. It's unclear why it's safe to do all this without locking cs_main. Or is this assuming that another flush won't happen in the background?\r\n\r\nAlso, is it ok for this and `GetUTXOStats` to be using different cursor objects?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T15:07:17Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272226729",
      "id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjIyNjcyOQ==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272226729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272308326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272308326"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add dumptxoutset\" (71a65a08213b0159d4e4df2199d9993547f163e4)\r\n\r\nIt is strange to return a formatted string from an RPC. Would seem better to return something structured like `{\"coins_written\": stats.coins_count}`",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T18:24:07Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;\n+            afile << coin;\n+        }\n+\n+        pcursor->Next();\n+    }\n+\n+    afile.fclose();\n+    return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272308326",
      "id" : 272308326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMwODMyNg==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2295,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272308326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272311275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272311275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: add CChainState::ActivateBestChain\" (deca3be21d35ca661e047512f74c805ee24ecb16)\r\n\r\nCommit description is misleading. This commit is only documenting the method, not adding it. And I guess it is making the last block argument optional.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T18:32:07Z",
      "diff_hunk" : "@@ -596,7 +596,16 @@ class CChainState {\n         FlushStateMode mode,\n         int nManualPruneHeight = 0);\n \n-    bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams, std::shared_ptr<const CBlock> pblock);\n+     /**\n+      * Find the best known block, and make it the tip of the block chain\n+      *\n+      * May not be called with cs_main held. May not be called in a\n+      * validationinterface callback.\n+      */\n+    bool ActivateBestChain(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272311275",
      "id" : 272311275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMxMTI3NQ==",
      "original_commit_id" : "deca3be21d35ca661e047512f74c805ee24ecb16",
      "original_line" : 748,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272311275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272311784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272311784"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: add CChainState::ActivateBestChain\" (deca3be21d35ca661e047512f74c805ee24ecb16)\r\n\r\nIt's not clear from this description what the block argument does.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T18:33:29Z",
      "diff_hunk" : "@@ -596,7 +596,16 @@ class CChainState {\n         FlushStateMode mode,\n         int nManualPruneHeight = 0);\n \n-    bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams, std::shared_ptr<const CBlock> pblock);\n+     /**\n+      * Find the best known block, and make it the tip of the block chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272311784",
      "id" : 272311784,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMxMTc4NA==",
      "original_commit_id" : "deca3be21d35ca661e047512f74c805ee24ecb16",
      "original_line" : 713,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272311784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272314847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272314847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"trivial: add CChainState::ToString()\" (10973e8e1dfd1951a98bf0de4c98b8cee385d70d)\r\n\r\n`m_from_snapshot_blockhash` variable isn't introduced yet, so this doesn't compile",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T18:41:32Z",
      "diff_hunk" : "@@ -4593,6 +4593,14 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     assert(nNodes == forward.size());\n }\n \n+std::string CChainState::ToString()\n+{\n+    CBlockIndex* tip = m_chain.Tip();\n+    return tfm::format(\"Chainstate [%s] @ height %d (%s)\",\n+        m_from_snapshot_blockhash.IsNull() ? \"ibd\" : \"snapshot\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272314847",
      "id" : 272314847,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMxNDg0Nw==",
      "original_commit_id" : "10973e8e1dfd1951a98bf0de4c98b8cee385d70d",
      "original_line" : 5088,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272314847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272317689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272317689"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata into BlockMetadataManager\" (155ee896520e51b8a13d6904e3a14b5fa50295c0)\r\n\r\nThis commit causes some lock annotation errors:\r\n\r\n```\r\n  CXX      libbitcoin_server_a-validation.o\r\nvalidation.cpp:114:48: error: reading variable 'm_block_index' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n        for (const BlockMap::value_type& entry : m_block_index) {\r\n                                               ^\r\nvalidation.cpp:114:48: error: reading variable 'm_block_index' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\nvalidation.cpp:118:9: error: reading variable 'm_block_index' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n        m_block_index.clear();\r\n        ^\r\nvalidation.cpp:3725:29: error: reading variable 'mapBlockIndex' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n    vSortedByHeight.reserve(mapBlockIndex.size());\r\n                            ^\r\nvalidation.cpp:3726:61: error: reading variable 'mapBlockIndex' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n    for (const std::pair<const uint256, CBlockIndex*>& item : mapBlockIndex)\r\n                                                            ^\r\nvalidation.cpp:3726:61: error: reading variable 'mapBlockIndex' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n6 errors generated.\r\nMakefile:7627: recipe for target 'libbitcoin_server_a-validation.o' failed\r\n```",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T18:48:55Z",
      "diff_hunk" : "@@ -64,6 +64,72 @@ CChainState* ChainstateActive() { return &g_chainstate; }\n \n CChain& ChainActive() { return g_chainstate.m_chain; }\n \n+/**\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n+ *\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockMetadataManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+public:\n+    /*\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n+     * Pruned nodes may have entries where B is missing data.\n+     */\n+    std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n+\n+    CBlockIndex *m_pindex_best_invalid = nullptr;\n+\n+    bool LoadBlockIndex(const Consensus::Params& consensus_params, CBlockTreeDB& blocktree);\n+\n+    void Unload() {\n+        m_failed_blocks.clear();\n+        m_blocks_unlinked.clear();\n+        m_pindex_best_invalid = nullptr;\n+\n+        for (const BlockMap::value_type& entry : m_block_index) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272317689",
      "id" : 272317689,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMxNzY4OQ==",
      "original_commit_id" : "155ee896520e51b8a13d6904e3a14b5fa50295c0",
      "original_line" : 114,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272317689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272322784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272322784"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271916764\r\n\r\nNow I'm confused about this comment. I thought it meant truthy in the Colbert sense (https://en.wikipedia.org/wiki/Truthiness). But that doesn't work where truthy is used later in https://github.com/bitcoin/bitcoin/commit/8d9b707f609b647fb28ae182a097adc03e718725#diff-349fbb003d5ae550a2e8fa658e475880R777. Since this is C++, it would probably be clearer to say \"non-zero\" here and \"non-null\" there, if that's what is meant.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T19:02:43Z",
      "diff_hunk" : "@@ -459,6 +459,9 @@ class CChain {\n     /** Set/initialize a chain with a given tip. */\n     void SetTip(CBlockIndex *pindex);\n \n+    /** Ensure all members of this chain have a truthy nTx/nChainTx value. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272322784",
      "id" : 272322784,
      "in_reply_to_id" : 271916764,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMyMjc4NA==",
      "original_commit_id" : "ebc844e8a1bacfe603db85ef4deae6e1f109cd57",
      "original_line" : 462,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272322784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272323444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272323444"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager, use in init\" (8d9b707f609b647fb28ae182a097adc03e718725)\r\n\r\nProbably clearer to say \"set\" or \"non-null\" here instead of \"truthy\".",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T19:04:42Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * This class was created to displace the use of global variables (e.g.\n+ * chainActive) which were historically used to reference a single active\n+ * chainstate throughout the codebase.\n+ *\n+ * TODO jamesob: basically everything in this class is implicitly covered\n+ *   by `cs_main`. Should probably put some more formalization around\n+ *   locking and maybe add a class-local `cs` CCriticalSection.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    /**\n+     * Temporary holding place for a snapshot chainstate which is in the process of\n+     * being constructed. When ready, we swap with `m_snapshot_chainstate`.\n+     */\n+    std::unique_ptr<CChainState> m_unready_snapshot_chainstate;\n+\n+    /**\n+     * If not empty, this points to metadata corresponding to the UTXO snapshot\n+     * currently in use.\n+     */\n+    std::unique_ptr<SnapshotMetadata> m_snapshot_metadata;\n+\n+    /**\n+     * The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+     * if a snapshot is in use, for background validation. Its contents will\n+     * be freed when background validation of the snapshot has completed.\n+     */\n+    std::unique_ptr<CChainState> m_ibd_chainstate GUARDED_BY(cs_main);\n+\n+    /**\n+     * A chainstate initialized on the basis of a UTXO snapshot. If this is\n+     * truthy, it is always our active chainstate unless proven invalid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272323444",
      "id" : 272323444,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMyMzQ0NA==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 899,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272323444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272325190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272325190"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager, use in init\" (8d9b707f609b647fb28ae182a097adc03e718725)\r\n\r\nWould drop this. Referencing historical variables in commit and review comments is helpful, but confusing in code comments. If this is supposed to suggest that there are still weird things about the code that could be cleaned up in the future, it would probably be better to say directly what the current problems are and how they might be addressed.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T19:08:55Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * This class was created to displace the use of global variables (e.g.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272325190",
      "id" : 272325190,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMyNTE5MA==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 867,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272325190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272326477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272326477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager, use in init\" (8d9b707f609b647fb28ae182a097adc03e718725)\r\n\r\nIs this supposed to be public? Maybe mention why in comment if so.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T19:12:06Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * This class was created to displace the use of global variables (e.g.\n+ * chainActive) which were historically used to reference a single active\n+ * chainstate throughout the codebase.\n+ *\n+ * TODO jamesob: basically everything in this class is implicitly covered\n+ *   by `cs_main`. Should probably put some more formalization around\n+ *   locking and maybe add a class-local `cs` CCriticalSection.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    /**\n+     * Temporary holding place for a snapshot chainstate which is in the process of\n+     * being constructed. When ready, we swap with `m_snapshot_chainstate`.\n+     */\n+    std::unique_ptr<CChainState> m_unready_snapshot_chainstate;\n+\n+    /**\n+     * If not empty, this points to metadata corresponding to the UTXO snapshot\n+     * currently in use.\n+     */\n+    std::unique_ptr<SnapshotMetadata> m_snapshot_metadata;\n+\n+    /**\n+     * The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+     * if a snapshot is in use, for background validation. Its contents will\n+     * be freed when background validation of the snapshot has completed.\n+     */\n+    std::unique_ptr<CChainState> m_ibd_chainstate GUARDED_BY(cs_main);\n+\n+    /**\n+     * A chainstate initialized on the basis of a UTXO snapshot. If this is\n+     * truthy, it is always our active chainstate unless proven invalid.\n+     */\n+    std::unique_ptr<CChainState> m_snapshot_chainstate GUARDED_BY(cs_main);\n+\n+public:\n+    /**\n+     * Points to either the ibd or snapshot chainstate; indicates our\n+     * most-work chain.\n+     */\n+    CChainState* m_active_chainstate GUARDED_BY(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272326477",
      "id" : 272326477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMyNjQ3Nw==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 926,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272326477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272327897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272327897"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager, use in init\" (8d9b707f609b647fb28ae182a097adc03e718725)\r\n\r\nCan you give a little overview of what is meant by the:\r\n\r\n- unready snapshot chainstate\r\n- ibd chainstate\r\n- snapshot chainstate\r\n- active chainstate\r\n- background validation chainstate\r\n- validated chainstate\r\n\r\nI am getting more than a little lost in the terminology, and it would nice to have it defined briefly in one place.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-04T19:15:55Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272327897",
      "id" : 272327897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMyNzg5Nw==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 817,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 222816088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272327897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272728241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272728241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: IsInitialBlockDownload -> CChainState\" (e9fab103e6f81cf32b09618ea9a70540616f7da8):\r\n\r\nStyle guide prefers (and it's a little clearer) to initialize variables like this where they're declared, instead of separately in constructors. Could write `m_is_ibd = false` or `m_is_ibd{false}`",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:09:24Z",
      "diff_hunk" : "@@ -540,6 +538,14 @@ class CChainState {\n      */\n     CCriticalSection m_cs_chainstate;\n \n+    /**\n+     * Is this chainstate undergoing initial block download?\n+     *\n+     * Mutable because we need to be able to mark IsInitialBlockDownload()\n+     * const, which toggles this for caching purposes.\n+     */\n+    mutable std::atomic<bool> m_is_ibd;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272728241",
      "id" : 272728241,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjcyODI0MQ==",
      "original_commit_id" : "e9fab103e6f81cf32b09618ea9a70540616f7da8",
      "original_line" : 547,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272728241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272731017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272731017"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::ActivateSnapshot\" (9b6907e080fe4da105a332c76ddb5110310e8840)\r\n\r\nIt would seem better to drop the comment and just assert, or return an error if this is not the case.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:19:48Z",
      "diff_hunk" : "@@ -4872,6 +4872,136 @@ CChainState* ChainstateManager::InitializeChainstate(\n     return to_modify.get();\n }\n \n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        size_t cache_size_bytes,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockheader.GetBlockHash();\n+\n+    // Important that we haven't set `m_snapshot_metadata` yet before this point.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272731017",
      "id" : 272731017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczMTAxNw==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 4883,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272731017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272732427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272732427"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::ActivateSnapshot\" (9b6907e080fe4da105a332c76ddb5110310e8840)\r\n\r\nNot sure, but probably should use interruption_point.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:24:55Z",
      "diff_hunk" : "@@ -4872,6 +4872,136 @@ CChainState* ChainstateManager::InitializeChainstate(\n     return to_modify.get();\n }\n \n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        size_t cache_size_bytes,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockheader.GetBlockHash();\n+\n+    // Important that we haven't set `m_snapshot_metadata` yet before this point.\n+    CChainState* snapshot_chainstate = InitializeChainstate(\n+        cache_size_bytes, in_memory,\n+        /* should_wipe */ false, /* activate */ false,\n+        /* snapshot_blockhash */ base_blockhash, /* snapshot_needs_initialization */ true);\n+\n+    CCoinsViewCache* coins_cache = snapshot_chainstate->CoinsCache();\n+\n+    CCoinsMap coins_map;\n+    COutPoint outpoint;\n+    Coin coin;\n+    uint64_t coins_count = metadata.m_coins_count;\n+    uint64_t coins_left = metadata.m_coins_count;\n+\n+    LogPrintf(\"[snapshot] loading coins from snapshot %s\\n\", base_blockhash.ToString());\n+\n+    while (coins_left > 0) {\n+        *coins_file >> outpoint;\n+        *coins_file >> coin;\n+        coins_map[outpoint] = CCoinsCacheEntry(std::move(coin), CCoinsCacheEntry::DIRTY);\n+        coins_left -= 1;\n+\n+        if ((coins_count - coins_left) % 1000000 == 0) {\n+            boost::this_thread::interruption_point();\n+            LogPrintf(\"[snapshot] progress=%d\\n\", coins_count - coins_left);\n+        }\n+    }\n+\n+    bool out_of_coins{false};\n+    try {\n+        *coins_file >> outpoint;\n+    } catch (const std::ios_base::failure&) {\n+        // We expect an exception since we should be out of coins.\n+        out_of_coins = true;\n+    }\n+    if (!out_of_coins) {\n+        LogPrintf(\n+            \"[snapshot] Bad snapshot - coins left over after deserializing %d coins\\n\",\n+            coins_count - coins_left);\n+        return false;\n+    }\n+\n+    LogPrintf(\n+        \"[snapshot] loaded %d coins from snapshot %s\\n\",\n+        coins_count - coins_left, base_blockhash.ToString());\n+\n+    // No need to acquire cs_main since this chainstate isn't being used yet.\n+    coins_cache->BatchWrite(coins_map, base_blockhash);\n+    coins_cache->Flush();\n+    assert(coins_cache->GetBestBlock() == base_blockhash);\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(snapshot_chainstate->m_coins_views->m_dbview.get(), stats)) {\n+        LogPrintf(\"[snapshot] failed to generate coins stats\\n\");\n+        return false;\n+    }\n+\n+    if (stats.hashSerialized != metadata.m_utxo_contents_hash) {\n+        LogPrintf(\n+            \"[snapshot] bad snapshot content hash: expected %s, got %s\\n\",\n+            metadata.m_utxo_contents_hash.ToString(), stats.hashSerialized.ToString());\n+        return false;\n+    }\n+    if (stats.coins_count != coins_count) {\n+        LogPrintf(\n+            \"[snapshot] bad snapshot coins count: expected %d, got %d\\n\",\n+            coins_count, stats.coins_count);\n+        return false;\n+    }\n+\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272732427",
      "id" : 272732427,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczMjQyNw==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 5600,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272732427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272734025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272734025"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::ActivateSnapshot\" (9b6907e080fe4da105a332c76ddb5110310e8840)\r\n\r\nCan the comment say more about this? Will there even be anything in the mempool? Would it make sense to only drop incompatible transactions?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:30:15Z",
      "diff_hunk" : "@@ -814,6 +814,33 @@ class ChainstateManager\n     /** Run some function on all chainstates in use.  */\n     void RunOnAll(const std::function<void(CChainState*)> fn);\n \n+    /**\n+     * Construct and activate a Chainstate on the basis of UTXO snapshot data.\n+     *\n+     * Steps:\n+     *\n+     *   - Initialize an unused CChainState and stash it in\n+     *     `m_unready_snapshot_chainstate`.\n+     *\n+     *   - Load its `CoinsViews` contents from `coins_file`.\n+     *\n+     *   - Verify that the hash of the resulting coinsdb matches the expected hash\n+     *     contained in the snapshot metadata.\n+     *\n+     *   - Wait up to 10 minutes for our headers chain to include the \"base\"\n+     *     block of the snapshot.\n+     *\n+     *   - \"Fast forward\" the tip of the new chainstate to the base of the snapshot,\n+     *     faking nTx* block index data along the way.\n+     *\n+     *   - Move the new chainstate to `m_snapshot_chainstate` and make it our\n+     *     ChainstateActive().\n+     *\n+     *   - Clear the mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272734025",
      "id" : 272734025,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczNDAyNQ==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 1005,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272734025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272736054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272736054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::ActivateSnapshot\" (9b6907e080fe4da105a332c76ddb5110310e8840):\r\n\r\nI don't understand why `m_unready_snapshot_chainstate` is a class member. It seems like it should just be a local variable `auto snapshot = MakeUnique<CChainState>(...)` in this function that gets swapped in with `m_snapshot_chainstate` when it is ready below. This would simplify the class and InitializeChainstate.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:37:28Z",
      "diff_hunk" : "@@ -4872,6 +4872,136 @@ CChainState* ChainstateManager::InitializeChainstate(\n     return to_modify.get();\n }\n \n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        size_t cache_size_bytes,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockheader.GetBlockHash();\n+\n+    // Important that we haven't set `m_snapshot_metadata` yet before this point.\n+    CChainState* snapshot_chainstate = InitializeChainstate(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272736054",
      "id" : 272736054,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczNjA1NA==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 4884,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272736054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272736888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272736888"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::ActivateSnapshot\" (9b6907e080fe4da105a332c76ddb5110310e8840):\r\n\r\nMaybe add NODISCARD since this returns error on failure.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:40:27Z",
      "diff_hunk" : "@@ -814,6 +814,33 @@ class ChainstateManager\n     /** Run some function on all chainstates in use.  */\n     void RunOnAll(const std::function<void(CChainState*)> fn);\n \n+    /**\n+     * Construct and activate a Chainstate on the basis of UTXO snapshot data.\n+     *\n+     * Steps:\n+     *\n+     *   - Initialize an unused CChainState and stash it in\n+     *     `m_unready_snapshot_chainstate`.\n+     *\n+     *   - Load its `CoinsViews` contents from `coins_file`.\n+     *\n+     *   - Verify that the hash of the resulting coinsdb matches the expected hash\n+     *     contained in the snapshot metadata.\n+     *\n+     *   - Wait up to 10 minutes for our headers chain to include the \"base\"\n+     *     block of the snapshot.\n+     *\n+     *   - \"Fast forward\" the tip of the new chainstate to the base of the snapshot,\n+     *     faking nTx* block index data along the way.\n+     *\n+     *   - Move the new chainstate to `m_snapshot_chainstate` and make it our\n+     *     ChainstateActive().\n+     *\n+     *   - Clear the mempool.\n+     */\n+    bool ActivateSnapshot(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272736888",
      "id" : 272736888,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczNjg4OA==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 976,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272736888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272737578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272737578"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (f9571218d41304040778655e2f3941042b358dd5)\r\n\r\nShould throw an exception on failure.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:42:50Z",
      "diff_hunk" : "@@ -2294,6 +2295,32 @@ UniValue dumptxoutset(const JSONRPCRequest& request)\n     return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());\n }\n \n+UniValue loadtxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\"dumptxoutset\",\n+                \"\\nLoad the serialized UTXO set from disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path{request.params[0].get_str()};\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    g_chainman.ActivateSnapshot(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272737578",
      "id" : 272737578,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczNzU3OA==",
      "original_commit_id" : "f9571218d41304040778655e2f3941042b358dd5",
      "original_line" : 2354,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272737578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272737759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272737759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (f9571218d41304040778655e2f3941042b358dd5)\r\n\r\nShould say loadtxoutset",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:43:21Z",
      "diff_hunk" : "@@ -2294,6 +2295,32 @@ UniValue dumptxoutset(const JSONRPCRequest& request)\n     return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());\n }\n \n+UniValue loadtxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\"dumptxoutset\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272737759",
      "id" : 272737759,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczNzc1OQ==",
      "original_commit_id" : "f9571218d41304040778655e2f3941042b358dd5",
      "original_line" : 2338,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272737759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272738317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272738317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (f9571218d41304040778655e2f3941042b358dd5)\r\n\r\nLike https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272223330, should probably intepret path relative to datadir",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:45:18Z",
      "diff_hunk" : "@@ -2294,6 +2295,32 @@ UniValue dumptxoutset(const JSONRPCRequest& request)\n     return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());\n }\n \n+UniValue loadtxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\"dumptxoutset\",\n+                \"\\nLoad the serialized UTXO set from disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path{request.params[0].get_str()};\n+    FILE* file{fsbridge::fopen(path, \"rb\")};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272738317",
      "id" : 272738317,
      "line" : 2671,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczODMxNw==",
      "original_commit_id" : "f9571218d41304040778655e2f3941042b358dd5",
      "original_line" : 2671,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 100,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272738317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272738640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272738640"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (f9571218d41304040778655e2f3941042b358dd5)\r\n\r\nLike https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272308326, should probably return json information instead of human readable string.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T20:46:41Z",
      "diff_hunk" : "@@ -2294,6 +2295,32 @@ UniValue dumptxoutset(const JSONRPCRequest& request)\n     return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());\n }\n \n+UniValue loadtxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\"dumptxoutset\",\n+                \"\\nLoad the serialized UTXO set from disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path{request.params[0].get_str()};\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    g_chainman.ActivateSnapshot(\n+        &afile, metadata, ::ChainstateActive()->m_coins_cache_size_bytes, false);\n+\n+    return tfm::format(\"Loaded snapshot %s\", metadata.m_base_blockheader.GetBlockHash().ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272738640",
      "id" : 272738640,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczODY0MA==",
      "original_commit_id" : "f9571218d41304040778655e2f3941042b358dd5",
      "original_line" : 2380,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272738640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272742396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272742396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272327897\r\n\r\n> Can you give a little overview of what is meant by the:\r\n>\r\n> - unready snapshot chainstate\r\n> - ibd chainstate\r\n> - snapshot chainstate\r\n> - active chainstate\r\n> - background validation chainstate\r\n> - validated chainstate\r\n\r\nMore chainstates from commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" (6d85241c236f563715d4a982651fd1815d76dbd2):\r\n\r\n- most-work chainstate\r\n- validation chainstate (different from validated chainstate?)\r\n",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T21:00:39Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272742396",
      "id" : 272742396,
      "in_reply_to_id" : 272327897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc0MjM5Ng==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 817,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 223458511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272742396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272743599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272743599"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" (6d85241c236f563715d4a982651fd1815d76dbd2)\r\n\r\nLike other places, callers never seem to be checking for null. This should just use references and return `*m_snapshot_chainstate` instead of `m_snapshot_chainstate.get()`.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-05T21:05:06Z",
      "diff_hunk" : "@@ -5002,6 +5010,16 @@ bool ChainstateManager::ActivateSnapshot(\n     return true;\n }\n \n+CChainState* ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    if (m_snapshot_chainstate &&\n+            !m_snapshot_chainstate->m_chain.Contains(LookupBlockIndex(blockhash))) {\n+        return m_snapshot_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r272743599",
      "id" : 272743599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc0MzU5OQ==",
      "original_commit_id" : "6d85241c236f563715d4a982651fd1815d76dbd2",
      "original_line" : 5017,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 223478991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272743599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273085866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273085866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah sorry, I guess \"truthy\" is colloquial to Python: https://stackoverflow.com/questions/39983695/what-is-truthy-and-falsy-in-python-how-is-it-different-from-true-and-false",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-08T14:46:47Z",
      "diff_hunk" : "@@ -459,6 +459,9 @@ class CChain {\n     /** Set/initialize a chain with a given tip. */\n     void SetTip(CBlockIndex *pindex);\n \n+    /** Ensure all members of this chain have a truthy nTx/nChainTx value. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273085866",
      "id" : 273085866,
      "in_reply_to_id" : 271916764,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzA4NTg2Ng==",
      "original_commit_id" : "ebc844e8a1bacfe603db85ef4deae6e1f109cd57",
      "original_line" : 462,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 223892740,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273085866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273571494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273571494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note: this needs to be rewritten to avoid assuming that the user has enough free memory to fit the entire snapshot. Right now it'll OOM on machines with less than 3.2GB mem available.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-09T16:13:22Z",
      "diff_hunk" : "@@ -4872,3 +4906,329 @@ class CMainCleanup\n         mapBlockIndex.clear();\n     }\n } instance_of_cmaincleanup;\n+\n+//\n+// ChainstateManager\n+//\n+\n+void ChainstateManager::SaveSnapshotMetadataToDisk() const\n+{\n+    fs::path path = GetDataDir() / \"chainstate_snapshot.dat\";\n+    FILE* out = fsbridge::fopen(path, \"wb\");\n+    CAutoFile file(out, SER_DISK, CLIENT_VERSION);\n+    file << *m_snapshot_metadata;\n+    LogPrintf(\"[snapshot] wrote snapshot metadata to %s\\n\", path);\n+}\n+\n+bool ChainstateManager::DeleteSnapshotMetadataFromDisk() const\n+{\n+    LogPrintf(\"[snapshot] %s: deleting chainstate_snapshot.dat\\n\", __func__);\n+    return fs::remove(GetDataDir() / \"chainstate_snapshot.dat\");\n+}\n+\n+bool ChainstateManager::LoadSnapshotMetadata()\n+{\n+    fs::path path = GetDataDir() / \"chainstate_snapshot.dat\";\n+    CAutoFile in{fsbridge::fopen(path, \"rb\"), SER_DISK, CLIENT_VERSION};\n+    if (in.IsNull()) {\n+        LogPrintf(\"[snapshot] no snapshot metadata found at %s\\n\", path);\n+        return false;\n+    }\n+    SnapshotMetadata metadata;\n+    in >> metadata;\n+    m_snapshot_metadata = MakeUnique<SnapshotMetadata>(metadata);\n+    return true;\n+}\n+\n+std::vector<CChainState*> ChainstateManager::GetAll()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+\n+    return out;\n+}\n+\n+void ChainstateManager::RunOnAll(\n+    const std::function<void(CChainState*)> fn)\n+{\n+    for (CChainState* chainstate : GetAll()) {\n+        fn(chainstate);\n+    }\n+}\n+\n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (m_snapshot_chainstate) out.push_back(m_snapshot_chainstate.get());\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) out.push_back(m_ibd_chainstate.get());\n+\n+    return out;\n+}\n+\n+CChainState* ChainstateManager::InitializeChainstate(\n+    size_t cache_size_bytes,\n+    bool in_memory,\n+    bool should_wipe,\n+    bool activate,\n+    const uint256& snapshot_blockhash,\n+    bool snapshot_needs_initialization)\n+{\n+    // If we don't yet have metadata for the snapshot, we need to do some extra processing\n+    // before it's ready for use, so stash it in `m_unready_snapshot_chainstate` to be\n+    // processed in ActivateSnapshot().\n+    std::unique_ptr<CChainState>& to_modify = (\n+        snapshot_blockhash.IsNull() ? m_ibd_chainstate :\n+            snapshot_needs_initialization ? m_unready_snapshot_chainstate : m_snapshot_chainstate);\n+\n+    to_modify.reset(new CChainState(\n+        cache_size_bytes, in_memory, should_wipe, \"chainstate\", snapshot_blockhash));\n+\n+    if (activate) {\n+        LogPrintf(\"Switching active chainstate to %s\\n\", snapshot_blockhash.ToString());\n+        m_active_chainstate = to_modify.get();\n+    }\n+\n+    return to_modify.get();\n+}\n+\n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        size_t cache_size_bytes,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockheader.GetBlockHash();\n+\n+    // Important that we haven't set `m_snapshot_metadata` yet before this point.\n+    CChainState* snapshot_chainstate = InitializeChainstate(\n+        cache_size_bytes, in_memory,\n+        /* should_wipe */ false, /* activate */ false,\n+        /* snapshot_blockhash */ base_blockhash, /* snapshot_needs_initialization */ true);\n+\n+    CCoinsViewCache* coins_cache = snapshot_chainstate->CoinsCache();\n+\n+    CCoinsMap coins_map;\n+    COutPoint outpoint;\n+    Coin coin;\n+    uint64_t coins_count = metadata.m_coins_count;\n+    uint64_t coins_left = metadata.m_coins_count;\n+\n+    LogPrintf(\"[snapshot] loading coins from snapshot %s\\n\", base_blockhash.ToString());\n+\n+    while (coins_left > 0) {\n+        *coins_file >> outpoint;\n+        *coins_file >> coin;\n+        coins_map[outpoint] = CCoinsCacheEntry(std::move(coin), CCoinsCacheEntry::DIRTY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273571494",
      "id" : 273571494,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzU3MTQ5NA==",
      "original_commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "original_line" : 5190,
      "original_position" : 2169,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 224508553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273571494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273572305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273572305"
         }
      },
      "author_association" : "MEMBER",
      "body" : "TODO: should add a check here that the user hasn't loaded any wallets with a bestblock height of less than the base of the snapshot.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-09T16:15:24Z",
      "diff_hunk" : "@@ -2296,6 +2231,133 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;\n+            afile << coin;\n+        }\n+\n+        pcursor->Next();\n+    }\n+\n+    afile.fclose();\n+    return tfm::format(\"%d coins written at tip %s\", stats.coins_count, tip->ToString());\n+}\n+\n+UniValue loadtxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\"dumptxoutset\",\n+                \"\\nLoad the serialized UTXO set from disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273572305",
      "id" : 273572305,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzU3MjMwNQ==",
      "original_commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "original_line" : 2399,
      "original_position" : 403,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 224509656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273572305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273647684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273647684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, agree with you. Will change.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-09T18:44:29Z",
      "diff_hunk" : "@@ -520,21 +545,40 @@ class CChainState {\n      */\n     mutable std::atomic<bool> m_is_ibd;\n \n+    //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n+    std::unique_ptr<CoinsViews> m_coins_views;\n+\n public:\n+    CChainState(\n+        /* parameters forwarded to CoinsViews */\n+        size_t cache_size_bytes,\n+        bool in_memory,\n+        bool should_wipe,\n+        std::string leveldb_name = \"chainstate\"\n+        ) : m_is_ibd(false)\n+    {\n+        m_coins_views.reset(new CoinsViews(\n+            leveldb_name, cache_size_bytes, in_memory, should_wipe));\n+    }\n+\n     /**\n      * The current chain of blockheaders we consult and build on.\n      *\n      * @see CChain, CBlockIndex.\n      */\n     CChain m_chain;\n+\n     /**\n      * The set of all CBlockIndex entries with BLOCK_VALID_TRANSACTIONS (for itself and all ancestors) and\n      * as good as our current tip or better. Entries may be failed, though, and pruning nodes may be\n      * missing the data for the block.\n      */\n     std::set<CBlockIndex*, CBlockIndexWorkComparator> setBlockIndexCandidates;\n \n-    CBlockIndex *pindexBestInvalid = nullptr;\n+    CCoinsViewCache* CoinsCache() { return m_coins_views->m_cacheview.get(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273647684",
      "id" : 273647684,
      "in_reply_to_id" : 271910014,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY0NzY4NA==",
      "original_commit_id" : "525df322de8e6803f41a56aff16bfc1ebe95f845",
      "original_line" : 669,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 224588340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273647684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273656736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273656736"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll add comments, but to answer your immediate question: once we complete validation of a snapshot, we update this value to true and write it out to a metadata file on disk. This is so that when we are initializing after a subsequent restart, we know that the snapshot we load in has been validated and we don't need to continue to do a background validation. This would be unnecessary if we renamed the `chainstate_xxx...x` leveldb directory used by the snapshot to `chainstate` after we complete background validation of the snapshot, which is maybe what we should do anyway.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-09T19:05:49Z",
      "diff_hunk" : "@@ -657,6 +658,46 @@ bool InvalidateBlock(CValidationState& state, const CChainParams& chainparams, C\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Serialized version of a UTXO set from which an assumed-valid CChainState\n+ * can be constructed.\n+ */\n+class SnapshotMetadata\n+{\n+public:\n+    CDiskBlockIndex m_base_blockheader;\n+    uint256 m_utxo_contents_hash = {};\n+    uint64_t m_coins_count = 0;\n+    /**\n+     * Necessary to \"fake\" the base nChainTx so that we can estimate progress during\n+     * snapshot IBD.\n+     */\n+    unsigned int m_nchaintx = 0;\n+    bool m_validation_complete = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r273656736",
      "id" : 273656736,
      "in_reply_to_id" : 271919012,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MzY1NjczNg==",
      "original_commit_id" : "50d8e7c910edec10dcf08beec577c3efd67f2276",
      "original_line" : 846,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 224599131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/273656736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274043281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274043281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 77e5c902168ca2191448c5f8924b6831dc2717b9:\r\n\r\nI'd prefer not to include a header when a forward declaration is enough.\r\n\r\nSee the following fixup:\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 4676a446f8..a67cd03686 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -22,6 +22,7 @@\r\n #include <policy/policy.h>\r\n #include <policy/rbf.h>\r\n #include <pow.h>\r\n+#include <txmempool.h>\r\n #include <primitives/block.h>\r\n #include <primitives/transaction.h>\r\n #include <random.h>\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex feb92b3774..9ff65e2dce 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -18,7 +18,6 @@\r\n #include <protocol.h> // For CMessageHeader::MessageStartChars\r\n #include <script/script_error.h>\r\n #include <sync.h>\r\n-#include <txmempool.h>\r\n #include <versionbits.h>\r\n \r\n #include <algorithm>\r\n@@ -44,7 +43,7 @@ class CBlockPolicyEstimator;\r\n class CTxMemPool;\r\n class CValidationState;\r\n struct ChainTxData;\r\n-\r\n+struct DisconnectedBlockTransactions;\r\n struct PrecomputedTransactionData;\r\n struct LockPoints;\r\n \r\n",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-10T16:10:46Z",
      "diff_hunk" : "@@ -18,7 +18,11 @@\n #include <protocol.h> // For CMessageHeader::MessageStartChars\n #include <script/script_error.h>\n #include <sync.h>\n+#include <txmempool.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274043281",
      "id" : 274043281,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDA0MzI4MQ==",
      "original_commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "original_line" : 22,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 225074146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274043281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274085047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274085047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This hasn't been fixed?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-10T17:55:22Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_mai\n /** The currently-connected chain of blocks (protected by cs_main). */\n extern CChain& chainActive;\n \n+extern CChainState g_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274085047",
      "id" : 274085047,
      "in_reply_to_id" : 271006988,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDA4NTA0Nw==",
      "original_commit_id" : "b5627060df9c7876d91391e34c84a7e4fb1ff378",
      "original_line" : 617,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 225074146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274085047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274091108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274091108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry - I'm marking these resolved as I rebase locally as a checklist for myself. Instead of pushing each time I rebase, I'm going to push all the changes up once I'm done (today or tomorrow).",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-10T18:10:37Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_mai\n /** The currently-connected chain of blocks (protected by cs_main). */\n extern CChain& chainActive;\n \n+extern CChainState g_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274091108",
      "id" : 274091108,
      "in_reply_to_id" : 271006988,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDA5MTEwOA==",
      "original_commit_id" : "b5627060df9c7876d91391e34c84a7e4fb1ff378",
      "original_line" : 617,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 225134474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274091108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274128409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274128409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good advice, thanks. I've renamed the class `BlockManager` and folded the \"global\" instance into `ChainstateManager`, which then injects a reference to that instance when constructing chainstates. Each reference lives as `CChainState.m_blockman`.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-10T19:48:21Z",
      "diff_hunk" : "@@ -1148,7 +1209,7 @@ void static InvalidChainFound(CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(c\n void CChainState::InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state) {\n     if (!state.CorruptionPossible()) {\n         pindex->nStatus |= BLOCK_FAILED_VALID;\n-        m_failed_blocks.insert(pindex);\n+        g_blockmetaman.m_failed_blocks.insert(pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274128409",
      "id" : 274128409,
      "in_reply_to_id" : 271513853,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDEyODQwOQ==",
      "original_commit_id" : "155ee896520e51b8a13d6904e3a14b5fa50295c0",
      "original_line" : 1212,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 225180998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274128409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274470338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274470338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, this is an incorrect relic of this RPC being a hackneyed prototype. We'll probably have to lock cs_main for the duration of this call for now, but I think that'll be prohibitively lengthy when we start generating snapshots as part of normal operation, so down the road we may have to introduce a unique lock for the coinsdb (i.e. to prevent flushes from happening mid-snapshot).\r\n\r\nWe're fine to use different cursor objects so long as the leveldb data hasn't changed between calls (which it obviously won't if we hold cs_main).",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T15:02:37Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274470338",
      "id" : 274470338,
      "in_reply_to_id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ3MDMzOA==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 225595493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274470338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274474143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274474143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This makes me think that the existing `gettxoutsetinfo` RPC is broken since it isn't locking cs_main during the `GetUTXOStats()` call. I wonder if the author of that function assumed that leveldb handles locking as some kind of RAII associated with use of the iterator, but that's not the case ([DBImpl::NewIterator](https://github.com/bitcoin-core/leveldb/blob/bitcoin-fork/db/db_impl.cc#L1156-L1166), [DBIter](https://github.com/bitcoin-core/leveldb/blob/bitcoin-fork/db/db_iter.cc#L51-L64)).",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T15:09:55Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274474143",
      "id" : 274474143,
      "in_reply_to_id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ3NDE0Mw==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 225600378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274474143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274479369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274479369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The cursor returned iterates over a snapshot of the database at the time of its creation; the db can be modified simultaneously, but won't affect what the cursor sees.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T15:20:32Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274479369",
      "id" : 274479369,
      "in_reply_to_id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ3OTM2OQ==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 225606956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274479369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274481307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274481307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@sipa I can't find any mention of this behavior in the leveldb docs or header files. I see it happening [here](https://github.com/bitcoin-core/leveldb/blob/bitcoin-fork/db/db_impl.cc#L1159), but do we want to rely on something so implicit?",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T15:24:19Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274481307",
      "id" : 274481307,
      "in_reply_to_id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ4MTMwNw==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 225609346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274481307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274484277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274484277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should probably make it explicit through the Snapshot API of LevelDB. I thought we already did, actually - so I'm a bit confused how I knew this as I don't remember looking in the code.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T15:29:47Z",
      "diff_hunk" : "@@ -2230,6 +2230,70 @@ UniValue scantxoutset(const JSONRPCRequest& request)\n     return result;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            RPCHelpMan{\n+                \"dumptxoutset\",\n+                \"\\nWrite the serialized UTXO set to disk.\\n\",\n+                {\n+                    {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, /* default_val */ \"\", \"path to the output file\"},\n+                },\n+                RPCResults{},\n+                RPCExamples{\"\"},\n+            }.ToString()\n+        );\n+\n+    std::string path = request.params[0].get_str();\n+    FILE* file{fsbridge::fopen(path, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+\n+    {\n+        LOCK(::cs_main);\n+        ::FlushStateToDisk();\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive()->CoinsDB()->Cursor());\n+        assert(pcursor);\n+    }\n+\n+    CCoinsStats stats;\n+    if (!GetUTXOStats(::ChainstateActive()->CoinsDB(), stats)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+    }\n+\n+    CBlockIndex* tip;\n+    {\n+        LOCK(::cs_main);\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        assert(tip);\n+    }\n+    SnapshotMetadata metadata{\n+        CDiskBlockIndex(tip), stats.hashSerialized, stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COutPoint key;\n+        Coin coin;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274484277",
      "id" : 274484277,
      "in_reply_to_id" : 272226729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ4NDI3Nw==",
      "original_commit_id" : "71a65a08213b0159d4e4df2199d9993547f163e4",
      "original_line" : 2622,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 225612968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274484277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274577341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577341"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Most of these are already documented with data docstrings, but I've added an overview in the classdoc.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T18:37:39Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274577341",
      "id" : 274577341,
      "in_reply_to_id" : 272327897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3NzM0MQ==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 817,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 225716908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274577341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274578776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274578776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep. This function used to be split across two (one of which was executed in a separate thread), so this is an artifact of that. Willfix.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-11T18:41:21Z",
      "diff_hunk" : "@@ -4872,6 +4872,136 @@ CChainState* ChainstateManager::InitializeChainstate(\n     return to_modify.get();\n }\n \n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        size_t cache_size_bytes,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockheader.GetBlockHash();\n+\n+    // Important that we haven't set `m_snapshot_metadata` yet before this point.\n+    CChainState* snapshot_chainstate = InitializeChainstate(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274578776",
      "id" : 274578776,
      "in_reply_to_id" : 272736054,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU3ODc3Ng==",
      "original_commit_id" : "9b6907e080fe4da105a332c76ddb5110310e8840",
      "original_line" : 4884,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 225718684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274578776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r275033240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275033240"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Made it private and then `friend`ed the only two functions (ChainActive and ChainstateActive) which access it.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-12T19:18:21Z",
      "diff_hunk" : "@@ -711,14 +732,170 @@ class SnapshotMetadata\n \n };\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * This class was created to displace the use of global variables (e.g.\n+ * chainActive) which were historically used to reference a single active\n+ * chainstate throughout the codebase.\n+ *\n+ * TODO jamesob: basically everything in this class is implicitly covered\n+ *   by `cs_main`. Should probably put some more formalization around\n+ *   locking and maybe add a class-local `cs` CCriticalSection.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    /**\n+     * Temporary holding place for a snapshot chainstate which is in the process of\n+     * being constructed. When ready, we swap with `m_snapshot_chainstate`.\n+     */\n+    std::unique_ptr<CChainState> m_unready_snapshot_chainstate;\n+\n+    /**\n+     * If not empty, this points to metadata corresponding to the UTXO snapshot\n+     * currently in use.\n+     */\n+    std::unique_ptr<SnapshotMetadata> m_snapshot_metadata;\n+\n+    /**\n+     * The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+     * if a snapshot is in use, for background validation. Its contents will\n+     * be freed when background validation of the snapshot has completed.\n+     */\n+    std::unique_ptr<CChainState> m_ibd_chainstate GUARDED_BY(cs_main);\n+\n+    /**\n+     * A chainstate initialized on the basis of a UTXO snapshot. If this is\n+     * truthy, it is always our active chainstate unless proven invalid.\n+     */\n+    std::unique_ptr<CChainState> m_snapshot_chainstate GUARDED_BY(cs_main);\n+\n+public:\n+    /**\n+     * Points to either the ibd or snapshot chainstate; indicates our\n+     * most-work chain.\n+     */\n+    CChainState* m_active_chainstate GUARDED_BY(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r275033240",
      "id" : 275033240,
      "in_reply_to_id" : 272326477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTAzMzI0MA==",
      "original_commit_id" : "8d9b707f609b647fb28ae182a097adc03e718725",
      "original_line" : 926,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 226247784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275033240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r275034464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275034464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-04-12T19:22:59Z",
      "diff_hunk" : "@@ -64,6 +64,72 @@ CChainState* ChainstateActive() { return &g_chainstate; }\n \n CChain& ChainActive() { return g_chainstate.m_chain; }\n \n+/**\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n+ *\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockMetadataManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+public:\n+    /*\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n+     * Pruned nodes may have entries where B is missing data.\n+     */\n+    std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n+\n+    CBlockIndex *m_pindex_best_invalid = nullptr;\n+\n+    bool LoadBlockIndex(const Consensus::Params& consensus_params, CBlockTreeDB& blocktree);\n+\n+    void Unload() {\n+        m_failed_blocks.clear();\n+        m_blocks_unlinked.clear();\n+        m_pindex_best_invalid = nullptr;\n+\n+        for (const BlockMap::value_type& entry : m_block_index) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r275034464",
      "id" : 275034464,
      "in_reply_to_id" : 272317689,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTAzNDQ2NA==",
      "original_commit_id" : "155ee896520e51b8a13d6904e3a14b5fa50295c0",
      "original_line" : 114,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 226249375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275034464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-16T17:14:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-483764115",
      "id" : 483764115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mzc2NDExNQ==",
      "updated_at" : "2019-04-16T17:14:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483764115",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-18T15:13:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-484551017",
      "id" : 484551017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDU1MTAxNw==",
      "updated_at" : "2019-04-18T15:13:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484551017",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm unable to compile this on macOS. See [error log](https://gist.github.com/Sjors/3937c8ebef0fcc8ea066072eacb59a60). It does compile on Ubuntu, despite quite a few warnings.\r\n\r\nI tested making a dump for testnet and then importing it with a fresh datadir. But I think I'm using it wrong. First time I tried to load it I got. That was before it fetched any headers. I waited for it to fetch a few blocks and tried again, but same error:\r\n\r\n```\r\nbitcoind: txdb.cpp:104: virtual bool CCoinsViewDB::BatchWrite(CCoinsMap&, const uint256&): Assertion `!hashBlock.IsNull()' failed.\r\n```\r\n\r\nI don't think an RPC method is the right tool for loading a snapshot (it's fine for saving); probably better to just specify a location at launch.\r\n\r\nCan you add an actual `assumeutxo` value (mainnet & testnet)? When combined with #13713 it should be easier to create and test the snapshot (I had some difficulty wrapping my head around the demo script). That also means `loadtxoutset` can refuse to process a snapshot for a lower block height than the most recent fully processed block (even if the header is a valid-fork).\r\n\r\nTo facilitate writing functional tests, you could allow a `-assumeutxo` param for regtest only.",
      "created_at" : "2019-04-19T18:12:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-484975314",
      "id" : 484975314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDk3NTMxNA==",
      "updated_at" : "2019-04-19T18:12:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484975314",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm unable to compile this on macOS. See error log. It does compile on Ubuntu, despite quite a few warnings.\r\n\r\nThanks; could you post the warnings you're receiving on Ubuntu? I'm not getting any warnings during compilation when using clang 9.0.0 and gcc 7.3.0 on Ubuntu 18.04.2.\r\n\r\n> I don't think an RPC method is the right tool for loading a snapshot (it's fine for saving); probably better to just specify a location at launch.\r\n\r\nLoading snapshot only on startup would simplify things in the short run, but ultimately if we're going to share snapshots over the P2P network, we'll need to support loading them at runtime. Better to test that process out earlier IMO.\r\n\r\n> I waited for it to fetch a few blocks and tried again, but same error...\r\n\r\nOops, looks like I introduced a bug during a recent rebase. Fixing now. Thanks for testing!\r\n\r\n> Can you add an actual assumeutxo value (mainnet & testnet)?\r\n\r\nYep, I'll do this in the next day or so.\r\n\r\n> To facilitate writing functional tests, you could allow a -assumeutxo param for regtest only.\r\n\r\nYep, this seems like a good idea. I'm also going to try to do as much unittesting as I can (as opposed to functional tests).",
      "created_at" : "2019-04-23T13:18:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-485798749",
      "id" : 485798749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NTc5ODc0OQ==",
      "updated_at" : "2019-04-23T13:18:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/485798749",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-23T17:45:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-485905192",
      "id" : 485905192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NTkwNTE5Mg==",
      "updated_at" : "2019-04-23T17:45:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/485905192",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added particular assumeutxo values and a more narrow `devtools` script. @Sjors hopefully this should now build without trouble or warnings on MacOS, though I haven't tested.",
      "created_at" : "2019-04-25T20:01:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-486817519",
      "id" : 486817519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NjgxNzUxOQ==",
      "updated_at" : "2019-04-25T20:01:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/486817519",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When (and if) I get a few Concept ACKs on this, I'll start to break this into smaller PRs with accompanying tests. Let me know if there's anything that would make conceptual review easier.",
      "created_at" : "2019-04-26T18:35:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-487158576",
      "id" : 487158576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NzE1ODU3Ng==",
      "updated_at" : "2019-04-26T18:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/487158576",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-04-26T19:03:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-487166998",
      "id" : 487166998,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NzE2Njk5OA==",
      "updated_at" : "2019-04-26T19:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/487166998",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. It compiles now. I was able to create a snapshot using the script and load it on a fresh datadir. Though it crashed when I stopped the node and started it again:\r\n\r\n```\r\n2019-04-27T14:18:10Z [snapshot] resetting coinsviews for Chainstate [ibd] @ height 410343 (000000000008b5afee8bdf7bbc4386c001615bbfcfe12e7ddd0ac19ab9a03235)\r\n2019-04-27T14:18:10Z [snapshot] resetting coinsviews for Chainstate [snapshot] @ height 1512817 (0000000000000332aba2ad56296b67b7b6664a46b1c23bb014bb9aad6fb20828)\r\n2019-04-27T14:18:13Z [default wallet] Releasing wallet\r\n2019-04-27T14:18:13Z Shutdown: done\r\n\r\n...\r\n2019-04-27T14:19:11Z Initializing chainstate Chainstate [snapshot] @ height -1 (null)\r\nAssertion failed: (!setBlockIndexCandidates.empty()), function PruneBlockIndexCandidates, file validation.cpp, line 2401.\r\n```\r\n\r\n\r\nIt's hard to follow what's going on when loading the snapshot on a fresh node because the logs are flooded by the regular IBD in progress. Consider pausing IBD while loading the file.\r\n\r\nOnce we reach the tip and it starts syncing from genesis in the background, the log is too quiet. It's only showing allocation of block files. It would be nice to have a message for each block along the lines of ` UpdateChain: processed block 00000000000000a9d.... at height=1234` . Something less verbose, like on message every 1000 blocks, would also be fine. Otherwise it might end up snowing under important events at the tip.\r\n\r\n`getblockchaininfo` should contain fields to measure the progress of catching up in the background (and there needs to be something for the GUI to access, that can wait).\r\n\r\nHow do plan to handle block pruning? Do we just split `-prune` in half while catchup is in progress? Do we double the minimum `prune` setting (when used with this feature)?",
      "created_at" : "2019-04-27T14:20:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-487289941",
      "id" : 487289941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NzI4OTk0MQ==",
      "updated_at" : "2019-04-27T14:20:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/487289941",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-30T19:37:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-488086533",
      "id" : 488086533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4ODA4NjUzMw==",
      "updated_at" : "2019-04-30T19:37:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/488086533",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Just an FYI - I had a working POC of this that would have worked fine with the chainstate hash in the source  code:\r\nhttps://gist.github.com/n1bor/55b25d72cd3c24eef85f7e24d549ef7a\r\n\r\nOne interesting thing is if you write a lot of data to a leveldb database that is mostly sorted by key (or at least big chunks are ) it is very efficient.",
      "created_at" : "2019-05-05T11:05:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-489415711",
      "id" : 489415711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4OTQxNTcxMQ==",
      "updated_at" : "2019-05-05T11:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489415711",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1016563?v=4",
         "events_url" : "https://api.github.com/users/n1bor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/n1bor/followers",
         "following_url" : "https://api.github.com/users/n1bor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/n1bor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/n1bor",
         "id" : 1016563,
         "login" : "n1bor",
         "node_id" : "MDQ6VXNlcjEwMTY1NjM=",
         "organizations_url" : "https://api.github.com/users/n1bor/orgs",
         "received_events_url" : "https://api.github.com/users/n1bor/received_events",
         "repos_url" : "https://api.github.com/users/n1bor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/n1bor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/n1bor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/n1bor"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors thanks very much for testing.\r\n\r\n> it crashed when I stopped the node and started it again\r\n\r\nYou found a bug in how the init process interacts with an assumed-valid chainstate. I needed to add `nChainTx` reconstruction to `LoadBlockIndex()` and make some allowances for the assumed-valid chain in `RewindBlockIndex()`. The details of the fix are mostly contained in https://github.com/bitcoin/bitcoin/pull/15606/commits/7d10a00daca80c6a8e68196ae7c016c1123d91fe, but we also now write `BLOCK_OPT_WITNESS` into the appropriate CBlockIndex entries during snapshot activation (https://github.com/bitcoin/bitcoin/pull/15606/commits/7bfbb78b445efbefa5238b4d23290ad4d4db05cf#diff-24efdb00bfbe56b140fb006b562cc70bR5001).\r\n\r\n> Consider pausing IBD while loading the file.\r\n\r\nOn your advice I'm now acquiring `cs_main` during snapshot activation for clarity when testing, but I think that closer to merge we should undo this. The snapshot chainstate can populate on a separate thread while traditional IBD starts and I don't think either slows the other down since they're running on separate threads and writing to separate data structures (the block index excluded).\r\n\r\nNote that you can isolate most of the snapshot-related logs with `tail -f debug.log | grep '[snapshot]'`.\r\n\r\n> Once we reach the tip and it starts syncing from genesis in the background, the log is too quiet.\r\n\r\nI've added a `[background validation] UpdateTip: ...` message for every 2000 blocks synced in the background.\r\n\r\n> How do plan to handle block pruning?\r\n\r\nSince we don't expect (or support handling) reorgs in the background validation chainstate, we prune it aggressively (within 1 block of tip; see https://github.com/bitcoin/bitcoin/pull/15606/commits/e37372a0236b12dff422eaeca643db7d64f58b48#diff-24efdb00bfbe56b140fb006b562cc70bR3635). Given current pruning precision, this seems like a rounding error and so I think should be sufficient.\r\n\r\nThanks again for testing. The most recent version of this PR is rebased and should be usable.",
      "created_at" : "2019-05-07T17:23:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-490172246",
      "id" : 490172246,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDE3MjI0Ng==",
      "updated_at" : "2019-05-07T17:29:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490172246",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> getblockchaininfo should contain fields to measure the progress of catching up in the background (and there needs to be something for the GUI to access, that can wait).\r\n\r\nYou can currently get a sense of this with the (maybe temporary? but definitely poorly named) `monitorsnapshot` RPC. Suggestions on how to roll this into `getblockchaininfo` are welcome. Maybe a `background:` key that contains a nested version of the same information? ",
      "created_at" : "2019-05-07T17:27:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-490173749",
      "id" : 490173749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDE3Mzc0OQ==",
      "updated_at" : "2019-05-07T17:27:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490173749",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r281750772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281750772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nIn file included from validation.cpp:12:\r\n./coinstats.h:15:14: redundant redeclaration of âCBlockIndex* LookupBlockIndex(const uint256&)â in same scope [-Wredundant-decls]\r\n```\r\n```suggestion\r\n\r\n```\r\n",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-05-07T17:50:45Z",
      "diff_hunk" : "@@ -0,0 +1,37 @@\n+// Copyright (c) 2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSTATS_H\n+#define BITCOIN_COINSTATS_H\n+\n+#include <coins.h>\n+#include <chain.h>\n+#include <uint256.h>\n+#include <sync.h>\n+\n+extern CCriticalSection cs_main;\n+CBlockIndex* LookupBlockIndex(const uint256& blockhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r281750772",
      "id" : 281750772,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTc1MDc3Mg==",
      "original_commit_id" : "d49425d82fa7a1bfa255e714a3e55f8efa016de8",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/coinstats.h",
      "position" : null,
      "pull_request_review_id" : 234667687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281750772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">> Consider pausing IBD while loading the file.\r\n> acquiring cs_main during snapshot activation for clarity when testing\r\n> I don't think either slows the other down since they're running on separate threads\r\n\r\nIt's not about performance, but about being able to debug. I think we should keep this in for at least one release, because it's easier than the `grep` approach. It could also make sense to wait ~60 seconds after the snapshot is loaded before resuming the original IBD. That way the log looks like:\r\n* IBD...\r\n* rpc call to load snapshot (if RPC debug is enabled)\r\n* pauze IBD\r\n* loading snapshot\r\n* snapshot loaded, begin sync from snapshot\r\n* little bit of sync from snapshot\r\n* IBD resumed\r\n* interwoven log entries from both syncs\r\n\r\n> we prune it aggressively (within 1 block of tip)\r\n\r\nPruning normally flushes `dbcache` though, are you preventing that?\r\n\r\n> Maybe a `background:` key that contains a nested version of the same information?\r\n\r\nThat seems better (or `snapshot`), since otherwise you have to call `monitorsnapshot` to even find out anything is happening.",
      "created_at" : "2019-05-07T18:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-490191681",
      "id" : 490191681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDE5MTY4MQ==",
      "updated_at" : "2019-05-07T18:19:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490191681",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r281848423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281848423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit e2c878bea3 refactoring: move block metadata structures into BlockManager\r\n\r\nstyle-nit: Duplicate `public`\r\n\r\nAlso, wouldn't it be clearer to not expose the block index via CChainState::BlockIndex? For me this is confusing because there is one blockindex, but several chainstates that could use it.\r\n\r\nI suggest the following diff, which adds a `BlockManager::BlockIndex` method (diff is on top of the current pull request, not the commit where I left this comment):\r\n\r\n```diff\r\ndiff --git a/src/init.cpp b/src/init.cpp\r\nindex 5097a81f08..2235db5ba1 100644\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -1563,7 +1563,7 @@ bool AppInitMain(InitInterfaces& interfaces)\r\n \r\n                 // If the loaded chain has a wrong genesis, bail out immediately\r\n                 // (we're likely using a testnet datadir, or the other way around).\r\n-                if (!::ChainstateActive().BlockIndex().empty() &&\r\n+                if (!g_chainman.BlockIndex().empty() &&\r\n                         !LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\r\n                     return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\r\n                 }\r\n@@ -1798,7 +1798,7 @@ bool AppInitMain(InitInterfaces& interfaces)\r\n     //// debug print\r\n     {\r\n         LOCK(cs_main);\r\n-        LogPrintf(\"m_block_index.size() = %u\\n\", ::ChainstateActive().BlockIndex().size());\r\n+        LogPrintf(\"m_block_index.size() = %u\\n\", g_chainman.BlockIndex().size());\r\n         chain_active_height = ::ChainActive().Height();\r\n     }\r\n     LogPrintf(\"nBestHeight = %d\\n\", chain_active_height);\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 6cdd11233a..d8e40a5d56 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -1378,7 +1378,7 @@ static UniValue getchaintips(const JSONRPCRequest& request)\r\n     std::set<const CBlockIndex*> setOrphans;\r\n     std::set<const CBlockIndex*> setPrevs;\r\n \r\n-    for (const std::pair<const uint256, CBlockIndex*>& item : ::ChainstateActive().BlockIndex())\r\n+    for (const std::pair<const uint256, CBlockIndex*>& item : g_chainman.BlockIndex())\r\n     {\r\n         if (!::ChainActive().Contains(item.second)) {\r\n             setOrphans.insert(item.second);\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f7884759ad..ebdd3ba1bc 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1044,11 +1044,6 @@ bool CChainState::IsInitialBlockDownload() const\r\n     return false;\r\n }\r\n \r\n-BlockMap& CChainState::BlockIndex()\r\n-{\r\n-    return m_blockman.m_block_index;\r\n-}\r\n-\r\n CBlockIndex *pindexBestForkTip = nullptr, *pindexBestForkBase = nullptr;\r\n \r\n static void AlertNotify(const std::string& strMessage)\r\n@@ -1695,8 +1690,8 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\r\n         //  relative to a piece of software is an objective fact these defaults can be easily reviewed.\r\n         // This setting doesn't force the selection of any particular chain but makes validating some faster by\r\n         //  effectively caching the result of part of the verification.\r\n-        BlockMap::const_iterator  it = BlockIndex().find(hashAssumeValid);\r\n-        if (it != BlockIndex().end()) {\r\n+        BlockMap::const_iterator  it = m_blockman.BlockIndex().find(hashAssumeValid);\r\n+        if (it != m_blockman.BlockIndex().end()) {\r\n             if (it->second->GetAncestor(pindex->nHeight) == pindex &&\r\n                 pindexBestHeader->GetAncestor(pindex->nHeight) == pindex &&\r\n                 pindexBestHeader->nChainWork >= nMinimumChainWork) {\r\n@@ -2787,8 +2782,8 @@ bool CChainState::InvalidateBlock(CValidationState& state, const CChainParams& c\r\n \r\n         // The resulting new best tip may not be in setBlockIndexCandidates anymore, so\r\n         // add it again.\r\n-        BlockMap::iterator it = BlockIndex().begin();\r\n-        while (it != BlockIndex().end()) {\r\n+        BlockMap::iterator it = m_blockman.BlockIndex().begin();\r\n+        while (it != m_blockman.BlockIndex().end()) {\r\n             if (it->second->IsValid(BLOCK_VALID_TRANSACTIONS) && it->second->HaveTxsDownloaded() && !setBlockIndexCandidates.value_comp()(it->second, m_chain.Tip())) {\r\n                 setBlockIndexCandidates.insert(it->second);\r\n             }\r\n@@ -2815,8 +2810,8 @@ void CChainState::ResetBlockFailureFlags(CBlockIndex *pindex) {\r\n     int nHeight = pindex->nHeight;\r\n \r\n     // Remove the invalidity flag from this block and all its descendants.\r\n-    BlockMap::iterator it = BlockIndex().begin();\r\n-    while (it != BlockIndex().end()) {\r\n+    BlockMap::iterator it = m_blockman.BlockIndex().begin();\r\n+    while (it != m_blockman.BlockIndex().end()) {\r\n         if (!it->second->IsValid() && it->second->GetAncestor(nHeight) == pindex) {\r\n             it->second->nStatus &= ~BLOCK_FAILED_MASK;\r\n             setDirtyBlockIndex.insert(it->second);\r\n@@ -3956,7 +3951,7 @@ bool CChainState::LoadChainTip(const CChainParams& chainparams)\r\n \r\n     if (tip && tip->GetBlockHash() == coins_cache.GetBestBlock()) return true;\r\n \r\n-    if (coins_cache.GetBestBlock().IsNull() && BlockIndex().size() == 1) {\r\n+    if (coins_cache.GetBestBlock().IsNull() && m_blockman.BlockIndex().size() == 1) {\r\n         // In case we just added the genesis block, connect it now, so\r\n         // that we always have a tip when we return.\r\n         LogPrintf(\"%s: Connecting genesis block...\\n\", __func__);\r\n@@ -4139,16 +4134,16 @@ bool CChainState::ReplayBlocks(const CChainParams& params)\r\n     const CBlockIndex* pindexNew;            // New tip during the interrupted flush.\r\n     const CBlockIndex* pindexFork = nullptr; // Latest block common to both the old and the new tip.\r\n \r\n-    if (BlockIndex().count(hashHeads[0]) == 0) {\r\n+    if (m_blockman.BlockIndex().count(hashHeads[0]) == 0) {\r\n         return error(\"ReplayBlocks(): reorganization to unknown block requested\");\r\n     }\r\n-    pindexNew = BlockIndex()[hashHeads[0]];\r\n+    pindexNew = m_blockman.BlockIndex()[hashHeads[0]];\r\n \r\n     if (!hashHeads[1].IsNull()) { // The old tip is allowed to be 0, indicating it's the first flush.\r\n-        if (BlockIndex().count(hashHeads[1]) == 0) {\r\n+        if (m_blockman.BlockIndex().count(hashHeads[1]) == 0) {\r\n             return error(\"ReplayBlocks(): reorganization from unknown block requested\");\r\n         }\r\n-        pindexOld = BlockIndex()[hashHeads[1]];\r\n+        pindexOld = m_blockman.BlockIndex()[hashHeads[1]];\r\n         pindexFork = LastCommonAncestor(pindexOld, pindexNew);\r\n         assert(pindexFork != nullptr);\r\n     }\r\n@@ -4235,7 +4230,7 @@ bool CChainState::RewindBlockIndex(const CChainParams& params)\r\n     // blocks will be dealt with below (releasing cs_main in between).\r\n     {\r\n         LOCK(cs_main);\r\n-        for (const auto& entry : BlockIndex()) {\r\n+        for (const auto& entry : m_blockman.BlockIndex()) {\r\n             if (IsWitnessEnabled(entry.second->pprev, params.GetConsensus()) && !(entry.second->nStatus & BLOCK_OPT_WITNESS) && !m_chain.Contains(entry.second)) {\r\n                 EraseBlockData(entry.second);\r\n             }\r\n@@ -4373,7 +4368,7 @@ bool LoadBlockIndex(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs\r\n     if (!fReindex) {\r\n         bool ret = LoadBlockIndexDB(chainparams);\r\n         if (!ret) return false;\r\n-        needs_init = g_chainman.m_blockman.m_block_index.empty();\r\n+        needs_init = g_chainman.m_blockman.BlockIndex().empty();\r\n     }\r\n \r\n     if (needs_init) {\r\n@@ -4553,17 +4548,17 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\r\n     // so we have the genesis block in BlockIndex() but no active chain. (A few of the tests when\r\n     // iterating the block tree require that m_chain has been initialized.)\r\n     if (m_chain.Height() < 0) {\r\n-        assert(BlockIndex().size() <= 1);\r\n+        assert(m_blockman.BlockIndex().size() <= 1);\r\n         return;\r\n     }\r\n \r\n     // Build forward-pointing map of the entire block tree.\r\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\r\n-    for (const std::pair<const uint256, CBlockIndex*>& entry : BlockIndex()) {\r\n+    for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.BlockIndex()) {\r\n         forward.insert(std::make_pair(entry.second->pprev, entry.second));\r\n     }\r\n \r\n-    assert(forward.size() == BlockIndex().size());\r\n+    assert(forward.size() == m_blockman.BlockIndex().size());\r\n \r\n     std::pair<std::multimap<CBlockIndex*,CBlockIndex*>::iterator,std::multimap<CBlockIndex*,CBlockIndex*>::iterator> rangeGenesis = forward.equal_range(nullptr);\r\n     CBlockIndex *pindex = rangeGenesis.first->second;\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 84605e957c..20a90cda0b 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -465,8 +465,12 @@ struct CBlockIndexWorkComparator\r\n  * candidate tips is not maintained here.\r\n  */\r\n class BlockManager {\r\n-public:\r\n     BlockMap m_block_index GUARDED_BY(cs_main);\r\n+public:\r\n+    BlockMap& BlockIndex() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+    {\r\n+        return m_block_index;\r\n+    }\r\n \r\n     /** In order to efficiently track invalidity of headers, we keep the set of\r\n       * blocks which we tried to connect and found to be invalid here (ie which\r\n@@ -488,7 +492,6 @@ public:\r\n       */\r\n     std::set<CBlockIndex*> m_failed_blocks;\r\n \r\n-public:\r\n     /*\r\n      * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\r\n      * Pruned nodes may have entries where B is missing data.\r\n@@ -775,9 +778,6 @@ public:\r\n     /** Check whether we are doing an initial block download (synchronizing from disk or network) */\r\n     bool IsInitialBlockDownload() const;\r\n \r\n-    //! @returns the map of blocks that this chainstate is aware of.\r\n-    BlockMap& BlockIndex();\r\n-\r\n     /** Update the chain tip based on database information. */\r\n     bool LoadChainTip(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n@@ -1040,7 +1040,7 @@ public:\r\n \r\n     BlockMap& BlockIndex() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n     {\r\n-        return m_blockman.m_block_index;\r\n+        return m_blockman.BlockIndex();\r\n     }\r\n \r\n     bool IsSnapshotActive() const\r\ndiff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\r\nindex 91618525fd..afb619f13f 100644\r\n--- a/src/wallet/test/wallet_tests.cpp\r\n+++ b/src/wallet/test/wallet_tests.cpp\r\n@@ -272,7 +272,7 @@ static int64_t AddTx(CWallet& wallet, uint32_t lockTime, int64_t mockTime, int64\r\n     if (blockTime > 0) {\r\n         LockAnnotation lock(::cs_main);\r\n         auto locked_chain = wallet.chain().lock();\r\n-        auto inserted = ::ChainstateActive().BlockIndex().emplace(GetRandHash(), new CBlockIndex);\r\n+        auto inserted = g_chainman.BlockIndex().emplace(GetRandHash(), new CBlockIndex);\r\n         assert(inserted.second);\r\n         const uint256& hash = inserted.first->first;\r\n         block = inserted.first->second;",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-05-07T22:08:58Z",
      "diff_hunk" : "@@ -461,27 +461,89 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+public:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r281848423",
      "id" : 281848423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTg0ODQyMw==",
      "original_commit_id" : "e2c878bea3003662d4bbdd656f1dc627a271a9df",
      "original_line" : 471,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 234785615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281848423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r282154374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282154374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This means the catchup process never leaves IBD once nMinimumChainWork > work(assume_utxo block). Not sure if that matters.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-05-08T16:49:23Z",
      "diff_hunk" : "@@ -1168,30 +1017,38 @@ CAmount GetBlockSubsidy(int nHeight, const Consensus::Params& consensusParams)\n     return nSubsidy;\n }\n \n-bool IsInitialBlockDownload()\n+// Note that though this is marked const, we may end up modifying `m_cached_finished_ibd`, which\n+// is a performance-related implementation detail. This function must be marked\n+// `const` so that `CValidationInterface` clients (which are given a `const CChainState&`)\n+// can call it.\n+//\n+bool CChainState::IsInitialBlockDownload() const\n {\n-    // Once this function has returned false, it must remain false.\n-    static std::atomic<bool> latchToFalse{false};\n     // Optimization: pre-test latch before taking the lock.\n-    if (latchToFalse.load(std::memory_order_relaxed))\n+    if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n \n     LOCK(cs_main);\n-    if (latchToFalse.load(std::memory_order_relaxed))\n+    if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n     if (fImporting || fReindex)\n         return true;\n-    if (::ChainActive().Tip() == nullptr)\n+    if (m_chain.Tip() == nullptr)\n         return true;\n-    if (::ChainActive().Tip()->nChainWork < nMinimumChainWork)\n+    if (m_chain.Tip()->nChainWork < nMinimumChainWork)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r282154374",
      "id" : 282154374,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjE1NDM3NA==",
      "original_commit_id" : "d49425d82fa7a1bfa255e714a3e55f8efa016de8",
      "original_line" : 1261,
      "original_position" : 386,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 235169752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282154374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Did another test (on Ubuntu) and was able to create a snapshot and load it in a fresh datadir.\r\n\r\nWhen I tried to make a snapshot while still in IBD, the chain reorged down to the specified height and then immedidately shot up again to the tip, before making a (presumable wrong) snapshot. Easiest solution is for the demo script to check if `initialblockdownload` is `false`.\r\n\r\nPerhaps related, but I managed to corrupt the node that I took the snapshot from:\r\n\r\n```\r\n2019-05-08T17:35:39Z Checking all blk files are present...\r\n2019-05-08T17:35:40Z Initializing chainstate Chainstate [ibd] @ height -1 (null)\r\nbitcoind: validation.cpp:2448: void CChainState::PruneBlockIndexCandidates(): Assertion `!setBlockIndexCandidates.empty()' failed.\r\n```\r\n\r\nI recovered with `-reindex` and then made the snapshot more carefully.\r\n\r\nWhen I restart the node during the snapshot sync, I notice that `monitorsnapshot` returns the wrong values for verification_progress of `snapshot` (e.g. `0.142`) which doesn't go up much until you restart again (`initialblockdownload: false`). I restarted a few times, and then it suddenly showed 0.9999 again.\r\n\r\nThe new logging every 2000 blocks feature doesn't work after restart.\r\n\r\nThe snapshot successfully validated, but when I try to shutdown gracefully it doesn't get beyond the \"dumped mempool\" message. Probably a thread locking issue; no crazy CPU or memory usage. I had to use `kill -9`, but fortunately it still worked at the next start.\r\n\r\nI haven't tried pruning yet.",
      "created_at" : "2019-05-08T19:05:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-490611693",
      "id" : 490611693,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDYxMTY5Mw==",
      "updated_at" : "2019-05-08T19:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490611693",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r282237828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282237828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I like your suggestion, thanks! Will work it into the commits.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2019-05-08T20:33:28Z",
      "diff_hunk" : "@@ -461,27 +461,89 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+public:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r282237828",
      "id" : 282237828,
      "in_reply_to_id" : 281848423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjIzNzgyOA==",
      "original_commit_id" : "e2c878bea3003662d4bbdd656f1dc627a271a9df",
      "original_line" : 471,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 235277762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T16:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282237828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-08T21:07:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-490499939",
      "id" : 490499939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDQ5OTkzOQ==",
      "updated_at" : "2019-05-08T21:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490499939",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can you split out d94356e086a2240773a42649ce6ef785b3a3d4b5 into a separate pull request? I need this for some of my fuzzing projects.\r\n\r\nSee #16703",
      "created_at" : "2019-08-23T22:32:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-524482297",
      "id" : 524482297,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDQ4MjI5Nw==",
      "updated_at" : "2019-08-23T22:32:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524482297",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On macOS 10.14.6 I'm seeing a warning:\r\n```\r\nvalidation.cpp:2222:64: warning: lambda capture 'func_name' is not required to be captured for this use [-Wunused-lambda-capture]\r\n    auto log_progress = [pindexNew, &coins_view, &chainParams, func_name](\r\n                                                             ~~^~~~~~~~~\r\nvalidation.cpp:4184:50: warning: comparison of integers of different signs: 'int64_t' (aka 'long long') and 'size_t' (aka 'unsigned long') [-Wsign-compare]\r\n        if (nCheckLevel >= 3 && curr_coins_usage <= chainstate.m_coinstip_cache_size_bytes) {\r\n                                ~~~~~~~~~~~~~~~~ ^  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n2 warnings generated.\r\n```\r\n\r\nCan you make the snapshot a bit more recent?\r\n\r\nI tried loading the snapshot I created back in May and noticed `2019-08-28T12:11:37Z [snapshot] waiting to see blockheader 000000000000001629aa3af57b421626b17c233ad0cd7197dfcc77389fe7b85e in headers chain before snapshot activation` burried in the log. Oops, that's a testnet snapshot :-) But this causes the RPC call to hang and makes it difficult to exit bitcoind, so we should probably detect this.\r\n\r\nUpdate: I made a fresh snapshot of a more recent block. When trying to import it the debug log said `2019-08-28T17:34:46Z [snapshot] assumeutxo value in snapshot metadata not valid for height 592000 - refusing to load snapshot`, but the RPC returned a cryptic `error code: -32603. error message:   Unable to load UTXO snapshot ...`.\r\n\r\n`flushing snapshot chainstate to disk` takes 10+ minutes. Can this step be skipped if `-dbcache` is large enough?\r\n\r\nIs this ignoring my `-dbcache` setting?\r\n```\r\n2019-08-28T17:55:49Z [Chainstate [snapshot] @ height 592003 (0000000000000000000919cc22af382ead360cd7a27572e19a2b6ac42baa6745)] resized coinsdb cache to 0.4 MiB\r\n2019-08-28T17:55:49Z [Chainstate [snapshot] @ height 592003 (0000000000000000000919cc22af382ead360cd7a27572e19a2b6ac42baa6745)] resized coinstip cache to 499.5 MiB\r\n2019-08-28T17:55:49Z Cache size (8699974960) exceeds total space (1523763712)\r\n```",
      "created_at" : "2019-08-28T12:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-525723416",
      "id" : 525723416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNTcyMzQxNg==",
      "updated_at" : "2019-08-28T17:58:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/525723416",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I made a torrent tracker for these snapshots, as well as limited capacity seeding:\r\n* mainnet: `magnet:?xt=urn:btih:556fb8dcc50059a62b0694f576a14e249156ab99&dn=utxo%5Fsnapshot%5F570000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n* testnet: `magnet:?xt=urn:btih:8780d3e8e336986a7fede11bea3e1209e2b25e41&dn=utxo%5Fsnapshot%5Ftestnet%5F1512062.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`",
      "created_at" : "2019-08-29T13:20:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-526181836",
      "id" : 526181836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjE4MTgzNg==",
      "updated_at" : "2019-08-29T13:20:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526181836",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "At the moment, the tip of this branch is broken - there's a lock inversion between the new `g_chainman.m_cs_chainstates` lock and `mempool.cs`. It's proven tricky to untangle because `ChainstateActive()` (which requires `g_chainman.m_cs_chainstates`) is called so pervasively.\r\n\r\nI tried swapping out m_cs_chainstates for cs_main since they're pretty much\r\nalways overlapping anyways, but that's a non-starter because you can't call\r\n`g_chainman.GetAll()` on top of `chainstate->ActivateBestChain()` because ABC\r\nasserts that cs_main isn't held (to drain the validation queue).\r\n\r\nI'm trying to work out the lowest-impact fix.\r\n\r\n### Notes\r\n\r\n```\r\n2019-08-20T17:18:51Z POTENTIAL DEADLOCK DETECTED\r\n2019-08-20T17:18:51Z Previous lock order was:\r\n2019-08-20T17:18:51Z  m_cs_chainstate validation.cpp:2675 (in thread loadblk)\r\n2019-08-20T17:18:51Z  cs_main validation.cpp:2693 (in thread loadblk)\r\n2019-08-20T17:18:51Z  (1) ::mempool.cs validation.cpp:2693 (in thread loadblk)\r\n2019-08-20T17:18:51Z  (2) g_chainman.m_cs_chainstates validation.cpp:86 (in thread loadblk)\r\n```\r\n\r\nwhich is \r\n\r\n  ActivateBestChain: LOCK(mempool.cs) \r\n  -> ConnectTip: LOCK(g_chainman.m_cs_chainstates) via ChainstateActive()\r\n\r\n```\r\n2019-08-20T17:18:51Z Current lock order is:\r\n2019-08-20T17:18:51Z  cs_main init.cpp:1484 (in thread init)\r\n2019-08-20T17:18:51Z  (2) m_cs_chainstates validation.cpp:5507 (in thread init)\r\n2019-08-20T17:18:51Z  cs_main validation.cpp:2046 (in thread init)\r\n2019-08-20T17:18:51Z  (1) cs txmempool.cpp:907 (in thread init)\r\n```\r\n\r\nwhich is\r\n\r\n  ChainstateManager.MaybeRebalanceCaches(): LOCK(m_cs_chainstates)\r\n  -> FlushStateToDisk\r\n  -> mempool.DynamicMemoryUsage(): LOCK(mempool.cs)\r\n",
      "created_at" : "2019-09-17T18:05:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-532335545",
      "id" : 532335545,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMjMzNTU0NQ==",
      "updated_at" : "2019-09-17T18:05:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/532335545",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It's proven tricky to untangle because ChainstateActive() (which requires g_chainman.m_cs_chainstates) is called so pervasively.\r\n\r\nCan't remember what we talked about last time this came up, but maybe m_cs_chainstates should be a shared mutex, that many threads can call lock_shared on simultaneously, and not block unless the chain is being swapped.\r\n\r\nThat way m_cs_chainstates could be locked at a really broad scope, before cs_main and mempool.cs, but it wouldn't hurt performance because it would be locked non-exclusively.\r\n",
      "created_at" : "2019-09-24T15:29:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-534612837",
      "id" : 534612837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDYxMjgzNw==",
      "updated_at" : "2019-09-24T15:29:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534612837",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm hosting some recent snapshots as a torrent (and tracker):\r\n* 570,000 mainnet `magnet:?xt=urn:btih:556fb8dcc50059a62b0694f576a14e249156ab99&dn=utxo%5Fsnapshot%5F570000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969` (made with older version, probably incompatible)\r\n* 600,000 mainnet: `magnet:?xt=urn:btih:e3c0b504c8e60c52653706079dbfecc5bcad5e02&dn=utxo%5Fmainnet%5F600000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n* 1,600,000 testnet: `magnet:?xt=urn:btih:701acffe49e83bce213ff337e52022c11368cdd0&dn=utxo%5Ftestnet%5F1600000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`",
      "created_at" : "2019-11-06T10:38:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-550251563",
      "id" : 550251563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MDI1MTU2Mw==",
      "updated_at" : "2019-11-15T13:39:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/550251563",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "A few quick updates on this branch.\r\n\r\n### New snapshots\r\n\r\nI've added an allowed assumeutxo hash at height 600,000 (which you can check with `./contrib/devtools/utxo_snapshot.sh - ./src/bitcoin-cli -datadir=[...]`) and have uploaded snapshot files ([Google Drive](https://storage.googleapis.com/assumeutxo/utxo.600k.dat), [Google Cloud](https://drive.google.com/file/d/1sGNpAsdQPPZNpWt7Wwbi5u3bHZiIKmSb/view?usp=sharing)) for testers' convenience. We obviously don't necessarily need to preserve this value for merge, but I figure it's useful for testing and not unrealistic.\r\n\r\nYou can test this branch easily by running a script like\r\n```sh\r\n#!/bin/bash\r\n\r\nset -e\r\nif [ ! -f ./src/bitcoind ]; then\r\n  echo \"Must be in built bitcoin directory.\"\r\n  exit 1\r\nfi\r\nSNAPSHOT_LOC=/tmp/utxo.600k.dat\r\nDATADIR=/tmp/bitcoin-assumeutxo-test\r\nmkdir -p $DATADIR\r\n\r\n[ -f ${SNAPSHOT_LOC} ] || curl -L https://storage.googleapis.com/assumeutxo/utxo.600k.dat > $SNAPSHOT_LOC\r\n/usr/bin/time -v ./src/bitcoind -datadir=$DATADIR -dbcache=4000 -stopatheight=604401 &\r\nsleep 60\r\n# Might timeout.\r\n/usr/bin/time -v ./src/bitcoin-cli -datadir=$DATADIR loadtxoutset $SNAPSHOT_LOC || true\r\nfg %1\r\n```\r\n\r\nAfter running this you should end up with a node that's synced to tip within 60-90 minutes depending on your internet connection and hardware.\r\n\r\n### Benchmarking\r\n\r\nI've compared reindexing to height 550,000 for this branch vs. its base ([a la previous PRs](https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-551883348)), and beyond some outlier runs on both sides, this changeset seems to be comparable in performance to master.\r\n\r\n```\r\nhost         tag                      time       time% maxmem  cpu%  dbcache\r\nbench-ssd-2  bench/au.1               9:24:53    0.92  6717.99MB 338%  5000MB\r\nbench-ssd-2  bench/au.1               9:23:14    0.92  6770.57MB 339%  5000MB\r\nbench-ssd-2  bench/au.master.1        10:08:33   0.99  6654.39MB 315%  5000MB\r\nbench-ssd-2  bench/au.master.1        10:13:04   1.00  6697.26MB 313%  5000MB\r\n\r\nbench-ssd-3  bench/au.master.1        9:26:17    0.93  6743.38MB 337%  5000MB\r\nbench-ssd-3  bench/au.master.1        9:24:03    0.93  6748.67MB 338%  5000MB\r\nbench-ssd-3  bench/au.1               9:22:35    0.92  6713.50MB 340%  5000MB\r\nbench-ssd-3  bench/au.1               10:08:36   1.00  6712.88MB 314%  5000MB\r\n\r\nbench-ssd-4  bench/au.1               9:24:59    0.93  6744.43MB 338%  5000MB\r\nbench-ssd-4  bench/au.1               10:06:09   1.00  6717.30MB 315%  5000MB\r\nbench-ssd-4  bench/au.master.1        9:23:44    0.93  6695.61MB 339%  5000MB\r\nbench-ssd-4  bench/au.master.1        9:23:56    0.93  6646.16MB 338%  5000MB\r\n\r\nbench-ssd-5  bench/au.master.1        9:18:57    1.00  6715.23MB 341%  5000MB\r\nbench-ssd-5  bench/au.master.1        9:20:35    1.00  6644.22MB 341%  5000MB\r\nbench-ssd-5  bench/au.1               9:17:27    0.99  6702.63MB 342%  5000MB\r\nbench-ssd-5  bench/au.1               9:21:17    1.00  6663.15MB 340%  5000MB\r\n```\r\n\r\nNote of course that as a sort of \"meta\"-optimization, these benchmarks are solely to ensure that we haven't introduced any performance regressions into normal operation. The really relevant benchmark here is \"time from empty datadir to usable node,\" which on one of my more capable machines has gone from ~20hrs to ~1hr. \r\n\r\n### Next steps\r\n\r\nIf you want to help move this project forward, the following PRs are prerequisites and once they're merged I'll carve off the next changeset:\r\n\r\n- #16945 \r\n- #17487 \r\n\r\n### Current work\r\n\r\nAfter significantly revising the structure of the snapshot file in #16899, this branch has been substantially rebased to avoid the requirement of any on-disk snapshot metadata once the snapshot has been loaded; instead we look to filesystem state (the presence of a `$DATADIR/chainstate_*` folder) to signal that we are currently building a snapshot chainstate. Once this chainstate has been fully back validated, we move it over to the regular `chainstate/` dir on shutdown. We also used to need on-disk state to restore the \"faked\" `nChainTx` data for snapshot-based header chains -- we now cache that information in the snapshot's chainstate itself (https://github.com/bitcoin/bitcoin/pull/15606/commits/87093a94ba311c495a1982f4f47d0c4607789f8f).\r\n\r\nI'm currently thinking about how to handle locking semantics (as you might be able to tell from the last commit, which needs to be squashed into the rest of the history at some point) which I can detail further if anyone's interested.",
      "created_at" : "2019-11-18T21:17:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-555213164",
      "id" : 555213164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTIxMzE2NA==",
      "updated_at" : "2019-11-18T21:17:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555213164",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Commits that can be split out and submitted for review in parallel:\r\n\r\n* f416c16b5728c91b071e18ea860a59c0401dcb5d\r\n* ba1f760cdad07331b403966a0d3ab8b3f9898799 (partially, at least)\r\n* e75fbc3087c1ad5039c946a0ac3107d6d2c84b94 (after #18698 ?)\r\n\r\ncommit 9b665e999bc82b98ff317907370db6f65efb2b43 can be dropped, no? It is already properly marked:\r\n\r\n```\r\n$ git grep 'bool LoadBlockIndex('\r\nsrc/validation.cpp:bool LoadBlockIndex(const CChainParams& chainparams)\r\nsrc/validation.h:bool LoadBlockIndex(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\nsrc/validation.h:    bool LoadBlockIndex(\r\n",
      "created_at" : "2020-04-20T15:06:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-616613653",
      "id" : 616613653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNjYxMzY1Mw==",
      "updated_at" : "2020-04-20T15:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/616613653",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Why is GitHub so horribly useless? I can't even see the last comment I posted here two weeks ago without spending minutes unwrapping the discussion",
      "created_at" : "2020-05-23T12:32:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-633044179",
      "id" : 633044179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzA0NDE3OQ==",
      "updated_at" : "2020-05-23T12:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633044179",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Quick update. I've rebased this PR in such a way that it does not rely on changes in #17487 to avoid being blocked on that going through. If that does merge, it'll be easy to update this branch to make use of the flush-without-erase behavior.\r\n\r\nThis needs testing (which I plan to do soon) as it's been a while since I've gone through the whole battery of manual system tests (i.e. actually loading snapshots and syncing). I need to focus on writing a few more functional and unit tests that will obviate most of that manual work. Some intermediate commits here almost certainly have compilation errors.\r\n\r\nThis project is getting to the point where it's less straightforward to find discrete bits of this draft to carve off for individual merge. Among the next changes are the snapshot activation procedure, the related RPC command for loading a snapshot, and all the little correspondent changes that have to happen in modules like net_processing to have snapshot chainstates actually function. I guess it makes sense to PR the snapshot activation changes (https://github.com/bitcoin/bitcoin/pull/15606/commits/eae9c625b10a7b5e6495ebef8698a98873f4933a) individually, but after that it may be somewhat less straightforward to carve off commits. \r\n\r\nI'm wondering how averse people would be to treating much of the remainder of this draft as a single PR, and subsequently finishing off the first phase of assumeutxo in two or so more PRs?",
      "created_at" : "2020-08-01T19:51:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-667579173",
      "id" : 667579173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzU3OTE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-01T19:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667579173",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I still thinks this can and should be split up further, since that makes it easier to find reviewers for the part of the code that is modified. For example, the net_processing additions might be reviewed by a different set of people than the validation changes like 8ce5eb04d5ec21843e6a3919d0beee9f6e6589fe",
      "created_at" : "2020-08-02T05:45:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-667631605",
      "id" : 667631605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzYzMTYwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-02T05:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667631605",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebase time now that #19806 landed?",
      "created_at" : "2021-02-17T15:29:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-780635284",
      "id" : 780635284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDYzNTI4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T15:29:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780635284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Rebase time now that #19806 landed?\r\n\r\nYup, actively working on it.",
      "created_at" : "2021-02-17T15:35:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-780639279",
      "id" : 780639279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDYzOTI3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T15:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780639279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach ACK / light review ACK 285d5dd3e409c1f14f50c46f18b3b1338f7ab9f6\r\n\r\nLooking at the remaining commits it seems like the assumeutxo implementation is actually 75% merged already, and remaining changes are mostly tweaking code that hardcodes or assumes ActiveChainstate to instead handle multiple chainstates.\r\n\r\nCurrent approach of splitting this large PR into medium sized PRs to be reviewed and merged sequentially (starting with #21526) seems reasonable and is probably ideal. I could also imagine a different approach thats splits out the tweaky commits as small obvious 1-commit PRs that could be reviewed in parallel, but this might just be more work and not solve anything.\r\n\r\nIn an ideal world it would be nice if individual changes here could be accompanied by unit tests confirming the new behaviors, but understandable that this isn't happening since validation code is not very modular.",
      "created_at" : "2021-04-01T01:32:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-811573676",
      "id" : 811573676,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTU3MzY3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T01:32:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811573676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to see a rebase of this, as it's a bit easier to understand the prerequisite PR's in their full context.",
      "created_at" : "2021-05-21T13:46:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-845962015",
      "id" : 845962015,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTk2MjAxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-21T13:46:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845962015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Agree with @Sjors . Currently it is not possible to test the \"great picture\" and only unit test or code review the split out patches.",
      "created_at" : "2021-05-25T08:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-847672512",
      "id" : 847672512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzY3MjUxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T08:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847672512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the pings, I'll start this tomorrow.",
      "created_at" : "2021-05-25T16:23:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-848022181",
      "id" : 848022181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0ODAyMjE4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T16:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/848022181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`utxo-dumpload.61`](https://github.com/jamesob/bitcoin/tree/utxo-dumpload.61) -> [`utxo-dumpload.62`](https://github.com/jamesob/bitcoin/tree/utxo-dumpload.62) ([range-diff](https://gist.github.com/jamesob/264f4bbb402b3c03c8dda241f83e5ae5))\r\n\r\nLarge rebase encompassing\r\n\r\n- many net_processing refactors by @jnewbery @rebroad et al. (#21713)\r\n- @dongcarl's chainstate deglobalization (#20158)\r\n- pruning updates for the blockfilter index (#15946)\r\n- and probably others I'm forgetting.\r\n\r\nIn the next few days I'll be manually testing this, which will require re-adding an actual assumeutxo value in chainparams after generating a recent snapshot. While or after that's happening, I'll see about generating a snapshot for use by the functional tests (and then actually writing them).\r\n\r\n",
      "created_at" : "2021-05-27T20:56:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-849935729",
      "id" : 849935729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0OTkzNTcyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-27T20:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849935729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Torrent for my snapshot at height 685,000: `magnet:?xt=urn:btih:bbc943dd7a97bff4bab7a039414e4dae5fbf5a3c&dn=utxo%5Fmainnet%5F685000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nTo make this snapshot, I rolled back to the correct height: `bitcoin-cli invalidateblock 00000000000000000002091619d7ae1596349afb10fe8cb1833a09945db1180d` and then called `dumptxoutset` (same procedure as `contrib/devtools/utxo_snapshot.sh`).\r\n\r\nIt's probably broken given that `coins_written` is `0`\r\n\r\n```json\r\n{\r\n  \"coins_written\": 0,\r\n  \"base_hash\": \"000000000000000000043a68d9e09f48eeb485ac28bde0abb6e0b6cb6e726a21\",\r\n  \"base_height\": 685000,\r\n  \"path\": \"...\",\r\n  \"assumeutxo\": \"771ad185615493278a5d62b4fa865ca47cbfc54dbeb3a9157535bc0d856369e4\"\r\n}\r\n```\r\n\r\nWhen attempting to load for a fresh IBD, by adding the snapshot to `chainparams.cpp`:\r\n\r\n```cpp\r\n        m_assumeutxo_data = MapAssumeutxo{\r\n            {\r\n                685000,\r\n                {AssumeutxoHash{uint256S(\"0x771ad185615493278a5d62b4fa865ca47cbfc54dbeb3a9157535bc0d856369e4\")}, 685000},\r\n            },\r\n        };\r\n```\r\n\r\nThe load `loadtxoutset` call fails with `[snapshot] bad snapshot - coins left over after deserializing 0 coins`",
      "created_at" : "2021-05-31T18:42:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-851632661",
      "id" : 851632661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MTYzMjY2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-31T18:45:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/851632661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing @Sjors. I couldn't reproduce your bug, but during manual testing I did find a number of issues based upon changes that have happened since last rebase. Subsequently I've pushed a bunch of new commits, some of which need to be fixed up. I've also done a manual test of the assumeutxo workflow and everything seems to be working properly again. \r\n\r\nI also found an issue, possibly new but possibly not, related to restarting bitcoind while using a snapshot that has not yet been fully validated. Basically, faked `nTx` values were not persisting and so `LoadBlockIndex()` was failing due to not constructing `setBlockIndexCandidates` as expected. \r\n\r\nIn response to the this as well as the recent changes in `RewindBlockIndex`, I've decided to make a change consistent with a previous recommendation from @ryanofsky: instead of mutating \"fake\" data into the block index for assumed-valid blocks, I'm instead explicitly accounting for the possibility of snapshot use at usage sites (e.g. `LoadBlockIndex()`, `NeedsRedownload()`). I think this is easier to reason about instead of relying on some implicit data faking.\r\n\r\n### Manual testing\r\n\r\nI've generated a snapshot at 685000 using the `utxo_snapshot.sh` contrib script.\r\n\r\n```sh\r\nsrc/bitcoin (? utxo-dumpload-compressed 4dfd3a2) % /usr/bin/time ./contrib/devtools/utxo_snapshot.sh 685000 utxo-685.dat ./src/bitcoin-cli\r\nRewinding chain back to height 685000 (by invalidating 00000000000000000002091619d7ae1596349afb10fe8cb1833a09945db1180d); this may take a while\r\nGenerating UTXO snapshot...\r\n{\r\n  \"coins_written\": 75696073,\r\n  \"base_hash\": \"000000000000000000043a68d9e09f48eeb485ac28bde0abb6e0b6cb6e726a21\",\r\n  \"base_height\": 685000,\r\n  \"path\": \"/home/james/.bitcoin/utxo-685.dat\",\r\n  \"assumeutxo\": \"a85dd26a5ca449d76bc7cb6103960a2894475f11acef57efb77d833ca84d0ed3\",\r\n  \"nchaintx\": 644907744\r\n}\r\nRestoring chain to original height; this may take a while\r\n0.01user 0.00system 14:13.84elapsed 0%CPU (0avgtext+0avgdata 4712maxresident)k\r\n2688inputs+0outputs (22major+1584minor)pagefaults 0swaps\r\n```\r\n\r\nI then create a new datadir (`~/.bitcoin/utxo-test`), start up, and immediately load the snapshot:\r\n\r\n```sh\r\nsrc/bitcoin (? utxo-dumpload-compressed 4dfd3a2) % /usr/bin/time ./src/bitcoin-cli -datadir=/home/james/.bitcoin/utxo-test loadtxoutset ~/.bitcoin/utxo-685.dat\r\n{\r\n  \"coins_loaded\": 75696073,\r\n  \"tip_hash\": \"000000000000000000043a68d9e09f48eeb485ac28bde0abb6e0b6cb6e726a21\",\r\n  \"base_height\": 685000,\r\n  \"path\": \"/home/james/.bitcoin/utxo-685.dat\"\r\n}\r\n0.00user 0.00system 12:49.51elapsed 0%CPU (0avgtext+0avgdata 4348maxresident)k\r\n3536inputs+0outputs (18major+233minor)pagefaults 0swaps\r\n```\r\n\r\nAfter load, I verified that the snapshot chain successfully syncs to tip, caches rebalance accordingly, and background validation starts. I also verified that the snapshot tip is maintained without issue as new blocks come in.\r\n\r\n### Next\r\n\r\nFunctional tests will be added to this branch. I may also add a contrib script that makes \"demoing\" the assumeutxo workflow more straightforward.\r\n",
      "created_at" : "2021-06-08T17:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-856949780",
      "id" : 856949780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1Njk0OTc4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-08T17:18:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856949780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This seems to work better:\r\n```\r\n{\r\n  \"coins_written\": 74785038,\r\n  \"base_hash\": \"00000000000000000004331a2b2230ee390f3cd8969c4b533e616a6805ccf918\",\r\n  \"base_height\": 687000,\r\n  \"path\": \"/Users/sjors/Library/Application Support/Bitcoin/utxo_mainnet_687000.dat\",\r\n  \"assumeutxo\": \"c6d8016d392df4a9b57c96a432347df3971b78da5b095bd2eafe71da84206892\",\r\n  \"nchaintx\": 648168241\r\n}\r\n```\r\n\r\nTorrent: `magnet:?xt=urn:btih:65361833886f742cc519003f8f85ebfe26979a36&dn=utxo%5Fmainnet%5F687000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nTo use the snapshot, edit `chainparams.cpp`:\r\n\r\n```cpp\r\n        m_assumeutxo_data = MapAssumeutxo{\r\n            {\r\n                687000,\r\n                {AssumeutxoHash{uint256S(\"0xc6d8016d392df4a9b57c96a432347df3971b78da5b095bd2eafe71da84206892\")}, 648168241},\r\n            },\r\n        };\r\n```\r\n\r\nWith a fresh datadir I'm able to load this snapshot (`-rpcclienttimeout=0` is handy) and sync to the tip. We'll see if background sync succeeds too...\r\n\r\nWhen loading fails, e.g. because it's the wrong height, the error returned by the RPC call could be more useful.",
      "created_at" : "2021-06-10T17:27:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-858813824",
      "id" : 858813824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODgxMzgyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T17:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858813824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On the road to writing actual functional tests (which may be somewhat of a challenge), I've added a demo/manual testing script (https://github.com/bitcoin/bitcoin/pull/15606/commits/322a9e9fc1d0edc3297a92618edc912c50bc0fd8) that should allow anyone to get acquainted with the assumeutxo feature.\r\n\r\nUsing it should be easy; clone this branch, `make`, and then run `./contrib/devtools/test_utxo_snapshots.sh` and follow the instructions. The script itself involves creating a snapshot, modifying the chainparams, and then watching the snapshot-based sync process followed by background validation. It's also a happy-path test of the changes here. I hope others find it useful, even if it just ends up being an ephemeral thing for testing that is never merged.",
      "created_at" : "2021-06-16T16:15:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-862515638",
      "id" : 862515638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjUxNTYzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T16:15:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862515638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've done a cleanup rebase as well as pushing a basic functional test (https://github.com/bitcoin/bitcoin/pull/15606/commits/aa65b21d79d9cc0d79925879bc62e1c240a1cf59) that can probably use some embellishment.",
      "created_at" : "2021-06-17T21:30:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-863577706",
      "id" : 863577706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzU3NzcwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T21:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863577706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655576593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655576593"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: have LoadGenesisBlock work on all chainstates\" (35ef764b7c8a7ebf0760e0eff52eda95ebac1136)\r\n\r\nProbably this should be deleted, it's just declaring that a function which doesn't exist would be a friend.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T17:31:21Z",
      "diff_hunk" : "@@ -814,6 +814,7 @@ class CChainState\n     bool LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n     friend ChainstateManager;\n+    friend bool LoadGenesisBlock(const CChainParams&);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655576593",
      "id" : 655576593,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTU3NjU5Mw==",
      "original_commit_id" : "35ef764b7c8a7ebf0760e0eff52eda95ebac1136",
      "original_line" : 817,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655576593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655581515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655581515"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"dumptxoutset: add assumeutxo key to output\" (cd1986f7abe6d6c7ce0918ac8cd62864205e373e)\r\n\r\nPath could be mentioned in commit description",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T17:38:51Z",
      "diff_hunk" : "@@ -2620,7 +2621,8 @@ UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFil\n     result.pushKV(\"coins_written\", stats.coins_count);\n     result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n     result.pushKV(\"base_height\", tip->nHeight);\n-\n+    result.pushKV(\"path\", path.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655581515",
      "id" : 655581515,
      "line" : 2635,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTU4MTUxNQ==",
      "original_commit_id" : "cd1986f7abe6d6c7ce0918ac8cd62864205e373e",
      "original_line" : 2624,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 64,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655581515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655586738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655586738"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: avoid rescans if under the snapshot\" (88a90b394c8936c695717927954b2b4299ff899b)\r\n\r\nThis seems strange. Why would this be returning number of transactions instead of the height? This seems like it would cause the `rescan_height < chain.getLowestBlockDataHeight()` below to be true in cases when it should be false and ignore the wallet sync error.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T17:46:40Z",
      "diff_hunk" : "@@ -457,6 +457,11 @@ class ChainImpl : public Chain\n         LOCK(cs_main);\n         return CheckFinalTx(chainman().ActiveChain().Tip(), tx);\n     }\n+    int getLowestBlockDataHeight() override\n+    {\n+        LOCK(cs_main);\n+        return Assert(m_node.chainman)->GetSnapshotNChainTx().value_or(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655586738",
      "id" : 655586738,
      "line" : 463,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTU4NjczOA==",
      "original_commit_id" : "88a90b394c8936c695717927954b2b4299ff899b",
      "original_line" : 463,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 7,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655586738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655628898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655628898"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: only send ValidationInterface callbacks for active chain\" (5505d17e21d886d85b614a13e7fc8a61d6bf4fe9)\r\n\r\nMaybe update validationinterface.h documentation to say no notifications will be sent about updates to the background chainstate. If a snapshot is loaded only notification about blocks after the snapshot are sent, IIUC",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T18:55:23Z",
      "diff_hunk" : "@@ -3512,8 +3520,11 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, Block\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!IsInitialBlockDownload() &&\n+            m_chain.Tip() == pindex->pprev &&\n+            this == &m_chainman.ActiveChainstate()) {\n         GetMainSignals().NewPoWValidBlock(pindex, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655628898",
      "id" : 655628898,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTYyODg5OA==",
      "original_commit_id" : "5505d17e21d886d85b614a13e7fc8a61d6bf4fe9",
      "original_line" : 3526,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 278,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655628898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655635682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655635682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add BackgroundBlockConnected and use it for indexing\" (0575a333ca1d02ecca7f651a41572ebd62de224b)\r\n\r\nIn general, it's not clear to me how this PR affects indexing. I assume this TODO needs to be addressed to avoid problems, but it's not really clear what problems may be or if fixing this fixes everything",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T19:06:38Z",
      "diff_hunk" : "@@ -262,6 +262,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655635682",
      "id" : 655635682,
      "line" : 274,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTYzNTY4Mg==",
      "original_commit_id" : "0575a333ca1d02ecca7f651a41572ebd62de224b",
      "original_line" : 265,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 20,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655635682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655637249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655637249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" (a5bd8e91aaf77853f1162a21f84efbe0e9754d5f)\r\n\r\nProbably wallet change here is meant to be part of earlier wallet commit",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-21T19:09:11Z",
      "diff_hunk" : "@@ -2761,7 +2761,6 @@ bool CWallet::AttachChain(const std::shared_ptr<CWallet>& walletInstance, interf\n         }\n         // Otherwise refuse to rescan if we're operating on a snapshot and the\n         // rescan height is at or lower than the base of the snapshot.\n-        //",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r655637249",
      "id" : 655637249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTYzNzI0OQ==",
      "original_commit_id" : "a5bd8e91aaf77853f1162a21f84efbe0e9754d5f",
      "original_line" : 2764,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 688698275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655637249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I was able to complete an IBD with my earlier snapshot using c78a2c743b5cedd9b9948ad355268798baa01bee (and a modified chain params).\r\n\r\nI noticed it didn't clean up the `cainstate_blah_hash` directory after it was done. But I didn't bother checking if a restart fixed that (already wiped that data dir).",
      "created_at" : "2021-06-22T09:27:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-865813255",
      "id" : 865813255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTgxMzI1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T17:26:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865813255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656257050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656257050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Absolutely, this is just totally wrong. Probably used the wrong method in the process of rebasing the `Assert(...)->` change in.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-22T14:06:36Z",
      "diff_hunk" : "@@ -457,6 +457,11 @@ class ChainImpl : public Chain\n         LOCK(cs_main);\n         return CheckFinalTx(chainman().ActiveChain().Tip(), tx);\n     }\n+    int getLowestBlockDataHeight() override\n+    {\n+        LOCK(cs_main);\n+        return Assert(m_node.chainman)->GetSnapshotNChainTx().value_or(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656257050",
      "id" : 656257050,
      "in_reply_to_id" : 655586738,
      "line" : 463,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NjI1NzA1MA==",
      "original_commit_id" : "88a90b394c8936c695717927954b2b4299ff899b",
      "original_line" : 463,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 7,
      "pull_request_review_id" : 689555908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T14:06:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656257050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656310455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656310455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "And probably indicates I should write a test for this.",
      "commit_id" : "b382f97e24c91c97cc40707adba809955ba070a8",
      "created_at" : "2021-06-22T15:01:29Z",
      "diff_hunk" : "@@ -457,6 +457,11 @@ class ChainImpl : public Chain\n         LOCK(cs_main);\n         return CheckFinalTx(chainman().ActiveChain().Tip(), tx);\n     }\n+    int getLowestBlockDataHeight() override\n+    {\n+        LOCK(cs_main);\n+        return Assert(m_node.chainman)->GetSnapshotNChainTx().value_or(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656310455",
      "id" : 656310455,
      "in_reply_to_id" : 655586738,
      "line" : 463,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NjMxMDQ1NQ==",
      "original_commit_id" : "88a90b394c8936c695717927954b2b4299ff899b",
      "original_line" : 463,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 7,
      "pull_request_review_id" : 689630642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T15:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656310455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656467017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656467017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll elaborate on this in some form soon, but the gist of it is that if indexing has ordering requirements, it has to make particular use of the `BackgroundBlockValidated` callback (which is why I introduced it); luckily all of the indexers (as far as I'm aware) don't have strict ordering requirements and each block can more or less be processed in isolation (aside from bestblock tracking, used to signal completion of index building).",
      "commit_id" : "6e7711c935c0e68f190bb334dd84ffc855e4ff18",
      "created_at" : "2021-06-22T18:11:59Z",
      "diff_hunk" : "@@ -262,6 +262,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656467017",
      "id" : 656467017,
      "in_reply_to_id" : 655635682,
      "line" : 274,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NjQ2NzAxNw==",
      "original_commit_id" : "0575a333ca1d02ecca7f651a41572ebd62de224b",
      "original_line" : 274,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 20,
      "pull_request_review_id" : 689849679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T18:12:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656467017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656485745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656485745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "6e7711c935c0e68f190bb334dd84ffc855e4ff18",
      "created_at" : "2021-06-22T18:36:45Z",
      "diff_hunk" : "@@ -2620,7 +2621,8 @@ UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFil\n     result.pushKV(\"coins_written\", stats.coins_count);\n     result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n     result.pushKV(\"base_height\", tip->nHeight);\n-\n+    result.pushKV(\"path\", path.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r656485745",
      "id" : 656485745,
      "in_reply_to_id" : 655581515,
      "line" : 2635,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NjQ4NTc0NQ==",
      "original_commit_id" : "cd1986f7abe6d6c7ce0918ac8cd62864205e373e",
      "original_line" : 2635,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 64,
      "pull_request_review_id" : 689874957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-22T18:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656485745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Anyway, I'm going to try a different tack here and open a bunch of smallish, independently mergeable PRs containing some of the commits here that shouldn't change any behavior\r\n\r\nWith the big picture in this PR being up to date, it should be easier to review your (upcoming) smaller PR's. Forest, trees, clear.",
      "created_at" : "2021-06-23T12:33:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-866796046",
      "id" : 866796046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Njc5NjA0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-23T12:33:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/866796046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Notes from going through this PR and writing down the behavior changes:\r\n\r\n- UpdateTip() - skip updating mempool transactions count for background chainstate\r\n  - would be better if background chainstate mempool pointer was just null?\r\n- UpdateTip() - skip activation warning for background chainstate\r\n  - would be better if background chainstate just considered always IBD? (since the warnings are already skipped for IBD)\r\n- CChainState::CheckBlockIndex() - skip snapshot chainstate block havedata checks\r\n  - would be better if pindexFirstMissing, pindexFirstNeverProcessed, setBlockIndexCandidates were chainstate members instead of globals?\r\n- CChainState::FlushStateToDisk() - suppress notification for background chainstate (used for wallet bestblock)\r\n- CChainState::DisconnectTip() - suppress notification for background chainstate\r\n  - unclear why disconnect would happen for background chainstate\r\n- CChainState::ConnectTip() - suppress notification for background chainstate\r\n- CChainState::ActivateBestChain() - suppress notifications (BlockConnected, UpdatedBlockTip, NotifyBlockTip) for background chainstate\r\n- CChainState::AcceptBlock() - suppress notification (NewPoWValidBlock) for background chainstate\r\n - would be better to suppress based on IBD?\r\n- ChainstateManager::ProcessNewBlock() - call CChainState::AcceptBlock() for background chainstate\r\n- FindNextBlocksToDownload() - replace global `pindexLastCommonBlock` with per-chainstate `chainstate_to_last_common_block`\r\n- PeerManagerImpl::ProcessMessage & PeerManagerImpl::MaybeSendAddr() - consider node to be in IBD state and not advertise if there is a background chain\r\n- AppInitMain() - call InitCoinsDB earlier, and use smaller starting cache size, and add MaybeRebalanceCaches call\r\n- Shutdown() - stop calling ResetCoinsViews (why?)\r\n- AppInitMain() - call CheckForUncleanShutdown\r\n- CChainState::ConnectTip() - call CompleteSnapshotValidation\r\n- CChainState::ActivateBestChain() - return early if m_stop_use unexpected error condition is true\r\n- CChainState::ActivateBestChain() - call MaybeRebalanceCaches if ibd changes true to false\r\n- BlockManager::FindFilesToPruneManual() - avoid pruning background chainstate blocks\r\n- CChainState::ConnectTip() - avoid calling m_mempool.removeForBlock and disconnectpool.removeForBlock for background chainstate\r\n- ChainstateManager::ProcessNewBlockHeaders() - call chainstate->CheckBlockIndex for all chains\r\n- BlockManager::LoadBlockIndex() - set pindex->nChainTx for first block after snapshot\r\n- BlockManager::LoadBlockIndex() - loop over chains to set setBlockIndexCandidates for all chains\r\n- CChainState::NeedsRedownload() - stop returning true for background chainstate download blocks because they don't have witness data flag set yet. this doesn't affect download just avoids \"missing data, please reindex\" error on startup",
      "created_at" : "2021-06-25T14:48:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-868553822",
      "id" : 868553822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2ODU1MzgyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-25T14:48:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/868553822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Russ, thanks for the thorough and thoughtful look here. Really appreciate your design guidance.\r\n\r\nOf course I have the predictable grumbles about the rework necessary and a slight dread at the prospect of introducing more prerequisite refactoring (given this project has been ongoing for two years already), but on design questions like this I'm inclined to side with you given (i) this code began as a minimum-viable demo prototype, and (ii) I've been staring at it for too damn long to be objective.\r\n\r\nCorrect me if I'm wrong, but one of the motivating factors behind your suggestion here is the notion that we may one day be facilitating `n` background chainstates instead of just 1, at which point some rework would be required to fix the abstractions for that case. Indeed the utreexo project that @kcalvinalvin @adiabat et al. have been working on may introduce such a usage.\r\n\r\nJust a few potshot responses before really gauging the level of effort required to make the changes you're talking about:\r\n\r\n> HasMempool vs IsActiveChain\r\n\r\nOne pushback I might have is that a lot of the \"inline\" logic that's scattered throughout parts of validation and net_processing won't actually by simplified by relatively surface-level transformations of `== ActiveChainstate()` -> `HasMempool()`. In some cases switching behavior on mempool presence might be even more confusing (e.g. https://github.com/bitcoin/bitcoin/pull/15606/commits/b51d6d7a30bc6c9bd0a63549254156ae3aeb6d4a) since the mempool is basically unrelated to things like validationinterface callbacks. But maybe making that change for cases where the mempool is relevant might make sense and be pretty easy (https://github.com/bitcoin/bitcoin/pull/15606/commits/70395ccedafd54fda2bc2e634e631935f5f1cec3).\r\n\r\nFundamentally a lot of the validation/net logic just needs to know whether it's dealing with the active chainstate or not; I don't see a way around that short of moving a maybe-inappropriate amount of domain-specific code into the ChainstateManager. \r\n\r\n> supporting `n` chainstates\r\n\r\nIf our goal is to facilitate `n` background chainstates instead of just 1 (although maybe your goal is purely to make the code easier to follow?), my inclination would be to say that we should wait until we're actually looking to implement `n` chainstates before spending a bunch of time on design changes.\r\n\r\nOn list-of-chainstates vs. `m_ibd_chainstate` and `m_snapshot_chainstate`, these are private members  of chainman and so swapping them out for a list (when necessary) should be pretty easily doable. But until we have actual use for a list, doing such a refactoring would kind of make awkward [things like cache rebalancing](https://github.com/bitcoin/bitcoin/blob/7317e14a44c6efc545e6fb9bcedee7174e93a8fa/src/validation.cpp#L5055-L5083). I guess that could be rephrased in terms of more general math... but why introduce the generality before we need it?\r\n\r\n> instead of having to write special case pruning logic, this could be integrated with Improve Indices on pruned nodes via prune blockers #21726, and each chainstate could just add to a list of prune blockers\r\n\r\nCan we not do this under the current design? I don't see why the suggested design changes would enable or simplify this, but admittedly I haven't given that work a close look yet.\r\n\r\n> Keeping future code maintainable and having confidence in completeness of the change.\r\n\r\nI think the reality is that introducing the possibility of multiple chainstates is a huge overhaul to the system and there's no free lunch in terms of simplification. Unless we move a lot of domain-specific code into the chainman, we're not going to get around some degree of scatter. I think in either case, you're not going to be able to verify completeness without grepping for every `CChainState` usage and manually examining it; I don't think there's a way around this regardless of the design you choose.\r\n\r\n---\r\n\r\nGrumbles aside I will spend the next few days trying to implement your proposed changes in an alternate branch. If the diff is small enough and I get your sign-off on completeness, I'll replace HEAD here.",
      "created_at" : "2021-06-28T18:33:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-869921671",
      "id" : 869921671,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTkyMTY3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T18:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869921671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks and to be sure I'm happy to review any version of this PR with or without the changes I was suggesting. My comment https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-692965905 was trying to make sense of things for myself as much as it was trying to give suggestions for the PR. So definitely feel free to any skip extra implementation work unless you think it will actually improve things.\r\n\r\nBut just to clarify, supporting multiple background chainstates was not my motivation at all. (I did try to think of use cases for multiple chainstates but couldn't think of any that seemed very realistic.) My motivation was purely to make resulting code more understandable and maintainable. I think ideally assumeutxo phases would be encapsulated completely in the ChainstateManager class and not referenced in any other validation code, including ChainState methods. I think outside of ChainstateManager no other validation code that should have to know about the \"IBD chainstate\" \"Snapshot chainstate\" \"Active chainstate\" \"Background IBD chainstate\" or\"Validated chainstate\". The jargon still just blurs together for me. I think ideally validation code should just deal with chains and blocks based on their attributes, not based on assumeutxo stages or the global sync state. Things just seem less confusing and more reassuring that way (more reassuring because special cases are less special and because background chainstates don't have access to the mempool).",
      "created_at" : "2021-06-28T19:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-869986387",
      "id" : 869986387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTk4NjM4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T19:54:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869986387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @ryanofsky, that's a really helpful clarification for me. Agree that there is probably more of a proliferation of assumeutxo jargon than there needs to be. At the very least what I think I can do is consolidate terminology to \"active\" chainstate vs. \"background\" chainstate (... or maybe just non-\"active\"?). I'll look at doing that in addition to your other recommendations.\r\n\r\nI've pushed a rebase ([`utxo-dumpload.81`](https://github.com/jamesob/bitcoin/tree/utxo-dumpload.81)) that reintroduces https://github.com/bitcoin/bitcoin/pull/15606/commits/cf9366fa4ffb37fd07ef44f0e8495226dcd72aea which I thought I might be able to omit but apparently is required to avoid test failures in certain configurations. I'm going to dig into the particulars of the related error to reconfirm the necessity of the commit.",
      "created_at" : "2021-06-28T20:09:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-869999896",
      "id" : 869999896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTk5OTg5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T20:09:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869999896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> In some cases switching behavior on mempool presence might be even more confusing (e.g. [b51d6d7](https://github.com/bitcoin/bitcoin/commit/b51d6d7a30bc6c9bd0a63549254156ae3aeb6d4a)) since the mempool is basically unrelated to things like validationinterface callbacks.\r\n\r\nThis is probably subjective, but I don't see it as being unrelated. If the chain is connected to the mempool it's active, and `BlockConnected` should be called instead of `BackgroundBlockConnected`, and rewinds and disconnects are possible instead of impossible, and other notifications should be sent too. \r\n\r\n> Fundamentally a lot of the validation/net logic just needs to know whether it's dealing with the active chainstate or not;\r\n\r\nThere could be `bool IsBackground() const { return m_mempool == nullptr; }` or  `bool IsActive() const { return m_mempool != nullptr; }` helpers maybe. I tend to not like vocabulary-introducing things like this, because then you have the mental overhead of putting cases into a taxonomy instead of just making all the code handle all the cases. But this is very subjective.\r\n\r\n> I don't see a way around that short of moving a maybe-inappropriate amount of domain-specific code into the ChainstateManager.\r\n\r\nI'm actually not sure what this would be referring to.\r\n\r\n> On list-of-chainstates vs. `m_ibd_chainstate` and `m_snapshot_chainstate`, these are private members of chainman and so swapping them out for a list (when necessary) should be pretty easily doable. But until we have actual use for a list, doing such a refactoring would kind of make awkward [things like cache rebalancing](https://github.com/bitcoin/bitcoin/blob/7317e14a44c6efc545e6fb9bcedee7174e93a8fa/src/validation.cpp#L5055-L5083). I guess that could be rephrased in terms of more general math... but why introduce the generality before we need it?\r\n\r\nFunny, it seems to me more general, less hardcoded math would actually be simpler to understand. Take the cache, divide it up, maybe boost some chain's weighting (I forget already) by some factor based on it's attributes. No thinking about assumeutxo phases or terminology.\r\n\r\n> > instead of having to write special case pruning logic, this could be integrated with Improve Indices on pruned nodes via prune blockers #21726, and each chainstate could just add to a list of prune blockers\r\n> \r\n> Can we not do this under the current design? I don't see why the suggested design changes would enable or simplify this, but admittedly I haven't given that work a close look yet.\r\n\r\nYes this would be doable under current design. I just mentioned it because it would be optional under current design, but required under the suggested design (because pruning code wouldn't know about the types of chainstates, it would just have to treat them generically and ask what blocks they need to keep).\r\n\r\n> > Keeping future code maintainable and having confidence in completeness of the change.\r\n> \r\n> I think the reality is that introducing the possibility of multiple chainstates is a huge overhaul to the system and there's no free lunch in terms of simplification. Unless we move a lot of domain-specific code into the chainman, we're not going to get around some degree of scatter.\r\n\r\nI don't think I'm suggesting to move any large pieces of code, but yes I do think ChainstateManager would be a little more complex because it would be more responsible for setting up and updating attributes of the chains so other validation code doesn't have to know about assumeutxo. I think this is just how things go with encapsulation. You don't necessarily reduce complexity, but you try locate it in one place.\r\n\r\nAgain though everything here is a suggestion and you will have a much better idea of this stuff than me. I'll take a look at the new branch, and I'm happy to review anything.",
      "created_at" : "2021-06-28T20:37:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-870024022",
      "id" : 870024022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MDAyNDAyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T20:41:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/870024022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Changing m_mempool from reference to pointer is something I wanted to do anyway for the `-nomempool` config option. If this also simplifies assumeutxo, I'd suggest doing it first. Happy to take a stab at this unless you are already working on it.",
      "created_at" : "2021-07-06T13:12:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-874747600",
      "id" : 874747600,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NDc0NzYwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T13:12:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/874747600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Changing m_mempool from reference to pointer is something I wanted to do anyway for the `-nomempool` config option. If this also simplifies assumeutxo, I'd suggest doing it first. Happy to take a stab at this unless you are already working on it.\r\n\r\nStarted looking at this last week and then America had a birthday. Should have a commit coming today; actually looks like a pretty small change. ",
      "created_at" : "2021-07-06T13:34:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-874765048",
      "id" : 874765048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NDc2NTA0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T13:34:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/874765048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668278224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668278224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: only send ValidationInterface callbacks for active chain\" (b63ff90d6597d1d81b198f5d4d91551fe9ff75f2)\r\n\r\nIs disconnecting the tip possible if the chain is not active? I guess the if statement could be changed to an assert if it's always supposed to be true. Or it could be good to have a comment to explain why there's no else branch BackgroundBlockDisconnected call.",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-12T21:45:30Z",
      "diff_hunk" : "@@ -2357,7 +2357,9 @@ bool CChainState::DisconnectTip(BlockValidationState& state, const CChainParams&\n     UpdateTip(m_mempool, pindexDelete->pprev, chainparams, *this);\n     // Let wallets know transactions went from 1-confirmed to\n     // 0-confirmed or conflicted:\n-    GetMainSignals().BlockDisconnected(pblock, pindexDelete);\n+    if (this == &m_chainman.ActiveChainstate()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668278224",
      "id" : 668278224,
      "line" : 2366,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODI3ODIyNA==",
      "original_commit_id" : "b63ff90d6597d1d81b198f5d4d91551fe9ff75f2",
      "original_line" : 2360,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 136,
      "pull_request_review_id" : 704570475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T22:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668278224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668281608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668281608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: avoid rescans if under the snapshot\" (b73572bc92c07d246f322135ef9826f7e4cbf1d6)\r\n\r\nIs this meant to be part of a different commit? Seems unrelated to the wallet change",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-12T21:52:26Z",
      "diff_hunk" : "@@ -5134,15 +5134,31 @@ void ChainstateManager::MaybeRebalanceCaches()\n     }\n }\n \n-std::optional<CBlockIndex*> ChainstateManager::GetSnapshotBaseBlock()\n+std::optional<unsigned int> ChainstateManager::GetSnapshotNChainTx()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668281608",
      "id" : 668281608,
      "line" : 5436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODI4MTYwOA==",
      "original_commit_id" : "b73572bc92c07d246f322135ef9826f7e4cbf1d6",
      "original_line" : 5137,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 921,
      "pull_request_review_id" : 704570475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T22:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668281608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668284231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668284231"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: indexing changes for assumeutxo\" (ad65151497e0e7ddc2c7c7bfed854a6d0b30828f)\r\n\r\nShould this only be updated if a block is connected to the active chain, not the background chain?",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-12T21:57:45Z",
      "diff_hunk" : "@@ -262,6 +271,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this\n+        // indexer out of order (i.e. earlier blocks from the background\n+        // validation chainstate submitted *after* more recent blocks from the\n+        // snapshot chainstate), look at only updating this when pindex's\n+        // height is greater than best_block's.\n+        //\n+        // Note: I tried this earlier, but got some test failures\n+        // (functional/rpc_rawtransactions.py and rpc_getblockfilter.py).\n         m_best_block_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668284231",
      "id" : 668284231,
      "line" : 282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODI4NDIzMQ==",
      "original_commit_id" : "ad65151497e0e7ddc2c7c7bfed854a6d0b30828f",
      "original_line" : 282,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 28,
      "pull_request_review_id" : 704570475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T22:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668284231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668291243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668291243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"p2p: don't advertise until we finish all IBDs\" (8dc65c32ffb533402bc0c82ccf3f1fe5535df521)\r\n\r\nIt seems messy for individual chains have their own IBD states, and interact with shared `fImporting` and `fReindex` and `nMinimumChainWork` globals, and use their own latches.\r\n\r\nI think the IBD logic would be more straightforward if the `CChainState::IsInitialBlockDownload` method and `CChainState::m_cached_finished_ibd` member were moved from the `CChainState` class to the `ChainstateManager` class and consolidated in one place.",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-12T22:12:46Z",
      "diff_hunk" : "@@ -5222,3 +5222,13 @@ std::optional<int> ChainstateManager::GetSnapshotHeight()\n     }\n     return (*base)->nHeight;\n }\n+\n+bool ChainstateManager::IsAnyChainInIBD()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r668291243",
      "id" : 668291243,
      "line" : 5474,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODI5MTI0Mw==",
      "original_commit_id" : "8dc65c32ffb533402bc0c82ccf3f1fe5535df521",
      "original_line" : 5226,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 959,
      "pull_request_review_id" : 704570475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T22:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668291243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671720305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671720305"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think if anything, probably the reverse; if we only do this accounting for the active chain, we run the risk of giving the impression that the index has been fully built up until that point (when in reality we're waiting for block data to come in further back in the chain via the background chainstate).\r\n\r\nThis requires more thought, but my inclination is to either (i) explicitly reform the assumption that indexes will be built sequentially, or (ii) disallow `BlockConnected` handling for the active chainstate when there is a background chainstate in use.\r\n\r\nI'll add plenty of documentation around this in the next day or so. And I should probably try to write some tests for the interaction between indexation and assumeutxo use somehow.",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-17T17:03:33Z",
      "diff_hunk" : "@@ -262,6 +271,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this\n+        // indexer out of order (i.e. earlier blocks from the background\n+        // validation chainstate submitted *after* more recent blocks from the\n+        // snapshot chainstate), look at only updating this when pindex's\n+        // height is greater than best_block's.\n+        //\n+        // Note: I tried this earlier, but got some test failures\n+        // (functional/rpc_rawtransactions.py and rpc_getblockfilter.py).\n         m_best_block_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671720305",
      "id" : 671720305,
      "in_reply_to_id" : 668284231,
      "line" : 282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcyMDMwNQ==",
      "original_commit_id" : "ad65151497e0e7ddc2c7c7bfed854a6d0b30828f",
      "original_line" : 282,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 28,
      "pull_request_review_id" : 708956144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T17:03:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671720305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671720487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671720487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Although it's worth noting that `BlockConnected` signals are [ignored by the indexer](https://github.com/jamesob/bitcoin/blob/bd07c1bc78ca41d7f03648ccf0c0db102bde9cc9/src/index/base.cpp#L242-L244) until a full indexation has completed, so this may be a moot point anyway (which I think is why I didn't materially change the code in the first place...).",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-17T17:05:53Z",
      "diff_hunk" : "@@ -262,6 +271,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this\n+        // indexer out of order (i.e. earlier blocks from the background\n+        // validation chainstate submitted *after* more recent blocks from the\n+        // snapshot chainstate), look at only updating this when pindex's\n+        // height is greater than best_block's.\n+        //\n+        // Note: I tried this earlier, but got some test failures\n+        // (functional/rpc_rawtransactions.py and rpc_getblockfilter.py).\n         m_best_block_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671720487",
      "id" : 671720487,
      "in_reply_to_id" : 668284231,
      "line" : 282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcyMDQ4Nw==",
      "original_commit_id" : "ad65151497e0e7ddc2c7c7bfed854a6d0b30828f",
      "original_line" : 282,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 28,
      "pull_request_review_id" : 708956344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T17:05:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671720487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671723451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671723451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Although it's worth noting that BlockConnected signals are ignored by the indexer until a full indexation has completed\r\n\r\nHah, just kidding - turns out that `m_synced` flips to `true` in a degenerate case when we start up with an empty datadir; i.e. if a user enables `-txindex=1` on first use. I'm not sure if jimpo intended this to happen when he wrote it, but because `m_chain` has no entries the latch flips immediately. So the above discussion is not moot, and this (maybe surprising) behavior should probably be documented in `BaseIndex`. I may do that in a separate PR soon.",
      "commit_id" : "8feedede4e7788187cdac2bff1a694c0672b6e65",
      "created_at" : "2021-07-17T17:33:13Z",
      "diff_hunk" : "@@ -262,6 +271,14 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n     }\n \n     if (WriteBlock(*block, pindex)) {\n+        // TODO assumeutxo: since blocks may be submitted to this\n+        // indexer out of order (i.e. earlier blocks from the background\n+        // validation chainstate submitted *after* more recent blocks from the\n+        // snapshot chainstate), look at only updating this when pindex's\n+        // height is greater than best_block's.\n+        //\n+        // Note: I tried this earlier, but got some test failures\n+        // (functional/rpc_rawtransactions.py and rpc_getblockfilter.py).\n         m_best_block_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r671723451",
      "id" : 671723451,
      "in_reply_to_id" : 668284231,
      "line" : 282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcyMzQ1MQ==",
      "original_commit_id" : "ad65151497e0e7ddc2c7c7bfed854a6d0b30828f",
      "original_line" : 282,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 28,
      "pull_request_review_id" : 708958183,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T17:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671723451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676183531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676183531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"doc: add assumeutxo notes\" (e9e673950b906957b9b691ac0efa3894463a0f92)\r\n\r\nspelling commands",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-25T18:16:07Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC comanmds `dumptxoutset` and `loadtxoutset` are used to respectively generate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676183531",
      "id" : 676183531,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjE4MzUzMQ==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "doc/assumeutxo.md",
      "position" : 6,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676183531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676189715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676189715"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"chain: add BLOCK_ASSUMED_VALID for use with assumeutxo\" (0e8854e70374a7fff7efa32e13cb2effbd782f40)\r\n\r\nIs it possible to drop \"almost certainly\" here? If there is actually ambiguity, it should be possible to say what the ambiguity is.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-25T19:11:20Z",
      "diff_hunk" : "@@ -126,7 +126,15 @@ enum BlockStatus: uint32_t {\n     BLOCK_FAILED_CHILD       =   64, //!< descends from failed block\n     BLOCK_FAILED_MASK        =   BLOCK_FAILED_VALID | BLOCK_FAILED_CHILD,\n \n-    BLOCK_OPT_WITNESS       =   128, //!< block data in blk*.data was received with a witness-enforcing client\n+    BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.data was received with a witness-enforcing client\n+\n+    /**\n+     * If set, this indicates that the block index entry is assumed-valid.\n+     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n+     * It almost certainly means that the block's full validation is pending",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676189715",
      "id" : 676189715,
      "line" : 134,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjE4OTcxNQ==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 134,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 10,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676189715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676197448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676197448"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: indexing changes for assumeutxo\" (cba98bb776763e5ca8e290504004dadc8c48f30d)\r\n\r\nWhy does indexing have to be aware of assumueutxo chainstates? In the abstract, it seems like indexes should only need to know:\r\n\r\n- When the tip is changing (to update best block pointer and to undo rewinds)\r\n- When new block data is available (to add to the index)\r\n\r\nIf it's true that indexing code already does not care about the order of blocks, then it would seem pretty straightforward for validation code to just send these two events to indexing API without indexing code having to change much, and without it having to know about assumeutxo chainstates.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-25T20:21:42Z",
      "diff_hunk" : "@@ -230,18 +234,43 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n \n void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    return this->blockConnectedInternal(block, pindex, false);\n+}\n+\n+void BaseIndex::BackgroundBlockConnected(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex)\n+{\n+    this->blockConnectedInternal(block, pindex, true);\n+}\n+\n+void BaseIndex::blockConnectedInternal(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex,\n+    bool from_background)\n+{\n+    // Ignore BlockConnected signals until we have fully indexed the chain.\n     if (!m_synced) {\n         return;\n     }\n \n+    bool bg_chainstates_in_use = m_chainman->hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676197448",
      "id" : 676197448,
      "line" : 257,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjE5NzQ0OA==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 257,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 89,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676197448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676615118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676615118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: indexing changes for assumeutxo\" (cba98bb776763e5ca8e290504004dadc8c48f30d)\r\n\r\nI think this comment would make more sense in the migratedata method as part of the commment describing how it works. Otherwise it's not clear why there is any relationship between the database format and IBD, much less the relationship to multiple chainstates",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-26T13:42:26Z",
      "diff_hunk" : "@@ -204,7 +204,13 @@ bool TxIndex::Init()\n     // Attempt to migrate txindex from the old database to the new one. Even if\n     // chain_tip is null, the node could be reindexing and we still want to\n     // delete txindex records in the old database.\n-    if (!m_db->MigrateData(*m_chainstate->m_blockman.m_block_tree_db, m_chainstate->m_chain.GetLocator())) {\n+    //\n+    // We can use the active chain here without consideration for multiple\n+    // chainstates because if a complete txindex exists to be migrated, it\n+    // implies we've already completed IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676615118",
      "id" : 676615118,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjYxNTExOA==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 210,
      "original_position" : 8,
      "original_start_line" : 208,
      "path" : "src/index/txindex.cpp",
      "position" : 8,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : 208,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676615118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676617574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676617574"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add utxo snapshot detection and add to init\" (9e277298d8529d1afb8743a6e67cc5a3363d2703)\r\n\r\nCould this logic be moved to chainstatemanager, maybe inside the InitializeChainstate. It would seem better for it to be encapsulated there and not have to be exposed to application init code.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-26T13:45:24Z",
      "diff_hunk" : "@@ -1348,10 +1347,23 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n                 chainman.m_total_coinstip_cache = nCoinCacheUsage;\n                 chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n+                // Load a chain created from a UTXO snapshot, if any exist.\n+                chainman.DetectSnapshotChainstate(*Assert(node.mempool));\n+\n+                // Conservative value that will ultimately be changed by\n+                // a call to `chainman.MaybeRebalanceCaches()`.\n+                double init_cache_fraction = 0.2;\n+\n+                // If we're not using a snapshot or we haven't fully validated it yet,\n+                // create a validation chainstate.\n+                if (!chainman.IsSnapshotValidated()) {\n+                    LogPrintf(\"Loading validation chainstate\\n\");\n+                    chainman.InitializeChainstate(Assert(node.mempool.get()));\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676617574",
      "id" : 676617574,
      "line" : 1365,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjYxNzU3NA==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 1365,
      "original_position" : 28,
      "original_start_line" : 1353,
      "path" : "src/init.cpp",
      "position" : 28,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : 1353,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676617574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676620638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676620638"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: work with multiple chainstates\" (39addc71a0c6f574acfc5e3fc6c9e75083530b81)\r\n\r\n`const CChainState* const` could be `const CChainState*` because map keys are always const",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-26T13:48:45Z",
      "diff_hunk" : "@@ -632,8 +642,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState* const, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r676620638",
      "id" : 676620638,
      "line" : 655,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjYyMDYzOA==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 655,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 714340245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T14:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676620638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679323066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679323066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reason the indexing code needs to be aware of background chainstates is because the best block pointer (`m_best_block_index`) was (and is) used to signal that all blocks including and beneath that blockhash have been indexed. When you've got two separate chainstates throwing off BlockConnected events, you basically have to reserve updating that pointer for the background chainstate because otherwise you're breaking the nature of the best block pointer. Updating the index when you get an assumed-valid chainstate event would mean that there are unindexed blocks beneath the pointer.\r\n\r\nI've tried to think about ways to avoid this situation, but haven't been able to figure out anything simpler. If you've got ideas, I'm definitely curious and happy to implement.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-29T16:49:39Z",
      "diff_hunk" : "@@ -230,18 +234,43 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n \n void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    return this->blockConnectedInternal(block, pindex, false);\n+}\n+\n+void BaseIndex::BackgroundBlockConnected(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex)\n+{\n+    this->blockConnectedInternal(block, pindex, true);\n+}\n+\n+void BaseIndex::blockConnectedInternal(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex,\n+    bool from_background)\n+{\n+    // Ignore BlockConnected signals until we have fully indexed the chain.\n     if (!m_synced) {\n         return;\n     }\n \n+    bool bg_chainstates_in_use = m_chainman->hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679323066",
      "id" : 679323066,
      "in_reply_to_id" : 676197448,
      "line" : 257,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTMyMzA2Ng==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 257,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 89,
      "pull_request_review_id" : 718322105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T16:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679323066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679341922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679341922"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah I think what I'm asking is beyond the scope of the PR. It seems to me ideally validation code would notify indexing code \"the tip is changing\" and \"here is some new block data\" in 2 separate events not 3 mixed up events (block connected, background block connected, rewind), and also that indexing code would more passively receive data instead of querying chainstatemanager to reverse-engineer what validation code is doing.\r\n\r\nBut probably what you're doing now is the simplest approach for this PR.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-29T17:16:41Z",
      "diff_hunk" : "@@ -230,18 +234,43 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n \n void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    return this->blockConnectedInternal(block, pindex, false);\n+}\n+\n+void BaseIndex::BackgroundBlockConnected(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex)\n+{\n+    this->blockConnectedInternal(block, pindex, true);\n+}\n+\n+void BaseIndex::blockConnectedInternal(\n+    const std::shared_ptr<const CBlock>& block,\n+    const CBlockIndex* pindex,\n+    bool from_background)\n+{\n+    // Ignore BlockConnected signals until we have fully indexed the chain.\n     if (!m_synced) {\n         return;\n     }\n \n+    bool bg_chainstates_in_use = m_chainman->hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679341922",
      "id" : 679341922,
      "in_reply_to_id" : 676197448,
      "line" : 257,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTM0MTkyMg==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 257,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 89,
      "pull_request_review_id" : 718346434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T17:16:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679341922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679366512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679366512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's a good point; will move that over.",
      "commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "created_at" : "2021-07-29T17:52:28Z",
      "diff_hunk" : "@@ -204,7 +204,13 @@ bool TxIndex::Init()\n     // Attempt to migrate txindex from the old database to the new one. Even if\n     // chain_tip is null, the node could be reindexing and we still want to\n     // delete txindex records in the old database.\n-    if (!m_db->MigrateData(*m_chainstate->m_blockman.m_block_tree_db, m_chainstate->m_chain.GetLocator())) {\n+    //\n+    // We can use the active chain here without consideration for multiple\n+    // chainstates because if a complete txindex exists to be migrated, it\n+    // implies we've already completed IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r679366512",
      "id" : 679366512,
      "in_reply_to_id" : 676615118,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTM2NjUxMg==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 210,
      "original_position" : 8,
      "original_start_line" : 208,
      "path" : "src/index/txindex.cpp",
      "position" : 8,
      "pull_request_review_id" : 718377845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : 208,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-29T17:52:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679366512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683682559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683682559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed - I've left the comment here, but added one to the method.",
      "commit_id" : "1a9ca26440a00acfb395ed598d5da3687afa4e52",
      "created_at" : "2021-08-05T18:12:36Z",
      "diff_hunk" : "@@ -204,7 +204,13 @@ bool TxIndex::Init()\n     // Attempt to migrate txindex from the old database to the new one. Even if\n     // chain_tip is null, the node could be reindexing and we still want to\n     // delete txindex records in the old database.\n-    if (!m_db->MigrateData(*m_chainstate->m_blockman.m_block_tree_db, m_chainstate->m_chain.GetLocator())) {\n+    //\n+    // We can use the active chain here without consideration for multiple\n+    // chainstates because if a complete txindex exists to be migrated, it\n+    // implies we've already completed IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683682559",
      "id" : 683682559,
      "in_reply_to_id" : 676615118,
      "line" : 214,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY4MjU1OQ==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 214,
      "original_position" : 8,
      "original_start_line" : 208,
      "path" : "src/index/txindex.cpp",
      "position" : 19,
      "pull_request_review_id" : 723659152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : 212,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-05T18:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683682559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683684768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683684768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I took a run at doing this (https://github.com/jamesob/bitcoin/commit/cec687abb4f587d756bbaac62c02c09704cd8a42), but the refactor necessary to encapsulate all of the chainstate init logic is fairly complicated and difficult to verify correctness for. I burned more time than I'd like to admit trying to get this to work, but was getting a weird race/segfault with the loadblk thread as a result of moving this stuff around. So rather than further bloat this changeset I'm going to leave this for a future PR.",
      "commit_id" : "1a9ca26440a00acfb395ed598d5da3687afa4e52",
      "created_at" : "2021-08-05T18:15:44Z",
      "diff_hunk" : "@@ -1348,10 +1347,23 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n                 chainman.m_total_coinstip_cache = nCoinCacheUsage;\n                 chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n+                // Load a chain created from a UTXO snapshot, if any exist.\n+                chainman.DetectSnapshotChainstate(*Assert(node.mempool));\n+\n+                // Conservative value that will ultimately be changed by\n+                // a call to `chainman.MaybeRebalanceCaches()`.\n+                double init_cache_fraction = 0.2;\n+\n+                // If we're not using a snapshot or we haven't fully validated it yet,\n+                // create a validation chainstate.\n+                if (!chainman.IsSnapshotValidated()) {\n+                    LogPrintf(\"Loading validation chainstate\\n\");\n+                    chainman.InitializeChainstate(Assert(node.mempool.get()));\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683684768",
      "id" : 683684768,
      "in_reply_to_id" : 676617574,
      "line" : 1370,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY4NDc2OA==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 1370,
      "original_position" : 28,
      "original_start_line" : 1353,
      "path" : "src/init.cpp",
      "position" : 28,
      "pull_request_review_id" : 723659152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : 1358,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-05T18:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683684768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683689658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683689658"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "1a9ca26440a00acfb395ed598d5da3687afa4e52",
      "created_at" : "2021-08-05T18:23:01Z",
      "diff_hunk" : "@@ -3512,8 +3520,11 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, Block\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!IsInitialBlockDownload() &&\n+            m_chain.Tip() == pindex->pprev &&\n+            this == &m_chainman.ActiveChainstate()) {\n         GetMainSignals().NewPoWValidBlock(pindex, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683689658",
      "id" : 683689658,
      "in_reply_to_id" : 655628898,
      "line" : 3498,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY4OTY1OA==",
      "original_commit_id" : "5505d17e21d886d85b614a13e7fc8a61d6bf4fe9",
      "original_line" : 3498,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 236,
      "pull_request_review_id" : 723659152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T18:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683689658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683690795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683690795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "1a9ca26440a00acfb395ed598d5da3687afa4e52",
      "created_at" : "2021-08-05T18:24:47Z",
      "diff_hunk" : "@@ -632,8 +642,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState* const, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r683690795",
      "id" : 683690795,
      "in_reply_to_id" : 676620638,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY5MDc5NQ==",
      "original_commit_id" : "e9e673950b906957b9b691ac0efa3894463a0f92",
      "original_line" : 655,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 723659152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T18:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683690795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fresh snapshot at height 694,000: `magnet:?xt=urn:btih:d7216e8dd1b9dcf8c136f20156b966a745003015&dn=utxo%5Fmainnet%5F694000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nTo use the snapshot, edit `chainparams.cpp`:\r\n\r\n```cpp\r\n        m_assumeutxo_data = MapAssumeutxo{\r\n            {\r\n                694000,\r\n                {AssumeutxoHash{uint256S(\"0x00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018\")}, 659945001},\r\n            },\r\n        };\r\n```\r\n\r\nI'm able to load the snapshot and sync to the tip. I'll let you know if the background sync fails.\r\n\r\nThe \"flushing snapshot chainstate to disk\" could use some progress indicators in the log, but this PR is already big enough.\r\n\r\nI did notice that during the catchup, Taproot is marked as `DEFINED` rather than `LOCKED_IN`:\r\n\r\n```json\r\n \"taproot\": {\r\n      \"type\": \"bip9\",\r\n      \"bip9\": {\r\n        \"status\": \"defined\",\r\n        \"start_time\": 1619222400,\r\n        \"timeout\": 1628640000,\r\n        \"since\": 0,\r\n        \"min_activation_height\": 709632\r\n      },\r\n      \"active\": false\r\n    }\r\n```\r\n\r\nYou may want to doublecheck that you're enforcing new consensus rules if a soft-fork activates after the snapshot.\r\n\r\nUpdate 2021-08-08: it synced fine. Taproot is now shown as locked_in. But when I start bitcoind again (minutes after shutting it down gracefully, doom:\r\n```\r\n2021-08-08T10:36:05Z Cache configuration:\r\n2021-08-08T10:36:05Z * Using 2.0 MiB for block index database\r\n2021-08-08T10:36:05Z * Using 8.0 MiB for chain state database\r\n2021-08-08T10:36:05Z * Using 14990.0 MiB for in-memory UTXO set (plus up to 953.7 MiB of unused mempool space)\r\n2021-08-08T10:36:05Z init message: Loading block indexâ¦\r\n2021-08-08T10:36:05Z [snapshot] detected active snapshot chainstate (\"/Users/sjors/.bitcoin-ext-hdd/chainstate_00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018\") - loading\r\n2021-08-08T10:36:05Z Switching active chainstate to Chainstate [snapshot] @ height -1 (null)\r\n2021-08-08T10:36:05Z Loading validation chainstate\r\n2021-08-08T10:36:05Z Opening LevelDB in /Users/sjors/.bitcoin-ext-hdd/blocks/index\r\n2021-08-08T10:36:05Z Opened LevelDB successfully\r\n2021-08-08T10:36:05Z Using obfuscation key for /Users/sjors/.bitcoin-ext-hdd/blocks/index: 0000000000000000\r\n2021-08-08T10:36:05Z Opening LevelDB in /Users/sjors/.bitcoin-ext-hdd/chainstate\r\n2021-08-08T10:36:06Z Opened LevelDB successfully\r\n2021-08-08T10:36:06Z Using obfuscation key for /Users/sjors/.bitcoin-ext-hdd/chainstate: 4285ede2cdd16ad3\r\n2021-08-08T10:36:06Z Opening LevelDB in /Users/sjors/.bitcoin-ext-hdd/chainstate_00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018\r\n2021-08-08T10:36:06Z Opened LevelDB successfully\r\n2021-08-08T10:36:06Z Using obfuscation key for /Users/sjors/.bitcoin-ext-hdd/chainstate_00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018: bd9dd8e1af78ac03\r\n2021-08-08T10:36:11Z \r\n\r\n[snapshot] setting CBlockIndex(pprev=0x7f8944e6ab60, nHeight=694000, merkle=184538ca130f25e57570a0fa50793845da76f0f8cc2098824044d4e7eca397f5, hashBlock=00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018) nChainTx to 659945001\r\n\r\n2021-08-08T10:36:11Z LoadBlockIndexDB: last block file = 2680\r\n2021-08-08T10:36:11Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=82, size=61069735, heights=694689...694781, time=2021-08-07...2021-08-08)\r\n2021-08-08T10:36:11Z Checking all blk files are present...\r\n2021-08-08T10:36:11Z Initializing chainstate Chainstate [ibd] @ height -1 (null)\r\nAssertion failed: (!setBlockIndexCandidates.empty()), function PruneBlockIndexCandidates, file validation.cpp, line 2505.\r\nzsh: abort      src/bitcoind -datadir=/Users/sjors/.bitcoin-ext-hdd\r\n```",
      "created_at" : "2021-08-06T19:00:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-894458319",
      "id" : 894458319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5841UFnP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-08T10:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894458319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "As always, thanks for testing @Sjors. We've discussed on IRC, but just so others can follow along: what's happened here is you've listed the blockhash in your chainparams (`0x00000000000000000003f5acb5ec81df7c98c16bc8d89bdaadd4e8965729c018`) instead of the UTXO set hash (`0x2f47dc1e089b623a4bea57e0752b776df9e6885904d7ff8b14911b94c2208ff4`), and so consequently snapshot activation fails. You might have mistaken regular IBD for a snapshot sync-to-tip.\r\n\r\nHowever in doing this, you've uncovered a minor bug: if a snapshot fails to validate, it doesn't activate but it does leave its datadir in place. On next startup, init would try to load this snapshot chainstate on the basis of the datadir existence but, because it was never actually activated, blockindex assertions don't allow the load to happen. This error would have only occurred in practice if a user is given a malformed snapshot file or is manually tweaking chainparams values, as we are here.\r\n\r\nI've pushed a commit ensuring that teardown of the snapshot datadir happens should activation fail. An alternative to this would be setting some kind of block index state that controls snapshot load on startup, but I don't think that's necessary. \r\n\r\nThe correct chainparams modification for the snapshot you generated is\r\n```cpp\r\n        m_assumeutxo_data = MapAssumeutxo{\r\n            ...\r\n            {\r\n                694000,\r\n                {AssumeutxoHash{uint256S(\"0x2f47dc1e089b623a4bea57e0752b776df9e6885904d7ff8b14911b94c2208ff4\")}, 659945001},\r\n            },\r\n        };\r\n```\r\n\r\nI've tested syncing to network tip with the 694000 snapshot, shutting down and booting back up at various points during the process, and it works for me. Thanks again for testing and finding bugs!",
      "created_at" : "2021-08-17T20:38:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-900613818",
      "id" : 900613818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5841rka6",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-17T20:38:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900613818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-16T22:31:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-921303210",
      "id" : 921303210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII58426fiq",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T22:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921303210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-05T08:19:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-934177787",
      "id" : 934177787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5843rmv7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934177787/reactions"
      },
      "updated_at" : "2021-10-05T08:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934177787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-02T09:49:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1003689682",
      "id" : 1003689682,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII58470xbS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003689682/reactions"
      },
      "updated_at" : "2022-01-02T09:49:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003689682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r777888610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777888610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry for causing the conflict, but BlockManager moved to blockstorage.cpp\r\n\r\nAlso, what is the status here? Do you plan to split another piece off or will this go in as one cake now?",
      "commit_id" : "d354a93b836b52f58ac69dff96e1172d8bc36ee1",
      "created_at" : "2022-01-04T08:07:00Z",
      "diff_hunk" : "@@ -3800,7 +3849,11 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     setDirtyFileInfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    int chain_tip_height,\n+    ChainstateManager& chainman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r777888610",
      "id" : 777888610,
      "line" : 3856,
      "node_id" : "PRRC_kwDOABII584uXaNi",
      "original_commit_id" : "d354a93b836b52f58ac69dff96e1172d8bc36ee1",
      "original_line" : 3856,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 214,
      "pull_request_review_id" : 843286621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777888610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-04T08:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777888610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI failure:\r\n```\r\ntest  2022-01-05T21:03:35.417000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/private/var/folders/xx/vl5f934s6k927z1vyyl9cxth0000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin/test/functional/test_framework/test_framework.py\", line 132, in main\r\n                                       self.run_test()\r\n                                     File \"/private/var/folders/xx/vl5f934s6k927z1vyyl9cxth0000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin/test/functional/feature_assumeutxo.py\", line 76, in run_test\r\n                                       assert_equal(\r\n                                     File \"/private/var/folders/xx/vl5f934s6k927z1vyyl9cxth0000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin/test/functional/test_framework/util.py\", line 50, in assert_equal\r\n                                       raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\n                                   AssertionError: not(2791b5e739503d03fb174d983ef4cf7ef9f905dabca0299f16ebb2cc06bc9b67 == b58bd896c7eb420f61d1a6f40a0cdee43853992fcb820a6f854ccc9db95b3e5e)\r\n``` ",
      "created_at" : "2022-01-06T13:46:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1006604260",
      "id" : 1006604260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5847_4_k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006604260/reactions"
      },
      "updated_at" : "2022-01-06T13:46:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006604260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> AssertionError: not(2791b5e739503d03fb174d983ef4cf7ef9f905dabca0299f16ebb2cc06bc9b67 == b58bd896c7eb420f61d1a6f40a0cdee43853992fcb820a6f854ccc9db95b3e5e)\r\n\r\nHm, well that's concerning. Does anyone know if `TestFramework.generatetoaddress` and its underlying functions have changed in such a way that would explain that? To my knowledge none of the UTXO set hashing functionality has changed...",
      "created_at" : "2022-01-06T19:11:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1006847511",
      "id" : 1006847511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5848A0YX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006847511/reactions"
      },
      "updated_at" : "2022-01-06T19:11:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006847511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oh here we go, this is the cause: https://github.com/bitcoin/bitcoin/commit/2539980e1d74a637be5bcadb566263f903adffd1\r\n\r\nI'll update the tests now.",
      "created_at" : "2022-01-06T19:35:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1006878332",
      "id" : 1006878332,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5848A758",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006878332/reactions"
      },
      "updated_at" : "2022-01-06T19:36:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1006878332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-07T04:58:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1007141123",
      "id" : 1007141123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII5848B8ED",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007141123/reactions"
      },
      "updated_at" : "2022-01-07T04:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007141123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-25T21:47:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1021640444",
      "id" : 1021640444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII58485P78",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021640444/reactions"
      },
      "updated_at" : "2022-01-25T21:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021640444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796585938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796585938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "please convert these to c++11 style functional casts",
      "commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "created_at" : "2022-02-01T13:17:47Z",
      "diff_hunk" : "@@ -131,63 +135,77 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n     LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int prune_height,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || nPruneTarget == 0) {\n-        return;\n-    }\n-    if ((uint64_t)chain_tip_height <= nPruneAfterHeight) {\n+    if (nPruneTarget == 0) {\n         return;\n     }\n \n-    unsigned int nLastBlockWeCanPrune{(unsigned)std::min(prune_height, chain_tip_height - static_cast<int>(MIN_BLOCKS_TO_KEEP))};\n-    uint64_t nCurrentUsage = CalculateCurrentUsage();\n-    // We don't check to prune until after we've allocated new space for files\n-    // So we should leave a buffer under our target to account for another allocation\n-    // before the next pruning.\n-    uint64_t nBuffer = BLOCKFILE_CHUNK_SIZE + UNDOFILE_CHUNK_SIZE;\n-    uint64_t nBytesToPrune;\n-    int count = 0;\n-\n-    if (nCurrentUsage + nBuffer >= nPruneTarget) {\n-        // On a prune event, the chainstate DB is flushed.\n-        // To avoid excessive prune events negating the benefit of high dbcache\n-        // values, we should not prune too rapidly.\n-        // So when pruning in IBD, increase the buffer a bit to avoid a re-prune too soon.\n-        if (is_ibd) {\n-            // Since this is only relevant during IBD, we use a fixed 10%\n-            nBuffer += nPruneTarget / 10;\n+    for (CChainState* chainstate : chainman.GetAll()) {\n+        uint64_t height = chainstate->m_chain.Height();\n+        if (height <= nPruneAfterHeight) {\n+            continue; // no pruning necessary for this chainstate\n         }\n \n-        for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-            nBytesToPrune = m_blockfile_info[fileNumber].nSize + m_blockfile_info[fileNumber].nUndoSize;\n-\n-            if (m_blockfile_info[fileNumber].nSize == 0) {\n-                continue;\n+        unsigned int start_height;\n+        unsigned int end_height;\n+        std::tie(start_height, end_height) = chainman.getPruneRange(chainstate, prune_height);\n+\n+        uint64_t nCurrentUsage = CalculateCurrentUsage();\n+        // We don't check to prune until after we've allocated new space for files\n+        // So we should leave a buffer under our target to account for another allocation\n+        // before the next pruning.\n+        uint64_t nBuffer = BLOCKFILE_CHUNK_SIZE + UNDOFILE_CHUNK_SIZE;\n+        uint64_t nBytesToPrune;\n+        int count=0;\n+\n+        if (nCurrentUsage + nBuffer >= nPruneTarget) {\n+            // On a prune event, the chainstate DB is flushed.\n+            // To avoid excessive prune events negating the benefit of high dbcache\n+            // values, we should not prune too rapidly.\n+            // So when pruning in IBD, increase the buffer a bit to avoid a re-prune too soon.\n+            if (chainstate->IsInitialBlockDownload()) {\n+                // Since this is only relevant during IBD, we use a fixed 10%\n+                nBuffer += nPruneTarget / 10;\n             }\n \n-            if (nCurrentUsage + nBuffer < nPruneTarget) { // are we below our target?\n-                break;\n-            }\n+            for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n+                nBytesToPrune = m_blockfile_info[fileNumber].nSize + m_blockfile_info[fileNumber].nUndoSize;\n \n-            // don't prune files that could have a block within MIN_BLOCKS_TO_KEEP of the main chain's tip but keep scanning\n-            if (m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n-                continue;\n-            }\n+                if (m_blockfile_info[fileNumber].nSize == 0) {\n+                    continue;\n+                }\n+\n+                if (nCurrentUsage + nBuffer < nPruneTarget)  // are we below our target?\n+                    break;\n+\n+                // don't prune files that could have a block within MIN_BLOCKS_TO_KEEP of the main chain's tip but keep scanning\n+                if (m_blockfile_info[fileNumber].nHeightLast > end_height)\n+                    continue;\n+\n+                // can't start pruning yet\n+                if (m_blockfile_info[fileNumber].nHeightFirst < start_height) {\n+                    continue;\n+                }\n \n-            PruneOneBlockFile(fileNumber);\n-            // Queue up the files for removal\n-            setFilesToPrune.insert(fileNumber);\n-            nCurrentUsage -= nBytesToPrune;\n-            count++;\n+                PruneOneBlockFile(fileNumber);\n+                // Queue up the files for removal\n+                setFilesToPrune.insert(fileNumber);\n+                nCurrentUsage -= nBytesToPrune;\n+                count++;\n+            }\n         }\n-    }\n \n-    LogPrint(BCLog::PRUNE, \"Prune: target=%dMiB actual=%dMiB diff=%dMiB max_prune_height=%d removed %d blk/rev pairs\\n\",\n-           nPruneTarget/1024/1024, nCurrentUsage/1024/1024,\n-           ((int64_t)nPruneTarget - (int64_t)nCurrentUsage)/1024/1024,\n-           nLastBlockWeCanPrune, count);\n+        LogPrint(BCLog::PRUNE, \"Prune: (%s) target=%dMiB actual=%dMiB diff=%dMiB max_prune_height=%d removed %d blk/rev pairs\\n\",\n+               chainstate->ToString(), nPruneTarget/1024/1024, nCurrentUsage/1024/1024,\n+               ((int64_t)nPruneTarget - (int64_t)nCurrentUsage)/1024/1024,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796585938",
      "id" : 796585938,
      "line" : 206,
      "node_id" : "PRRC_kwDOABII584veu_S",
      "original_commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "original_line" : 206,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 129,
      "pull_request_review_id" : 869114595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796585938/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-01T13:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796585938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796587529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796587529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "please convert these three to c++11 style functional casts",
      "commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "created_at" : "2022-02-01T13:19:49Z",
      "diff_hunk" : "@@ -2729,6 +2729,158 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"\\nLoad the serialized UTXO set from disk.\\n\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                /* default_val */ \"\",\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded by the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the new tip\"},\n+                    {RPCResult::Type::NUM, \"tip_height\", \"the height of the new chain\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = fs::absolute(path, gArgs.GetDataDirNet());\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        {\n+            LOCK(cs_main);\n+            snapshot_start_block = chainman.m_blockman.LookupBlockIndex(base_blockhash);\n+        }\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (snapshot_start_block == nullptr) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+\n+    // TODO jamesob: no real need to lock cs_main here, but during testing it makes it\n+    // easier to follow the logs. We may want to remove this before merge.\n+    //\n+    LOCK(::cs_main);\n+\n+    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    }\n+    CBlockIndex* new_tip{chainman.ActiveTip()};\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"coins_loaded\", metadata.m_coins_count);\n+    result.pushKV(\"tip_hash\", new_tip->GetBlockHash().ToString());\n+    result.pushKV(\"base_height\", new_tip->nHeight);\n+    result.pushKV(\"path\", fs::PathToString(path));\n+    return result;\n+},\n+    };\n+}\n+\n+static RPCHelpMan monitorsnapshot()\n+{\n+return RPCHelpMan{\n+        \"monitorsnapshot\",\n+        \"\\nReturn information about UTXO snapshot status.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"x\", \"x\",\n+                {\n+                    {RPCResult::Type::NUM, \"headers\", \"the number of headers we've seen\"},\n+                    {RPCResult::Type::STR, \"active_chain_type\", \"whether active chain is ibd or snapshot\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"monitorsnapshot\", \"\")\n+    + HelpExampleRpc(\"monitorsnapshot\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [](CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"mediantime\",            (int64_t)tip->GetMedianTimePast());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796587529",
      "id" : 796587529,
      "line" : 2856,
      "node_id" : "PRRC_kwDOABII584vevYJ",
      "original_commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "original_line" : 2856,
      "original_position" : 128,
      "original_start_line" : 2853,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 128,
      "pull_request_review_id" : 869114595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796587529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2853,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-01T13:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796587529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796594594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796594594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "please avoid c-style cast; use a functional cast or be explicit like \r\n```\r\nbool(m_coins_views)\r\nm_couns_view != nullptr\r\n```",
      "commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "created_at" : "2022-02-01T13:28:16Z",
      "diff_hunk" : "@@ -560,12 +566,14 @@ class CChainState\n     //!     handles disk read errors gracefully.\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n     {\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r796594594",
      "id" : 796594594,
      "line" : 575,
      "node_id" : "PRRC_kwDOABII584vexGi",
      "original_commit_id" : "e84248814296b82d926f5018dd62d917ddefe626",
      "original_line" : 575,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 42,
      "pull_request_review_id" : 869114595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796594594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-01T13:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796594594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-15T19:59:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1040733199",
      "id" : 1040733199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII584-CFQP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040733199/reactions"
      },
      "updated_at" : "2022-02-15T19:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040733199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-05T22:52:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1338287141",
      "id" : 1338287141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585PxKQl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338287141/reactions"
      },
      "updated_at" : "2022-12-05T22:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338287141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI trips over:\r\n\r\n```\r\nsrc/validation.cpp:5721:1: \r\nerror: \r\nreturn type 'const ChainstateRole' is 'const'-qualified at the top level, which may reduce code readability without improving const correctness [readability-const-return-type,-warnings-as-errors]\r\n```\r\n\r\n\r\nI made a snapshot at height 780,000 and then loaded it.\r\n\r\n<details>\r\n<summary>Oops...</summary>\r\n But instead of finishing towards the tip, it started the background sync:\r\n\r\n```json\r\n[\r\n  {\r\n    \"height\": 780050,\r\n    \"hash\": \"000000000000000000043cfdd430cbcf5d6cfa0c437ad5b808e1d45dc509387e\",\r\n    \"branchlen\": 771607,\r\n    \"status\": \"headers-only\"\r\n  },\r\n  {\r\n    \"height\": 8443,\r\n    \"hash\": \"00000000ee985adaa7242745800b7702d48558fbc517358be4fb597368f8b217\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n  }\r\n]\r\n```\r\n\r\nPerhaps this is because the assume valid block was (unrealistically) close to the tip?\r\n\r\nI used the commits in this PR, but cleanly rebased on #24008 (replacing the first 6 commits here), and with a commit to modify the assumed valid block.\r\n\r\nI was able to produce this behaviour with a fresh datadir.\r\n\r\n_Update 10-3-2023_: I just tried again and noticed a log message that I probably overlooked: `[snapshot] bad snapshot content hash â¦`. This ~puzzling too, since I got the same sha256 hash when dumping the snapshot on both macOS and Ubuntu~ the umpteenth time I hardcoded a block hash instead of the content hash, ~but~ and it explains why IBD just went on as normal.\r\n</details>\r\n\r\nIt made it to the tip and is now doing a background sync.\r\n\r\nOne thing I noticed if that whenc syncing to the tip, it was showing `cache=3.0MiB` even though it was using ~15GB of ~cache~ RAM. This is strange, because #27008 is not part of this PR, so most of the RAM should have cleared up once the snapshot is loaded.\r\n\r\n~Also worrying is that~ once it reaches the tip, it doesn't immediately flush. (Update: that makes sense, because we recently flushed.) That causes the background sync to have very limited resources. It endup up flushing the cache when it reach 1751MB (which matches the coinstip cache of 818 MB plus my maxmempool of 1GB). (update: I think the problem is that it's not correctly rebalancing)\r\n\r\nStrangely it says `[snapshot] validated snapshot (811 MB)` and `[snapshot] (811 MB)`, which seems completely off since the snapshot should use about 12 GB (`-dbcache` was set high enough).\r\n\r\nOnce I restart the node it creates a more reasonable split between the background ibd (15555 MB) and snapshot chainstate caches (818 MB).\r\n\r\nAnother thing I noticed is that because it takes a while to load and process the snapshot, it triggers a timeout in p2p networking and we start querying DNS seeds again. Can be dealt with in a followup.\r\n\r\nLoading a wallet that last opened _before_ the assumevalid block fails gracefully, with a clear instruction to try again after sync reaches the snapshot height. Currently the GUI gives no indication that such a background sync is going on, but that's ok for now. The user must have used the RPC to trigger snapshot use, and loading an old wallet on fresh node is not a typical novice use case.",
      "created_at" : "2023-03-09T17:15:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1462444460",
      "id" : 1462444460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585XKyGs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1462444460/reactions"
      },
      "updated_at" : "2023-03-10T14:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1462444460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r1132363873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132363873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Optimistically bumping the block, but also making sure I don't keep putting the wrong numbers here:\r\n\r\n```cpp\r\n/*height=*/780000,\r\n{AssumeutxoHash{uint256S(/*txoutset_hash=*/\"0x97d2989ab4c1b2cfb4eaa37788aeea08a3a6757eabd94ae9b7cdde07e79381da\")},\r\n/*nchaintx=*/812391117},\r\n```\r\n\r\nMaybe also add a string initialiser to `AssumeutxoHash` to avoid the extra `uint256S`.",
      "commit_id" : "38a25771fe7481c67274a972162c8de850f74cc6",
      "created_at" : "2023-03-10T13:18:26Z",
      "diff_hunk" : "@@ -164,7 +164,10 @@ class CMainParams : public CChainParams {\n         };\n \n         m_assumeutxo_data = MapAssumeutxo{\n-         // TODO to be specified in a future patch.\n+            {\n+                685000,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r1132363873",
      "id" : 1132363873,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585DfoBh",
      "original_commit_id" : "1dc803c1bd007e7878aaeaa17da7bffe661ab23e",
      "original_line" : 168,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/chainparams.cpp",
      "position" : 6,
      "pull_request_review_id" : 1334849488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132363873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-10T13:18:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132363873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r1132390967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132390967"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be useful to have information about dbcache allocation (and usage) here.",
      "commit_id" : "38a25771fe7481c67274a972162c8de850f74cc6",
      "created_at" : "2023-03-10T13:40:36Z",
      "diff_hunk" : "@@ -2788,6 +2788,66 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan monitorsnapshot()\n+{\n+return RPCHelpMan{\n+        \"monitorsnapshot\",\n+        \"\\nReturn information about UTXO snapshot status.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r1132390967",
      "id" : 1132390967,
      "line" : 2789,
      "node_id" : "PRRC_kwDOABII585Dfuo3",
      "original_commit_id" : "010419cec6a991361e0a4cf68519a8a3a3b9f5bd",
      "original_line" : 2795,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 88,
      "pull_request_review_id" : 1334884058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132390967/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-10T13:40:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132390967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-03-15T23:54:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1470996078",
      "id" : 1470996078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585XrZ5u",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1470996078/reactions"
      },
      "updated_at" : "2023-03-15T23:54:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1470996078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alright! This is fully rebased and passing CI. Copy/pasteable testing instructions follow.\r\n\r\nI'm pretty sure these are the complete changes necessary to enable use of assumeutxo (via `loadtxoutset`), including pruning and index use. It's worth noting that 200 of these lines are an elaborate demo shell script and another good chunk of this is airy RPC code, so this 1200 line diff is maybe more approachable than it appears.\r\n\r\n### Recent changes\r\n\r\n- [x] I've segmented blockfile storage into \"assumed\" vs. \"normal\" files to avoid doing drastic mixing of heights. As the code was written, we had snapshot and ibd chainstates pushing into the same space of blockfiles, which makes pruning ineffectual for a decent chunk of the chain. This is now fixed.\r\n- [x] Ironed out all the indexing issues in a relatively simple way. Indexation now happens strictly sequentially, along the background chainstate (which is just a continuation of the \"regular\" chainstate that we initialize with before running `loadtxoutset` and creating the snapshot chainstate). Validationinterface events in the indexers are ignored for the snapshot chainstate; once we complete background validation, the indexers are restarted and continue (sequentially) into the previously unindexed region of the chain.\r\n- [x] I've renamed `monitorsnapshot` (a utility RPC) to `getchainstates`.\r\n- [x] Lotta rebase and bug fixes.\r\n\r\n### Testing\r\n\r\n#### For fun (~5min)\r\n\r\nIf you want to do a quick test, you can run `./contrib/devtools/test_utxo_snapshots.sh` and follow the instructions. This is mostly obviated by the functional tests, though.\r\n\r\n#### For real (longer)\r\n\r\nIf you'd like to experience a real usage of assumeutxo, you can do that too.\r\nI've cut a new snapshot at height 788'000 (https://img.jameso.be/utxo-788000.dat - but you can do it yourself with `./contrib/devtools/utxo_snapshot.sh` if you want). Download that, and then create a datadir for testing:\r\n```sh\r\n$ cd ~/src/bitcoin  # or whatever\r\n\r\n# get the snapshot\r\n$ curl https://img.jameso.be/utxo-788000.dat > utxo-788000.dat\r\n\r\n# you'll want to do this if you like copy/pasting \r\n$ export AU_DATADIR=/home/${USER}/au-test # or wherever\r\n\r\n$ mkdir ${AU_DATADIR}\r\n$ vim ${AU_DATADIR}/bitcoin.conf\r\n\r\ndbcache=8000  # or, you know, something high\r\nblockfilterindex=1\r\ncoinstatsindex=1\r\nprune=3000\r\nlogthreadnames=1\r\n```\r\nObtain this branch, build it, and then start bitcoind:\r\n```sh\r\n$ git remote add jamesob https://github.com/jamesob/bitcoin\r\n$ git fetch jamesob utxo-dumpload-compressed\r\n$ git checkout jamesob/utxo-dumpload-compressed\r\n\r\n$ ./configure $conf_args && make  # (whatever you like to do here)\r\n\r\n# start 'er up and watch the logs\r\n$ ./src/bitcoind -datadir=${AU_DATADIR}\r\n```\r\nThen, in some other window, load the snapshot\r\n```sh\r\n$ ./src/bitcoin-cli -datadir=${AU_DATADIR} loadtxoutset $(pwd)/utxo-788000.dat\r\n```\r\n\r\nYou'll see some log messages about headers retrieval and waiting to see the snapshot in the headers chain. Once you get the full headers chain, you'll spend a decent amount of time (~10min) loading the snapshot, checking it, and flushing it to disk. After all that happens, you should be syncing to tip in pretty short order, and you'll see the occasional `[background validation]` log message go by.\r\n\r\nIn yet another window, you can check out chainstate status with\r\n```sh\r\n$ ./src/bitcoin-cli -datadir=${AU_DATADIR} getchainstates\r\n```\r\nas well as usual favorites like `getblockchaininfo`.\r\n\r\nHave fun and hope it works!\r\n\r\n#### Known weird behavior\r\n\r\n- [ ] The last few blocks to get the snapshot chainstate to tip seem to take a while to roll in... I'm not sure what's going on here. It eventually syncs, but not as fast as I would think.\r\n- [ ] If you restart the node in the middle of the bg sync, `nChainTx` for the snapshot chain will not properly repopulate and your `progress=` for the snapshot chainstate will be weird. I *think* there's an easy fix for this, which I'm investigating.\r\n\r\n#### Next steps\r\n\r\nMaybe I'll open a PR that's this changeset but without the pruning changes, as suggested by @sdaftuar. If we decide it's preferable to wait on pruning we can, but I think the LOC delta is only maybe a hundred lines or so. Conceptually the diff might be bigger of course. Curious what others think here, given this (relatively complete?) set of changes.",
      "created_at" : "2023-05-05T02:33:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1535622786",
      "id" : 1535622786,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585bh76C",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1535622786/reactions"
      },
      "updated_at" : "2023-05-05T02:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1535622786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Known weird behavior\r\n\r\nRuning through your steps above, everything *seems* to be working, except that my mempool was empty until I stopped and restarted bitcoind?\r\n\r\n> If you restart the node in the middle of the bg sync, nChainTx for the snapshot chain will not properly repopulate and your progress= for the snapshot chainstate will be weird. I think there's an easy fix for this, which I'm investigating.\r\n\r\nYea. After a restart:\r\n```bash\r\n# ./src/bitcoin-cli -datadir=${AU_DATADIR} getblockchaininfo\r\n...\r\n  \"chain\": \"main\",\r\n  \"blocks\": 788360,\r\n  \"headers\": 788360,\r\n  \"bestblockhash\": \"00000000000000000004adb413e56a36a384f6a2a5b2070919400a5589e5e61c\",\r\n  \"difficulty\": 48005534313578.78,\r\n  \"time\": 1683282690,\r\n  \"mediantime\": 1683281530,\r\n  \"verificationprogress\": 0.01514891955399454,\r\n\r\n# ./src/bitcoin-cli -datadir=${AU_DATADIR} getchainstates\r\n{\r\n  \"active_chain_type\": \"snapshot\",\r\n  \"ibd\": {\r\n    \"blocks\": 217772,\r\n    \"bestblockhash\": \"00000000000003c6630bb58c5dfab652c2b921d850f9f9472d87739857b6f14b\",\r\n    \"difficulty\": 2968775.332075074,\r\n    \"verificationprogress\": 0.01394596823378951,\r\n    \"snapshot_blockhash\": \"0000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"initialblockdownload\": true,\r\n    \"coins_db_cache_bytes\": 7969177,\r\n    \"coins_tip_cache_bytes\": 8931455795\r\n  },\r\n  \"snapshot\": {\r\n    \"blocks\": 788360,\r\n    \"bestblockhash\": \"00000000000000000004adb413e56a36a384f6a2a5b2070919400a5589e5e61c\",\r\n    \"difficulty\": 48005534313578.78,\r\n    \"verificationprogress\": 0.0151489113147836,\r\n    \"snapshot_blockhash\": \"00000000000000000001f3fa1b4c03c877740778f56b0d5456b18dd88f7f695e\",\r\n    \"initialblockdownload\": false,\r\n    \"coins_db_cache_bytes\": 419430,\r\n    \"coins_tip_cache_bytes\": 470076620\r\n  },\r\n  \"headers\": 788360\r\n}\r\n```",
      "created_at" : "2023-05-05T11:08:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1536093556",
      "id" : 1536093556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585bju10",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536093556/reactions"
      },
      "updated_at" : "2023-05-05T11:08:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536093556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing!\r\n\r\n> except that my mempool was empty until I stopped and restarted bitcoind?\r\n\r\nInteresting, I'll look at this today; probably some part of net_processing that's looking at `chainman.IsAnyIBD()` when it should be using `ActiveChainstate().IsInitialBlockDownload()`.",
      "created_at" : "2023-05-05T12:56:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1536222186",
      "id" : 1536222186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585bkOPq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536222186/reactions"
      },
      "updated_at" : "2023-05-05T12:56:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536222186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-05T17:09:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1536545883",
      "id" : 1536545883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585bldRb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536545883/reactions"
      },
      "updated_at" : "2023-05-05T17:09:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536545883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here's a torrent for the snapshot: `magnet:?xt=urn:btih:a457a54c76dfdbb3f44e3485a84c4772bea647e0&dn=utxo-788000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`",
      "created_at" : "2023-05-05T18:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-1536606404",
      "id" : 1536606404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "IC_kwDOABII585blsDE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536606404/reactions"
      },
      "updated_at" : "2023-05-05T18:12:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536606404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
