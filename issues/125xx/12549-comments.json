[
   {
      "author_association" : "MEMBER",
      "body" : "Nice speedup! Concept ACK",
      "created_at" : "2018-02-27T04:25:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368743276",
      "id" : 368743276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T04:25:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368743276",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This exists in #11988 no?",
      "created_at" : "2018-02-27T04:37:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368744946",
      "id" : 368744946,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T04:37:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368744946",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like this branch is failing because `std::is_trivially_constructible` wasn't added until GCC 5 (according to https://www.gnu.org/software/gcc/gcc-5/changes.html ), even though it is part of C++11. I can find a workaround for GCC 4.8.\r\n\r\nThis isn't quite the same as #11988 because that still uses placement new.",
      "created_at" : "2018-02-27T04:40:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368745395",
      "id" : 368745395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T04:40:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368745395",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If it's not hugely different consider reviewing #11988 and suggesting changes to make it better instead.",
      "created_at" : "2018-02-27T04:48:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368746452",
      "id" : 368746452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T04:48:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368746452",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "That's a good idea, I'll see if I can cherry-pick @AkioNak's commit into my branch while I'm testing the GCC 4.8 compatibility issues.",
      "created_at" : "2018-02-27T04:52:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368747020",
      "id" : 368747020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T04:52:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368747020",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This new branch cherry-picks @AkioNak 's commit from #11988 and then adds my memset optimization. I constructed this PR such that it has three commits:\r\n * First commit just adds new benchmarks\r\n * Second commit is from #11988 (unmodified, preserves authorship)\r\n * Third commit implements my `memset()` optimization\r\n\r\nI have a script that benchmarks the performance for each of the three commits. Here's the summarized data. The first commit is considered to have a baseline speedup of 1x, and then each of the subsequent commits shows the speedup from the base:\r\n\r\n```\r\n34d238     PrevectorClear                 1.00x\r\n34d238     PrevectorDestructor            1.00x\r\n34d238     PrevectorResizeNontrivial      1.00x\r\n34d238     PrevectorResizeTrivial         1.00x\r\nd1d28e     PrevectorClear                 2.36x\r\nd1d28e     PrevectorDestructor            2.16x\r\nd1d28e     PrevectorResizeNontrivial      3.24x\r\nd1d28e     PrevectorResizeTrivial         2.76x\r\nf8b078     PrevectorClear                 8.31x\r\nf8b078     PrevectorDestructor            7.62x\r\nf8b078     PrevectorResizeNontrivial      6.56x\r\nf8b078     PrevectorResizeTrivial         18.99x\r\n```\r\n\r\nHere's the raw data I generated the above from:\r\n```\r\ngit 34d2387b1d5c753d6ba130eb6b4730dcc15072c5\r\n# Benchmark, evals, iterations, total, min, max, median\r\nPrevectorClear, 5, 5600, 3.47561, 0.00012317, 0.000125752, 0.000123494\r\nPrevectorDestructor, 5, 5700, 3.2223, 0.000112914, 0.000113208, 0.000113068\r\nPrevectorResizeNontrivial, 5, 4100, 3.24072, 0.000158005, 0.000158212, 0.000158075\r\nPrevectorResizeTrivial, 5, 4900, 3.24407, 0.000131094, 0.000133749, 0.000132495\r\n\r\ngit d1d28e72154a9f2e7fb56001f2b790074d1cfa30\r\n# Benchmark, evals, iterations, total, min, max, median\r\nPrevectorClear, 5, 5600, 1.4682, 5.23405e-05, 5.2611e-05, 5.24265e-05\r\nPrevectorDestructor, 5, 5700, 1.49587, 5.24034e-05, 5.26179e-05, 5.2448e-05\r\nPrevectorResizeNontrivial, 5, 4100, 1.00747, 4.87854e-05, 5.04511e-05, 4.88389e-05\r\nPrevectorResizeTrivial, 5, 4900, 1.17581, 4.79055e-05, 4.81338e-05, 4.79753e-05\r\n\r\ngit f8b078c8cda6d4ac6e3b112ce605b08f6ac002b9\r\n# Benchmark, evals, iterations, total, min, max, median\r\nPrevectorClear, 5, 5600, 0.419837, 1.48182e-05, 1.55947e-05, 1.48556e-05\r\nPrevectorDestructor, 5, 5700, 0.422994, 1.48187e-05, 1.48808e-05, 1.48327e-05\r\nPrevectorResizeNontrivial, 5, 4100, 0.494272, 2.40686e-05, 2.41813e-05, 2.4084e-05\r\nPrevectorResizeTrivial, 5, 4900, 0.171037, 6.89859e-06, 7.06054e-06, 6.97555e-06\r\n```",
      "created_at" : "2018-02-27T06:46:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368764912",
      "id" : 368764912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T06:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368764912",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170835611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170835611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe use `ptrdiff_t` here and in `fill`? Would allow you to assert against the negative case rather than have a very large value.\r\n\r\nNot that the negative case is possible with the current code, but it could be protective going forward.",
      "commit_id" : "5aad635b78c8359adae9b2af015b67b7325c0e0b",
      "created_at" : "2018-02-27T07:35:13Z",
      "diff_hunk" : "@@ -314,16 +329,20 @@ class prevector {\n     }\n \n     void resize(size_type new_size) {\n-        if (size() > new_size) {\n+        size_type cur_size = size();\n+        if (cur_size == new_size) {\n+            return;\n+        }\n+        if (cur_size > new_size) {\n             erase(item_ptr(new_size), end());\n+            return;\n         }\n         if (new_size > capacity()) {\n             change_capacity(new_size);\n         }\n-        while (size() < new_size) {\n-            _size++;\n-            new(static_cast<void*>(item_ptr(size() - 1))) T();\n-        }\n+        size_t increase = new_size - cur_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170835611",
      "id" : 170835611,
      "original_commit_id" : "f8b078c8cda6d4ac6e3b112ce605b08f6ac002b9",
      "original_position" : 151,
      "path" : "src/prevector.h",
      "position" : null,
      "pull_request_review_id" : 99580961,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549",
      "updated_at" : "2018-02-27T21:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170835611",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170938344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170938344"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think diganostic message can not be omitted on c++11.",
      "commit_id" : "5aad635b78c8359adae9b2af015b67b7325c0e0b",
      "created_at" : "2018-02-27T14:27:21Z",
      "diff_hunk" : "@@ -32,5 +34,38 @@ static void PrevectorClear(benchmark::State& state)\n     }\n }\n \n+template <typename T>\n+void PrevectorResize(benchmark::State& state)\n+{\n+    while (state.KeepRunning()) {\n+        prevector<28, T> t0;\n+        prevector<28, T> t1;\n+        for (auto x = 0; x < 1000; ++x) {\n+            t0.resize(28);\n+            t0.resize(0);\n+            t1.resize(29);\n+            t1.resize(0);\n+        }\n+    }\n+}\n+\n+static void PrevectorResizeTrivial(benchmark::State& state) {\n+    static_assert(IS_TRIVIALLY_CONSTRUCTIBLE<unsigned char>::value);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170938344",
      "id" : 170938344,
      "original_commit_id" : "f8b078c8cda6d4ac6e3b112ce605b08f6ac002b9",
      "original_position" : 29,
      "path" : "src/bench/prevector.cpp",
      "position" : null,
      "pull_request_review_id" : 99702586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549",
      "updated_at" : "2018-02-27T21:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170938344",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/24285095?v=4",
         "events_url" : "https://api.github.com/users/AkioNak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AkioNak/followers",
         "following_url" : "https://api.github.com/users/AkioNak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AkioNak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AkioNak",
         "id" : 24285095,
         "login" : "AkioNak",
         "organizations_url" : "https://api.github.com/users/AkioNak/orgs",
         "received_events_url" : "https://api.github.com/users/AkioNak/received_events",
         "repos_url" : "https://api.github.com/users/AkioNak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AkioNak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AkioNak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AkioNak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170938591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170938591"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think diganostic message can not be omitted on c++11.",
      "commit_id" : "5aad635b78c8359adae9b2af015b67b7325c0e0b",
      "created_at" : "2018-02-27T14:28:06Z",
      "diff_hunk" : "@@ -32,5 +34,38 @@ static void PrevectorClear(benchmark::State& state)\n     }\n }\n \n+template <typename T>\n+void PrevectorResize(benchmark::State& state)\n+{\n+    while (state.KeepRunning()) {\n+        prevector<28, T> t0;\n+        prevector<28, T> t1;\n+        for (auto x = 0; x < 1000; ++x) {\n+            t0.resize(28);\n+            t0.resize(0);\n+            t1.resize(29);\n+            t1.resize(0);\n+        }\n+    }\n+}\n+\n+static void PrevectorResizeTrivial(benchmark::State& state) {\n+    static_assert(IS_TRIVIALLY_CONSTRUCTIBLE<unsigned char>::value);\n+    PrevectorResize<unsigned char>(state);\n+}\n+\n+struct NontrivialStruct {\n+    int x;\n+    NontrivialStruct() :x(-1) {}\n+};\n+\n+static void PrevectorResizeNontrivial(benchmark::State& state) {\n+    static_assert(!IS_TRIVIALLY_CONSTRUCTIBLE<NontrivialStruct>::value);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r170938591",
      "id" : 170938591,
      "original_commit_id" : "f8b078c8cda6d4ac6e3b112ce605b08f6ac002b9",
      "original_position" : 39,
      "path" : "src/bench/prevector.cpp",
      "position" : null,
      "pull_request_review_id" : 99702888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549",
      "updated_at" : "2018-02-27T21:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170938591",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/24285095?v=4",
         "events_url" : "https://api.github.com/users/AkioNak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AkioNak/followers",
         "following_url" : "https://api.github.com/users/AkioNak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AkioNak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AkioNak",
         "id" : 24285095,
         "login" : "AkioNak",
         "organizations_url" : "https://api.github.com/users/AkioNak/orgs",
         "received_events_url" : "https://api.github.com/users/AkioNak/received_events",
         "repos_url" : "https://api.github.com/users/AkioNak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AkioNak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AkioNak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AkioNak"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Ping @sipa who wrote this code.",
      "created_at" : "2018-02-27T14:57:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368905441",
      "id" : 368905441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T14:57:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368905441",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've addressed the feedback I've gotten so far, and expanded the other benchmarks to test both trivial and non-trivial types.\r\n\r\nOne thing that I also found interesting while doing this change was the way the current code is written to not use SFINAE. On GCC 7.3 (what I have locally) the compiler is smart enough to do the type checks at compile time and not generate runtime checks, meaning it generates optimal code (i.e. the same code it would generate using SFINAE). On GCC 4.8 it's smart enough to do that for trivial types, but does not generate optimal code in the nontrivial path. This is probably fine because the main use of prevector is to hold `unsigned char` (a trivially constructible and destructible type).",
      "created_at" : "2018-02-27T17:30:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368959289",
      "id" : 368959289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T17:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368959289",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I believe your first commit won't compile on GCC 4.8. Also, if you're going to use IS_TRIVIALLY_CONSTRUCTIBLE outside of prevector.h, perhaps it's better to move it elsewhere (like util.h or compat.h)?",
      "created_at" : "2018-02-27T18:55:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368986496",
      "id" : 368986496,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T18:55:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368986496",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, I only tested the last commit. I'll rebase this branch so all of the commits build cleanly, and move the macro definition.",
      "created_at" : "2018-02-27T19:03:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-368989316",
      "id" : 368989316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T19:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368989316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Here are the latest results, tested under both GCC 7.3 and GCC 4.8. For both compilers I ran the full test suite and benchmarks for each of the three commits in this PR.\r\n\r\n### GCC 4.8\r\n\r\n```\r\nCommit     Test                                     Median (s)   Speedup\r\n------------------------------------------------------------------------\r\nf0e7aa     PrevectorClearNontrivial                 8.15034e-05   1.00x\r\nf0e7aa     PrevectorClearTrivial                    1.49740e-04   1.00x\r\nf0e7aa     PrevectorDestructorNontrivial            8.27660e-05   1.00x\r\nf0e7aa     PrevectorDestructorTrivial               1.48346e-04   1.00x\r\nf0e7aa     PrevectorResizeNontrivial                8.26464e-05   1.00x\r\nf0e7aa     PrevectorResizeTrivial                   1.50579e-04   1.00x\r\ne46be2     PrevectorClearNontrivial                 2.59100e-05   3.15x\r\ne46be2     PrevectorClearTrivial                    4.80695e-05   3.12x\r\ne46be2     PrevectorDestructorNontrivial            2.54231e-05   3.26x\r\ne46be2     PrevectorDestructorTrivial               4.80365e-05   3.09x\r\ne46be2     PrevectorResizeNontrivial                2.54693e-05   3.24x\r\ne46be2     PrevectorResizeTrivial                   4.82063e-05   3.12x\r\n3f9abf     PrevectorClearNontrivial                 2.60759e-05   3.13x\r\n3f9abf     PrevectorClearTrivial                    6.08490e-06  24.61x\r\n3f9abf     PrevectorDestructorNontrivial            2.55872e-05   3.23x\r\n3f9abf     PrevectorDestructorTrivial               6.09886e-06  24.32x\r\n3f9abf     PrevectorResizeNontrivial                2.56024e-05   3.23x\r\n3f9abf     PrevectorResizeTrivial                   6.15214e-06  24.48x\r\n```\r\n\r\n### GCC 7.3\r\n```\r\nCommit     Test                                     Median (s)   Speedup\r\n------------------------------------------------------------------------\r\nf0e7aa     PrevectorClearNontrivial                 1.58989e-04   1.00x\r\nf0e7aa     PrevectorClearTrivial                    1.31495e-04   1.00x\r\nf0e7aa     PrevectorDestructorNontrivial            1.58322e-04   1.00x\r\nf0e7aa     PrevectorDestructorTrivial               1.31456e-04   1.00x\r\nf0e7aa     PrevectorResizeNontrivial                1.58518e-04   1.00x\r\nf0e7aa     PrevectorResizeTrivial                   1.29851e-04   1.00x\r\ne46be2     PrevectorClearNontrivial                 4.89286e-05   3.25x\r\ne46be2     PrevectorClearTrivial                    4.81217e-05   2.73x\r\ne46be2     PrevectorDestructorNontrivial            4.94412e-05   3.20x\r\ne46be2     PrevectorDestructorTrivial               4.79828e-05   2.74x\r\ne46be2     PrevectorResizeNontrivial                4.89689e-05   3.24x\r\ne46be2     PrevectorResizeTrivial                   4.80065e-05   2.70x\r\n3f9abf     PrevectorClearNontrivial                 2.59529e-05   6.13x\r\n3f9abf     PrevectorClearTrivial                    6.39799e-06  20.55x\r\n3f9abf     PrevectorDestructorNontrivial            2.58583e-05   6.12x\r\n3f9abf     PrevectorDestructorTrivial               6.40997e-06  20.51x\r\n3f9abf     PrevectorResizeNontrivial                2.56362e-05   6.18x\r\n3f9abf     PrevectorResizeTrivial                   6.40775e-06  20.26x\r\n```\r\n\r\nIt's interesting that GCC 4.8 generates better code in some cases. Anyway, hopefully this is enough data to convince people that this is a good change.",
      "created_at" : "2018-02-27T20:49:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-369020851",
      "id" : 369020851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T20:51:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369020851",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK\r\n\r\nThis is a good optimization @AkioNak / @eklitzke! I didn't have a hack for getting cross platform support for trivial constructors when I wrote https://github.com/bitcoin/bitcoin/pull/9505, so glad to see trivial types handled more optimally now (noting this to clarify that there was no other reason _not_ to do this that I came across in #9505)\r\n\r\nI would only nit that you should amend the line:\r\n\r\n    prevector::~prevector() for trivial types becomes 7.6x faster (most of its time was spent in resize())\r\n\r\nto make it clear you are only referring to the Benchmark, not to the actual destructor (there should be no performance change under this patchset, and it would be good for you to demonstrate that -- ironically it means I probably under-reported the performance advantage when I added the trivial_destructor commit, because I counted the resizes).",
      "created_at" : "2018-02-27T20:54:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-369022397",
      "id" : 369022397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T20:54:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369022397",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r171064514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/171064514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this redundant with the same in `prevector.h`?",
      "commit_id" : "5aad635b78c8359adae9b2af015b67b7325c0e0b",
      "created_at" : "2018-02-27T21:00:55Z",
      "diff_hunk" : "@@ -10,6 +10,16 @@\n #include <config/bitcoin-config.h>\n #endif\n \n+#include <type_traits>\n+\n+// GCC 4.8 is missing some C++11 type_traits,\n+// https://www.gnu.org/software/gcc/gcc-5/changes.html\n+#if defined(__GNUC__) && __GNUC__ < 5\n+#define IS_TRIVIALLY_CONSTRUCTIBLE std::is_trivial\n+#else\n+#define IS_TRIVIALLY_CONSTRUCTIBLE std::is_trivially_constructible\n+#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r171064514",
      "id" : 171064514,
      "original_commit_id" : "3f9abf49d7f96b53719ee99e5c7cd28d9c4c04af",
      "original_position" : 12,
      "path" : "src/compat.h",
      "position" : 12,
      "pull_request_review_id" : 99852671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549",
      "updated_at" : "2018-02-27T21:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/171064514",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r171071990"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/171071990"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, pushing a rebase that fixes this.",
      "commit_id" : "5aad635b78c8359adae9b2af015b67b7325c0e0b",
      "created_at" : "2018-02-27T21:28:12Z",
      "diff_hunk" : "@@ -10,6 +10,16 @@\n #include <config/bitcoin-config.h>\n #endif\n \n+#include <type_traits>\n+\n+// GCC 4.8 is missing some C++11 type_traits,\n+// https://www.gnu.org/software/gcc/gcc-5/changes.html\n+#if defined(__GNUC__) && __GNUC__ < 5\n+#define IS_TRIVIALLY_CONSTRUCTIBLE std::is_trivial\n+#else\n+#define IS_TRIVIALLY_CONSTRUCTIBLE std::is_trivially_constructible\n+#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#discussion_r171071990",
      "id" : 171071990,
      "in_reply_to_id" : 171064514,
      "original_commit_id" : "3f9abf49d7f96b53719ee99e5c7cd28d9c4c04af",
      "original_position" : 12,
      "path" : "src/compat.h",
      "position" : 12,
      "pull_request_review_id" : 99861631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549",
      "updated_at" : "2018-02-27T21:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/171071990",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "utACK 5aad635b78c8359adae9b2af015b67b7325c0e0b. Those benchmark numbers look very nice; thanks @AkioNak as well (sorry I never got around to reviewing your previous PR).",
      "created_at" : "2018-02-27T21:44:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-369037126",
      "id" : 369037126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T21:44:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369037126",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated profile for `ReadBlockFromDisk()` with these changes: https://monad.io/readblockfromdisk2.svg . The time spent waiting on `prevector::resize()` has dropped from about 32% of the total time to 4% of the total time.",
      "created_at" : "2018-02-27T23:18:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-369062502",
      "id" : 369062502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T23:18:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369062502",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa please never mind.",
      "created_at" : "2018-02-27T23:55:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549#issuecomment-369070334",
      "id" : 369070334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
      "updated_at" : "2018-02-27T23:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369070334",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/24285095?v=4",
         "events_url" : "https://api.github.com/users/AkioNak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AkioNak/followers",
         "following_url" : "https://api.github.com/users/AkioNak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AkioNak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AkioNak",
         "id" : 24285095,
         "login" : "AkioNak",
         "organizations_url" : "https://api.github.com/users/AkioNak/orgs",
         "received_events_url" : "https://api.github.com/users/AkioNak/received_events",
         "repos_url" : "https://api.github.com/users/AkioNak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AkioNak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AkioNak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AkioNak"
      }
   }
]
