[
   {
      "author_association" : "MEMBER",
      "body" : "Seeing a CI failure; converting to draft status. \r\n```\r\nsync.cpp:27:1: error: static_assert failed \"thread_local is not supported\"\r\nstatic_assert(false, \"thread_local is not supported\");\r\n^             ~~~~~\r\n1 error generated.\r\n```\r\n",
      "created_at" : "2021-08-18T13:54:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-901135584",
      "id" : 901135584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841tjzg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T13:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901135584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691277896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691277896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I am somewhat worried that the extra calls to `Base::try_lock` cause performance overhead in the non-lock contention debugging case. It's unnecessary. We might want to gate *that too* on the log category being enabled.",
      "commit_id" : "6f6abbe7d735b5a2622df9b5c971cccbca93b886",
      "created_at" : "2021-08-18T14:11:34Z",
      "diff_hunk" : "@@ -138,14 +137,10 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n         if (!Base::try_lock()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691277896",
      "id" : 691277896,
      "line" : 140,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTI3Nzg5Ng==",
      "original_commit_id" : "6f6abbe7d735b5a2622df9b5c971cccbca93b886",
      "original_line" : 140,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 27,
      "pull_request_review_id" : 732919180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-18T14:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691277896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691280693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691280693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, wondering that as well (or alternatively, leave the directives in place and just improve the logging experience when `DEBUG_LOCKCONTENTION` is defined).",
      "commit_id" : "6f6abbe7d735b5a2622df9b5c971cccbca93b886",
      "created_at" : "2021-08-18T14:14:42Z",
      "diff_hunk" : "@@ -138,14 +137,10 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n         if (!Base::try_lock()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691280693",
      "id" : 691280693,
      "in_reply_to_id" : 691277896,
      "line" : 140,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTI4MDY5Mw==",
      "original_commit_id" : "6f6abbe7d735b5a2622df9b5c971cccbca93b886",
      "original_line" : 140,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 27,
      "pull_request_review_id" : 732923029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-18T14:14:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691280693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691487999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691487999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Implemented your suggestion (thanks!)\r\n\r\n(Behind the gate it could now be just `LogPrintf` if anyone prefers.)",
      "commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "created_at" : "2021-08-18T18:03:48Z",
      "diff_hunk" : "@@ -138,14 +137,10 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n         if (!Base::try_lock()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r691487999",
      "id" : 691487999,
      "in_reply_to_id" : 691277896,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTQ4Nzk5OQ==",
      "original_commit_id" : "6f6abbe7d735b5a2622df9b5c971cccbca93b886",
      "original_line" : 140,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 733201598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-18T18:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691487999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Moving this out of draft now, ready for review.",
      "created_at" : "2021-08-18T20:15:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-901400935",
      "id" : 901400935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841ukln",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T20:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901400935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#20487](https://github.com/bitcoin/bitcoin/pull/20487) (Add syscall sandboxing using seccomp-bpf (Linux secure computing mode) by practicalswift)\n* [#16365](https://github.com/bitcoin/bitcoin/pull/16365) (Log RPC parameters (arguments) if -debug=rpcparams by LarryRuane)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-19T08:35:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-901721006",
      "id" : 901721006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841vyuu",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T08:35:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901721006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "created_at" : "2021-08-19T14:50:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-901980815",
      "id" : 901980815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841wyKP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T14:50:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901980815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692383717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692383717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why are those includes needed?",
      "commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "created_at" : "2021-08-19T18:29:56Z",
      "diff_hunk" : "@@ -6,7 +6,10 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include <logging.h>\n #include <threadsafety.h>\n+#include <tinyformat.h>\n+#include <util/strencodings.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692383717",
      "id" : 692383717,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjM4MzcxNw==",
      "original_commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "original_line" : 12,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 7,
      "pull_request_review_id" : 734334313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T18:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692383717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692388102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692388102"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: If `PrintLockContention` stayed in the cpp file, this include can be avoided (it indirectly includes the heavy filesystem header).",
      "commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "created_at" : "2021-08-19T18:36:38Z",
      "diff_hunk" : "@@ -6,7 +6,10 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include <logging.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692388102",
      "id" : 692388102,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjM4ODEwMg==",
      "original_commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 4,
      "pull_request_review_id" : 734334313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T18:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692388102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nNice idea. I've used something similar in my local tree when analysing lock contention locally.\r\n\r\nNon-blocking suggestions:\r\n* In my version I printed the duration too to make it clear from the log entry if the lock contention was significant or not. Perhaps worth adding here too?\r\n* In addition to `__FILE__` and `__LINE__` it would be nice to have `__FUNCTION__` printed as part of the log message too.\r\n\r\nTo rule out any accidental performance regressions: would it be possible to benchmark before vs after this PR (with and without `-debug=lock`) in some intelligent way?\r\n\r\n",
      "created_at" : "2021-08-19T21:32:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902262386",
      "id" : 902262386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841x25y",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T21:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902262386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692550022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692550022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "dropped",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-08-19T23:11:47Z",
      "diff_hunk" : "@@ -6,7 +6,10 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include <logging.h>\n #include <threadsafety.h>\n+#include <tinyformat.h>\n+#include <util/strencodings.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692550022",
      "id" : 692550022,
      "in_reply_to_id" : 692383717,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjU1MDAyMg==",
      "original_commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "original_line" : 12,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 734543340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T23:11:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692550022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692550796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692550796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, though we would have to essentially move `UniqueLock::Enter()` to the cpp file, due to calling `LogAcceptCategory(BCLog::LOCK)`. Punting on this for now.",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-08-19T23:14:07Z",
      "diff_hunk" : "@@ -6,7 +6,10 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include <logging.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r692550796",
      "id" : 692550796,
      "in_reply_to_id" : 692388102,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjU1MDc5Ng==",
      "original_commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 4,
      "pull_request_review_id" : 734544299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T23:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692550796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In my version I printed the duration too to make it clear from the log entry if the lock contention was significant or not. Perhaps worth adding here too?\r\n> \r\n> In addition to `__FILE__` and `__LINE__` it would be nice to have `__FUNCTION__` printed as part of the log message too.\r\n\r\nI think I'd need your help (propose a commit to pull in?) or you could do it as a follow-up.\r\n \r\n> To rule out any accidental performance regressions: would it be possible to benchmark before vs after this PR (with and without `-debug=lock`) in some intelligent way?\r\n\r\nI'll look.  Without `-debug=lock` it should be the same, and I'm not sure anyone besides developers would use the lock logging; it's still fairly verbose. In the worst case I suppose we could add a warning in the RPC logging help.",
      "created_at" : "2021-08-19T23:20:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902315324",
      "id" : 902315324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841yD08",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T10:05:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902315324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj: following up on our IRC convo in `#bitcoin-core-builds`, as a test just pushed a version with the `HAVE_THREAD_LOCAL` conditional compilation directives removed to see what happens...",
      "created_at" : "2021-08-19T23:23:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902316418",
      "id" : 902316418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841yEGC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T23:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902316418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "To-do:\r\n- <strike>add a smoke test with -debug=lock</strike>\r\n- <strike>do some invocation frequency checks and research</strike>\r\n- try benchmarking Mutex::UniqueLock `lock()` versus `try_lock()` and the overhead of `LogAcceptCategory(BCLog::LOCK)`, which evaluates to `m_categories.load(std::memory_order_relaxed) & category) != 0`",
      "created_at" : "2021-08-20T09:35:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902567823",
      "id" : 902567823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841zBeP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-22T17:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902567823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> add a smoke test with -debug=lock\r\n\r\nShouldn't this be enabled in the functional test already by default?",
      "created_at" : "2021-08-20T10:22:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902594037",
      "id" : 902594037,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841zH31",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T10:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902594037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Shouldn't this be enabled in the functional test already by default?\r\n\r\nYou're right, TIL.  I was thinking of adding something like this assertion but probably not worth it or reliable enough:\r\n\r\n```python3\r\n        with node.assert_debug_log(expected_msgs=[\"Lock contention: cs_main\"]):\r\n            node.generate(COINBASE_MATURITY)\r\n```\r\n",
      "created_at" : "2021-08-20T12:55:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902672708",
      "id" : 902672708,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841zbFE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T12:55:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902672708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-08-20T16:33:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902815225",
      "id" : 902815225,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5841z935",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T16:33:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902815225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Observations\r\n\r\n- `void Mutex::UniqueLock::lock()` acquires the mutex and blocks until it gains access to it\r\n\r\n- `bool Mutex::UniqueLock::try_lock()` doesn't block but instead immediately returns whether it acquired the mutex; it may be used by `lock()` internally as part of the deadlock-avoidance algorithm\r\n\r\n- IIUC the test-and-set logic of these calls is ~constant time, optimised and light/quick if used carefully (i.e. no mutex convoying), compared to system calls, memory/cache coherency and fences, wait queues, lock contentions\r\n\r\n- added the following patch and tested a regular, non-debug clang 13 build of bitcoind synced on mainnet\r\n```diff\r\n        if (LogAcceptCategory(BCLog::LOCK)) {\r\n             if (!Base::try_lock()) {\r\n                 LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n                 Base::lock();\r\n+            } else {\r\n+                LogPrintf(\"No lock contention\\n\");\r\n             }\r\n```\r\n \r\n- with this, I'm seeing `src/sync.h::UniqueLock::Enter()` invoked 2500-5000 times per minute, sampled roughly an hour after startup\r\n\r\n- of those, `try_lock()` returns true 99.26% to 99.91% of the time. In the true case the lock logging should have essentially the same performance as when the lock logging is off\r\n\r\n- thus 0.09% to 0.74% of the time `try_lock()` returns false, the contention is logged and `lock()` is then called, in which case the additional overhead compared to `lock()` alone, if any (~depending on how long the mutex was blocked), is of trying the lock and initially returning false\r\n\r\n- Overall, lock contention seems to be relatively infrequent as a percentage of locks. I'm seeing a few per minute. The most common one I see is `cs_vNodes` in `net.cpp::2242/2277::ThreadMessageHandler`.\r\n\r\nEdit: recalculated the numbers and updated.\r\n\r\nSome resources:\r\n- https://preshing.com/20111118/locks-arent-slow-lock-contention-is/\r\n- https://travisdowns.github.io/blog/2020/07/06/concurrency-costs.html\r\n- https://probablydance.com/2019/12/30/measuring-mutexes-spinlocks-and-how-bad-the-linux-scheduler-really-is/\r\n- https://stackoverflow.com/questions/3652056/how-efficient-is-locking-an-unlocked-mutex-what-is-the-cost-of-a-mutex\r\n",
      "created_at" : "2021-08-20T17:38:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-902851054",
      "id" : 902851054,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII58410Gnu",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T22:33:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902851054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-09-01T07:57:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910035766",
      "id" : 910035766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842Pgs2",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T07:57:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910035766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r699989239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699989239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (LogAcceptCategory(BCLog::LOCK) && !Base::try_lock()) {\r\n            LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n        }\r\n```\r\n\r\n?",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-09-01T08:19:05Z",
      "diff_hunk" : "@@ -138,14 +135,14 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n-        if (!Base::try_lock()) {\n-            PrintLockContention(pszName, pszFile, nLine);\n-#endif\n+        if (LogAcceptCategory(BCLog::LOCK)) {\n+            if (!Base::try_lock()) {\n+                LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\n+                Base::lock();\n+            }\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r699989239",
      "id" : 699989239,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5OTk4OTIzOQ==",
      "original_commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "original_line" : 143,
      "original_position" : 32,
      "original_start_line" : 138,
      "path" : "src/sync.h",
      "position" : 32,
      "pull_request_review_id" : 743622555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : 138,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-01T08:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699989239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">     * benchmarking ... the overhead of `LogAcceptCategory(BCLog::LOCK)`, which evaluates to `m_categories.load(std::memory_order_relaxed) & category) != 0`\r\n\r\nI think the benchmarking results could depend on a platform.\r\n\r\nCould we sacrifice the ability to turn \"lock\" debugging on/off at runtime, and use just a const?\r\n\r\n",
      "created_at" : "2021-09-01T08:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910063200",
      "id" : 910063200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842PnZg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T08:32:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910063200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700028085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700028085"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. If I understand the suggestion, this would only lock if the lock logging is on and `try_lock()` succeeds.",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-09-01T09:09:23Z",
      "diff_hunk" : "@@ -138,14 +135,14 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n-        if (!Base::try_lock()) {\n-            PrintLockContention(pszName, pszFile, nLine);\n-#endif\n+        if (LogAcceptCategory(BCLog::LOCK)) {\n+            if (!Base::try_lock()) {\n+                LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\n+                Base::lock();\n+            }\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700028085",
      "id" : 700028085,
      "in_reply_to_id" : 699989239,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDAyODA4NQ==",
      "original_commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "original_line" : 143,
      "original_position" : 32,
      "original_start_line" : 138,
      "path" : "src/sync.h",
      "position" : 32,
      "pull_request_review_id" : 743674807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : 138,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-01T09:09:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700028085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700030470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700030470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```cpp\r\n    void Enter(const char* pszName, const char* pszFile, int nLine)\r\n    {\r\n        EnterCritical(pszName, pszFile, nLine, Base::mutex());\r\n        if (LogAcceptCategory(BCLog::LOCK) && !Base::try_lock()) {\r\n            LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n        }\r\n        Base::lock();\r\n    }\r\n```",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-09-01T09:12:27Z",
      "diff_hunk" : "@@ -138,14 +135,14 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n-        if (!Base::try_lock()) {\n-            PrintLockContention(pszName, pszFile, nLine);\n-#endif\n+        if (LogAcceptCategory(BCLog::LOCK)) {\n+            if (!Base::try_lock()) {\n+                LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\n+                Base::lock();\n+            }\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700030470",
      "id" : 700030470,
      "in_reply_to_id" : 699989239,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDAzMDQ3MA==",
      "original_commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "original_line" : 143,
      "original_position" : 32,
      "original_start_line" : 138,
      "path" : "src/sync.h",
      "position" : 32,
      "pull_request_review_id" : 743677963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : 138,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-01T09:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700030470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700035169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700035169"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nm, my suggestion is wrong.",
      "commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "created_at" : "2021-09-01T09:18:47Z",
      "diff_hunk" : "@@ -138,14 +135,14 @@ class SCOPED_LOCKABLE UniqueLock : public Base\n     void Enter(const char* pszName, const char* pszFile, int nLine)\n     {\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\n-#ifdef DEBUG_LOCKCONTENTION\n-        if (!Base::try_lock()) {\n-            PrintLockContention(pszName, pszFile, nLine);\n-#endif\n+        if (LogAcceptCategory(BCLog::LOCK)) {\n+            if (!Base::try_lock()) {\n+                LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\n+                Base::lock();\n+            }\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700035169",
      "id" : 700035169,
      "in_reply_to_id" : 699989239,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDAzNTE2OQ==",
      "original_commit_id" : "6e7b6bfee377cdb1ea700af8084b08f79cbe5ee5",
      "original_line" : 143,
      "original_position" : 32,
      "original_start_line" : 138,
      "path" : "src/sync.h",
      "position" : 32,
      "pull_request_review_id" : 743684310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : 138,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-01T09:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700035169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Could we sacrifice the ability to turn \"lock\" debugging on/off at runtime, and use just a const?\r\n\r\nI could be wrong, and this goes way beyond my competence, but readings suggest that these options are low-level, fast, and near constant time compared to system calls, memory/cache coherency and fences, wait queues and (particularly) lock contentions.  (Would a difference be apparent in, say, https://bitcoinperf.com? I don't know, but if this helps us reduce contentions, that may be a win. @jamesob, @0xB10C, @martinus thoughts?)",
      "created_at" : "2021-09-01T09:23:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910102088",
      "id" : 910102088,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842Pw5I",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910102088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Could we sacrifice the ability to turn \"lock\" debugging on/off at runtime, and use just a const?\r\n> \r\n> I could be wrong, and this goes way beyond my competence, but readings suggest that these options are low-level, fast, and near constant time compared to system calls, memory/cache coherency and fences, wait queues and (particularly) lock contentions. Would a difference be apparent in, say, https://bitcoinperf.com? I don't know, but if this helps us reduce contentions, that may be a win.\r\n\r\nAnd `m_categories.load(std::memory_order_relaxed)` could cause cache lines switching, no?",
      "created_at" : "2021-09-01T09:23:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910102353",
      "id" : 910102353,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842Pw9R",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910102353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> And `m_categories.load(std::memory_order_relaxed)` could cause cache lines switching, no?\r\n\r\nAlternative version:\r\n```cpp\r\n    void Enter(const char* pszName, const char* pszFile, int nLine)\r\n    {\r\n        EnterCritical(pszName, pszFile, nLine, Base::mutex());\r\n        if (Base::try_lock()) return;\r\n        Base::lock();\r\n        LogPrint(BCLog::LOCK, \"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n    }\r\n```\r\n\r\n",
      "created_at" : "2021-09-01T09:33:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910110140",
      "id" : 910110140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842Py28",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:36:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910110140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > And `m_categories.load(std::memory_order_relaxed)` could cause cache lines switching, no?\r\n> \r\n> Alternative version:\r\n> \r\n> ```c++\r\n>     void Enter(const char* pszName, const char* pszFile, int nLine)\r\n>     {\r\n>         EnterCritical(pszName, pszFile, nLine, Base::mutex());\r\n>         if (Base::try_lock()) return;\r\n>         Base::lock();\r\n>         LogPrint(BCLog::LOCK, \"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n>     }\r\n> ```\r\n\r\nNice!\r\n\r\nMaybe put logging before the blocking call `Base::lock();` as it is now? The `LogPrint` call takes some time, and it could increase probability of releasing a mutex by another thread before the `Base::lock()` call.",
      "created_at" : "2021-09-01T09:40:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910114980",
      "id" : 910114980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842P0Ck",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:54:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910114980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> And `m_categories.load(std::memory_order_relaxed)` could cause cache lines switching, no?\r\n\r\nI don't know.\r\n\r\n> Maybe put logging before the blocking call `Base::lock();` as it is now? The `LogPrint` call takes some time, and it could increase probability of releasing a mutex by another thread before the `Base::lock()` call.\r\n\r\nSeems like a good idea--done.\r\n\r\n\r\n\r\n",
      "created_at" : "2021-09-01T10:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910149515",
      "id" : 910149515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842P8eL",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T10:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910149515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700095417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700095417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> nit: If `PrintLockContention` stayed in the cpp file, this include can be avoided (it indirectly includes the heavy filesystem header).\r\n\r\nagree, dropped the commit changing this",
      "commit_id" : "df149f89dcd0c457c61d463e36c057bb064783b8",
      "created_at" : "2021-09-01T10:44:14Z",
      "diff_hunk" : "@@ -6,7 +6,10 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include <logging.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r700095417",
      "id" : 700095417,
      "in_reply_to_id" : 692388102,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDA5NTQxNw==",
      "original_commit_id" : "ccd73de1dd969097d34634c2be2fc32b03fbd09e",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 4,
      "pull_request_review_id" : 743766642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-01T10:44:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700095417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> as a follow up?\r\n\r\nThanks--was about to re-push to drop the third commit. Will try your suggestion before re-pushing.",
      "created_at" : "2021-09-01T10:46:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910162337",
      "id" : 910162337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842P_mh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T10:46:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910162337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > as a follow up?\r\n> \r\n> Thanks--was about to re-push to drop the third commit. Will try your suggestion before re-pushing.\r\n\r\nMy only concerns are about wording -- \"Enter: Lock contention: cs_vNodes, net.cpp:2242 completed (0.07ms)\" -- \"contention completed\"?",
      "created_at" : "2021-09-01T10:48:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910163668",
      "id" : 910163668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842P_7U",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T10:48:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910163668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> My only concerns are about wording -- \"Enter: Lock contention: cs_vNodes, net.cpp:2242 completed (0.07ms)\" -- \"contention completed\"?\r\n\r\nI'm seeing the following (all of the times are 0.00ms or 0.01ms so far, and seems I should remove \"PrintLockContention\" or \"Lock Contention\" from the log output now)\r\n```\r\n2021-09-01T11:03:59Z PrintLockContention: Lock contention: cs_main, net_processing.cpp:1476 started\r\n2021-09-01T11:03:59Z PrintLockContention: Lock contention: cs_main, net_processing.cpp:1476 completed (0.00ms)\r\n2021-09-01T11:03:59Z PrintLockContention: Lock contention: cs_vNodes, net.cpp:2242 started\r\n2021-09-01T11:03:59Z PrintLockContention: Lock contention: cs_vNodes, net.cpp:2242 completed (0.01ms)\r\n```\r\n\r\n`timer.h::LOG_TIME_MILLIS_WITH_CATEGORY` times the execution of the whole Enter() function, the placement of `Base::lock();` doesn't matter for it?",
      "created_at" : "2021-09-01T11:06:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910176459",
      "id" : 910176459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842QDDL",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T11:39:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910176459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "<details><summary>How about microseconds?</summary><p>\r\n\r\n```diff\r\ndiff --git a/src/logging/timer.h b/src/logging/timer.h\r\nindex 159920e397..cadfe395ee 100644\r\n--- a/src/logging/timer.h\r\n+++ b/src/logging/timer.h\r\n@@ -93,6 +93,8 @@ private:\r\n } // namespace BCLog\r\n \r\n \r\n+#define LOG_TIME_MICROS_WITH_CATEGORY(end_msg, log_category) \\\r\n+    BCLog::Timer<std::chrono::microseconds> PASTE2(logging_timer, __COUNTER__)(__func__, end_msg, log_category)\r\n #define LOG_TIME_MILLIS_WITH_CATEGORY(end_msg, log_category) \\\r\n     BCLog::Timer<std::chrono::milliseconds> PASTE2(logging_timer, __COUNTER__)(__func__, end_msg, log_category)\r\n #define LOG_TIME_SECONDS(end_msg) \\\r\ndiff --git a/src/sync.cpp b/src/sync.cpp\r\nindex a7b63ea986..eace86d9dd 100644\r\n--- a/src/sync.cpp\r\n+++ b/src/sync.cpp\r\n@@ -24,9 +24,9 @@\r\n #include <utility>\r\n #include <vector>\r\n \r\n-void PrintLockContention(const char* pszName, const char* pszFile, int nLine)\r\n+void LockContention(const char* pszName, const char* pszFile, int nLine)\r\n {\r\n-    LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);\r\n+    LOG_TIME_MICROS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);\r\n }\r\n \r\n #ifdef DEBUG_LOCKORDER\r\ndiff --git a/src/sync.h b/src/sync.h\r\nindex 252dc95845..0a8ec9e58f 100644\r\n--- a/src/sync.h\r\n+++ b/src/sync.h\r\n@@ -126,7 +126,8 @@ using RecursiveMutex = AnnotatedMixin<std::recursive_mutex>;\r\n /** Wrapped mutex: supports waiting but not recursive locking */\r\n typedef AnnotatedMixin<std::mutex> Mutex;\r\n \r\n-void PrintLockContention(const char* pszName, const char* pszFile, int nLine);\r\n+/** Print a lock contention to the log */\r\n+void LockContention(const char* pszName, const char* pszFile, int nLine);\r\n \r\n /** Wrapper around std::unique_lock style lock for Mutex. */\r\n template <typename Mutex, typename Base = typename Mutex::UniqueLock>\r\n@@ -137,7 +138,7 @@ private:\r\n     {\r\n         EnterCritical(pszName, pszFile, nLine, Base::mutex());\r\n         if (Base::try_lock()) return;\r\n-        PrintLockContention(pszName, pszFile, nLine);\r\n+        LockContention(pszName, pszFile, nLine);\r\n         Base::lock();\r\n     }\r\n```\r\n</p></details>\r\n\r\n```\r\n2021-09-01T11:29:03Z LockContention: cs_vNodes, net.cpp:1251 started\r\n2021-09-01T11:29:03Z LockContention: cs_vNodes, net.cpp:1251 completed (5s)\r\n2021-09-01T11:29:03Z LockContention: pnode->cs_vSend, net.cpp:1373 started\r\n2021-09-01T11:29:03Z LockContention: pnode->cs_vSend, net.cpp:1373 completed (31s)\r\n2021-09-01T11:29:03Z LockContention: cs_vNodes, net.cpp:2277 started\r\n2021-09-01T11:29:03Z LockContention: cs_vNodes, net.cpp:2277 completed (6s)\r\n2021-09-01T11:29:04Z LockContention: cs_vNodes, net.cpp:2242 started\r\n2021-09-01T11:29:04Z LockContention: cs_vNodes, net.cpp:2242 completed (3s)\r\n```\r\n",
      "created_at" : "2021-09-01T11:34:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910198774",
      "id" : 910198774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842QIf2",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T12:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910198774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> And `m_categories.load(std::memory_order_relaxed)` could cause cache lines switching, no?\r\n\r\nyes, the only guarantee with `memory_order_relaxed` is that the operation itself is atomic, but other operations are allowed to be  shuffled that by the compiler. I personally try to avoid using any of the memory order stuff. It's too easy to get wrong. \r\n\r\nBy the way, I think that in that patch: \r\n\r\n```patch\r\n        if (LogAcceptCategory(BCLog::LOCK)) {\r\n             if (!Base::try_lock()) {\r\n                 LogPrintf(\"Lock contention: %s, %s:%d\\n\", pszName, pszFile, nLine);\r\n                 Base::lock();\r\n+            } else {\r\n+                LogPrintf(\"No lock contention\\n\");\r\n             }\r\n```\r\n\r\nIf `Base::try_lock()` fails strictly speaking that does not necessarily mean that there's a lock contention. `std::mutex`'s `try_lock()` can also spuriously fail even when no other thread is currently holding a lock: https://en.cppreference.com/w/cpp/thread/mutex/try_lock I have no idea though how often that can happen.",
      "created_at" : "2021-09-01T11:47:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910206514",
      "id" : 910206514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842QKYy",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T11:47:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910206514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the ideas and feedback. Updates:\r\n\r\n- added a timing macro in microseconds, `LOG_TIME_MICROS_WITH_CATEGORY`\r\n- improved `BCLog::LogMsg()` to omit irrelevant decimals for microseconds and skip unnecessary code/math\r\n- added time duration in microseconds to the lock contention logging\r\n\r\n> If `Base::try_lock()` fails strictly speaking that does not necessarily mean that there's a lock contention. `std::mutex`'s `try_lock()` can also spuriously fail even when no other thread is currently holding a lock: [en.cppreference.com/w/cpp/thread/mutex/try_lock](https://en.cppreference.com/w/cpp/thread/mutex/try_lock). I have no idea though how often that can happen.\r\n\r\nGood point. I read that doc previously and admit to discounting the spurious failures a little, as we don't know the frequency.  It seems to be an additional reason to log the contention duration.",
      "created_at" : "2021-09-01T13:21:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-910280351",
      "id" : 910280351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842Qcaf",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T14:51:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910280351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing! For me, there seems to be a higher frequency of contention and occuring in more places on mainnet than on signet, presumably as the scale/numbers are larger. Also, a big difference in contention durations between a regular build and a debug build, which makes sense.",
      "created_at" : "2021-09-05T11:14:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#issuecomment-913133555",
      "id" : 913133555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22736",
      "node_id" : "IC_kwDOABII5842bU_z",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-05T11:14:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913133555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r702747920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702747920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated: Could make sense to inline those as well to avoid the heterogeneous code flow? ",
      "commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "created_at" : "2021-09-06T09:23:30Z",
      "diff_hunk" : "@@ -58,12 +58,14 @@ class Timer\n             return strprintf(\"%s: %s\", m_prefix, msg);\n         }\n \n-        std::string units = \"\";\n+        if (std::is_same<TimeType, std::chrono::microseconds>::value) {\n+            return strprintf(\"%s: %s (%is)\", m_prefix, msg, end_time.count());\n+        }\n+\n+        std::string units;\n         float divisor = 1;\n \n-        if (std::is_same<TimeType, std::chrono::microseconds>::value) {\n-            units = \"s\";\n-        } else if (std::is_same<TimeType, std::chrono::milliseconds>::value) {\n+        if (std::is_same<TimeType, std::chrono::milliseconds>::value) {\n             units = \"ms\";\n             divisor = 1000.;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r702747920",
      "id" : 702747920,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjc0NzkyMA==",
      "original_commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "original_line" : 70,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/logging/timer.h",
      "position" : 17,
      "pull_request_review_id" : 747015764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T09:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702747920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703019629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703019629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `LockContention` doesn't do what it is supposed to do. At least it doesn't log the time that the contention actually takes: the macro creates an `BCLog::Timer` instance where constructor measures start time, and destructor prints finished. But since all that is done inside the `LockContention` function, this happens instantly and doesn't measure the actual lock contention.\r\n\r\nI've verified that in https://github.com/bitcoin/bitcoin/pull/21006 because I wanted to see how long the contentions are, but it always prints 0s or 1s. When I move the macro into `sync.h` and replace \r\n\r\n```cpp\r\nLockContention(pszName, pszFile, nLine); // log the contention\r\n```\r\nwith\r\n```cpp\r\nLOG_TIME_MICROS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);\r\n```\r\nI get reasonable contention times, like so:\r\n\r\n```\r\n2021-09-06T17:18:23Z Enter: cs_main, rest.cpp:281 completed (65406s)\r\n2021-09-06T17:18:23Z Enter: cs_main, rest.cpp:281 completed (65331s)\r\n2021-09-06T17:18:23Z Enter: cs_main, rest.cpp:281 completed (65074s)\r\n2021-09-06T17:18:23Z Enter: cs_main, rest.cpp:281 completed (65103s)\r\n2021-09-06T17:18:23Z Enter: cs_main, net_processing.cpp:4051 completed (67687s)\r\n```",
      "commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "created_at" : "2021-09-06T17:21:54Z",
      "diff_hunk" : "@@ -27,10 +28,9 @@\n #if !defined(HAVE_THREAD_LOCAL)\n static_assert(false, \"thread_local is not supported\");\n #endif\n-void PrintLockContention(const char* pszName, const char* pszFile, int nLine)\n+void LockContention(const char* pszName, const char* pszFile, int nLine)\n {\n-    LogPrint(BCLog::LOCK, \"LOCKCONTENTION: %s\\n\", pszName);\n-    LogPrint(BCLog::LOCK, \"Locker: %s:%d\\n\", pszFile, nLine);\n+    LOG_TIME_MICROS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703019629",
      "id" : 703019629,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAxOTYyOQ==",
      "original_commit_id" : "9b08006bc502e67956d6ab518388fad6397cac8d",
      "original_line" : 33,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/sync.cpp",
      "position" : 21,
      "pull_request_review_id" : 747369877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T17:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703019629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703028343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703028343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Interesting, makes sense that it would only be timing the `LockContention()` function. Right now on mainnet with a non-debug clang 13 build running since 6 hours (2 cores x 2.50GHz), I see varying durations of 1-50 usec, most often 2-30.  I suspect your machine is much faster than mine (and that I may be only seeing the time of the macro function as you suggest). Will try your suggestion.",
      "commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "created_at" : "2021-09-06T17:53:55Z",
      "diff_hunk" : "@@ -27,10 +28,9 @@\n #if !defined(HAVE_THREAD_LOCAL)\n static_assert(false, \"thread_local is not supported\");\n #endif\n-void PrintLockContention(const char* pszName, const char* pszFile, int nLine)\n+void LockContention(const char* pszName, const char* pszFile, int nLine)\n {\n-    LogPrint(BCLog::LOCK, \"LOCKCONTENTION: %s\\n\", pszName);\n-    LogPrint(BCLog::LOCK, \"Locker: %s:%d\\n\", pszFile, nLine);\n+    LOG_TIME_MICROS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703028343",
      "id" : 703028343,
      "in_reply_to_id" : 703019629,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAyODM0Mw==",
      "original_commit_id" : "9b08006bc502e67956d6ab518388fad6397cac8d",
      "original_line" : 33,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/sync.cpp",
      "position" : 21,
      "pull_request_review_id" : 747378858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T18:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703028343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703090529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703090529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@martinus This does seem better, now seeing durations of 1 to several million usec (mainnet, non-debug build). Thanks for reporting. Proposed fix in #22904.\r\n",
      "commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "created_at" : "2021-09-06T23:08:46Z",
      "diff_hunk" : "@@ -27,10 +28,9 @@\n #if !defined(HAVE_THREAD_LOCAL)\n static_assert(false, \"thread_local is not supported\");\n #endif\n-void PrintLockContention(const char* pszName, const char* pszFile, int nLine)\n+void LockContention(const char* pszName, const char* pszFile, int nLine)\n {\n-    LogPrint(BCLog::LOCK, \"LOCKCONTENTION: %s\\n\", pszName);\n-    LogPrint(BCLog::LOCK, \"Locker: %s:%d\\n\", pszFile, nLine);\n+    LOG_TIME_MICROS_WITH_CATEGORY(strprintf(\"%s, %s:%d\", pszName, pszFile, nLine), BCLog::LOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703090529",
      "id" : 703090529,
      "in_reply_to_id" : 703019629,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzA5MDUyOQ==",
      "original_commit_id" : "9b08006bc502e67956d6ab518388fad6397cac8d",
      "original_line" : 33,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/sync.cpp",
      "position" : 21,
      "pull_request_review_id" : 747441422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T23:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703090529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703090666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703090666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good idea, done (and more) in #22904",
      "commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "created_at" : "2021-09-06T23:09:29Z",
      "diff_hunk" : "@@ -58,12 +58,14 @@ class Timer\n             return strprintf(\"%s: %s\", m_prefix, msg);\n         }\n \n-        std::string units = \"\";\n+        if (std::is_same<TimeType, std::chrono::microseconds>::value) {\n+            return strprintf(\"%s: %s (%is)\", m_prefix, msg, end_time.count());\n+        }\n+\n+        std::string units;\n         float divisor = 1;\n \n-        if (std::is_same<TimeType, std::chrono::microseconds>::value) {\n-            units = \"s\";\n-        } else if (std::is_same<TimeType, std::chrono::milliseconds>::value) {\n+        if (std::is_same<TimeType, std::chrono::milliseconds>::value) {\n             units = \"ms\";\n             divisor = 1000.;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22736#discussion_r703090666",
      "id" : 703090666,
      "in_reply_to_id" : 702747920,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzA5MDY2Ng==",
      "original_commit_id" : "7e698732836121912f179b7c743a72dd6fdffa72",
      "original_line" : 70,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/logging/timer.h",
      "position" : 17,
      "pull_request_review_id" : 747441534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22736",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T23:09:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703090666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
