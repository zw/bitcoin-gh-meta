{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "TL;DR: this change improves sync time on my PC by ~6%.\r\n\r\nWhile syncing when the CCoinsViewCache gets full it is flushed to disk and then memory is freed. Depending on available cache size, this happens several times. This PR removes the unnecessary reallocations for temporary CCoinsViewCache and reserves the cacheCoins's bucket array to its previous size.\r\n\r\nI benchmarked the change on an AMD Ryzen 9 7950X with this command:\r\n\r\n```sh\r\nhyperfine \\\r\n--show-output --parameter-list commit b5a271334ca81a6adcb1c608d85c83621a9eae47,ceeb71816512642e92a110b2cf5d2549d090fe78 \\\r\n--setup 'git checkout {commit} && make -j$(nproc) src/bitcoind' \\\r\n--prepare 'sync; sudo /sbin/sysctl vm.drop_caches=3' \\\r\n-M 3 './src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000'\r\n```\r\n\r\nWhere b5a271334ca81a6adcb1c608d85c83621a9eae47 is mergebase, and ceeb71816512642e92a110b2cf5d2549d090fe78 this PR.\r\n\r\nWhich runs `-reindex-chainstate` up to block 500000 3 times and compares both commits, giving this result:\r\n\r\n```\r\nBenchmark 1: ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = b5a271334ca81a6adcb1c608d85c83621a9eae47)\r\n  Time (mean Â± Ï):     2815.648 s Â± 70.720 s    [User: 2639.959 s, System: 640.051 s]\r\n  Range (min â¦ max):   2736.616 s â¦ 2872.964 s    3 runs\r\n\r\nBenchmark 2: ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = ceeb71816512642e92a110b2cf5d2549d090fe78)\r\n  Time (mean Â± Ï):     2661.520 s Â± 23.205 s    [User: 2473.010 s, System: 624.040 s]\r\n  Range (min â¦ max):   2635.816 s â¦ 2680.926 s    3 runs\r\n\r\nSummary\r\n  ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = ceeb71816512642e92a110b2cf5d2549d090fe78) ran\r\n    1.06 Â± 0.03 times faster than ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = b5a271334ca81a6adcb1c608d85c83621a9eae47)\r\n```\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945/comments",
   "created_at" : "2023-11-27T06:43:15Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945",
   "id" : 2011597258,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585gZxxZ",
   "number" : 28945,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/28945.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/28945.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28945"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945/timeline",
   "title" : "sync: improve CCoinsViewCache ReallocateCache",
   "updated_at" : "2023-11-27T06:43:21Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
      "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
      "followers_url" : "https://api.github.com/users/martinus/followers",
      "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/martinus",
      "id" : 14386,
      "login" : "martinus",
      "node_id" : "MDQ6VXNlcjE0Mzg2",
      "organizations_url" : "https://api.github.com/users/martinus/orgs",
      "received_events_url" : "https://api.github.com/users/martinus/received_events",
      "repos_url" : "https://api.github.com/users/martinus/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/martinus"
   }
}
