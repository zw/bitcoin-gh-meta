[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28956).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/28956#pullrequestreview-1755018341), [RandyMcMillan](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832151113), [fanquake](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832376788), [Pttn](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832799066), [naumenkogs](https://github.com/bitcoin/bitcoin/pull/28956#pullrequestreview-1759382310), [ariard](https://github.com/bitcoin/bitcoin/pull/28956#pullrequestreview-1761497233) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29015](https://github.com/bitcoin/bitcoin/pull/29015) (kernel: Streamline util library by ryanofsky)\n* [#28983](https://github.com/bitcoin/bitcoin/pull/28983) (Stratum v2 Template Provider (take 2) by Sjors)\n* [#28170](https://github.com/bitcoin/bitcoin/pull/28170) (p2p: adaptive connections services flags by furszy)\n* [#28051](https://github.com/bitcoin/bitcoin/pull/28051) (Get rid of shutdown.cpp/shutdown.h, use SignalInterrupt directly by ryanofsky)\n* [#28043](https://github.com/bitcoin/bitcoin/pull/28043) (fuzz: Test headers pre-sync through p2p interface by dergoegge)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#26812](https://github.com/bitcoin/bitcoin/pull/26812) (test: add end-to-end tests for CConnman and PeerManager by vasild)\n* [#15218](https://github.com/bitcoin/bitcoin/pull/15218) (validation: Flush state after initial sync by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-28T13:27:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1829843027",
      "id" : 1829843027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tETBT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829843027/reactions"
      },
      "updated_at" : "2023-12-13T14:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829843027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns  @darosior @fanquake @maflcko @naumenkogs You all were interested in the previous PR. Would appreciate your review.",
      "created_at" : "2023-11-29T10:58:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1831671138",
      "id" : 1831671138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tLRVi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831671138/reactions"
      },
      "updated_at" : "2023-11-29T10:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831671138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409131058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're building a function that collects this info, maybe call it `GetInfo()` and combine it with `IgnoresIncomingTxs()` ?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:13:45Z",
      "diff_hunk" : "@@ -84,6 +88,9 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Get statistics from node state */\n     virtual bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const = 0;\n \n+    /** Get stats from peer manager. */\n+    virtual PeerManagerStats GetStats() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409131058",
      "id" : 1409131058,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_aIy",
      "original_commit_id" : "cab1cf9c134b15e829ddcea676cc1b5a039ace08",
      "original_line" : 92,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409132248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be conditional on `node.peerman` being valid, see the previous line.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:14:45Z",
      "diff_hunk" : "@@ -674,7 +673,7 @@ static RPCHelpMan getnetworkinfo()\n     if (node.peerman) {\n         obj.pushKV(\"localrelay\", !node.peerman->IgnoresIncomingTxs());\n     }\n-    obj.pushKV(\"timeoffset\",    GetTimeOffset());\n+    obj.pushKV(\"timeoffset\", node.peerman->GetStats().median_outbound_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409132248",
      "id" : 1409132248,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_abY",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 676,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409140558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having a rolling set of 10 time offsets from every outbound connection we make (full outbounds, block-relay-only, extra block-relay-only, feelers?) seems somewhat risky: at present, you'll get odd behaviour if a high-proportion of the first 100 outbound peers you connect to have a different time; with this change, you'll get a warning if the last 10 peers you randomly connect to have a dodgy view of the time?\r\n\r\nMaybe consider making this conditional on `IsManualOrFullOutboundConn()` instead; that way it only updates rarely for things we're really trying to connect to, and isn't mostly made up of random peers we're briefly sampling?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:22:50Z",
      "diff_hunk" : "@@ -3567,6 +3601,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Don't use timedata samples from inbound peers to make it\n             // harder for others to tamper with our adjusted time.\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n+\n+            m_outbound_time_offsets.Add(peer->m_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409140558",
      "id" : 1409140558,
      "line" : 3612,
      "node_id" : "PRRC_kwDOABII585T_cdO",
      "original_commit_id" : "71d61076657557f7d7041624e0d959807fa6d786",
      "original_line" : 3612,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409146055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`SetMiscWarning` seems a poor interface; if there's two warnings, the latest one overrides the first, and you can't remove warnings in the event that they resolve themselves. Might be better to do something like `SetfLargeWorkInvalidChainFound(bool)` ?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:27:50Z",
      "diff_hunk" : "@@ -3611,6 +3613,12 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n \n             m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();\n+            if (median > TIME_OFFSET_WARN_THRESHOLD.count() ||\n+                median < -TIME_OFFSET_WARN_THRESHOLD.count()) {\n+                SetMiscWarning(Untranslated(\"Please check that your computer's date and time are correct\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409146055",
      "id" : 1409146055,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_dzH",
      "original_commit_id" : "786c562b074324cc81e81a008d2a7e36f9deca7d",
      "original_line" : 3620,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409150007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is reduced from 70min to 30min, compared to `DEFAULT_MAX_TIME_ADJUSTMENT`. 70min avoids warning if you're buggy by an hour due to (you or your peers) getting daylight savings time wrong, which seems like a vaguely plausible thing to continue doing?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:31:46Z",
      "diff_hunk" : "@@ -175,6 +176,7 @@ static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\n static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\n /** The compactblocks version we support. See BIP 152. */\n static constexpr uint64_t CMPCTBLOCKS_VERSION{2};\n+static constexpr std::chrono::seconds TIME_OFFSET_WARN_THRESHOLD{30min};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409150007",
      "id" : 1409150007,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_ew3",
      "original_commit_id" : "786c562b074324cc81e81a008d2a7e36f9deca7d",
      "original_line" : 179,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409151223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps swap this option for one that controls how much of a time difference results in a warning? Not sure.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:32:59Z",
      "diff_hunk" : "@@ -497,7 +496,6 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-maxconnections=<n>\", strprintf(\"Maintain at most <n> automatic connections to peers (default: %u). This limit does not apply to connections manually added via -addnode or the addnode RPC, which have a separate limit of %u.\", DEFAULT_MAX_PEER_CONNECTIONS, MAX_ADDNODE_CONNECTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxreceivebuffer=<n>\", strprintf(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXRECEIVEBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxsendbuffer=<n>\", strprintf(\"Maximum per-connection memory usage for the send buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXSENDBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n-    argsman.AddArg(\"-maxtimeadjustment\", strprintf(\"Maximum allowed median peer time offset adjustment. Local perspective of time may be influenced by outbound peers forward or backward by this amount (default: %u seconds).\", DEFAULT_MAX_TIME_ADJUSTMENT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409151223",
      "id" : 1409151223,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585T_fD3",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409284495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea, done!",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:29:54Z",
      "diff_hunk" : "@@ -84,6 +88,9 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Get statistics from node state */\n     virtual bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const = 0;\n \n+    /** Get stats from peer manager. */\n+    virtual PeerManagerStats GetStats() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409284495",
      "id" : 1409284495,
      "in_reply_to_id" : 1409131058,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T__mP",
      "original_commit_id" : "cab1cf9c134b15e829ddcea676cc1b5a039ace08",
      "original_line" : 92,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1755270180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:29:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409285449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe consider making this conditional on IsManualOrFullOutboundConn()\r\n\r\nDone",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:30:42Z",
      "diff_hunk" : "@@ -3567,6 +3601,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Don't use timedata samples from inbound peers to make it\n             // harder for others to tamper with our adjusted time.\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n+\n+            m_outbound_time_offsets.Add(peer->m_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409285449",
      "id" : 1409285449,
      "in_reply_to_id" : 1409140558,
      "line" : 3612,
      "node_id" : "PRRC_kwDOABII585T__1J",
      "original_commit_id" : "71d61076657557f7d7041624e0d959807fa6d786",
      "original_line" : 3612,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1755271738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409290332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No strong opinion on this, but it doesn't seem very useful to me to be able to set that threshold. Happy to add this if someone can name a good reason.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:34:19Z",
      "diff_hunk" : "@@ -497,7 +496,6 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-maxconnections=<n>\", strprintf(\"Maintain at most <n> automatic connections to peers (default: %u). This limit does not apply to connections manually added via -addnode or the addnode RPC, which have a separate limit of %u.\", DEFAULT_MAX_PEER_CONNECTIONS, MAX_ADDNODE_CONNECTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxreceivebuffer=<n>\", strprintf(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXRECEIVEBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxsendbuffer=<n>\", strprintf(\"Maximum per-connection memory usage for the send buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXSENDBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n-    argsman.AddArg(\"-maxtimeadjustment\", strprintf(\"Maximum allowed median peer time offset adjustment. Local perspective of time may be influenced by outbound peers forward or backward by this amount (default: %u seconds).\", DEFAULT_MAX_TIME_ADJUSTMENT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409290332",
      "id" : 1409290332,
      "in_reply_to_id" : 1409151223,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585UABBc",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1755281286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T15:36:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832151113",
      "id" : 1832151113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tNGhJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832151113/reactions"
      },
      "updated_at" : "2023-11-29T15:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832151113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/152159?v=4",
         "events_url" : "https://api.github.com/users/RandyMcMillan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/RandyMcMillan/followers",
         "following_url" : "https://api.github.com/users/RandyMcMillan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/RandyMcMillan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/RandyMcMillan",
         "id" : 152159,
         "login" : "RandyMcMillan",
         "node_id" : "MDQ6VXNlcjE1MjE1OQ==",
         "organizations_url" : "https://api.github.com/users/RandyMcMillan/orgs",
         "received_events_url" : "https://api.github.com/users/RandyMcMillan/received_events",
         "repos_url" : "https://api.github.com/users/RandyMcMillan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/RandyMcMillan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/RandyMcMillan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/RandyMcMillan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T17:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832376788",
      "id" : 1832376788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tN9nU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832376788/reactions"
      },
      "updated_at" : "2023-11-29T17:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832376788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T22:26:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832799066",
      "id" : 1832799066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tPkta",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832799066/reactions"
      },
      "updated_at" : "2023-11-29T22:26:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832799066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/28868425?v=4",
         "events_url" : "https://api.github.com/users/Pttn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Pttn/followers",
         "following_url" : "https://api.github.com/users/Pttn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Pttn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Pttn",
         "id" : 28868425,
         "login" : "Pttn",
         "node_id" : "MDQ6VXNlcjI4ODY4NDI1",
         "organizations_url" : "https://api.github.com/users/Pttn/orgs",
         "received_events_url" : "https://api.github.com/users/Pttn/received_events",
         "repos_url" : "https://api.github.com/users/Pttn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Pttn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Pttn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Pttn"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411184510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this use `min(N, m_index)` instead of `N`?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-30T19:44:45Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411184510",
      "id" : 1411184510,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UHPd-",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1758318406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-30T19:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411821098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "122658f95b36b7f940351bd34a89e13831931f18\r\n\r\nshould we make this addition overflow safe?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-01T09:17:58Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411821098",
      "id" : 1411821098,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UJq4q",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1759350317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T09:17:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413301629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think one advance in term of robustness of this local time monitoring mechanism could be to add feeler âs time offset (`ConnectionType::FEELER`) to reserved slots in the index (e.g +3 on the 10 full-outbound connections). Those peers connections are already triggered at regular interval, which is not necessarily the case of outbound peer topology if the peers are stable and performant.\r\n\r\nI guess a NTP-attacker could silently time shift the local clock of a victim, without this warning logic ever triggering if no new outbound or manual connections are ever opened during the exploitation.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T02:23:07Z",
      "diff_hunk" : "@@ -3557,12 +3605,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   peer->m_starting_height, addrMe.ToStringAddrPort(), fRelay, pfrom.GetId(),\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n-        int64_t nTimeOffset = nTime - GetTime();\n-        pfrom.nTimeOffset = nTimeOffset;\n-        if (!pfrom.IsInboundConn()) {\n-            // Don't use timedata samples from inbound peers to make it\n-            // harder for others to tamper with our adjusted time.\n-            AddTimeData(pfrom.addr, nTimeOffset);\n+        peer->m_time_offset = nTime - GetTime();\n+\n+        if (pfrom.IsManualOrFullOutboundConn()) {\n+            // Only sample from outbound connections we are really trying to connect to.\n+            m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413301629",
      "id" : 1413301629,
      "line" : 3614,
      "node_id" : "PRRC_kwDOABII585UPUV9",
      "original_commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "original_line" : 3614,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 137,
      "pull_request_review_id" : 1761497233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T02:27:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413770472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The idea is that `m_index` is always set to the next index in `m_offsets` that gets written to (so a value out of `[0, N)`) and we just assume that the initial N samples were 0, which is why the median is immediately computed out of N.\r\n\r\nI could change it to always increase `m_index` instead and add new offsets by doing `m_offsets[m_index % N] = new_offset`, in which case your suggestion would allow us to compute the median more \"accurately\" while we haven't seen N samples yet. I'm not sure though if that is an improvement,. e.g. do we want to issue a warning if only the first outbound connection has a offset larger than our threshold?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T11:56:44Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413770472",
      "id" : 1413770472,
      "in_reply_to_id" : 1411184510,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585URGzo",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1762231767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T11:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413773031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm yea I guess... I could also just remove support for even `N`s from this class.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T11:58:49Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413773031",
      "id" : 1413773031,
      "in_reply_to_id" : 1411821098,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585URHbn",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1762238037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1415130119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415130119"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">do we want to issue a warning if only the first outbound connection has a offset larger than our threshold?\r\n\r\nThis is the main question I guess.\r\nSo, with the current code, having 4 peers would never trigger it, right? Because median will always be 0.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-05T08:31:51Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1415130119",
      "id" : 1415130119,
      "in_reply_to_id" : 1411184510,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UWSwH",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1764352235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415130119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T08:31:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415130119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1415132157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415132157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "i won't mind that either, but ideally with an in-function comment.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-05T08:32:27Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1415132157",
      "id" : 1415132157,
      "in_reply_to_id" : 1411821098,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UWTP9",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1764355275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415132157/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T08:32:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415132157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417498148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498148"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  So, with the current code, having 4 peers would never trigger it, right? Because median will always be 0.\r\n\r\nYes and this sort of (on accident) mimics how/when we trigger the warning on master at 5 or more samples: https://github.com/bitcoin/bitcoin/blob/dde7ac5c704688c8a9af29bd07e5ae8114824ce7/src/timedata.cpp#L77",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-06T15:20:15Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417498148",
      "id" : 1417498148,
      "in_reply_to_id" : 1411184510,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UfU4k",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1767854381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T15:20:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417498497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-06T15:20:28Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417498497",
      "id" : 1417498497,
      "in_reply_to_id" : 1411821098,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UfU-B",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1767854950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T15:20:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417498497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417504050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417504050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see your point but I think I would like to keep discussion about improving the warning condition to a future PR. The current adjusted time mechanism has the same flaw and is even worse as it stops sampling entirely after 200 samples.\r\n\r\nMaybe we can collect some stats on how often outbound connections rotate and how many samples from which connections are actually useful to inform such a change.\r\n\r\n---\r\n\r\nI will add the release note.",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-06T15:23:58Z",
      "diff_hunk" : "@@ -3557,12 +3605,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   peer->m_starting_height, addrMe.ToStringAddrPort(), fRelay, pfrom.GetId(),\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n-        int64_t nTimeOffset = nTime - GetTime();\n-        pfrom.nTimeOffset = nTimeOffset;\n-        if (!pfrom.IsInboundConn()) {\n-            // Don't use timedata samples from inbound peers to make it\n-            // harder for others to tamper with our adjusted time.\n-            AddTimeData(pfrom.addr, nTimeOffset);\n+        peer->m_time_offset = nTime - GetTime();\n+\n+        if (pfrom.IsManualOrFullOutboundConn()) {\n+            // Only sample from outbound connections we are really trying to connect to.\n+            m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1417504050",
      "id" : 1417504050,
      "in_reply_to_id" : 1413301629,
      "line" : 3611,
      "node_id" : "PRRC_kwDOABII585UfWUy",
      "original_commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "original_line" : 3611,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 134,
      "pull_request_review_id" : 1767864568,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417504050/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T15:23:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417504050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418616411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418616411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I won't mind, but this should be commented somewhere above âÂ perhaps where 0 returned is handled.",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-07T08:58:04Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418616411",
      "id" : 1418616411,
      "in_reply_to_id" : 1411184510,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ujl5b",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1769568731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418616411/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T08:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418616411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418629765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418629765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6c65f61b625212e128e5db52cbd80a3b57b1450b\r\n\r\nnit: your code assumes that N is less than the capacity of `size_t`, otherwise this addition can overflow. You might consider adding a static assert for that too, just in case someone in the future decides to use `TimeOffsets<bazillion>`",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-07T09:04:40Z",
      "diff_hunk" : "@@ -186,6 +186,35 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418629765",
      "id" : 1418629765,
      "line" : 206,
      "node_id" : "PRRC_kwDOABII585UjpKF",
      "original_commit_id" : "6c65f61b625212e128e5db52cbd80a3b57b1450b",
      "original_line" : 205,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 44,
      "pull_request_review_id" : 1769589876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418629765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T09:04:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418629765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418647036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418647036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "After your changes, we won't consider `BLOCK_RELAY`, `FEELER`, `ADDR_FETCH` anymore, right?",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-07T09:18:47Z",
      "diff_hunk" : "@@ -3604,11 +3603,6 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n         peer->m_time_offset = nTime - GetTime();\n-        if (!pfrom.IsInboundConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418647036",
      "id" : 1418647036,
      "line" : 3562,
      "node_id" : "PRRC_kwDOABII585UjtX8",
      "original_commit_id" : "569a8797cce6bd1cbb4c3d8362ce300baf250ac8",
      "original_line" : 3607,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 124,
      "pull_request_review_id" : 1769618257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418647036/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T09:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418647036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418654682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418654682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why don't you implement going out of this warning?",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-07T09:24:59Z",
      "diff_hunk" : "@@ -28,6 +29,12 @@ void SetfLargeWorkInvalidChainFound(bool flag)\n     fLargeWorkInvalidChainFound = flag;\n }\n \n+void SetMedianTimeOffsetWarning()\n+{\n+    LOCK(g_warnings_mutex);\n+    g_timeoffset_warning = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418654682",
      "id" : 1418654682,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585UjvPa",
      "original_commit_id" : "b7364bc832437d95f1e712ed25f25ecb072da66c",
      "original_line" : 35,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/warnings.cpp",
      "position" : 15,
      "pull_request_review_id" : 1769630587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418654682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T09:25:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418654682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418656693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418656693"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">stops sampling entirely after 200 samples\r\n\r\nperhaps record this bug in the commit message, might be useful in the future?",
      "commit_id" : "2d429bc5c4deac68b0c7a84832e23eac9de63988",
      "created_at" : "2023-12-07T09:26:37Z",
      "diff_hunk" : "@@ -3557,12 +3605,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   peer->m_starting_height, addrMe.ToStringAddrPort(), fRelay, pfrom.GetId(),\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n-        int64_t nTimeOffset = nTime - GetTime();\n-        pfrom.nTimeOffset = nTimeOffset;\n-        if (!pfrom.IsInboundConn()) {\n-            // Don't use timedata samples from inbound peers to make it\n-            // harder for others to tamper with our adjusted time.\n-            AddTimeData(pfrom.addr, nTimeOffset);\n+        peer->m_time_offset = nTime - GetTime();\n+\n+        if (pfrom.IsManualOrFullOutboundConn()) {\n+            // Only sample from outbound connections we are really trying to connect to.\n+            m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1418656693",
      "id" : 1418656693,
      "in_reply_to_id" : 1413301629,
      "line" : 3611,
      "node_id" : "PRRC_kwDOABII585Ujvu1",
      "original_commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "original_line" : 3611,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 134,
      "pull_request_review_id" : 1769633858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418656693/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T09:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418656693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Changed the approach.\r\n\r\nThis now still deletes all the adjusted time code and removes it from consensus code but keeps the warning condition for a large median time offset as it is on master. Improvements to the warning can be done in a follow up.\r\n\r\nThis should now be a very straight forward review, since we don't need to discuss a new warning mechanism.",
      "created_at" : "2023-12-11T14:47:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1850227162",
      "id" : 1850227162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585uSDna",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1850227162/reactions"
      },
      "updated_at" : "2023-12-11T14:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1850227162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422593402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422593402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Kept the setting in the new approach",
      "commit_id" : "39453edbeea91609db083a2d86eeb18cf111259c",
      "created_at" : "2023-12-11T14:52:27Z",
      "diff_hunk" : "@@ -497,7 +496,6 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-maxconnections=<n>\", strprintf(\"Maintain at most <n> automatic connections to peers (default: %u). This limit does not apply to connections manually added via -addnode or the addnode RPC, which have a separate limit of %u.\", DEFAULT_MAX_PEER_CONNECTIONS, MAX_ADDNODE_CONNECTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxreceivebuffer=<n>\", strprintf(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXRECEIVEBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxsendbuffer=<n>\", strprintf(\"Maximum per-connection memory usage for the send buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXSENDBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n-    argsman.AddArg(\"-maxtimeadjustment\", strprintf(\"Maximum allowed median peer time offset adjustment. Local perspective of time may be influenced by outbound peers forward or backward by this amount (default: %u seconds).\", DEFAULT_MAX_TIME_ADJUSTMENT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422593402",
      "id" : 1422593402,
      "in_reply_to_id" : 1409151223,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585Uyw16",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1775338668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422593402/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T14:52:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422593402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422595852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422595852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is documented in the current code. \r\nhttps://github.com/bitcoin/bitcoin/blob/40bc501bf462e1b38679f728336f18f08ee251ca/src/timedata.cpp#L60-L76",
      "commit_id" : "39453edbeea91609db083a2d86eeb18cf111259c",
      "created_at" : "2023-12-11T14:54:08Z",
      "diff_hunk" : "@@ -3557,12 +3605,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   peer->m_starting_height, addrMe.ToStringAddrPort(), fRelay, pfrom.GetId(),\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n-        int64_t nTimeOffset = nTime - GetTime();\n-        pfrom.nTimeOffset = nTimeOffset;\n-        if (!pfrom.IsInboundConn()) {\n-            // Don't use timedata samples from inbound peers to make it\n-            // harder for others to tamper with our adjusted time.\n-            AddTimeData(pfrom.addr, nTimeOffset);\n+        peer->m_time_offset = nTime - GetTime();\n+\n+        if (pfrom.IsManualOrFullOutboundConn()) {\n+            // Only sample from outbound connections we are really trying to connect to.\n+            m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422595852",
      "id" : 1422595852,
      "in_reply_to_id" : 1413301629,
      "line" : 3627,
      "node_id" : "PRRC_kwDOABII585UyxcM",
      "original_commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "original_line" : 3627,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 142,
      "pull_request_review_id" : 1775342506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422595852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T14:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422595852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422596329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596329"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With the new approach this is kept as is on master",
      "commit_id" : "39453edbeea91609db083a2d86eeb18cf111259c",
      "created_at" : "2023-12-11T14:54:29Z",
      "diff_hunk" : "@@ -3604,11 +3603,6 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n         peer->m_time_offset = nTime - GetTime();\n-        if (!pfrom.IsInboundConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422596329",
      "id" : 1422596329,
      "in_reply_to_id" : 1418647036,
      "line" : 3562,
      "node_id" : "PRRC_kwDOABII585Uyxjp",
      "original_commit_id" : "569a8797cce6bd1cbb4c3d8362ce300baf250ac8",
      "original_line" : 3562,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 136,
      "pull_request_review_id" : 1775343288,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596329/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T14:54:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422596929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This wasn't implemented before either. This can be improved in a follow up.",
      "commit_id" : "39453edbeea91609db083a2d86eeb18cf111259c",
      "created_at" : "2023-12-11T14:54:55Z",
      "diff_hunk" : "@@ -28,6 +29,12 @@ void SetfLargeWorkInvalidChainFound(bool flag)\n     fLargeWorkInvalidChainFound = flag;\n }\n \n+void SetMedianTimeOffsetWarning()\n+{\n+    LOCK(g_warnings_mutex);\n+    g_timeoffset_warning = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1422596929",
      "id" : 1422596929,
      "in_reply_to_id" : 1418654682,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585UyxtB",
      "original_commit_id" : "b7364bc832437d95f1e712ed25f25ecb072da66c",
      "original_line" : 35,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/warnings.cpp",
      "position" : 15,
      "pull_request_review_id" : 1775344296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-11T14:54:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1422596929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looking at the diff between the two versions, I see these changes:\r\n1. which peers are taken into account (`FEELER`, `ADDRFETCH`, `BLOCKRELAY` are also considered)\r\n2. the 199-bug is brought back\r\n3. fixed addition overflow; an alternative would divide each element by 2 and then add without overflow risk, it saves us the sloppiness `int64_max/2`; but i don't care that much)\r\n\r\nNot sure i see `keeps warning condition for a large median time offset as it is on master`.\r\n\r\nGenerally, while I think it's fine to leave (1) for the latter PR, re-introducing the bug (2) is somewhat unfortunate:\r\n- it's just a bad practice\r\n- even if the bug was anything useful before, it won't be anymore since all we keep is\r\n- i actually think the original diff is easier to review than the bug re-introduction :)\r\n\r\n(3) should be kept for either version of course.",
      "created_at" : "2023-12-12T08:55:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1851561925",
      "id" : 1851561925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585uXJfF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851561925/reactions"
      },
      "updated_at" : "2023-12-12T08:55:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851561925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removing adjusted time from consensus is a big win. Having time samples received from peers be involved in consensus checks is not great and not effective against NTP based attacks (https://github.com/bitcoin/bitcoin/pull/25908#issuecomment-1264632475, https://github.com/bitcoin/bitcoin/pull/25908#issuecomment-1271239626). The warning itself is not as interesting to me but most of the review on both #25908 and this PR is about the warning and its threshold.\r\n\r\nI don't want changing the warning (small win) to distract from removing adjusted time from consensus (big win).",
      "created_at" : "2023-12-12T10:54:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1851803284",
      "id" : 1851803284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585uYEaU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851803284/reactions"
      },
      "updated_at" : "2023-12-12T10:54:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851803284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> an alternative would divide each element by 2 and then add without overflow risk\r\n\r\nDone.",
      "created_at" : "2023-12-12T11:01:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1851813782",
      "id" : 1851813782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585uYG-W",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851813782/reactions"
      },
      "updated_at" : "2023-12-12T11:01:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1851813782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Removing adjusted time from consensus is a big win. Having time samples received from peers be involved in consensus checks is not great and not effective against NTP based attacks (#25908 (comment), #25908 (comment)). The warning itself is not as interesting to me but most of the review on both #25908 and this PR is about the warning and its threshold.\r\n\r\nCurrently, we're adjusting our local clock from the median of the first 199 outbound peers we're connecting to (only the first 199 due to the oddness bug in `AddTimeData()`). In case of the occurence of a NTP-based attack (e.g a malicious network delay on traffic between the local system NTP client and its timeservers), this median-adjusted time mechanism can generate a salvatory warning towards the node operators (the `\"Please check that your computer's date and time are correct!\"`). However, this mechanism comes as a security benefit only if the attack is active when you start your local bitcoind and until the first 199 outbound peers connection have been sampled (which might last for hours / days, given our only 10 outbound connections slots at the moment). So there is a robustness benefit brought by the current adjusted time mechanism and this is has been one of my main concern brought in #25908.\r\n\r\nOn the other hand, this mechanism can allow your outbound peers topology to correct your local time (as used for some consensus rules validation in `ContextualCheckBlockHeader()` ) in the boundaries of -/+ `DEFAULT_MAX_TIME_ADJUSTEMENT`. This exploit assumes youâre able to corrupt or compromise 100 outbound peers (as it's a median), which has to be done in considerations of all our hardenings in `AddrMan` and some low-hashrate capabilities. Those 2 elements in my appreciation present a very high-bar (at least compared to state-of-art practical NTP-based attacks).\r\n\r\nAs such, I reasonably think maintaining the warning mechanism is valuable at the very least to maintain current robustness of our consensus validation code in face of NTP attacks. This always give the chance of node operators noticing time anomalies from their logs, which is welcome robustness if youâre operating a time-sensitive bitcoin infrastructure imo. I think we should be better to keep a large buffer of sampled outbound peers (e.g in the order of 100 outbound peers as right now) for this current change itself, and fix the oddness bug.\r\n\r\nFor sure, we can add additional robustness mechanisms in follow-up PRs, e.g \"random drop\" of sampeld peers time offset to add uncertainty in the eyes of adversaries targeting neutralization of the warning mechanism or including feelers connections in sampled offsets. \r\n\r\n--------------------------------------\r\n\r\nAnother source of concern, the ajdusted-time is implemented by other full-nodes with at least some other real-world economic traffic. If we're modifying our consensus-definition of time, and they stay on the old one, this could be source of consensus discrepancies in some edge scenarios. True, this could be a source of concern for non-upraded Bitcoin Core nodes.\r\n\r\nFrom a deployment viewpoint, my recommendation is to notify on the maling list or bitcoin forums other bitcoin full-nodes  implementations of this change, and some \"rough\" deployment timeline in function of Bitcoin Core's own 27.0 or 28.0 release schedules. I think there is a lesson to be learnt from the old Bitcoin 0.8 LevelDB upgrade.\r\n\r\nSee, btcd code: https://github.com/btcsuite/btcd/blob/master/blockchain/mediantime.go#L74\r\n\r\n```\r\n// medianTime provides an implementation of the MedianTimeSource interface.\r\n// It is limited to maxMedianTimeEntries includes the same buggy behavior as\r\n// the time offset mechanism in Bitcoin Core.  This is necessary because it is\r\n// used in the consensus code.\r\ntype medianTime struct {\r\n        mtx                sync.Mutex\r\n        knownIDs           map[string]struct{}\r\n        offsets            []int64\r\n        offsetSecs         int64\r\n        invalidTimeChecked bool\r\n}\r\n```",
      "created_at" : "2023-12-12T21:10:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1852816465",
      "id" : 1852816465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585ub7xR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852816465/reactions"
      },
      "updated_at" : "2023-12-12T21:17:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852816465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-12-14T21:41:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1856683941",
      "id" : 1856683941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585uqr-l",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856683941/reactions"
      },
      "updated_at" : "2023-12-14T21:41:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856683941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
