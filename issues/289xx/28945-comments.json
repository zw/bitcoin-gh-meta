[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28945).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28280](https://github.com/bitcoin/bitcoin/pull/28280) (Don't empty dbcache on prune flushes: >30% faster IBD by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-27T06:43:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#issuecomment-1827211645",
      "id" : 1827211645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945",
      "node_id" : "IC_kwDOABII585s6Ql9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1827211645/reactions"
      },
      "updated_at" : "2023-12-01T01:54:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1827211645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hi, is this benchmark for HDD or SSD? Did you tried to run benchmark with huge dbcache and high height?",
      "created_at" : "2023-12-09T06:42:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#issuecomment-1848265773",
      "id" : 1848265773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945",
      "node_id" : "IC_kwDOABII585uKkwt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1848265773/reactions"
      },
      "updated_at" : "2023-12-09T06:42:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1848265773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/30323047?v=4",
         "events_url" : "https://api.github.com/users/helpau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/helpau/followers",
         "following_url" : "https://api.github.com/users/helpau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/helpau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/helpau",
         "id" : 30323047,
         "login" : "helpau",
         "node_id" : "MDQ6VXNlcjMwMzIzMDQ3",
         "organizations_url" : "https://api.github.com/users/helpau/orgs",
         "received_events_url" : "https://api.github.com/users/helpau/received_events",
         "repos_url" : "https://api.github.com/users/helpau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/helpau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/helpau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/helpau"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I only measured it on an SSD, and only with relatively low dbcache size so flushing is triggered more often which I think would give more accurate results. But more benchmarks are definitely appreciated :)",
      "created_at" : "2023-12-09T08:56:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#issuecomment-1848332095",
      "id" : 1848332095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945",
      "node_id" : "IC_kwDOABII585uK08_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1848332095/reactions"
      },
      "updated_at" : "2023-12-09T08:56:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1848332095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28945#discussion_r1428946493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428946493"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The purpose of `ReallocateCache` originally was to balance the snapshot and background chainstate caches (see https://github.com/bitcoin/bitcoin/pull/18637). However, in https://github.com/bitcoin/bitcoin/pull/25325/commits/5e4ac5abf54f8e6d6330df0c73119aa0cca4c103 this function was removed from `ResizeCoinsCaches` and moved to `Flush`. This created an implicit assumption that calling `Flush` would clear the memory in the cache. This change violates that assumption, since the memory will no longer be clear and therefore `ResizeCoinsCaches` will likely no longer respect the `dbcache` limit during assumeutxo syncing.\r\n\r\nAlso see the docs for this function https://github.com/bitcoin/bitcoin/blob/master/src/coins.h#L336-L341. The purpose of this is to clear the memory of the cache.\r\n\r\nPerhaps we could get the bucket count in `Flush` before calling `ReallocateCache` and reserve it in `Flush`, then re-add `ReallocateCache` to `ResizeCoinsCaches`?\r\n\r\nedit: I see that `reserve` only allocates memory for the hashtable, and not the actual nodes stored in the unordered_map. I'm not sure how significant that extra memory is.\r\n\r\nIt is possible that not reallocating in `ConnectTip` is a benefit on its own though. I am doing a benchmark comparing the base, 985ddd954199cb7686ac75d12492d25b16d235c8, and the head of this branch.\r\n",
      "commit_id" : "ceeb71816512642e92a110b2cf5d2549d090fe78",
      "created_at" : "2023-12-16T22:03:37Z",
      "diff_hunk" : "@@ -315,10 +317,15 @@ void CCoinsViewCache::ReallocateCache()\n {\n     // Cache should be empty when we're calling this.\n     assert(cacheCoins.size() == 0);\n+    auto current_bucket_count = cacheCoins.bucket_count();\n     cacheCoins.~CCoinsMap();\n     m_cache_coins_memory_resource.~CCoinsMapMemoryResource();\n     ::new (&m_cache_coins_memory_resource) CCoinsMapMemoryResource{};\n     ::new (&cacheCoins) CCoinsMap{0, SaltedOutpointHasher{/*deterministic=*/m_deterministic}, CCoinsMap::key_equal{}, &m_cache_coins_memory_resource};\n+\n+    // After a flush all the cacheCoins's memory has now been freed. It is likely that the map gets full again so flush is necessary, and it will\n+    // happen around the same memory usage. So we can already reserve the bucket array to the previous size, reducing the number of rehashes needed.\n+    cacheCoins.reserve(current_bucket_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#discussion_r1428946493",
      "id" : 1428946493,
      "line" : 328,
      "node_id" : "PRRC_kwDOABII585VK_49",
      "original_commit_id" : "ceeb71816512642e92a110b2cf5d2549d090fe78",
      "original_line" : 328,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 31,
      "pull_request_review_id" : 1785313140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28945",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428946493/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-16T22:34:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428946493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28945#discussion_r1428961040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428961040"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should this parameter be added to the fuzz targets or unit tests?",
      "commit_id" : "ceeb71816512642e92a110b2cf5d2549d090fe78",
      "created_at" : "2023-12-16T22:43:09Z",
      "diff_hunk" : "@@ -250,14 +250,16 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n     return true;\n }\n \n-bool CCoinsViewCache::Flush() {\n+bool CCoinsViewCache::Flush(bool reallocate_cache) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#discussion_r1428961040",
      "id" : 1428961040,
      "line" : 253,
      "node_id" : "PRRC_kwDOABII585VLDcQ",
      "original_commit_id" : "ceeb71816512642e92a110b2cf5d2549d090fe78",
      "original_line" : 253,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 5,
      "pull_request_review_id" : 1785315882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28945",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428961040/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-16T22:43:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428961040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ran same hyperfine benchmark with base, 985ddd954199cb7686ac75d12492d25b16d235c8, and head of branch. Got similar results :rocket:.\r\n\r\n```\r\nSummary\r\n  ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = ceeb71816512642e92a110b2cf5d2549d090fe78) ran\r\n    1.06 Â± 0.00 times faster than ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = 985ddd954199cb7686ac75d12492d25b16d235c8)\r\n    1.07 Â± 0.00 times faster than ./src/bitcoind -dbcache=500 -reindex-chainstate -printtoconsole=0 -stopatheight=500000 (commit = b5a271334ca81a6adcb1c608d85c83621a9eae47)\r\n```\r\n\r\nIt's unclear to me though why 5e4ac5abf54f8e6d6330df0c73119aa0cca4c103 was necessary at all, and if reverting that change would be a cleaner fix for this instead?\r\nFrom the commit message:\r\n> This is necessary in preparation for using the PoolAllocator for\r\nCCoinsMap, which does not actually free any memory on clear().\r\n\r\nWhy is it necessary to free memory on `clear()`? Is the unfreed memory not just recycled for new coins as they are added? The only purpose of `ReallocateCache` seemed to be to clear all memory when rebalancing caches during assumeutxo syncing, and is unrelated to `Flush`.",
      "created_at" : "2023-12-17T14:03:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28945#issuecomment-1859181762",
      "id" : 1859181762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28945",
      "node_id" : "IC_kwDOABII585u0NzC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859181762/reactions"
      },
      "updated_at" : "2023-12-17T14:03:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859181762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   }
]
