[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ZMQ_HEARTBEAT_* look promising, can you test with those in your test setup?",
      "created_at" : "2018-03-28T19:32:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-377008424",
      "id" : 377008424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "updated_at" : "2018-03-28T19:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377008424",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ZMQ is itself unreliable. I'm not sure this is a Core issue.",
      "created_at" : "2018-03-28T20:00:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-377016849",
      "id" : 377016849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "updated_at" : "2018-03-28T20:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377016849",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@bitkevin Do you have any more info on this problem? Is it caused by a middle box? Does it only happen when running with a particular node topology? Have you tried tuning TCP keepalive, or anything like that, on your host(s) to remedy the problem? Did you try the ZMQ_HEARTBEAT_* options https://github.com/zeromq/libzmq/blob/master/doc/zmq_setsockopt.txt ?\r\n\r\nI tried running a regtest node as a publisher with `./src/qt/bitcoin-qt -regtest -txindex -datadir=/tmp/node1 -zmqpubhashblock=tcp://127.0.0.1:28332 &` and `python3 contrib/zmq/zmq_sub.py` as a subscriber so that I could easily control block generation. Then I watched my loopback interface with WireShark. I generated one block, saw the packets, and then did nothing and did not see any packets go either way around the 30 minute mark with my system config. After 45 minutes of doing nothing and seeing no packet traffic for that TCP port, I generated a block and my subscriber got the message as expected from my Bitcoin node. I am using libzmq v4.2.5, if it matters.\r\n\r\nAre you able to reproduce the issue using the same tools from the bitcoin repo that I used in my test?",
      "created_at" : "2018-07-05T04:26:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-402603088",
      "id" : 402603088,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwMjYwMzA4OA==",
      "updated_at" : "2018-07-05T04:26:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/402603088",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks like they're starting to sort it out in the ZMQ repo:\r\n\r\nhttps://github.com/zeromq/libzmq/commit/0867c380326829dc7e48e12d46b977bffad207c4\r\nhttps://github.com/zeromq/libzmq/commit/79d5ac3deeb944c9fd8a7a7a20a8b973d119fa5e\r\nhttps://github.com/zeromq/libzmq/commit/cdf556610812c172a15c53da063ffd5684c5d995\r\n\r\nWe should probably await a fresh release / sufficient tests, but can begin on the implementation with 4.2.3 (using `zmq_setsockopt` and `ZMQ_HEARTBEAT_IVL`/`TIMEOUT`/`TTL`. I'll take a crack at it this week.\r\n\r\nhttp://api.zeromq.org/4-2:zmq-setsockopt#toc17\r\n\r\nhttps://github.com/zeromq/libzmq/blob/master/tests/test_heartbeats.cpp#L425",
      "created_at" : "2018-08-17T20:42:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-413982780",
      "id" : 413982780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMzk4Mjc4MA==",
      "updated_at" : "2018-08-18T02:52:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/413982780",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/2287825?v=4",
         "events_url" : "https://api.github.com/users/ch4ot1c/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ch4ot1c/followers",
         "following_url" : "https://api.github.com/users/ch4ot1c/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ch4ot1c/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ch4ot1c",
         "id" : 2287825,
         "login" : "ch4ot1c",
         "node_id" : "MDQ6VXNlcjIyODc4MjU=",
         "organizations_url" : "https://api.github.com/users/ch4ot1c/orgs",
         "received_events_url" : "https://api.github.com/users/ch4ot1c/received_events",
         "repos_url" : "https://api.github.com/users/ch4ot1c/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ch4ot1c/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ch4ot1c/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ch4ot1c"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ch4ot1c Are you able to reproduce the issue using the same tools from the bitcoin repo that I used in my test?",
      "created_at" : "2018-08-18T11:36:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-414051841",
      "id" : 414051841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNDA1MTg0MQ==",
      "updated_at" : "2018-08-18T11:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/414051841",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mruddy Just tried it out, got the same results - everything seems to still be connected and appear immediately (block 7 here, after a `generate 1` after 45 minutes, port 28332):\r\n\r\n<img width=\"791\" alt=\"screen shot 2018-08-20 at 1 00 24 pm\" src=\"https://user-images.githubusercontent.com/2287825/44357995-4460e900-a479-11e8-8efe-db8349c71f0f.png\">\r\n\r\nMaybe this is a timeout due to a middle box topology, like you mentioned?",
      "created_at" : "2018-08-20T18:03:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-414408828",
      "id" : 414408828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNDQwODgyOA==",
      "updated_at" : "2018-08-21T01:11:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/414408828",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/2287825?v=4",
         "events_url" : "https://api.github.com/users/ch4ot1c/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ch4ot1c/followers",
         "following_url" : "https://api.github.com/users/ch4ot1c/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ch4ot1c/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ch4ot1c",
         "id" : 2287825,
         "login" : "ch4ot1c",
         "node_id" : "MDQ6VXNlcjIyODc4MjU=",
         "organizations_url" : "https://api.github.com/users/ch4ot1c/orgs",
         "received_events_url" : "https://api.github.com/users/ch4ot1c/received_events",
         "repos_url" : "https://api.github.com/users/ch4ot1c/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ch4ot1c/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ch4ot1c/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ch4ot1c"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ch4ot1c Thanks for confirming what you see!\r\n\r\nI'm convinced that this behavior is caused by middle boxes. The OP could confirm with a little command line inspection using tools like `netstat`, `ss`, and `tcpdump`. He could verify that both sides think the connection is established and that some packets are sent, but not received, when this condition occurs.\r\n\r\nWith the middle box idea in mind, I've reproduced this behavior with a topology spread across multiple hosts with multiple NATs and firewalls in between.\r\n\r\nThe thing is that the ZMQ PUB sockets are not being created with TCP keep-alive enabled (i.e.- SO_KEEPALIVE, or more specifically to libzmq, setting `ZMQ_TCP_KEEPALIVE` to 1 in `CZMQAbstractPublishNotifier::Initialize`) This is easily verified with th the `-o` option to `netstat` or `ss`. I think enabling TCP keep-alive is what we want to do here because we want to keep the connection alive and we are not concerned if the other side is alive (what app level heartbeating is designed to do). Plus, using the TCP keep-alive options means we don't have to bump the min required library version (the heartbeat options are newer, see https://github.com/zeromq/libzmq/releases/tag/v4.2.0).\r\n\r\nSo, one way we can go is to set `ZMQ_TCP_KEEPALIVE` to 1 and then use the operating system provided defaults for keep alive interval and probes to fail before killing the connection. That works for me when the OS settings are set low enough to keep the middle boxes from forgetting the connection. The values must be set before starting the bitcoin process.\r\n\r\nThe other way we could go is to set `ZMQ_TCP_KEEPALIVE` to 1 and then also provide bitcoin command line args to customize the other ZMQ ZMQ_TCP_KEEPALIVE_* socket options (see http://api.zeromq.org/4-2:zmq-setsockopt).\r\n\r\nFor more on the OS keep alive settings see `/proc/sys/net/ipv4/tcp_keepalive_time`, `/proc/sys/net/ipv4/tcp_keepalive_intvl`, and `/proc/sys/net/ipv4/tcp_keepalive_probes` in `man 7 tcp`.\r\n\r\nSo I don't forget, something like this works (added in `src/zmq/zmqpublishnotifier.cpp` before `zmq_bind`):\r\n```\r\n        const int so_keepalive_option = 1;\r\n\r\n        rc = zmq_setsockopt(psocket, ZMQ_TCP_KEEPALIVE, &so_keepalive_option, sizeof(so_keepalive_option));\r\n        if (rc != 0)\r\n        {\r\n            zmqError(\"Failed to set SO_KEEPALIVE\");\r\n            zmq_close(psocket);\r\n            return false;\r\n        }\r\n```",
      "created_at" : "2018-08-25T19:45:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-415992268",
      "id" : 415992268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNTk5MjI2OA==",
      "updated_at" : "2018-08-25T21:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415992268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "After read zmq doc, still have no idea how to use `ZMQ_HEARTBEAT_*`, copy some code snippets, try use `zmq_socket_monitor()`, heartbeat still not work, no timeout event or similar event.\r\n\r\nBut reconnect after no message in a while is very stable.",
      "created_at" : "2018-09-03T14:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-418132977",
      "id" : 418132977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxODEzMjk3Nw==",
      "updated_at" : "2018-09-03T14:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/418132977",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/514951?v=4",
         "events_url" : "https://api.github.com/users/bitkevin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitkevin/followers",
         "following_url" : "https://api.github.com/users/bitkevin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitkevin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitkevin",
         "id" : 514951,
         "login" : "bitkevin",
         "node_id" : "MDQ6VXNlcjUxNDk1MQ==",
         "organizations_url" : "https://api.github.com/users/bitkevin/orgs",
         "received_events_url" : "https://api.github.com/users/bitkevin/received_events",
         "repos_url" : "https://api.github.com/users/bitkevin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitkevin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitkevin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitkevin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`ZMQ_HEARTBEAT_*` is not what you want. i'll make some `ZMQ_TCP_KEEPALIVE` changes available after some of my other zmq stuff gets merged to avoid having to rebase more than necessary.",
      "created_at" : "2018-09-11T22:31:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12754#issuecomment-420448433",
      "id" : 420448433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12754",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDQ0ODQzMw==",
      "updated_at" : "2018-09-11T22:31:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420448433",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   }
]
