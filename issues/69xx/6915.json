{
   "assignee" : null,
   "body" : "@TheBlueMatt This is a rebased version of #6656 (which in turn built off #6595).\r\n\r\nAs previously reported in #6595, there's currently a bug where we don't remove transactions that become invalid after a reorg due to the transaction's locktime.  The solution proposed in #6595 doesn't exhibit great behavior because it doesn't make sense to evict locktime-invalid transactions in the middle of a reorg before the new tip is updated (since typically the block height is the same or greater at the end); @TheBlueMatt addressed this in #6656, which is rebased and included here.\r\n\r\nI have also added a commit that vastly improves the efficiency of `CTxMemPool::removeForReorg()`, by tracking in each mempool entry whether or not the transaction spends a coinbase. Then in `removeForReorg()`, we only access coins for those transactions that spend a coinbase, instead of looking up all inputs for all transactions in the mempool (which is slow and blows up the UTXO cache).\r\n\r\nI compared this code with and without this last commit on some historical data, and observed that this drastically improves runtime of `removeForReorg()` and reduces memory usage in `pcoinsTip`.  Running this code on historical data on a few days in July, I observed 4 reorgs, and the runtime of `removeForReorg()` went from ranging between 167ms - 719ms down to between 5.5ms-16ms; meanwhile `pcoinsTip` memory usage (after the call to `removeForReorg()`) was reduced by between 144MB - 413MB.\r\n\r\nWhen BIP68 support is merged we'll probably want to update this approach, since `IsFinalTx()` will become a more expensive function that needs to look at inputs.",
   "closed_at" : "2015-12-01T12:18:17Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 19,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6915/comments",
   "created_at" : "2015-10-30T01:32:50Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6915/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/6915",
   "id" : 114180188,
   "labels" : [
      {
         "color" : "fef2c0",
         "name" : "Mempool",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6915/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 70,
      "created_at" : "2015-05-01T12:31:35Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.12.0",
      "id" : 1092458,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19/labels",
      "number" : 19,
      "open_issues" : 0,
      "state" : "open",
      "title" : "0.12.0",
      "updated_at" : "2016-02-03T09:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19"
   },
   "number" : 6915,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/6915.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6915",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/6915.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6915"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "[Mempool] Improve removal of invalid transactions after reorgs",
   "updated_at" : "2015-12-01T12:18:17Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6915",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
      "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sdaftuar/followers",
      "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sdaftuar",
      "id" : 7463573,
      "login" : "sdaftuar",
      "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
      "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
      "repos_url" : "https://api.github.com/users/sdaftuar/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sdaftuar"
   }
}
