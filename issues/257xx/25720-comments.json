[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r933304616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/933304616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        assert_equal(count, 1)\r\n```\r\n\r\nBecause of #23119",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-07-29T14:00:25Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_message(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        time.sleep(5)\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        time.sleep(5)\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p\n+                    p.last_message.pop(\"getheaders\", None)\n+                    p.send_message(msg_headers()) # Send empty response\n+\n+        assert count == 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r933304616",
      "id" : 933304616,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII5843oRko",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 81,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 81,
      "pull_request_review_id" : 1055615149,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/933304616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-29T14:00:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/933304616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935709971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935709971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Looks like, either:\r\n\r\n* GUARDED_BY is not needed, as this is only accessed by a single thread (and if another thread is added in the future, it is unclear whether this should use cs_main or a different mutex)\r\n* If it is needed, it might be best to use a mutex different from the validation mutex cs_main to avoid further bundling net_processing with chainstatemanager logic and fields.",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T15:03:22Z",
      "diff_hunk" : "@@ -681,6 +684,9 @@ class PeerManagerImpl final : public PeerManager\n     /** Number of nodes with fSyncStarted. */\n     int nSyncStarted GUARDED_BY(cs_main) = 0;\n \n+    /** Hash of the last block we received via INV */\n+    uint256 m_last_block_inv_triggering_headers_sync GUARDED_BY(cs_main) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935709971",
      "id" : 935709971,
      "line" : 688,
      "node_id" : "PRRC_kwDOABII5843xc0T",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 688,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 1058937454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935709971/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-02T15:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935709971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935722925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935722925"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems a corner case that blocks are announced to us via inv, no? So I am wondering why such a new block is a good signal to add the peer as a initial headers sync peer, as opposed to, let's say, a random timer.",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T15:14:56Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935722925",
      "id" : 935722925,
      "line" : 3280,
      "node_id" : "PRRC_kwDOABII5843xf-t",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3280,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 1058937454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935722925/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-02T15:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935722925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935725314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we assume that the initial headers sync logic is robust, why add the additional complexity here? Wouldn't it be better to just skip the getheaders message? Or if the logic isn't assumed to be robust, lower the timeout or add a new peer on a random timeout?",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T15:17:01Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935725314",
      "id" : 935725314,
      "line" : 3283,
      "node_id" : "PRRC_kwDOABII5843xgkC",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3283,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 1058937454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-02T15:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935725923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            CNodeState& state{*Assert(State(pfrom.GetId()));\r\n```\r\n\r\nnit: Can be written in one line",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T15:17:34Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).\n+            CNodeState *state = State(pfrom.GetId());\n+            assert(state != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935725923",
      "id" : 935725923,
      "line" : 3285,
      "node_id" : "PRRC_kwDOABII5843xgtj",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3285,
      "original_position" : 39,
      "original_start_line" : 3284,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 1058937454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725923/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3284,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-02T15:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935725923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935756421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935756421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "While syncing headers, I found this to actually be the typical case. I think it's because we only use announcement via headers if we know that the peer has the previous header (which is not the case if it's a new peer currently syncing headers) and otherwise revert to INV-mode. [(code)](https://github.com/bitcoin/bitcoin/blob/0043ec4e1310e860150e5789064789377e5a6273/src/net_processing.cpp#L4974-L4978)",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T15:46:14Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935756421",
      "id" : 935756421,
      "in_reply_to_id" : 935722925,
      "line" : 3280,
      "node_id" : "PRRC_kwDOABII5843xoKF",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3280,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 1059005316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935756421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-02T15:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935756421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935793639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935793639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In that case, could make sense to correct the doc, which says \"If a node fell back to sending blocks by inv,\r\n                    // it's probably for a re-org.\"",
      "commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "created_at" : "2022-08-02T16:23:49Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r935793639",
      "id" : 935793639,
      "in_reply_to_id" : 935722925,
      "line" : 3280,
      "node_id" : "PRRC_kwDOABII5843xxPn",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3280,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 1059058573,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935793639/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-02T16:23:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935793639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936663024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936663024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, will drop the mutex.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T13:27:47Z",
      "diff_hunk" : "@@ -681,6 +684,9 @@ class PeerManagerImpl final : public PeerManager\n     /** Number of nodes with fSyncStarted. */\n     int nSyncStarted GUARDED_BY(cs_main) = 0;\n \n+    /** Hash of the last block we received via INV */\n+    uint256 m_last_block_inv_triggering_headers_sync GUARDED_BY(cs_main) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936663024",
      "id" : 936663024,
      "in_reply_to_id" : 935709971,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58431Ffw",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 688,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1060301657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936663024/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T13:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936663024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936665467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936665467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess words like \"probably\" are confusing in comments, as there is context that is missing.  I'll update both comments.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T13:29:57Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936665467",
      "id" : 936665467,
      "in_reply_to_id" : 935722925,
      "line" : 3281,
      "node_id" : "PRRC_kwDOABII58431GF7",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3281,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 1060301657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936665467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T13:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936665467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936687632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T13:48:33Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_message(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        time.sleep(5)\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        time.sleep(5)\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p\n+                    p.last_message.pop(\"getheaders\", None)\n+                    p.send_message(msg_headers()) # Send empty response\n+\n+        assert count == 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936687632",
      "id" : 936687632,
      "in_reply_to_id" : 933304616,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58431LgQ",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 81,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1060301657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687632/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T13:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936687806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T13:48:41Z",
      "diff_hunk" : "@@ -681,6 +684,9 @@ class PeerManagerImpl final : public PeerManager\n     /** Number of nodes with fSyncStarted. */\n     int nSyncStarted GUARDED_BY(cs_main) = 0;\n \n+    /** Hash of the last block we received via INV */\n+    uint256 m_last_block_inv_triggering_headers_sync GUARDED_BY(cs_main) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936687806",
      "id" : 936687806,
      "in_reply_to_id" : 935709971,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58431Li-",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 688,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1060340218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687806/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T13:48:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936687806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936688283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936688283"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Improved the comments and removed the \"probably for a re-org\" language.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T13:49:05Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936688283",
      "id" : 936688283,
      "in_reply_to_id" : 935722925,
      "line" : 3281,
      "node_id" : "PRRC_kwDOABII58431Lqb",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3281,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 1060340906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936688283/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T13:49:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936688283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936707629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure I completely understand what you're asking, but the topic is more complicated than just an assumption around whether the initial headers sync logic is robust:\r\n\r\n- Ideally, we would only download the full headers chain from a single peer when we are starting up, because it saves bandwidth to do so.\r\n- It's possible that the peer we pick for initial headers sync could be (a) slow, (b) on a chain that is not the main chain, (c) adversarial, or some other terrible combination of those factors.  So we cannot just have our logic rely on the initial peer to serve us the honest chain in a reasonable amount of time.\r\n- We currently have two behaviors that help protect us from choosing a bad initial peer.  The main protection we have is that when a block INV is received, we send a getheaders to all peers that announce the block, resulting in us getting the main chain with high probability.  However, this is bandwidth wasting if we have many peers that serve us an INV at the same time, which is probably the common case when we're in a scenario that our initial peer is slow.\r\n- The second protection we have is that after about 20 minutes, we'll evict our initial headers-sync peer if our tip's timestamp isn't within a day of the current time.  This could kick in if we have a bad initial peer and no blocks are found for a while.\r\n\r\nI think we could do a variety of things to improve the current situation on master; I think that adding (say) one additional headers sync peer on some kind of timer (maybe every 5 or 10 minutes) could make sense. I think that choosing a random peer among the set of peers announcing a block is probably better peer selection than choosing a random peer (or random outbound peer) on a timer, just because if a peer sends an INV there's more reason to believe that they are responsive and going to be helpful in getting us the chain, but probably some combination of both would be even better. \r\n\r\nHowever, the complexity I ran into when thinking about other strategies for initial sync has to do with the eviction logic. Right now, I think it's mostly good that we evict our (single) initial headers-sync peer if we can't get a chain tip that is recent within 20 minutes. However, triggering that logic on all our peers at the same time seems over the top to me, because there are edge-case scenarios (such as: no blocks have been found on the network for a day, or the honest chain is some kind of billion-block timewarp chain that takes more than 20 minutes to download) where I think such logic could be badly behaved for the network, because we could end up with no peers or we could fall out of consensus.\r\n\r\nI think what I'm proposing in this patch is a narrow change that exactly addresses the bandwidth problem, and maximizes the chance we find a good peer quickly, without making our behavior in those edge-case scenarios any worse.  Nevertheless, a bigger overhaul of this logic that carefully considers these things could certainly be an improvement and make this whole thing easier to think about.  ",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T14:04:07Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936707629",
      "id" : 936707629,
      "in_reply_to_id" : 935725314,
      "line" : 3284,
      "node_id" : "PRRC_kwDOABII58431QYt",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3284,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 1060369090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T14:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936707819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-03T14:04:16Z",
      "diff_hunk" : "@@ -3265,10 +3271,32 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).\n+            CNodeState *state = State(pfrom.GetId());\n+            assert(state != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r936707819",
      "id" : 936707819,
      "in_reply_to_id" : 935725923,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58431Qbr",
      "original_commit_id" : "4a3376376c774cb95dc633624ad92a2002378178",
      "original_line" : 3285,
      "original_position" : 39,
      "original_start_line" : 3284,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1060369343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707819/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-03T14:04:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/936707819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939514647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939514647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        peer1.wait_for_getheaders()\r\n```\r\nShould work for all the other locations below as well.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-06T10:46:31Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939514647",
      "id" : 939514647,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII5843_9sX",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 43,
      "pull_request_review_id" : 1064295660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939514647/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-06T11:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939514647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939516204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you can just remove this timeout?\r\n\r\n`PeerManagerImpl::SendMessages` is called twice (once after `verack` is received in the initial handshake and once after calling `sync_with_ping` on the next line), so we can be sure that `getheaders` hasn't been sent here because it would have been sent after the `verack` but before the `pong`.\r\n",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-06T11:04:23Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        time.sleep(5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939516204",
      "id" : 939516204,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII5843_-Es",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 55,
      "pull_request_review_id" : 1064295660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516204/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-06T11:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939516794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't need to happen in this PR but in the future this test could also cover our preference for outbound peers for the initial headers sync.",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-06T11:11:10Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939516794",
      "id" : 939516794,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII5843_-N6",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 40,
      "pull_request_review_id" : 1064295660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-06T11:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939516794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939720760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939720760"
         }
      },
      "author_association" : "NONE",
      "body" : "Doesn't really matter but: `1<<256 - 1 == 1 << (256 - 1)`\r\n```suggestion\r\n        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1 << 256) - 1))])\r\n```",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-07T20:51:09Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r939720760",
      "id" : 939720760,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII5844AwA4",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 35,
      "pull_request_review_id" : 1064467269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939720760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-07T20:51:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939720760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32590137?v=4",
         "events_url" : "https://api.github.com/users/jonas-ott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonas-ott/followers",
         "following_url" : "https://api.github.com/users/jonas-ott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonas-ott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonas-ott",
         "id" : 32590137,
         "login" : "jonas-ott",
         "node_id" : "MDQ6VXNlcjMyNTkwMTM3",
         "organizations_url" : "https://api.github.com/users/jonas-ott/orgs",
         "received_events_url" : "https://api.github.com/users/jonas-ott/received_events",
         "repos_url" : "https://api.github.com/users/jonas-ott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonas-ott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonas-ott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonas-ott"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Related: https://github.com/bitcoin/bitcoin/pull/8306",
      "created_at" : "2022-08-10T17:28:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#issuecomment-1211027683",
      "id" : 1211027683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25720",
      "node_id" : "IC_kwDOABII585ILtDj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1211027683/reactions"
      },
      "updated_at" : "2022-08-10T17:28:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1211027683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944145250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944145250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If there are two blocks found at the same time/height, this could still trigger a getheaders to most peers, no? (Someone sends block A, then someone else sends block B, then someone else sends A, etc) Might it be better to set `m_last_extra_headers_sync = SteadyClock::now();` and check that it's been at least a minute before adding an extra one?",
      "commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "created_at" : "2022-08-12T06:17:08Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).\n+            CNodeState& state{*Assert(State(pfrom.GetId()))};\n+            if (state.fSyncStarted || (!peer->m_inv_triggered_getheaders_before_sync && *best_block != m_last_block_inv_triggering_headers_sync)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944145250",
      "id" : 944145250,
      "line" : 3286,
      "node_id" : "PRRC_kwDOABII5844RoNi",
      "original_commit_id" : "fdbbc6ab91519d0af986c3264bc38abf9bc9160e",
      "original_line" : 3286,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 1070638379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944145250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T06:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944145250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944537497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944537497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's true, but I think your suggestion is less robust overall than what I have proposed here: sending an INV to a node is free (there is no proof-of-work attached to a block hash), so an adversary could take advantage of your proposed strategy by continually connecting, sending an INV, and disconnecting, to prevent a node from trying to sync with any of its honest peers that are announcing main-chain blocks.\r\n\r\nOn the other hand, I just checked one of my long-running, well-connected nodes, and it's seen about 10 stale blocks in the last 50000.  So that seems like pretty good odds that a node starting up is unlikely to run into this?",
      "commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "created_at" : "2022-08-12T14:42:55Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,\n+            // as new blocks are found, we are willing to add one new peer per\n+            // block to sync with as well, to sync quicker in the case where\n+            // our initial peer is unresponsive (but less bandwidth than we'd\n+            // use if we turned on sync with all peers).\n+            CNodeState& state{*Assert(State(pfrom.GetId()))};\n+            if (state.fSyncStarted || (!peer->m_inv_triggered_getheaders_before_sync && *best_block != m_last_block_inv_triggering_headers_sync)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944537497",
      "id" : 944537497,
      "in_reply_to_id" : 944145250,
      "line" : 3286,
      "node_id" : "PRRC_kwDOABII5844TH-Z",
      "original_commit_id" : "fdbbc6ab91519d0af986c3264bc38abf9bc9160e",
      "original_line" : 3286,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 1071201493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944537497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T14:42:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944537497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944540982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944540982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! Fixed.",
      "commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "created_at" : "2022-08-12T14:46:26Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944540982",
      "id" : 944540982,
      "in_reply_to_id" : 939514647,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844TI02",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071206362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944540982/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T14:46:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944540982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944541468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good, done.",
      "commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "created_at" : "2022-08-12T14:47:00Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_until(lambda: \"getheaders\" in peer1.last_message, timeout=30)\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        time.sleep(5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944541468",
      "id" : 944541468,
      "in_reply_to_id" : 939516204,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844TI8c",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071207110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541468/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T14:47:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944541830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! Fixed.",
      "commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "created_at" : "2022-08-12T14:47:20Z",
      "diff_hunk" : "@@ -0,0 +1,102 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, 1<<256 - 1))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944541830",
      "id" : 944541830,
      "in_reply_to_id" : 939720760,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844TJCG",
      "original_commit_id" : "17f2822c0da197ce7b96767da94da1cb8af3002b",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071207541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541830/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T14:47:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944541830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944697101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944697101"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Whether we've sent this peer a getheaders in response to an inv prior to initial-headers-sync completing */\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T18:08:45Z",
      "diff_hunk" : "@@ -369,6 +369,9 @@ struct Peer {\n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n     std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n \n+    /** Whether we've sent a peer a getheaders in response to an inv prior to initial-headers-sync completing */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944697101",
      "id" : 944697101,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844Tu8N",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 372,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944697101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944697101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944702783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944702783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            // reliability vs bandwidth tradeoff, where we are only trying to do\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T18:17:23Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944702783",
      "id" : 944702783,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844TwU_",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 3277,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944702783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944702783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944703369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944703369"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            // disconnect the peer and then choose another). In the meantime,\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T18:18:17Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944703369",
      "id" : 944703369,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844TweJ",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 3280,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944703369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944703369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944727838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944727838"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\nis close to caught up), and that each block announcement results in only one\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T18:35:55Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944727838",
      "id" : 944727838,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844T2ce",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 8,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944727838/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944727838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944762330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944762330"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, this would be clearer since there's no reason to build up a list from the return values (there aren't actually any return values)\r\n```suggestion\r\n        for p in peers: p.send_and_ping(new_block_announcement)\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:02:35Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944762330",
      "id" : 944762330,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844T-3a",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944762330/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944762330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944765440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944765440"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randrange(1<<256))])\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:08:00Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944765440",
      "id" : 944765440,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844T_oA",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944765440/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944765440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944767452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        # An empty reply causes the reply handler to not initiate another getheaders\r\n        peer1.send_message(msg_headers())\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:11:12Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944767452",
      "id" : 944767452,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UAHc",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 47,
      "original_position" : 45,
      "original_start_line" : 44,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944767932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        peer1.send_message(msg_headers()) # Send empty response, no follow-on getheaders\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:12:04Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944767932",
      "id" : 944767932,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UAO8",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944767932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944770457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944770457"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, may make the test slightly more readable (and doesn't give the casual reader the impression that there may be more than one node running).\r\n```suggestion\r\n    def run_test(self):\r\n    node = self.nodes[0]\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:16:24Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944770457",
      "id" : 944770457,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII5844UA2Z",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 38,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 38,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944770457/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944770457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944772525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944772525"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        for p in all_peers: p.sync_with_ping()\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:20:06Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944772525",
      "id" : 944772525,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UBWt",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944772525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944772525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944778237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944778237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        for p in [peer2, peer3]:\r\n            p.sync_with_ping()\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:30:16Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944778237",
      "id" : 944778237,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII5844UCv9",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 78,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 78,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944778237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944778237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944782014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944782014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n                    peer_receiving_getheaders = p\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:36:15Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944782014",
      "id" : 944782014,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UDq-",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944782014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944782014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944783783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944783783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        expected_peer.wait_for_getheaders()\r\n        peer_receiving_headers.sync_with_ping()\r\n        with p2p_lock:\r\n            assert \"getheaders\" not in peer_receiving_headers.last_message\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:38:38Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p\n+                    p.last_message.pop(\"getheaders\", None)\n+                    p.send_message(msg_headers()) # Send empty response\n+\n+        assert_equal(count, 1)\n+\n+        self.log.info(\"Announce another new block, from all peers\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+\n+        self.log.info(\"Check that the remaining peer received a getheaders as well\")\n+        expected_peer = peer2\n+        if peer2 == peer_receiving_headers:\n+            expected_peer = peer3\n+\n+        expected_peer.wait_for_getheaders()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944783783",
      "id" : 944783783,
      "line" : 99,
      "node_id" : "PRRC_kwDOABII5844UEGn",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 99,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 99,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944783783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944783783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944789336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944789336"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "lock needed?\r\n```suggestion\r\n        with p2p_lock:\r\n            peer1.last_message.pop(\"getheaders\", None)\r\n```",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T19:45:49Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944789336",
      "id" : 944789336,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UFdY",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071483455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944789336/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944789336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944844643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944844643"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "remove this line to make the linter happy",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T20:48:34Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944844643",
      "id" : 944844643,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844US9j",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071766406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944844643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944844643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944846209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944846209"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if I'm missing something; I believe this `sync_with_ping()` is unnecessary because we use `send_and_ping()` in `announce_random_block()`, does that sound right?",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T20:50:48Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944846209",
      "id" : 944846209,
      "in_reply_to_id" : 944778237,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII5844UTWB",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 78,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 78,
      "pull_request_review_id" : 1071768019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944846209/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944846209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944850656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944850656"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So I intentionally did not include this test (that a peer that we've started sync with doesn't receive a subsequent getheaders in response to an INV) because I felt like that was overspecifying what I think of as reasonable behavior.  I think the most important property is that we add a new peer with each new block, but whether we continue trying to sync with existing peers is (in my view) up for debate.\r\n\r\nFor instance, if the test were rewritten a bit so that the peer receiving the initial getheaders in response to an INV had a big long headers chain to serve the node, then you'd expect there to be a getheaders in flight as headers sync proceeds.  Granted that is not the situation in this test right now, but I feel like it's helpful for future test maintenance to not overspecify behavior if it doesn't really matter for what we're trying to achieve.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T20:56:57Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p\n+                    p.last_message.pop(\"getheaders\", None)\n+                    p.send_message(msg_headers()) # Send empty response\n+\n+        assert_equal(count, 1)\n+\n+        self.log.info(\"Announce another new block, from all peers\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+\n+        self.log.info(\"Check that the remaining peer received a getheaders as well\")\n+        expected_peer = peer2\n+        if peer2 == peer_receiving_headers:\n+            expected_peer = peer3\n+\n+        expected_peer.wait_for_getheaders()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944850656",
      "id" : 944850656,
      "in_reply_to_id" : 944783783,
      "line" : 99,
      "node_id" : "PRRC_kwDOABII5844UUbg",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 99,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 99,
      "pull_request_review_id" : 1071772229,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944850656/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T20:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944850656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:06:47Z",
      "diff_hunk" : "@@ -369,6 +369,9 @@ struct Peer {\n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n     std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n \n+    /** Whether we've sent a peer a getheaders in response to an inv prior to initial-headers-sync completing */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857336",
      "id" : 944857336,
      "in_reply_to_id" : 944697101,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWD4",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 372,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071778805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857336/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:06:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:07:00Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857486",
      "id" : 944857486,
      "in_reply_to_id" : 944702783,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWGO",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 3277,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071778954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857736"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, fixed.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:07:22Z",
      "diff_hunk" : "@@ -3265,10 +3272,30 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (best_block != nullptr) {\n-            if (MaybeSendGetHeaders(pfrom, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), *peer)) {\n-                LogPrint(BCLog::NET, \"getheaders (%d) %s to peer=%d\\n\",\n-                        m_chainman.m_best_header->nHeight, best_block->ToString(),\n-                        pfrom.GetId());\n+            // If we haven't started initial headers-sync with this peer, then\n+            // consider sending a getheaders now. On initial startup, there's a\n+            // reliability vs bandwidth tradeoff, where we only trying doing\n+            // initial headers sync with one peer at a time, with a long\n+            // timeout (at which point, if the sync hasn't completed, we will\n+            // disconnect the peer and then choose another).  In the meantime,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944857736",
      "id" : 944857736,
      "in_reply_to_id" : 944703369,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWKI",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 3280,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1071779196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857736/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944857736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:08:01Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858177",
      "id" : 944858177,
      "in_reply_to_id" : 944727838,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWRB",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 8,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071779607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:08:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:08:17Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858389",
      "id" : 944858389,
      "in_reply_to_id" : 944765440,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWUV",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071779799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858389/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:08:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:08:26Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858482",
      "id" : 944858482,
      "in_reply_to_id" : 944762330,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWVy",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071779887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858482/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:08:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this as-is; I think the `self.num_nodes = 1` in `set_test_params` makes it clear that only one node is involved.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:09:07Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944858934",
      "id" : 944858934,
      "in_reply_to_id" : 944770457,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII5844UWc2",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 38,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 38,
      "pull_request_review_id" : 1071780276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944858934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I improved this comment in the latest commit.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:09:17Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859042",
      "id" : 944859042,
      "in_reply_to_id" : 944767452,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWei",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 47,
      "original_position" : 45,
      "original_start_line" : 44,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071780364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-12T21:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:09:22Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859093",
      "id" : 944859093,
      "in_reply_to_id" : 944772525,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWfV",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071780424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:09:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, thanks!  Fixed.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:09:38Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859268",
      "id" : 944859268,
      "in_reply_to_id" : 944789336,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWiE",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071780597,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859268/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:09:46Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:\n+            with p2p_lock:\n+                if \"getheaders\" in p.last_message:\n+                    count += 1\n+                    peer_receiving_headers = p",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859352",
      "id" : 944859352,
      "in_reply_to_id" : 944782014,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWjY",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071780685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:09:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:10:10Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944859614",
      "id" : 944859614,
      "in_reply_to_id" : 944844643,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWne",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071780945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:10:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944859614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944860218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944860218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I updated this comment as well (to reference the longer explanation above).",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:11:03Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944860218",
      "id" : 944860218,
      "in_reply_to_id" : 944767932,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UWw6",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071781487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944860218/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:11:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944860218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944862204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944862204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, turns out the linter doesn't like this, so this is now split into two lines.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-12T21:13:53Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944862204",
      "id" : 944862204,
      "in_reply_to_id" : 944772525,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844UXP8",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : null,
      "pull_request_review_id" : 1071783266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944862204/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T21:13:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944862204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944981265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944981265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right, ignore my suggestion.",
      "commit_id" : "f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-13T00:49:27Z",
      "diff_hunk" : "@@ -0,0 +1,101 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test initial headers download\n+\n+Test that we only try to initially sync headers from one peer (until our chain\n+is close to caught up), and that block announcements result in only one\n+additional peer receiving a getheaders message.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    CInv,\n+    MSG_BLOCK,\n+    msg_headers,\n+    msg_inv,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PInterface,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+import random\n+\n+class HeadersSyncTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def announce_random_block(self, peers):\n+        new_block_announcement = msg_inv(inv=[CInv(MSG_BLOCK, random.randint(0, (1<<256) - 1))])\n+        [ p.send_and_ping(new_block_announcement) for p in peers ]\n+\n+    def run_test(self):\n+        self.log.info(\"Adding a peer to node0\")\n+        peer1 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Wait for peer1 to receive a getheaders\n+        peer1.wait_for_getheaders()\n+        # Give an empty reply\n+        peer1.send_message(msg_headers())\n+\n+        self.log.info(\"Connecting two more peers to node0\")\n+        # Connect 2 more peers; they should not receive a getheaders yet\n+        peer2 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        peer3 = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        all_peers = [peer1, peer2, peer3]\n+\n+        self.log.info(\"Verify that peer2 and peer3 don't receive a getheaders after connecting\")\n+        [ p.sync_with_ping() for p in all_peers ]\n+        with p2p_lock:\n+            assert \"getheaders\" not in peer2.last_message\n+            assert \"getheaders\" not in peer3.last_message\n+\n+        with p2p_lock:\n+            peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Have all peers announce a new block\")\n+        self.announce_random_block(all_peers)\n+\n+        self.log.info(\"Check that peer1 receives a getheaders in response\")\n+        peer1.wait_for_getheaders()\n+        peer1.send_message(msg_headers()) # Send empty response\n+        peer1.last_message.pop(\"getheaders\", None)\n+\n+        self.log.info(\"Check that exactly 1 of {peer2, peer3} received a getheaders in response\")\n+        count = 0\n+        peer_receiving_headers = None\n+        for p in [peer2, peer3]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#discussion_r944981265",
      "id" : 944981265,
      "in_reply_to_id" : 944778237,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII5844U0UR",
      "original_commit_id" : "61931d7535e526b8ae654eedf84062ff194fb5e6",
      "original_line" : 78,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_initial_headers_sync.py",
      "position" : 78,
      "pull_request_review_id" : 1071867836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944981265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-13T00:49:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944981265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK f6a916683d75ed5489666dbfbd711f000ad0707f",
      "created_at" : "2022-08-13T00:59:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25720#issuecomment-1213619530",
      "id" : 1213619530,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25720",
      "node_id" : "IC_kwDOABII585IVl1K",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1213619530/reactions"
      },
      "updated_at" : "2022-08-13T00:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1213619530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   }
]
