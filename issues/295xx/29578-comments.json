[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29578).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/29578#pullrequestreview-1930628143) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-03-06T13:44:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#issuecomment-1980909481",
      "id" : 1980909481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29578",
      "node_id" : "IC_kwDOABII5852Ekep",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1980909481/reactions"
      },
      "updated_at" : "2024-03-12T10:41:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1980909481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I was able to reproduce the diff, but please rebase the changes so that the benchmark is before the change so that we can easily check before/after.\r\n\r\nRunning it locally:\r\n> make && ./src/bench/bench_bitcoin --filter=AddrManGetAddrByNetwork --min-time=1000\r\n\r\nBefore:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          819,423.49 |            1,220.37 |    0.3% |      1.07 | `AddrManGetAddrByNetwork`\r\n```\r\n\r\nafter:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          418,538.38 |            2,389.27 |    1.7% |      1.08 | `AddrManGetAddrByNetwork`\r\n```",
      "created_at" : "2024-03-08T23:01:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#issuecomment-1986542020",
      "id" : 1986542020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29578",
      "node_id" : "IC_kwDOABII5852aDnE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986542020/reactions"
      },
      "updated_at" : "2024-03-08T23:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986542020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29578#discussion_r1518398774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29578"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518398774"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: To make it clear that we're overwriting the same value:\r\n```suggestion\r\n    size_t nNodes;\r\n    if (network) {\r\n        auto it = m_network_counts.find(*network);\r\n        if (it == m_network_counts.end()) return {};\r\n        nNodes = it->second.n_new + it->second.n_tried;\r\n    } else {\r\n        nNodes = vRandom.size();\r\n    }\r\n```",
      "commit_id" : "98cc6ac935c7ba322b7b464f32666f805b99f9b3",
      "created_at" : "2024-03-08T23:06:52Z",
      "diff_hunk" : "@@ -805,11 +805,17 @@ int AddrManImpl::GetEntry(bool use_tried, size_t bucket, size_t position) const\n     return -1;\n }\n \n-std::vector<CAddress> AddrManImpl::GetAddr_(size_t max_addresses, size_t max_pct, std::optional<Network> network, const bool filtered) const\n+std::vector<CAddress> AddrManImpl::GetAddr_(size_t max_addresses, size_t max_pct, const std::optional<Network>& network, const bool filtered) const\n {\n     AssertLockHeld(cs);\n \n     size_t nNodes = vRandom.size();\n+    if (network) {\n+        auto it = m_network_counts.find(*network);\n+        if (it == m_network_counts.end()) return {};\n+        const auto counts{it->second};\n+        nNodes = counts.n_new + counts.n_tried;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#discussion_r1518398774",
      "id" : 1518398774,
      "line" : 818,
      "node_id" : "PRRC_kwDOABII585agO02",
      "original_commit_id" : "98cc6ac935c7ba322b7b464f32666f805b99f9b3",
      "original_line" : 818,
      "original_position" : 15,
      "original_start_line" : 812,
      "path" : "src/addrman.cpp",
      "position" : 15,
      "pull_request_review_id" : 1925991084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29578",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518398774/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 812,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-03-08T23:06:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518398774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29578#discussion_r1518579667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29578"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518579667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll leave it as is for now. ",
      "commit_id" : "1319958b45455a18800cb83d483448a3021b2aba",
      "created_at" : "2024-03-09T14:16:53Z",
      "diff_hunk" : "@@ -805,11 +805,17 @@ int AddrManImpl::GetEntry(bool use_tried, size_t bucket, size_t position) const\n     return -1;\n }\n \n-std::vector<CAddress> AddrManImpl::GetAddr_(size_t max_addresses, size_t max_pct, std::optional<Network> network, const bool filtered) const\n+std::vector<CAddress> AddrManImpl::GetAddr_(size_t max_addresses, size_t max_pct, const std::optional<Network>& network, const bool filtered) const\n {\n     AssertLockHeld(cs);\n \n     size_t nNodes = vRandom.size();\n+    if (network) {\n+        auto it = m_network_counts.find(*network);\n+        if (it == m_network_counts.end()) return {};\n+        const auto counts{it->second};\n+        nNodes = counts.n_new + counts.n_tried;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#discussion_r1518579667",
      "id" : 1518579667,
      "in_reply_to_id" : 1518398774,
      "line" : 818,
      "node_id" : "PRRC_kwDOABII585ag6_T",
      "original_commit_id" : "98cc6ac935c7ba322b7b464f32666f805b99f9b3",
      "original_line" : 818,
      "original_position" : 15,
      "original_start_line" : 812,
      "path" : "src/addrman.cpp",
      "position" : 15,
      "pull_request_review_id" : 1926200187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29578",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518579667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 812,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-03-09T14:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1518579667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I was able to reproduce the diff, but please rebase the changes so that the benchmark is before the change so that we can easily check before/after.\r\n\r\nNice idea, force-pushed changing the order of the commits.",
      "created_at" : "2024-03-09T14:17:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#issuecomment-1986869103",
      "id" : 1986869103,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29578",
      "node_id" : "IC_kwDOABII5852bTdv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986869103/reactions"
      },
      "updated_at" : "2024-03-09T14:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986869103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Changing the argument from std::optional<Network> to const std::optional<Network>& seems unnecessary because it is very cheap to copy that, it is 8 bytes. I would drop commit https://github.com/bitcoin/bitcoin/commit/1319958b45455a18800cb83d483448a3021b2aba addrman: net: use const ref for network in GetAddresses/GetAddr\r\n\r\nDone. Thanks, @vasild.",
      "created_at" : "2024-03-12T10:41:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29578#issuecomment-1991336393",
      "id" : 1991336393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29578",
      "node_id" : "IC_kwDOABII5852sWHJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991336393/reactions"
      },
      "updated_at" : "2024-03-12T10:41:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991336393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
