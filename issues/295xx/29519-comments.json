[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29519).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1991970602) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-02-29T21:44:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1972013849",
      "id" : 1972013849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5851iosZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1972013849/reactions"
      },
      "updated_at" : "2024-03-12T15:45:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1972013849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Note that given that 27 will not ship with mainnet assumeutxo, this isn't a blocker, and a fix can still be backported to 27.x if deemed necessary.",
      "created_at" : "2024-03-05T16:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1979145599",
      "id" : 1979145599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5851911_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1979145599/reactions"
      },
      "updated_at" : "2024-03-05T16:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1979145599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nac547ea43beb1d66d2c11e7e8abb76dd1bfc2883 looks reasonable, but it would be nice to somehow add a test for it.\r\n\r\nWhat happens once we've reached the tip and need more peers for background sync? And once background sync is done, is it updated to the tip again?\r\n\r\nWould it make sense to introduce `pindexLastCommonBackgroundSyncBlock` so we have more control over what peers to dedicate to the tip vs background (which might take weeks on some devices)?",
      "created_at" : "2024-03-11T15:21:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1988700471",
      "id" : 1988700471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852iSk3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988700471/reactions"
      },
      "updated_at" : "2024-03-11T15:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988700471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> [ac547ea](https://github.com/bitcoin/bitcoin/commit/ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883) looks reasonable, but it would be nice to somehow add a test for it.\r\n\r\nI tested this syncing on signet, but I'll think about a functional test; I imagine that it would be hard to prevent race conditions in a functional test because we'd:\r\n* need to first connect to a peer that has the entire chain and start syncing the background chain\r\n* then load the snapshot (at the same time the peer would continue syncing the background chain)\r\n* then check that we switch to requesting from the snapshot chain (while the bg chain hopefully hasn't finished downloading yet)\r\n\r\nIt might be possible though if that peer was a `P2PConnection()` (that could stall / withhold certain blocks) instead of a real node.\r\n\r\n> What happens once we've reached the tip and need more peers for background sync? And once background sync is done, is it updated to the tip again?\r\n> \r\n> Would it make sense to introduce `pindexLastCommonBackgroundSyncBlock` so we have more control over what peers to dedicate to the tip vs background (which might take weeks on some devices)?\r\n\r\nWe have [this logic](https://github.com/bitcoin/bitcoin/blob/a945f09fa6e0f94cc424da9e06516f9cfa192545/src/net_processing.cpp#L5991-L6000) in `SendMessages`: It first tries `FindNextBlocksToDownload` meant for the active chainstate, and, if it doesn't fill up the `vToDownload` buffer (e.g. because we are at / near the tip), then calls `TryDownloadingHistoricalBlocks` specifically for the background chainstate. I think that this existing separation should work well, the problem that this PR fixes is that `FindNextBlocksToDownload` would pick historical blocks from the background chain when it shouldn't because higher-prio blocks are available.",
      "created_at" : "2024-03-11T20:30:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1989387189",
      "id" : 1989387189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852k6O1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989387189/reactions"
      },
      "updated_at" : "2024-03-11T20:31:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989387189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I can see how it would be difficult to test, indeed.\r\n\r\nI encountered this scenario while testing #29370 on signet. All my peers were only downloading the background state. I only got headers for the tip chain, but it didn't progress. The workaround there was to turn the network off and on, which is consistent with your observation that only existing peers are affected.\r\n\r\nutACK ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-03-12T15:45:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1991970602",
      "id" : 1991970602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852uw8q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991970602/reactions"
      },
      "updated_at" : "2024-03-12T15:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991970602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The code and reasoning look good to me and I have been trying to write a test but I am currently unable to reproduce the behavior described before the change, i.e. to make the test fail on master.\r\n\r\nHere is the test so far: https://github.com/fjahr/bitcoin/commit/478fb28dac4e22175da150cee97991a66b4f5695\r\n\r\nThis now does fail on master but only because it also checks for the debug log `HERE` I have added. This log confirms that the test does trigger the behavior change, i.e. on master the last common block is set once, after the change here it is set twice within `FindNextBlockToDownload`. But, of course, we would rather like to have the test fail at the asserts at the end but that is not the case so far.\r\n\r\n@mzumsande do you have an idea why this doesn't reproduce the behavior you have seen on master?",
      "created_at" : "2024-03-25T17:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2018586575",
      "id" : 2018586575,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5854US_P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2018586575/reactions"
      },
      "updated_at" : "2024-03-25T17:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2018586575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
