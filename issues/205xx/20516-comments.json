[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20560 (fuzz: Link all targets once by MarcoFalke)\n* #20509 (net: CAddress deser: use stream's version, not what's coming from disk by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-11-27T02:24:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734548674",
      "id" : 734548674,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDU0ODY3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T14:43:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734548674",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I merged the anchors.dat addrv2 support from #20514 into this PR, as doing it correctly requires changes the `Cservice` serialization from stream version based to stored version based.",
      "created_at" : "2020-11-27T19:17:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734958654",
      "id" : 734958654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDk1ODY1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-27T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734958654",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nFrom the PR description and quick code reading it follows that there is no hurry to backport these changes into 0.21, right?",
      "created_at" : "2020-11-27T19:49:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734965909",
      "id" : 734965909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDk2NTkwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-27T19:49:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734965909",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Indeed, there is probably no hurry, unless we want to support torv3 anchors in 0.21.",
      "created_at" : "2020-11-27T19:50:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734966179",
      "id" : 734966179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDk2NjE3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-27T19:50:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734966179",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532026970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532026970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "501de309e682f2edddb7e51e55665e034e1a86be, while this line is touched, it seems natural to inherit the stream type as well:\r\n\r\n```suggestion\r\n        CHashWriter hasher(stream.GetType(), stream.GetVersion());\r\n```\r\n\r\nAnd `CHashVerifier` uses type of stream.",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-11-28T11:03:35Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ bool SerializeDB(Stream& stream, const Data& data)\n {\n     // Write and commit header, data\n     try {\n-        CHashWriter hasher(SER_DISK, CLIENT_VERSION);\n+        CHashWriter hasher(SER_DISK, stream.GetVersion());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532026970",
      "id" : 532026970,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAyNjk3MA==",
      "original_commit_id" : "04e3733b8dc073562e30a12f955a0430793cfe25",
      "original_line" : 26,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 540368109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-30T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532026970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532053363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532053363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6d16903c4c384bc15f3f29e5635bb9dccd789cb6\r\n```suggestion\r\n    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\r\n```",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-11-28T15:43:53Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532053363",
      "id" : 532053363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1MzM2Mw==",
      "original_commit_id" : "04e3733b8dc073562e30a12f955a0430793cfe25",
      "original_line" : 386,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 540383063,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-30T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532053363",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe present `DISK_VERSION_ADDRV2` as a bit flag explicitly, i.e.\r\n```suggestion\r\n    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\r\n```\r\n?",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-11-28T16:21:41Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057230",
      "id" : 532057230,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NzIzMA==",
      "original_commit_id" : "04e3733b8dc073562e30a12f955a0430793cfe25",
      "original_line" : 384,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 540385340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-30T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057230",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When a new bit flag for disk serialization will be introduced in the future, a downgraded (after upgrading) node will throw an exception during deserialization. Maybe:\r\n```suggestion\r\n            } else if (stored_format_version & DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\r\n```\r\n?",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-11-28T16:27:28Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057860",
      "id" : 532057860,
      "line" : 408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1Nzg2MA==",
      "original_commit_id" : "04e3733b8dc073562e30a12f955a0430793cfe25",
      "original_line" : 408,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 61,
      "pull_request_review_id" : 540385340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-30T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057860",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532091123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532091123"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, that would break the ability to add other formats in a compatible way.\r\n\r\nIt's supposed to throw an exception if it can't be read.",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-11-28T18:23:55Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532091123",
      "id" : 532091123,
      "in_reply_to_id" : 532057860,
      "line" : 408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MTEyMw==",
      "original_commit_id" : "04e3733b8dc073562e30a12f955a0430793cfe25",
      "original_line" : 408,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 61,
      "pull_request_review_id" : 540408979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-30T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532091123",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed comments.",
      "created_at" : "2020-11-30T21:41:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-736073151",
      "id" : 736073151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjA3MzE1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-30T21:41:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736073151",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-15T18:40:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-745485657",
      "id" : 745485657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NTQ4NTY1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-15T18:40:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745485657",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902150"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2 deserialization is permitted,\r\n```",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T15:17:33Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902150",
      "id" : 545902150,
      "line" : 376,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMjE1MA==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 376,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 23,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902150",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902418"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     *  For network serialization ADDRV2_FORMAT in the stream version determines the actual format used (as it has no\r\n```",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T15:17:58Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902418",
      "id" : 545902418,
      "line" : 378,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMjQxOA==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 378,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 25,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902418",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545917692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545917692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nowadays\r\n\r\n```cpp\r\n(1 << 19) - 1\r\n```\r\n\r\ncan be written as\r\n\r\n```cpp\r\n0b00000000'00000111'11111111'11111111\r\n```\r\n\r\n(feel free to ignore)",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T15:42:11Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545917692",
      "id" : 545917692,
      "line" : 382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkxNzY5Mg==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 382,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 29,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545917692",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545922062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545922062"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it is ok to assign `ADDRV2_FORMAT` here and remove the last `static_assert` below.",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T15:49:09Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545922062",
      "id" : 545922062,
      "line" : 384,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMjA2Mg==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 384,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 31,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545922062",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545924591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545924591"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shouldn't this be 18 bytes, instead of 19? `CLIENT_VERSION` of `219900` is 18 bytes (`0b11'01011010'11111100`).",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T15:53:15Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545924591",
      "id" : 545924591,
      "line" : 382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyNDU5MQ==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 382,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 29,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545924591",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545938774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545938774"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The repeated code can be moved after the `if`:\r\n\r\n```suggestion\r\n        } else {\r\n            READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\r\n        }\r\n        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\r\n        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\r\n```",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T16:16:59Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545938774",
      "id" : 545938774,
      "line" : 442,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzODc3NA==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 442,
      "original_position" : 97,
      "original_start_line" : 434,
      "path" : "src/protocol.h",
      "position" : 97,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : 434,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545938774",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545942030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545942030"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Here and below in deserialize, why add `CLIENT_VERSION` when it is going to be ignored during ser/deser (they only check `s.GetVersion() & ADDRV2_FORMAT`)?",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T16:22:41Z",
      "diff_hunk" : "@@ -161,13 +161,13 @@ bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n void DumpAnchors(const fs::path& anchors_db_path, const std::vector<CAddress>& anchors)\n {\n     LOG_TIME_SECONDS(strprintf(\"Flush %d outbound block-relay-only peer addresses to anchors.dat\", anchors.size()));\n-    SerializeFileDB(\"anchors\", anchors_db_path, anchors);\n+    SerializeFileDB(\"anchors\", anchors_db_path, anchors, CLIENT_VERSION | ADDRV2_FORMAT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545942030",
      "id" : 545942030,
      "line" : 164,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0MjAzMA==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 164,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 76,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545942030",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545944869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545944869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe this comment warrants an update, since we do not allow anything other than disk and network now.\r\n\r\nAlso, it is \"network only if s.GetVersion() != INIT_PROTO_VERSION\".",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T16:27:27Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }\n-        READWRITEAS(CService, obj);\n     }\n \n     // disk and network only\n     uint32_t nTime{TIME_INIT};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545944869",
      "id" : 545944869,
      "line" : 446,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NDg2OQ==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 446,
      "original_position" : 102,
      "original_start_line" : 445,
      "path" : "src/protocol.h",
      "position" : 102,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : 445,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545944869",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545958131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545958131"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe also mention what happens during disk serialization and network deserialization:\r\n\r\nFor disk serialization, ADDRV2_FORMAT in the stream version indicates a write in that format\r\nFor network deserialization ADDRV2_FORMAT in the stream version indicates that the data is expected to be in that format",
      "commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "created_at" : "2020-12-18T16:49:44Z",
      "diff_hunk" : "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545958131",
      "id" : 545958131,
      "line" : 380,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk1ODEzMQ==",
      "original_commit_id" : "80f5c544202c35a936bc04ee45e092b4325e637d",
      "original_line" : 380,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 27,
      "pull_request_review_id" : 555578477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T16:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545958131",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
