[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16278](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16278.html) (tests: Reduce compile-time memory usage, compilation time and unneccessary recompiles by removing unused includes in tests by practicalswift)\n* [#16273](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16273.html) (refactor: Reduce compile-time memory usage by 2%, compilation time by 2% and avoid unnecessary recompiles by removing unused includes by practicalswift)\n* [#16115](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16115.html) (On bitcoind startup, write config args to debug.log by LarryRuane)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-05-31T05:21:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497579493",
      "id" : 497579493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzU3OTQ5Mw==",
      "updated_at" : "2019-06-27T10:09:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497579493",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Strong concept ACK: thanks for fixing this!",
      "created_at" : "2019-05-31T06:59:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497599196",
      "id" : 497599196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzU5OTE5Ng==",
      "updated_at" : "2019-05-31T06:59:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497599196",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In a few cases we need to use `std::mutex` rather than the sync.h primitives.\r\n\r\nCan you explain why?",
      "created_at" : "2019-05-31T07:07:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497601104",
      "id" : 497601104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzYwMTEwNA==",
      "updated_at" : "2019-05-31T07:07:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497601104",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag Our \"default\" mutexes are recursive mutexes (which you can enter multiple times from the same thread). They're easier to work with as you don't need to worry about whether to call a lock-grabbing function from either inside or outside the lock. However, recursive mutexes can't be used for condition variable waiting, so for those, we use std::mutex (which is not recursive) directly.\n\nLonger term we should try to get rid of recursive mutexes entirely; code is much cleaner without them.",
      "created_at" : "2019-05-31T10:31:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497661895",
      "id" : 497661895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzY2MTg5NQ==",
      "updated_at" : "2019-05-31T10:31:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497661895",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "How is this different from using `Mutex` and `Lock`?\r\n\r\nE.g.\r\n\r\n```cpp\r\nMutex m;\r\nLOCK(m);",
      "created_at" : "2019-05-31T14:42:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497733944",
      "id" : 497733944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzczMzk0NA==",
      "updated_at" : "2019-05-31T14:42:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497733944",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa thanks, I was aware of that. I wasn't sure _why_ \"In a few cases we need to use `std::mutex`\".",
      "created_at" : "2019-06-02T19:36:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-498059158",
      "id" : 498059158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5ODA1OTE1OA==",
      "updated_at" : "2019-06-02T19:36:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/498059158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How is this different from using `Mutex` and `Lock`?\r\n\r\nIf you do `Mutex cs;` instead of `std::mutex cs;` then you can do `LOCK(cs);` or `WAIT_LOCK(cs, g);` instead of `MutexGuard g(cs);`. In that case the type of `g` changes from a trivial subclass of `std::lock_guard` to `UniqueLock` which is a subclass of `std::unique_lock` that supports `DEBUG_LOCKCONTENTION` in which case it uses `LogPrintf` to report potential deadlocks or lock contention. Even without the extra features we have, `std::unique_lock` is potentially higher overhead than `std::lock_guard`, but `std::lock_guard` isn't unlockable except on destruction, so `unique_lock` is needed for use with condition variables.\r\n\r\n * We can't use `Mutex` for locking for the logging API, because that is a circular dependency.\r\n * We use `std::mutex` in code that implements our specialised locking behaviour got `Mutex` etc.\r\n * We don't use `Mutex` in `support/lockedpool.h`, probably because at present it is independent of bitcoin interfaces in general (this PR adds a dependency on threadsafety.h, so maybe just using `Mutex` would make sense at that point).\r\n * We use `std::mutex` instead of `Mutex` for protecting `dir_locks` in `util/system.h`, not sure if there's a circular dependency there to justify it though?\r\n * We also use `std::mutex` in some unit tests, which I don't think matters much.\r\n\r\nThere's some cases where we currently use `std::lock_guard<std::mutex> g(cs)` where `cs` is a `Mutex`, rather than calling `LOCK(cs);` or `WAIT_LOCK(cs, g);` That saves a bit of overhead, while losing our contention/deadlock debugging info, which I'm not sure makes much sense. I've updated this PR to change those instances to just use `LOCK(cs)` instead of `lock_guard`.\r\n\r\nI think that means it makes sense to:\r\n\r\n * Use `Mutex` and `LOCK` etc as the \"normal\" locking mechanism.\r\n * Use `RecursiveMutex` (aka `CCriticalSection`) if recursive locks are needed, or it's old code that we haven't worked through yet.\r\n * Use `std::mutex` and `{ MutexGuard guard(mutex); ... }` for code that's used to implement `Mutex`\r\n\r\nI've bumped this PR to replace a couple of the `lock_guard` instances that referred to our Mutex/CCriticalSection classes with `LOCK` instead of `MutexGuard`.",
      "created_at" : "2019-06-03T01:22:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-498083950",
      "id" : 498083950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5ODA4Mzk1MA==",
      "updated_at" : "2019-06-03T01:22:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/498083950",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> We can't use Mutex for locking for the logging API, because that is a circular dependency.\r\n\r\nI don't think this is true (that we can't allow a circular dependency), but maybe you can explain more. I think ideally, we would just use `Mutex` and `RecursiveMutex` everywhere, since they fully support LOCK macros, lock assertions, lock annotations, deadlock detection, and so on. What exactly is the need for std::mutex and MutexGuard?\r\n",
      "created_at" : "2019-06-05T12:48:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-499068336",
      "id" : 499068336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTA2ODMzNg==",
      "updated_at" : "2019-06-05T13:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499068336",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > We can't use Mutex for locking for the logging API, because that is a circular dependency.\r\n> \r\n> I don't think this is true (that we can't allow a circular dependency), but maybe you can explain more. \r\n\r\nMaybe; `LOCK(m);` becomes a call to `UniqueLock` contstructor, which calls `Enter()` (or `TryEnter()`), which calls `EnterCritical()`, which calls `push_lock()` which may call `potential_deadlock_detected()` which then calls `LogPrintf`, which calls `LogPrintStr` which, when logging to a file, will then lock `m_file_mutex`. But I don't think that actually causes a problem, because I don't think any lock is ever taken while the m_file_mutex is held, so that shouldn't trigger potential_deadlock_detected.\r\n\r\nThere's also the case if you compile with `-DDEBUG_LOCKCONTENTION`. If two processes try to log simultaneously, the first one will lock `m_file_mutex` successfully, while the second one will fail at the `try_lock` phase of `UniqueLock::Enter`, which will then call `PrintLockContention` and hence `LogPrintf`, and recursively fail for the same reason until `m_file_mutex` is released, at which point things should clean up.\r\n\r\n> I think ideally, we would just use `Mutex` and `RecursiveMutex` everywhere, since they fully support LOCK macros, lock assertions, lock annotations, deadlock detection, and so on. What exactly is the need for std::mutex and MutexGuard?\r\n\r\nIf we can switch all the uses of std::mutex to Mutex, I don't think there's a need for MutexGuard.",
      "created_at" : "2019-06-05T13:54:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-499092691",
      "id" : 499092691,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTA5MjY5MQ==",
      "updated_at" : "2019-06-05T13:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499092691",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
