[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [josibake](https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1331900188), [Xekyo](https://github.com/bitcoin/bitcoin/pull/26560#pullrequestreview-1199933874), [S3RK](https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1332724607) |\n| Concept ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1334090387), [glozow](https://github.com/bitcoin/bitcoin/pull/26560#pullrequestreview-1201406725) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26573](https://github.com/bitcoin/bitcoin/pull/26573) (Wallet: don't underestimate the fees when spending a Taproot output by darosior)\n* [#26567](https://github.com/bitcoin/bitcoin/pull/26567) (Wallet: estimate the size of signed inputs using descriptors by darosior)\n* [#25729](https://github.com/bitcoin/bitcoin/pull/25729) (wallet: Check max transaction weight in CoinSelection by aureleoules)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-11-23T15:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1325231872",
      "id" : 1325231872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585O_W8A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325231872/reactions"
      },
      "updated_at" : "2022-12-01T17:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325231872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030669464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7f6abb39159cd55b6c9193630ca4c3d9ae551be6 \"wallet: bugfix, 'CoinsResult::Erase' is erasing only one output of the set\"\r\n\r\nHow come we need to have `coins_to_remove` and erase the removed coins from it? `coins_to_remove` isn't being used anywhere else so this doesn't seem to be doing anything?",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T16:39:27Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030669464",
      "id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849bsSY",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1191984507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T16:39:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030884532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's to decrease the search time while moving across the `CoinsResult` vectors.\r\n\r\n`Erase` receives a const set with all the coins that needs to be removed from the `CoinsResult` internal vectors. So, what we do is loop across each coins vector and, for each coin inside them, **we test whether the coin is inside the set of coins provided by the caller**, if it's there, then we update the internal state and return true so `std:.remove_if` does its magic.\r\n(bolded the important part)\r\n\r\nSo, if we remove coins as we find them on the `CoinsResult` vectors from the to_remove set, we will continually search inside a container with less elements up until there is none and we can stop the search earlier.",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T21:30:33Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030884532",
      "id" : 1030884532,
      "in_reply_to_id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849cgy0",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1192284295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T21:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030894873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that's really a useful optimization since `outs` is likely to be very small. If we are concerned about the complexity of `find`, then I think it would be better to use an `unordered_set` rather than erasing after each removal.\r\n\r\nThis isn't really a blocking comment, I just found it a bit confusing.",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T21:50:56Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030894873",
      "id" : 1030894873,
      "in_reply_to_id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849cjUZ",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1192298629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T21:50:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030960317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, an `unordered_set` sounds good too.\r\n\r\nstill, what I wanted to add (and I actually didn't add it for some reason..) is the capability to stop early if the set has no elements. E.g. if the wallet has 100k UTXO inside, the preset inputs set is small, and the coins appear early in the loop: the process could stop right away (no need to keep traversing the entire available coins vector if we already found them).\r\n\r\nbut.. as this is primarily to solve the dangerous bug in v24. Could go ahead with the `unordered_set`, make the code simpler, and leave any optimization for later.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-24T00:27:15Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030960317",
      "id" : 1030960317,
      "in_reply_to_id" : 1030669464,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849czS9",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1192391348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T00:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032802753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is locking here necessary? Can we just fund the wallets with 2 coins instead of 10?",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T15:45:22Z",
      "diff_hunk" : "@@ -1200,6 +1201,63 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 10 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(10):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs and lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032802753",
      "id" : 1032802753,
      "line" : 1227,
      "node_id" : "PRRC_kwDOABII5849j1HB",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 1227,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 35,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032807770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same question here. Do we really need to lock the coins? ",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T16:33:35Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verifies that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 10; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+    // Lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032807770",
      "id" : 1032807770,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5849j2Va",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 125,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 14,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032808028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I'm not sure having second test provides enough extra value. I'd rather keep one, but ultimately up to you.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T16:36:00Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032808028",
      "id" : 1032808028,
      "line" : 115,
      "node_id" : "PRRC_kwDOABII5849j2Zc",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 115,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032811592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think it's correct to fallback on `available_coins.total_amount` when we don't do SFFO.\r\n\r\nwith SFFO we must have effective amount, if we don't - something went wrong.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T17:09:24Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032811592",
      "id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849j3RI",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032813025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "note to self: not a huge fan of how this looks like with `optional`. The code would look much simpler if we can just always pass a fee rate to `AvailableCoins` (we can set it 0 by default). Can't make my mind which way is better...",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T17:24:38Z",
      "diff_hunk" : "@@ -51,8 +51,10 @@ struct CoinsResult {\n     void Shuffle(FastRandomContext& rng_fast);\n     void Add(OutputType type, const COutput& out);\n \n-    /** Sum of all available coins */\n+    /** Sum of all available coins raw value */\n     CAmount total_amount{0};\n+    /** Sum of all available coins effective value (each output value minus fees required to spend it) */\n+    std::optional<CAmount> total_effective_amount{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032813025",
      "id" : 1032813025,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849j3nh",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 57,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 8,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Asking here instead of in the backport: is this only in v24 or also earlier versions?",
      "created_at" : "2022-11-28T13:54:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1329146984",
      "id" : 1329146984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585POSxo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329146984/reactions"
      },
      "updated_at" : "2022-11-28T13:54:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329146984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Asking here instead of in the backport: is this only in v24 or also earlier versions?\r\n\r\nMy understanding is only v24.x. Seems like the buggy behaviour was introduced in #24584 + #25734?",
      "created_at" : "2022-11-28T14:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1329161687",
      "id" : 1329161687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585POWXX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329161687/reactions"
      },
      "updated_at" : "2022-11-28T14:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329161687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Asking here instead of in the backport: is this only in v24 or also earlier versions?\r\n\r\nYeah. @Sjors only for v24. The dangerous bug was introduced in #25734 which is only on v24, and after branching off, we merged #25685 which fixed it without noticing it.",
      "created_at" : "2022-11-28T14:04:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1329163697",
      "id" : 1329163697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585POW2x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329163697/reactions"
      },
      "updated_at" : "2022-11-28T14:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329163697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033634941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033634941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "let me double check it, IIRC I added it to make the wallet have enough funds in case we have an early balance check in the flow.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T14:46:30Z",
      "diff_hunk" : "@@ -1200,6 +1201,63 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 10 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(10):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs and lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033634941",
      "id" : 1033634941,
      "in_reply_to_id" : 1032802753,
      "line" : 1227,
      "node_id" : "PRRC_kwDOABII5849nAR9",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 1227,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 35,
      "pull_request_review_id" : 1195944592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033634941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T14:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033634941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033644437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033644437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah. I almost remove it but.. ended up leaving because (1) the severity of the bug and (2) because it's easier to debug and assert that the code is failing where is supposed to be failing (in the functional test case, as we use the `send` RPC command, we do have other stuff involved).\r\n\r\nI'm fine either way, if this still doesn't convince you and more people don't see it useful, can remove it for sure.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T14:53:59Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033644437",
      "id" : 1033644437,
      "in_reply_to_id" : 1032808028,
      "line" : 115,
      "node_id" : "PRRC_kwDOABII5849nCmV",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 115,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1195958121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033644437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T14:53:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033644437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033752353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033752353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, need a bit of context here.\r\nGuess that you are saying that because, with SFFO, the wallet needs to select a group of UTXOs that will be able to pay for themselves? So, the entire coin selection relies on the effective value existence so.. if it's not there there is a bug?",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T16:18:46Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033752353",
      "id" : 1033752353,
      "in_reply_to_id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849nc8h",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1196113714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033752353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T16:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033752353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033815954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033815954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By the time we get here, if `total_effective_amount` doesn't have a value, that means that none of the UTXOs in this wallet were solvable, so we can't do any coin selection here in that case. So I think it would be better to always return early in that case.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T17:08:23Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033815954",
      "id" : 1033815954,
      "in_reply_to_id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849nseS",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1196209044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033815954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T17:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033815954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033924509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033924509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> By the time we get here, if total_effective_amount doesn't have a value, that means that none of the UTXOs in this wallet were solvable, so we can't do any coin selection here in that case\r\n\r\nHmm, code wise, that doesn't seems to be what is happening.\r\n\r\nAt the `COutput` constructor, if the coin isn't solvable then `effective_value` will be equal to the nominal output value. So it will always have an effective value during the tx creation process.\r\n\r\nThe only way that a `COutput` has no `effective_value` is when we don't provide the feerate param to `AvailableCoins` (which happens on all the flows that uses `AvailableCoins` that are not part of the tx creation process).",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T18:43:04Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033924509",
      "id" : 1033924509,
      "in_reply_to_id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849oG-d",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1196363778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033924509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T18:43:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033924509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033935017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033935017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, hmm, I thought it checked `input_bytes` as well.\r\n\r\nIn that case, `total_effective_amount` should always have a value if we have any coins. If it isn't set, then we don't have any coins and we can still return early.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-28T18:54:30Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033935017",
      "id" : 1033935017,
      "in_reply_to_id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849oJip",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1196378617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033935017/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T18:54:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033935017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033936642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033936642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would agree on always passing the fee rate to `AvailableCoins` if we were using the function only for the tx creation process, but we are using it for other processes that don't require to calculate the effective value nor the output spending fee.\r\n\r\nWe definitely can improve it but I don't think that this PR is the best place to do it.\r\n\r\nSide from that, from my side, have some plans to re-write the `AvailableCoins` functionality differently post #25806 (because, after it, will be able to continually connect outputs to existent output groups, outside of the coin selection process which is currently forcing us to do the whole calculation on-demand).",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-28T18:56:14Z",
      "diff_hunk" : "@@ -51,8 +51,10 @@ struct CoinsResult {\n     void Shuffle(FastRandomContext& rng_fast);\n     void Add(OutputType type, const COutput& out);\n \n-    /** Sum of all available coins */\n+    /** Sum of all available coins raw value */\n     CAmount total_amount{0};\n+    /** Sum of all available coins effective value (each output value minus fees required to spend it) */\n+    std::optional<CAmount> total_effective_amount{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033936642",
      "id" : 1033936642,
      "in_reply_to_id" : 1032813025,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849oJ8C",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 57,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 13,
      "pull_request_review_id" : 1196380793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033936642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T23:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033936642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033971497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "All good, just removed it. Seems that I was just over-thinking it.",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-28T19:32:58Z",
      "diff_hunk" : "@@ -1200,6 +1201,63 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 10 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(10):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs and lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033971497",
      "id" : 1033971497,
      "in_reply_to_id" : 1032802753,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849oScp",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 1227,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1196436608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T19:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033971966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "not really, removed it. Thanks",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-28T19:33:26Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verifies that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 10; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+    // Lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1033971966",
      "id" : 1033971966,
      "in_reply_to_id" : 1032807770,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849oSj-",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 125,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1196437167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T19:33:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033971966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Feedback tackled, thanks @S3RK and @achow101.\r\n\r\nChanges:\r\n1) In the tests, removed the unneeded coins lock.\r\n2) Now `SelectCoins` returns early if the wallet's available coins `total_effective_amount` is not available (it does not fallback to use the raw total amount anymore).",
      "created_at" : "2022-11-28T19:48:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1329665367",
      "id" : 1329665367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PQRVX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329665367/reactions"
      },
      "updated_at" : "2022-11-28T19:48:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329665367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think probably `CoinsResult::coins` should be a `std::map<OutputType, std::unordered_set<COutput>>` instead of [map of] vectors. It's too strange that we could end up with the same output in there twice. Maybe even an assert failure if we try to add the same ones twice?",
      "created_at" : "2022-11-29T04:10:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1330050199",
      "id" : 1330050199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PRvSX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330050199/reactions"
      },
      "updated_at" : "2022-11-29T04:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330050199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034778211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034778211"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in https://github.com/bitcoin/bitcoin/pull/26560/commits/65126cb522b28f53a020ce56826f7d15560241c9:\r\n\r\nShouldn't this be a `std::find`? `count` will traverse the entire `coins_to_remove` vector whereas `std::find` will stop as soon as it finds the outpoint.\r\n",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T13:50:32Z",
      "diff_hunk" : "@@ -102,15 +102,13 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& coins_to_remove)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            return coins_to_remove.count(coin.outpoint) == 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034778211",
      "id" : 1034778211,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rXZj",
      "original_commit_id" : "65126cb522b28f53a020ce56826f7d15560241c9",
      "original_line" : 109,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 16,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034778211/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034778211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034780473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034780473"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in https://github.com/bitcoin/bitcoin/pull/26560/commits/65126cb522b28f53a020ce56826f7d15560241c9:\r\n\r\nnit, but can we keep the parameter names consistent? either use `outs` in both places or `coins_to_remove` in both places?",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T13:52:28Z",
      "diff_hunk" : "@@ -47,7 +47,7 @@ struct CoinsResult {\n      * i.e., methods can work with individual OutputType vectors or on the entire object */\n     size_t Size() const;\n     void Clear();\n-    void Erase(std::set<COutPoint>& preset_coins);\n+    void Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& outs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034780473",
      "id" : 1034780473,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII5849rX85",
      "original_commit_id" : "65126cb522b28f53a020ce56826f7d15560241c9",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 5,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034780473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034780473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034796746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034796746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I also agree that the second unit test (which isn't really a unit test) seems redundant and also a little confusing to me. I think the unit test for `CoinsResult::Erase` in an earlier commit is correct for a unit test and the functional test is better suited for testing the wallet behavior",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T14:05:43Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034796746",
      "id" : 1034796746,
      "in_reply_to_id" : 1032808028,
      "line" : 115,
      "node_id" : "PRRC_kwDOABII5849rb7K",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 115,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034796746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034796746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034800106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800106"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As it's written, the test comment doesn't make sense unless you have the background context. The comment describes a certain type of failure (insane fee, or wallet crash), but the assertion seems to check something entirely different. Perhaps it's worth writing a long comment which explains why you are checking for insufficient funds and what you would expect if the insufficient funds assert fails.",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T14:08:35Z",
      "diff_hunk" : "@@ -1200,6 +1201,59 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)\n+\n+        # Second case, don't use 'subtract_fee_from_outputs' to make the wallet crash due the insane fee on v24.0\n+        del options[\"subtract_fee_from_outputs\"]\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034800106",
      "id" : 1034800106,
      "line" : 1253,
      "node_id" : "PRRC_kwDOABII5849rcvq",
      "original_commit_id" : "a07c3b4cfdf864b419984103323d431cbe3cc870",
      "original_line" : 1253,
      "original_position" : 61,
      "original_start_line" : 1248,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 61,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800106/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1248,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034803002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034803002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in https://github.com/bitcoin/bitcoin/pull/26560/commits/1b14bd7ac77027351a1e5b3ef21fb2d1de659efd:\r\n\r\nsame comment from before, I'd suggest using `find` here.",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T14:10:54Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034803002",
      "id" : 1034803002,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII5849rdc6",
      "original_commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034803002/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034803002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034809655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034809655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "also, might be worth adding the `if () return false;` in the earlier commit so you don't end up touching this line twice? ",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T14:16:13Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034809655",
      "id" : 1034809655,
      "in_reply_to_id" : 1034803002,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII5849rfE3",
      "original_commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1197593313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034809655/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034809655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think probably `CoinsResult::coins` should be a `std::map<OutputType, std::unordered_set<COutput>>` instead of [map of] vectors. It's too strange that we could end up with the same output in there twice. Maybe even an assert failure if we try to add the same ones twice?\r\n\r\n@luke-jr: we can't end up with the same output twice there. That struct is loaded inside `AvailableCoins` which traverses the wallet's txes map once.\r\nIn v24, where we don't have https://github.com/bitcoin/bitcoin/pull/25685 merge, the preset inputs were fetched twice: first inside `AvailableCoins` which was appending them to the `CoinsResult` vectors and secondly inside `SelectCoins` where we were manually fetching them from the wallet txes map [here](https://github.com/bitcoin/bitcoin/blob/c1061be14a515b0ed4f4d646fcd0378c62e6ded3/src/wallet/spend.cpp#L542-L587) (by calling `GetWalletTx(outpoint)`). \r\nThen, `SelectCoins` was removing the preset inputs from the `CoinsResult` vectors before start the automatic coin selection process so the process does not select them (bug was here, the `Erase` function was not removing them). Then, at the end of the selection process, we merge both results (the preset inputs selection result and the automatic coin selection result).",
      "created_at" : "2022-11-29T15:10:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1330799911",
      "id" : 1330799911,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PUmUn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330799911/reactions"
      },
      "updated_at" : "2022-11-29T15:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330799911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034897955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034897955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`coins_to_remove` is an unordered set, not a vector. Internally, uses a hash table where keys are hashed into indices. So, time complexity wise, `count` and `find` should take the same constant time.",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T15:22:12Z",
      "diff_hunk" : "@@ -102,15 +102,13 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& coins_to_remove)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            return coins_to_remove.count(coin.outpoint) == 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034897955",
      "id" : 1034897955,
      "in_reply_to_id" : 1034778211,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849r0oj",
      "original_commit_id" : "65126cb522b28f53a020ce56826f7d15560241c9",
      "original_line" : 109,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 16,
      "pull_request_review_id" : 1197772333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034897955/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T15:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034897955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034898859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034898859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, thanks",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T15:22:48Z",
      "diff_hunk" : "@@ -47,7 +47,7 @@ struct CoinsResult {\n      * i.e., methods can work with individual OutputType vectors or on the entire object */\n     size_t Size() const;\n     void Clear();\n-    void Erase(std::set<COutPoint>& preset_coins);\n+    void Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& outs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034898859",
      "id" : 1034898859,
      "in_reply_to_id" : 1034780473,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII5849r02r",
      "original_commit_id" : "65126cb522b28f53a020ce56826f7d15560241c9",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 5,
      "pull_request_review_id" : 1197773598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034898859/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T15:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034898859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034903839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034903839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> in [1b14bd7](https://github.com/bitcoin/bitcoin/commit/1b14bd7ac77027351a1e5b3ef21fb2d1de659efd):\r\n> \r\n> same comment from before, I'd suggest using `find` here.\r\n\r\nanswered in the first commit comment https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034897955\r\n\r\n\r\n> also, might be worth adding the `if () return false;` in the earlier commit so you don't end up touching this line twice?\r\n\r\nnot sure what you meant, the first commit has a single line (the `count` function will either return 1 if the element is in the set or 0 if not).\r\n```c++\r\nreturn coins_to_remove.count(coin.outpoint) == 1;\r\n```",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T15:26:29Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034903839",
      "id" : 1034903839,
      "in_reply_to_id" : 1034803002,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII5849r2Ef",
      "original_commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1197780760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034903839/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T15:26:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034903839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034921437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034921437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah ok. I added the topic background inside the commit description that introduces the tests. But.. agree that, at least in this post-mortem bug case, the link to the PR that fixes it and further comments inside the test code would make it more digestible. Thanks.",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T15:39:50Z",
      "diff_hunk" : "@@ -1200,6 +1201,59 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)\n+\n+        # Second case, don't use 'subtract_fee_from_outputs' to make the wallet crash due the insane fee on v24.0\n+        del options[\"subtract_fee_from_outputs\"]\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034921437",
      "id" : 1034921437,
      "in_reply_to_id" : 1034800106,
      "line" : 1253,
      "node_id" : "PRRC_kwDOABII5849r6Xd",
      "original_commit_id" : "a07c3b4cfdf864b419984103323d431cbe3cc870",
      "original_line" : 1253,
      "original_position" : 61,
      "original_start_line" : 1248,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 61,
      "pull_request_review_id" : 1197805794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034921437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1248,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-29T15:41:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034921437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035007277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035007277"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ah, good point! i forgot how `find` \\ `count` work is dependent on the underlying container",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T16:49:16Z",
      "diff_hunk" : "@@ -102,15 +102,13 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& coins_to_remove)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            return coins_to_remove.count(coin.outpoint) == 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035007277",
      "id" : 1035007277,
      "in_reply_to_id" : 1034778211,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849sPUt",
      "original_commit_id" : "65126cb522b28f53a020ce56826f7d15560241c9",
      "original_line" : 109,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 16,
      "pull_request_review_id" : 1197936889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035007277/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T16:49:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035007277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035016991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035016991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah, more just saying you could write the first commit like:\r\n\r\n```\r\nif (coins_to_remove.count(coin.outpoint) == 0) return false;\r\nreturn true;\r\n```\r\n\r\nbecause you know that in a later commit you will add the `total_amount` and `total_effective` code, and this way you avoid re-writing the same line twice. it doesn't really matter in this case, just a suggestion. in general, it can be confusing as a reviewer when the same line of code is edited multiple times in different commits",
      "commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "created_at" : "2022-11-29T16:55:53Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035016991",
      "id" : 1035016991,
      "in_reply_to_id" : 1034803002,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII5849sRsf",
      "original_commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1197947748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035016991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T16:55:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035016991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "fwiw, I ran the failing CI test locally and it passed, so I think all you need to do is restart the test",
      "created_at" : "2022-11-29T17:03:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1330975637",
      "id" : 1330975637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PVROV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330975637/reactions"
      },
      "updated_at" : "2022-11-29T17:03:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330975637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035058430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035058430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ideally, commits should introduce atomic changes. Did the first one in this way so it can be backported without any dependency into a different branch (due the lack of https://github.com/bitcoin/bitcoin/pull/25685, v24 branch cannot cherry-pick https://github.com/bitcoin/bitcoin/commit/1b14bd7ac77027351a1e5b3ef21fb2d1de659efd).\r\n\r\nSo, we would only have those lines inside v24, which I think that is ugly. The current one looks better.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-29T17:32:13Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1035058430",
      "id" : 1035058430,
      "in_reply_to_id" : 1034803002,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII5849sbz-",
      "original_commit_id" : "1b14bd7ac77027351a1e5b3ef21fb2d1de659efd",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 17,
      "pull_request_review_id" : 1198036593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035058430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T17:34:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035058430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated per feedback, thanks everyone. [Small diff](https://github.com/bitcoin/bitcoin/compare/1b14bd7ac77027351a1e5b3ef21fb2d1de659efd..8f9bd177255f285a53871fa278528338407af267).\r\n\r\nChanges:\r\n1) Per @S3RK feedback, cherry-picked the simple fallback assertion (eb76557).\r\n   I still think that we might want to merge different `SelectionResult` objects that share some outputs in the future but.. now it's definitely not the right time to do it.\r\n2) Per @josibake feedback, added [#26559](https://github.com/bitcoin/bitcoin/pull/26559) mention in the functional test cases and few more details in the comments.",
      "created_at" : "2022-11-29T22:57:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1331424471",
      "id" : 1331424471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PW-zX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331424471/reactions"
      },
      "updated_at" : "2022-11-29T23:00:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331424471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~ACK eb76557331b4f34b568da1d9c589c7005d7ab46d~",
      "created_at" : "2022-11-29T23:06:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1331432988",
      "id" : 1331432988,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PXA4c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331432988/reactions"
      },
      "updated_at" : "2022-12-01T17:11:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331432988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK https://github.com/bitcoin/bitcoin/commit/eb76557331b4f34b568da1d9c589c7005d7ab46d\r\n\r\nreviewed the diff, looks good",
      "created_at" : "2022-11-30T09:56:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1331900188",
      "id" : 1331900188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PYy8c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331900188/reactions"
      },
      "updated_at" : "2022-11-30T09:56:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331900188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036068985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036068985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Could add a check that you also haven't removed things that weren't supposed to be removed. For example, a `BOOST_CHECK_EQUAL(available_coins.Size(), 8);` would catch a case of, for example, accidentally removing the entire map entry for that output type instead of an element in the vector of the entry.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T14:51:16Z",
      "diff_hunk" : "@@ -980,5 +980,43 @@ BOOST_AUTO_TEST_CASE(SelectCoins_effective_value_test)\n     BOOST_CHECK(!result);\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_coinsresult_test, BasicTestingSetup)\n+{\n+    // Test case to verify CoinsResult object sanity.\n+    CoinsResult available_coins;\n+    {\n+        std::unique_ptr<CWallet> dummyWallet = std::make_unique<CWallet>(m_node.chain.get(), \"dummy\", m_args, CreateMockWalletDatabase());\n+        BOOST_CHECK_EQUAL(dummyWallet->LoadWallet(), DBErrors::LOAD_OK);\n+        LOCK(dummyWallet->cs_wallet);\n+        dummyWallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+        dummyWallet->SetupDescriptorScriptPubKeyMans();\n+\n+        // Add some coins to 'available_coins'\n+        for (int i=0; i<10; i++) {\n+            add_coin(available_coins, *dummyWallet, 1 * COIN);\n+        }\n+    }\n+\n+    {\n+        // First test case, check that 'CoinsResult::Erase' function works as expected.\n+        // By trying to erase two elements from the 'available_coins' object.\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outs_to_remove;\n+        const auto& coins = available_coins.All();\n+        for (int i = 0; i < 2; i++) {\n+            outs_to_remove.emplace(coins[i].outpoint);\n+        }\n+        available_coins.Erase(outs_to_remove);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036068985",
      "id" : 1036068985,
      "line" : 1008,
      "node_id" : "PRRC_kwDOABII5849wSh5",
      "original_commit_id" : "4ba93512768201402e2ff445b13a6dba666cd80b",
      "original_line" : 1008,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 29,
      "pull_request_review_id" : 1199471979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036068985/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T10:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036068985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036074023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036074023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: why can't you just make this equal to `preset_inputs` - maybe I'm missing something?\r\n\r\n```suggestion\r\n           \"inputs\": preset_inputs,\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T14:55:11Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036074023",
      "id" : 1036074023,
      "line" : 1248,
      "node_id" : "PRRC_kwDOABII5849wTwn",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 1248,
      "original_position" : 56,
      "original_start_line" : 1239,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 56,
      "pull_request_review_id" : 1199471979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036074023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1239,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-01T10:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036074023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036387520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036387520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just a nit, but the term \"insane fee\" had me thinking that this test has us paying a huge amount of fees, something that would be conflicting with our sanity checks.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T19:54:30Z",
      "diff_hunk" : "@@ -112,5 +112,34 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verify that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 2; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+\n+    // Now that all coins were locked except the two preset inputs, let's create a tx\n+    std::vector<CRecipient> recipients = {{GetScriptForDestination(*Assert(wallet->GetNewDestination(OutputType::BECH32, \"dummy\"))), 149 * COIN, /*fSubtractFeeFromAmount=*/true}};\n+    CCoinControl coin_control;\n+    coin_control.m_allow_other_inputs = true;\n+    for (const auto& outpoint : preset_inputs) {\n+        coin_control.Select(outpoint);\n+    }\n+\n+    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036387520",
      "id" : 1036387520,
      "line" : 134,
      "node_id" : "PRRC_kwDOABII5849xgTA",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 134,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036387520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036387520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036388582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036388582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It was not clear to me at first why the expected outcome is that we don't create a transaction. That could have perhaps been captured in the comment instead: the wallet shouldn't have sufficient funds to create the tx, but the bug caused us previously to assume that preset UTXOs were available twice and thus overestimate our funding.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T19:55:43Z",
      "diff_hunk" : "@@ -112,5 +112,34 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verify that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 2; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+\n+    // Now that all coins were locked except the two preset inputs, let's create a tx\n+    std::vector<CRecipient> recipients = {{GetScriptForDestination(*Assert(wallet->GetNewDestination(OutputType::BECH32, \"dummy\"))), 149 * COIN, /*fSubtractFeeFromAmount=*/true}};\n+    CCoinControl coin_control;\n+    coin_control.m_allow_other_inputs = true;\n+    for (const auto& outpoint : preset_inputs) {\n+        coin_control.Select(outpoint);\n+    }\n+\n+    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+    util::Result<CreatedTransactionResult> res_tx = CreateTransaction(*wallet, recipients, /*change_pos*/-1, coin_control);\n+    BOOST_CHECK(!res_tx.has_value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036388582",
      "id" : 1036388582,
      "line" : 136,
      "node_id" : "PRRC_kwDOABII5849xgjm",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 136,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 25,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036388582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036388582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036389602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036389602"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I see, that is the context that I was missing above! :)",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T19:56:59Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036389602",
      "id" : 1036389602,
      "line" : 1222,
      "node_id" : "PRRC_kwDOABII5849xgzi",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 1222,
      "original_position" : 30,
      "original_start_line" : 1219,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 30,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036389602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1219,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036389602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036411064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036411064"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Are we sure that `total_effective_value` is always set here?\r\n\r\nMaybe `assume(total_effective_amount.has_value()` here?",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T20:24:26Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;\n+\n+            // update cached amounts\n+            total_amount -= coin.txout.nValue;\n+            if (coin.HasEffectiveValue()) total_effective_amount = *total_effective_amount - coin.GetEffectiveValue();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036411064",
      "id" : 1036411064,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849xmC4",
      "original_commit_id" : "a45ecd64ba4f63cba8d5f623a9442d81ccf63ac4",
      "original_line" : 114,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 10,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036411064/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036411064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036419174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036419174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We will never use `SelectCoins()` without a feerate. If you end up not having total_effective_amount here, something went terribly wrong. Perhaps just:\r\n\r\n```suggestion\r\n    assume(available_coins.total_effective_amount.has_value());\r\n    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount : *available_coins.total_effective_amount);\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T20:35:33Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036419174",
      "id" : 1036419174,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849xoBm",
      "original_commit_id" : "a45ecd64ba4f63cba8d5f623a9442d81ccf63ac4",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : 589,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036419174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 589,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036419174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036421300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036421300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // Store sum of combined input sets to check that no UTXO was used twice\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T20:38:46Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036421300",
      "id" : 1036421300,
      "line" : 455,
      "node_id" : "PRRC_kwDOABII5849xoi0",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 455,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1199933874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036421300/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036421300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036429162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would be useful to make `total_amount`, `total_effective_amount`, and `coins` private members to ensure that we are only adding/removing things with `Add` and `Erase`.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T20:49:27Z",
      "diff_hunk" : "@@ -47,12 +47,14 @@ struct CoinsResult {\n      * i.e., methods can work with individual OutputType vectors or on the entire object */\n     size_t Size() const;\n     void Clear();\n-    void Erase(std::set<COutPoint>& preset_coins);\n+    void Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& coins_to_remove);\n     void Shuffle(FastRandomContext& rng_fast);\n     void Add(OutputType type, const COutput& out);\n \n-    /** Sum of all available coins */\n+    /** Sum of all available coins raw value */\n     CAmount total_amount{0};\n+    /** Sum of all available coins effective value (each output value minus fees required to spend it) */\n+    std::optional<CAmount> total_effective_amount{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036429162",
      "id" : 1036429162,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849xqdq",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 57,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 13,
      "pull_request_review_id" : 1199994539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429162/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:49:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036429177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429177"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I had this question myself. I figured if we remove the coin with effective value, then the coin was added before, hence we have `total_effective_value` defined. Please correct me if my reasoning is flawed.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-11-30T20:49:28Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;\n+\n+            // update cached amounts\n+            total_amount -= coin.txout.nValue;\n+            if (coin.HasEffectiveValue()) total_effective_amount = *total_effective_amount - coin.GetEffectiveValue();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036429177",
      "id" : 1036429177,
      "in_reply_to_id" : 1036411064,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849xqd5",
      "original_commit_id" : "a45ecd64ba4f63cba8d5f623a9442d81ccf63ac4",
      "original_line" : 114,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 10,
      "pull_request_review_id" : 1199994567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T20:49:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036429177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK eb76557331b4f34b568da1d9c589c7005d7ab46d\r\n\r\nWill reack if you address nits",
      "created_at" : "2022-11-30T20:55:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1332724607",
      "id" : 1332724607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585Pb8N_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332724607/reactions"
      },
      "updated_at" : "2022-11-30T20:55:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332724607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036936363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036936363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a bit unclear to me how the assert added in eb76557331b4f34b568da1d9c589c7005d7ab46d is more safe? Wouldn't this mean we still crash if we haven't caught a similar bug before shipping?",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T10:23:29Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1036936363",
      "id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII5849zmSr",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1199471979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036936363/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T10:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036936363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037315629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037315629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think we should be adding specific version numbers to comments, because this just becomes (mostly) incorrect, once we've merged a backport, and doesn't really provide any value otherwise.\r\n```suggestion\r\n    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee.\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T16:18:50Z",
      "diff_hunk" : "@@ -112,5 +112,34 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verify that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 2; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+\n+    // Now that all coins were locked except the two preset inputs, let's create a tx\n+    std::vector<CRecipient> recipients = {{GetScriptForDestination(*Assert(wallet->GetNewDestination(OutputType::BECH32, \"dummy\"))), 149 * COIN, /*fSubtractFeeFromAmount=*/true}};\n+    CCoinControl coin_control;\n+    coin_control.m_allow_other_inputs = true;\n+    for (const auto& outpoint : preset_inputs) {\n+        coin_control.Select(outpoint);\n+    }\n+\n+    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037315629",
      "id" : 1037315629,
      "line" : 134,
      "node_id" : "PRRC_kwDOABII58491C4t",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 134,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1201300739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037315629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T16:18:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037315629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037319314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037319314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is no need to continually write `v24.0` and `(further details in #26559)` (here and below and further above). If you need to provide further context or details, please put them in the commit (or PR) descriptions, so they are available with the code change.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T16:22:16Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037319314",
      "id" : 1037319314,
      "line" : 1255,
      "node_id" : "PRRC_kwDOABII58491DyS",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1255,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 63,
      "pull_request_review_id" : 1201306217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037319314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T16:22:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037319314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037337828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037337828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "those were my initial thoughts actually, added this on the last push per request https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1034800106.\r\n\r\nseems that not everyone read the PR/commit description. But well, will just revert it.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T16:38:51Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037337828",
      "id" : 1037337828,
      "in_reply_to_id" : 1037319314,
      "line" : 1255,
      "node_id" : "PRRC_kwDOABII58491ITk",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1255,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 63,
      "pull_request_review_id" : 1201333779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037337828/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T16:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037337828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037351924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037351924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry if this wasn't clear in my comment, but I wasn't suggesting adding `v24` and links to the PR. My comment was to point out that the comments in the test didn't match what was being checked in the assertion, which would be confusing to someone who didn't have the background context. I understand this is a bit tricky because the test is for a bug that is no longer there, but ideally, the comment should explain why you are asserting \"Insufficient Funds\" in the happy case, and why, if the bug were present, that you would expect the \"Insufficient Funds\" assertion to fail. If you do want to link to the PR for more context, perhaps a top-level comment would be the best place?",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T16:52:23Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037351924",
      "id" : 1037351924,
      "in_reply_to_id" : 1037319314,
      "line" : 1255,
      "node_id" : "PRRC_kwDOABII58491Lv0",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1255,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 63,
      "pull_request_review_id" : 1201354316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037351924/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T16:52:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037351924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Retracting my ACK for now. It seems that the comment wordings is confusing several people, so it would be good to have those be clear as to what the bugs are to avoid confusion in the future.",
      "created_at" : "2022-12-01T17:11:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1334090387",
      "id" : 1334090387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585PhJqT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1334090387/reactions"
      },
      "updated_at" : "2022-12-01T17:11:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1334090387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037395665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037395665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest removing this last commit for this PR, and following up with an \"add sanity checks to coin selection code\" PR.\r\n\r\nOf course we don't want to create a bad transaction, but an assert would cause the user's node to crash in case we have implemented it wrong. I think something better could be to add `if(!Assume(...)) {return \"sorry, something went wrong and transaction creation failed. please report this bug...\";}` which should stop the wallet from doing something horrible but also not crash. Apologies if this is bikesheddy - my concrete suggestion is to remove this for now, and do a followup PR for these types of changes. Other appropriate sanity checks could include `AddInput()` never adds an input that's already there, `SelectCoins` result should cover `selection_target`, etc.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T17:36:37Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037395665",
      "id" : 1037395665,
      "in_reply_to_id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII58491WbR",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1201406725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037395665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T17:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037395665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037410273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.log.info('Test wallet preset inputs are not double-counted or reused in coin selection')\r\n\r\n        # Create and fund the wallet with 2 UTXO of 5 BTC each, total balance 10 BTC.\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T17:52:34Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037410273",
      "id" : 1037410273,
      "line" : 1224,
      "node_id" : "PRRC_kwDOABII58491Z_h",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1224,
      "original_position" : 32,
      "original_start_line" : 1205,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 32,
      "pull_request_review_id" : 1201406725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410273/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1205,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-01T17:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037410889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410889"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        # Attempt to send 14 BTC. The wallet should exclude the preset inputs from the pool of\r\n        # available coins, realize that there is not enough money to fund the 14 BTC payment,\r\n        # and fail with \"insufficient funds.\"\r\n        # Even with SFFO, the wallet can only afford to send 10 BTC.\r\n\r\n        # If the wallet does not properly exclude preset inputs from the pool of available coins\r\n        # prior to coin selection, it may create a transaction that does not fund the full payment\r\n        # amount or, through SFFO, incorrectly reduce the payment amount so that payment+fee is not\r\n        # equal to 14 BTC.\r\n        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)\r\n```",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T17:53:14Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)\n+\n+        # Second case, don't use 'subtract_fee_from_outputs' to make the wallet crash due the insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037410889",
      "id" : 1037410889,
      "line" : 1259,
      "node_id" : "PRRC_kwDOABII58491aJJ",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1259,
      "original_position" : 67,
      "original_start_line" : 1254,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 67,
      "pull_request_review_id" : 1201406725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410889/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1254,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-01T17:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037410889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037413633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037413633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\nCherry-picking this test on top of 24.x, I can see that the wallet mistakenly uses a preset input twice and deducts the fee+5BTC from the payment, but the fee is actually exactly what is expected (since at the end the transaction only has 10BTC inputs and not 15): https://github.com/glozow/bitcoin/blob/test-n26560/test/functional/rpc_fundrawtransaction.py#L1250-L1266\r\n\r\n@achow101 suggested that maybe `nFeeRet` from `FundTransaction()` or  `CreatedTransactionResult::fee` could be incorrect but I wasn't able to get a test to show that. @achow101 then pointed me to this code showing the sffo fee should be correctly set before `CreateTransaction` returns:\r\nhttps://github.com/bitcoin/bitcoin/blob/f668a3a85933512e7efc369b5b2922d44b4bad82/src/wallet/spend.cpp#L971-L1004\r\n\r\nI could be mistaken, but in that case could you maybe write a test for v24.0 that shows what the expected vs actual fee are? Otherwise I'd suggest removing this from the comments/commit message/PR descriptions.\r\n\r\nHaving 2 test cases for sffo and non-sffo codepaths is still meaningful, but I think the current comment is misleading and can cause us to have trouble understanding this test in the future.",
      "commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "created_at" : "2022-12-01T17:56:16Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1037413633",
      "id" : 1037413633,
      "line" : 1256,
      "node_id" : "PRRC_kwDOABII58491a0B",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1256,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 64,
      "pull_request_review_id" : 1201406725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037413633/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-01T17:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1037413633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ok great, thanks everyone. Now I see where the confusion arises.\r\nWill be tackling all the feedback and updating the PR soon.",
      "created_at" : "2022-12-01T18:51:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1334201650",
      "id" : 1334201650,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585Phk0y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1334201650/reactions"
      },
      "updated_at" : "2022-12-01T18:51:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1334201650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038265394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038265394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds good",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T15:35:36Z",
      "diff_hunk" : "@@ -980,5 +980,43 @@ BOOST_AUTO_TEST_CASE(SelectCoins_effective_value_test)\n     BOOST_CHECK(!result);\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_coinsresult_test, BasicTestingSetup)\n+{\n+    // Test case to verify CoinsResult object sanity.\n+    CoinsResult available_coins;\n+    {\n+        std::unique_ptr<CWallet> dummyWallet = std::make_unique<CWallet>(m_node.chain.get(), \"dummy\", m_args, CreateMockWalletDatabase());\n+        BOOST_CHECK_EQUAL(dummyWallet->LoadWallet(), DBErrors::LOAD_OK);\n+        LOCK(dummyWallet->cs_wallet);\n+        dummyWallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+        dummyWallet->SetupDescriptorScriptPubKeyMans();\n+\n+        // Add some coins to 'available_coins'\n+        for (int i=0; i<10; i++) {\n+            add_coin(available_coins, *dummyWallet, 1 * COIN);\n+        }\n+    }\n+\n+    {\n+        // First test case, check that 'CoinsResult::Erase' function works as expected.\n+        // By trying to erase two elements from the 'available_coins' object.\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outs_to_remove;\n+        const auto& coins = available_coins.All();\n+        for (int i = 0; i < 2; i++) {\n+            outs_to_remove.emplace(coins[i].outpoint);\n+        }\n+        available_coins.Erase(outs_to_remove);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038265394",
      "id" : 1038265394,
      "in_reply_to_id" : 1036068985,
      "line" : 1008,
      "node_id" : "PRRC_kwDOABII58494qwy",
      "original_commit_id" : "4ba93512768201402e2ff445b13a6dba666cd80b",
      "original_line" : 1008,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 63,
      "pull_request_review_id" : 1202683490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038265394/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T15:35:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038265394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038266662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038266662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nop, you are right. I was doing this stuff manually at the beginning, can simplify it now. Thanks",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T15:36:47Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038266662",
      "id" : 1038266662,
      "in_reply_to_id" : 1036074023,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58494rEm",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 1248,
      "original_position" : 56,
      "original_start_line" : 1239,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1202685143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038266662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-02T15:36:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038266662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038307694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038307694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Of course we don't want to create a bad transaction, but an assert would cause the user's node to crash in case we have implemented it wrong. I think something better could be to add if(!Assume(...)) {return \"sorry, something went wrong and transaction creation failed. please report this bug...\";} which should stop the wallet from doing something horrible but also not crash.\r\n\r\nSure. I totally agree on using more `Assume` + user friendly error return messages than crashing the node with bare assertions.\r\n\r\nI do actually implemented the capability to return error messages from the Coin Selection process inside [#25806](https://github.com/bitcoin/bitcoin/pull/25806) -> 45bc10687f7b0131fd1c4575406b62f0608e2c01 few months ago (which is later used to return specific error messages instead of the current general \"Insufficient Funds\". Which is required to implement your suggestions as we currently don't have a way to return specific errors to the upper layers).\r\n\r\nSo, in short, could drop the last commit and open a follow-up PR moving forward with it, and more, for sure. But.. as I added the last commit by reviewers request, would be good to see if @S3RK is sync with this reasoning too (otherwise we would be going in circles).\r\nNote: Since, after the fix, this problem cannot realistically happen anymore, I'm fine to move either way.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T16:19:18Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038307694",
      "id" : 1038307694,
      "in_reply_to_id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII584941Fu",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1202746006,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038307694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T16:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038307694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038319639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038319639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah. As we only use `CoinsResult::Add` to append new coins: if we have the coin inside `CoinsResult`, and the coin has an effective value, then we must have `total_effective_amount`.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T16:32:11Z",
      "diff_hunk" : "@@ -106,7 +106,13 @@ void CoinsResult::Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher\n {\n     for (auto& [type, vec] : coins) {\n         auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n-            return coins_to_remove.count(coin.outpoint) == 1;\n+            // remove it if it's on the set\n+            if (coins_to_remove.count(coin.outpoint) == 0) return false;\n+\n+            // update cached amounts\n+            total_amount -= coin.txout.nValue;\n+            if (coin.HasEffectiveValue()) total_effective_amount = *total_effective_amount - coin.GetEffectiveValue();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038319639",
      "id" : 1038319639,
      "in_reply_to_id" : 1036411064,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII584944AX",
      "original_commit_id" : "a45ecd64ba4f63cba8d5f623a9442d81ccf63ac4",
      "original_line" : 114,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1202763464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038319639/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T16:32:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038319639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038322763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038322763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah ok, I used that term because the `nFeeRet` calculation prior to the SFFO process, can go insanely high based on the duplicated preset inputs, then we deduct it from the recipient's target.\r\nwill improve the documentation.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T16:35:53Z",
      "diff_hunk" : "@@ -112,5 +112,34 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verify that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 2; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+\n+    // Now that all coins were locked except the two preset inputs, let's create a tx\n+    std::vector<CRecipient> recipients = {{GetScriptForDestination(*Assert(wallet->GetNewDestination(OutputType::BECH32, \"dummy\"))), 149 * COIN, /*fSubtractFeeFromAmount=*/true}};\n+    CCoinControl coin_control;\n+    coin_control.m_allow_other_inputs = true;\n+    for (const auto& outpoint : preset_inputs) {\n+        coin_control.Select(outpoint);\n+    }\n+\n+    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038322763",
      "id" : 1038322763,
      "in_reply_to_id" : 1036387520,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584944xL",
      "original_commit_id" : "01d5cf9d1d65795edcd15efb0b2e7b8a22e0b778",
      "original_line" : 134,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1202768141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038322763/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T16:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038322763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038372600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T17:36:58Z",
      "diff_hunk" : "@@ -47,12 +47,14 @@ struct CoinsResult {\n      * i.e., methods can work with individual OutputType vectors or on the entire object */\n     size_t Size() const;\n     void Clear();\n-    void Erase(std::set<COutPoint>& preset_coins);\n+    void Erase(const std::unordered_set<COutPoint, SaltedOutpointHasher>& coins_to_remove);\n     void Shuffle(FastRandomContext& rng_fast);\n     void Add(OutputType type, const COutput& out);\n \n-    /** Sum of all available coins */\n+    /** Sum of all available coins raw value */\n     CAmount total_amount{0};\n+    /** Sum of all available coins effective value (each output value minus fees required to spend it) */\n+    std::optional<CAmount> total_effective_amount{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038372600",
      "id" : 1038372600,
      "in_reply_to_id" : 1036429162,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII58495E74",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 61,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 17,
      "pull_request_review_id" : 1202841958,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T17:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038372846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T17:37:15Z",
      "diff_hunk" : "@@ -112,5 +112,34 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verify that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 2; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+\n+    // Now that all coins were locked except the two preset inputs, let's create a tx\n+    std::vector<CRecipient> recipients = {{GetScriptForDestination(*Assert(wallet->GetNewDestination(OutputType::BECH32, \"dummy\"))), 149 * COIN, /*fSubtractFeeFromAmount=*/true}};\n+    CCoinControl coin_control;\n+    coin_control.m_allow_other_inputs = true;\n+    for (const auto& outpoint : preset_inputs) {\n+        coin_control.Select(outpoint);\n+    }\n+\n+    // First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038372846",
      "id" : 1038372846,
      "in_reply_to_id" : 1037315629,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58495E_u",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 134,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1202842285,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372846/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T17:37:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038372846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038373086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T17:37:33Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038373086",
      "id" : 1038373086,
      "in_reply_to_id" : 1037410273,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58495FDe",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1224,
      "original_position" : 32,
      "original_start_line" : 1205,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1202842629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373086/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-02T17:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038373248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated, thanks",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T17:37:43Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)\n+\n+        # Second case, don't use 'subtract_fee_from_outputs' to make the wallet crash due the insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038373248",
      "id" : 1038373248,
      "in_reply_to_id" : 1037410889,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58495FGA",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1259,
      "original_position" : 67,
      "original_start_line" : 1254,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1202842848,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-02T17:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038373248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038445723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038445723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, done thanks. Ready for another review round.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T19:08:29Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038445723",
      "id" : 1038445723,
      "in_reply_to_id" : 1037319314,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58495Wyb",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1255,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1202950392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038445723/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T19:24:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038445723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038451737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038451737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, updated per feedback. Thanks.\r\n\r\nSome context:\r\nThe \"insane fee\" label came from the `nFeeRet` calculation. Which, in case of this bug, sets a high value then is later deducted from the recipient's amount. Which.. as we spoke via dm, it's true that this is internal to the wallet only.. so the description should be something like \"double-counted preset inputs during Coin Selection incorrectly deduces the user's selected recipient's amount\" (or something similar)",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T19:17:54Z",
      "diff_hunk" : "@@ -1200,6 +1201,67 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # This exercises the bug presented in #26559 that\n+        # ended up on (1) a wallet crash or (2) a created and\n+        # broadcasted tx that pays an insane fee amount.\n+        #\n+        # This is covered by making the wallet selects the preset\n+        # inputs twice during the coin selection process (which\n+        # is a dangerous bug on v24.0).\n+        #\n+        # Making the wallet think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in\n+        # fee :(.\n+\n+        # Create and fund the wallet with 2 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(2):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs\n+        coins = wallet.listunspent()\n+        preset_inputs = [coins[0], coins[1]]\n+\n+        # Now let's create the tx\n+        options = {\n+            \"inputs\": [\n+                {\n+                    \"txid\": preset_inputs[0][\"txid\"],\n+                    \"vout\": preset_inputs[0][\"vout\"]\n+                },\n+                {\n+                    \"txid\": preset_inputs[1][\"txid\"],\n+                    \"vout\": preset_inputs[1][\"vout\"]\n+                },\n+            ],\n+            \"add_inputs\": True,\n+            \"subtract_fee_from_outputs\": [0],\n+            \"add_to_wallet\": False\n+        }\n+\n+        # First case, use 'subtract_fee_from_outputs' to make the wallet create a tx that pays an insane fee on v24.0.\n+        # (further details in #26559).\n+        assert_raises_rpc_error(-4, \"Insufficient funds\", wallet.send, outputs=[{wallet.getnewaddress(address_type=\"bech32\"): 14}], options=options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038451737",
      "id" : 1038451737,
      "in_reply_to_id" : 1037413633,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58495YQZ",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 1256,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 1202964187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038451737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T19:18:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038451737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038455258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038455258"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this relies on https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038307694 (where we are talking about whether should include the assertion commit here or in a follow-up PR).\r\nPlease, feel free to comment there.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T19:20:50Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038455258",
      "id" : 1038455258,
      "in_reply_to_id" : 1036421300,
      "line" : 455,
      "node_id" : "PRRC_kwDOABII58495ZHa",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 455,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1202967407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038455258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T19:20:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038455258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038529453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038529453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's find to change this to `Assume` for this PR. We should probably try to avoid asserts in general.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-02T21:01:13Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1038529453",
      "id" : 1038529453,
      "in_reply_to_id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII58495rOt",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1203077913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038529453/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T21:01:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038529453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1039260388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039260388"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll be fine with any of the following: keep asserts as I proposed, replaced them with `Assume` for this PR, remove the commit and address this in a follow up. With that said, here's my strong opinion held lightly.\r\n\r\nIn the absence of ability of returning error messages from coin selection we have only two options. So the question is what is better within the scope of this PR:\r\na) crash the node if assert is hit\r\nb) keep executing and potentially creating bad transactions.\r\n\r\nBoth are bad, but a) is strictly better, because recovering from a crash is much easier than from a bad tx. Replacing `assert`s and returning error messages could/should done in a follow up.\r\n\r\nNow I agree that in general the wallet should not ever crash the node, but for this we need a general mechanism, something like multiprocess.\r\n\r\nAlso, my original suggestion included check within `AddInput()` and `AddInputs()`, as `SelectionResult` is not designed to work with duplicated inputs. This would make the class safe and its interface consistent.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-05T07:53:10Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1039260388",
      "id" : 1039260388,
      "in_reply_to_id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII58498drk",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1204044729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039260388/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T07:53:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039260388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1039352959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039352959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Another alternative (not sure if applicable here) would be to throw an exception. This should only crash when running in the gui, but not when called from the RPC server.",
      "commit_id" : "7362f8e5e2497bc1ef27bfa871fc6dd306dd33c3",
      "created_at" : "2022-12-05T09:33:21Z",
      "diff_hunk" : "@@ -452,12 +452,16 @@ void SelectionResult::AddInputs(const std::set<COutput>& inputs, bool subtract_f\n \n void SelectionResult::Merge(const SelectionResult& other)\n {\n+    // Obtain the expected selected inputs count after the merge (for now, duplicates are not allowed)\n+    const size_t expected_count = m_selected_inputs.size() + other.m_selected_inputs.size();\n+\n     m_target += other.m_target;\n     m_use_effective |= other.m_use_effective;\n     if (m_algo == SelectionAlgorithm::MANUAL) {\n         m_algo = other.m_algo;\n     }\n     util::insert(m_selected_inputs, other.m_selected_inputs);\n+    assert(m_selected_inputs.size() == expected_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1039352959",
      "id" : 1039352959,
      "in_reply_to_id" : 1036936363,
      "line" : 464,
      "node_id" : "PRRC_kwDOABII584980R_",
      "original_commit_id" : "eb76557331b4f34b568da1d9c589c7005d7ab46d",
      "original_line" : 464,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 13,
      "pull_request_review_id" : 1204183376,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039352959/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T09:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039352959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
