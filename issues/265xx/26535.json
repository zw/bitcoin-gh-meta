{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Fixes #2039\r\n\r\nThis PR allows node operators to set file permissions on finalized blk files to be read-only.\r\n\r\nGenerally, we assume that the node can write to anything within the data directory. But, in this case, the finalized blk files don't need to be written to again. So, it might be useful to be able to set them as read-only.\r\n\r\nThis only makes sense with **finalized** block files as blk files that have logical space under the 128 MiB limit need to be writable for appending additional blocks.\r\n\r\nUsing read-only permissions had caused a problem while using `-reindex` because there was an unnecessary flush being performed on unmodified blk files within `BlockManager::FlushBlockFile`.\r\n\r\nThe flush would show up in logs in two ways:\r\n\r\n```\r\n2022-11-19T14:26:57Z [loadblk] Loaded 119965 blocks from external file in 3868921ms\r\n2022-11-19T14:26:57Z [loadblk] Reindexing block file blk00001.dat...\r\n2022-11-19T14:26:57Z [loadblk] Unable to open file /tmp/btc/blocks/blk00000.dat\r\n2022-11-19T14:26:57Z [loadblk] ERROR: Flush: failed to open file 0\r\n2022-11-19T14:26:57Z [loadblk] *** Flushing block file to disk failed. This is likely the result of an I/O error.\r\n2022-11-19T14:26:57Z [loadblk] Error: A fatal internal error occurred, see debug.log for details\r\n```\r\n\r\nor\r\n\r\n```\r\n2022-11-19T13:17:59Z [loadblk] [bench] FlushStateToDisk: write block and undo data to disk started\r\n2022-11-19T13:17:59Z [loadblk] Unable to open file /tmp/btc/blocks/blk00000.dat\r\n2022-11-19T13:17:59Z [loadblk] ERROR: Flush: failed to open file 0\r\n2022-11-19T13:17:59Z [loadblk] *** Flushing block file to disk failed. This is likely the result of an I/O error.\r\n2022-11-19T13:17:59Z [loadblk] Error: A fatal internal error occurred, see debug.log for details\r\n2022-11-19T13:18:14Z [loadblk] [bench] FlushStateToDisk: write block and undo data to disk completed (15582.56ms)\r\n2022-11-19T13:18:14Z [loadblk] [bench] FlushStateToDisk: write block index to disk started\r\n2022-11-19T13:18:14Z [loadblk] [leveldb] WriteBatch memory usage: db=index, before=0.0MiB, after=0.0MiB\r\n2022-11-19T13:18:14Z [loadblk] [bench] FlushStateToDisk: write block index to disk completed (4.38ms)\r\n```\r\n\r\nTo test these changes, you can grab some linearized test blk files over at https://github.com/mruddy/test_blk_files\r\nYou only need to import a handful of the files to test that the flush doesn't cause the problem anymore.\r\n\r\nOnce you have the files, setup with:\r\n\r\n```\r\nmkdir -p /tmp/btc && ./src/qt/bitcoin-qt -debug -logthreadnames -datadir=/tmp/btc -loadblock=/readonly/btc/main/blk{00000..00005}.dat -connect=0\r\n```\r\n\r\nWhen those are done importing, stop the node and run\r\n\r\n```\r\nchmod 0400 /tmp/btc/blocks/blk00000.dat\r\n```\r\n\r\nFinally, start the node again, and this time run the reindex and verify that the failure does not occur as will occur without this PR's patch.\r\n\r\n```\r\n./src/qt/bitcoin-qt -debug -logthreadnames -datadir=/tmp/btc -reindex -connect=0\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535/comments",
   "created_at" : "2022-11-19T17:17:46Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/26535",
   "id" : 1456585633,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585DSWnh",
   "number" : 26535,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/26535.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26535",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/26535.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26535"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535/timeline",
   "title" : "reindex: allow finalized blk files to use read-only permissions",
   "updated_at" : "2022-11-19T21:43:52Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26535",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
      "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mruddy/followers",
      "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mruddy",
      "id" : 6440430,
      "login" : "mruddy",
      "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
      "organizations_url" : "https://api.github.com/users/mruddy/orgs",
      "received_events_url" : "https://api.github.com/users/mruddy/received_events",
      "repos_url" : "https://api.github.com/users/mruddy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mruddy"
   }
}
