[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [w0xlt](https://github.com/bitcoin/bitcoin/pull/26595#pullrequestreview-1221251115), [furszy](https://github.com/bitcoin/bitcoin/pull/26595#pullrequestreview-1285181014), [john-moffett](https://github.com/bitcoin/bitcoin/pull/26595#pullrequestreview-1289995957), [ishaanam](https://github.com/bitcoin/bitcoin/pull/26595#pullrequestreview-1287712925) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26740](https://github.com/bitcoin/bitcoin/pull/26740) (wallet: Migrate wallets that are not in a wallet dir by achow101)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-11-28T23:46:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1329892598",
      "id" : 1329892598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585PRIz2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329892598/reactions"
      },
      "updated_at" : "2023-02-16T18:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329892598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-01T11:03:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1333588173",
      "id" : 1333588173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585PfPDN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1333588173/reactions"
      },
      "updated_at" : "2022-12-01T11:03:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1333588173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040296263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040296263"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 3aa48c855d05dc8f7dd43adc017b408064634f17 \"wallet: Allow MigrateLegacyToDescriptor to take a wallet name\"\r\n\r\nThis `error` isn't used here, it can be removed.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-06T01:18:06Z",
      "diff_hunk" : "@@ -4112,26 +4112,25 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n \n util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n {\n-    MigrationResult res;\n     bilingual_str error;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040296263",
      "id" : 1040296263,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-AalH",
      "original_commit_id" : "3aa48c855d05dc8f7dd43adc017b408064634f17",
      "original_line" : 4115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1205582870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040296263/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T03:43:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040296263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040327195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040327195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 433f9f8d7539efc26b952063d6127315606d248e \"rpc: Allow users to specify wallet name for migratewallet\"\r\n\r\nAn error should be thrown if no RPC endpoint wallet is specified and the `wallet_name` parameter isn't present. Otherwise the following error is thrown which is vague:\r\n> JSONRPCException: JSON value of type null is not of expected type string (-3)",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-06T01:31:48Z",
      "diff_hunk" : "@@ -727,16 +729,28 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                wallet_name = request.params[0].get_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040327195",
      "id" : 1040327195,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-AiIb",
      "original_commit_id" : "433f9f8d7539efc26b952063d6127315606d248e",
      "original_line" : 742,
      "original_position" : 26,
      "original_start_line" : 737,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1205582870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040327195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-06T03:43:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040327195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040393963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040393963"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 433f9f8d7539efc26b952063d6127315606d248e \"rpc: Allow users to specify wallet name for migratewallet\"\r\n\r\nThese lines don't seem to have any test coverage. Also, if `GetWallet` is unable to get the wallet, shouldn't an error be thrown at that point?",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-06T03:18:19Z",
      "diff_hunk" : "@@ -727,16 +729,28 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                wallet_name = request.params[0].get_str();\n             }\n \n             WalletContext& context = EnsureWalletContext(request.context);\n+            std::shared_ptr<CWallet> wallet = GetWallet(context, wallet_name);\n+            util::Result<MigrationResult> res;\n+            if (wallet) {\n+                if (wallet->IsCrypted()) {\n+                    throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+                }\n+\n+                res = MigrateLegacyToDescriptor(std::move(wallet), context);\n+            } else {\n+                res = MigrateLegacyToDescriptor(wallet_name, context);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1040393963",
      "id" : 1040393963,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-Aybr",
      "original_commit_id" : "433f9f8d7539efc26b952063d6127315606d248e",
      "original_line" : 759,
      "original_position" : 40,
      "original_start_line" : 750,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1205582870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040393963/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-06T03:43:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040393963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047668947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047668947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's being used by `MakeWalletDatabase`.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-13T19:54:55Z",
      "diff_hunk" : "@@ -4112,26 +4112,25 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n \n util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n {\n-    MigrationResult res;\n     bilingual_str error;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047668947",
      "id" : 1047668947,
      "in_reply_to_id" : 1040296263,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-cijT",
      "original_commit_id" : "3aa48c855d05dc8f7dd43adc017b408064634f17",
      "original_line" : 4115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1216330427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047668947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T19:54:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047668947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047676523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047676523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added an error.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-13T20:02:25Z",
      "diff_hunk" : "@@ -727,16 +729,28 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                wallet_name = request.params[0].get_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047676523",
      "id" : 1047676523,
      "in_reply_to_id" : 1040327195,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ckZr",
      "original_commit_id" : "433f9f8d7539efc26b952063d6127315606d248e",
      "original_line" : 742,
      "original_position" : 26,
      "original_start_line" : 737,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1216339747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047676523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-13T20:02:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047676523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047679943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047679943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> These lines don't seem to have any test coverage.\r\n\r\nTests are added in a later commit.\r\n\r\n> Also, if `GetWallet` is unable to get the wallet, shouldn't an error be thrown at that point?\r\n\r\nNo, `GetWallet` only looks for wallets that have been loaded. But it is necessary to be able to migrate wallets that are not currently loaded. `MigrateLegacyToDescriptor` will try loading the wallet and result in an error if it does not actually exist.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-13T20:05:56Z",
      "diff_hunk" : "@@ -727,16 +729,28 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                wallet_name = request.params[0].get_str();\n             }\n \n             WalletContext& context = EnsureWalletContext(request.context);\n+            std::shared_ptr<CWallet> wallet = GetWallet(context, wallet_name);\n+            util::Result<MigrationResult> res;\n+            if (wallet) {\n+                if (wallet->IsCrypted()) {\n+                    throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+                }\n+\n+                res = MigrateLegacyToDescriptor(std::move(wallet), context);\n+            } else {\n+                res = MigrateLegacyToDescriptor(wallet_name, context);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047679943",
      "id" : 1047679943,
      "in_reply_to_id" : 1040393963,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-clPH",
      "original_commit_id" : "433f9f8d7539efc26b952063d6127315606d248e",
      "original_line" : 759,
      "original_position" : 40,
      "original_start_line" : 750,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1216343903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047679943/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-13T20:05:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047679943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047706070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047706070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think that `MakeWalletDatabase` is directly run in this function, the `error` on src/wallet/wallet.cpp:4131 is used for that.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-13T20:29:34Z",
      "diff_hunk" : "@@ -4112,26 +4112,25 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n \n util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n {\n-    MigrationResult res;\n     bilingual_str error;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047706070",
      "id" : 1047706070,
      "in_reply_to_id" : 1040296263,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-crnW",
      "original_commit_id" : "3aa48c855d05dc8f7dd43adc017b408064634f17",
      "original_line" : 4115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1216377486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047706070/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T20:29:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047706070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047723192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047723192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, was looking at the wrong line. Removed.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-13T20:42:21Z",
      "diff_hunk" : "@@ -4112,26 +4112,25 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n \n util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n {\n-    MigrationResult res;\n     bilingual_str error;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1047723192",
      "id" : 1047723192,
      "in_reply_to_id" : 1040296263,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-cvy4",
      "original_commit_id" : "3aa48c855d05dc8f7dd43adc017b408064634f17",
      "original_line" : 4115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1216392504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047723192/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T20:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047723192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1050215249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050215249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "To fix failing CI:\r\n```suggestion\r\n        assert_raises_rpc_error(-8, \"Either RPC endpoint wallet or wallet_name parameter must be provided\", self.nodes[0].migratewallet)\r\n```",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-15T22:53:27Z",
      "diff_hunk" : "@@ -399,11 +399,47 @@ def test_pk_coinbases(self):\n     def test_encrypted(self):\n         self.log.info(\"Test migration of an encrypted wallet\")\n         wallet = self.create_legacy_wallet(\"encrypted\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n \n         wallet.encryptwallet(\"pass\")\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        assert_raises_rpc_error(-4, \"Error: Unable to produce descriptors for this legacy wallet. Make sure to provide the wallet's passphrase if it is encrypted.\", wallet.migratewallet)\n+\n+        wallet.migratewallet(passphrase=\"pass\")\n \n-        assert_raises_rpc_error(-15, \"Error: migratewallet on encrypted wallets is currently unsupported.\", wallet.migratewallet)\n-        # TODO: Fix migratewallet so that we can actually migrate encrypted wallets\n+        info = wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+        wallet.gettransaction(txid)\n+\n+        assert_equal(bals, wallet.getbalances())\n+\n+    def test_unloaded(self):\n+        self.log.info(\"Test migration of a wallet that isn't loaded\")\n+        wallet = self.create_legacy_wallet(\"notloaded\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        wallet.unloadwallet()\n+\n+        assert_raises_rpc_error(-8, \"RPC endpoint wallet and wallet_name parameter specify different wallets\", wallet.migratewallet, \"someotherwallet\")\n+        assert_raises_rpc_error(-8, \"Either RPC endpoint wallet or wallet_name parameter must be used\", self.nodes[0].migratewallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1050215249",
      "id" : 1050215249,
      "line" : 434,
      "node_id" : "PRRC_kwDOABII584-mQNR",
      "original_commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "original_line" : 434,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : 38,
      "pull_request_review_id" : 1220063915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050215249/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-15T22:53:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050215249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1050251449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050251449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This fixes the CI error.",
      "commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "created_at" : "2022-12-16T00:06:43Z",
      "diff_hunk" : "@@ -399,11 +399,47 @@ def test_pk_coinbases(self):\n     def test_encrypted(self):\n         self.log.info(\"Test migration of an encrypted wallet\")\n         wallet = self.create_legacy_wallet(\"encrypted\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n \n         wallet.encryptwallet(\"pass\")\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        assert_raises_rpc_error(-4, \"Error: Unable to produce descriptors for this legacy wallet. Make sure to provide the wallet's passphrase if it is encrypted.\", wallet.migratewallet)\n+\n+        wallet.migratewallet(passphrase=\"pass\")\n \n-        assert_raises_rpc_error(-15, \"Error: migratewallet on encrypted wallets is currently unsupported.\", wallet.migratewallet)\n-        # TODO: Fix migratewallet so that we can actually migrate encrypted wallets\n+        info = wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+        wallet.gettransaction(txid)\n+\n+        assert_equal(bals, wallet.getbalances())\n+\n+    def test_unloaded(self):\n+        self.log.info(\"Test migration of a wallet that isn't loaded\")\n+        wallet = self.create_legacy_wallet(\"notloaded\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        wallet.unloadwallet()\n+\n+        assert_raises_rpc_error(-8, \"RPC endpoint wallet and wallet_name parameter specify different wallets\", wallet.migratewallet, \"someotherwallet\")\n+        assert_raises_rpc_error(-8, \"Either RPC endpoint wallet or wallet_name parameter must be used\", self.nodes[0].migratewallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1050251449",
      "id" : 1050251449,
      "in_reply_to_id" : 1050215249,
      "line" : 434,
      "node_id" : "PRRC_kwDOABII584-mZC5",
      "original_commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "original_line" : 434,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : 38,
      "pull_request_review_id" : 1220114054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050251449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-16T00:06:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1050251449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1051002682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051002682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "8d957e3b2f56f07d1c0af1c843d396cc29aecb94",
      "created_at" : "2022-12-16T17:40:21Z",
      "diff_hunk" : "@@ -399,11 +399,47 @@ def test_pk_coinbases(self):\n     def test_encrypted(self):\n         self.log.info(\"Test migration of an encrypted wallet\")\n         wallet = self.create_legacy_wallet(\"encrypted\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n \n         wallet.encryptwallet(\"pass\")\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        assert_raises_rpc_error(-4, \"Error: Unable to produce descriptors for this legacy wallet. Make sure to provide the wallet's passphrase if it is encrypted.\", wallet.migratewallet)\n+\n+        wallet.migratewallet(passphrase=\"pass\")\n \n-        assert_raises_rpc_error(-15, \"Error: migratewallet on encrypted wallets is currently unsupported.\", wallet.migratewallet)\n-        # TODO: Fix migratewallet so that we can actually migrate encrypted wallets\n+        info = wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+        wallet.gettransaction(txid)\n+\n+        assert_equal(bals, wallet.getbalances())\n+\n+    def test_unloaded(self):\n+        self.log.info(\"Test migration of a wallet that isn't loaded\")\n+        wallet = self.create_legacy_wallet(\"notloaded\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        wallet.unloadwallet()\n+\n+        assert_raises_rpc_error(-8, \"RPC endpoint wallet and wallet_name parameter specify different wallets\", wallet.migratewallet, \"someotherwallet\")\n+        assert_raises_rpc_error(-8, \"Either RPC endpoint wallet or wallet_name parameter must be used\", self.nodes[0].migratewallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1051002682",
      "id" : 1051002682,
      "in_reply_to_id" : 1050215249,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-pQc6",
      "original_commit_id" : "424ee3e242f117c755991f5c306f925e3e0ba323",
      "original_line" : 434,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : null,
      "pull_request_review_id" : 1221225285,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051002682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-16T17:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051002682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1073473966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073473966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fae51d77:\r\n\r\nI'm not so sure about this, an empty `Result` is currently equal to `Error{}` but it's not defined anywhere. It might change in the future if we move away from using a variant.\r\n\r\nWould rather delete the empty constructor and force us to always set either the Error or the \"good\" object.",
      "commit_id" : "8d957e3b2f56f07d1c0af1c843d396cc29aecb94",
      "created_at" : "2023-01-18T12:30:56Z",
      "diff_hunk" : "@@ -41,6 +41,7 @@ class Result\n     friend bilingual_str ErrorString(const Result<FT>& result);\n \n public:\n+    Result() = default;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1073473966",
      "id" : 1073473966,
      "line" : 44,
      "node_id" : "PRRC_kwDOABII584_--mu",
      "original_commit_id" : "fae51d77c0f97b7161b872b0a4d139ca97e8fc4c",
      "original_line" : 44,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/util/result.h",
      "position" : 4,
      "pull_request_review_id" : 1253389075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073473966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T00:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073473966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1080661377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080661377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could be a const ref to avoid a copy.",
      "commit_id" : "8d957e3b2f56f07d1c0af1c843d396cc29aecb94",
      "created_at" : "2023-01-18T23:20:37Z",
      "diff_hunk" : "@@ -1006,8 +1006,8 @@ struct MigrationResult {\n };\n \n //! Do all steps to migrate a legacy wallet to a descriptor wallet\n-util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context);\n-util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, WalletContext& context);\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, SecureString passphrase, WalletContext& context);\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, SecureString passphrase, WalletContext& context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1080661377",
      "id" : 1080661377,
      "line" : 1010,
      "node_id" : "PRRC_kwDOABII585AaZWB",
      "original_commit_id" : "b44342298a4742569f02a9e02da6609f320b5c8e",
      "original_line" : 1010,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 7,
      "pull_request_review_id" : 1253389075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080661377/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T00:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080661377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1080669202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080669202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use the `Unlock` return value to know whether the passphrase is ok or not (failing early if not).\r\n\r\n```c++\r\n// Unlock the wallet if needed\r\nif (local_wallet->IsLocked() && !local_wallet->Unlock(passphrase)) {\r\n    return util::Error{Untranslated(\"Error: Wallet decryption failed, please provide the correct wallet's passphrase\")};\r\n}\r\n```\r\n\r\natm, this fails after doing the whole bdb -> sqlite migration.",
      "commit_id" : "8d957e3b2f56f07d1c0af1c843d396cc29aecb94",
      "created_at" : "2023-01-18T23:35:13Z",
      "diff_hunk" : "@@ -4161,6 +4161,9 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     {\n         LOCK(local_wallet->cs_wallet);\n \n+        // Unlock the wallet\n+        local_wallet->Unlock(passphrase);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1080669202",
      "id" : 1080669202,
      "line" : 4166,
      "node_id" : "PRRC_kwDOABII585AabQS",
      "original_commit_id" : "b44342298a4742569f02a9e02da6609f320b5c8e",
      "original_line" : 4166,
      "original_position" : 37,
      "original_start_line" : 4164,
      "path" : "src/wallet/wallet.cpp",
      "position" : 37,
      "pull_request_review_id" : 1253389075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080669202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4164,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-19T00:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080669202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> * Thinking that the `MigrateLegacyToDescriptor` overload isnât really needed, we only call this function from a single place which always receives a wallet name/path.\r\n>   Could instead decouple the âUnloadWalletForMigrationâ process into a separate function, and call it at the beginning of the migration process if `GetWallet(wallet_name)` returns a wallet. e.g. [furszy@456780b](https://github.com/furszy/bitcoin-core/commit/456780b255af490a6dd44e710184cf85106f5390)\r\n>   This would let us remove the added `Result` default constructor too.\r\n\r\nDone as suggested\r\n\r\n> * Would be good to add a test for a wallet migration by absolute path (the ânotloadedâ test provides the wallet dir name and relies on the wallet internals to detect it as a directory inside the wallets dir).\r\n\r\nAdded",
      "created_at" : "2023-01-24T22:36:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1402781811",
      "id" : 1402781811,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585TnMBz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1402781811/reactions"
      },
      "updated_at" : "2023-01-24T22:36:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1402781811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "9ec4b115cd870365870d30d41eb97788f407c3a8",
      "created_at" : "2023-01-24T22:36:25Z",
      "diff_hunk" : "@@ -41,6 +41,7 @@ class Result\n     friend bilingual_str ErrorString(const Result<FT>& result);\n \n public:\n+    Result() = default;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012690",
      "id" : 1086012690,
      "in_reply_to_id" : 1073473966,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Auz0S",
      "original_commit_id" : "fae51d77c0f97b7161b872b0a4d139ca97e8fc4c",
      "original_line" : 44,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/util/result.h",
      "position" : null,
      "pull_request_review_id" : 1268435366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-24T22:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "9ec4b115cd870365870d30d41eb97788f407c3a8",
      "created_at" : "2023-01-24T22:36:31Z",
      "diff_hunk" : "@@ -1006,8 +1006,8 @@ struct MigrationResult {\n };\n \n //! Do all steps to migrate a legacy wallet to a descriptor wallet\n-util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context);\n-util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, WalletContext& context);\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, SecureString passphrase, WalletContext& context);\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, SecureString passphrase, WalletContext& context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012745",
      "id" : 1086012745,
      "in_reply_to_id" : 1080661377,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Auz1J",
      "original_commit_id" : "b44342298a4742569f02a9e02da6609f320b5c8e",
      "original_line" : 1010,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1268435458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-24T22:36:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "9ec4b115cd870365870d30d41eb97788f407c3a8",
      "created_at" : "2023-01-24T22:36:36Z",
      "diff_hunk" : "@@ -4161,6 +4161,9 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     {\n         LOCK(local_wallet->cs_wallet);\n \n+        // Unlock the wallet\n+        local_wallet->Unlock(passphrase);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1086012796",
      "id" : 1086012796,
      "in_reply_to_id" : 1080669202,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Auz18",
      "original_commit_id" : "b44342298a4742569f02a9e02da6609f320b5c8e",
      "original_line" : 4162,
      "original_position" : 37,
      "original_start_line" : 4164,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1268435523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-24T22:36:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1086012796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased for a silent merge conflict.",
      "created_at" : "2023-01-25T18:16:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1404036117",
      "id" : 1404036117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585Tr-QV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1404036117/reactions"
      },
      "updated_at" : "2023-01-25T18:16:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1404036117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased for another silent merge conflict.",
      "created_at" : "2023-02-02T21:46:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1414418050",
      "id" : 1414418050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585UTk6C",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1414418050/reactions"
      },
      "updated_at" : "2023-02-02T21:46:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1414418050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added a commit to update the help text about encrypted wallets.",
      "created_at" : "2023-02-06T05:29:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1418540825",
      "id" : 1418540825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585UjTcZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1418540825/reactions"
      },
      "updated_at" : "2023-02-06T05:29:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1418540825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1099038619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099038619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In ee620e999a8ce269a90eee15b25988428e7620fd \" tests: Tests for migrating wallets by name, and providing passphrase \"\r\nIt would be useful to also test the behavior of the wallet encryption post-migration (eg. that `migratewallet` re-locks the wallet). A test for when the passphrase is provided but is incorrect could also be added here. A test for when the wallet name is provided but is incorrect could also be added.",
      "commit_id" : "3e521b2eb13799e11866562cfda4dc0bd3f7d6b9",
      "created_at" : "2023-02-07T18:20:27Z",
      "diff_hunk" : "@@ -400,11 +400,69 @@ def test_pk_coinbases(self):\n     def test_encrypted(self):\n         self.log.info(\"Test migration of an encrypted wallet\")\n         wallet = self.create_legacy_wallet(\"encrypted\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n \n         wallet.encryptwallet(\"pass\")\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        assert_raises_rpc_error(-4, \"Error: Wallet decryption failed, please provide the correct wallet's passphrase\", wallet.migratewallet)\n+\n+        wallet.migratewallet(passphrase=\"pass\")\n+\n+        info = wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+        wallet.gettransaction(txid)\n+\n+        assert_equal(bals, wallet.getbalances())\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1099038619",
      "id" : 1099038619,
      "line" : 424,
      "node_id" : "PRRC_kwDOABII585Bgf-b",
      "original_commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "original_line" : 424,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : 25,
      "pull_request_review_id" : 1287712925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099038619/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T04:07:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099038619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like this should also be backported to 24.x?",
      "created_at" : "2023-02-08T11:22:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1422438189",
      "id" : 1422438189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585UyK8t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1422438189/reactions"
      },
      "updated_at" : "2023-02-08T11:22:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1422438189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1100676840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100676840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: request.params[1]",
      "commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "created_at" : "2023-02-08T21:02:35Z",
      "diff_hunk" : "@@ -738,16 +741,27 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                if (request.params[0].isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Either RPC endpoint wallet or wallet_name parameter must be provided\");\n+                }\n+                wallet_name = request.params[0].get_str();\n             }\n \n-            WalletContext& context = EnsureWalletContext(request.context);\n+            // Note that the walletpassphrase is stored in request.params[1] which is not mlock()ed\n+            SecureString wallet_pass;\n+            wallet_pass.reserve(100);\n+            // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)\n+            // Alternately, find a way to make request.params[0] mlock()'d to begin with.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1100676840",
      "id" : 1100676840,
      "line" : 760,
      "node_id" : "PRRC_kwDOABII585Bmv7o",
      "original_commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "original_line" : 760,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : 42,
      "pull_request_review_id" : 1289995957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100676840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T21:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100676840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/116917595?v=4",
         "events_url" : "https://api.github.com/users/john-moffett/events{/privacy}",
         "followers_url" : "https://api.github.com/users/john-moffett/followers",
         "following_url" : "https://api.github.com/users/john-moffett/following{/other_user}",
         "gists_url" : "https://api.github.com/users/john-moffett/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/john-moffett",
         "id" : 116917595,
         "login" : "john-moffett",
         "node_id" : "U_kgDOBvgFWw",
         "organizations_url" : "https://api.github.com/users/john-moffett/orgs",
         "received_events_url" : "https://api.github.com/users/john-moffett/received_events",
         "repos_url" : "https://api.github.com/users/john-moffett/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/john-moffett/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/john-moffett/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/john-moffett"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1100700585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100700585"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Possibly for another PR (and possibly a dumb question), but why can't we do \r\n\r\n```c++\r\nif (!request.params[1].isNull()) wallet_pass.assign(request.params[1].get_str());\r\n```\r\n\r\nrather than use `.c_str()` (and in the other existing places)? This is supported since C++17.",
      "commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "created_at" : "2023-02-08T21:28:59Z",
      "diff_hunk" : "@@ -738,16 +741,27 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                if (request.params[0].isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Either RPC endpoint wallet or wallet_name parameter must be provided\");\n+                }\n+                wallet_name = request.params[0].get_str();\n             }\n \n-            WalletContext& context = EnsureWalletContext(request.context);\n+            // Note that the walletpassphrase is stored in request.params[1] which is not mlock()ed\n+            SecureString wallet_pass;\n+            wallet_pass.reserve(100);\n+            // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)\n+            // Alternately, find a way to make request.params[0] mlock()'d to begin with.\n+            wallet_pass = request.params[1].isNull() ? \"\" : request.params[1].get_str().c_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1100700585",
      "id" : 1100700585,
      "line" : 761,
      "node_id" : "PRRC_kwDOABII585Bm1up",
      "original_commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "original_line" : 761,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : 43,
      "pull_request_review_id" : 1289995957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100700585/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T21:29:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100700585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/116917595?v=4",
         "events_url" : "https://api.github.com/users/john-moffett/events{/privacy}",
         "followers_url" : "https://api.github.com/users/john-moffett/followers",
         "following_url" : "https://api.github.com/users/john-moffett/following{/other_user}",
         "gists_url" : "https://api.github.com/users/john-moffett/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/john-moffett",
         "id" : 116917595,
         "login" : "john-moffett",
         "node_id" : "U_kgDOBvgFWw",
         "organizations_url" : "https://api.github.com/users/john-moffett/orgs",
         "received_events_url" : "https://api.github.com/users/john-moffett/received_events",
         "repos_url" : "https://api.github.com/users/john-moffett/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/john-moffett/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/john-moffett/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/john-moffett"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1103485473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103485473"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n    // If the wallet is still loaded, unload it so that nothing else tries to use it while we're changing it\r\n```",
      "commit_id" : "3e521b2eb13799e11866562cfda4dc0bd3f7d6b9",
      "created_at" : "2023-02-11T02:25:09Z",
      "diff_hunk" : "@@ -4165,32 +4165,19 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n     return true;\n }\n \n-util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, WalletContext& context)\n {\n-    // Before anything else, check if there is something to migrate.\n-    if (!wallet->GetLegacyScriptPubKeyMan()) {\n-        return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n-    }\n-\n     MigrationResult res;\n     bilingual_str error;\n     std::vector<bilingual_str> warnings;\n \n-    // Make a backup of the DB\n-    std::string wallet_name = wallet->GetName();\n-    fs::path this_wallet_dir = fs::absolute(fs::PathFromString(wallet->GetDatabase().Filename())).parent_path();\n-    fs::path backup_filename = fs::PathFromString(strprintf(\"%s-%d.legacy.bak\", wallet_name, GetTime()));\n-    fs::path backup_path = this_wallet_dir / backup_filename;\n-    if (!wallet->BackupWallet(fs::PathToString(backup_path))) {\n-        return util::Error{_(\"Error: Unable to make a backup of your wallet\")};\n-    }\n-    res.backup_path = backup_path;\n-\n-    // Unload the wallet so that nothing else tries to use it while we're changing it\n-    if (!RemoveWallet(context, wallet, /*load_on_start=*/std::nullopt, warnings)) {\n-        return util::Error{_(\"Unable to unload the wallet before migrating\")};\n+    // If the wallet is still loaded, unload it wallet so that nothing else tries to use it while we're changing it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1103485473",
      "id" : 1103485473,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bxdoh",
      "original_commit_id" : "ca9bc8a222ffecc2ed6429925b9760cd6acad8b7",
      "original_line" : 4174,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1287712925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103485473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T04:07:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103485473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108881969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108881969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the passphrase handling to match what #27068 does",
      "commit_id" : "3e521b2eb13799e11866562cfda4dc0bd3f7d6b9",
      "created_at" : "2023-02-16T18:37:50Z",
      "diff_hunk" : "@@ -738,16 +741,27 @@ static RPCHelpMan migratewallet()\n         },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n         {\n-            std::shared_ptr<CWallet> wallet = GetWalletForJSONRPCRequest(request);\n-            if (!wallet) return NullUniValue;\n-\n-            if (wallet->IsCrypted()) {\n-                throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: migratewallet on encrypted wallets is currently unsupported.\");\n+            std::string wallet_name;\n+            if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {\n+                if (!(request.params[0].isNull() || request.params[0].get_str() == wallet_name)) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"RPC endpoint wallet and wallet_name parameter specify different wallets\");\n+                }\n+            } else {\n+                if (request.params[0].isNull()) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"Either RPC endpoint wallet or wallet_name parameter must be provided\");\n+                }\n+                wallet_name = request.params[0].get_str();\n             }\n \n-            WalletContext& context = EnsureWalletContext(request.context);\n+            // Note that the walletpassphrase is stored in request.params[1] which is not mlock()ed\n+            SecureString wallet_pass;\n+            wallet_pass.reserve(100);\n+            // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)\n+            // Alternately, find a way to make request.params[0] mlock()'d to begin with.\n+            wallet_pass = request.params[1].isNull() ? \"\" : request.params[1].get_str().c_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108881969",
      "id" : 1108881969,
      "in_reply_to_id" : 1100700585,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CGDIx",
      "original_commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "original_line" : 761,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1302067772,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108881969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-16T18:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108881969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108883010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108883010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It would be useful to also test the behavior of the wallet encryption post-migration (eg. that migratewallet re-locks the wallet).\r\n\r\nAdded a check for that.\r\n\r\n> A test for when the passphrase is provided but is incorrect could also be added here.\r\n\r\nDone\r\n\r\n> A test for when the wallet name is provided but is incorrect could also be added.\r\n\r\nThere's a test for that already in `test_unloaded`.",
      "commit_id" : "3e521b2eb13799e11866562cfda4dc0bd3f7d6b9",
      "created_at" : "2023-02-16T18:38:29Z",
      "diff_hunk" : "@@ -400,11 +400,69 @@ def test_pk_coinbases(self):\n     def test_encrypted(self):\n         self.log.info(\"Test migration of an encrypted wallet\")\n         wallet = self.create_legacy_wallet(\"encrypted\")\n+        default = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n \n         wallet.encryptwallet(\"pass\")\n+        addr = wallet.getnewaddress()\n+        txid = default.sendtoaddress(addr, 1)\n+        self.generate(self.nodes[0], 1)\n+        bals = wallet.getbalances()\n+\n+        assert_raises_rpc_error(-4, \"Error: Wallet decryption failed, please provide the correct wallet's passphrase\", wallet.migratewallet)\n+\n+        wallet.migratewallet(passphrase=\"pass\")\n+\n+        info = wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+        wallet.gettransaction(txid)\n+\n+        assert_equal(bals, wallet.getbalances())\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108883010",
      "id" : 1108883010,
      "in_reply_to_id" : 1099038619,
      "line" : 424,
      "node_id" : "PRRC_kwDOABII585CGDZC",
      "original_commit_id" : "3a6965d5606bb8e8f750341dfd6dac12aa7d4870",
      "original_line" : 424,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : 25,
      "pull_request_review_id" : 1302069281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108883010/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-16T18:38:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108883010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108884105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108884105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "3e521b2eb13799e11866562cfda4dc0bd3f7d6b9",
      "created_at" : "2023-02-16T18:39:10Z",
      "diff_hunk" : "@@ -4165,32 +4165,19 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\n     return true;\n }\n \n-util::Result<MigrationResult> MigrateLegacyToDescriptor(std::shared_ptr<CWallet>&& wallet, WalletContext& context)\n+util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& wallet_name, WalletContext& context)\n {\n-    // Before anything else, check if there is something to migrate.\n-    if (!wallet->GetLegacyScriptPubKeyMan()) {\n-        return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n-    }\n-\n     MigrationResult res;\n     bilingual_str error;\n     std::vector<bilingual_str> warnings;\n \n-    // Make a backup of the DB\n-    std::string wallet_name = wallet->GetName();\n-    fs::path this_wallet_dir = fs::absolute(fs::PathFromString(wallet->GetDatabase().Filename())).parent_path();\n-    fs::path backup_filename = fs::PathFromString(strprintf(\"%s-%d.legacy.bak\", wallet_name, GetTime()));\n-    fs::path backup_path = this_wallet_dir / backup_filename;\n-    if (!wallet->BackupWallet(fs::PathToString(backup_path))) {\n-        return util::Error{_(\"Error: Unable to make a backup of your wallet\")};\n-    }\n-    res.backup_path = backup_path;\n-\n-    // Unload the wallet so that nothing else tries to use it while we're changing it\n-    if (!RemoveWallet(context, wallet, /*load_on_start=*/std::nullopt, warnings)) {\n-        return util::Error{_(\"Unable to unload the wallet before migrating\")};\n+    // If the wallet is still loaded, unload it wallet so that nothing else tries to use it while we're changing it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#discussion_r1108884105",
      "id" : 1108884105,
      "in_reply_to_id" : 1103485473,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CGDqJ",
      "original_commit_id" : "ca9bc8a222ffecc2ed6429925b9760cd6acad8b7",
      "original_line" : 4174,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1302070911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26595",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108884105/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-16T18:39:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1108884105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Wallet file verification failed. Failed to load database path '/tmp/bitcoin_func_test_w3iehdpt/node0/regtest/wallets/wrong_wallet_name'. Path does not exist. (-4)\r\n> \r\n> It would make more sense to throw a simpler error from `migratewallet` (as opposed to from `MakeDatabase`).\r\n\r\nThis is the same error that we currently give for `loadwallet`. I'm going to leave it as is so these are consistent with each other, but I agree it could be improved.",
      "created_at" : "2023-02-16T18:40:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26595#issuecomment-1433550228",
      "id" : 1433550228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26595",
      "node_id" : "IC_kwDOABII585Vcj2U",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1433550228/reactions"
      },
      "updated_at" : "2023-02-16T18:40:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1433550228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
