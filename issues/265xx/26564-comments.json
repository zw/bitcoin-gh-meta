[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/26564).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [tdb3](https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962323104), [cbergqvist](https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962364915) |\n| Concept ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/26564#pullrequestreview-1192987059), [kouloumos](https://github.com/bitcoin/bitcoin/pull/26564#pullrequestreview-1280558321), [RandyMcMillan](https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1832754358) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "created_at" : "2022-11-24T02:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1325860135",
      "id" : 1325860135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PBwUn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325860135/reactions"
      },
      "updated_at" : "2024-02-24T13:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325860135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031135642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031135642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "pretty sure this will break when running in parallel.\r\n\r\nWhat about a --nocleanup option, like the one in the functional test framework, if the goal is to not delete the dir?",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T07:31:02Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031135642",
      "id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849deGa",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1192635762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031135642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T07:31:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031135642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031393993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031393993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Useful to specify which tests this affects?",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T11:17:15Z",
      "diff_hunk" : "@@ -53,6 +53,11 @@ The `-printtoconsole=1` after the two dashes redirects the debug log, which\n would normally go to a file in the test datadir\n (`BasicTestingSetup::m_path_root`), to the standard terminal output.\n \n+The `TEST_BITCOIN_PATH` environment variable, if set, determines the\n+location of the test datadir, which is recreated for each individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031393993",
      "id" : 1031393993,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849edLJ",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 57,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/README.md",
      "position" : 5,
      "pull_request_review_id" : 1192987059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031393993/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T11:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031393993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031394461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031394461"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's helpful to have all env vars start with `BITCOIN_`\r\n```suggestion\r\nThe `BITCOIN_TEST_PATH` environment variable, if set, determines the\r\n```",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T11:17:43Z",
      "diff_hunk" : "@@ -53,6 +53,11 @@ The `-printtoconsole=1` after the two dashes redirects the debug log, which\n would normally go to a file in the test datadir\n (`BasicTestingSetup::m_path_root`), to the standard terminal output.\n \n+The `TEST_BITCOIN_PATH` environment variable, if set, determines the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031394461",
      "id" : 1031394461,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII5849edSd",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 56,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/README.md",
      "position" : 4,
      "pull_request_review_id" : 1192987059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031394461/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T11:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031394461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031401722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031401722"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if this would work, but what about checking the datadir lock before removing it, e.g. with `util/system.cpp::LockDirectory`?",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T11:26:02Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031401722",
      "id" : 1031401722,
      "in_reply_to_id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849efD6",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1192987059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031401722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T11:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031401722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031532953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031532953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To explain, tests running in parallel can not share a data directory. With rand256, each test gets a unique one. However, with `TEST_BITCOIN_PATH` all tests get the same one.",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T13:48:43Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031532953",
      "id" : 1031532953,
      "in_reply_to_id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849e_GZ",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1193188840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031532953/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T13:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031532953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031546227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031546227"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I know, my suggestion was rather: since this is an advanced setting, we could let the user handle making sure that there are no tests running in parallel, but just add a simple check in case they aren't aware/mistaken (by checking the datadir lock)? ",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T14:02:07Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031546227",
      "id" : 1031546227,
      "in_reply_to_id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849fCVz",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1193208348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031546227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T14:02:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031546227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031730173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031730173"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> What about a --nocleanup option ... if the goal is to not delete the dir?\r\n\r\nYes, but also to have a fixed data directory path, so I can open its `debug.log` in an editor, and re-read the file as the test runs and after the test completes. (Or better yet, set the editor to automatically re-read if possible, which I do with `vim`.) Then if I run the test again, I can re-read the file again, without having to open a different file. \r\n\r\nBut I think specifying this environment variable can also indicate not to delete the directory when the test completes; you wouldn't want to do this normally because the disk usage would continuously increase as you run the test repeatedly. If instead you specify a fixed directory, then disk usage doesn't grow as you repeatedly run tests, so it's okay for the test not to delete it at the end.\r\n\r\n> tests running in parallel can not share a data directory\r\n\r\nYes, you definitely wouldn't specify this to multiple tests running in parallel. I would only use this when I'm running a single test that I'm trying to understand or debug. That is, I definitely would not set this environment variable in my `.bashrc`! (I could improve the doc changes to make that clear.) The default is to use separate directories (as today). \r\n\r\n> ... checking the datadir lock ...\r\n\r\nThe unit tests don't create a lock file; only `bitcoind` does that. The unit tests don't actually create a full datadir, only some parts of it, and can also create extra files that aren't normally in a datadir. (That's why I called it a working dir in the title and description, instead of a datadir, although the test `README` does call it a datadir.)\r\n\r\nI don't think it's worth adding a lock file; I think users of this will be advanced enough to understand that multiple tests can't simultaneously share the same work directory.",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T17:22:01Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031730173",
      "id" : 1031730173,
      "in_reply_to_id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849fvP9",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1193471551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031730173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T17:22:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031730173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031731565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031731565"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do you mean which executables (as this PR's description does, bench, fuzz)? That's a good idea, I can add this text (or similar) to the READMEs for those too.",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T17:24:36Z",
      "diff_hunk" : "@@ -53,6 +53,11 @@ The `-printtoconsole=1` after the two dashes redirects the debug log, which\n would normally go to a file in the test datadir\n (`BasicTestingSetup::m_path_root`), to the standard terminal output.\n \n+The `TEST_BITCOIN_PATH` environment variable, if set, determines the\n+location of the test datadir, which is recreated for each individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031731565",
      "id" : 1031731565,
      "in_reply_to_id" : 1031393993,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849fvlt",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 57,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/README.md",
      "position" : 5,
      "pull_request_review_id" : 1193473352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031731565/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T17:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031731565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031732504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031732504"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea, I named it that way because the executable is called `test_bitcoin` but that's not a strong reason. I'll make that change.",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T17:26:18Z",
      "diff_hunk" : "@@ -53,6 +53,11 @@ The `-printtoconsole=1` after the two dashes redirects the debug log, which\n would normally go to a file in the test datadir\n (`BasicTestingSetup::m_path_root`), to the standard terminal output.\n \n+The `TEST_BITCOIN_PATH` environment variable, if set, determines the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031732504",
      "id" : 1031732504,
      "in_reply_to_id" : 1031394461,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII5849fv0Y",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 56,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/README.md",
      "position" : 4,
      "pull_request_review_id" : 1193474584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031732504/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T17:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031732504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031735601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031735601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, sgtm",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-24T17:30:52Z",
      "diff_hunk" : "@@ -98,7 +98,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n+    : m_path_root{std::getenv(\"TEST_BITCOIN_PATH\") ?\n+                      std::getenv(\"TEST_BITCOIN_PATH\") :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1031735601",
      "id" : 1031735601,
      "in_reply_to_id" : 1031135642,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII5849fwkx",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 6,
      "pull_request_review_id" : 1193478663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031735601/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T17:30:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031735601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1032513174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032513174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yep pretty much what you did in the PR description",
      "commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "created_at" : "2022-11-25T14:37:11Z",
      "diff_hunk" : "@@ -53,6 +53,11 @@ The `-printtoconsole=1` after the two dashes redirects the debug log, which\n would normally go to a file in the test datadir\n (`BasicTestingSetup::m_path_root`), to the standard terminal output.\n \n+The `TEST_BITCOIN_PATH` environment variable, if set, determines the\n+location of the test datadir, which is recreated for each individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1032513174",
      "id" : 1032513174,
      "in_reply_to_id" : 1031393993,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849iuaW",
      "original_commit_id" : "bc32016e581c52ee404ab795a6ea43291ad3a198",
      "original_line" : 57,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/README.md",
      "position" : 5,
      "pull_request_review_id" : 1194525020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032513174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-25T14:37:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032513174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed to incorporate two review suggestions (thanks!):\r\n- add description to the other README files (benchmark, fuzz, qt)\r\n- rename `TEST_BITCOIN_PATH` to `BITCOIN_TEST_PATH`",
      "created_at" : "2022-11-25T20:43:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1327874880",
      "id" : 1327874880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PJcNA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1327874880/reactions"
      },
      "updated_at" : "2022-11-25T20:43:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1327874880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">If the environment variable BITCOIN_TEST_PATH is set, use its value as the test's working directory, rather than a randomly-named path in /tmp/test_common_Bitcoin\\ Core/\r\n>When the test starts, remove the working directory if it exists\r\n\r\nThis combination seems dangerous... :/",
      "created_at" : "2022-11-26T08:41:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328007192",
      "id" : 1328007192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PJ8gY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328007192/reactions"
      },
      "updated_at" : "2022-11-26T08:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328007192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr\r\n> This combination seems dangerous... :/\r\n\r\nIf the concern is that someone may specify a real data directory by mistake, that's a good point! A real datadir has a `.lock` file, whether `bitcoind` is running or not. This file will never exist in one of these unit test work directories (I verified that by running all the tests, and also by source code inspection starting with `\".lock\"`).\r\n\r\nI just force-pushed code to exit without removing the work directory if contains `.lock`, for example:\r\n```\r\n$ BITCOIN_TEST_PATH=~/.bitcoin src/test/test_bitcoin --run_test=getarg_tests/logargs\r\nRunning 1 test case...\r\nunknown location(0): fatal error: in \"getarg_tests/logargs\": std::runtime_error: .lock exists, not using possible real data directory\r\ntest/getarg_tests.cpp(423): last checkpoint: \"logargs\" fixture ctor\r\n\r\n*** 1 failure is detected in the test module \"Bitcoin Core Test Suite\"\r\n$ \r\n```\r\nDoes this address your concern? Is there a better way to report the error?",
      "created_at" : "2022-11-26T18:12:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328091116",
      "id" : 1328091116,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PKQ_s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328091116/reactions"
      },
      "updated_at" : "2022-11-26T18:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328091116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not quite, I'm more concerned about a situation where `BITCOIN_TEST_PATH` might be `/home/user` or something else weird. While it's a crazy user error, nobody expects setting an env variable would nuke a path.",
      "created_at" : "2022-11-27T07:54:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328190540",
      "id" : 1328190540,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PKpRM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328190540/reactions"
      },
      "updated_at" : "2022-11-27T07:54:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328190540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Not quite, I'm more concerned about a situation where `BITCOIN_TEST_PATH` might be `/home/user` or something else weird. While it's a crazy user error, nobody expects setting an env variable would nuke a path.\r\n\r\nAnother great point! Force-pushed a change (c48a1b4c6949af4e610035d037c6195bc22904ca) so that the environment variable only replaces the random path component _within_ `/tmp/test_common_Bitcoin\\ Core/mydatadir/`. The specified path must be relative. All I care about is that the datadir has a fixed name (across multiple test runs). This should now be very safe. (Also removed the check for `.lock`, not needed.) I'll update the description now too.\r\n\r\n```bash\r\n$ BITCOIN_TEST_PATH=mydatadir src/test/test_bitcoin --run_test=getarg_tests/doubledash\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n$ ls -l /tmp/test_common_Bitcoin\\ Core/mydatadir/\r\ntotal 8\r\ndrwxrwxr-x 2 larry larry 4096 Nov 27 22:45 blocks\r\n-rw-rw-r-- 1 larry larry 1003 Nov 27 22:45 debug.log\r\n$ \r\n```\r\n",
      "created_at" : "2022-11-28T06:03:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328583668",
      "id" : 1328583668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585PMJP0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328583668/reactions"
      },
      "updated_at" : "2022-11-28T06:03:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1328583668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033228008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033228008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe just use a hardcoded path item like `\"fixed\"` and turn the env into a flag? This should be fine, because anyone can still modify the root temp dir.",
      "commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "created_at" : "2022-11-28T08:07:54Z",
      "diff_hunk" : "@@ -98,9 +98,20 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+    : m_args{}\n {\n+    char* test_path_env{std::getenv(\"BITCOIN_TEST_PATH\")};\n+    std::string test_path;\n+    if (test_path_env == nullptr) {\n+        test_path = g_insecure_rand_ctx_temp_path.rand256().ToString();\n+    } else {\n+        test_path = test_path_env;\n+        if (fs::PathFromString(test_path).is_absolute()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033228008",
      "id" : 1033228008,
      "line" : 109,
      "node_id" : "PRRC_kwDOABII5849lc7o",
      "original_commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "original_line" : 109,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 14,
      "pull_request_review_id" : 1195352428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033228008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T08:07:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033228008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033779220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033779220"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I know this sounds a little far-fetched, but I have actually done the following: I have two test binaries, one from a PR branch and the other from master, and the test fails on the PR branch but passes on master. I've single-stepped through the tests simultaneously (in sync) comparing them to see what happens leading up to the failure. In this case, it would be convenient to have two different fixed data directories (if I needed to restart the test many times) because I also want to watch the two `debug.log` files.\r\n\r\nAlso, as long as we're going to the trouble of implementing and documenting an environment variable, it's no extra work to make it a value instead of a flag.",
      "commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "created_at" : "2022-11-28T16:39:14Z",
      "diff_hunk" : "@@ -98,9 +98,20 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+    : m_args{}\n {\n+    char* test_path_env{std::getenv(\"BITCOIN_TEST_PATH\")};\n+    std::string test_path;\n+    if (test_path_env == nullptr) {\n+        test_path = g_insecure_rand_ctx_temp_path.rand256().ToString();\n+    } else {\n+        test_path = test_path_env;\n+        if (fs::PathFromString(test_path).is_absolute()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033779220",
      "id" : 1033779220,
      "in_reply_to_id" : 1033228008,
      "line" : 109,
      "node_id" : "PRRC_kwDOABII5849njgU",
      "original_commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "original_line" : 109,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 14,
      "pull_request_review_id" : 1196154089,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033779220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T16:39:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033779220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033789621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033789621"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that is still possible. You can set `TMPDIR=/tmp/1`, see https://en.cppreference.com/w/cpp/filesystem/temp_directory_path\r\n\r\nNot sure if relevant, but `BITCOIN_TEST_PATH=../../home/user` will still delete your home dir.",
      "commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "created_at" : "2022-11-28T16:48:38Z",
      "diff_hunk" : "@@ -98,9 +98,20 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+    : m_args{}\n {\n+    char* test_path_env{std::getenv(\"BITCOIN_TEST_PATH\")};\n+    std::string test_path;\n+    if (test_path_env == nullptr) {\n+        test_path = g_insecure_rand_ctx_temp_path.rand256().ToString();\n+    } else {\n+        test_path = test_path_env;\n+        if (fs::PathFromString(test_path).is_absolute()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033789621",
      "id" : 1033789621,
      "in_reply_to_id" : 1033228008,
      "line" : 109,
      "node_id" : "PRRC_kwDOABII5849nmC1",
      "original_commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "original_line" : 109,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 14,
      "pull_request_review_id" : 1196168874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033789621/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T16:48:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033789621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033913225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033913225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch! I just force-pushed an update to require that `BITCOIN_TEST_PATH` doesn't contain the separator character. That should take care of both problems. I would say that if the user has set `TMPDIR`, it should be safe to delete the given directory, even if it's within the user's home directory, since paths containing `../` are no longer allowed.\r\n```\r\n$ BITCOIN_TEST_PATH=../mydatadir src/test/test_bitcoin --run_test=getarg_tests/doubledash\r\nRunning 1 test case...\r\nunknown location(0): fatal error: in \"getarg_tests/doubledash\": std::runtime_error: BITCOIN_TEST_PATH cannot contain path separators\r\ntest/getarg_tests.cpp(380): last checkpoint: \"doubledash\" fixture ctor\r\n\r\n*** 1 failure is detected in the test module \"Bitcoin Core Test Suite\"\r\n$\r\n```",
      "commit_id" : "8aee8b42c3cf4af44f86d249770bf7cb043387ee",
      "created_at" : "2022-11-28T18:31:00Z",
      "diff_hunk" : "@@ -98,9 +98,20 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+    : m_args{}\n {\n+    char* test_path_env{std::getenv(\"BITCOIN_TEST_PATH\")};\n+    std::string test_path;\n+    if (test_path_env == nullptr) {\n+        test_path = g_insecure_rand_ctx_temp_path.rand256().ToString();\n+    } else {\n+        test_path = test_path_env;\n+        if (fs::PathFromString(test_path).is_absolute()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1033913225",
      "id" : 1033913225,
      "in_reply_to_id" : 1033228008,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849oEOJ",
      "original_commit_id" : "c48a1b4c6949af4e610035d037c6195bc22904ca",
      "original_line" : 109,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1196348550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033913225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T18:31:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033913225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1094240144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094240144"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just from this note, I did not realize that running \r\n```\r\nBITCOIN_TEST_PATH=mydatadir test_bitcoin --run_test=getarg_tests\r\n```\r\nis also not optimal because each `BOOST_AUTO_TEST_CASE` overrides the previous directory. And the same goes for running benchmarks with a `--filter=`. Which I think does not fall under \"multiple simultaneous instances of\" `test_bitcoin` or `bench_bitcoin`.\r\n\r\nI don't think that this is bad, just that it should be more explicitly stated that using this env variable is mostly suitable for running single benchmarks/test cases.\r\n\r\nI am not familiar with fuzzing, therefore I haven't verified if the same applies there.",
      "commit_id" : "8aee8b42c3cf4af44f86d249770bf7cb043387ee",
      "created_at" : "2023-02-02T09:22:17Z",
      "diff_hunk" : "@@ -41,17 +41,47 @@ test_bitcoin --log_level=all --run_test=getarg_tests\n ```\n \n `log_level` controls the verbosity of the test framework, which logs when a\n-test case is entered, for example. `test_bitcoin` also accepts the command\n-line arguments accepted by `bitcoind`. Use `--` to separate both types of\n-arguments:\n+test case is entered, for example.\n+\n+Both `test_bitcoin` and `test_bitcoin-qt` create a temporary test working\n+or data directory within `/tmp/test_common_Bitcoin Core/`. This data\n+directory looks like a simplified form of the standard `bitcoind` data\n+directory; content will vary depending on the test, but it will always\n+have a `debug.log` file, for example.\n+\n+By default the directory is named as a random string (different for each\n+run), but this can be overridden with the `BITCOIN_TEST_PATH` environment\n+variable. Be careful not to run multiple simultaneous instances of\n+`test_bitcoin` that share the same test data directory; they'll conflict\n+with each other.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1094240144",
      "id" : 1094240144,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII585BOMeQ",
      "original_commit_id" : "8aee8b42c3cf4af44f86d249770bf7cb043387ee",
      "original_line" : 56,
      "original_position" : 19,
      "original_start_line" : 54,
      "path" : "src/test/README.md",
      "position" : 19,
      "pull_request_review_id" : 1280558321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094240144/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 54,
      "start_side" : "RIGHT",
      "updated_at" : "2023-02-02T10:39:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094240144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1094286912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094286912"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe give a hint to the user on where to look for the test directory, the same way that the functional test framework is doing it. It could be done with `g_print_dir = true` and then here\r\n```suggestion\r\n    if (std::getenv(\"BITCOIN_TEST_PATH\") && g_print_dir) {\r\n        std::cout << \"Test directory: \" << m_path_root << \"\\n\"\r\n        g_print_dir = false\r\n    } \r\n```\r\n\r\nI was initially thinking that this could be part of the destructor but, per [my other comment](https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1094240144), that can lead to multiple redundant prints.\r\n",
      "commit_id" : "8aee8b42c3cf4af44f86d249770bf7cb043387ee",
      "created_at" : "2023-02-02T09:51:25Z",
      "diff_hunk" : "@@ -98,9 +98,20 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n-    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+    : m_args{}\n {\n+    char* test_path_env{std::getenv(\"BITCOIN_TEST_PATH\")};\n+    std::string test_path;\n+    if (test_path_env == nullptr) {\n+        test_path = g_insecure_rand_ctx_temp_path.rand256().ToString();\n+    } else {\n+        test_path = test_path_env;\n+        if (test_path.find(fs::path::preferred_separator) != std::string::npos) {\n+            throw std::runtime_error(\"BITCOIN_TEST_PATH cannot contain path separators\");\n+        }\n+    }\n+    m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / test_path;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1094286912",
      "id" : 1094286912,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII585BOX5A",
      "original_commit_id" : "8aee8b42c3cf4af44f86d249770bf7cb043387ee",
      "original_line" : 114,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 19,
      "pull_request_review_id" : 1280558321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094286912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-02T10:40:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094286912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are you still working on this?",
      "created_at" : "2023-04-25T16:02:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1522051059",
      "id" : 1522051059,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585auKfz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1522051059/reactions"
      },
      "updated_at" : "2023-04-25T16:02:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1522051059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, still hoping to get this merged. Force-pushed 5df0ed5ab789e005cb9aa0fc3ab61b7ce0b80ec8 to rebase onto the latest master (since it's been a long time)",
      "created_at" : "2023-04-27T17:00:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1526037535",
      "id" : 1526037535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585a9Xwf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1526037535/reactions"
      },
      "updated_at" : "2023-04-27T17:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1526037535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Another force push to improve the doc slightly and to address review comments, thanks @kouloumos!\r\n\r\nReady for review, also ping @theStack.",
      "created_at" : "2023-04-27T17:12:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1526052311",
      "id" : 1526052311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585a9bXX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1526052311/reactions"
      },
      "updated_at" : "2023-04-27T17:12:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1526052311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased for merge conflict.",
      "created_at" : "2023-06-11T22:38:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1586362907",
      "id" : 1586362907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585ejfob",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1586362907/reactions"
      },
      "updated_at" : "2023-06-11T22:38:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1586362907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could rebase for fresh CI?",
      "created_at" : "2023-11-27T13:34:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1827844066",
      "id" : 1827844066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585s8q_i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1827844066/reactions"
      },
      "updated_at" : "2023-11-27T13:34:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1827844066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1408489618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408489618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What about creating a pid file during init and removing it during shutdown? Failing early if the file already exist.",
      "commit_id" : "4be0734ff80e1de54185b3bc117142bf915b3b76",
      "created_at" : "2023-11-28T22:21:33Z",
      "diff_hunk" : "@@ -36,6 +36,14 @@ The output will look similar to:\n ...\n ```\n \n+Some benchmarks create a test data directory within\n+`test_common_Bitcoin Core/`, which is within the system's temporary directory\n+(for example, `/tmp`). By default the directory is\n+named as a random string, but this can be\n+overridden with the `BITCOIN_TEST_PATH` environment variable.\n+Be careful not to run multiple simultaneous instances of `bench_bitcoin`\n+that share the same test data directory; they'll conflict with each other.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1408489618",
      "id" : 1408489618,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585T89iS",
      "original_commit_id" : "4be0734ff80e1de54185b3bc117142bf915b3b76",
      "original_line" : 45,
      "original_position" : 25,
      "original_start_line" : 44,
      "path" : "doc/benchmarking.md",
      "position" : 25,
      "pull_request_review_id" : 1754057428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408489618/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-28T22:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408489618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1408502548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408502548"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, perhaps even better, maybe the test startup code can call `LockDirectory()` like `bitcoind` does. I'll see if I can get that to work, thanks for the suggestion!",
      "commit_id" : "4be0734ff80e1de54185b3bc117142bf915b3b76",
      "created_at" : "2023-11-28T22:38:09Z",
      "diff_hunk" : "@@ -36,6 +36,14 @@ The output will look similar to:\n ...\n ```\n \n+Some benchmarks create a test data directory within\n+`test_common_Bitcoin Core/`, which is within the system's temporary directory\n+(for example, `/tmp`). By default the directory is\n+named as a random string, but this can be\n+overridden with the `BITCOIN_TEST_PATH` environment variable.\n+Be careful not to run multiple simultaneous instances of `bench_bitcoin`\n+that share the same test data directory; they'll conflict with each other.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1408502548",
      "id" : 1408502548,
      "in_reply_to_id" : 1408489618,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585T9AsU",
      "original_commit_id" : "4be0734ff80e1de54185b3bc117142bf915b3b76",
      "original_line" : 45,
      "original_position" : 25,
      "original_start_line" : 44,
      "path" : "doc/benchmarking.md",
      "position" : 25,
      "pull_request_review_id" : 1754077923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408502548/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-28T22:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408502548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added commit ed37d296ba0a17daaf3334a011398ce05b30d69c to implement review suggestion https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1408489618, thank you, @furszy!",
      "created_at" : "2023-11-29T17:02:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1832343450",
      "id" : 1832343450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585tN1ea",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832343450/reactions"
      },
      "updated_at" : "2023-11-29T17:02:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832343450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-11-29T18:35:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1832487874",
      "id" : 1832487874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585tOYvC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832487874/reactions"
      },
      "updated_at" : "2023-11-29T18:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832487874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed a4bd4c490c140b7f59dc98664f1a0996087cf43d to fix merge conflict, and 567ce8bfecfc674b8f68613bfdfe6ddd55310769 to fix Windows CI failure (I think the problem was that we were trying to remove the data directory while still holding the `.lock` file open, which isn't allowed in Windows).",
      "created_at" : "2023-11-29T21:07:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1832701464",
      "id" : 1832701464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585tPM4Y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832701464/reactions"
      },
      "updated_at" : "2023-11-29T21:07:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832701464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T21:49:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1832754358",
      "id" : 1832754358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585tPZy2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832754358/reactions"
      },
      "updated_at" : "2023-11-29T21:49:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832754358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/152159?v=4",
         "events_url" : "https://api.github.com/users/RandyMcMillan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/RandyMcMillan/followers",
         "following_url" : "https://api.github.com/users/RandyMcMillan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/RandyMcMillan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/RandyMcMillan",
         "id" : 152159,
         "login" : "RandyMcMillan",
         "node_id" : "MDQ6VXNlcjE1MjE1OQ==",
         "organizations_url" : "https://api.github.com/users/RandyMcMillan/orgs",
         "received_events_url" : "https://api.github.com/users/RandyMcMillan/received_events",
         "repos_url" : "https://api.github.com/users/RandyMcMillan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/RandyMcMillan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/RandyMcMillan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/RandyMcMillan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, @furszy, I reworked your commit a bit, that was a big help! It did mean dropping support for `fuzz`, `bench_bitcoin`, and `test_bitcoin-qt` but this change really only benefits `test_bitcoin` (in my view). This PR is ready to review. Note the updated PR title and description.",
      "created_at" : "2023-12-08T00:20:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1846306653",
      "id" : 1846306653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585uDGdd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1846306653/reactions"
      },
      "updated_at" : "2023-12-08T00:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1846306653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1419817421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419817421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 5dd89adbc:\r\nCan drop this now. Custom test data directories are not deleted anymore.\r\n\r\nThis is good for running test on a different storage location. Not only on the OS temporary files directory.",
      "commit_id" : "0324942a7401416f572132d82055017cb6db749a",
      "created_at" : "2023-12-08T01:13:25Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1419817421",
      "id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UoLHN",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 144,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1771368553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419817421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-08T01:17:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1419817421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420176846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420176846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe submit this (bugfix? or change?) in a separate pull?",
      "commit_id" : "0324942a7401416f572132d82055017cb6db749a",
      "created_at" : "2023-12-08T09:35:56Z",
      "diff_hunk" : "@@ -8,12 +8,12 @@ thread queue, wallet balance.\n Running\n ---------------------\n \n-For benchmarking, you only need to compile `bitcoin_bench`.  The bench runner\n+For benchmarking, you only need to compile `bench_bitcoin`.  The bench runner\n warns if you configure with `--enable-debug`, but consider if building without\n it will impact the benchmark(s) you are interested in by unlatching log printers\n and lock analysis.\n \n-    make -C src bitcoin_bench\n+    make -C src bench/bench_bitcoin",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420176846",
      "id" : 1420176846,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585Upi3O",
      "original_commit_id" : "0324942a7401416f572132d82055017cb6db749a",
      "original_line" : 16,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "doc/benchmarking.md",
      "position" : 11,
      "pull_request_review_id" : 1771966521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420176846/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-08T09:35:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420176846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420774368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420774368"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea, will do, probably best not to sneak in something unrelated even if it is small. I'll remove this from this PR. Thanks!",
      "commit_id" : "0324942a7401416f572132d82055017cb6db749a",
      "created_at" : "2023-12-08T16:49:08Z",
      "diff_hunk" : "@@ -8,12 +8,12 @@ thread queue, wallet balance.\n Running\n ---------------------\n \n-For benchmarking, you only need to compile `bitcoin_bench`.  The bench runner\n+For benchmarking, you only need to compile `bench_bitcoin`.  The bench runner\n warns if you configure with `--enable-debug`, but consider if building without\n it will impact the benchmark(s) you are interested in by unlatching log printers\n and lock analysis.\n \n-    make -C src bitcoin_bench\n+    make -C src bench/bench_bitcoin",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420774368",
      "id" : 1420774368,
      "in_reply_to_id" : 1420176846,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585Ur0vg",
      "original_commit_id" : "0324942a7401416f572132d82055017cb6db749a",
      "original_line" : 16,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "doc/benchmarking.md",
      "position" : 11,
      "pull_request_review_id" : 1772804055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420774368/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-08T16:49:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420774368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420802246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420802246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We do remove the custom directory at the beginning of the test:\r\nhttps://github.com/bitcoin/bitcoin/pull/26564/files#diff-6a8ef76c60f30a6ca67d9f0e478fd02989c4b7fbc4c3116f80e13d873d5775e6R164\r\nso I think this restriction is still needed. I just verified that `/tmp/test_common_Bitcoin\\ Core` can be a symlink, so that would allow you to use any location, right? (I could add that to the README but not sure it's worth it.)",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-08T17:14:18Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420802246",
      "id" : 1420802246,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ur7jG",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1772841158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420802246/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-08T17:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420802246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed to remove the fix to `doc/benchmarking.md` as suggested by https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420176846",
      "created_at" : "2023-12-08T18:36:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1847650629",
      "id" : 1847650629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585uIOlF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1847650629/reactions"
      },
      "updated_at" : "2023-12-08T18:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1847650629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420978430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420978430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> We do remove the custom directory at the beginning of the test:\r\n> https://github.com/bitcoin/bitcoin/pull/26564/files#diff-6a8ef76c60f30a6ca67d9f0e478fd02989c4b7fbc4c3116f80e13d873d5775e6R164\r\n> so I think this restriction is still needed. I just verified that `/tmp/test_common_Bitcoin\\ Core` can be a symlink, so that would allow you to use any location, right? (I could add that to the README but not sure it's worth it.)\r\n\r\nhmm, that wasn't there before. Why we should introduce it?.\r\n\r\nWe have two cases, default and custom dir path.\r\nThe default test behavior creates a random directory path within the OS temp directory; therefore, we don't need to remove anything on this execution path.\r\nRegarding the custom path functionality, I'm not entirely certain we should assign core the responsibility of cleaning up the custom directory before executing the test/s. I think we should just try to lock the folder and run the test, similar to what we do for bitcoind.\r\nRunning tests on different paths, not on the temp directory, would be helpful. Doing it has no risk if we don't remove the directory after running the test there. And I think that users who make use of the custom path functionality should be aware of what they are doing",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-08T20:00:39Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1420978430",
      "id" : 1420978430,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Usmj-",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1773097857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420978430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-08T20:00:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1420978430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1421821961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1421821961"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The default test behavior creates a random directory path within the OS temp directory; therefore, we don't need to remove anything on this execution path.\r\n\r\nNo, in current master, the test framework does delete the directory _after_ the test: https://github.com/bitcoin/bitcoin/blob/3e691258d8789a4a89cce42e7e71b130491594d7/src/test/util/setup_common.cpp#L162 and I think that's a good thing or else running many tests could fill up your temp directory. If the test stops unexpectedly, I think the directory isn't removed, which is probably a good thing so that the cause of the failure can be investigated.\r\n\r\nThe directory doesn't need to be removed before the test; we can presume the directory doesn't exist because of the random name. (This PR does attempt to remove the random directory, which does no harm but it's not necessary.)\r\n\r\n> Regarding the custom path functionality, I'm not entirely certain we should assign core the responsibility of cleaning up the custom directory before executing the test/s.\r\n\r\nNo, it does need to, because if a (populated) directory exists when the test begins, the test will likely fail because of this unexpected leftover state.",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-10T21:42:26Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1421821961",
      "id" : 1421821961,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Uv0gJ",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1774102034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1421821961/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-10T21:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1421821961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424022422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424022422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was talking about what we do before the test. The test cleanup after execution is fine for the default case.\r\n\r\nI think we shouldn't block the test creation on different paths. Be forced to place the test only inside the temp directory doesn't seems so useful to me.\r\nWhat if we make the `-testdatadir` arg the base path for all test cases, and create a subdirectory for each run test inside it?. (with this, you would not need to delete the datadir at the beginning, because it will not exist).\r\nE.g.\r\n```c++\r\nfs::path base_dir;\r\nif (!m_node.args->IsArgSet(\"-testdatadir\")) {\r\n    base_dir = fs::temp_directory_path();\r\n} else {\r\n    std::string testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\r\n    // Allow only a simple string (a single path component) because we're\r\n    // going to remove this path, and it would be bad if it was \"../../home\".\r\n    if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\r\n        std::cerr << \"-testdatadir cannot contain path separators: \" << testdatadir << std::endl;\r\n        exit(1);\r\n    }\r\n\r\n    // Allow only regular directory paths\r\n    if (fs::is_regular_file(testdatadir) || fs::is_symlink(testdatadir)) {\r\n        std::cerr << \"-testdatadir needs to be a directory path: \" << testdatadir << std::endl;\r\n        exit(1);\r\n    }\r\n\r\n    // Create base dir if needed\r\n    fs::create_directories(testdatadir);\r\n    base_dir = fs::path{testdatadir.c_str()};\r\n    m_has_custom_datadir = true;\r\n}\r\n\r\n// Create test dir within the base directory\r\nm_path_root = base_dir / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\r\n```",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-12T13:50:32Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424022422",
      "id" : 1424022422,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U4NuW",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1777521001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424022422/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-12T13:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424022422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424023270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424023270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this should use std::cerr",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-12T13:51:12Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424023270",
      "id" : 1424023270,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII585U4N7m",
      "original_commit_id" : "56bcaf03f5c964e6b0cdda563685159b6ecda45f",
      "original_line" : 142,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 45,
      "pull_request_review_id" : 1777522424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424023270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T13:51:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424023270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424659497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424659497"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This defeats the purpose of this pull because it generates a randomly named data directory path; the point of this PR is to have a fixed datadir pathname so that I can have various files open in an editor across multiple test runs (not have to determine files' locations and re-open them on each test run).\r\n\r\n> Be forced to place the test only inside the temp directory doesn't seems so useful to me.\r\n\r\nWell, if we want the datadir pathnames to be static (which is what _I'm_ trying to accomplish with this PR), then we _must_ delete the datadir before the test begins. The first version of this PR did indeed allow the datadir to be anywhere, but this comment: https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328190540 points out that it's dangerous to recursively remove a directory (because of the possibility of user error) -- but within `/tmp`, and especially within `/tmp/test_common_Bitcoin\\ Core/`, recursive directory remove is okay, not dangerous at all.\r\n\r\nAnd, again, the user can set up a symlink from `/tmp/test_common_Bitcoin\\ Core/` to anywhere, if there's a desire not to use `/tmp` for some reason (but that should be rare). That reintroduces the danger, of course, but that's why we won't even document setting up a symlink.",
      "commit_id" : "9f3bc76b48458331eddb4a9e9082bcd11d5eef64",
      "created_at" : "2023-12-12T22:54:00Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424659497",
      "id" : 1424659497,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585U6pQp",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1778567582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424659497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-12T22:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424659497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed suggestion by @furszy (thanks!) https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1424023270",
      "created_at" : "2023-12-13T02:37:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1853174830",
      "id" : 1853174830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585udTQu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853174830/reactions"
      },
      "updated_at" : "2023-12-13T02:37:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853174830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1427479087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427479087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> And, again, the user can set up a symlink from /tmp/test_common_Bitcoin\\ Core/ to anywhere, if there's a desire not to use /tmp for some reason (but that should be rare).\r\n\r\nHave you seen https://github.com/bitcoin/bitcoin/pull/26684#pullrequestreview-1566578747 and https://github.com/bitcoin/bitcoin/pull/28955#issuecomment-1829948567?\r\nIt seems that we need it.\r\n\r\n> Well, if we want the datadir pathnames to be static (which is what I'm trying to accomplish with this PR), then we must delete the datadir before the test begins. The first version of this PR did indeed allow the datadir to be anywhere, but this comment: https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1328190540 points out that it's dangerous to recursively remove a directory (because of the possibility of user error) -- but within /tmp, and especially within /tmp/test_common_Bitcoin\\ Core/, recursive directory remove is okay, not dangerous at all.\r\n\r\nYes. I understood why you added it and the history. What I proposed was a middle ground between the \"only run tests in a /temp/<something> directory\" option and the \"run test on any custom path\" option. It was an option to allow users to provide the base directory path where the test will be created and run without being deleted after it execution.\r\n\r\nOther than that, I'm just not sure why we need to delete the directory path recursively at the beginning of the test. Why we cannot delete only what the test will use? or.. don't delete anything and move such responsibility to the user.\r\n--- Also, I have to admit that I'm not a fan of the symlink approach but.. thats a different topic ---",
      "commit_id" : "2c8c74409cceb95d59056b0229415bc4f43bd44a",
      "created_at" : "2023-12-15T02:12:28Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1427479087",
      "id" : 1427479087,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VFZov",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1783026029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427479087/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-15T20:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427479087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428387286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428387286"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I hadn't seen those PRs, thanks. I tried running `test_bitcoin` with the `TMPDIR` environment variable set (on Linux), and it works, so that means you don't have to set up a symlink.\r\n\r\n> or.. don't delete anything and move such responsibility to the user.\r\n\r\nYes, I like that suggestion. I had forgotten that vscode (which is where I run the debugger from) allows one to set up an arbitrary \"task\" to run, `preLaunchTask`, before starting the executable, and this can remove the (fixed-named) data directory, so that's perfect. Much less dangerous than recursive remove.\r\n\r\nSo what do you think about this:\r\n\r\n- change the argument name to `-datadir=` instead of `-testdatadir=` (since the argument will have the same meaning as for other executables like `bitcoind`)\r\n- if `-datadir` is not specified, behave as today\r\n- have the `datadir` argument be the actual full pathname to use for the data directory (can have path separators, and be a relative name or absolute path, we don't care)\r\n- _don't_ delete this directory before starting the test (could possibly warn if it's non-empty? it really should be empty when we start)\r\n- if `-datadir=` is specified, don't delete the directory after the test completes.",
      "commit_id" : "2c8c74409cceb95d59056b0229415bc4f43bd44a",
      "created_at" : "2023-12-15T19:17:35Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428387286",
      "id" : 1428387286,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VI3XW",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1784778463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428387286/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-15T19:17:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428387286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428446668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428446668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good to me.\r\nProbably the only scenario we may want to abort running a test on a specific datadir is when the directory contain mainnet data. But it shouldn't be a problem as we should be having something to detect this scenario inside `init.cpp` already.",
      "commit_id" : "2c8c74409cceb95d59056b0229415bc4f43bd44a",
      "created_at" : "2023-12-15T20:23:09Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428446668",
      "id" : 1428446668,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VJF3M",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1784873325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428446668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-15T20:23:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428446668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428581458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428581458"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's an excellent point, but I doubt there is anything already present that will prevent this.\r\n\r\nHere are two ideas, what do you think?\r\n\r\n- Whatever argument is given to `-datadir=`, _always_ make (if necessary) and use a subdirectory (within the specified directory) called `test_bitcoin`. That way, even if the user specifies their real data directory, all the test stuff will be within this subdirectory. (It's similar to how there already are subdirectories for testnet, signet, and regtest.)\r\n- make the argument keyword `-testdatadir=` (like it is now) instead of `-datadir=` (which might lead someone to think of specifying the real data directory path).\r\n\r\nThe first option is probably safer. Actually, I might do both, because this `-datadir` argument would behave a little differently (by making that subdirectory) than what people may be expecting. Also, there's a technical reason why `-datadir=` is a little more difficult to do (I won't bother to explain it right here).\r\n\r\nIf I have a chance, I'll see if you're correct that it's already prevented.",
      "commit_id" : "2c8c74409cceb95d59056b0229415bc4f43bd44a",
      "created_at" : "2023-12-15T23:25:25Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428581458",
      "id" : 1428581458,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VJmxS",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 145,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1785051393,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428581458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-15T23:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428581458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428842615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428842615"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Whatever argument is given to -datadir=, always make (if necessary) and use a subdirectory (within the specified directory) called test_bitcoin. That way, even if the user specifies their real data directory, all the test stuff will be within this subdirectory. (It's similar to how there already are subdirectories for testnet, signet, and regtest.)\r\n\r\nSounds good. s/test_bitcoin/tests (we don't use \"signet_bitcoin\", \"testnet_bitcoin\", \"regtest_bitcoin\").\r\n\r\n------------\r\n\r\nAlso, probably something for another PR but.. the following feature came to my mind: https://github.com/furszy/bitcoin-core/commits/2023_test_nocleanup/. Check the two commits there.",
      "commit_id" : "4831a008af8c1a808974056459d615464c870256",
      "created_at" : "2023-12-16T15:43:12Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428842615",
      "id" : 1428842615,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VKmh3",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 151,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1785202264,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428842615/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-17T13:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1428842615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1433153712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1433153712"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the suggestion; I decided to name the extra path component `test_temp` instead of `tests`, because if the user thought it was okay to specify their home directory, they may have a directory there called `tests` with some source code. This name isn't likely to conflict, and the `temp` part of the name indicates that it's a temporary directory (unlike `signet`, `regtest`, etc., which make sense to persist).",
      "commit_id" : "4831a008af8c1a808974056459d615464c870256",
      "created_at" : "2023-12-20T20:25:24Z",
      "diff_hunk" : "@@ -120,18 +119,49 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    {\n+        std::string testdatadir;\n+        if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+            testdatadir = g_insecure_rand_ctx_temp_path.rand256().ToString().c_str();\n+        } else {\n+            testdatadir = m_node.args->GetArg(\"-testdatadir\").value();\n+            // Don't allow anything but a simple string (a single path component) because we're\n+            // going to remove this path, and it would be bad if the string was \"../../home\".\n+            if (testdatadir.find(fs::path::preferred_separator) != std::string::npos) {\n+                std::cout << \"testdatadir cannot contain path separators: \" << testdatadir << std::endl;\n+                exit(1);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1433153712",
      "id" : 1433153712,
      "in_reply_to_id" : 1419817421,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585VbDCw",
      "original_commit_id" : "5dd89adbcbe5083cbd0c14ad868885fac2ee64ca",
      "original_line" : 151,
      "original_position" : 39,
      "original_start_line" : 139,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1791611611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1433153712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-20T20:25:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1433153712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed the changes described above (https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428581458( but I don't understand why CI is failing. All the failures are that `LockDirectory()` is not found, but it's declared in `util/fs_helpers.h` and that file is included. It builds for me. @furszy, can you try building this branch? Thanks.",
      "created_at" : "2023-12-20T20:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1865121551",
      "id" : 1865121551,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585vK38P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865121551/reactions"
      },
      "updated_at" : "2023-12-20T20:50:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865121551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Force pushed the changes described above ([#26564 (comment)](https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1428581458) but I don't understand why CI is failing. All the failures are that `LockDirectory()` is not found, but it's declared in `util/fs_helpers.h` and that file is included. It builds for me. @furszy, can you try building this branch? Thanks.\r\n\r\nWithout compiling, would say that you are missing the namespace. `util::LockDirectory()` instead of `LockDirectory()`.",
      "created_at" : "2023-12-20T22:48:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1865243678",
      "id" : 1865243678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585vLVwe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865243678/reactions"
      },
      "updated_at" : "2023-12-20T22:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865243678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that's what the compiler error says, but that function doesn't seem to be in that namespace. Its other callers don't qualify it, and if I do qualify it, the build fails for me.",
      "created_at" : "2023-12-21T06:07:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1865554603",
      "id" : 1865554603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585vMhqr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865554603/reactions"
      },
      "updated_at" : "2023-12-21T06:07:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1865554603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Yes, that's what the compiler error says, but that function doesn't seem to be in that namespace. Its other callers don't qualify it, and if I do qualify it, the build fails for me.\r\n\r\nSeems that the function was moved to the `util` namespace on #28075. Will need to do some modifications here. `LockDirectory()` does not return a boolean anymore.\r\nTry cleaning up your project and rebasing it on master. (git clean -fdx && git pull --rebase origin master && make). Probably thats what the CI does.",
      "created_at" : "2023-12-21T12:24:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1866160684",
      "id" : 1866160684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585vO1os",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1866160684/reactions"
      },
      "updated_at" : "2023-12-21T12:24:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1866160684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force pushed twice to rebase and fix the CI problem, ready for review, thanks, @furszy!",
      "created_at" : "2023-12-21T21:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1866934995",
      "id" : 1866934995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585vRyrT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1866934995/reactions"
      },
      "updated_at" : "2023-12-21T21:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1866934995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437956165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437956165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could mention that the datadir will not be removed automatically.\r\n\r\nAlso, the default value isn't just a random string. It should be:\r\n```suggestion\r\n        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")), ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\r\n```",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T02:42:08Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437956165",
      "id" : 1437956165,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585VtXhF",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 125,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 28,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437956165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437956165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437959375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437959375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Let's avoid using the string pointer (`c_str()`), could instead use: \r\n```c++\r\ntestdatadir = fs::PathFromString(g_insecure_rand_ctx_temp_path.rand256().ToString())\r\n```",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T02:57:07Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437959375",
      "id" : 1437959375,
      "line" : 136,
      "node_id" : "PRRC_kwDOABII585VtYTP",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 135,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 38,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437959375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437959375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437960487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437960487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here; let's avoid using the string pointer `c_str()`, and instead use `fs::PathFromString(path)`",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T03:02:46Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437960487",
      "id" : 1437960487,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII585VtYkn",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 140,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 45,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437960487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437960487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437962170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437962170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this because you are running all tests within a boost fixture test suite or is it happening when you run a single test case? \r\nE.g. fixture test suite: `./test_bitcoin --run_test=db_tests` vs single test case `./test_bitcoin --run_test= db_tests/getwalletenv_file`.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T03:10:57Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+        fs::remove_all(m_path_root);\n+\n+        // Print the test directory name if custom, but only once per test run\n+        static bool g_printed_dir{false};\n+        if (!g_printed_dir) {\n+            g_printed_dir = true;\n+            std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437962170",
      "id" : 1437962170,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585VtY-6",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 148,
      "original_position" : 43,
      "original_start_line" : 143,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 75,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437962170/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 168,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437962170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437963129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437963129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can use `GetPathArg(\"-testdatadir\")` directly.\r\n\r\nAlso, I would check the path correctness here and error out early when it is invalid.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T03:15:38Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437963129",
      "id" : 1437963129,
      "line" : 142,
      "node_id" : "PRRC_kwDOABII585VtZN5",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 139,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 44,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437963129/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437963129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437965595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437965595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If a concurrent process locks the datadir right after the lock release, this process would remove the root path even when the other process is using it?",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T03:27:22Z",
      "diff_hunk" : "@@ -134,21 +135,43 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         // By default, the data directory has a random name\n         const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n         m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+        fs::create_directories(m_path_root);\n     } else {\n         // Custom data directory\n+        m_has_custom_datadir = true;\n         const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n         m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        auto lock_datadir = [&]() -> void {\n+            try {\n+                fs::create_directories(m_path_root);\n+            } catch (const std::exception&) {\n+            }\n+            if (!fs::exists(m_path_root)) {\n+                std::cerr << \"Cannot create test data directory \" + fs::PathToString(m_path_root) + '\\n';\n+                exit(1);\n+            }\n+            if (util::LockDirectory(m_path_root, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+                std::cerr << \"Cannot obtain a lock on test data directory \" + fs::PathToString(m_path_root) + '\\n' +\n+                                 \"The test executable is probably already running.\\n\";\n+                exit(1);\n+            }\n+        };\n+        lock_datadir();\n+\n+        // Always start with a fresh data directory (must release the lock before remove on some platforms).\n+        ReleaseDirectoryLocks();\n         fs::remove_all(m_path_root);\n+        lock_datadir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437965595",
      "id" : 1437965595,
      "line" : 166,
      "node_id" : "PRRC_kwDOABII585VtZ0b",
      "original_commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "original_line" : 166,
      "original_position" : 40,
      "original_start_line" : 161,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 40,
      "pull_request_review_id" : 1798560817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437965595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T03:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1437965595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438054972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438054972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `g_printed_dir` guard is only needed because the user may be running more than one test case (like your first example). I don't love this global variable but it seems weird to print this out on every individual test case, and I think it's okay for a test program. I convinced myself that no race condition is possible, but we could use `std::call_once()` here but I didn't think it was worth it.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T06:42:25Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+        fs::remove_all(m_path_root);\n+\n+        // Print the test directory name if custom, but only once per test run\n+        static bool g_printed_dir{false};\n+        if (!g_printed_dir) {\n+            g_printed_dir = true;\n+            std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438054972",
      "id" : 1438054972,
      "in_reply_to_id" : 1437962170,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585Vtvo8",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 148,
      "original_position" : 43,
      "original_start_line" : 143,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 75,
      "pull_request_review_id" : 1798686569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438054972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 168,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T06:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438054972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438055076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055076"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I can't get this to work.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T06:42:50Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438055076",
      "id" : 1438055076,
      "in_reply_to_id" : 1437960487,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII585Vtvqk",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 140,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 45,
      "pull_request_review_id" : 1798686569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055076/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T06:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438055454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea, but what do you mean by path correctness?",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T06:44:17Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438055454",
      "id" : 1438055454,
      "in_reply_to_id" : 1437963129,
      "line" : 142,
      "node_id" : "PRRC_kwDOABII585Vtvwe",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 139,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 44,
      "pull_request_review_id" : 1798686569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T06:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438055454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438057148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438057148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, I was actually aware of this but concluded that it is such a small timing window, that it's not a problem in practice. The problem is that on Windows, you can't remove an open file (and having a file lock is a form of having the file open). I could make this conditional on `WIN32` (I think it is), but I'm not sure that's even worth it.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T06:50:10Z",
      "diff_hunk" : "@@ -134,21 +135,43 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         // By default, the data directory has a random name\n         const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n         m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+        fs::create_directories(m_path_root);\n     } else {\n         // Custom data directory\n+        m_has_custom_datadir = true;\n         const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n         m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        auto lock_datadir = [&]() -> void {\n+            try {\n+                fs::create_directories(m_path_root);\n+            } catch (const std::exception&) {\n+            }\n+            if (!fs::exists(m_path_root)) {\n+                std::cerr << \"Cannot create test data directory \" + fs::PathToString(m_path_root) + '\\n';\n+                exit(1);\n+            }\n+            if (util::LockDirectory(m_path_root, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+                std::cerr << \"Cannot obtain a lock on test data directory \" + fs::PathToString(m_path_root) + '\\n' +\n+                                 \"The test executable is probably already running.\\n\";\n+                exit(1);\n+            }\n+        };\n+        lock_datadir();\n+\n+        // Always start with a fresh data directory (must release the lock before remove on some platforms).\n+        ReleaseDirectoryLocks();\n         fs::remove_all(m_path_root);\n+        lock_datadir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438057148",
      "id" : 1438057148,
      "in_reply_to_id" : 1437965595,
      "line" : 166,
      "node_id" : "PRRC_kwDOABII585VtwK8",
      "original_commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "original_line" : 166,
      "original_position" : 40,
      "original_start_line" : 161,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 40,
      "pull_request_review_id" : 1798689795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438057148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T06:50:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438057148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438256160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438256160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\nfs::path dir = m_node.args->GetPathArg(\"-testdatadir\");\r\n// todo: check if path is valid\r\nm_path_root = dir / \"test_temp\";\r\n```",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T13:32:00Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438256160",
      "id" : 1438256160,
      "in_reply_to_id" : 1437960487,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII585Vugwg",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 140,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 45,
      "pull_request_review_id" : 1798997385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438256160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T13:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438256160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438257281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438257281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Good idea, but what do you mean by path correctness?\r\n\r\nProbably we should fail when `-testdatadir` is an empty string.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T13:35:03Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438257281",
      "id" : 1438257281,
      "in_reply_to_id" : 1437963129,
      "line" : 142,
      "node_id" : "PRRC_kwDOABII585VuhCB",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 139,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 44,
      "pull_request_review_id" : 1798999078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438257281/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-29T13:35:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438257281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438258663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438258663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should use the `EXIT_FAILURE` constant, not exit(1).\r\n\r\nAlso, I would move the print + exit to a standalone function to dedup code. Like `Shutdown(const std::string& err_msg);`.",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T13:38:56Z",
      "diff_hunk" : "@@ -120,18 +120,61 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        auto lock_datadir = [&]() -> void {\n+            try {\n+                fs::create_directories(m_path_root);\n+            } catch (const std::exception&) {\n+            }\n+            if (!fs::exists(m_path_root)) {\n+                std::cerr << \"Cannot create test data directory \" + fs::PathToString(m_path_root) + '\\n';\n+                exit(1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438258663",
      "id" : 1438258663,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII585VuhXn",
      "original_commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "original_line" : 153,
      "original_position" : 55,
      "original_start_line" : 152,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 55,
      "pull_request_review_id" : 1799001317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438258663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 152,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T13:38:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438258663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438415389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438415389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The `g_printed_dir` guard is only needed because the user may be running more than one test case \r\n\r\nThis would break the PR goal in the current implementation. Only the last executed test datadir would be kept, the rest will be deleted.\r\nI think we should include the test name in the path and create a datadir directory for each executed tests. Could pull most of what I did before: 53eb4980d561491798d0c8b0ee383c83ba193432.\r\n\r\n",
      "commit_id" : "e00c75df8be3a2f99c505ee2352d39d42f18a150",
      "created_at" : "2023-12-29T21:26:55Z",
      "diff_hunk" : "@@ -120,18 +119,39 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", \"Custom data directory (default: <random_string>)\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const std::string testdatadir{g_insecure_rand_ctx_temp_path.rand256().ToString().c_str()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / testdatadir;\n+    } else {\n+        // Custom data directory\n+        const std::string testdatadir{m_node.args->GetArg(\"-testdatadir\").value()};\n+        m_path_root = fs::path(testdatadir.c_str()) / \"test_temp\";\n+        fs::remove_all(m_path_root);\n+\n+        // Print the test directory name if custom, but only once per test run\n+        static bool g_printed_dir{false};\n+        if (!g_printed_dir) {\n+            g_printed_dir = true;\n+            std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438415389",
      "id" : 1438415389,
      "in_reply_to_id" : 1437962170,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585VvHod",
      "original_commit_id" : "9d8f12146bb19d44a17fc4fa67aaaac9c7c2ec2d",
      "original_line" : 148,
      "original_position" : 43,
      "original_start_line" : 143,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 75,
      "pull_request_review_id" : 1799224452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438415389/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 168,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-29T21:26:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1438415389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480729338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480729338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is the purpose of this extra levels?\r\nThis can just be `root_dir / G_TEST_GET_FULL_NAME()`.",
      "commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "created_at" : "2024-02-07T00:35:20Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480729338",
      "id" : 1480729338,
      "line" : 150,
      "node_id" : "PRRC_kwDOABII585YQiL6",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : 148,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 52,
      "pull_request_review_id" : 1866665138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480729338/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-07T00:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480729338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480738630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480738630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Guess that you are duplicating `TryCreateDirectories()`?\r\n\r\nYou could just try to create the directory and lock it right away. E.g.\r\n```c++\r\nTryCreateDirectories(dir);\r\nif (util::LockDirectory(dir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\r\n   // error out\r\n}\r\netc..\r\n```\r\n\r\nShouldn't need to execute the `fs::exist` call.",
      "commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "created_at" : "2024-02-07T00:43:57Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        try {\n+            fs::create_directories(lockdir);\n+        } catch (const std::exception&) {\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480738630",
      "id" : 1480738630,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII585YQkdG",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 156,
      "original_position" : 58,
      "original_start_line" : 152,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 58,
      "pull_request_review_id" : 1866665138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480738630/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 152,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-07T00:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480738630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480740777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480740777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If this doesn't delete the .lock file, then the `fs::create_directories` call isn't needed?",
      "commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "created_at" : "2024-02-07T00:46:27Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        try {\n+            fs::create_directories(lockdir);\n+        } catch (const std::exception&) {\n+        }\n+        if (!fs::exists(lockdir)) {\n+            std::cerr << \"Cannot create test data directory \" + fs::PathToString(m_path_root) + '\\n';\n+            exit(EXIT_FAILURE);\n+        }\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        fs::create_directories(m_path_root);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1480740777",
      "id" : 1480740777,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585YQk-p",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 169,
      "original_position" : 71,
      "original_start_line" : 167,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 71,
      "pull_request_review_id" : 1866665138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480740777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 167,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-07T00:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480740777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1483525174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483525174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's because after successfully locking the `lockdir` directory, I don't want to release the lock (you had caught that problem earlier), which means we can't delete `.lock`, but I do want to start with a clean data directory. This extra level makes it easy to delete the old data directory (if it exists) without disturbing the `.lock` file so it can remain locked the entire time.\r\n\r\nThe alternative would be to iterate over the contents of the data directory delete (call `fs::remove_all()`) on everything _except_ `.lock`. I think the added code complexity isn't worth it, but that's a judgment call.",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-08T19:56:32Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1483525174",
      "id" : 1483525174,
      "in_reply_to_id" : 1480729338,
      "line" : 150,
      "node_id" : "PRRC_kwDOABII585YbMw2",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : 148,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 52,
      "pull_request_review_id" : 1871146839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483525174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-08T20:11:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483525174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1483535959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483535959"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's needed because `fs::remove_all(m_path_root)` removes `m_path_root` (and everything below), so we must re-create `m_path_root` (only the last component of the pathname will need to actually be created). I'll change the `fs::create_directories()` to `TryCreateDirectories()` (even though it shouldn't matter here).",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-08T20:07:30Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        try {\n+            fs::create_directories(lockdir);\n+        } catch (const std::exception&) {\n+        }\n+        if (!fs::exists(lockdir)) {\n+            std::cerr << \"Cannot create test data directory \" + fs::PathToString(m_path_root) + '\\n';\n+            exit(EXIT_FAILURE);\n+        }\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        fs::create_directories(m_path_root);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1483535959",
      "id" : 1483535959,
      "in_reply_to_id" : 1480740777,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YbPZX",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 169,
      "original_position" : 71,
      "original_start_line" : 167,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 1871146839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483535959/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-08T20:11:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1483535959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1497505462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497505462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It's because after successfully locking the lockdir directory, I don't want to release the lock (you had caught that problem earlier), which means we can't delete .lock, but I do want to start with a clean data directory. This extra level makes it easy to delete the old data directory (if it exists) without disturbing the .lock file so it can remain locked the entire time.\r\n\r\nWhat if we use the test group directory level instead?. See 6697933c. It locks the entire test group.\r\nAlso, 6697933c changes the \"/test_temp/\" to \"/test_common_\" PACKAGE_NAME /\" to keep the same structure.\r\n\r\nUpdate:\r\nI'm not really happy with this suggestion anymore. It will block concurrent sub-tests runs.. (but, I'm still thinking that \"test_temp\" should be replaced for \"/test_common_\" PACKAGE_NAME /\")",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-21T13:02:18Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1497505462",
      "id" : 1497505462,
      "in_reply_to_id" : 1480729338,
      "line" : 150,
      "node_id" : "PRRC_kwDOABII585ZQh62",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : 148,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 52,
      "pull_request_review_id" : 1893141758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497505462/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-21T20:46:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497505462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1497615599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497615599"
         }
      },
      "author_association" : "NONE",
      "body" : "Why not pass `lock_dir` here into `fs::remove_all()` instead of the datadir-subdirectory `m_path_root`? Seems like current version does NOT remove old test directories, just the datadir.\r\n\r\nThis contradicts the PR summary:\r\n> When the test starts, remove <datadir>/test_temp/<test-name> if it exists from an earlier run (currently, it's presumed not to exist due to the long random string)\r\n\r\nCurrent (7b81dea) behavior:\r\n```sh\r\n$ ./src/test/test_bitcoin --run_test=getarg_tests/doubledash -- --testdatadir=/tmp/\r\n...\r\n\r\n$ touch /tmp/test_temp/getarg_tests/doubledash/foo\r\n$ touch /tmp/test_temp/getarg_tests/doubledash/datadir/bar\r\n\r\n$ ./src/test/test_bitcoin --run_test=getarg_tests/doubledash -- --testdatadir=/tmp/\r\n...\r\n\r\n$ ls /tmp/test_temp/getarg_tests/doubledash/foo\r\n/tmp/test_temp/getarg_tests/doubledash/foo\r\n\r\n$ ls /tmp/test_temp/getarg_tests/doubledash/datadir/bar\r\nls: cannot access '/tmp/test_temp/getarg_tests/doubledash/datadir/bar': No such file or directory\r\n```",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-21T14:01:36Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1497615599",
      "id" : 1497615599,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585ZQ8zv",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 161,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 63,
      "pull_request_review_id" : 1893059876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497615599/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T19:06:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497615599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1498243817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498243817"
         }
      },
      "author_association" : "NONE",
      "body" : "> What is the purpose of this extra levels? This can just be `root_dir / G_TEST_GET_FULL_NAME()`.\r\n\r\nAlso reacted to this, but another bonus of having the intermediate `test_temp` dir is that one doesn't unintentionally flood an already existing directory with directories based on test-names.",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-21T20:12:07Z",
      "diff_hunk" : "@@ -120,18 +120,60 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        fs::create_directories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1498243817",
      "id" : 1498243817,
      "in_reply_to_id" : 1480729338,
      "line" : 150,
      "node_id" : "PRRC_kwDOABII585ZTWLp",
      "original_commit_id" : "3a298b2a86769eea38f378a8ad54f4f4bfb9c89c",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : 148,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 52,
      "pull_request_review_id" : 1894315513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498243817/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-21T20:12:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498243817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> may be an issue with some tests when `testdatadir` is provided a relative path\r\n\r\nI can't reproduce this problem. I tried both running the one test alone and running the entire test suite (not specifying `--run_test=`).",
      "created_at" : "2024-02-22T17:22:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1959915076",
      "id" : 1959915076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII58500e5E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959915076/reactions"
      },
      "updated_at" : "2024-02-22T17:22:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959915076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">This contradicts the PR summary:\r\n\r\nThanks for the review! You're right, good catch. I updated the PR description.\r\n\r\nThe behavior is correct, we don't want to remove the `.lock` file at the start of the run, because we've just _acquired_ the lock, and want to keep it while we delete the test's data directory that might be left over from a previous run. That's why there's a `datadir` at the same level as `.lock` (so we can delete `datadir` without also deleting `.lock`). This behavior was suggested in this comment earlier in this PR: https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1437965595 (but I forgot to update the PR description).",
      "created_at" : "2024-02-22T17:43:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1959949768",
      "id" : 1959949768,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII58500nXI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959949768/reactions"
      },
      "updated_at" : "2024-02-22T17:43:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959949768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499651040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499651040"
         }
      },
      "author_association" : "NONE",
      "body" : "Suggestion: change to something like `\"Test directory (not deleted until next run): \"`",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-22T17:53:14Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        TryCreateDirectories(m_path_root);\n+\n+        // Print the test directory name if custom.\n+        std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499651040",
      "id" : 1499651040,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585ZYtvg",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 165,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 67,
      "pull_request_review_id" : 1896496278,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499651040/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499651040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499718540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499718540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I _think_ it's clear enough as is. If it says \"until next run\", it might not be clear if that's before the next run of _any_ test or this _particular_ test. Clarifying that would add more text and be a bit too chatty. I think the current text is clear enough to convey \"not deleted after the current run\"; I think it's understood that if you specify the same data directory and the same test, it will overwrite that same directory.",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-22T18:28:44Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        TryCreateDirectories(m_path_root);\n+\n+        // Print the test directory name if custom.\n+        std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499718540",
      "id" : 1499718540,
      "in_reply_to_id" : 1499651040,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585ZY-OM",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 165,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 67,
      "pull_request_review_id" : 1896617670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499718540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T18:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499718540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499896700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499896700"
         }
      },
      "author_association" : "NONE",
      "body" : "Last suggestion: `\"Test directory (remains after run)\"`.\r\n\r\nIf it hadn't been so chatty compared to running without `-testdatadir` I wouldn't mind. Would have been nicer to explain the part within the parenthesis one single time, before all the tests are run.",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-22T20:25:47Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        TryCreateDirectories(m_path_root);\n+\n+        // Print the test directory name if custom.\n+        std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1499896700",
      "id" : 1499896700,
      "in_reply_to_id" : 1499651040,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585ZZpt8",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 165,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 67,
      "pull_request_review_id" : 1896884169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499896700/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T20:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499896700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1501041426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501041426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Last suggestion: `\"Test directory (remains after run)\"`.\r\n\r\nI'm not sure if I see that as an improvement; I'll hold off to see if anyone else has a preference.\r\n\r\n> Would have been nicer to explain the part within the parenthesis one single time, before all the tests are run.\r\n\r\nA previous iteration of this PR did this (before each test case had its own data directory), the code worked but was messy (required a static (global) variable), so I was glad to remove it which needed to be done anyway since now each test has its own data directory. I don't really want to add that complexity back in. I think I'll leave it as is unless someone has a strong opinion to the contrary.",
      "commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "created_at" : "2024-02-23T18:38:53Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);\n+        TryCreateDirectories(m_path_root);\n+\n+        // Print the test directory name if custom.\n+        std::cout << \"Test directory (will not be deleted): \" << m_path_root << std::endl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1501041426",
      "id" : 1501041426,
      "in_reply_to_id" : 1499651040,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585ZeBMS",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 165,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 67,
      "pull_request_review_id" : 1898720444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501041426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T18:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501041426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > may be an issue with some tests when `testdatadir` is provided a relative path\r\n> \r\n> I can't reproduce this problem. I tried both running the one test alone and running the entire test suite (not specifying `--run_test=`).\r\n\r\nThe specific command I used that caused the error was as follows.  Only seems to happen when using a relative path for testdatadir.\r\n```\r\nsrc/test/test_bitcoin --run_test=walletdb_tests/walletdb_read_write_deadlock -- -testdatadir=\"./mytestdir/newlycreateddir/\"\r\n```\r\n\r\nI'm getting the same failure on two different machines (both running Ubuntu 22.04, one x86_64 and one aarch64).  Here's how I built Core (maybe something wrong here?):\r\n```\r\nmake -C depends && ./autogen.sh && ./configure BDB_LIBS=\"-L${BDB_PREFIX}/lib -ldb_cxx-4.8\" BDB_CFLAGS=\"-I${BDB_PREFIX}/include\" --disable-bench --disable-fuzz-binary --enable-debug --without-gui --enable-suppress-external-warnings && make -j4 && make check\r\n```",
      "created_at" : "2024-02-23T18:49:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1961826538",
      "id" : 1961826538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII58507xjq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961826538/reactions"
      },
      "updated_at" : "2024-02-23T18:49:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961826538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@tdb3 - Ah, I bet the problem relates to `BDB`. I don't build that way. I don't know what's wrong, but just to verify one thing, the [build document](https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md#berkeley-db) says:\r\n\r\n> Note: Make sure that `BDB_PREFIX` is an absolute path.\r\n\r\nWhat is that environment variable set to in your environment? But if not, you may want to try that. (Having said this, if this is the problem, I don't understand how this causes the problem.)",
      "created_at" : "2024-02-23T23:03:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962114338",
      "id" : 1962114338,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII5850830i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962114338/reactions"
      },
      "updated_at" : "2024-02-23T23:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962114338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> @tdb3 - Ah, I bet the problem relates to `BDB`. I don't build that way. I don't know what's wrong, but just to verify one thing, the [build document](https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md#berkeley-db) says:\n> \n> > Note: Make sure that `BDB_PREFIX` is an absolute path.\n> \n> What is that environment variable set to in your environment? But if not, you may want to try that. (Having said this, if this is the problem, I don't understand how this causes the problem.)\n\nHmm. BDB_PREFIX was an absolute path, and it was sanity checked with `ls -l $BDB_PREFIX`",
      "created_at" : "2024-02-23T23:06:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962116218",
      "id" : 1962116218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585084R6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962116218/reactions"
      },
      "updated_at" : "2024-02-23T23:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962116218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@tdb3 \r\n>Hmm. BDB_PREFIX was an absolute path\r\n\r\nDrat, I'll set up BDB on my system here and see if it reproduces. If not too much trouble and if you have time, maybe you can try building without BDB and see if that works.",
      "created_at" : "2024-02-23T23:24:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962130516",
      "id" : 1962130516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585087xU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962130516/reactions"
      },
      "updated_at" : "2024-02-23T23:24:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962130516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@tdb3 \r\nI force-pushed a fix, it turns out that Berkeley DB (BDB) doesn't work with a relative path, only absolute. So it's a one-line fix. Thanks for finding this bug!",
      "created_at" : "2024-02-24T02:05:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962215224",
      "id" : 1962215224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII58509Qc4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962215224/reactions"
      },
      "updated_at" : "2024-02-24T02:05:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962215224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> @tdb3 I force-pushed a fix, it turns out that Berkeley DB (BDB) doesn't work with a relative path, only absolute. So it's a one-line fix. Thanks for finding this bug!\r\n\r\nHappy to help.  Nice job with the fix.  ACK 11aeabde29820ab218757a6c5b959f2ba2cd8f13.\r\n\r\nRetested on my machine as well (the same steps outlined above).  All passed!\r\n",
      "created_at" : "2024-02-24T10:33:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962323104",
      "id" : 1962323104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII58509qyg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962323104/reactions"
      },
      "updated_at" : "2024-02-24T10:33:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962323104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Great find @tdb3! re-ACK 11aeabd.\r\n\r\n(Diffed against previous commit and re-ran `./src/test/test_bitcoin -- --testdatadir=` with absolute and relative paths. Not explicitly opting in to BDB though).",
      "created_at" : "2024-02-24T13:31:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#issuecomment-1962364915",
      "id" : 1962364915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26564",
      "node_id" : "IC_kwDOABII585090_z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962364915/reactions"
      },
      "updated_at" : "2024-02-24T13:31:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1962364915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1506916758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@cbergqvist As I understand, the reasoning is hinted at by the line 161 comment, namely the reason for the extra parent (lockdir) of our `m_path_root`  is solely for us to grab a lock on the lockdir, and once we've obtained it, safely delete and write to the nested `datadir`. As discussed at: https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1483525174 and https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1438057148 :\r\n\r\n\"The problem is that on Windows, you can't remove an open file (and having a file lock is a form of having the file open).\"",
      "commit_id" : "11aeabde29820ab218757a6c5b959f2ba2cd8f13",
      "created_at" : "2024-02-29T02:26:05Z",
      "diff_hunk" : "@@ -120,18 +120,53 @@ BasicTestingSetup::BasicTestingSetup(const ChainType chainType, const std::vecto\n         arguments = Cat(arguments, G_TEST_COMMAND_LINE_ARGUMENTS());\n     }\n     util::ThreadRename(\"test\");\n-    fs::create_directories(m_path_root);\n-    m_args.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n-    gArgs.ForceSetArg(\"-datadir\", fs::PathToString(m_path_root));\n     gArgs.ClearPathCache();\n     {\n         SetupServerArgs(*m_node.args);\n+        m_node.args->AddArg(\"-testdatadir\", strprintf(\"Custom data directory (default: %s<random_string>)\", fs::PathToString(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / \"\")),\n+                            ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n         std::string error;\n         if (!m_node.args->ParseParameters(arguments.size(), arguments.data(), error)) {\n             m_node.args->ClearArgs();\n             throw std::runtime_error{error};\n         }\n     }\n+\n+    if (!m_node.args->IsArgSet(\"-testdatadir\")) {\n+        // By default, the data directory has a random name\n+        const auto rand_str{g_insecure_rand_ctx_temp_path.rand256().ToString()};\n+        m_path_root = fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / rand_str;\n+        TryCreateDirectories(m_path_root);\n+    } else {\n+        // Custom data directory\n+        m_has_custom_datadir = true;\n+        fs::path root_dir{m_node.args->GetPathArg(\"-testdatadir\")};\n+        if (root_dir.empty()) {\n+            std::cerr << \"-testdatadir argument is empty, please specify a path\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+        const std::string test_path{G_TEST_GET_FULL_NAME ? G_TEST_GET_FULL_NAME() : \"\"};\n+        const fs::path lockdir{root_dir / \"test_temp\" / fs::PathFromString(test_path)};\n+        m_path_root = lockdir / \"datadir\";\n+\n+        // Try to obtain the lock; if unsuccessful don't disturb the existing test.\n+        TryCreateDirectories(lockdir);\n+        if (util::LockDirectory(lockdir, \".lock\", /*probe_only=*/false) != util::LockResult::Success) {\n+            std::cerr << \"Cannot obtain a lock on test data lock directory \" + fs::PathToString(lockdir) + '\\n' +\n+                             \"The test executable is probably already running.\\n\";\n+            exit(EXIT_FAILURE);\n+        }\n+\n+        // Always start with a fresh data directory; this doesn't delete the .lock file.\n+        fs::remove_all(m_path_root);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26564#discussion_r1506916758",
      "id" : 1506916758,
      "in_reply_to_id" : 1497615599,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585Z0bmW",
      "original_commit_id" : "7b81dea7eb6b14a939230477835159dad6b4b75b",
      "original_line" : 162,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 64,
      "pull_request_review_id" : 1907816611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26564",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916758/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T02:26:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2257631?v=4",
         "events_url" : "https://api.github.com/users/davidgumberg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/davidgumberg/followers",
         "following_url" : "https://api.github.com/users/davidgumberg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/davidgumberg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/davidgumberg",
         "id" : 2257631,
         "login" : "davidgumberg",
         "node_id" : "MDQ6VXNlcjIyNTc2MzE=",
         "organizations_url" : "https://api.github.com/users/davidgumberg/orgs",
         "received_events_url" : "https://api.github.com/users/davidgumberg/received_events",
         "repos_url" : "https://api.github.com/users/davidgumberg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/davidgumberg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/davidgumberg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/davidgumberg"
      }
   }
]
