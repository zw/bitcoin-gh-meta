[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29306).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [sdaftuar](https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1959678050) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29427](https://github.com/bitcoin/bitcoin/pull/29427) (Add imbued v3 based on template-matching by sdaftuar)\n* [#29325](https://github.com/bitcoin/bitcoin/pull/29325) (consensus: Store transaction nVersion as uint32_t by achow101)\n* [#28984](https://github.com/bitcoin/bitcoin/pull/28984) (Cluster size 2 package rbf by instagibbs)\n* [#28886](https://github.com/bitcoin/bitcoin/pull/28886) (refactor: Replace sets of txiter with CTxMemPoolEntryRefs by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-24T14:30:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1908245452",
      "id" : 1908245452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29306",
      "node_id" : "IC_kwDOABII585xvYPM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908245452/reactions"
      },
      "updated_at" : "2024-02-22T15:22:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908245452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466473683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466473683"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n                // we don't conflict inputs with it, consider evicting it under RBF rules. We rely on v3 rules\r\n```",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T14:39:52Z",
      "diff_hunk" : "@@ -180,6 +180,21 @@ std::optional<std::pair<std::string, CTransactionRef>> ApplyV3Rules(const CTrans\n                 std::any_of(children.cbegin(), children.cend(),\n                     [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n             if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n+                // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+                // we don't conflict with it, consider evicting it under RBF rules. We rely on v3 rules",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466473683",
      "id" : 1466473683,
      "line" : 184,
      "node_id" : "PRRC_kwDOABII585XaJzT",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 184,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 184,
      "pull_request_review_id" : 1843901103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466473683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466473683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466475345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466475345"
         }
      },
      "author_association" : "MEMBER",
      "body" : "aside: In relaxed topos we just attempt the eviction of *all* of them",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T14:41:03Z",
      "diff_hunk" : "@@ -180,6 +180,21 @@ std::optional<std::pair<std::string, CTransactionRef>> ApplyV3Rules(const CTrans\n                 std::any_of(children.cbegin(), children.cend(),\n                     [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n             if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n+                // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+                // we don't conflict with it, consider evicting it under RBF rules. We rely on v3 rules\n+                // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+                // which descendant to evict. Skip if this isn't true, e.g. if this transaction has",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466475345",
      "id" : 1466475345,
      "line" : 186,
      "node_id" : "PRRC_kwDOABII585XaKNR",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 186,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 186,
      "pull_request_review_id" : 1843901103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466475345/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466475345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466484490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466484490"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this return value needs to be explained very well ",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T14:47:27Z",
      "diff_hunk" : "@@ -55,11 +55,11 @@ static_assert(V3_CHILD_MAX_VSIZE + MAX_STANDARD_TX_WEIGHT / WITNESS_SCALE_FACTOR\n  * @param[in]   vsize                   The sigop-adjusted virtual size of ptx.\n  * @returns an error string if any v3 rule was violated, otherwise std::nullopt.\n  */\n-std::optional<std::string> ApplyV3Rules(const CTransactionRef& ptx,\n-                                        const CTxMemPool::setEntries& mempool_ancestors,\n-                                        unsigned int num_in_pkg_ancestors,\n-                                        const std::set<Txid>& direct_conflicts,\n-                                        int64_t vsize);\n+std::optional<std::pair<std::string, CTransactionRef>> ApplyV3Rules(const CTransactionRef& ptx,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466484490",
      "id" : 1466484490,
      "line" : 58,
      "node_id" : "PRRC_kwDOABII585XaMcK",
      "original_commit_id" : "a28681ed1c4291d0d9cc53f0faae07815d588449",
      "original_line" : 58,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.h",
      "position" : 58,
      "pull_request_review_id" : 1843901103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466484490/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466484490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466531988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466531988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "did you consider internalizing this logic inside `ApplyV3` directly to reduce conceptual sprawl",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T15:20:20Z",
      "diff_hunk" : "@@ -967,7 +972,19 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     CTxMemPool::setEntries collective_ancestors = *ancestors;\n     collective_ancestors.merge(ws.m_ancestors_of_in_package_ancestors);\n     if (const auto err{ApplyV3Rules(ws.m_ptx, collective_ancestors, ws.m_num_in_package_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", err->first);\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466531988",
      "id" : 1466531988,
      "line" : 976,
      "node_id" : "PRRC_kwDOABII585XaYCU",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 976,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 101,
      "pull_request_review_id" : 1843901103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466531988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466531988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466538340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466538340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "needs test coverage",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T15:24:54Z",
      "diff_hunk" : "@@ -1007,16 +1024,28 @@ bool MemPoolAccept::ReplacementChecks(Workspace& ws)\n         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not\n         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.\n         // This must be changed if package RBF is enabled.\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because insufficient fee\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", *err_string);\n     }\n \n     // Calculate all conflicting entries and enforce Rule #5.\n     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, ws.m_all_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because too many potential replacements\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,\n                              \"too many potential replacements\", *err_string);\n     }\n     // Enforce Rule #2.\n     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, ws.m_iters_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because replacement-adds-unconfirmed\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466538340",
      "id" : 1466538340,
      "line" : 1046,
      "node_id" : "PRRC_kwDOABII585XaZlk",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 1046,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 140,
      "pull_request_review_id" : 1843901103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466538340/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466538340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466648992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466648992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you mean all of the sibling eviction logic? That doesn't work because we'd only enforce that the tx pays enough to evict siblings OR conflicting transactions; it needs to pay for both.\r\n\r\nIf you mean the logic adding stuff to `m_conflicts`, `m_iters_conflicting`, etc., it's because I don't like in-out parameters.",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T16:41:49Z",
      "diff_hunk" : "@@ -967,7 +972,19 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     CTxMemPool::setEntries collective_ancestors = *ancestors;\n     collective_ancestors.merge(ws.m_ancestors_of_in_package_ancestors);\n     if (const auto err{ApplyV3Rules(ws.m_ptx, collective_ancestors, ws.m_num_in_package_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", err->first);\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466648992",
      "id" : 1466648992,
      "in_reply_to_id" : 1466531988,
      "line" : 976,
      "node_id" : "PRRC_kwDOABII585Xa0mg",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 976,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 101,
      "pull_request_review_id" : 1844187891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466648992/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T16:41:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466648992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466657588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466657588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the latter, but at least you gave a reason why not",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T16:45:51Z",
      "diff_hunk" : "@@ -967,7 +972,19 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     CTxMemPool::setEntries collective_ancestors = *ancestors;\n     collective_ancestors.merge(ws.m_ancestors_of_in_package_ancestors);\n     if (const auto err{ApplyV3Rules(ws.m_ptx, collective_ancestors, ws.m_num_in_package_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", err->first);\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466657588",
      "id" : 1466657588,
      "in_reply_to_id" : 1466531988,
      "line" : 976,
      "node_id" : "PRRC_kwDOABII585Xa2s0",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 976,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 101,
      "pull_request_review_id" : 1844202854,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466657588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T16:45:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466657588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466658531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466658531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's impossible to hit, since we're v3-only and it can't have another ancestor. Maybe we just omit this case? I figured somebody would advocate for having it just in case.",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-25T16:46:25Z",
      "diff_hunk" : "@@ -1007,16 +1024,28 @@ bool MemPoolAccept::ReplacementChecks(Workspace& ws)\n         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not\n         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.\n         // This must be changed if package RBF is enabled.\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because insufficient fee\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", *err_string);\n     }\n \n     // Calculate all conflicting entries and enforce Rule #5.\n     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, ws.m_all_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because too many potential replacements\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,\n                              \"too many potential replacements\", *err_string);\n     }\n     // Enforce Rule #2.\n     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, ws.m_iters_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because replacement-adds-unconfirmed\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1466658531",
      "id" : 1466658531,
      "in_reply_to_id" : 1466538340,
      "line" : 1046,
      "node_id" : "PRRC_kwDOABII585Xa27j",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 1046,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 140,
      "pull_request_review_id" : 1844204623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466658531/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T16:46:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466658531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1467461085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467461085"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I think passing those in would be a bit unhygienic. `ApplyV3Rules` would be using the contents beforehand to decide whether a child would be replaced, and then potentially modifying it in a way that looks like the child would replace it.",
      "commit_id" : "72a8433074be557cc25de3ae2396e3b8573478d1",
      "created_at" : "2024-01-26T10:18:19Z",
      "diff_hunk" : "@@ -967,7 +972,19 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     CTxMemPool::setEntries collective_ancestors = *ancestors;\n     collective_ancestors.merge(ws.m_ancestors_of_in_package_ancestors);\n     if (const auto err{ApplyV3Rules(ws.m_ptx, collective_ancestors, ws.m_num_in_package_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", err->first);\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1467461085",
      "id" : 1467461085,
      "in_reply_to_id" : 1466531988,
      "line" : 976,
      "node_id" : "PRRC_kwDOABII585Xd63d",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 976,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 101,
      "pull_request_review_id" : 1845437541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467461085/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T10:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467461085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-02-10T04:43:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1936861861",
      "id" : 1936861861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29306",
      "node_id" : "IC_kwDOABII585zciql",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936861861/reactions"
      },
      "updated_at" : "2024-02-10T04:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936861861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Currently traveling but will push a rebase soon.\r\n\r\nEl El sÃ¡b, 10 feb 2024 a las 1:43, DrahtBot ***@***.***>\r\nescribiÃ³:\r\n\r\n> ð This pull request conflicts with the target branch and needs rebase\r\n> <https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes>\r\n> .\r\n>\r\n> â\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1936861861>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AGAEGGOQHPRFWDNWV3DTRRTYS33INAVCNFSM6AAAAABCI3QW5WVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTSMZWHA3DCOBWGE>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n",
      "created_at" : "2024-02-13T15:21:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1941768684",
      "id" : 1941768684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29306",
      "node_id" : "IC_kwDOABII585zvQns",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1941768684/reactions"
      },
      "updated_at" : "2024-02-13T15:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1941768684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1493792426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493792426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should be impossible right?  Maybe just an `Assume()` to check that there's no sibling eviction going on in this scenario?",
      "commit_id" : "96eadd132cc48a1f016beefd24e8faa71803c027",
      "created_at" : "2024-02-18T15:44:43Z",
      "diff_hunk" : "@@ -995,16 +1015,28 @@ bool MemPoolAccept::ReplacementChecks(Workspace& ws)\n         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not\n         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.\n         // This must be changed if package RBF is enabled.\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation and cannot bypass because insufficient fee\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", *err_string);\n     }\n \n     // Calculate all conflicting entries and enforce Rule #5.\n     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, ws.m_all_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation and cannot bypass because too many potential replacements\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,\n                              \"too many potential replacements\", *err_string);\n     }\n     // Enforce Rule #2.\n     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, ws.m_iters_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1493792426",
      "id" : 1493792426,
      "line" : 1036,
      "node_id" : "PRRC_kwDOABII585ZCXaq",
      "original_commit_id" : "55a6b995ce938e646de5cda73891053febab53f0",
      "original_line" : 1036,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 69,
      "pull_request_review_id" : 1887268593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493792426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-18T15:53:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493792426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1493837935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493837935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we also exclude the case where the sibling transaction has descendants of its own, which can happen as the result of a reorg? My concern is that our RBF rules today don't enforce incentive compatibility in such a situation, so it's not clear that we should support this case for now (post-cluster-mempool, this would be fine).",
      "commit_id" : "96eadd132cc48a1f016beefd24e8faa71803c027",
      "created_at" : "2024-02-18T20:22:41Z",
      "diff_hunk" : "@@ -214,10 +213,27 @@ std::optional<std::pair<std::string, CTransactionRef>> SingleV3Checks(const CTra\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n-            return std::make_pair(strprintf(\"tx %u (wtxid=%s) would exceed descendant count limit\",\n-                             parent_entry->GetSharedTx()->GetHash().ToString(),\n-                             parent_entry->GetSharedTx()->GetWitnessHash().ToString()),\n-                nullptr);\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if this transaction has\n+            // extra descendants due to a reorg.\n+            const bool consider_sibling_eviction{children.size() == 1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1493837935",
      "id" : 1493837935,
      "line" : 221,
      "node_id" : "PRRC_kwDOABII585ZCihv",
      "original_commit_id" : "55a6b995ce938e646de5cda73891053febab53f0",
      "original_line" : 221,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 94,
      "pull_request_review_id" : 1887319224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493837935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-18T20:22:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493837935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> alternative log lines are a bit noisy, but understandable and I have no good suggestions that reduce that much\r\n> I'm not sure how important it is to return the v3 error messages if sibling RBF fails. \r\n\r\nI've changed it to just add \"(including sibling eviction)\" when that is what's happening. The diff is less invasive this way, but let me know if still too clunky. I just want to avoid confusing users (\"wait, why am I getting an RBF error if I didn't try to replace anything?\").",
      "created_at" : "2024-02-19T12:02:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1952306161",
      "id" : 1952306161,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29306",
      "node_id" : "IC_kwDOABII5850XdPx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1952306161/reactions"
      },
      "updated_at" : "2024-02-19T12:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1952306161",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494446464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494446464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed this to be `parent_entry->GetCountWithDescendants() == 2` so no grandchildren and no other siblings.",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-19T12:03:18Z",
      "diff_hunk" : "@@ -214,10 +213,27 @@ std::optional<std::pair<std::string, CTransactionRef>> SingleV3Checks(const CTra\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n-            return std::make_pair(strprintf(\"tx %u (wtxid=%s) would exceed descendant count limit\",\n-                             parent_entry->GetSharedTx()->GetHash().ToString(),\n-                             parent_entry->GetSharedTx()->GetWitnessHash().ToString()),\n-                nullptr);\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if this transaction has\n+            // extra descendants due to a reorg.\n+            const bool consider_sibling_eviction{children.size() == 1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494446464",
      "id" : 1494446464,
      "in_reply_to_id" : 1493837935,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZE3GA",
      "original_commit_id" : "55a6b995ce938e646de5cda73891053febab53f0",
      "original_line" : 221,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : null,
      "pull_request_review_id" : 1888253362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494446464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T12:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494446464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447054"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added an `Assume`",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-19T12:03:51Z",
      "diff_hunk" : "@@ -995,16 +1015,28 @@ bool MemPoolAccept::ReplacementChecks(Workspace& ws)\n         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not\n         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.\n         // This must be changed if package RBF is enabled.\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation and cannot bypass because insufficient fee\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", *err_string);\n     }\n \n     // Calculate all conflicting entries and enforce Rule #5.\n     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, ws.m_all_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation and cannot bypass because too many potential replacements\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,\n                              \"too many potential replacements\", *err_string);\n     }\n     // Enforce Rule #2.\n     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, ws.m_iters_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447054",
      "id" : 1494447054,
      "in_reply_to_id" : 1493792426,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZE3PO",
      "original_commit_id" : "55a6b995ce938e646de5cda73891053febab53f0",
      "original_line" : 1036,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1888254319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T12:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Kept this and added an `Assume`, also see https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1493792426",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-19T12:04:12Z",
      "diff_hunk" : "@@ -1007,16 +1024,28 @@ bool MemPoolAccept::ReplacementChecks(Workspace& ws)\n         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not\n         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.\n         // This must be changed if package RBF is enabled.\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because insufficient fee\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", *err_string);\n     }\n \n     // Calculate all conflicting entries and enforce Rule #5.\n     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, ws.m_all_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because too many potential replacements\",\n+                                 strprintf(\"%s and %s\", *ws.m_sibling_eviction_failure_string, *err_string));\n+        }\n         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,\n                              \"too many potential replacements\", *err_string);\n     }\n     // Enforce Rule #2.\n     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, ws.m_iters_conflicting)}) {\n+        if (ws.m_sibling_eviction_failure_string.has_value()) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-violation and cannot bypass because replacement-adds-unconfirmed\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447437",
      "id" : 1494447437,
      "in_reply_to_id" : 1466538340,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZE3VN",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 1046,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1888255120,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T12:04:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-19T12:04:21Z",
      "diff_hunk" : "@@ -180,6 +180,21 @@ std::optional<std::pair<std::string, CTransactionRef>> ApplyV3Rules(const CTrans\n                 std::any_of(children.cbegin(), children.cend(),\n                     [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n             if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n+                // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+                // we don't conflict with it, consider evicting it under RBF rules. We rely on v3 rules",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447595",
      "id" : 1494447595,
      "in_reply_to_id" : 1466473683,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZE3Xr",
      "original_commit_id" : "58ebc34b930abaf4911c012e94eaa6ba0c5ee01c",
      "original_line" : 184,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : null,
      "pull_request_review_id" : 1888255374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T12:04:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-19T12:04:25Z",
      "diff_hunk" : "@@ -55,11 +55,11 @@ static_assert(V3_CHILD_MAX_VSIZE + MAX_STANDARD_TX_WEIGHT / WITNESS_SCALE_FACTOR\n  * @param[in]   vsize                   The sigop-adjusted virtual size of ptx.\n  * @returns an error string if any v3 rule was violated, otherwise std::nullopt.\n  */\n-std::optional<std::string> ApplyV3Rules(const CTransactionRef& ptx,\n-                                        const CTxMemPool::setEntries& mempool_ancestors,\n-                                        unsigned int num_in_pkg_ancestors,\n-                                        const std::set<Txid>& direct_conflicts,\n-                                        int64_t vsize);\n+std::optional<std::pair<std::string, CTransactionRef>> ApplyV3Rules(const CTransactionRef& ptx,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1494447749",
      "id" : 1494447749,
      "in_reply_to_id" : 1466484490,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZE3aF",
      "original_commit_id" : "a28681ed1c4291d0d9cc53f0faae07815d588449",
      "original_line" : 58,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.h",
      "position" : null,
      "pull_request_review_id" : 1888255580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T12:04:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494447749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496208017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496208017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "let's get a bit of test coverage of `->second`",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-20T17:20:32Z",
      "diff_hunk" : "@@ -115,7 +115,7 @@ BOOST_FIXTURE_TEST_CASE(version3_tests, RegTestingSetup)\n         const auto expected_error_str{strprintf(\"non-v3 tx %s (wtxid=%s) cannot spend from v3 tx %s (wtxid=%s)\",\n             tx_v2_from_v3->GetHash().ToString(), tx_v2_from_v3->GetWitnessHash().ToString(),\n             mempool_tx_v3->GetHash().ToString(), mempool_tx_v3->GetWitnessHash().ToString())};\n-        BOOST_CHECK(*SingleV3Checks(tx_v2_from_v3, *ancestors_v2_from_v3, empty_conflicts_set, GetVirtualTransactionSize(*tx_v2_from_v3)) == expected_error_str);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496208017",
      "id" : 1496208017,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII585ZLlKR",
      "original_commit_id" : "5fb874471f03f33e741f5493ff479e436e50804c",
      "original_line" : 118,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txvalidation_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1891040322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496208017/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T17:40:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496208017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496216091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496216091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "was this always erroneous?",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-20T17:25:25Z",
      "diff_hunk" : "@@ -85,7 +85,6 @@ std::optional<std::string> PackageV3Checks(const CTransactionRef& ptx, int64_t v\n             const auto parent_info = [&] {\n                 if (mempool_ancestors.size() > 0) {\n                     auto& mempool_parent = *mempool_ancestors.begin();\n-                    Assume(mempool_parent->GetCountWithDescendants() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496216091",
      "id" : 1496216091,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585ZLnIb",
      "original_commit_id" : "b751678dca2e7b73ccc864ebfcafcebbc36e3c4c",
      "original_line" : 88,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 4,
      "pull_request_review_id" : 1891040322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496216091/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T17:40:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496216091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496221417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496221417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "log/description of this test should get updated or maybe merged into test_v3_sibling_eviction",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-20T17:28:35Z",
      "diff_hunk" : "@@ -312,7 +312,8 @@ def test_mempool_sibling(self):\n             version=3\n         )\n         expected_error_mempool_sibling = f\"v3-rule-violation, tx {tx_mempool_parent['txid']} (wtxid={tx_mempool_parent['wtxid']}) would exceed descendant count limit\"\n-        assert_raises_rpc_error(-26, expected_error_mempool_sibling, node.sendrawtransaction, tx_has_mempool_sibling[\"hex\"])\n+        expected_error_mempool_sibling_no_eviction = f\"insufficient fee (including sibling eviction), rejecting replacement\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496221417",
      "id" : 1496221417,
      "line" : 318,
      "node_id" : "PRRC_kwDOABII585ZLobp",
      "original_commit_id" : "b751678dca2e7b73ccc864ebfcafcebbc36e3c4c",
      "original_line" : 315,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : 19,
      "pull_request_review_id" : 1891040322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496221417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T17:40:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496221417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496235168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496235168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n        # However, an RBF (with conflicting inputs) is possible even if the resulting cluster exceeds size 2\r\n```",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-20T17:37:02Z",
      "diff_hunk" : "@@ -430,11 +433,123 @@ def test_reorg_2child_rbf(self):\n         self.check_mempool([ancestor_tx[\"txid\"], child_1_conflict[\"txid\"], child_2[\"txid\"]])\n         assert_equal(node.getmempoolentry(ancestor_tx[\"txid\"])[\"descendantcount\"], 3)\n \n+    @cleanup(extra_args=[\"-acceptnonstdtxn=1\"])\n+    def test_v3_sibling_eviction(self):\n+        self.log.info(\"Test sibling eviction for v3\")\n+        node = self.nodes[0]\n+        tx_v3_parent = self.wallet.send_self_transfer_multi(from_node=node, num_outputs=2, version=3)\n+        # This is the sibling to replace\n+        tx_v3_child_1 = self.wallet.send_self_transfer(\n+            from_node=node, utxo_to_spend=tx_v3_parent[\"new_utxos\"][0], fee_rate=DEFAULT_FEE * 2, version=3\n+        )\n+        assert tx_v3_child_1[\"txid\"] in node.getrawmempool()\n+\n+        self.log.info(\"Test tx must be higher feerate than sibling to evict it\")\n+        tx_v3_child_2_rule6 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=DEFAULT_FEE, version=3\n+        )\n+        rule6_str = f\"insufficient fee (including sibling eviction), rejecting replacement {tx_v3_child_2_rule6['txid']}; new feerate\"\n+        assert_raises_rpc_error(-26, rule6_str, node.sendrawtransaction, tx_v3_child_2_rule6[\"hex\"])\n+        self.check_mempool([tx_v3_parent['txid'], tx_v3_child_1['txid']])\n+\n+        self.log.info(\"Test tx must meet absolute fee rules to evict sibling\")\n+        tx_v3_child_2_rule4 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=2 * DEFAULT_FEE + Decimal(\"0.00000001\"), version=3\n+        )\n+        rule4_str = f\"insufficient fee (including sibling eviction), rejecting replacement {tx_v3_child_2_rule4['txid']}, not enough additional fees to relay\"\n+        assert_raises_rpc_error(-26, rule4_str, node.sendrawtransaction, tx_v3_child_2_rule4[\"hex\"])\n+        self.check_mempool([tx_v3_parent['txid'], tx_v3_child_1['txid']])\n+\n+        self.log.info(\"Test tx cannot cause more than 100 evictions including RBF and sibling eviction\")\n+        # First add 4 groups of 25 transactions.\n+        utxos_for_conflict = []\n+        txids_v2_100 = []\n+        for _ in range(4):\n+            confirmed_utxo = self.wallet.get_utxo(confirmed_only=True)\n+            utxos_for_conflict.append(confirmed_utxo)\n+            # 25 is within descendant limits\n+            chain_length = int(MAX_REPLACEMENT_CANDIDATES / 4)\n+            chain = self.wallet.create_self_transfer_chain(chain_length=chain_length, utxo_to_spend=confirmed_utxo)\n+            for item in chain:\n+                txids_v2_100.append(item[\"txid\"])\n+                node.sendrawtransaction(item[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_1[\"txid\"]])\n+\n+        # Replacing 100 transactions is fine\n+        tx_v3_replacement_only = self.wallet.create_self_transfer_multi(utxos_to_spend=utxos_for_conflict, fee_per_output=4000000)\n+        # Override maxfeerate - it costs a lot to replace these 100 transactions.\n+        assert node.testmempoolaccept([tx_v3_replacement_only[\"hex\"]], maxfeerate=0)[0][\"allowed\"]\n+        # Adding another one exceeds the limit.\n+        utxos_for_conflict.append(tx_v3_parent[\"new_utxos\"][1])\n+        tx_v3_child_2_rule5 = self.wallet.create_self_transfer_multi(utxos_to_spend=utxos_for_conflict, fee_per_output=4000000, version=3)\n+        rule5_str = f\"too many potential replacements (including sibling eviction), rejecting replacement {tx_v3_child_2_rule5['txid']}; too many potential replacements (101 > 100)\"\n+        assert_raises_rpc_error(-26, rule5_str, node.sendrawtransaction, tx_v3_child_2_rule5[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_1[\"txid\"]])\n+\n+        self.log.info(\"Test sibling eviction is successful if it meets all RBF rules\")\n+        tx_v3_child_2 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=DEFAULT_FEE*10, version=3\n+        )\n+        node.sendrawtransaction(tx_v3_child_2[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_2[\"txid\"]])\n+\n+        self.log.info(\"Test that it's possible to do a sibling eviction and RBF at the same time\")\n+        utxo_unrelated_conflict = self.wallet.get_utxo(confirmed_only=True)\n+        tx_unrelated_replacee = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=utxo_unrelated_conflict)\n+        assert tx_unrelated_replacee[\"txid\"] in node.getrawmempool()\n+\n+        fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)\n+\n+        tx_v3_child_3 = self.wallet.create_self_transfer_multi(\n+            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], fee_per_output=fee_to_beat_child2*5, version=3\n+        )\n+        node.sendrawtransaction(tx_v3_child_3[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_3[\"txid\"]])\n+\n+    @cleanup(extra_args=[\"-acceptnonstdtxn=1\"])\n+    def test_reorg_sibling_eviction_1p2c(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Test that sibling eviction is not allowed when multiple siblings exist\")\n+\n+        tx_with_multi_children = self.wallet.send_self_transfer_multi(from_node=node, num_outputs=3, version=3, confirmed_only=True)\n+        self.check_mempool([tx_with_multi_children[\"txid\"]])\n+\n+        block_to_disconnect = self.generate(node, 1)[0]\n+        self.check_mempool([])\n+\n+        tx_with_sibling1 = self.wallet.send_self_transfer(from_node=node, version=3, utxo_to_spend=tx_with_multi_children[\"new_utxos\"][0])\n+        tx_with_sibling2 = self.wallet.send_self_transfer(from_node=node, version=3, utxo_to_spend=tx_with_multi_children[\"new_utxos\"][1])\n+        self.check_mempool([tx_with_sibling1[\"txid\"], tx_with_sibling2[\"txid\"]])\n+\n+        # Create a reorg, bringing tx_with_multi_children back into the mempool with a descendant count of 3.\n+        node.invalidateblock(block_to_disconnect)\n+        self.check_mempool([tx_with_multi_children[\"txid\"], tx_with_sibling1[\"txid\"], tx_with_sibling2[\"txid\"]])\n+        assert_equal(node.getmempoolentry(tx_with_multi_children[\"txid\"])[\"descendantcount\"], 3)\n+\n+        # Sibling eviction is not allowed because there are two siblings\n+        tx_with_sibling3 = self.wallet.create_self_transfer(\n+            version=3,\n+            utxo_to_spend=tx_with_multi_children[\"new_utxos\"][2],\n+            fee_rate=DEFAULT_FEE*50\n+        )\n+        expected_error_2siblings = f\"v3-rule-violation, tx {tx_with_multi_children['txid']} (wtxid={tx_with_multi_children['wtxid']}) would exceed descendant count limit\"\n+        assert_raises_rpc_error(-26, expected_error_2siblings, node.sendrawtransaction, tx_with_sibling3[\"hex\"])\n+\n+        # However, an RBF (with conflicting inputs) is possible",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496235168",
      "id" : 1496235168,
      "line" : 538,
      "node_id" : "PRRC_kwDOABII585ZLryg",
      "original_commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "original_line" : 538,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : 120,
      "pull_request_review_id" : 1891040322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496235168/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T17:40:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496235168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496342131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496342131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I had the same question -- as far as I can tell, it's fine to leave this Assume() in? (see line 135)",
      "commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "created_at" : "2024-02-20T18:55:16Z",
      "diff_hunk" : "@@ -85,7 +85,6 @@ std::optional<std::string> PackageV3Checks(const CTransactionRef& ptx, int64_t v\n             const auto parent_info = [&] {\n                 if (mempool_ancestors.size() > 0) {\n                     auto& mempool_parent = *mempool_ancestors.begin();\n-                    Assume(mempool_parent->GetCountWithDescendants() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1496342131",
      "id" : 1496342131,
      "in_reply_to_id" : 1496216091,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585ZMF5z",
      "original_commit_id" : "b751678dca2e7b73ccc864ebfcafcebbc36e3c4c",
      "original_line" : 88,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 4,
      "pull_request_review_id" : 1891278290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496342131/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T18:58:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496342131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497818462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497818462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right, it's not necessary. I think all we need is to gate on `ATMPArgs::m_allow_replacement` to not hit it in a multi-testmempoolaccept.",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T15:46:22Z",
      "diff_hunk" : "@@ -85,7 +85,6 @@ std::optional<std::string> PackageV3Checks(const CTransactionRef& ptx, int64_t v\n             const auto parent_info = [&] {\n                 if (mempool_ancestors.size() > 0) {\n                     auto& mempool_parent = *mempool_ancestors.begin();\n-                    Assume(mempool_parent->GetCountWithDescendants() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497818462",
      "id" : 1497818462,
      "in_reply_to_id" : 1496216091,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZRuVe",
      "original_commit_id" : "b751678dca2e7b73ccc864ebfcafcebbc36e3c4c",
      "original_line" : 88,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : null,
      "pull_request_review_id" : 1893573444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497818462/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T15:46:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497818462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've repurposed this test to check that sibling eviction is not allowed through multi-testmempoolaccept or submitpackage",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T17:32:18Z",
      "diff_hunk" : "@@ -312,7 +312,8 @@ def test_mempool_sibling(self):\n             version=3\n         )\n         expected_error_mempool_sibling = f\"v3-rule-violation, tx {tx_mempool_parent['txid']} (wtxid={tx_mempool_parent['wtxid']}) would exceed descendant count limit\"\n-        assert_raises_rpc_error(-26, expected_error_mempool_sibling, node.sendrawtransaction, tx_has_mempool_sibling[\"hex\"])\n+        expected_error_mempool_sibling_no_eviction = f\"insufficient fee (including sibling eviction), rejecting replacement\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979346",
      "id" : 1497979346,
      "in_reply_to_id" : 1496221417,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZSVnS",
      "original_commit_id" : "b751678dca2e7b73ccc864ebfcafcebbc36e3c4c",
      "original_line" : 315,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 1893972686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979346/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T17:32:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added checks that all the others have `nullptr`. Also added unit tests for whether sibling is returned when {1p1c, 1p2c, 3gen} is in mempool.",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T17:32:24Z",
      "diff_hunk" : "@@ -115,7 +115,7 @@ BOOST_FIXTURE_TEST_CASE(version3_tests, RegTestingSetup)\n         const auto expected_error_str{strprintf(\"non-v3 tx %s (wtxid=%s) cannot spend from v3 tx %s (wtxid=%s)\",\n             tx_v2_from_v3->GetHash().ToString(), tx_v2_from_v3->GetWitnessHash().ToString(),\n             mempool_tx_v3->GetHash().ToString(), mempool_tx_v3->GetWitnessHash().ToString())};\n-        BOOST_CHECK(*SingleV3Checks(tx_v2_from_v3, *ancestors_v2_from_v3, empty_conflicts_set, GetVirtualTransactionSize(*tx_v2_from_v3)) == expected_error_str);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979453",
      "id" : 1497979453,
      "in_reply_to_id" : 1496208017,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII585ZSVo9",
      "original_commit_id" : "5fb874471f03f33e741f5493ff479e436e50804c",
      "original_line" : 118,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txvalidation_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1893972995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979453/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T17:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979615"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T17:32:32Z",
      "diff_hunk" : "@@ -430,11 +433,123 @@ def test_reorg_2child_rbf(self):\n         self.check_mempool([ancestor_tx[\"txid\"], child_1_conflict[\"txid\"], child_2[\"txid\"]])\n         assert_equal(node.getmempoolentry(ancestor_tx[\"txid\"])[\"descendantcount\"], 3)\n \n+    @cleanup(extra_args=[\"-acceptnonstdtxn=1\"])\n+    def test_v3_sibling_eviction(self):\n+        self.log.info(\"Test sibling eviction for v3\")\n+        node = self.nodes[0]\n+        tx_v3_parent = self.wallet.send_self_transfer_multi(from_node=node, num_outputs=2, version=3)\n+        # This is the sibling to replace\n+        tx_v3_child_1 = self.wallet.send_self_transfer(\n+            from_node=node, utxo_to_spend=tx_v3_parent[\"new_utxos\"][0], fee_rate=DEFAULT_FEE * 2, version=3\n+        )\n+        assert tx_v3_child_1[\"txid\"] in node.getrawmempool()\n+\n+        self.log.info(\"Test tx must be higher feerate than sibling to evict it\")\n+        tx_v3_child_2_rule6 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=DEFAULT_FEE, version=3\n+        )\n+        rule6_str = f\"insufficient fee (including sibling eviction), rejecting replacement {tx_v3_child_2_rule6['txid']}; new feerate\"\n+        assert_raises_rpc_error(-26, rule6_str, node.sendrawtransaction, tx_v3_child_2_rule6[\"hex\"])\n+        self.check_mempool([tx_v3_parent['txid'], tx_v3_child_1['txid']])\n+\n+        self.log.info(\"Test tx must meet absolute fee rules to evict sibling\")\n+        tx_v3_child_2_rule4 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=2 * DEFAULT_FEE + Decimal(\"0.00000001\"), version=3\n+        )\n+        rule4_str = f\"insufficient fee (including sibling eviction), rejecting replacement {tx_v3_child_2_rule4['txid']}, not enough additional fees to relay\"\n+        assert_raises_rpc_error(-26, rule4_str, node.sendrawtransaction, tx_v3_child_2_rule4[\"hex\"])\n+        self.check_mempool([tx_v3_parent['txid'], tx_v3_child_1['txid']])\n+\n+        self.log.info(\"Test tx cannot cause more than 100 evictions including RBF and sibling eviction\")\n+        # First add 4 groups of 25 transactions.\n+        utxos_for_conflict = []\n+        txids_v2_100 = []\n+        for _ in range(4):\n+            confirmed_utxo = self.wallet.get_utxo(confirmed_only=True)\n+            utxos_for_conflict.append(confirmed_utxo)\n+            # 25 is within descendant limits\n+            chain_length = int(MAX_REPLACEMENT_CANDIDATES / 4)\n+            chain = self.wallet.create_self_transfer_chain(chain_length=chain_length, utxo_to_spend=confirmed_utxo)\n+            for item in chain:\n+                txids_v2_100.append(item[\"txid\"])\n+                node.sendrawtransaction(item[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_1[\"txid\"]])\n+\n+        # Replacing 100 transactions is fine\n+        tx_v3_replacement_only = self.wallet.create_self_transfer_multi(utxos_to_spend=utxos_for_conflict, fee_per_output=4000000)\n+        # Override maxfeerate - it costs a lot to replace these 100 transactions.\n+        assert node.testmempoolaccept([tx_v3_replacement_only[\"hex\"]], maxfeerate=0)[0][\"allowed\"]\n+        # Adding another one exceeds the limit.\n+        utxos_for_conflict.append(tx_v3_parent[\"new_utxos\"][1])\n+        tx_v3_child_2_rule5 = self.wallet.create_self_transfer_multi(utxos_to_spend=utxos_for_conflict, fee_per_output=4000000, version=3)\n+        rule5_str = f\"too many potential replacements (including sibling eviction), rejecting replacement {tx_v3_child_2_rule5['txid']}; too many potential replacements (101 > 100)\"\n+        assert_raises_rpc_error(-26, rule5_str, node.sendrawtransaction, tx_v3_child_2_rule5[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_1[\"txid\"]])\n+\n+        self.log.info(\"Test sibling eviction is successful if it meets all RBF rules\")\n+        tx_v3_child_2 = self.wallet.create_self_transfer(\n+            utxo_to_spend=tx_v3_parent[\"new_utxos\"][1], fee_rate=DEFAULT_FEE*10, version=3\n+        )\n+        node.sendrawtransaction(tx_v3_child_2[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_2[\"txid\"]])\n+\n+        self.log.info(\"Test that it's possible to do a sibling eviction and RBF at the same time\")\n+        utxo_unrelated_conflict = self.wallet.get_utxo(confirmed_only=True)\n+        tx_unrelated_replacee = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=utxo_unrelated_conflict)\n+        assert tx_unrelated_replacee[\"txid\"] in node.getrawmempool()\n+\n+        fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)\n+\n+        tx_v3_child_3 = self.wallet.create_self_transfer_multi(\n+            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], fee_per_output=fee_to_beat_child2*5, version=3\n+        )\n+        node.sendrawtransaction(tx_v3_child_3[\"hex\"])\n+        self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_3[\"txid\"]])\n+\n+    @cleanup(extra_args=[\"-acceptnonstdtxn=1\"])\n+    def test_reorg_sibling_eviction_1p2c(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Test that sibling eviction is not allowed when multiple siblings exist\")\n+\n+        tx_with_multi_children = self.wallet.send_self_transfer_multi(from_node=node, num_outputs=3, version=3, confirmed_only=True)\n+        self.check_mempool([tx_with_multi_children[\"txid\"]])\n+\n+        block_to_disconnect = self.generate(node, 1)[0]\n+        self.check_mempool([])\n+\n+        tx_with_sibling1 = self.wallet.send_self_transfer(from_node=node, version=3, utxo_to_spend=tx_with_multi_children[\"new_utxos\"][0])\n+        tx_with_sibling2 = self.wallet.send_self_transfer(from_node=node, version=3, utxo_to_spend=tx_with_multi_children[\"new_utxos\"][1])\n+        self.check_mempool([tx_with_sibling1[\"txid\"], tx_with_sibling2[\"txid\"]])\n+\n+        # Create a reorg, bringing tx_with_multi_children back into the mempool with a descendant count of 3.\n+        node.invalidateblock(block_to_disconnect)\n+        self.check_mempool([tx_with_multi_children[\"txid\"], tx_with_sibling1[\"txid\"], tx_with_sibling2[\"txid\"]])\n+        assert_equal(node.getmempoolentry(tx_with_multi_children[\"txid\"])[\"descendantcount\"], 3)\n+\n+        # Sibling eviction is not allowed because there are two siblings\n+        tx_with_sibling3 = self.wallet.create_self_transfer(\n+            version=3,\n+            utxo_to_spend=tx_with_multi_children[\"new_utxos\"][2],\n+            fee_rate=DEFAULT_FEE*50\n+        )\n+        expected_error_2siblings = f\"v3-rule-violation, tx {tx_with_multi_children['txid']} (wtxid={tx_with_multi_children['wtxid']}) would exceed descendant count limit\"\n+        assert_raises_rpc_error(-26, expected_error_2siblings, node.sendrawtransaction, tx_with_sibling3[\"hex\"])\n+\n+        # However, an RBF (with conflicting inputs) is possible",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1497979615",
      "id" : 1497979615,
      "in_reply_to_id" : 1496235168,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZSVrf",
      "original_commit_id" : "8ee900fba998a3edac0da4f4632bb2a3f06cc7b1",
      "original_line" : 538,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 1893973458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979615/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T17:32:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497979615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498032703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498032703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we care about the case where the other child is not itself v3 and is not signaling for opt-in-rbf?  As this can only happen as the result of a reorg, I don't think we care, but maybe it's worth mentioning somewhere that we'd process the replacement anyway.  ",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T17:58:37Z",
      "diff_hunk" : "@@ -214,10 +215,19 @@ std::optional<std::pair<std::string, CTransactionRef>> SingleV3Checks(const CTra\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict inputs with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if the transaction has\n+            // multiple children or the sibling also has descendants due to a reorg.\n+            const bool consider_sibling_eviction{parent_entry->GetCountWithDescendants() == 2};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498032703",
      "id" : 1498032703,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585ZSio_",
      "original_commit_id" : "eb1dbf9564514f1a14fc69ee7717d0d9a8d96633",
      "original_line" : 223,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 78,
      "pull_request_review_id" : 1894064754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498032703/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T17:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498032703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498086476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498086476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that we shouldn't care about it signaling v3 or BIP125. Will add comment.",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T18:25:18Z",
      "diff_hunk" : "@@ -214,10 +215,19 @@ std::optional<std::pair<std::string, CTransactionRef>> SingleV3Checks(const CTra\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict inputs with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if the transaction has\n+            // multiple children or the sibling also has descendants due to a reorg.\n+            const bool consider_sibling_eviction{parent_entry->GetCountWithDescendants() == 2};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498086476",
      "id" : 1498086476,
      "in_reply_to_id" : 1498032703,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585ZSvxM",
      "original_commit_id" : "eb1dbf9564514f1a14fc69ee7717d0d9a8d96633",
      "original_line" : 223,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 78,
      "pull_request_review_id" : 1894129784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498086476/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T18:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498086476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498102589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498102589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            // the descendant count is done separately in SingleV3Checks for v3 transactions.\r\n```",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-21T18:36:00Z",
      "diff_hunk" : "@@ -954,8 +958,27 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     }\n \n     ws.m_ancestors = *ancestors;\n-    if (const auto err_string{SingleV3Checks(ws.m_ptx, ws.m_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", *err_string);\n+    // Even though just checking direct mempool parents for inheritance would be sufficient, we\n+    // check using the full ancestor set here because it's more convenient to use what we have\n+    // already calculated.\n+    if (const auto err{SingleV3Checks(ws.m_ptx, ws.m_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission && args.m_allow_replacement) {\n+            // Potential sibling eviction. Add the sibling to our list of mempool conflicts to be\n+            // included in RBF checks.\n+            ws.m_conflicts.insert(err->second->GetHash());\n+            // Adding the sibling to m_iters_conflicting here means that it doesn't count towards\n+            // RBF Carve Out above. This is correct, since removing to-be-replaced transactions from\n+            // the descendant count is done separately in ApplyV3Rules for v3 transactions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498102589",
      "id" : 1498102589,
      "line" : 972,
      "node_id" : "PRRC_kwDOABII585ZSzs9",
      "original_commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "original_line" : 972,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 1894149228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498102589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T18:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498102589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK apart from @instagibbs' nit here: https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1498102589",
      "created_at" : "2024-02-22T15:22:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#issuecomment-1959678050",
      "id" : 1959678050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29306",
      "node_id" : "IC_kwDOABII5850zlBi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959678050/reactions"
      },
      "updated_at" : "2024-02-22T15:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959678050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500918986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500918986"
         }
      },
      "author_association" : "MEMBER",
      "body" : "tighten checks a bit further to make sure this is incentive compatible?\r\n```suggestion\r\n            const bool consider_sibling_eviction{parent_entry->GetCountWithDescendants() == 2 &&\r\n                children.begin()->get().GetCountWithAncestors() == 2};\r\n```",
      "commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "created_at" : "2024-02-23T16:41:49Z",
      "diff_hunk" : "@@ -210,9 +215,19 @@ std::optional<std::string> SingleV3Checks(const CTransactionRef& ptx,\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n-            return strprintf(\"tx %u (wtxid=%s) would exceed descendant count limit\",\n-                             parent_entry->GetSharedTx()->GetHash().ToString(),\n-                             parent_entry->GetSharedTx()->GetWitnessHash().ToString());\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict inputs with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if the transaction has\n+            // multiple children or the sibling also has descendants due to a reorg.\n+            const bool consider_sibling_eviction{parent_entry->GetCountWithDescendants() == 2};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500918986",
      "id" : 1500918986,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585ZdjTK",
      "original_commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "original_line" : 223,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : 78,
      "pull_request_review_id" : 1898527213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500918986/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T16:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500918986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500969997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500969997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed",
      "commit_id" : "77b0b8c6f2bf2a2020965ef2ef73f0881e224e7f",
      "created_at" : "2024-02-23T17:26:25Z",
      "diff_hunk" : "@@ -954,8 +958,27 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     }\n \n     ws.m_ancestors = *ancestors;\n-    if (const auto err_string{SingleV3Checks(ws.m_ptx, ws.m_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n-        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"v3-rule-violation\", *err_string);\n+    // Even though just checking direct mempool parents for inheritance would be sufficient, we\n+    // check using the full ancestor set here because it's more convenient to use what we have\n+    // already calculated.\n+    if (const auto err{SingleV3Checks(ws.m_ptx, ws.m_ancestors, ws.m_conflicts, ws.m_vsize)}) {\n+        // Disabled within package validation.\n+        if (err->second != nullptr && !args.m_package_submission && args.m_allow_replacement) {\n+            // Potential sibling eviction. Add the sibling to our list of mempool conflicts to be\n+            // included in RBF checks.\n+            ws.m_conflicts.insert(err->second->GetHash());\n+            // Adding the sibling to m_iters_conflicting here means that it doesn't count towards\n+            // RBF Carve Out above. This is correct, since removing to-be-replaced transactions from\n+            // the descendant count is done separately in ApplyV3Rules for v3 transactions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500969997",
      "id" : 1500969997,
      "in_reply_to_id" : 1498102589,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZdvwN",
      "original_commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "original_line" : 972,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1898606739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500969997/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T17:26:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500969997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500970127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500970127"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added",
      "commit_id" : "77b0b8c6f2bf2a2020965ef2ef73f0881e224e7f",
      "created_at" : "2024-02-23T17:26:33Z",
      "diff_hunk" : "@@ -210,9 +215,19 @@ std::optional<std::string> SingleV3Checks(const CTransactionRef& ptx,\n             std::any_of(children.cbegin(), children.cend(),\n                 [&direct_conflicts](const CTxMemPoolEntry& child){return direct_conflicts.count(child.GetTx().GetHash()) > 0;});\n         if (parent_entry->GetCountWithDescendants() + 1 > V3_DESCENDANT_LIMIT && !child_will_be_replaced) {\n-            return strprintf(\"tx %u (wtxid=%s) would exceed descendant count limit\",\n-                             parent_entry->GetSharedTx()->GetHash().ToString(),\n-                             parent_entry->GetSharedTx()->GetWitnessHash().ToString());\n+            // Allow sibling eviction for v3 transaction: if another child already exists, even if\n+            // we don't conflict inputs with it, consider evicting it under RBF rules. We rely on v3 rules\n+            // only permitting 1 descendant, as otherwise we would need to have logic for deciding\n+            // which descendant to evict. Skip if this isn't true, e.g. if the transaction has\n+            // multiple children or the sibling also has descendants due to a reorg.\n+            const bool consider_sibling_eviction{parent_entry->GetCountWithDescendants() == 2};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29306#discussion_r1500970127",
      "id" : 1500970127,
      "in_reply_to_id" : 1500918986,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZdvyP",
      "original_commit_id" : "ac7527fff4704437cb728ba56f777ba047fe7d46",
      "original_line" : 223,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/policy/v3_policy.cpp",
      "position" : null,
      "pull_request_review_id" : 1898606951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29306",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500970127/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T17:26:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500970127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
