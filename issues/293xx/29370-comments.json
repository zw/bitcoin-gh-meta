[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29370).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29355](https://github.com/bitcoin/bitcoin/pull/29355) (doc: Assert that assumed-valid blocks are not fully valid in CheckBlockIndex() by maflcko)\n* [#29349](https://github.com/bitcoin/bitcoin/pull/29349) (refactor: Remove nChainTx from consensus by maflcko)\n* [#29331](https://github.com/bitcoin/bitcoin/pull/29331) (redeclare nChainTx to use uint64_t by russeree)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-02-02T16:18:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#issuecomment-1924196872",
      "id" : 1924196872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29370",
      "node_id" : "IC_kwDOABII585ysOoI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924196872/reactions"
      },
      "updated_at" : "2024-02-02T18:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924196872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Backwards compatibility code in LoadBlockIndex to override `nTx == 1` values set by previous code when they are fake (when ` (pindex->nStatus & BLOCK_VALID_MASK) < BLOCK_VALID_TRANSACTIONS`)\r\n\r\nNot sure. This can only happen on test-chains, so I think it would be cleaner to just require the developers, if there are any, to finish their background sync, or to wipe their chainstate, or the blocksdir, or the whole test data dir.",
      "created_at" : "2024-02-02T16:47:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#issuecomment-1924254747",
      "id" : 1924254747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29370",
      "node_id" : "IC_kwDOABII585yscwb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924254747/reactions"
      },
      "updated_at" : "2024-02-02T16:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924254747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/21160915955</sub>",
      "created_at" : "2024-02-02T17:16:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#issuecomment-1924315726",
      "id" : 1924315726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29370",
      "node_id" : "IC_kwDOABII585ysrpO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924315726/reactions"
      },
      "updated_at" : "2024-02-02T17:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924315726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Not sure. This can only happen on test-chains, so I think it would be cleaner to just require the developers, if there are any, to finish their background sync, or to wipe their chainstate, or the blocksdir, or the whole test data dir.\r\n\r\nIt makes sense that having backwards compatibility may not be worth it, but I don't see why test chains would set `nTx` to a real value without also setting BLOCK_VALID_TRANSACTIONS. It seems like we should be able to use BLOCK_VALID_TRANSACTIONS to know if nTx is real or fake, as long as we are checking for BLOCK_VALID_TRANSACTIONS, directly, and not using the IsValid() helper which is also influenced by BLOCK_FAILED flags.\r\n\r\n---\r\n\r\nUpdated 4c70d993e3ac0e9b7923eded51826fe1faa2d004 -> a3228f02f69e28960f7da76054965c916e781f27 ([`pr/nofake.1`](https://github.com/ryanofsky/bitcoin/commits/pr/nofake.1) -> [`pr/nofake.2`](https://github.com/ryanofsky/bitcoin/commits/pr/nofake.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/nofake.1..pr/nofake.2)) to fix broken validation_block_tests due to a buggy check, also making some minor cleanups",
      "created_at" : "2024-02-02T18:44:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#issuecomment-1924479030",
      "id" : 1924479030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29370",
      "node_id" : "IC_kwDOABII585ytTg2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924479030/reactions"
      },
      "updated_at" : "2024-02-02T18:44:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924479030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477981888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477981888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to touch this LOC?",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T10:39:14Z",
      "diff_hunk" : "@@ -168,21 +169,18 @@ class CBlockIndex\n     //! (memory only) Total amount of work (expected number of hashes) in the chain up to and including this block\n     arith_uint256 nChainWork{};\n \n-    //! Number of transactions in this block.\n+    //! Number of transactions in this block. This will be nonzero if the block\n+    //! reached the VALID_TRANSACTIONS validity level, and zero otherwise.\n     //! Note: in a potential headers-first mode, this number cannot be relied upon\n     //! Note: this value is faked during UTXO snapshot load to ensure that\n     //! LoadBlockIndex() will load index entries for blocks that we lack data for.\n     //! @sa ActivateSnapshot\n     unsigned int nTx{0};\n \n     //! (memory only) Number of transactions in the chain up to and including this block.\n-    //! This value will be non-zero only if and only if transactions for this block and all its parents are available.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477981888",
      "id" : 1477981888,
      "line" : 180,
      "node_id" : "PRRC_kwDOABII585YGDbA",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 180,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 67,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477981888/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477981888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477996772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477996772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            index->nChainTx = 0;\r\n```\r\n\r\nisn't this always true? Maybe you meant to type `-` instead of `<`?\r\n\r\nIn any case, the test seems to be passing either way, so this is \"dead\" code, similar to a code comment.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T10:51:34Z",
      "diff_hunk" : "@@ -465,6 +465,12 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+            index->nTx = 0;\n+            // Keep nChainTx for the snapshot base since it is part of the\n+            // snapshot metadata. Reset it for other blocks this is simulating\n+            // not having been downloaded yet.\n+            if (i < last_assumed_valid_idx == 1) index->nChainTx = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477996772",
      "id" : 1477996772,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YGHDk",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 472,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477996772/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477996772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998490"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to change the sequence id? I think this isn't changed in `loadtxoutset` either?",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T10:53:08Z",
      "diff_hunk" : "@@ -91,13 +91,10 @@ CreateAndActivateUTXOSnapshot(\n             // these blocks instead\n             CBlockIndex *pindex = orig_tip;\n             while (pindex && pindex != chain.m_chain.Tip()) {\n-                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n-                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n-                // We have to set the ASSUMED_VALID flag, because otherwise it\n-                // would not be possible to have a block index entry without HAVE_DATA\n-                // and with nTx > 0 (since we aren't setting the pruned flag);\n-                // see CheckBlockIndex().\n-                pindex->nStatus |= BLOCK_ASSUMED_VALID;\n+                pindex->nStatus = BlockStatus::BLOCK_VALID_TREE;\n+                pindex->nTx = 0;\n+                pindex->nChainTx = 0;\n+                pindex->nSequenceId = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998490",
      "id" : 1477998490,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585YGHea",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 103,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 20,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998490/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same (sequence id)",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T10:53:33Z",
      "diff_hunk" : "@@ -465,6 +465,12 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+            index->nTx = 0;\n+            // Keep nChainTx for the snapshot base since it is part of the\n+            // snapshot metadata. Reset it for other blocks this is simulating\n+            // not having been downloaded yet.\n+            if (i < last_assumed_valid_idx == 1) index->nChainTx = 0;\n+            index->nSequenceId = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998941",
      "id" : 1477998941,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YGHld",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 473,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1477998941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478006900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478006900"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is removing the validity check intended?",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T11:00:32Z",
      "diff_hunk" : "@@ -4577,15 +4577,7 @@ bool ChainstateManager::LoadBlockIndex()\n \n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            // If we have an assumeutxo-based chainstate, then the snapshot\n-            // block will be a candidate for the tip, but it may not be\n-            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n-            // so we special-case the snapshot block as a potential candidate\n-            // here.\n-            if (pindex == GetSnapshotBaseBlock() ||\n-                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478006900",
      "id" : 1478006900,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YGJh0",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4586,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478006900/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478006900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478018977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478018977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can this be further limited to only mark the snap_block if it has ASSUMED_VALID set? Otherwise, nodes which never used loadtxoutset will assume that some block is a \"snapshot block\", even though they never used that feature.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T11:11:04Z",
      "diff_hunk" : "@@ -4903,36 +4890,23 @@ void ChainstateManager::CheckBlockIndex()\n         if (!pindex->HaveNumChainTxs()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        // Unless these indexes are assumed valid and pending block download on a\n-        // background chainstate.\n-        if (!m_blockman.m_have_pruned && !pindex->IsAssumedValid()) {\n+        if (!m_blockman.m_have_pruned) {\n             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\n             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\n-            if (pindexFirstAssumeValid == nullptr) {\n-                // If we've got some assume valid blocks, then we might have\n-                // missing blocks (not HAVE_DATA) but still treat them as\n-                // having been processed (with a fake nTx value). Otherwise, we\n-                // can assert that these are the same.\n-                assert(pindexFirstMissing == pindexFirstNeverProcessed);\n-            }\n+            assert(pindexFirstMissing == pindexFirstNeverProcessed);\n         } else {\n             // If we have pruned, then we can only say that HAVE_DATA implies nTx > 0\n             if (pindex->nStatus & BLOCK_HAVE_DATA) assert(pindex->nTx > 0);\n         }\n         if (pindex->nStatus & BLOCK_HAVE_UNDO) assert(pindex->nStatus & BLOCK_HAVE_DATA);\n-        if (pindex->IsAssumedValid()) {\n-            // Assumed-valid blocks should have some nTx value.\n-            assert(pindex->nTx > 0);\n-            // Assumed-valid blocks should connect to the main chain.\n-            assert((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TREE);\n-        } else {\n-            // Otherwise there should only be an nTx value if we have\n-            // actually seen a block's transactions.\n-            assert(((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TRANSACTIONS) == (pindex->nTx > 0)); // This is pruning-independent.\n-        }\n+        // There there should only be an nTx value if we have\n+        // actually seen a block's transactions.\n+        assert(((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TRANSACTIONS) == (pindex->nTx > 0)); // This is pruning-independent.\n         // All parents having had data (at some point) is equivalent to all parents being VALID_TRANSACTIONS, which is equivalent to HaveNumChainTxs().\n-        assert((pindexFirstNeverProcessed == nullptr) == pindex->HaveNumChainTxs());\n-        assert((pindexFirstNotTransactionsValid == nullptr) == pindex->HaveNumChainTxs());\n+        // HaveNumChainTxs will also be set in the assumeutxo snapshot block from snapshot metadata.\n+        const bool snap_block = pindex == GetSnapshotBaseBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478018977",
      "id" : 1478018977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YGMeh",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4907,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1862394105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478018977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478018977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478022794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478022794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to remove this check?",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T11:14:35Z",
      "diff_hunk" : "@@ -4903,36 +4890,23 @@ void ChainstateManager::CheckBlockIndex()\n         if (!pindex->HaveNumChainTxs()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        // Unless these indexes are assumed valid and pending block download on a\n-        // background chainstate.\n-        if (!m_blockman.m_have_pruned && !pindex->IsAssumedValid()) {\n+        if (!m_blockman.m_have_pruned) {\n             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\n             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\n-            if (pindexFirstAssumeValid == nullptr) {\n-                // If we've got some assume valid blocks, then we might have\n-                // missing blocks (not HAVE_DATA) but still treat them as\n-                // having been processed (with a fake nTx value). Otherwise, we\n-                // can assert that these are the same.\n-                assert(pindexFirstMissing == pindexFirstNeverProcessed);\n-            }\n+            assert(pindexFirstMissing == pindexFirstNeverProcessed);\n         } else {\n             // If we have pruned, then we can only say that HAVE_DATA implies nTx > 0\n             if (pindex->nStatus & BLOCK_HAVE_DATA) assert(pindex->nTx > 0);\n         }\n         if (pindex->nStatus & BLOCK_HAVE_UNDO) assert(pindex->nStatus & BLOCK_HAVE_DATA);\n-        if (pindex->IsAssumedValid()) {\n-            // Assumed-valid blocks should have some nTx value.\n-            assert(pindex->nTx > 0);\n-            // Assumed-valid blocks should connect to the main chain.\n-            assert((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TREE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478022794",
      "id" : 1478022794,
      "line" : 4927,
      "node_id" : "PRRC_kwDOABII585YGNaK",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4927,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 70,
      "pull_request_review_id" : 1862459885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478022794/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T11:14:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478022794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478549351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478549351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477981888\r\n\r\n> Any reason to touch this LOC?\r\n\r\nNo, will restore. I only meant to update the comments around it.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T16:40:57Z",
      "diff_hunk" : "@@ -168,21 +169,18 @@ class CBlockIndex\n     //! (memory only) Total amount of work (expected number of hashes) in the chain up to and including this block\n     arith_uint256 nChainWork{};\n \n-    //! Number of transactions in this block.\n+    //! Number of transactions in this block. This will be nonzero if the block\n+    //! reached the VALID_TRANSACTIONS validity level, and zero otherwise.\n     //! Note: in a potential headers-first mode, this number cannot be relied upon\n     //! Note: this value is faked during UTXO snapshot load to ensure that\n     //! LoadBlockIndex() will load index entries for blocks that we lack data for.\n     //! @sa ActivateSnapshot\n     unsigned int nTx{0};\n \n     //! (memory only) Number of transactions in the chain up to and including this block.\n-    //! This value will be non-zero only if and only if transactions for this block and all its parents are available.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478549351",
      "id" : 1478549351,
      "in_reply_to_id" : 1477981888,
      "line" : 180,
      "node_id" : "PRRC_kwDOABII585YIN9n",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 180,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 67,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478549351/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478549351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478561706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478561706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998490\r\n\r\n> Any reason to change the sequence id? I think this isn't changed in `loadtxoutset` either?\r\n\r\nI'll double check and add a comment. I think this might be needed to satisfy an assert that ensures nChainTx is set if nSequenceId is set, since these are both set when a block is received and all blocks before it have also been received.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T16:43:34Z",
      "diff_hunk" : "@@ -91,13 +91,10 @@ CreateAndActivateUTXOSnapshot(\n             // these blocks instead\n             CBlockIndex *pindex = orig_tip;\n             while (pindex && pindex != chain.m_chain.Tip()) {\n-                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n-                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n-                // We have to set the ASSUMED_VALID flag, because otherwise it\n-                // would not be possible to have a block index entry without HAVE_DATA\n-                // and with nTx > 0 (since we aren't setting the pruned flag);\n-                // see CheckBlockIndex().\n-                pindex->nStatus |= BLOCK_ASSUMED_VALID;\n+                pindex->nStatus = BlockStatus::BLOCK_VALID_TREE;\n+                pindex->nTx = 0;\n+                pindex->nChainTx = 0;\n+                pindex->nSequenceId = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478561706",
      "id" : 1478561706,
      "in_reply_to_id" : 1477998490,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585YIQ-q",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 103,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 20,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478561706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478561706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478567668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478567668"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477996772\r\n\r\n> isn't this always true? Maybe you meant to type `-` instead of `<`?\r\n> \r\n> In any case, the test seems to be passing either way, so this is \"dead\" code, similar to a code comment.\r\n\r\nI think it was supposed to be i < last_assumed_valid_idx - 1, to preserve nChainTx in the snapshot block, and only set nChainTx to 0 before the snapshot block, so the test matches what happens in reality. But it does seem like this is not necessary so will simplify.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T16:47:16Z",
      "diff_hunk" : "@@ -465,6 +465,12 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+            index->nTx = 0;\n+            // Keep nChainTx for the snapshot base since it is part of the\n+            // snapshot metadata. Reset it for other blocks this is simulating\n+            // not having been downloaded yet.\n+            if (i < last_assumed_valid_idx == 1) index->nChainTx = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478567668",
      "id" : 1478567668,
      "in_reply_to_id" : 1477996772,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YISb0",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 472,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478567668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478567668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478584012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478584012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478006900\r\n\r\n> Is removing the validity check intended?\r\n\r\nIt was intended, but on second thought it is probably better to add back. The reason for removing it is that the block reaching VALID_TRANSACTIONS level is not really significant, because what is actually needed is for the block and all its ancestors back to the snapshot block or genesis block to reach VALID_TRANACTIONS level, and HaveNumChainTxs() is the direct and efficient way to check for that.\r\n\r\nBut it should still be useful to call the IsValid() function because it additionally checks for BLOCK_FAILED flags. So it would be good to add back to avoid changing behavior, and be more efficient if there are invalid blocks.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T16:59:53Z",
      "diff_hunk" : "@@ -4577,15 +4577,7 @@ bool ChainstateManager::LoadBlockIndex()\n \n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            // If we have an assumeutxo-based chainstate, then the snapshot\n-            // block will be a candidate for the tip, but it may not be\n-            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n-            // so we special-case the snapshot block as a potential candidate\n-            // here.\n-            if (pindex == GetSnapshotBaseBlock() ||\n-                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478584012",
      "id" : 1478584012,
      "in_reply_to_id" : 1478006900,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YIWbM",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4586,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478584012/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478584012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478594492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478594492"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478022794\r\n\r\n> Any reason to remove this check?\r\n\r\nNo, good catch, I'll add it back. I was thinking it wasn't really related to the other checks here, and trying to eliminate unnecessary uses of BLOCK_ASSUMED_VALID / IsAssumedValid in general. But as long as we have the assumed valid flag, might as well check this.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T17:08:36Z",
      "diff_hunk" : "@@ -4903,36 +4890,23 @@ void ChainstateManager::CheckBlockIndex()\n         if (!pindex->HaveNumChainTxs()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        // Unless these indexes are assumed valid and pending block download on a\n-        // background chainstate.\n-        if (!m_blockman.m_have_pruned && !pindex->IsAssumedValid()) {\n+        if (!m_blockman.m_have_pruned) {\n             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\n             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\n-            if (pindexFirstAssumeValid == nullptr) {\n-                // If we've got some assume valid blocks, then we might have\n-                // missing blocks (not HAVE_DATA) but still treat them as\n-                // having been processed (with a fake nTx value). Otherwise, we\n-                // can assert that these are the same.\n-                assert(pindexFirstMissing == pindexFirstNeverProcessed);\n-            }\n+            assert(pindexFirstMissing == pindexFirstNeverProcessed);\n         } else {\n             // If we have pruned, then we can only say that HAVE_DATA implies nTx > 0\n             if (pindex->nStatus & BLOCK_HAVE_DATA) assert(pindex->nTx > 0);\n         }\n         if (pindex->nStatus & BLOCK_HAVE_UNDO) assert(pindex->nStatus & BLOCK_HAVE_DATA);\n-        if (pindex->IsAssumedValid()) {\n-            // Assumed-valid blocks should have some nTx value.\n-            assert(pindex->nTx > 0);\n-            // Assumed-valid blocks should connect to the main chain.\n-            assert((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TREE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478594492",
      "id" : 1478594492,
      "in_reply_to_id" : 1478022794,
      "line" : 4927,
      "node_id" : "PRRC_kwDOABII585YIY-8",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4927,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 70,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478594492/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478594492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478604893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478604893"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478018977\r\n\r\n> Can this be further limited to only mark the snap_block if it has ASSUMED_VALID set? Otherwise, nodes which never used loadtxoutset will assume that some block is a \"snapshot block\", even though they never used that feature.\r\n\r\nI'm pretty sure I can do that, but it should not change anything. If loadtxoutset is not used, GetSnapshotBaseBlock will return null and snap_block should already be false. The only case where the suggestion would change the checks performed (when GetSnapshotBaseBlock() == pindex && !pindex->IsAssumedValid()) is the case where background chain has been downloaded and fully validated, and the snapshot block loses it's assumed_valid flag after it become validated. In that case, none of the snap_block conditions will ever be reached. Whether a snapshot block is still considered a snapshot block after the snapshot is validated is just a semantic question.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T17:17:43Z",
      "diff_hunk" : "@@ -4903,36 +4890,23 @@ void ChainstateManager::CheckBlockIndex()\n         if (!pindex->HaveNumChainTxs()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        // Unless these indexes are assumed valid and pending block download on a\n-        // background chainstate.\n-        if (!m_blockman.m_have_pruned && !pindex->IsAssumedValid()) {\n+        if (!m_blockman.m_have_pruned) {\n             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\n             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\n-            if (pindexFirstAssumeValid == nullptr) {\n-                // If we've got some assume valid blocks, then we might have\n-                // missing blocks (not HAVE_DATA) but still treat them as\n-                // having been processed (with a fake nTx value). Otherwise, we\n-                // can assert that these are the same.\n-                assert(pindexFirstMissing == pindexFirstNeverProcessed);\n-            }\n+            assert(pindexFirstMissing == pindexFirstNeverProcessed);\n         } else {\n             // If we have pruned, then we can only say that HAVE_DATA implies nTx > 0\n             if (pindex->nStatus & BLOCK_HAVE_DATA) assert(pindex->nTx > 0);\n         }\n         if (pindex->nStatus & BLOCK_HAVE_UNDO) assert(pindex->nStatus & BLOCK_HAVE_DATA);\n-        if (pindex->IsAssumedValid()) {\n-            // Assumed-valid blocks should have some nTx value.\n-            assert(pindex->nTx > 0);\n-            // Assumed-valid blocks should connect to the main chain.\n-            assert((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TREE);\n-        } else {\n-            // Otherwise there should only be an nTx value if we have\n-            // actually seen a block's transactions.\n-            assert(((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TRANSACTIONS) == (pindex->nTx > 0)); // This is pruning-independent.\n-        }\n+        // There there should only be an nTx value if we have\n+        // actually seen a block's transactions.\n+        assert(((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TRANSACTIONS) == (pindex->nTx > 0)); // This is pruning-independent.\n         // All parents having had data (at some point) is equivalent to all parents being VALID_TRANSACTIONS, which is equivalent to HaveNumChainTxs().\n-        assert((pindexFirstNeverProcessed == nullptr) == pindex->HaveNumChainTxs());\n-        assert((pindexFirstNotTransactionsValid == nullptr) == pindex->HaveNumChainTxs());\n+        // HaveNumChainTxs will also be set in the assumeutxo snapshot block from snapshot metadata.\n+        const bool snap_block = pindex == GetSnapshotBaseBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478604893",
      "id" : 1478604893,
      "in_reply_to_id" : 1478018977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YIbhd",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4907,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1863282117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478604893/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T17:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478604893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478757569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478757569"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998490\r\n\r\nAdded a comment. It is necessary to set nSequenceId to avoid an assert failure in CheckBlockIndex. I think it's also a reasonable thing to do to make the block look like it was never received.",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T19:03:01Z",
      "diff_hunk" : "@@ -91,13 +91,10 @@ CreateAndActivateUTXOSnapshot(\n             // these blocks instead\n             CBlockIndex *pindex = orig_tip;\n             while (pindex && pindex != chain.m_chain.Tip()) {\n-                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n-                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n-                // We have to set the ASSUMED_VALID flag, because otherwise it\n-                // would not be possible to have a block index entry without HAVE_DATA\n-                // and with nTx > 0 (since we aren't setting the pruned flag);\n-                // see CheckBlockIndex().\n-                pindex->nStatus |= BLOCK_ASSUMED_VALID;\n+                pindex->nStatus = BlockStatus::BLOCK_VALID_TREE;\n+                pindex->nTx = 0;\n+                pindex->nChainTx = 0;\n+                pindex->nSequenceId = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478757569",
      "id" : 1478757569,
      "in_reply_to_id" : 1477998490,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585YJAzB",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 103,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 20,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478757569/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478757569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478766159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477996772\r\n\r\nThanks, removed this",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T19:12:18Z",
      "diff_hunk" : "@@ -465,6 +465,12 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+            index->nTx = 0;\n+            // Keep nChainTx for the snapshot base since it is part of the\n+            // snapshot metadata. Reset it for other blocks this is simulating\n+            // not having been downloaded yet.\n+            if (i < last_assumed_valid_idx == 1) index->nChainTx = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478766159",
      "id" : 1478766159,
      "in_reply_to_id" : 1477996772,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YJC5P",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 472,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478766291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477998941\r\n\r\n> Same (sequence id)\r\n\r\nThanks, removed this",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T19:12:26Z",
      "diff_hunk" : "@@ -465,6 +465,12 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+            index->nTx = 0;\n+            // Keep nChainTx for the snapshot base since it is part of the\n+            // snapshot metadata. Reset it for other blocks this is simulating\n+            // not having been downloaded yet.\n+            if (i < last_assumed_valid_idx == 1) index->nChainTx = 0;\n+            index->nSequenceId = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478766291",
      "id" : 1478766291,
      "in_reply_to_id" : 1477998941,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YJC7T",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 473,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766291/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478766291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478776687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478776687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478006900\r\n\r\nThanks, reverted this",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T19:23:17Z",
      "diff_hunk" : "@@ -4577,15 +4577,7 @@ bool ChainstateManager::LoadBlockIndex()\n \n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            // If we have an assumeutxo-based chainstate, then the snapshot\n-            // block will be a candidate for the tip, but it may not be\n-            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n-            // so we special-case the snapshot block as a potential candidate\n-            // here.\n-            if (pindex == GetSnapshotBaseBlock() ||\n-                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478776687",
      "id" : 1478776687,
      "in_reply_to_id" : 1478006900,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585YJFdv",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4586,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478776687/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478776687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478943273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478943273"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1477981888\r\n\r\nThanks, restored this line",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T21:46:40Z",
      "diff_hunk" : "@@ -168,21 +169,18 @@ class CBlockIndex\n     //! (memory only) Total amount of work (expected number of hashes) in the chain up to and including this block\n     arith_uint256 nChainWork{};\n \n-    //! Number of transactions in this block.\n+    //! Number of transactions in this block. This will be nonzero if the block\n+    //! reached the VALID_TRANSACTIONS validity level, and zero otherwise.\n     //! Note: in a potential headers-first mode, this number cannot be relied upon\n     //! Note: this value is faked during UTXO snapshot load to ensure that\n     //! LoadBlockIndex() will load index entries for blocks that we lack data for.\n     //! @sa ActivateSnapshot\n     unsigned int nTx{0};\n \n     //! (memory only) Number of transactions in the chain up to and including this block.\n-    //! This value will be non-zero only if and only if transactions for this block and all its parents are available.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478943273",
      "id" : 1478943273,
      "in_reply_to_id" : 1477981888,
      "line" : 180,
      "node_id" : "PRRC_kwDOABII585YJuIp",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 180,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 67,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478943273/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478943273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478947294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478947294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478022794\r\n\r\nRestored this check",
      "commit_id" : "603a92c9881ed78e29f15c48121ce8bf35d30837",
      "created_at" : "2024-02-05T21:51:28Z",
      "diff_hunk" : "@@ -4903,36 +4890,23 @@ void ChainstateManager::CheckBlockIndex()\n         if (!pindex->HaveNumChainTxs()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        // Unless these indexes are assumed valid and pending block download on a\n-        // background chainstate.\n-        if (!m_blockman.m_have_pruned && !pindex->IsAssumedValid()) {\n+        if (!m_blockman.m_have_pruned) {\n             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\n             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\n-            if (pindexFirstAssumeValid == nullptr) {\n-                // If we've got some assume valid blocks, then we might have\n-                // missing blocks (not HAVE_DATA) but still treat them as\n-                // having been processed (with a fake nTx value). Otherwise, we\n-                // can assert that these are the same.\n-                assert(pindexFirstMissing == pindexFirstNeverProcessed);\n-            }\n+            assert(pindexFirstMissing == pindexFirstNeverProcessed);\n         } else {\n             // If we have pruned, then we can only say that HAVE_DATA implies nTx > 0\n             if (pindex->nStatus & BLOCK_HAVE_DATA) assert(pindex->nTx > 0);\n         }\n         if (pindex->nStatus & BLOCK_HAVE_UNDO) assert(pindex->nStatus & BLOCK_HAVE_DATA);\n-        if (pindex->IsAssumedValid()) {\n-            // Assumed-valid blocks should have some nTx value.\n-            assert(pindex->nTx > 0);\n-            // Assumed-valid blocks should connect to the main chain.\n-            assert((pindex->nStatus & BLOCK_VALID_MASK) >= BLOCK_VALID_TREE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29370#discussion_r1478947294",
      "id" : 1478947294,
      "in_reply_to_id" : 1478022794,
      "line" : 4927,
      "node_id" : "PRRC_kwDOABII585YJvHe",
      "original_commit_id" : "a3228f02f69e28960f7da76054965c916e781f27",
      "original_line" : 4927,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 70,
      "pull_request_review_id" : 1863598337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29370",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478947294/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-05T22:29:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1478947294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
