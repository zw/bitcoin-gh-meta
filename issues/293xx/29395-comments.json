[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29395).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2024-02-07T06:35:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1931379194",
      "id" : 1931379194,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zHoH6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931379194/reactions"
      },
      "updated_at" : "2024-02-07T06:35:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931379194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can you explain *why* this fixes the issue? What are the steps to reproduce the issue?",
      "created_at" : "2024-02-07T08:10:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1931492134",
      "id" : 1931492134,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zIDsm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931492134/reactions"
      },
      "updated_at" : "2024-02-07T08:10:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931492134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can you explain _why_ this fixes the issue? What are the steps to reproduce the issue?\r\n\r\nAFAIK, `SyncWithValidationInterfaceQueue()` is a method used to synchronize the main thread with the validation interface queue. This synchronization ensures that all pending callbacks, which might include transaction validation, block connections, and wallet notifications, are processed before the method returns.\r\n\r\nTo reproduce the issue:\r\n\r\n1. Set up a testing environment with multiple nodes.\r\n2. Create transactions that would end up in a conflicted state, likely by creating a fork in the blockchain and having transactions on both sides of the fork.\r\n3. Without proper synchronization, attempt to assert the state of transactions too quickly, before the node has had a chance to fully process the recent blockchain changes.\r\n",
      "created_at" : "2024-02-07T09:11:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1931594513",
      "id" : 1931594513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zIcsR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931594513/reactions"
      },
      "updated_at" : "2024-02-07T09:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931594513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/46436462?v=4",
         "events_url" : "https://api.github.com/users/araujo88/events{/privacy}",
         "followers_url" : "https://api.github.com/users/araujo88/followers",
         "following_url" : "https://api.github.com/users/araujo88/following{/other_user}",
         "gists_url" : "https://api.github.com/users/araujo88/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/araujo88",
         "id" : 46436462,
         "login" : "araujo88",
         "node_id" : "MDQ6VXNlcjQ2NDM2NDYy",
         "organizations_url" : "https://api.github.com/users/araujo88/orgs",
         "received_events_url" : "https://api.github.com/users/araujo88/received_events",
         "repos_url" : "https://api.github.com/users/araujo88/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/araujo88/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/araujo88/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/araujo88"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The issue is a race, so it is not deterministically reproducible. Usually, to deterministically reproduce it on all hardware, a sleep will have to be added in the right place in the source code or test code.\r\n\r\nA pull request will either have to explain where to put the sleep, or, if not possible, come up with a plausible explanation how the race could happen. Also, the pull request should explain if the bug is in the wallet code or in the test code, in which case the fix should be applied to the code where the bug is. ",
      "created_at" : "2024-02-07T09:39:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1931648941",
      "id" : 1931648941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zIp-t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931648941/reactions"
      },
      "updated_at" : "2024-02-07T09:39:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1931648941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The issue is a race, so it is not deterministically reproducible. Usually, to deterministically reproduce it on all hardware, a sleep will have to be added in the right place in the source code or test code.\r\n> \r\n> A pull request will either have to explain where to put the sleep, or, if not possible, come up with a plausible explanation how the race could happen. Also, the pull request should explain if the bug is in the wallet code or in the test code, in which case the fix should be applied to the code where the bug is.\r\n\r\nIn my understanding, this race condition arises from asynchronous block processing and transaction validation. Specifically, it occurs during the blockchain reorganization process when nodes are reconnected, and their blockchains are synchronized to establish a consensus chain. The asynchronous nature of this process introduces a timing issue where the state of transactions might not be fully updated before the test assertions are executed. This leads to a discrepancy in the expected outcome of test assertions, particularly those related to transaction confirmations and wallet conflicts post-reorg.\r\n\r\nUsing `syncwithvalidationinterfacequeue` introduces synchronization points for nodes involved in the reorg process. This method ensures that all pending operations in the validation interface queue, including transaction validation and block processing, are completed before proceeding with the test assertions. This approach aims to provide a more deterministic environment for assessing the impact of reorgs on transaction states by mitigating the race condition without introducing arbitrary delays into the test or source code.\r\n\r\nRegarding the suggestion to introduce a sleep to deterministically reproduce the race condition, I opted for a solution that aligns with best practices for testing asynchronous operations. Introducing sleep could indeed force the race condition to manifest but might not accurately reflect the underlying issue's nature or its resolution. Instead, `syncwithvalidationinterfacequeue` provides a direct way to ensure all asynchronous operations have been processed, offering a clearer and more reliable testing approach.\r\n\r\nThe motivation for use of `syncwithvalidationinterfacequeue` here is that the race condition is more related to the timing in the test environment rather than a bug in the wallet or source code itself. The need for synchronization points indicates that the test code must wait for the completion of asynchronous operations before making assertions about the state of the blockchain and transactions. This does not necessarily indicate a bug in the wallet or source code logic but rather highlights the need for careful coordination in tests involving asynchronous operations.",
      "created_at" : "2024-02-07T18:13:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1932611938",
      "id" : 1932611938,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zMVFi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932611938/reactions"
      },
      "updated_at" : "2024-02-07T18:13:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932611938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/46436462?v=4",
         "events_url" : "https://api.github.com/users/araujo88/events{/privacy}",
         "followers_url" : "https://api.github.com/users/araujo88/followers",
         "following_url" : "https://api.github.com/users/araujo88/following{/other_user}",
         "gists_url" : "https://api.github.com/users/araujo88/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/araujo88",
         "id" : 46436462,
         "login" : "araujo88",
         "node_id" : "MDQ6VXNlcjQ2NDM2NDYy",
         "organizations_url" : "https://api.github.com/users/araujo88/orgs",
         "received_events_url" : "https://api.github.com/users/araujo88/received_events",
         "repos_url" : "https://api.github.com/users/araujo88/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/araujo88/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/araujo88/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/araujo88"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In my understanding, this race condition arises from asynchronous block processing and transaction validation. Specifically, it occurs during the blockchain reorganization process when nodes are reconnected, and their blockchains are synchronized to establish a consensus chain. The asynchronous nature of this process introduces a timing issue where the state of transactions might not be fully updated before the test assertions are executed. This leads to a discrepancy in the expected outcome of test assertions, particularly those related to transaction confirmations and wallet conflicts post-reorg.\r\n> \r\n> Using `syncwithvalidationinterfacequeue` introduces synchronization points for nodes involved in the reorg process.\r\n\r\nErrr this is very verbose and vague, I don't think it answers the question at all. Can you point to which line(s) of code aren't being executed in the order this test expects them to? We can verify/reproduce the bug by adding a sleep in front of them. Otherwise this \"fix\" is just a shot in the dark.",
      "created_at" : "2024-02-07T18:38:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1932649179",
      "id" : 1932649179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zMeLb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932649179/reactions"
      },
      "updated_at" : "2024-02-07T18:38:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932649179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > In my understanding, this race condition arises from asynchronous block processing and transaction validation. Specifically, it occurs during the blockchain reorganization process when nodes are reconnected, and their blockchains are synchronized to establish a consensus chain. The asynchronous nature of this process introduces a timing issue where the state of transactions might not be fully updated before the test assertions are executed. This leads to a discrepancy in the expected outcome of test assertions, particularly those related to transaction confirmations and wallet conflicts post-reorg.\r\n> > Using `syncwithvalidationinterfacequeue` introduces synchronization points for nodes involved in the reorg process.\r\n> \r\n> Errr this is very verbose and vague, I don't think it answers the question at all. Can you point to which line(s) of code aren't being executed in the order this test expects them to? We can verify/reproduce the bug by adding a sleep in front of them. Otherwise this \"fix\" is just a shot in the dark.\r\n\r\nMy apologies if it was verbose. I understood that @maflcko wanted a detailed answer so I tried to be as thorough as possible. Anyway, here is a TL;DR:\r\n\r\n - I addressed the race condition with `syncwithvalidationinterfacequeue` to ensure all operations complete before assertions, avoiding arbitrary delays;\r\n  - This method targets timing issues in tests during blockchain reorgs, not bugs in the wallet or source code\r\n  - It aims for deterministic testing by synchronizing node operations before validation.\r\n  \r\n The race condition is specifically related to the asynchronous execution of transaction confirmations and wallet conflict detection, which are not being awaited upon before proceeding to the assertions at lines:\r\n\r\n```python\r\nassert_equal(conflicted[\"confirmations\"], -9) and\r\nassert_equal(conflicted[\"walletconflicts\"][0], conflicting[\"txid\"])\r\n```\r\n\r\nImplementing `syncwithvalidationinterfacequeue` ensures all updates are processed, directly addressing the race by ensuring a consistent state for validation. Using sleep is less precise due to variable timing.",
      "created_at" : "2024-02-07T19:04:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29395#issuecomment-1932689628",
      "id" : 1932689628,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29395",
      "node_id" : "IC_kwDOABII585zMoDc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932689628/reactions"
      },
      "updated_at" : "2024-02-07T19:04:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1932689628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/46436462?v=4",
         "events_url" : "https://api.github.com/users/araujo88/events{/privacy}",
         "followers_url" : "https://api.github.com/users/araujo88/followers",
         "following_url" : "https://api.github.com/users/araujo88/following{/other_user}",
         "gists_url" : "https://api.github.com/users/araujo88/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/araujo88",
         "id" : 46436462,
         "login" : "araujo88",
         "node_id" : "MDQ6VXNlcjQ2NDM2NDYy",
         "organizations_url" : "https://api.github.com/users/araujo88/orgs",
         "received_events_url" : "https://api.github.com/users/araujo88/received_events",
         "repos_url" : "https://api.github.com/users/araujo88/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/araujo88/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/araujo88/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/araujo88"
      }
   }
]
