[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163662410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163662410"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should say more than 50, not less than",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T20:02:55Z",
      "diff_hunk" : "@@ -59,47 +60,42 @@ def send_blocks_with_version(self, peer, numblocks, version):\n         peer.sync_with_ping()\n \n     def test_versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\n+\n+        Note that this is only called after the node is shutdown, so doesn't need\n+        a wait_until wrapper.\"\"\"\n         with open(self.alert_filename, 'r', encoding='utf8') as f:\n             alert_text = f.read()\n         assert(VB_PATTERN.match(alert_text))\n \n     def run_test(self):\n-        # Setup the p2p connection and start up the network thread.\n         self.nodes[0].add_p2p_connection(TestNode())\n-\n         network_thread_start()\n-\n-        # Test logic begins here\n         self.nodes[0].p2p.wait_for_verack()\n \n-        # 1. Have the node mine one period worth of blocks\n+        # Mine one period worth of blocks\n         self.nodes[0].generate(VB_PERIOD)\n \n-        # 2. Now build one period of blocks on the tip, with < VB_THRESHOLD\n-        # blocks signaling some unknown bit.\n-        version = VB_TOP_BITS | (1 << VB_UNKNOWN_BIT)\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, version)\n-\n-        # Fill rest of period with regular version blocks\n+        self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n         self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n-        # Check that we're not getting any versionbit-related errors in\n-        # get*info()\n+\n+        # Check that we're not getting any versionbit-related errors in get*info()\n         assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n         assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n \n-        # 3. Now build one period of blocks with >= VB_THRESHOLD blocks signaling\n-        # some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, version)\n+        # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n         self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n-        # Might not get a versionbits-related alert yet, as we should\n-        # have gotten a different alert due to more than 51/100 blocks\n-        # being of unexpected version.\n-        # Check that get*info() shows some kind of error.\n+\n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163662410",
      "id" : 163662410,
      "original_commit_id" : "f96b1eca3bf4dd0b4b06e0cd7e3b43c28c6dc5f2",
      "original_position" : 71,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : null,
      "pull_request_review_id" : 91312035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163662410",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163663927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163663927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: 60 seconds seems overkill, what about 5 or 10?",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T20:09:15Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163663927",
      "id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91313867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163663927",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163665254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163665254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Generating that block will not help to get us out of ibd any sooner. Am I mistaken?",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T20:14:35Z",
      "diff_hunk" : "@@ -35,87 +34,79 @@ def set_test_params(self):\n     def setup_network(self):\n         self.alert_filename = os.path.join(self.options.tmpdir, \"alert.txt\")\n         # Open and close to create zero-length file\n-        with open(self.alert_filename, 'w', encoding='utf8') as _:\n+        with open(self.alert_filename, 'w', encoding='utf8'):\n             pass\n         self.extra_args = [[\"-alertnotify=echo %s >> \\\"\" + self.alert_filename + \"\\\"\"]]\n         self.setup_nodes()\n \n-    # Send numblocks blocks via peer with nVersionToUse set.\n-    def send_blocks_with_version(self, peer, numblocks, nVersionToUse):\n+    def send_blocks_with_version(self, peer, numblocks, version):\n+        \"\"\"Send numblocks blocks to peer with version set\"\"\"\n         tip = self.nodes[0].getbestblockhash()\n         height = self.nodes[0].getblockcount()\n-        block_time = self.nodes[0].getblockheader(tip)[\"time\"]+1\n+        block_time = self.nodes[0].getblockheader(tip)[\"time\"] + 1\n         tip = int(tip, 16)\n \n         for _ in range(numblocks):\n-            block = create_block(tip, create_coinbase(height+1), block_time)\n-            block.nVersion = nVersionToUse\n+            block = create_block(tip, create_coinbase(height + 1), block_time)\n+            block.nVersion = version\n             block.solve()\n             peer.send_message(msg_block(block))\n             block_time += 1\n             height += 1\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        # Setup the p2p connection and start up the network thread.\n-        self.nodes[0].add_p2p_connection(TestNode())\n-\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n+        node.p2p.wait_for_verack()\n \n-        # Test logic begins here\n-        self.nodes[0].p2p.wait_for_verack()\n-\n-        # 1. Have the node mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n-\n-        # 2. Now build one period of blocks on the tip, with < VB_THRESHOLD\n-        # blocks signaling some unknown bit.\n-        nVersion = VB_TOP_BITS | (1<<VB_UNKNOWN_BIT)\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD-1, nVersion)\n-\n-        # Fill rest of period with regular version blocks\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n-        # Check that we're not getting any versionbit-related errors in\n-        # get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n-\n-        # 3. Now build one period of blocks with >= VB_THRESHOLD blocks signaling\n-        # some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, nVersion)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n-        # Might not get a versionbits-related alert yet, as we should\n-        # have gotten a different alert due to more than 51/100 blocks\n-        # being of unexpected version.\n-        # Check that get*info() shows some kind of error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n+        # Mine one period worth of blocks\n+        node.generate(VB_PERIOD)\n \n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This should move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8') as _:\n-            pass\n-        self.start_nodes()\n+        self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n+\n+        # Check that we're not getting any versionbit-related errors in get*info()\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n+        # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Check that get*info() shows the 51/100 unknown block version error.\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n+\n+        self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163665254",
      "id" : 163665254,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 163,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : null,
      "pull_request_review_id" : 91315353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163665254",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2018-01-24T20:15:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#issuecomment-360259589",
      "id" : 360259589,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12264",
      "updated_at" : "2018-01-24T20:15:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360259589",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T21:16:28Z",
      "diff_hunk" : "@@ -59,47 +60,42 @@ def send_blocks_with_version(self, peer, numblocks, version):\n         peer.sync_with_ping()\n \n     def test_versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\n+\n+        Note that this is only called after the node is shutdown, so doesn't need\n+        a wait_until wrapper.\"\"\"\n         with open(self.alert_filename, 'r', encoding='utf8') as f:\n             alert_text = f.read()\n         assert(VB_PATTERN.match(alert_text))\n \n     def run_test(self):\n-        # Setup the p2p connection and start up the network thread.\n         self.nodes[0].add_p2p_connection(TestNode())\n-\n         network_thread_start()\n-\n-        # Test logic begins here\n         self.nodes[0].p2p.wait_for_verack()\n \n-        # 1. Have the node mine one period worth of blocks\n+        # Mine one period worth of blocks\n         self.nodes[0].generate(VB_PERIOD)\n \n-        # 2. Now build one period of blocks on the tip, with < VB_THRESHOLD\n-        # blocks signaling some unknown bit.\n-        version = VB_TOP_BITS | (1 << VB_UNKNOWN_BIT)\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, version)\n-\n-        # Fill rest of period with regular version blocks\n+        self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n         self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n-        # Check that we're not getting any versionbit-related errors in\n-        # get*info()\n+\n+        # Check that we're not getting any versionbit-related errors in get*info()\n         assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n         assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n \n-        # 3. Now build one period of blocks with >= VB_THRESHOLD blocks signaling\n-        # some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, version)\n+        # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n         self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n-        # Might not get a versionbits-related alert yet, as we should\n-        # have gotten a different alert due to more than 51/100 blocks\n-        # being of unexpected version.\n-        # Check that get*info() shows some kind of error.\n+\n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680166",
      "id" : 163680166,
      "in_reply_to_id" : 163662410,
      "original_commit_id" : "f96b1eca3bf4dd0b4b06e0cd7e3b43c28c6dc5f2",
      "original_position" : 71,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : null,
      "pull_request_review_id" : 91333271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680166",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no harm in having it longer",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T21:16:45Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680243",
      "id" : 163680243,
      "in_reply_to_id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91333357,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:16:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "generating a block *guarantees* that we'll get out of IBD. I've updated the comment.",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-24T21:17:20Z",
      "diff_hunk" : "@@ -35,87 +34,79 @@ def set_test_params(self):\n     def setup_network(self):\n         self.alert_filename = os.path.join(self.options.tmpdir, \"alert.txt\")\n         # Open and close to create zero-length file\n-        with open(self.alert_filename, 'w', encoding='utf8') as _:\n+        with open(self.alert_filename, 'w', encoding='utf8'):\n             pass\n         self.extra_args = [[\"-alertnotify=echo %s >> \\\"\" + self.alert_filename + \"\\\"\"]]\n         self.setup_nodes()\n \n-    # Send numblocks blocks via peer with nVersionToUse set.\n-    def send_blocks_with_version(self, peer, numblocks, nVersionToUse):\n+    def send_blocks_with_version(self, peer, numblocks, version):\n+        \"\"\"Send numblocks blocks to peer with version set\"\"\"\n         tip = self.nodes[0].getbestblockhash()\n         height = self.nodes[0].getblockcount()\n-        block_time = self.nodes[0].getblockheader(tip)[\"time\"]+1\n+        block_time = self.nodes[0].getblockheader(tip)[\"time\"] + 1\n         tip = int(tip, 16)\n \n         for _ in range(numblocks):\n-            block = create_block(tip, create_coinbase(height+1), block_time)\n-            block.nVersion = nVersionToUse\n+            block = create_block(tip, create_coinbase(height + 1), block_time)\n+            block.nVersion = version\n             block.solve()\n             peer.send_message(msg_block(block))\n             block_time += 1\n             height += 1\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        # Setup the p2p connection and start up the network thread.\n-        self.nodes[0].add_p2p_connection(TestNode())\n-\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n+        node.p2p.wait_for_verack()\n \n-        # Test logic begins here\n-        self.nodes[0].p2p.wait_for_verack()\n-\n-        # 1. Have the node mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n-\n-        # 2. Now build one period of blocks on the tip, with < VB_THRESHOLD\n-        # blocks signaling some unknown bit.\n-        nVersion = VB_TOP_BITS | (1<<VB_UNKNOWN_BIT)\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD-1, nVersion)\n-\n-        # Fill rest of period with regular version blocks\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n-        # Check that we're not getting any versionbit-related errors in\n-        # get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n-\n-        # 3. Now build one period of blocks with >= VB_THRESHOLD blocks signaling\n-        # some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, nVersion)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n-        # Might not get a versionbits-related alert yet, as we should\n-        # have gotten a different alert due to more than 51/100 blocks\n-        # being of unexpected version.\n-        # Check that get*info() shows some kind of error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n+        # Mine one period worth of blocks\n+        node.generate(VB_PERIOD)\n \n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This should move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8') as _:\n-            pass\n-        self.start_nodes()\n+        self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n+\n+        # Check that we're not getting any versionbit-related errors in get*info()\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n+        # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Check that get*info() shows the 51/100 unknown block version error.\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n+\n+        self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163680400",
      "id" : 163680400,
      "in_reply_to_id" : 163665254,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 163,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : null,
      "pull_request_review_id" : 91333520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-24T21:17:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163680400",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163717827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163717827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I sometimes make tests fail on purpose, so having to wait a minute (or going into the test each time and having to modify it) is somewhat inconvenient.",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-25T00:10:52Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163717827",
      "id" : 163717827,
      "in_reply_to_id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91376395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-25T00:10:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163717827",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163718077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163718077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, should the test fail for some reason, the earlier you know the better. As a rule of thumb, I estimate the time it would take to fulfill the predicate, double that for travis, then double again just to be safe.",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-25T00:12:46Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163718077",
      "id" : 163718077,
      "in_reply_to_id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91376714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-25T00:12:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163718077",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163718203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163718203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can change the timeout on your failure-triggering case  \r\n\r\nIn my opinion it's better to have this too long than too short, to avoid spurious Travis failures.",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-25T00:13:33Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163718203",
      "id" : 163718203,
      "in_reply_to_id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91376856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-25T00:13:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163718203",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163805033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163805033"
         }
      },
      "author_association" : "OWNER",
      "body" : "I also prefer waiting on the long side, if it doesn't slow down the test in the passing case. Travis can be really slow when the servers are contended.",
      "commit_id" : "f36607eb8c7efc0633ebdae4212c0f0bde274504",
      "created_at" : "2018-01-25T10:37:29Z",
      "diff_hunk" : "@@ -59,61 +56,57 @@ def send_blocks_with_version(self, peer, numblocks, version):\n             tip = block.sha256\n         peer.sync_with_ping()\n \n-    def test_versionbits_in_alert_file(self):\n-        \"\"\"Test that the versionbits warning has been written to the alert file.\n-\n-        Note that this is only called after the node is shutdown, so doesn't need\n-        a wait_until wrapper.\"\"\"\n-        with open(self.alert_filename, 'r', encoding='utf8') as f:\n-            alert_text = f.read()\n-        assert(VB_PATTERN.match(alert_text))\n+    def versionbits_in_alert_file(self):\n+        \"\"\"Test that the versionbits warning has been written to the alert file.\"\"\"\n+        alert_text = open(self.alert_filename, 'r', encoding='utf8').read()\n+        return VB_PATTERN.search(alert_text) is not None\n \n     def run_test(self):\n-        self.nodes[0].add_p2p_connection(TestNode())\n+        # Handy alias\n+        node = self.nodes[0]\n+        node.add_p2p_connection(P2PInterface())\n         network_thread_start()\n-        self.nodes[0].p2p.wait_for_verack()\n+        node.p2p.wait_for_verack()\n \n         # Mine one period worth of blocks\n-        self.nodes[0].generate(VB_PERIOD)\n+        node.generate(VB_PERIOD)\n \n         self.log.info(\"Check that there is no warning if previous VB_BLOCKS have <VB_THRESHOLD blocks with unknown versionbits version.\")\n         # Build one period of blocks with < VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD + 1)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD - 1, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD + 1)\n \n         # Check that we're not getting any versionbit-related errors in get*info()\n-        assert(not VB_PATTERN.match(self.nodes[0].getmininginfo()[\"warnings\"]))\n-        assert(not VB_PATTERN.match(self.nodes[0].getnetworkinfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getmininginfo()[\"warnings\"]))\n+        assert(not VB_PATTERN.match(node.getnetworkinfo()[\"warnings\"]))\n \n+        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Build one period of blocks with VB_THRESHOLD blocks signaling some unknown bit\n-        self.send_blocks_with_version(self.nodes[0].p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n-        self.nodes[0].generate(VB_PERIOD - VB_THRESHOLD)\n+        self.send_blocks_with_version(node.p2p, VB_THRESHOLD, VB_UNKNOWN_VERSION)\n+        node.generate(VB_PERIOD - VB_THRESHOLD)\n \n-        self.log.info(\"Check that there is a warning if <50 blocks in the last 100 were an unknown version\")\n         # Check that get*info() shows the 51/100 unknown block version error.\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_MINED in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-\n-        # Mine a period worth of expected blocks so the generic block-version warning\n-        # is cleared, and restart the node. This will move the versionbit state\n-        # to ACTIVE.\n-        self.nodes[0].generate(VB_PERIOD)\n-        self.stop_nodes()\n-        # Empty out the alert file\n-        with open(self.alert_filename, 'w', encoding='utf8'):\n-            pass\n-        self.start_nodes()\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_MINED in node.getnetworkinfo()[\"warnings\"])\n \n         self.log.info(\"Check that there is a warning if previous VB_BLOCKS have >=VB_THRESHOLD blocks with unknown versionbits version.\")\n-        # Connecting one block should be enough to generate an error.\n-        self.nodes[0].generate(1)\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getmininginfo()[\"warnings\"])\n-        assert(WARN_UNKNOWN_RULES_ACTIVE in self.nodes[0].getnetworkinfo()[\"warnings\"])\n-        self.stop_nodes()\n-        self.test_versionbits_in_alert_file()\n-\n-        # Test framework expects the node to still be running...\n-        self.start_nodes()\n+        # Mine a period worth of expected blocks so the generic block-version warning\n+        # is cleared. This will move the versionbit state to ACTIVE.\n+        node.generate(VB_PERIOD)\n+\n+        # Stop-start the node. This is required because bitcoind will only warn once about unknown versions or unknown rules activating.\n+        self.restart_node(0)\n+\n+        # Generating one block will get us out of IBD\n+        node.generate(1)\n+        wait_until(lambda: not node.getblockchaininfo()['initialblockdownload'], timeout=10, lock=mininode_lock)\n+        # Generating one more block will be enough to generate an error.\n+        node.generate(1)\n+        # Check that get*info() shows the versionbits unknown rules warning\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getmininginfo()[\"warnings\"])\n+        assert(WARN_UNKNOWN_RULES_ACTIVE in node.getnetworkinfo()[\"warnings\"])\n+        # Check that the alert file shows the versionbits unknown rules warning\n+        wait_until(lambda: self.versionbits_in_alert_file(), timeout=60)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#discussion_r163805033",
      "id" : 163805033,
      "in_reply_to_id" : 163663927,
      "original_commit_id" : "9100159ddd3bb01b5703e1ef43fa2563e656f38b",
      "original_position" : 117,
      "path" : "test/functional/p2p-versionbits-warning.py",
      "position" : 171,
      "pull_request_review_id" : 91476017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12264",
      "updated_at" : "2018-01-25T10:37:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/163805033",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Seems to need rebase (already?).",
      "created_at" : "2018-01-25T10:37:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#issuecomment-360427994",
      "id" : 360427994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12264",
      "updated_at" : "2018-01-25T10:37:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360427994",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK f36607eb8c Needs rebase",
      "created_at" : "2018-01-25T11:53:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#issuecomment-360445267",
      "id" : 360445267,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12264",
      "updated_at" : "2018-01-25T11:53:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360445267",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased (test file name change)",
      "created_at" : "2018-01-25T13:01:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12264#issuecomment-360460221",
      "id" : 360460221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12264",
      "updated_at" : "2018-01-25T13:01:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360460221",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
