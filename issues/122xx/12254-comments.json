[
   {
      "author_association" : "MEMBER",
      "body" : "Big Concept ACK, excited about this",
      "created_at" : "2018-01-24T01:57:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-359994997",
      "id" : 359994997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-24T01:57:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/359994997",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Should this be labeled consensus? This is a P2P change, right?\r\n",
      "created_at" : "2018-01-24T14:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-360154896",
      "id" : 360154896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-24T14:36:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360154896",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@laanwj This is a data structure to be used in a P2P change. I first thought that it shouldn't be tagged \"Consensus\", but there's an argument to be made for it. It doesn't affect blockchain consensus, but it is kind of a softer P2P consensus change, where network clients (though not other full nodes) may disconnect/ban you if you serve incorrectly computed block filters. I'll let you make the call on the tag.",
      "created_at" : "2018-01-24T17:09:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-360204783",
      "id" : 360204783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-24T17:09:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360204783",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Any fork that can be resolved by a P2P adaptor that speaks both protocols is not a consensus change.",
      "created_at" : "2018-01-24T17:12:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-360205706",
      "id" : 360205706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-24T17:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360205706",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> This is a data structure to be used in a P2P change.\r\n\r\nThanks for the explanation. With \"consensus\" we mean the blockchain consensus rules code. Banning\\disconnecting is a P2P level issue. So changing the label to P2P.",
      "created_at" : "2018-01-24T17:19:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-360207830",
      "id" : 360207830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-24T17:19:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360207830",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Great work @jimpo!\r\nBig Concept ACK,... will help to get this done.",
      "created_at" : "2018-01-25T22:33:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-360623262",
      "id" : 360623262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-01-25T22:33:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/360623262",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r167173632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167173632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure, but I guess that comments belongs to L113?",
      "commit_id" : "68777c59c91fdcdc2967a39b70d41f215c6846ca",
      "created_at" : "2018-02-09T09:13:33Z",
      "diff_hunk" : "@@ -0,0 +1,319 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <blockfilter.h>\n+#include <hash.h>\n+#include <primitives/transaction.h>\n+#include <script/script.h>\n+#include <streams.h>\n+\n+/// SerType used to serialize parameters in GCS filter encoding.\n+static constexpr int GCS_SER_TYPE = SER_NETWORK;\n+\n+/// Protocol version used to serialize parameters in GCS filter encoding.\n+static constexpr int GCS_SER_VERSION = 0;\n+\n+template <typename OStream>\n+static void GolombRiceEncode(BitStreamWriter<OStream>& bitwriter, uint8_t k, uint64_t n)\n+{\n+    // Write quotient as unary-encoded: q 1's followed by one 0.\n+    uint64_t q = n >> k;\n+    while (q > 0) {\n+        int nbits = q <= 64 ? static_cast<int>(q) : 64;\n+        bitwriter.Write(~0ULL, nbits);\n+        q -= nbits;\n+    }\n+    bitwriter.Write(0, 1);\n+\n+    // Write the remainder in k bits. Since the remainder is just the bottom\n+    // k bits of n, there is no need to mask first.\n+    bitwriter.Write(n, k);\n+}\n+\n+template <typename IStream>\n+static uint64_t GolombRiceDecode(BitStreamReader<IStream>& bitreader, uint8_t k)\n+{\n+    // Read unary-encoded quotient: q 1's followed by one 0.\n+    uint64_t q = 0;\n+    while (bitreader.Read(1) == 1) {\n+        q++;\n+    }\n+\n+    uint64_t r = bitreader.Read(k);\n+\n+    return (q << k) + r;\n+}\n+\n+// Map a value x that is uniformly distributed in the range [0, 2^64) to a\n+// value uniformly distributed in [0, n) by returning the upper 64 bits of\n+// x * n.\n+//\n+// See: https://lemire.me/blog/2016/06/27/a-fast-alternative-to-the-modulo-reduction/\n+static uint64_t MapIntoRange(uint64_t x, uint64_t n)\n+{\n+    // To perform the calculation on 64-bit numbers without losing the\n+    // result to overflow, split the numbers into the most significant and\n+    // least significant 32 bits and perform multiplication piece-wise.\n+    //\n+    // See: https://stackoverflow.com/a/26855440\n+    uint64_t x_hi = x >> 32;\n+    uint64_t x_lo = x & 0xFFFFFFFF;\n+    uint64_t n_hi = n >> 32;\n+    uint64_t n_lo = n & 0xFFFFFFFF;\n+\n+    uint64_t ac = x_hi * n_hi;\n+    uint64_t ad = x_hi * n_lo;\n+    uint64_t bc = x_lo * n_hi;\n+    uint64_t bd = x_lo * n_lo;\n+\n+    uint64_t mid34 = (bd >> 32) + (bc & 0xFFFFFFFF) + (ad & 0xFFFFFFFF);\n+    uint64_t upper64 = ac + (bc >> 32) + (ad >> 32) + (mid34 >> 32);\n+    return upper64;\n+}\n+\n+uint64_t GCSFilter::HashToRange(const Element& element) const\n+{\n+    uint64_t hash = CSipHasher(m_siphash_k0, m_siphash_k1)\n+        .Write(element.data(), element.size())\n+        .Finalize();\n+    return MapIntoRange(hash, m_F);\n+}\n+\n+std::vector<uint64_t> GCSFilter::BuildHashedSet(const std::set<Element>& elements) const\n+{\n+    std::vector<uint64_t> hashed_elements;\n+    hashed_elements.reserve(elements.size());\n+    for (const Element& element : elements) {\n+        hashed_elements.push_back(HashToRange(element));\n+    }\n+    std::sort(hashed_elements.begin(), hashed_elements.end());\n+    return hashed_elements;\n+}\n+\n+GCSFilter::GCSFilter(uint64_t siphash_k0, uint64_t siphash_k1, uint8_t P)\n+    : m_siphash_k0(siphash_k0), m_siphash_k1(siphash_k1), m_P(P), m_N(0), m_F(0)\n+{\n+    if (m_P > 32) {\n+        throw std::invalid_argument(\"P must be <=32\");\n+    }\n+}\n+\n+GCSFilter::GCSFilter(uint64_t siphash_k0, uint64_t siphash_k1, uint8_t P,\n+                     std::vector<unsigned char> encoded_filter)\n+    : GCSFilter(siphash_k0, siphash_k1, P)\n+{\n+    m_encoded = std::move(encoded_filter);\n+\n+    CVectorReader stream(GCS_SER_TYPE, GCS_SER_VERSION, m_encoded, 0);\n+\n+    m_N = ReadCompactSize(stream);\n+    m_F = m_N << m_P;\n+\n+    if (m_N >= (1ULL << 32)) {\n+        throw std::invalid_argument(\"N must be <2^32\");\n+    }\n+\n+    // Surface any errors decoding the filter on construction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r167173632",
      "id" : 167173632,
      "original_commit_id" : "884ebec137484daac81c208b805815ff9ee3b35c",
      "original_position" : 117,
      "path" : "src/blockfilter.cpp",
      "position" : null,
      "pull_request_review_id" : 95354532,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254",
      "updated_at" : "2018-03-12T16:01:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167173632",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reviewed and tested a bit... nice, clean PR!\r\nI would wish we had more test vectors... ",
      "created_at" : "2018-02-09T09:46:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-364385727",
      "id" : 364385727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-02-09T09:46:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364385727",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Would it useful to add some (hidden) RPC commands so other developers can test it?",
      "created_at" : "2018-02-09T15:14:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-364461376",
      "id" : 364461376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-02-09T15:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364461376",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonasschnelli Thanks for reviewing. The test vectors were generated from a Go program I have that cross-validates against the [btcsuite implementation](https://github.com/Roasbeef/btcutil/pull/6). I can easily add any specific testnet blocks to the list of cases. The blocks were chosen to exercise certain edge cases (eg. empty filters, duplicate pushdatas, invalid output scripts), but the vectors aren't commented with which edges cases they exercise. I'll add the comments, because it seems worthwhile.\r\n\r\n@Sjors I'd definitely like to see RPC commands to fetch specific filters and filter headers, but I think it makes more sense to do that after adding the filter index, so that the RPC handlers just have to look up a precomputed filter/header. (So basically, in a subsequent PR).",
      "created_at" : "2018-02-09T18:15:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-364513902",
      "id" : 364513902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-02-09T18:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364513902",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r167313633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167313633"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, the idea is that the below lines fully decode the filter in the constructor so that any errors decoding get raised during construction rather than when it is first matched against. I'll elaborate on the comment.",
      "commit_id" : "68777c59c91fdcdc2967a39b70d41f215c6846ca",
      "created_at" : "2018-02-09T18:49:12Z",
      "diff_hunk" : "@@ -0,0 +1,319 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <blockfilter.h>\n+#include <hash.h>\n+#include <primitives/transaction.h>\n+#include <script/script.h>\n+#include <streams.h>\n+\n+/// SerType used to serialize parameters in GCS filter encoding.\n+static constexpr int GCS_SER_TYPE = SER_NETWORK;\n+\n+/// Protocol version used to serialize parameters in GCS filter encoding.\n+static constexpr int GCS_SER_VERSION = 0;\n+\n+template <typename OStream>\n+static void GolombRiceEncode(BitStreamWriter<OStream>& bitwriter, uint8_t k, uint64_t n)\n+{\n+    // Write quotient as unary-encoded: q 1's followed by one 0.\n+    uint64_t q = n >> k;\n+    while (q > 0) {\n+        int nbits = q <= 64 ? static_cast<int>(q) : 64;\n+        bitwriter.Write(~0ULL, nbits);\n+        q -= nbits;\n+    }\n+    bitwriter.Write(0, 1);\n+\n+    // Write the remainder in k bits. Since the remainder is just the bottom\n+    // k bits of n, there is no need to mask first.\n+    bitwriter.Write(n, k);\n+}\n+\n+template <typename IStream>\n+static uint64_t GolombRiceDecode(BitStreamReader<IStream>& bitreader, uint8_t k)\n+{\n+    // Read unary-encoded quotient: q 1's followed by one 0.\n+    uint64_t q = 0;\n+    while (bitreader.Read(1) == 1) {\n+        q++;\n+    }\n+\n+    uint64_t r = bitreader.Read(k);\n+\n+    return (q << k) + r;\n+}\n+\n+// Map a value x that is uniformly distributed in the range [0, 2^64) to a\n+// value uniformly distributed in [0, n) by returning the upper 64 bits of\n+// x * n.\n+//\n+// See: https://lemire.me/blog/2016/06/27/a-fast-alternative-to-the-modulo-reduction/\n+static uint64_t MapIntoRange(uint64_t x, uint64_t n)\n+{\n+    // To perform the calculation on 64-bit numbers without losing the\n+    // result to overflow, split the numbers into the most significant and\n+    // least significant 32 bits and perform multiplication piece-wise.\n+    //\n+    // See: https://stackoverflow.com/a/26855440\n+    uint64_t x_hi = x >> 32;\n+    uint64_t x_lo = x & 0xFFFFFFFF;\n+    uint64_t n_hi = n >> 32;\n+    uint64_t n_lo = n & 0xFFFFFFFF;\n+\n+    uint64_t ac = x_hi * n_hi;\n+    uint64_t ad = x_hi * n_lo;\n+    uint64_t bc = x_lo * n_hi;\n+    uint64_t bd = x_lo * n_lo;\n+\n+    uint64_t mid34 = (bd >> 32) + (bc & 0xFFFFFFFF) + (ad & 0xFFFFFFFF);\n+    uint64_t upper64 = ac + (bc >> 32) + (ad >> 32) + (mid34 >> 32);\n+    return upper64;\n+}\n+\n+uint64_t GCSFilter::HashToRange(const Element& element) const\n+{\n+    uint64_t hash = CSipHasher(m_siphash_k0, m_siphash_k1)\n+        .Write(element.data(), element.size())\n+        .Finalize();\n+    return MapIntoRange(hash, m_F);\n+}\n+\n+std::vector<uint64_t> GCSFilter::BuildHashedSet(const std::set<Element>& elements) const\n+{\n+    std::vector<uint64_t> hashed_elements;\n+    hashed_elements.reserve(elements.size());\n+    for (const Element& element : elements) {\n+        hashed_elements.push_back(HashToRange(element));\n+    }\n+    std::sort(hashed_elements.begin(), hashed_elements.end());\n+    return hashed_elements;\n+}\n+\n+GCSFilter::GCSFilter(uint64_t siphash_k0, uint64_t siphash_k1, uint8_t P)\n+    : m_siphash_k0(siphash_k0), m_siphash_k1(siphash_k1), m_P(P), m_N(0), m_F(0)\n+{\n+    if (m_P > 32) {\n+        throw std::invalid_argument(\"P must be <=32\");\n+    }\n+}\n+\n+GCSFilter::GCSFilter(uint64_t siphash_k0, uint64_t siphash_k1, uint8_t P,\n+                     std::vector<unsigned char> encoded_filter)\n+    : GCSFilter(siphash_k0, siphash_k1, P)\n+{\n+    m_encoded = std::move(encoded_filter);\n+\n+    CVectorReader stream(GCS_SER_TYPE, GCS_SER_VERSION, m_encoded, 0);\n+\n+    m_N = ReadCompactSize(stream);\n+    m_F = m_N << m_P;\n+\n+    if (m_N >= (1ULL << 32)) {\n+        throw std::invalid_argument(\"N must be <2^32\");\n+    }\n+\n+    // Surface any errors decoding the filter on construction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r167313633",
      "id" : 167313633,
      "in_reply_to_id" : 167173632,
      "original_commit_id" : "884ebec137484daac81c208b805815ff9ee3b35c",
      "original_position" : 117,
      "path" : "src/blockfilter.cpp",
      "position" : null,
      "pull_request_review_id" : 95523188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254",
      "updated_at" : "2018-03-12T16:01:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167313633",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r174886724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174886724"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"streams: Create CVectorReader stream interface for vectors.\" (93f702b08e413c5c025b155bfb62b721d27939f5)\r\n\r\nThis is pretty similar to the VectorReader class @TheBlueMatt is adding here: https://github.com/TheBlueMatt/bitcoin/commit/bb608a995e8fd16d156145bf41023e7a77d44971 for https://github.com/bitcoin/bitcoin/compare/master...TheBlueMatt:2018-02-miningserver\r\n\r\nYour implementation is more general with support for deserialization in the constructor and more complete comments. But his has a `pos()` method and uses non-hungarian names which are recommended by the contrib guide. Anyway you may want to incorporate some of his changes.\r\n\r\n",
      "commit_id" : "68777c59c91fdcdc2967a39b70d41f215c6846ca",
      "created_at" : "2018-03-15T18:29:54Z",
      "diff_hunk" : "@@ -138,6 +138,80 @@ class CVectorWriter\n     size_t nPos;\n };\n \n+/* Minimal stream for reading from an existing vector by reference\n+ */\n+class CVectorReader",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r174886724",
      "id" : 174886724,
      "original_commit_id" : "93f702b08e413c5c025b155bfb62b721d27939f5",
      "original_position" : 6,
      "path" : "src/streams.h",
      "position" : 6,
      "pull_request_review_id" : 104327123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254",
      "updated_at" : "2018-03-15T18:40:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174886724",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r174888569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174888569"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"streams: Create CVectorReader stream interface for vectors.\" (93f702b08e413c5c025b155bfb62b721d27939f5)\r\n\r\nIt would be nice if this just had `const unsigned char*` and `size_t` members instead of a requiring a reference to an actual vector. That way the class could be used to efficiently deserialize from any memory location, and be compatible with other containers like `std::string`.",
      "commit_id" : "68777c59c91fdcdc2967a39b70d41f215c6846ca",
      "created_at" : "2018-03-15T18:34:53Z",
      "diff_hunk" : "@@ -138,6 +138,80 @@ class CVectorWriter\n     size_t nPos;\n };\n \n+/* Minimal stream for reading from an existing vector by reference\n+ */\n+class CVectorReader\n+{\n+private:\n+    const int nType;\n+    const int nVersion;\n+    const std::vector<unsigned char>& vchData;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#discussion_r174888569",
      "id" : 174888569,
      "original_commit_id" : "93f702b08e413c5c025b155bfb62b721d27939f5",
      "original_position" : 11,
      "path" : "src/streams.h",
      "position" : 11,
      "pull_request_review_id" : 104327123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12254",
      "updated_at" : "2018-03-15T18:39:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174888569",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @Sjors I'd definitely like to see RPC commands to fetch specific filters and filter headers, but I think it makes more sense to do that after adding the filter index, so that the RPC handlers just have to look up a precomputed filter/header. (So basically, in a subsequent PR).\r\n\r\nEven a proof-of-concept PR for that would be useful for review.",
      "created_at" : "2018-03-15T19:07:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12254#issuecomment-373489502",
      "id" : 373489502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12254",
      "updated_at" : "2018-03-15T19:07:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/373489502",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
