[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r579181272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579181272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's currently impossible for `vAddrToSend` to grow larger than `MAX_ADDR_TO_SEND` (observe that the only place where elements are added to `vAddrToSend` check the size first). However, it might be safer to do something like:\r\n\r\n```suggestion\r\n    if(pto.vAddrToSend.size() > MAX_ADDR_TO_SEND) vAddrToSend.resize(MAX_ADDR_TO_SEND);\r\n```\r\n\r\nI'm happy to go with whatever reviewers prefer.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-19T13:23:26Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r579181272",
      "id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTE4MTI3Mg==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 594182306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579181272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21528 ([p2p] Reduce addr blackholes by amitiuttarwar)\n* #21515 (Erlay: bandwidth-efficient transaction relay protocol by naumenkogs)\n* #21198 (net: Address outstanding review comments from PR20721 by jnewbery)\n* #21160 (net/net processing: Move tx inventory into net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-19T14:17:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-782102826",
      "id" : 782102826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MjEwMjgyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T14:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782102826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master to pick up fix for interface_zmq.py in #21008.",
      "created_at" : "2021-02-22T08:46:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-783203779",
      "id" : 783203779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzIwMzc3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T08:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783203779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583805388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583805388"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Err, nack. Please add `EXCLUSIVE_LOCKS_REQUIRED(pto->cs_sendProcessing)` to `MaybeSendAddr` instead. I could see an argument for having a single mutex representing \"this is the message handler thread\" (rather than one per-peer), but removing guards entirely is wrong...",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-26T17:37:25Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583805388",
      "id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzgwNTM4OA==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 599796777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583805388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583839782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583839782"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe change this to `node` or `node_to` as per `MaybeSendPing`. It's no longer a `p` either way.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-26T18:36:31Z",
      "diff_hunk" : "@@ -337,7 +337,7 @@ class PeerManagerImpl final : public PeerManager\n     void MaybeSendPing(CNode& node_to, Peer& peer);\n \n     /** Send `addr` messages on a regular schedule*/\n-    void MaybeSendAddr(CNode* pto);\n+    void MaybeSendAddr(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583839782",
      "id" : 583839782,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzgzOTc4Mg==",
      "original_commit_id" : "cb68827f7d25d2c2eafa8f64a9f0a7c4cacee84b",
      "original_line" : 340,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 599796777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583839782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583849836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583849836"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could have an Assume instead of an assert, but better to error out than silently cover it up if mistakes are introduced elsewhere I think.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-26T18:54:25Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583849836",
      "id" : 583849836,
      "in_reply_to_id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mzg0OTgzNg==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 599796777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583849836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583851018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583851018"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should move this to directly after the `RelayAddrsWithConn` check -- that's what makes it true, and you rely on `m_addr_known` being not null in the `!IBD` branch above as well.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-26T18:56:23Z",
      "diff_hunk" : "@@ -4395,45 +4395,39 @@ void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n         pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n     }\n \n-    //\n-    // Message: addr\n-    //\n-    if (pto.RelayAddrsWithConn() && pto.m_next_addr_send < current_time) {\n-        pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n-        std::vector<CAddress> vAddr;\n-        vAddr.reserve(pto.vAddrToSend.size());\n-        assert(pto.m_addr_known);\n-\n-        const char* msg_type;\n-        int make_flags;\n-        if (pto.m_wants_addrv2) {\n-            msg_type = NetMsgType::ADDRV2;\n-            make_flags = ADDRV2_FORMAT;\n-        } else {\n-            msg_type = NetMsgType::ADDR;\n-            make_flags = 0;\n-        }\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n \n-        for (const CAddress& addr : pto.vAddrToSend)\n-        {\n-            if (!pto.m_addr_known->contains(addr.GetKey()))\n-            {\n-                pto.m_addr_known->insert(addr.GetKey());\n-                vAddr.push_back(addr);\n-                // receiver rejects addr messages larger than MAX_ADDR_TO_SEND\n-                if (vAddr.size() >= MAX_ADDR_TO_SEND)\n-                {\n-                    m_connman.PushMessage(&pto, msgMaker.Make(make_flags, msg_type, vAddr));\n-                    vAddr.clear();\n-                }\n-            }\n-        }\n-        pto.vAddrToSend.clear();\n-        if (!vAddr.empty())\n-            m_connman.PushMessage(&pto, msgMaker.Make(make_flags, msg_type, vAddr));\n-        // we only send the big addr message once\n-        if (pto.vAddrToSend.capacity() > 40)\n-            pto.vAddrToSend.shrink_to_fit();\n+    assert(pto.m_addr_known);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583851018",
      "id" : 583851018,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mzg1MTAxOA==",
      "original_commit_id" : "53353c75369bb87a9947c49a4a9f0c0ef053f248",
      "original_line" : 4402,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 599796777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583851018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584276609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584276609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These members should never have been guarded by `cs_sendProcessing`, which really only exists at this point to make sure that multiple threads don't enter `SendMessages()` concurrently.\r\n\r\nThe annotation was over-zealously added in #13123. The author of that PR agrees that these annotations are unnecessary: https://github.com/bitcoin/bitcoin/pull/13123#issuecomment-647505130.\r\n\r\nThese variables are only ever read/written by the message handler thread inside `SendMessages()`, so it's safe for them to be unguarded. I can make them atomic if you think that would make this more obviously safe.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T10:53:53Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584276609",
      "id" : 584276609,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDI3NjYwOQ==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 600245301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584276609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584277318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584277318"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you think it'd be useful to add a new macro `AssertAndRecover()`:\r\n\r\n- in debug builds, this asserts (terminates) if the condition fails\r\n- in release builds, this executes some recovery code and continues.\r\n\r\neg here the recovery code would be to clear the `vAddrToSend` vector and return from `MaybeSendAddr()`. Better to not relay addr records to a peer and continue operation than crash the node.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T10:59:14Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584277318",
      "id" : 584277318,
      "in_reply_to_id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDI3NzMxOA==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600245745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584277318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584282539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584282539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T11:40:47Z",
      "diff_hunk" : "@@ -337,7 +337,7 @@ class PeerManagerImpl final : public PeerManager\n     void MaybeSendPing(CNode& node_to, Peer& peer);\n \n     /** Send `addr` messages on a regular schedule*/\n-    void MaybeSendAddr(CNode* pto);\n+    void MaybeSendAddr(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584282539",
      "id" : 584282539,
      "in_reply_to_id" : 583839782,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDI4MjUzOQ==",
      "original_commit_id" : "cb68827f7d25d2c2eafa8f64a9f0a7c4cacee84b",
      "original_line" : 340,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600249140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584282539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584282888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584282888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T11:44:01Z",
      "diff_hunk" : "@@ -4395,45 +4395,39 @@ void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n         pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n     }\n \n-    //\n-    // Message: addr\n-    //\n-    if (pto.RelayAddrsWithConn() && pto.m_next_addr_send < current_time) {\n-        pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n-        std::vector<CAddress> vAddr;\n-        vAddr.reserve(pto.vAddrToSend.size());\n-        assert(pto.m_addr_known);\n-\n-        const char* msg_type;\n-        int make_flags;\n-        if (pto.m_wants_addrv2) {\n-            msg_type = NetMsgType::ADDRV2;\n-            make_flags = ADDRV2_FORMAT;\n-        } else {\n-            msg_type = NetMsgType::ADDR;\n-            make_flags = 0;\n-        }\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n \n-        for (const CAddress& addr : pto.vAddrToSend)\n-        {\n-            if (!pto.m_addr_known->contains(addr.GetKey()))\n-            {\n-                pto.m_addr_known->insert(addr.GetKey());\n-                vAddr.push_back(addr);\n-                // receiver rejects addr messages larger than MAX_ADDR_TO_SEND\n-                if (vAddr.size() >= MAX_ADDR_TO_SEND)\n-                {\n-                    m_connman.PushMessage(&pto, msgMaker.Make(make_flags, msg_type, vAddr));\n-                    vAddr.clear();\n-                }\n-            }\n-        }\n-        pto.vAddrToSend.clear();\n-        if (!vAddr.empty())\n-            m_connman.PushMessage(&pto, msgMaker.Make(make_flags, msg_type, vAddr));\n-        // we only send the big addr message once\n-        if (pto.vAddrToSend.capacity() > 40)\n-            pto.vAddrToSend.shrink_to_fit();\n+    assert(pto.m_addr_known);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584282888",
      "id" : 584282888,
      "in_reply_to_id" : 583851018,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDI4Mjg4OA==",
      "original_commit_id" : "53353c75369bb87a9947c49a4a9f0c0ef053f248",
      "original_line" : 4402,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600249395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584282888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ajtowns. I've addressed your comments.",
      "created_at" : "2021-02-28T11:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-787440104",
      "id" : 787440104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzQ0MDEwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T11:52:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787440104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584304375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584304375"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't `AssertAndRecover(condition, recovery)` the same as `if (!Assume(condition)) { recovery; }` ? (Err, at least if `Assume` was the identity function its comments claim it to be, rather than being cast to `(void)` in release builds)\r\n\r\nNot sure the recovery code is needed here -- more than MAX_ADDR_TO_SEND would be a protocol violation, but shouldn't cause a crash or anything, I think?",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T14:17:24Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584304375",
      "id" : 584304375,
      "in_reply_to_id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwNDM3NQ==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600264565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584304375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584308103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584308103"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"These variables are only ever read/written ... inside SendMessages\" -- is **exactly** what GUARDED_BY(cs_sendProcessing) documents. The point of having the guard is to catch errors when we change the code in future and violate the assumptions we were relying on -- if the code compiles with the GUARDED_BY statements, it will always also compile correctly without them -- the trouble comes when people make changes later.\r\n\r\nI don't know what @practicalswift thinks the annotation was a mistake; it's not. (It's a mistake the other addr-related member variables aren't guarded though)\r\n\r\nHaving things be atomic instead of guarded is only a good idea if they're actually accessed by multiple threads, and either they don't need to be synchronized with any other data, or the timing is too important for proper locks.\r\n\r\nEDIT: There's a commit on https://github.com/ajtowns/bitcoin/commits/202103-cs_sendProcessing which turns the mutex into a single global, which can then be used to also guard things in `struct Peer` that aren't accessed outside of ProcessMesasges/SendMessages. Not needed for this PR, but might be useful for the followup.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T14:41:40Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584308103",
      "id" : 584308103,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwODEwMw==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 600267153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584308103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584353143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584353143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Isn't AssertAndRecover(condition, recovery) the same as if (!Assume(condition)) { recovery; }\r\n\r\nAh interesting. I didn't realise that.\r\n\r\n> Not sure the recovery code is needed here -- more than MAX_ADDR_TO_SEND would be a protocol violation, but shouldn't cause a crash or anything, I think?\r\n\r\nI think it's probably better to skip sending the `addr` message than violate the p2p protocol.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T20:08:02Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584353143",
      "id" : 584353143,
      "in_reply_to_id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDM1MzE0Mw==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600300442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584353143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584353407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584353407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It's a mistake the other addr-related member variables aren't guarded though\r\n\r\nOk. I've moved all of the addr fields to be guarded by their own `m_addr_mutex` mutex. This seems much better than having data/logic that should be in net_processing being locked by a mutex in net.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-02-28T20:10:00Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584353407",
      "id" : 584353407,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDM1MzQwNw==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 600300603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584353407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oops. I missed taking the new lock in one of the call sites. Will fix up tomorrow.",
      "created_at" : "2021-02-28T22:05:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-787531613",
      "id" : 787531613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzUzMTYxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T22:05:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787531613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Once all of the addr data has been moved into net_processing, I intend to guard it with a single lock (see the `m_addr_relay` struct in https://github.com/jnewbery/bitcoin/tree/2021-02-lazy-init-peer). However, it's proving difficult to get lock orders right while the data is still in net. I've decided to punt on doing that until after this PR.\r\n\r\nTo avoid simply removing the guard from `m_next_addr_send` and `m_next_local_addr_send`, I've introduced the new `m_addr_mutex` lock in this PR. Once the data is moved into `Peer`, I'll extend that mutex to guard the remaining addr data.",
      "created_at" : "2021-03-01T18:00:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-788149974",
      "id" : 788149974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODE0OTk3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-01T18:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788149974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584933092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584933092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That proved more difficult than expected. I've reverted that change and have moved just  `m_next_addr_send` and `m_next_local_addr_send` to be guarded by the new `m_addr_mutex`. I'll move the rest of the addr fields under that mutex when they move into the `Peer` struct.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-01T18:01:45Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r584933092",
      "id" : 584933092,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDkzMzA5Mg==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 601017423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584933092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r585462620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585462620"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't follow why you're changing those guards at all in this PR; you don't need to. See https://github.com/ajtowns/bitcoin/tree/202003-pr21236\r\n\r\nI don't think it will make sense to lock `m_addr_known` and `vAddrToSend` with per-peer locks: when receiving an addr message we'll obtain the lock for the peer that sends the message, then attempt to obtain the lock for a peer we want to forward the address on to -- but there's no particular reason to expect those peers to always be in a particular order, so holding the sending peer's lock would create ordering violations, and releasing and reacquiring would be a bit ridiculous given that this is always happening in a single thread.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-02T10:52:41Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r585462620",
      "id" : 585462620,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQ2MjYyMA==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 601683530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585462620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r585490441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585490441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! Totally agree that taking and releasing multiple locks would be ridiculous. I've taken your branch.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-02T11:36:12Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r585490441",
      "id" : 585490441,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQ5MDQ0MQ==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 601719232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585490441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586153384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586153384"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    if (node.vAddrToSend.capacity() > 40) {\r\n        node.vAddrToSend.shrink_to_fit();\r\n    }\r\n```",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T06:36:58Z",
      "diff_hunk" : "@@ -4366,6 +4369,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        node.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (node.m_next_local_addr_send != 0us) {\n+            node.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&node)) {\n+            FastRandomContext insecure_rand;\n+            node.PushAddress(*local_addr, insecure_rand);\n+        }\n+        node.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= node.m_next_addr_send) return;\n+\n+    node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about\n+    auto addr_already_known = [&node](const CAddress& addr) EXCLUSIVE_LOCKS_REQUIRED(node.m_addr_mutex)\n+                              {return node.m_addr_known->contains(addr.GetKey());};\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),\n+                           node.vAddrToSend.end());\n+\n+    // No addr messages to send\n+    if (node.vAddrToSend.empty()) return;\n+\n+    for (const CAddress& addr : node.vAddrToSend) {\n+        node.m_addr_known->insert(addr.GetKey());\n+    }\n+\n+    const char* msg_type;\n+    int make_flags;\n+    if (node.m_wants_addrv2) {\n+        msg_type = NetMsgType::ADDRV2;\n+        make_flags = ADDRV2_FORMAT;\n+    } else {\n+        msg_type = NetMsgType::ADDR;\n+        make_flags = 0;\n+    }\n+    m_connman.PushMessage(&node, CNetMsgMaker(node.GetCommonVersion()).Make(make_flags, msg_type, node.vAddrToSend));\n+    node.vAddrToSend.clear();\n+\n+    // we only send the big addr message once\n+    if (node.vAddrToSend.capacity() > 40)\n+        node.vAddrToSend.shrink_to_fit();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586153384",
      "id" : 586153384,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjE1MzM4NA==",
      "original_commit_id" : "d587fae7542ebfa7e6292333f0976dd32d643e20",
      "original_line" : 4210,
      "original_position" : 76,
      "original_start_line" : 4433,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 602558406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586153384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586155459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586155459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const auto current_time = GetTime<std::chrono::microseconds>();\r\n```",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T06:42:20Z",
      "diff_hunk" : "@@ -4366,6 +4369,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586155459",
      "id" : 586155459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjE1NTQ1OQ==",
      "original_commit_id" : "d587fae7542ebfa7e6292333f0976dd32d643e20",
      "original_line" : 4379,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 602558406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586155459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586234407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586234407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T09:02:52Z",
      "diff_hunk" : "@@ -4366,6 +4369,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586234407",
      "id" : 586234407,
      "in_reply_to_id" : 586155459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjIzNDQwNw==",
      "original_commit_id" : "d587fae7542ebfa7e6292333f0976dd32d643e20",
      "original_line" : 4379,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 602659552,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586234407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586234438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586234438"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T09:02:57Z",
      "diff_hunk" : "@@ -4366,6 +4369,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        node.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (node.m_next_local_addr_send != 0us) {\n+            node.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&node)) {\n+            FastRandomContext insecure_rand;\n+            node.PushAddress(*local_addr, insecure_rand);\n+        }\n+        node.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= node.m_next_addr_send) return;\n+\n+    node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about\n+    auto addr_already_known = [&node](const CAddress& addr) EXCLUSIVE_LOCKS_REQUIRED(node.m_addr_mutex)\n+                              {return node.m_addr_known->contains(addr.GetKey());};\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),\n+                           node.vAddrToSend.end());\n+\n+    // No addr messages to send\n+    if (node.vAddrToSend.empty()) return;\n+\n+    for (const CAddress& addr : node.vAddrToSend) {\n+        node.m_addr_known->insert(addr.GetKey());\n+    }\n+\n+    const char* msg_type;\n+    int make_flags;\n+    if (node.m_wants_addrv2) {\n+        msg_type = NetMsgType::ADDRV2;\n+        make_flags = ADDRV2_FORMAT;\n+    } else {\n+        msg_type = NetMsgType::ADDR;\n+        make_flags = 0;\n+    }\n+    m_connman.PushMessage(&node, CNetMsgMaker(node.GetCommonVersion()).Make(make_flags, msg_type, node.vAddrToSend));\n+    node.vAddrToSend.clear();\n+\n+    // we only send the big addr message once\n+    if (node.vAddrToSend.capacity() > 40)\n+        node.vAddrToSend.shrink_to_fit();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586234438",
      "id" : 586234438,
      "in_reply_to_id" : 586153384,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjIzNDQzOA==",
      "original_commit_id" : "d587fae7542ebfa7e6292333f0976dd32d643e20",
      "original_line" : 4210,
      "original_position" : 76,
      "original_start_line" : 4433,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 602659615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586234438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review, @fanquake! The compile error was due to an annotation that I'd left from a previous branch. It's now fixed.\r\n\r\n> If this SendMessages() logic is going to be split up even more, you could consider a call to GetTime<>() at the start, and just pass that into MaybeSendPing, MaybeSendAddr, MaybeSomeOtherFunc etc.\r\n\r\nGood idea. Done!",
      "created_at" : "2021-03-03T09:04:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-789555842",
      "id" : 789555842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTU1NTg0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T09:04:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789555842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586886948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586886948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `schedule. */` ",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T23:39:11Z",
      "diff_hunk" : "@@ -336,6 +336,9 @@ class PeerManagerImpl final : public PeerManager\n      *  mark the peer to be disconnected if a ping has timed out. */\n     void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);\n \n+    /** Send `addr` messages on a regular schedule*/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586886948",
      "id" : 586886948,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njg4Njk0OA==",
      "original_commit_id" : "86087474a21c730edeaa6fc2bf102d1a3d11acfc",
      "original_line" : 339,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 603469123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586886948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586903995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586903995"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what do you think about adding an `AssertLockHeld` to accompany the clang safety annotations with a dynamic runtime check? ([developer notes](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#threads-and-synchronization))",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-03T23:57:20Z",
      "diff_hunk" : "@@ -4365,6 +4368,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode* pto, std::chrono::microseconds current_time)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586903995",
      "id" : 586903995,
      "line" : 4146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkwMzk5NQ==",
      "original_commit_id" : "86087474a21c730edeaa6fc2bf102d1a3d11acfc",
      "original_line" : 4146,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 43,
      "pull_request_review_id" : 603469123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586903995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586925342"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586925342"
         }
      },
      "author_association" : "MEMBER",
      "body" : "looks like d506485865 removed the IBD check, but 4adba42f41 brings it back",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T00:48:52Z",
      "diff_hunk" : "@@ -4368,68 +4368,67 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n-void PeerManagerImpl::MaybeSendAddr(CNode* pto, std::chrono::microseconds current_time)\n+void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n {\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    const CNetMsgMaker msgMaker(node.GetCommonVersion());\n \n-    if (fListen && pto->RelayAddrsWithConn() &&\n-        !::ChainstateActive().IsInitialBlockDownload() &&\n-        pto->m_next_local_addr_send < current_time) {\n+    if (fListen && node.RelayAddrsWithConn() &&\n+        node.m_next_local_addr_send < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586925342",
      "id" : 586925342,
      "line" : 4155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyNTM0Mg==",
      "original_commit_id" : "d5064858656016005396f670c2c7a5fd1e744b10",
      "original_line" : 4155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 603469123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586925342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586930516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586930516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "might be worth updating to `m_chainman.ActivateChainstate()`? \r\n\r\nh/t https://github.com/bitcoin/bitcoin/pull/21327#discussion_r585433607",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T01:02:29Z",
      "diff_hunk" : "@@ -4375,8 +4375,6 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n \n     assert(node.m_addr_known);\n \n-    const CNetMsgMaker msgMaker(node.GetCommonVersion());\n-\n     // Periodically advertise our local address to the peer.\n     if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r586930516",
      "id" : 586930516,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkzMDUxNg==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 4176,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 603469123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586930516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587104852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587104852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "looks like both `MaybeSendPing` and `MaybeSendAddr` can be made into const member functions",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T04:46:35Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587104852",
      "id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzEwNDg1Mg==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 603700421,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587104852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587327515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587327515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure that `const` should be used in cases like this. The compiler will make sure that any function marked `const` doesn't mutate the object's data members, which is the case for both of these functions. However, `const` is not transitive, so the functions are still able to modify state through pointers and modify global state.\r\n\r\nHere, `PeerManagerImpl` owns the map of `Peer` objects:\r\n\r\n```\r\nclass PeerManagerImpl final : public PeerManager\r\n{\r\n[...]\r\nprivate:\r\n    /**\r\n     * Map of all Peer objects, keyed by peer id. This map is protected\r\n     * by the m_peer_mutex. Once a shared pointer reference is\r\n     * taken, the lock may be released. Individual fields are protected by\r\n     * their own locks.\r\n     */\r\n    std::map<NodeId, PeerRef> m_peer_map GUARDED_BY(m_peer_mutex);\r\n```\r\n\r\nand the map of `CNodeState` objects are global (in the file's unnamed namespace):\r\n\r\n```\r\n/** Map maintaining per-node state. */\r\nstatic std::map<NodeId, CNodeState> mapNodeState GUARDED_BY(cs_main);\r\n```\r\n\r\nSo `PeerManagerImpl` definitely owns the `Peer` objects, and logically owns the `CNodeState` objects since it's responsible for constructing and destructing them (and #20758 actually moves the `CNodeState` objects into `PeerManagerImpl`).\r\n\r\nThese functions don't mutate `PeerManagerImpl`, but _do_ mutate data that it owns. I think in such cases there's an argument that we shouldn't mark the function `const` even if the compiler would allow us to. For me, `const` on a member function is telling the programmer \"this function does not mutate the logical state of this object\", which isn't the case here.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T10:01:37Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587327515",
      "id" : 587327515,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMyNzUxNQ==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 603916449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587327515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587328862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587328862"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T10:03:33Z",
      "diff_hunk" : "@@ -336,6 +336,9 @@ class PeerManagerImpl final : public PeerManager\n      *  mark the peer to be disconnected if a ping has timed out. */\n     void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);\n \n+    /** Send `addr` messages on a regular schedule*/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587328862",
      "id" : 587328862,
      "in_reply_to_id" : 586886948,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMyODg2Mg==",
      "original_commit_id" : "86087474a21c730edeaa6fc2bf102d1a3d11acfc",
      "original_line" : 339,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 603918218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587328862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587329584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587329584"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T10:04:45Z",
      "diff_hunk" : "@@ -4365,6 +4368,71 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode* pto, std::chrono::microseconds current_time)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587329584",
      "id" : 587329584,
      "in_reply_to_id" : 586903995,
      "line" : 4146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMyOTU4NA==",
      "original_commit_id" : "86087474a21c730edeaa6fc2bf102d1a3d11acfc",
      "original_line" : 4146,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 43,
      "pull_request_review_id" : 603919285,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587329584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587329723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587329723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. Good catch. Fixed!",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T10:04:56Z",
      "diff_hunk" : "@@ -4368,68 +4368,67 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n-void PeerManagerImpl::MaybeSendAddr(CNode* pto, std::chrono::microseconds current_time)\n+void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n {\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    const CNetMsgMaker msgMaker(node.GetCommonVersion());\n \n-    if (fListen && pto->RelayAddrsWithConn() &&\n-        !::ChainstateActive().IsInitialBlockDownload() &&\n-        pto->m_next_local_addr_send < current_time) {\n+    if (fListen && node.RelayAddrsWithConn() &&\n+        node.m_next_local_addr_send < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587329723",
      "id" : 587329723,
      "in_reply_to_id" : 586925342,
      "line" : 4155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMyOTcyMw==",
      "original_commit_id" : "d5064858656016005396f670c2c7a5fd1e744b10",
      "original_line" : 4155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 603919471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587329723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587332869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587332869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't adding a new `::ChainstateActive()` like #21327 was. I think changing this call to be `m_chainman.ActiveChainstate()` would be adding more noise/distraction for reviewers.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T10:09:17Z",
      "diff_hunk" : "@@ -4375,8 +4375,6 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n \n     assert(node.m_addr_known);\n \n-    const CNetMsgMaker msgMaker(node.GetCommonVersion());\n-\n     // Periodically advertise our local address to the peer.\n     if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587332869",
      "id" : 587332869,
      "in_reply_to_id" : 586930516,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMzMjg2OQ==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 4176,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 603923517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587332869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @amitiuttarwar! I've addressed all of your comments.",
      "created_at" : "2021-03-04T10:09:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-790497523",
      "id" : 790497523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDQ5NzUyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T10:09:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790497523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587422505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587422505"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since `PeerRef` is a shared_ptr which does its own destruction once the ref count hits zero, I don't think it's accurate to say that `PeerManagerImpl` owns the `Peer` object.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T12:17:55Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587422505",
      "id" : 587422505,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzQyMjUwNQ==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604037167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587422505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587435992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587435992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure it's right to say that ownership of Peer is shared because it uses a shared pointer. We use a shared pointer for the Peer for convenience/safety/synchronization. We never take a shared pointer to a Peer outside PeerManagerImpl, and if we really wanted to, could implement it with raw pointers and a manual ref count, and then `new` and `delete` the Peer objects (as is done by CConnman for its CNode objects in vNodes)\r\n\r\nThat's maybe a bit pedantic. I think the more important question is \"what is `const` for?\" For me, it means \"this function won't mutate the _logical_ state of this object\". If we're using it to say \"this function won't mutate the data members of this object, but it will mutate the state of data structures that are integral to how this object operates, but will do so through a pointer\", then it seems a bit legalistic and not very useful to me.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T12:39:09Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587435992",
      "id" : 587435992,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzQzNTk5Mg==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604054910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587435992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587491156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587491156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was surprised to discover that if you have a class Y with a member `X& x` then C++ thinks it's fine to modify `x.foo = 3` from a const member function of Y. So not sure I'd argue against \"a bit legalistic and not very useful\"... (So in particular, if you have a `const PeerManagerImpl`, it will have no problems calling non-const functions of its `m_connman`)\r\n\r\nIf you consider modifying the contents of a `PeerRef` to be modifying a `PeerManagerImpl`, then I don't think it's consistent to mark `GetPeerRef()` as const either (code compiles fine that way though). I dunno; \"shared\" makes me think things are shared, not owned, so that's definitely a mental adjustment.\r\n\r\nI guess I don't think it's a good idea to try to put too much convention on top of what our compilers will actually enforce here though.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T13:59:11Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587491156",
      "id" : 587491156,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzQ5MTE1Ng==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604127769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587491156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-04T14:11:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-790645450",
      "id" : 790645450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDY0NTQ1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T14:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790645450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-03-04T14:26:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-790655465",
      "id" : 790655465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDY1NTQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T14:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790655465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587515302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587515302"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This certainly isn't a hill I'm prepared to die on (either here or in https://github.com/bitcoin/bitcoin/pull/21162#discussion_r587410937). My preference is not to mark functions as const if they're mutating data that is so closely associated with the object that it can only be modified through the object, but I'll go along with the majority if people want this to be const.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T14:28:55Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587515302",
      "id" : 587515302,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzUxNTMwMg==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604159447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587515302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587557545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587557545"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, not my hill either, but I think it's worth discussing so we've got a *shared* understanding of how this data's meant to be controlled... I have some other ideas about `Peer` ownership I want to try out once more of this refactoring is finished that might change this, and worst case can add or remove const markers when we're reordering the PeerManageImpl declarations and adding more comments...",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T15:18:22Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587557545",
      "id" : 587557545,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzU1NzU0NQ==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604216120,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587557545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587729007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587729007"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok. since this is a refactor PR anyway, as a reviewer I would not mind, but its no worries :) ",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-04T18:49:44Z",
      "diff_hunk" : "@@ -4375,8 +4375,6 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n \n     assert(node.m_addr_known);\n \n-    const CNetMsgMaker msgMaker(node.GetCommonVersion());\n-\n     // Periodically advertise our local address to the peer.\n     if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587729007",
      "id" : 587729007,
      "in_reply_to_id" : 586930516,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzcyOTAwNw==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 4176,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 604439071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587729007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587946600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587946600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that the relevant question is \"what is `const` for?\" The two main aspects are compiler enforcement & human understanding. @jnewbery I get what you're saying about making these member functions `const` is misleading for the humans, because the function often mutates the logical state of the object. However, I also agree with @ajtowns that since the compilers would actually be enforcing something here, it does offer a bit of literal guarding?\r\n\r\nI don't have a strong opinion on which way we go, but it is definitely an interesting consideration & mostly I conclude that `const` is complex. I'm personally curious to learn more about how a compiler uses the keyword- when its just enforcement vs optimization. (recommending resources welcome!)",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-05T00:57:50Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587946600",
      "id" : 587946600,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzk0NjYwMA==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604708190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587946600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587978004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587978004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm 99% sure that compilers don't use `const` markers on functions/pointers/references at all for optimization. All they do is disallow certain operations on them.\r\n\r\nIt's different if you have an actual `const` variable (e.g. a global, local, or member variable that is declared const where it is defined & initialized), because that means \"changing this is UB\". Any other use simply means \"no non-const operations are allowed on object *through this reference/pointer/function*; if other code is invoked that happens to hold a non-const reference/pointer, the object can still change (and the compiler can't assume a cached version in a register won't change e.g.).",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-05T02:21:53Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r587978004",
      "id" : 587978004,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzk3ODAwNA==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 604745053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587978004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588780970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588780970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should we explicitly `#include <algorithm>`? ",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-05T23:25:33Z",
      "diff_hunk" : "@@ -4196,8 +4194,20 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n     if (current_time <= node.m_next_addr_send) return;\n \n     node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n-    std::vector<CAddress> vAddr;\n-    vAddr.reserve(node.vAddrToSend.size());\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about\n+    auto addr_already_known = [&node](const CAddress& addr) {return node.m_addr_known->contains(addr.GetKey());};\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588780970",
      "id" : 588780970,
      "line" : 4190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODc4MDk3MA==",
      "original_commit_id" : "151597e19ba3dd662c25ea37f957f5ceddc95aec",
      "original_line" : 4190,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 87,
      "pull_request_review_id" : 605682022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588780970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588787373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588787373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "interesting, ok. so other than with direct variable management, `const` essentially uses the compiler to ensure anyone introducing new code has to think before they modify the object through this path. hm, thanks.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-05T23:48:40Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588787373",
      "id" : 588787373,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODc4NzM3Mw==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 605682022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588787373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588896407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588896407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@sipa yes, that's exactly my understanding. Mutating a `const`-declared variable is UB. Therefore compilers could make optimizations based on the fact that `const`-declared variables cannot change.\r\n\r\n`const` on a member functions simply means that this function call won't mutate the state of the object, although of course, other code could mutate the state. Therefore, the compiler can't make any assumptions about the state of the variable not changing.\r\n\r\nYou can even mutate the state through a `const` function by casting away the constness, eg:\r\n\r\n```c++\r\n#include <iostream>\r\n\r\nclass thing\r\n{\r\n    int x{0};\r\n\r\npublic:\r\n    void mutate(int x_in) const\r\n    {\r\n        thing* mutable_this = const_cast<thing*>(this);\r\n        mutable_this->x = x_in;\r\n    }\r\n\r\n    int access() const { return x; }\r\n\r\n    thing(int x_in) : x(x_in) { }\r\n};\r\n \r\nint main()\r\n{\r\n    thing t(1);\r\n    std::cout << \"t.x = \" << t.access() << \"\\n\";\r\n\r\n    t.mutate(2);\r\n    std::cout << \"t.x = \" << t.access() << \"\\n\";\r\n\r\n    return 0;\r\n}\r\n```\r\n\r\nYou can see that the state of `t` has been mutated in the `mutate()` function, even though that function is `const`. This compiles with no warnings. I believe this is perfectly legal (although ill-advised!) c++. The c++ core guidelines advise against casting away const in almost all cases: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#es50-dont-cast-away-const. Scott Meyers does use casting away const to avoid code duplication: https://stackoverflow.com/a/123995/933705 (although that book is now quite old, so I'm not sure if the advice is still current).\r\n\r\nGoing back to the main question about whether these functions _should_ be `const`, I found [the isocpp.org wikipedia page on const correctness](https://isocpp.org/wiki/faq/const-correctness) to be very useful in clarifying my thoughts. A few extracts:\r\n\r\n> The trailing `const` on `inspect()` member function should be used to mean the method wont change the objects _abstract_ (client-visible) state. That is slightly different from saying the method wont change the raw bits of the objects `struct`\r\n\r\n> a `const` member function must not change (or allow a caller to change) the this objects _logical_ state (AKA _abstract_ state AKA _meaningwise_ state). Think of what an object means, not how it is internally implemented. A Persons age and name are logically part of the Person, but the Persons neighbor and employer are not. An inspector method that returns part of the this objects _logical_ / _abstract_ / _meaningwise_ state must not return a non-`const` pointer (or reference) to that part, **independent of whether that part is internally implemented as a direct data-member physically embedded within the this object or some other way**. (emphasis mine)\r\n\r\n> - If a method changes any part of the objects logical state, it logically is a mutator; it should not be const even if (as actually happens!) the method doesnt change any physical bits of the objects concrete state.\r\n> - Conversely, a method is logically an inspector and should be const if it never changes any part of the objects logical state, even if (as actually happens!) the method changes physical bits of the objects concrete state.\r\n\r\n> If you are outside the class  you are a normal user, every experiment you could perform (every method or sequence of methods you call) would have the same results (same return values, same exceptions or lack of exceptions) irrespective of whether you first called that lookup method. If the lookup function changed any future behavior of any future method (not just making it faster but changed the outcome, changed the return value, changed the exception), then the lookup method changed the objects logical state  it is a mutuator.\r\n\r\nBased on that, I believe these functions should not be marked `const`. Calling `MaybeSendPing()` and `MaybeSendAddr()` multiple times will result in different behaviour that is observable from outside the class, since the `Peer()` objects are mutated.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-06T15:44:21Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588896407",
      "id" : 588896407,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5NjQwNw==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 605765705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588896407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588897221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588897221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes! Thank you :)",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-06T15:51:07Z",
      "diff_hunk" : "@@ -4196,8 +4194,20 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n     if (current_time <= node.m_next_addr_send) return;\n \n     node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n-    std::vector<CAddress> vAddr;\n-    vAddr.reserve(node.vAddrToSend.size());\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about\n+    auto addr_already_known = [&node](const CAddress& addr) {return node.m_addr_known->contains(addr.GetKey());};\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588897221",
      "id" : 588897221,
      "in_reply_to_id" : 588780970,
      "line" : 4190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5NzIyMQ==",
      "original_commit_id" : "151597e19ba3dd662c25ea37f957f5ceddc95aec",
      "original_line" : 4190,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 87,
      "pull_request_review_id" : 605766216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588897221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588899879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588899879"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done!",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-06T16:16:36Z",
      "diff_hunk" : "@@ -4196,8 +4194,20 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds curre\n     if (current_time <= node.m_next_addr_send) return;\n \n     node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n-    std::vector<CAddress> vAddr;\n-    vAddr.reserve(node.vAddrToSend.size());\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about\n+    auto addr_already_known = [&node](const CAddress& addr) {return node.m_addr_known->contains(addr.GetKey());};\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r588899879",
      "id" : 588899879,
      "in_reply_to_id" : 588780970,
      "line" : 4190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5OTg3OQ==",
      "original_commit_id" : "151597e19ba3dd662c25ea37f957f5ceddc95aec",
      "original_line" : 4190,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 87,
      "pull_request_review_id" : 605767957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588899879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The only touchpoint I'm unsure about is the call to fRelay here\r\n\r\nI'm not sure what this is referring to. I don't see `fRelay` in that file at all.",
      "created_at" : "2021-03-06T16:17:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-791980714",
      "id" : 791980714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTk4MDcxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T16:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791980714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think we now traverse the vector 2x instead of 1x, but that seems fine.\r\n\r\nI've changed this so we both check for the addr in `node.m_addr_known` and add it to `node.m_addr_known` in the same pass.",
      "created_at" : "2021-03-06T16:42:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-791986604",
      "id" : 791986604,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTk4NjYwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T16:42:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791986604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Well just depends if your locating a delivery or life form suppose time and\nreality and computer s and virtually augmentation with magnetic field and\nradio station tower in unison league s of things networked in a branch of\nservers and databases uploading instead of down and cloud space could be\nused as an example of connections that don't exist like bluetooth or sound\nthen theory has it if you left side of your brain was the tracking\ntransition of nuero synaptic feeds then suppose I could run all three bases\nwhen not slowed down or placed in a geo metric analysis predicted spatial\nof surveying that layers beyond the scope of even einstiens guessing or\nmath if I stepped left twice jumped stretched my calf and verily looked\nright to check the sun then my own body would be in perfect balance in\nrelationship to this earth  and mutually connected to flow to and from\nvarious spaces or matters that may not even be existing considering even\ngrass doesn't make since to most unless your in paradise bloom berg point\nis two planets almost identical to another so close to one another that\nsome one could climb or fly or trampoline right into another world where\nthey might run into a duplicate smarter version of there very own self\nsuppose what I said is right in the sky now and the blue you see is the\nwater from another earth so close that account for pipelines and quotes of\ngravity and you got a sky network of endless resources unless someone knew\nmore than what he just said just now\n\nOn Sat, Mar 6, 2021, 9:44 AM John Newbery <notifications@github.com> wrote:\n\n> I think we now traverse the vector 2x instead of 1x, but that seems fine.\n>\n> I've changed this so we both check for the addr in node.m_addr_known and\n> add it to node.m_addr_known in the same pass.\n>\n> \n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-791986604>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/ATDTIGQTWU7VXE4PDZOB63LTCJLWHANCNFSM4X4K2C3Q>\n> .\n>\n",
      "created_at" : "2021-03-06T19:42:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-792038983",
      "id" : 792038983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MjAzODk4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T19:42:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/792038983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80163866?v=4",
         "events_url" : "https://api.github.com/users/xzavjierr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xzavjierr/followers",
         "following_url" : "https://api.github.com/users/xzavjierr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xzavjierr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xzavjierr",
         "id" : 80163866,
         "login" : "xzavjierr",
         "node_id" : "MDQ6VXNlcjgwMTYzODY2",
         "organizations_url" : "https://api.github.com/users/xzavjierr/orgs",
         "received_events_url" : "https://api.github.com/users/xzavjierr/received_events",
         "repos_url" : "https://api.github.com/users/xzavjierr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xzavjierr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xzavjierr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xzavjierr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-11T12:46:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-796710557",
      "id" : 796710557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjcxMDU1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T12:46:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796710557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-03-11T13:58:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-796754661",
      "id" : 796754661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5Njc1NDY2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T13:58:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796754661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-17T12:44:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-801052314",
      "id" : 801052314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTA1MjMxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T12:44:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801052314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-03-17T14:25:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-801124033",
      "id" : 801124033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTEyNDAzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T14:25:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801124033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r596292997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596292997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm convinced :) ",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-17T18:45:09Z",
      "diff_hunk" : "@@ -334,7 +334,10 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n      *  mark the peer to be disconnected if a ping has timed out. */\n-    void MaybeSendPing(CNode& node_to, Peer& peer);\n+    void MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r596292997",
      "id" : 596292997,
      "in_reply_to_id" : 587104852,
      "line" : 324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjI5Mjk5Nw==",
      "original_commit_id" : "950398a61b0677b852f26f66ec2deda599b0b5fc",
      "original_line" : 324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 614671944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596292997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-03-26T13:26:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-808217285",
      "id" : 808217285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODIxNzI4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-26T13:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808217285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r602442471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602442471"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e3d6cbca83300e5ccc0fd8a1075ff52654aa76ff\r\n\r\nEarly return skips https://github.com/bitcoin/bitcoin/blob/e3d6cbca83300e5ccc0fd8a1075ff52654aa76ff/src/net_processing.cpp#L4221-L4224\r\n\r\nThat differs from original behavior.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-26T16:44:43Z",
      "diff_hunk" : "@@ -4156,6 +4158,72 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n+{\n+    AssertLockHeld(node.cs_sendProcessing);\n+\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload() &&\n+        node.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (node.m_next_local_addr_send != 0us) {\n+            node.m_addr_known->reset();\n+        }\n+        if (std::optional<CAddress> local_addr = GetLocalAddrForPeer(&node)) {\n+            FastRandomContext insecure_rand;\n+            node.PushAddress(*local_addr, insecure_rand);\n+        }\n+        node.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= node.m_next_addr_send) return;\n+\n+    node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about, and add new\n+    // addrs to the m_addr_known filter on the same pass.\n+    auto addr_already_known = [&node](const CAddress& addr) {\n+        bool ret = node.m_addr_known->contains(addr.GetKey());\n+        if (!ret) node.m_addr_known->insert(addr.GetKey());\n+        return ret;\n+    };\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),\n+                           node.vAddrToSend.end());\n+\n+    // No addr messages to send\n+    if (node.vAddrToSend.empty()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r602442471",
      "id" : 602442471,
      "line" : 4194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ0MjQ3MQ==",
      "original_commit_id" : "e3d6cbca83300e5ccc0fd8a1075ff52654aa76ff",
      "original_line" : 4194,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 91,
      "pull_request_review_id" : 622345585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602442471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r602883642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602883642"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "super nit: `current_time` here is `const`. Not sure if the intention for `now` is to be immutable in `MaybeSendPing()`, but I think  `now` would still be mutable even though the outer scoped variable is `const` because of the param signature in `MaybeSendPing(..., std::chrono::microseconds now)`",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-28T14:04:30Z",
      "diff_hunk" : "@@ -4194,7 +4192,9 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     // If we get here, the outgoing message serialization version is set and can't change.\n     const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n \n-    MaybeSendPing(*pto, *peer);\n+    const auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    MaybeSendPing(*pto, *peer, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r602883642",
      "id" : 602883642,
      "line" : 4254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjg4MzY0Mg==",
      "original_commit_id" : "461dda316aefa4f792350a82ca2fb8c6daf8cca1",
      "original_line" : 4254,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 622751108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602883642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603171920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603171920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In general, there's no benefit to making pass by value parameters const. Passing by reference to const indicates to the caller that the parameter will not be mutated. When passing by value, a copy of the parameter is made, so the original object cannot be mutated.\r\n\r\nThere's very good documentation about how to pass parameters in the c++ core guidelines: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#f16-for-in-parameters-pass-cheaply-copied-types-by-value-and-others-by-reference-to-const.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T10:11:36Z",
      "diff_hunk" : "@@ -4194,7 +4192,9 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     // If we get here, the outgoing message serialization version is set and can't change.\n     const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n \n-    MaybeSendPing(*pto, *peer);\n+    const auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    MaybeSendPing(*pto, *peer, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603171920",
      "id" : 603171920,
      "in_reply_to_id" : 602883642,
      "line" : 4254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzE3MTkyMA==",
      "original_commit_id" : "461dda316aefa4f792350a82ca2fb8c6daf8cca1",
      "original_line" : 4254,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 623068741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603171920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603212914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603212914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21317 has now been merged so I've updated this to use the `if (!Assume(condition)) { recovery; }` pattern.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T11:22:55Z",
      "diff_hunk" : "@@ -4365,6 +4368,68 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& pto)\n+{\n+    // Nothing to do for non-address-relay peers\n+    if (!pto.RelayAddrsWithConn()) return;\n+\n+    auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !::ChainstateActive().IsInitialBlockDownload() &&\n+        pto.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (pto.m_next_local_addr_send != 0us) {\n+            pto.m_addr_known->reset();\n+        }\n+        if (Optional<CAddress> local_addr = GetLocalAddrForPeer(&pto)) {\n+            FastRandomContext insecure_rand;\n+            pto.PushAddress(*local_addr, insecure_rand);\n+        }\n+        pto.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= pto.m_next_addr_send) return;\n+    pto.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(pto.m_addr_known);\n+    assert(pto.vAddrToSend.size() <= MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603212914",
      "id" : 603212914,
      "in_reply_to_id" : 579181272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxMjkxNA==",
      "original_commit_id" : "5e9af6f8412a773b920b4d2c2c972c811e57dd31",
      "original_line" : 4403,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623122411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603212914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603213253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603213253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is still causing confusion for reviewers, so I've moved the fields to have their own lock that is only used in net_processing.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T11:23:30Z",
      "diff_hunk" : "@@ -546,8 +546,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603213253",
      "id" : 603213253,
      "in_reply_to_id" : 583805388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxMzI1Mw==",
      "original_commit_id" : "975f0060aabc5d0de37ce5542f5c0f2055daebfe",
      "original_line" : 550,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 623122850,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603213253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @hebasto! Responding to your points:\r\n\r\n> I see two calls of three are consolidated. What about the third one [...]\r\n\r\nI was also counting the call inside `MaybeSendPing()`, which is called from `SendMessages()`. I've now removed the additional call to `GetTime()` as suggested, which required a duration cast.\r\n\r\n> I believe that this commit is not a clean refactoring. To be precise, change behavior could be expected as even LOCK(cs_main); could take unpredictable time. But the scale of such changes seems insignificant to P2P, right?\r\n\r\nGood observation! However, I think it's fine to treat time as constant within a call to `SendMessages()`, since it's observationally equivalent to any actors outside net_processing.\r\n\r\n> The commit \"[net processing] Extract addr send functionality into MaybeSendAddr()\" (97e1013) allows to localize acquiring of the CNode::cs_sendProcessing mutex\r\n\r\nThe fact that you've raised this independently has made me reconsider the discussion here https://github.com/bitcoin/bitcoin/pull/21236#discussion_r583805388. It doesn't make sense for a mutex to  be guarding variables/functions across multiple layers, so I've moved the addr send time vars under their own mutex.\r\n\r\n> Early return skips\r\n> \r\n> ```\r\n>  // we only send the big addr message once \r\n>  if (node.vAddrToSend.capacity() > 40) { \r\n>      node.vAddrToSend.shrink_to_fit(); \r\n>  } \r\n> ```\r\n> \r\n> That differs from original behavior.\r\n\r\nAnother great observation! Although again, I don't think it matters. This logic is for when we've sent a response to the peer's `getaddr` message. In such cases, we'd expect to send up to 1000 addresses, and for the address filter to not yet be filled, so we wouldn't exit early.",
      "created_at" : "2021-03-29T11:23:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-809301197",
      "id" : 809301197,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTMwMTE5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T11:23:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809301197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603213680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603213680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @hebasto! See https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-809301197.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T11:24:14Z",
      "diff_hunk" : "@@ -4156,6 +4158,72 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n     }\n }\n \n+void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n+{\n+    AssertLockHeld(node.cs_sendProcessing);\n+\n+    // Nothing to do for non-address-relay peers\n+    if (!node.RelayAddrsWithConn()) return;\n+\n+    assert(node.m_addr_known);\n+\n+    // Periodically advertise our local address to the peer.\n+    if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload() &&\n+        node.m_next_local_addr_send < current_time) {\n+        // If we've sent before, clear the bloom filter for the peer, so that our\n+        // self-announcement will actually go out.\n+        // This might be unnecessary if the bloom filter has already rolled\n+        // over since our last self-announcement, but there is only a small\n+        // bandwidth cost that we can incur by doing this (which happens\n+        // once a day on average).\n+        if (node.m_next_local_addr_send != 0us) {\n+            node.m_addr_known->reset();\n+        }\n+        if (std::optional<CAddress> local_addr = GetLocalAddrForPeer(&node)) {\n+            FastRandomContext insecure_rand;\n+            node.PushAddress(*local_addr, insecure_rand);\n+        }\n+        node.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\n+    }\n+\n+    // We sent an `addr` message to this peer recently. Nothing more to do.\n+    if (current_time <= node.m_next_addr_send) return;\n+\n+    node.m_next_addr_send = PoissonNextSend(current_time, AVG_ADDRESS_BROADCAST_INTERVAL);\n+\n+    assert(node.vAddrToSend.size() <= MAX_ADDR_TO_SEND);\n+\n+    // Remove addr records that the peer already knows about, and add new\n+    // addrs to the m_addr_known filter on the same pass.\n+    auto addr_already_known = [&node](const CAddress& addr) {\n+        bool ret = node.m_addr_known->contains(addr.GetKey());\n+        if (!ret) node.m_addr_known->insert(addr.GetKey());\n+        return ret;\n+    };\n+    node.vAddrToSend.erase(std::remove_if(node.vAddrToSend.begin(), node.vAddrToSend.end(), addr_already_known),\n+                           node.vAddrToSend.end());\n+\n+    // No addr messages to send\n+    if (node.vAddrToSend.empty()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603213680",
      "id" : 603213680,
      "in_reply_to_id" : 602442471,
      "line" : 4194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxMzY4MA==",
      "original_commit_id" : "e3d6cbca83300e5ccc0fd8a1075ff52654aa76ff",
      "original_line" : 4194,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 91,
      "pull_request_review_id" : 623123390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603213680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603229203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603229203"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, apologies, I think I should have been more clear. Even though the `std::chrono` is passed by value, MaybeSendPing() treats ~it~ the copy as mutable even though I don't think the method mutates the copy. So I was just thinking would it be useful/or maybe unecessary to make current_time in MaybeSendPing() also const.",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T11:52:04Z",
      "diff_hunk" : "@@ -4194,7 +4192,9 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     // If we get here, the outgoing message serialization version is set and can't change.\n     const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n \n-    MaybeSendPing(*pto, *peer);\n+    const auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    MaybeSendPing(*pto, *peer, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603229203",
      "id" : 603229203,
      "in_reply_to_id" : 602883642,
      "line" : 4254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIyOTIwMw==",
      "original_commit_id" : "461dda316aefa4f792350a82ca2fb8c6daf8cca1",
      "original_line" : 4254,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 623143269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T11:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603229203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603305159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603305159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I understand. Yes, it is possible to mark the function parameters as `const` in the definition, which would prevent the copy from being mutated within the function body. You can even do this if the function declaration does not mark the parameter as `const`.\r\n\r\nHowever, I haven't ever seen that style used in this project. It may be marginally useful, but it may also be misleading (eg see https://groups.google.com/u/4/g/comp.lang.c++.moderated/c/DEQTho8OCj8).",
      "commit_id" : "b4d7d3def058e17d36cf7702e34c0a2fff45a5cf",
      "created_at" : "2021-03-29T13:42:59Z",
      "diff_hunk" : "@@ -4194,7 +4192,9 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     // If we get here, the outgoing message serialization version is set and can't change.\n     const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n \n-    MaybeSendPing(*pto, *peer);\n+    const auto current_time = GetTime<std::chrono::microseconds>();\n+\n+    MaybeSendPing(*pto, *peer, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#discussion_r603305159",
      "id" : 603305159,
      "in_reply_to_id" : 602883642,
      "line" : 4254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzMwNTE1OQ==",
      "original_commit_id" : "461dda316aefa4f792350a82ca2fb8c6daf8cca1",
      "original_line" : 4254,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 623243445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21236",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-29T13:42:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603305159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "`RecursiveMutex cs_sendProcessing` guards nothing. Let's burn it :)",
      "created_at" : "2021-03-29T16:45:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-809535865",
      "id" : 809535865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTUzNTg2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T16:45:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809535865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "pico-nit: I find myself more comfortable to reason about the code when the same variable is placed on the same position in similar logical operations. Consider\r\nhttps://github.com/bitcoin/bitcoin/blob/b4d7d3def058e17d36cf7702e34c0a2fff45a5cf/src/net_processing.cpp#L4154-L4155 and https://github.com/bitcoin/bitcoin/blob/b4d7d3def058e17d36cf7702e34c0a2fff45a5cf/src/net_processing.cpp#L4173\r\n\r\nCould `current_time` position be consistent?",
      "created_at" : "2021-03-29T16:52:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-809540053",
      "id" : 809540053,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTU0MDA1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T16:52:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809540053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> pico-nit: I find myself more comfortable to reason about the code when the same variable is placed on the same position in similar logical operations.\r\n\r\nI tend to agree and think that generally the variable should be placed on the left and the thing it's being compared to on the right. Others disagreed with me on previous PRs and told me to always place the smaller thing on the left. I think it's just a matter of taste :shrug: ",
      "created_at" : "2021-03-29T17:18:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-809557707",
      "id" : 809557707,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTU1NzcwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T17:18:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809557707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 935d4889228e7e361c8b0020761fa0e08a55fb48",
      "created_at" : "2021-03-31T23:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21236#issuecomment-811526436",
      "id" : 811526436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21236",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTUyNjQzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T23:18:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811526436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
