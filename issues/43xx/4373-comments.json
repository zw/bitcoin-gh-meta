[
   {
      "body" : "Comments:\r\n* Agree this wants fixing.\r\n* Memory exhaustion in RPC is a low priority, since it's an internal control plane, not something that should be exposed to the open Internet.\r\n* 16k seems small.  It is easy to construct a valid JSON batch request of this size.  Make it 1MB.\r\n* During review, I noticed we use getline(), which is similarly unbounded input.\r\n\r\nSo, increase the limit and consider fixing getline() calls too.\r\n",
      "created_at" : "2014-06-20T14:31:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46684473",
      "id" : 46684473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:31:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46684473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "So with this fix, you actually have to SEND 4GB (or whatever) of data to exhaust 4GB (or whatever) of memory, instead of just sending a header SAYING that you'll send 4GB of data.\r\n\r\nACK: better is better. Although did you consider just setting an arbitrary, large limit on nLen? Code would be simpler...",
      "created_at" : "2014-06-20T14:35:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46684899",
      "id" : 46684899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46684899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen Actually, very good final point.  Just change the limit here:\r\n```\r\n    int nLen = ReadHTTPHeaders(stream, mapHeadersRet);\r\n    if (nLen < 0 || nLen > (int)MAX_SIZE)\r\n        return HTTP_INTERNAL_SERVER_ERROR;\r\n```\r\n\r\nto 1MB.\r\n\r\nCurrently the limit is _not_ infinite, either:\r\n```\r\nstatic const unsigned int MAX_SIZE = 0x02000000;\r\n```\r\n\r\nSo, that's 32MB.\r\n",
      "created_at" : "2014-06-20T14:42:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46685824",
      "id" : 46685824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:42:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46685824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "General comment:  Our RPC code really wants to be smarter in any case.  You can just as easily open a bunch of connections, even with the loop, and exhaust memory.  Or another familiar HTTP attack is opening a bunch of connections, keeping them open for hours or days without making progress.\r\n\r\ni.e. send one character per day across 10,000 connections.  Stupid server will not timeout, and sockets will be rapidly exhausted.",
      "created_at" : "2014-06-20T14:45:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46686155",
      "id" : 46686155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46686155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Yes there is already a limit, and yes this is low priority, I was mislead by the issue description that this happened *before* the rpcallow check. Closing.",
      "created_at" : "2014-06-20T14:47:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46686451",
      "id" : 46686451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:47:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46686451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Also it's not about unbounded input, but as @gavinandresen remarks correctly that with this change you actually have to send the amount of bytes to get them allocated instead of being able to open 100 connections up-front and specifying 32 mbytes of data and keeping open the connection without actually sending it (which is very cheap to do).",
      "created_at" : "2014-06-20T14:49:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46686681",
      "id" : 46686681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46686681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj Agree, that is why I did not NAK the patch.\r\n\r\nAdding a loop is fine with me...  just 16k was _much_ too low.\r\n",
      "created_at" : "2014-06-20T14:55:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46687393",
      "id" : 46687393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T14:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46687393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Untested ACK; I would raise the 16k too, though.",
      "created_at" : "2014-06-20T22:39:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46734007",
      "id" : 46734007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-20T22:39:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46734007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "OK, seemingly this fix-on-top-of-a-stack-of-hacks is good enough for now, will change POST_READ_SIZE to 1MiB.\r\n",
      "created_at" : "2014-06-21T08:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-46747495",
      "id" : 46747495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-06-21T08:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/46747495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Rebased and changed POST_READ_SIZE to 256kiB.\r\n",
      "created_at" : "2014-07-04T07:23:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-48015462",
      "id" : 48015462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-07-04T07:23:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48015462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4373_2ec5a3d212ac4b09e6c32d495f34ee3cdedc8c66/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-07-04T08:05:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4373#issuecomment-48018189",
      "id" : 48018189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4373",
      "updated_at" : "2014-07-04T08:05:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48018189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   }
]
