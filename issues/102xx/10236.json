{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "In [a recent blog post](http://laanwj.github.io/2017/04/19/bitcoin-test-qemu-cache-settings.html) Wladimir writes that:\r\n\r\n> It turns out that [tests run slowly] because the wallet code does an fsync after every operation to make sure that changes to the database are safely written to disk\r\n\r\n`ThreadFlushWalletDB()` in `src/wallet/walletdb.cpp` has roughly the following logic:\r\n\r\n    every 500 milliseconds:\r\n        if (the wallet has been modified since the last time it was flushed to disk &&\r\n            the wallet hasn't been modified for at least 2 seconds &&\r\n            we can get a database lock &&\r\n            the database isn't currently in use):\r\n        then\r\n            flush it to disk\r\n\r\nThis has a couple of problems:\r\n\r\n* If the wallet receives a deposit every second, the \"hasn't been modified for at least 2 seconds\" condition is never met, and so the wallet is never flushed to disk. Perhaps the loop needs to have an extra check, \"if the wallet wasn't flushed in the last N1 seconds then flush it now even if it was modified in the last 2 seconds\".\r\n\r\n* If the wallet receives a deposit every 2.5 seconds, the \"hasn't been modified for at least 2 seconds\" condition is almost always met, and so the wallet is continually flushed to disk. The wallet file grows bigger with each deposit, and the flushing causes a full rewrite of the file. This causes a quadratically increasing disk usage over time, eventually swamping the capacity of the drive. Perhaps the loop needs to have an extra check: \"if the wallet was flushed in the last N2 seconds then don't flush it now, even if it wasn't modified in the last 2 seconds\".\r\n\r\nIs there some way of safely updating a BDB database without rewriting the whole file to disk for every update? This seems like a major inefficiency.\r\n\r\nI've been struggling with this issue of ever increasing hard drive use as wallet size grows for years now, but only recently discovered the root cause of the problem.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10236/comments",
   "created_at" : "2017-04-19T17:39:10Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10236/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/10236",
   "id" : 222814923,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10236/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyMjI4MTQ5MjM=",
   "number" : 10236,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "wallet flushing thread could use improvement",
   "updated_at" : "2018-02-16T07:33:07Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10236",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/573356?v=4",
      "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dooglus/followers",
      "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dooglus",
      "id" : 573356,
      "login" : "dooglus",
      "node_id" : "MDQ6VXNlcjU3MzM1Ng==",
      "organizations_url" : "https://api.github.com/users/dooglus/orgs",
      "received_events_url" : "https://api.github.com/users/dooglus/received_events",
      "repos_url" : "https://api.github.com/users/dooglus/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dooglus"
   }
}
