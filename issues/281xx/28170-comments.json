[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28170).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1842572200), [andrewtoth](https://github.com/bitcoin/bitcoin/pull/28170#pullrequestreview-1771466506) |\n| Concept ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/28170#pullrequestreview-1581277414) |\n| Approach NACK | [vasild](https://github.com/bitcoin/bitcoin/pull/28170#pullrequestreview-1769801940) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28956](https://github.com/bitcoin/bitcoin/pull/28956) (Nuke adjusted time (attempt 2) by dergoegge)\n* [#28016](https://github.com/bitcoin/bitcoin/pull/28016) (p2p: gives seednode priority over dnsseed if both are provided by sr-gi)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#15218](https://github.com/bitcoin/bitcoin/pull/15218) (validation: Flush state after initial sync by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-07-27T15:34:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1653862929",
      "id" : 1653862929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585ik_IR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1653862929/reactions"
      },
      "updated_at" : "2023-12-08T11:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1653862929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nWould be better to have a method on connman, e.g. `CConnman::SetDesirableServiceFlags` that is then called by peerman.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T14:50:21Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092",
      "id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MpqbM",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1565523628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T14:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nHmm ok, that would avoid locking `cs_main` in the open connections thread. Which is nice.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T22:20:19Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458",
      "id" : 1286427458,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MrVNC",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1566217778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have thought more about this and I'm not so convinced about it anymore.\r\n\r\nThe connection manager class lives on a lower level, and manages only a fraction of the node's information. And this field is strictly linked to the node's overall status. Right now, `HasDesirableServiceFlags()` requires to know the chain sync status.\r\nSo, by placing it inside `CConMan`, we add another level of indirection. Because, most of the time, the peer manager class will call to the `CConMan` setter and subsequently call the getter to utilize it. Using the `CConMan` class mostly as a field container.\r\n\r\nAlso, it would complicate any expansion of the peer services selectivity logic because different processes would require to update the flag stored in `CConMan`. For instance, the node could be seeking to exclusively connect to peers that provide block filters (up to a certain point, then pick other preferences on a case basis), or could want to minimize the number of limited connections based on the chain download state, or if a chain stale state was detected, or could be needing to disallow certain peer types for a certain time etc.\r\n\r\nConsidering this, the responsibility for managing this field seems to fit better inside the peer manager class.\r\n\r\nHappy to hear your thoughts about this. Will keep thinking about it, we can still improve this to not require `cs_main` lock even when it's placed inside the peers manager class.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-08T15:23:38Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613",
      "id" : 1287286613,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585Mum9V",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1567568353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-14T15:09:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1293556312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Because, most of the time, the peer manager class will call to the CConMan setter and subsequently call the getter to utilize it. \r\n\r\nI wasn't saying to make connman the container for this data, I only meant to add a setter to inform connman of the things it needs to perform its job (making connections to desirable nodes). The main container for the flags would still be peerman.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-14T14:37:45Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1293556312",
      "id" : 1293556312,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585NGhpY",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1576991490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-14T14:37:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296335745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The comment (\"shortcut for...\") was helpful for me, any reason to drop it?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T19:23:07Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296335745",
      "id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NRIOB",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1582,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296355296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why stop doing extra block-relay peers in this situation? These aren't attempted during original IBD because we are  expected to be behind the tip. However, in this super-stale situation which should really not happen normally, it seems that they could only help?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T19:44:37Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296355296",
      "id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NRM_g",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296375222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`m_initial_sync_finished` is set using AdjustedTime (see `CanDirectFetch()`) while it's unset using local time. In spite of plans to get rid of AdjustedTime, I  think it would be better to use it here as well, otherwise there could be constant switching back and forth in some situations where the two times differ.\r\n\r\nAlso, why introduce a new magic number of 290, can't we just use `NODE_NETWORK_LIMITED_MIN_BLOCKS` (maybe + 2, if there is a reason for it)?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T20:07:35Z",
      "diff_hunk" : "@@ -1265,14 +1266,21 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+bool PeerManagerImpl::TipMayBeStale(bool& super_stale)\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        super_stale = last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 290};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296375222",
      "id" : 1296375222,
      "line" : 1280,
      "node_id" : "PRRC_kwDOABII585NRR22",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 1280,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 36,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297115636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Was it just outdated already? I'm confused by what NODE_NONE meant here before this change.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T11:57:16Z",
      "diff_hunk" : "@@ -327,12 +327,16 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n  * guaranteed to not change dependent on state - ie they are suitable for\n  * use when describing peers which we know to be desirable, but for which\n  * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297115636",
      "id" : 1297115636,
      "line" : 331,
      "node_id" : "PRRC_kwDOABII585NUGn0",
      "original_commit_id" : "1dbc6cc6b177497c18664bcc08f4d55da21941a6",
      "original_line" : 331,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 24,
      "pull_request_review_id" : 1582453390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T11:57:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297117898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "does `peerServices` refer to the outdated code? Pehraps we should change it here?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T11:59:36Z",
      "diff_hunk" : "@@ -90,6 +90,29 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** This function is used for testing the stale tip eviction logic, see denialofservice_tests.cpp */\n     virtual void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds) = 0;\n+\n+    /**\n+     * Gets the set of service flags which are \"desirable\" for a given peer.\n+     *\n+     * These are the flags which are required for a peer to support for them\n+     * to be \"interesting\" to us, ie for us to wish to use one of our few\n+     * outbound connection slots for or for us to wish to prioritize keeping\n+     * their connection around.\n+     *\n+     * Relevant service flags may be peer- and state-specific in that the\n+     * version of the peer may determine which flags are required (eg in the\n+     * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n+     * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n+     * case NODE_NETWORK_LIMITED suffices).\n+     *\n+     * Thus, generally, avoid calling with peerServices == NODE_NONE, unless",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297117898",
      "id" : 1297117898,
      "line" : 108,
      "node_id" : "PRRC_kwDOABII585NUHLK",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 108,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 19,
      "pull_request_review_id" : 1582457092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T11:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297132683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think they would help with?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T12:13:37Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297132683",
      "id" : 1297132683,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NUKyL",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1582480170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T12:13:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297205559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If for whatever reason our current peers aren't able to send us the blocks to get us out of this situation, maybe trying an additional one will.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T13:14:41Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297205559",
      "id" : 1297205559,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NUck3",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1582597289,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T13:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297413491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297413491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> > Because, most of the time, the peer manager class will call to the CConMan setter and subsequently call the getter to utilize it.\r\n> \r\n> I wasn't saying to make connman the container for this data, I only meant to add a setter to inform connman of the things it needs to perform its job (making connections to desirable nodes). The main container for the flags would still be peerman.\r\n\r\nOk. What I dislike about that approach is that we lose a lot of flexibility.\r\n\r\nThe PeerManager should be able to decide granularly whether to connect to a specific address before ConnMann opens the connection and initiates handshaking etc.\r\nThe node's contextual information and logic required to take the decision of opening a socket to a particular address resides mostly in PeerManager (right now, we only have the stale chain condition, but there could be more). And, by adding another field inside ConnMan, we would be duplicating data (same `desirable_services` field inside PeerManager and ConnMan), which would need to be synchronized and could potentially lead to race conditions.\r\n\r\nI mean, this misalignment could result in ConnMan performing actions that are no longer in line with the latest PeerManager state. For instance, it might create connections to multiple peers with certain service flags, when PeerManager only intended to connect to one peer supporting such service flags. This situation would eventually lead to PeerManager closing the newly created connections when it sends the version message, as these connections are no longer desirable. Which is a waste of resources.\r\n\r\nThus why I think that the callback mechanism suits well here. So PeerManager is able to evaluate each connection request, and avoid executing the connection + handshake when we are going to disconnect the peer anyway.",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T15:47:16Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297413491",
      "id" : 1297413491,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585NVPVz",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1582929778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297413491/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-17T20:15:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297413491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297744944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297744944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Why stop doing extra block-relay peers in this situation?\r\n\r\nBecause, in the stalling scenario, we not only need to progress at the chain level, we might also need to receive new addresses from the network. And block-relay-only connections are limited in that sense. The node rejects addresses coming from them.\r\n\r\n> If for whatever reason our current peers aren't able to send us the blocks to get us out of this situation, maybe trying an additional one will.\r\n\r\nThats basically what we currently do. The stalling behavior triggers the \"try new outbound connection\" functionality. Which instructs ConnMan to create a new full relay connection even when the outbound slots are full.\r\n\r\n....\r\n\r\nWith this, I'm not disagreeing about keeping the extra-block-relay connections enabled. Just thought that they might not be as useful, given that we're already performing the same actions with the \"try new outbound connection\" functionality.",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T20:57:31Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297744944",
      "id" : 1297744944,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NWgQw",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1583483576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297744944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T21:03:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297744944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297791137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297791137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah. Sure for both.\r\nNot sure why I hardcoded the number..",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T21:59:04Z",
      "diff_hunk" : "@@ -1265,14 +1266,21 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+bool PeerManagerImpl::TipMayBeStale(bool& super_stale)\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        super_stale = last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 290};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297791137",
      "id" : 1297791137,
      "in_reply_to_id" : 1296375222,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NWrih",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 1280,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1583552709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297791137/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T21:59:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297791137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297796093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297796093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Was it just outdated already? I'm confused by what NODE_NONE meant here before this change.\r\n\r\nIt was talking about the input `ServiceFlags`. Not the `GetDesirableServiceFlags()` output.\r\n\r\nBasically, we expect to have all the hardcoded seeds supporting `NODE_NETWORK` and `NODE_WITNESS`.\r\n",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T22:07:25Z",
      "diff_hunk" : "@@ -327,12 +327,16 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n  * guaranteed to not change dependent on state - ie they are suitable for\n  * use when describing peers which we know to be desirable, but for which\n  * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297796093",
      "id" : 1297796093,
      "in_reply_to_id" : 1297115636,
      "line" : 331,
      "node_id" : "PRRC_kwDOABII585NWsv9",
      "original_commit_id" : "1dbc6cc6b177497c18664bcc08f4d55da21941a6",
      "original_line" : 331,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 24,
      "pull_request_review_id" : 1583559886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297796093/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T22:07:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297796093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297797152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297797152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah sure.",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T22:09:08Z",
      "diff_hunk" : "@@ -90,6 +90,29 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** This function is used for testing the stale tip eviction logic, see denialofservice_tests.cpp */\n     virtual void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds) = 0;\n+\n+    /**\n+     * Gets the set of service flags which are \"desirable\" for a given peer.\n+     *\n+     * These are the flags which are required for a peer to support for them\n+     * to be \"interesting\" to us, ie for us to wish to use one of our few\n+     * outbound connection slots for or for us to wish to prioritize keeping\n+     * their connection around.\n+     *\n+     * Relevant service flags may be peer- and state-specific in that the\n+     * version of the peer may determine which flags are required (eg in the\n+     * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n+     * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n+     * case NODE_NETWORK_LIMITED suffices).\n+     *\n+     * Thus, generally, avoid calling with peerServices == NODE_NONE, unless",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297797152",
      "id" : 1297797152,
      "in_reply_to_id" : 1297117898,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NWtAg",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 108,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1583561365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297797152/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T22:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297797152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297802187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297802187"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The comment (\"shortcut for...\") was helpful for me, any reason to drop it?\r\n\r\nThat was because the method was moved to the net interface ([see](https://github.com/bitcoin/bitcoin/blob/1428b7f4e8c648fdc68ba5744d640d120d5d78eb/src/net.h#L673)). And there, this is no longer a shortcut. It is the only available method. ",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-17T22:17:19Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297802187",
      "id" : 1297802187,
      "in_reply_to_id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NWuPL",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1590,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1583568676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297802187/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T22:17:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297802187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298341327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298341327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In that case i'd rather not `StopExtraBlockRelayPeers`. Instead we can leave a comment regarding the \"same actions\", although I'm not sure what's the appropriate place for it.",
      "commit_id" : "26a9bb4526f3e1a17581e0dea7befa7be4de9817",
      "created_at" : "2023-08-18T11:25:31Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298341327",
      "id" : 1298341327,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NYx3P",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1584395102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298341327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T11:25:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298341327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298677448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298677448"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I interpreted the comment as explaining the not-so-trivial bit-operator logic:\r\n`!(GetDesirableServiceFlags(services) & (~services));` \r\nis still a shortcut for the longer, but more understandable alternative\r\n`services & GetDesirableServiceFlags(services)) == GetDesirableServiceFlags(services)`\r\nno matter where the function is situated.",
      "commit_id" : "8af5f2535b366f8c666a1ce18ced4594c6267321",
      "created_at" : "2023-08-18T17:09:23Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298677448",
      "id" : 1298677448,
      "in_reply_to_id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NaD7I",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1590,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1584926434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298677448/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T17:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298677448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298685145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298685145"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok. For that, we can locate the comment in the implementation (above the no-so-trivial logic). So it's clear what that single line does. I just don't think that is good to place it at the API level. Where `GetDesirableServiceFlags` doesn't exist and `HasDesirableServiceFlags()` could be implemented in different manners.\r\n\r\nSide note:\r\nIf the line is confusing, instead of adding the comment, we could just replace it by the more understandable one. Isn't something that will really affect anything.",
      "commit_id" : "8af5f2535b366f8c666a1ce18ced4594c6267321",
      "created_at" : "2023-08-18T17:19:07Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298685145",
      "id" : 1298685145,
      "in_reply_to_id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NaFzZ",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1590,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1584938489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298685145/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T17:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298685145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298718974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298718974"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Both options are fine with me. I will admit that I'm not as fluent/quick reading code with bitwise operators as I should be, but then again if even the original author of this code got it wrong at first (https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144391264) it's probably not just me.",
      "commit_id" : "8af5f2535b366f8c666a1ce18ced4594c6267321",
      "created_at" : "2023-08-18T18:01:24Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298718974",
      "id" : 1298718974,
      "in_reply_to_id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NaOD-",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1590,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1584993083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298718974/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T18:01:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298718974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298723753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298723753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think there's no harm in keeping the `ExtraBlockRelayPeers` logic:\r\nWhile it's true that we would also do extra full outbound connections in this case, those have priority in `ThreadOpenConnections` over the block-relay-only ones, so trying another block-relay only might not have a super high chance of helping, but it still is another try and if there is no downside to it (I can't see any), I don't see why we should actively add logic to stop these.",
      "commit_id" : "8af5f2535b366f8c666a1ce18ced4594c6267321",
      "created_at" : "2023-08-18T18:07:28Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298723753",
      "id" : 1298723753,
      "in_reply_to_id" : 1296355296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NaPOp",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5251,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1585002068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298723753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T18:07:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298723753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298732036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298732036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, agree",
      "commit_id" : "8af5f2535b366f8c666a1ce18ced4594c6267321",
      "created_at" : "2023-08-18T18:17:29Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1298732036",
      "id" : 1298732036,
      "in_reply_to_id" : 1296355296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NaRQE",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5251,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1585012519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298732036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-18T18:17:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298732036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "per convo, cc @vasild ",
      "created_at" : "2023-09-20T13:59:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1727793191",
      "id" : 1727793191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585m_Agn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727793191/reactions"
      },
      "updated_at" : "2023-09-20T13:59:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727793191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-19T18:27:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1771505385",
      "id" : 1771505385,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585plwbp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771505385/reactions"
      },
      "updated_at" : "2023-10-19T18:27:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771505385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1374426573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374426573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7c20e65b2880a23d753b3f05fd28994353b3049d\r\n\r\n`the same nodes` always takes non-negligible time for me to understand... I would suggest making it less ambiguous, e.g. \"nodes with desired service flags (compatible with our new flags)\"",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-27T11:18:46Z",
      "diff_hunk" : "@@ -330,12 +330,16 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n  * guaranteed to not change dependent on state - ie they are suitable for\n  * use when describing peers which we know to be desirable, but for which\n  * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py\n- * should be updated appropriately to filter for the same nodes.\n  */\n ServiceFlags GetDesirableServiceFlags(ServiceFlags services);\n \n+/**\n+ * State independent service flags.\n+ * If the return value is changed, contrib/seeds/makeseeds.py\n+ * should be updated appropriately to filter for the same nodes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1374426573",
      "id" : 1374426573,
      "line" : 316,
      "node_id" : "PRRC_kwDOABII585R7BXN",
      "original_commit_id" : "7c20e65b2880a23d753b3f05fd28994353b3049d",
      "original_line" : 339,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 27,
      "pull_request_review_id" : 1701549241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374426573/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T12:53:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374426573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375473315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375473315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The implementation could be moved here and this made `constexpr`?\r\n```suggestion\r\nServiceFlags StatelessServiceFlags();\r\n```",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T16:57:22Z",
      "diff_hunk" : "@@ -311,43 +311,11 @@ enum ServiceFlags : uint64_t {\n std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n \n /**\n- * Gets the set of service flags which are \"desirable\" for a given peer.\n- *\n- * These are the flags which are required for a peer to support for them\n- * to be \"interesting\" to us, ie for us to wish to use one of our few\n- * outbound connection slots for or for us to wish to prioritize keeping\n- * their connection around.\n- *\n- * Relevant service flags may be peer- and state-specific in that the\n- * version of the peer may determine which flags are required (eg in the\n- * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n- * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n- * case NODE_NETWORK_LIMITED suffices).\n- *\n- * Thus, generally, avoid calling with peerServices == NODE_NONE, unless\n- * state-specific flags must absolutely be avoided. When called with\n- * peerServices == NODE_NONE, the returned desirable service flags are\n- * guaranteed to not change dependent on state - ie they are suitable for\n- * use when describing peers which we know to be desirable, but for which\n- * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py\n+ * State independent service flags.\n+ * If the return value is changed, contrib/seeds/makeseeds.py\n  * should be updated appropriately to filter for the same nodes.\n  */\n-ServiceFlags GetDesirableServiceFlags(ServiceFlags services);\n-\n-/** Set the current IBD status in order to figure out the desirable service flags */\n-void SetServiceFlagsIBDCache(bool status);\n-\n-/**\n- * A shortcut for (services & GetDesirableServiceFlags(services))\n- * == GetDesirableServiceFlags(services), ie determines whether the given\n- * set of service flags are sufficient for a peer to be \"relevant\".\n- */\n-static inline bool HasAllDesirableServiceFlags(ServiceFlags services)\n-{\n-    return !(GetDesirableServiceFlags(services) & (~services));\n-}\n+ServiceFlags StatelessServicesFlags();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375473315",
      "id" : 1375473315,
      "line" : 318,
      "node_id" : "PRRC_kwDOABII585R_A6j",
      "original_commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "original_line" : 318,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 43,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375473315/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375473315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375475833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375475833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why rename from `HasAllDesirableServiceFlags`? The `HasAll` is more descriptive. It is now ambiguous whether this returns `true` if the `ServiceFlags` has some number of desirable service flags or strictly all of them.",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T17:12:38Z",
      "diff_hunk" : "@@ -1642,6 +1644,21 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375475833",
      "id" : 1375475833,
      "line" : 1655,
      "node_id" : "PRRC_kwDOABII585R_Bh5",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 1647,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375475833/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375475833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375477984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375477984"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could be a `const` function?",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T17:23:53Z",
      "diff_hunk" : "@@ -110,6 +110,29 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** This function is used for testing the stale tip eviction logic, see denialofservice_tests.cpp */\n     virtual void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds) = 0;\n+\n+    /**\n+     * Gets the set of service flags which are \"desirable\" for a given peer.\n+     *\n+     * These are the flags which are required for a peer to support for them\n+     * to be \"interesting\" to us, ie for us to wish to use one of our few\n+     * outbound connection slots for or for us to wish to prioritize keeping\n+     * their connection around.\n+     *\n+     * Relevant service flags may be peer- and state-specific in that the\n+     * version of the peer may determine which flags are required (eg in the\n+     * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n+     * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n+     * case NODE_NETWORK_LIMITED suffices).\n+     *\n+     * Thus, generally, avoid calling with 'services' == NODE_NONE, unless\n+     * state-specific flags must absolutely be avoided. When called with\n+     * 'services' == NODE_NONE, the returned desirable service flags are\n+     * guaranteed to not change dependent on state - ie they are suitable for\n+     * use when describing peers which we know to be desirable, but for which\n+     * we do not have a confirmed set of service flags.\n+    */\n+    virtual ServiceFlags GetDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375477984",
      "id" : 1375477984,
      "line" : 135,
      "node_id" : "PRRC_kwDOABII585R_CDg",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 135,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 26,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375477984/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375477984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375478210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375478210"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could be a `const` function?",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T17:25:15Z",
      "diff_hunk" : "@@ -1012,6 +1012,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375478210",
      "id" : 1375478210,
      "line" : 1019,
      "node_id" : "PRRC_kwDOABII585R_CHC",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 1019,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375478210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375478210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375481949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375481949"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `super_stale` is not very descriptive. I also think this pattern of returning extra data from this function in this way is a little confusing. This could be made more descriptive by declaring a new enum and using it as the return value. eg\r\n```\r\nenum Staleness {\r\n    NotStale,\r\n    Stale,\r\n    StalePastNetworkLimited,\r\n};\r\n```",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T17:51:19Z",
      "diff_hunk" : "@@ -892,7 +893,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    bool TipMayBeStale(bool& super_stale) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375481949",
      "id" : 1375481949,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585R_DBd",
      "original_commit_id" : "cc5f276fa2acbd13d044fbf5e7dfff46d296b898",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375481949/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375481949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375482009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375482009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is relaxed ordering ok for this? We don't need to call `m_initial_sync_finished.load()`?",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-29T17:51:50Z",
      "diff_hunk" : "@@ -1661,7 +1661,6 @@ bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)\n ServiceFlags PeerManagerImpl::GetDesirableServiceFlags(ServiceFlags services)\n {\n     if (services & NODE_NETWORK_LIMITED) {\n-        LOCK(::cs_main);\n         if (m_initial_sync_finished) return ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375482009",
      "id" : 1375482009,
      "line" : 1664,
      "node_id" : "PRRC_kwDOABII585R_DCZ",
      "original_commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "original_line" : 1664,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1702994944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375482009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-29T17:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375482009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375843721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375843721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: add `Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3)` so that stale/super-stale makes sense here.",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-30T08:31:39Z",
      "diff_hunk" : "@@ -1294,14 +1295,21 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+bool PeerManagerImpl::TipMayBeStale(bool& super_stale)\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        super_stale = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1375843721",
      "id" : 1375843721,
      "line" : 1309,
      "node_id" : "PRRC_kwDOABII585SAbWJ",
      "original_commit_id" : "cc5f276fa2acbd13d044fbf5e7dfff46d296b898",
      "original_line" : 1309,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 54,
      "pull_request_review_id" : 1701549241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375843721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T12:53:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1375843721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376165998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376165998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7c20e65b2880a23d753b3f05fd28994353b3049d\r\n\r\nWhile you decouple the two, do you mean to make them independent from each other? It seems to me they will always be roughly the same. I agree with the goal of the PR, just not sure about this approach.",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-30T12:53:01Z",
      "diff_hunk" : "@@ -134,6 +134,11 @@ ServiceFlags GetDesirableServiceFlags(ServiceFlags services) {\n     return ServiceFlags(NODE_NETWORK | NODE_WITNESS);\n }\n \n+ServiceFlags StatelessServicesFlags()\n+{\n+    return ServiceFlags(NODE_NETWORK | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376165998",
      "id" : 1376165998,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585SBqBu",
      "original_commit_id" : "7c20e65b2880a23d753b3f05fd28994353b3049d",
      "original_line" : 139,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/protocol.cpp",
      "position" : 20,
      "pull_request_review_id" : 1701549241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376165998/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T12:53:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376165998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376733399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376733399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Why rename from `HasAllDesirableServiceFlags`? The `HasAll` is more descriptive. It is now ambiguous whether this returns `true` if the `ServiceFlags` has some number of desirable service flags or strictly all of them.\r\n\r\nI don't think the name is good for the PeerManager-Connman interface. What \"HasAll\" means for `NetEventsInterface`? There, it should be something like `bool CanConnectTo(services)` or something similar.\r\n\r\nStill, I'm not really happy with the interface at this point. No problem on renaming it back.",
      "commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "created_at" : "2023-10-30T19:52:26Z",
      "diff_hunk" : "@@ -1642,6 +1644,21 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376733399",
      "id" : 1376733399,
      "in_reply_to_id" : 1375475833,
      "line" : 1655,
      "node_id" : "PRRC_kwDOABII585SD0jX",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 1647,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 1704958214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376733399/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T19:52:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376733399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376794129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376794129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why relaxed? look at the [operator](https://en.cppreference.com/w/cpp/atomic/atomic/operator_T). Is equivalent to `load`, which uses [std::memory_order_seq_cst](http://en.cppreference.com/w/cpp/atomic/memory_order).",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T20:59:16Z",
      "diff_hunk" : "@@ -1661,7 +1661,6 @@ bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)\n ServiceFlags PeerManagerImpl::GetDesirableServiceFlags(ServiceFlags services)\n {\n     if (services & NODE_NETWORK_LIMITED) {\n-        LOCK(::cs_main);\n         if (m_initial_sync_finished) return ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376794129",
      "id" : 1376794129,
      "in_reply_to_id" : 1375482009,
      "line" : 1671,
      "node_id" : "PRRC_kwDOABII585SEDYR",
      "original_commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "original_line" : 1671,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 81,
      "pull_request_review_id" : 1705055908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376794129/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T20:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376794129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376837397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376837397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> While you decouple the two, do you mean to make them independent from each other? It seems to me they will always be roughly the same. I agree with the goal of the PR, just not sure about this approach.\r\n\r\nYeah. The goal is to make them independent from each other so the peer manager runtime logic doesn't affect the hardcoded seeds. They are built from another source and depend on the way we externally collect them. These peers are stored in db with the stateless service flags, and would be an error to store them with a different one (they might not support the service).",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T21:48:42Z",
      "diff_hunk" : "@@ -134,6 +134,11 @@ ServiceFlags GetDesirableServiceFlags(ServiceFlags services) {\n     return ServiceFlags(NODE_NETWORK | NODE_WITNESS);\n }\n \n+ServiceFlags StatelessServicesFlags()\n+{\n+    return ServiceFlags(NODE_NETWORK | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376837397",
      "id" : 1376837397,
      "in_reply_to_id" : 1376165998,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEN8V",
      "original_commit_id" : "7c20e65b2880a23d753b3f05fd28994353b3049d",
      "original_line" : 139,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/protocol.cpp",
      "position" : null,
      "pull_request_review_id" : 1705128417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376837397/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T21:48:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376837397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:10Z",
      "diff_hunk" : "@@ -311,43 +311,11 @@ enum ServiceFlags : uint64_t {\n std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n \n /**\n- * Gets the set of service flags which are \"desirable\" for a given peer.\n- *\n- * These are the flags which are required for a peer to support for them\n- * to be \"interesting\" to us, ie for us to wish to use one of our few\n- * outbound connection slots for or for us to wish to prioritize keeping\n- * their connection around.\n- *\n- * Relevant service flags may be peer- and state-specific in that the\n- * version of the peer may determine which flags are required (eg in the\n- * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n- * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n- * case NODE_NETWORK_LIMITED suffices).\n- *\n- * Thus, generally, avoid calling with peerServices == NODE_NONE, unless\n- * state-specific flags must absolutely be avoided. When called with\n- * peerServices == NODE_NONE, the returned desirable service flags are\n- * guaranteed to not change dependent on state - ie they are suitable for\n- * use when describing peers which we know to be desirable, but for which\n- * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py\n+ * State independent service flags.\n+ * If the return value is changed, contrib/seeds/makeseeds.py\n  * should be updated appropriately to filter for the same nodes.\n  */\n-ServiceFlags GetDesirableServiceFlags(ServiceFlags services);\n-\n-/** Set the current IBD status in order to figure out the desirable service flags */\n-void SetServiceFlagsIBDCache(bool status);\n-\n-/**\n- * A shortcut for (services & GetDesirableServiceFlags(services))\n- * == GetDesirableServiceFlags(services), ie determines whether the given\n- * set of service flags are sufficient for a peer to be \"relevant\".\n- */\n-static inline bool HasAllDesirableServiceFlags(ServiceFlags services)\n-{\n-    return !(GetDesirableServiceFlags(services) & (~services));\n-}\n+ServiceFlags StatelessServicesFlags();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845662",
      "id" : 1376845662,
      "in_reply_to_id" : 1375473315,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEP9e",
      "original_commit_id" : "893c541dce938aaa210785df53a5841c5e90d924",
      "original_line" : 318,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 1705142132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845719"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:15Z",
      "diff_hunk" : "@@ -110,6 +110,29 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** This function is used for testing the stale tip eviction logic, see denialofservice_tests.cpp */\n     virtual void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds) = 0;\n+\n+    /**\n+     * Gets the set of service flags which are \"desirable\" for a given peer.\n+     *\n+     * These are the flags which are required for a peer to support for them\n+     * to be \"interesting\" to us, ie for us to wish to use one of our few\n+     * outbound connection slots for or for us to wish to prioritize keeping\n+     * their connection around.\n+     *\n+     * Relevant service flags may be peer- and state-specific in that the\n+     * version of the peer may determine which flags are required (eg in the\n+     * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n+     * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n+     * case NODE_NETWORK_LIMITED suffices).\n+     *\n+     * Thus, generally, avoid calling with 'services' == NODE_NONE, unless\n+     * state-specific flags must absolutely be avoided. When called with\n+     * 'services' == NODE_NONE, the returned desirable service flags are\n+     * guaranteed to not change dependent on state - ie they are suitable for\n+     * use when describing peers which we know to be desirable, but for which\n+     * we do not have a confirmed set of service flags.\n+    */\n+    virtual ServiceFlags GetDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845719",
      "id" : 1376845719,
      "in_reply_to_id" : 1375477984,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEP-X",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 135,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1705142221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845719/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:18Z",
      "diff_hunk" : "@@ -1012,6 +1012,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845755",
      "id" : 1376845755,
      "in_reply_to_id" : 1375478210,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEP-7",
      "original_commit_id" : "3c895206cbff7a45d467878caa19aef8bd3aef4e",
      "original_line" : 1019,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1705142273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845755/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, better. Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:37Z",
      "diff_hunk" : "@@ -892,7 +893,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    bool TipMayBeStale(bool& super_stale) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376845963",
      "id" : 1376845963,
      "in_reply_to_id" : 1375481949,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEQCL",
      "original_commit_id" : "cc5f276fa2acbd13d044fbf5e7dfff46d296b898",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1705142584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845963/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376845963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376846014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846014"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:42Z",
      "diff_hunk" : "@@ -330,12 +330,16 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n  * guaranteed to not change dependent on state - ie they are suitable for\n  * use when describing peers which we know to be desirable, but for which\n  * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py\n- * should be updated appropriately to filter for the same nodes.\n  */\n ServiceFlags GetDesirableServiceFlags(ServiceFlags services);\n \n+/**\n+ * State independent service flags.\n+ * If the return value is changed, contrib/seeds/makeseeds.py\n+ * should be updated appropriately to filter for the same nodes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376846014",
      "id" : 1376846014,
      "in_reply_to_id" : 1374426573,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEQC-",
      "original_commit_id" : "7c20e65b2880a23d753b3f05fd28994353b3049d",
      "original_line" : 339,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 1705142677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376846059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T22:00:47Z",
      "diff_hunk" : "@@ -1294,14 +1295,21 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+bool PeerManagerImpl::TipMayBeStale(bool& super_stale)\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        super_stale = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376846059",
      "id" : 1376846059,
      "in_reply_to_id" : 1375843721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SEQDr",
      "original_commit_id" : "cc5f276fa2acbd13d044fbf5e7dfff46d296b898",
      "original_line" : 1309,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1705142752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846059/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376846059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376889771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376889771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we return `StatelessServiceFlags()` here instead?",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-30T23:08:47Z",
      "diff_hunk" : "@@ -1642,6 +1659,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasAllDesirableServiceFlags(ServiceFlags services) const\n+{\n+    // Shortcut for (services & GetDesirableServiceFlags(services)) == GetDesirableServiceFlags(services)\n+    return !(GetDesirableServiceFlags(services) & (~services));\n+}\n+\n+ServiceFlags PeerManagerImpl::GetDesirableServiceFlags(ServiceFlags services) const\n+{\n+    if (services & NODE_NETWORK_LIMITED) {\n+        if (m_initial_sync_finished) return ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n+    }\n+    return ServiceFlags(NODE_NETWORK | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376889771",
      "id" : 1376889771,
      "line" : 1673,
      "node_id" : "PRRC_kwDOABII585SEaur",
      "original_commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "original_line" : 1673,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 1705210202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376889771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-30T23:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1376889771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377164244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377164244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah this what causes my confusion [here](https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1376837397) as well. I think the author means to use `StatelessServiceFlags` only for seed peers. In that case, i'd probably say that explicitly in the function's name. Like `SeedsServiceFlags`. Then, a comment saying something like `these flags should probably be in sync with GetDesirableServiceFlags, but not strictly`.",
      "commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "created_at" : "2023-10-31T07:36:53Z",
      "diff_hunk" : "@@ -1642,6 +1659,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasAllDesirableServiceFlags(ServiceFlags services) const\n+{\n+    // Shortcut for (services & GetDesirableServiceFlags(services)) == GetDesirableServiceFlags(services)\n+    return !(GetDesirableServiceFlags(services) & (~services));\n+}\n+\n+ServiceFlags PeerManagerImpl::GetDesirableServiceFlags(ServiceFlags services) const\n+{\n+    if (services & NODE_NETWORK_LIMITED) {\n+        if (m_initial_sync_finished) return ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n+    }\n+    return ServiceFlags(NODE_NETWORK | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377164244",
      "id" : 1377164244,
      "in_reply_to_id" : 1376889771,
      "line" : 1673,
      "node_id" : "PRRC_kwDOABII585SFdvU",
      "original_commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "original_line" : 1673,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 1705619635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377164244/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T07:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377164244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377694801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377694801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In that case, i'd probably say that explicitly in the function's name. Like SeedsServiceFlags.\r\n\r\nSounds good. Will rename it to `SeedsServiceFlags`.\r\nI was thinking we would use this function for other cases in the future, but agree that this can be simplified for now.\r\n\r\n> Then, a comment saying something like these flags should probably be in sync with GetDesirableServiceFlags, but not strictly.\r\n\r\nI'm not sure about this comment. We could have a much more complex logic at the PeerManager level, adaptable based on the chain context and/or the user's configurations. For instance, the user could be running a node whose preferred connections are ones supporting `NODE_P2P_V2` or `NODE_COMPACT_FILTERS` (because the sync mechanism is BIP157) or some other service flag in the future.\r\n\r\n\r\n",
      "commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "created_at" : "2023-10-31T14:36:35Z",
      "diff_hunk" : "@@ -1642,6 +1659,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasAllDesirableServiceFlags(ServiceFlags services) const\n+{\n+    // Shortcut for (services & GetDesirableServiceFlags(services)) == GetDesirableServiceFlags(services)\n+    return !(GetDesirableServiceFlags(services) & (~services));\n+}\n+\n+ServiceFlags PeerManagerImpl::GetDesirableServiceFlags(ServiceFlags services) const\n+{\n+    if (services & NODE_NETWORK_LIMITED) {\n+        if (m_initial_sync_finished) return ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n+    }\n+    return ServiceFlags(NODE_NETWORK | NODE_WITNESS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377694801",
      "id" : 1377694801,
      "in_reply_to_id" : 1376889771,
      "line" : 1679,
      "node_id" : "PRRC_kwDOABII585SHfRR",
      "original_commit_id" : "bf3ce4a9ae88910ef33be61980be42c84fc812af",
      "original_line" : 1679,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 102,
      "pull_request_review_id" : 1706479807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377694801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T14:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377694801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377784027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377784027"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we first check that we don't go back to ibd if we are stale but at the threshold, then we do go back to ibd once we step over the threshold?",
      "commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "created_at" : "2023-10-31T15:31:57Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/miner.h>\n+#include <net_processing.h>\n+#include <pow.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(peerman_tests, RegTestingSetup)\n+\n+// Verifying when network-limited peer connections are desirable based on the node's IBD status\n+BOOST_AUTO_TEST_CASE(connections_desirable_service_flags)\n+{\n+    std::unique_ptr<PeerManager> peerman = PeerManager::make(*m_node.connman, *m_node.addrman, nullptr, *m_node.chainman, *m_node.mempool, {});\n+\n+    // Check we start connecting to full nodes\n+    ServiceFlags peer_flags{NODE_WITNESS | NODE_NETWORK_LIMITED};\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we accept network limited peers when we are out of ibd\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Now check we can go back to ibd if we are further than the limited peers threshold (NODE_NETWORK_LIMITED_MIN_BLOCKS)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377784027",
      "id" : 1377784027,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII585SH1Db",
      "original_commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "original_line" : 30,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/peerman_tests.cpp",
      "position" : 30,
      "pull_request_review_id" : 1706626162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377784027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T15:31:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377784027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377793447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377793447"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The 3 lines below are the same as lines 33-35, except for the +11min. It's unclear to me from this comment what the 11min is doing and why this is different from what we are doing before. Can this maybe be explained better?",
      "commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "created_at" : "2023-10-31T15:37:42Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/miner.h>\n+#include <net_processing.h>\n+#include <pow.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(peerman_tests, RegTestingSetup)\n+\n+// Verifying when network-limited peer connections are desirable based on the node's IBD status\n+BOOST_AUTO_TEST_CASE(connections_desirable_service_flags)\n+{\n+    std::unique_ptr<PeerManager> peerman = PeerManager::make(*m_node.connman, *m_node.addrman, nullptr, *m_node.chainman, *m_node.mempool, {});\n+\n+    // Check we start connecting to full nodes\n+    ServiceFlags peer_flags{NODE_WITNESS | NODE_NETWORK_LIMITED};\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we accept network limited peers when we are out of ibd\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Now check we can go back to ibd if we are further than the limited peers threshold (NODE_NETWORK_LIMITED_MIN_BLOCKS)\n+    auto consensus = m_node.chainman->GetParams().GetConsensus();\n+    auto time_last_stale = GetTime<std::chrono::seconds>() + std::chrono::seconds{consensus.nPowTargetSpacing * 300};\n+    SetMockTime(time_last_stale);\n+    peerman->CheckForStaleTipAndEvictPeers();\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we can get back out of ibd again\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Push the chain forward to surpass the 'STALE_CHECK_INTERVAL' (time between 'CheckForStaleTipAndEvictPeers' calls)\n+    // to move the \"initial sync finished\" state flag back to false (back to IBD state once more).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1377793447",
      "id" : 1377793447,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585SH3Wn",
      "original_commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/test/peerman_tests.cpp",
      "position" : 43,
      "pull_request_review_id" : 1706640450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377793447/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T15:38:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377793447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378086895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378086895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah sure, good idea.",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-10-31T19:37:01Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/miner.h>\n+#include <net_processing.h>\n+#include <pow.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(peerman_tests, RegTestingSetup)\n+\n+// Verifying when network-limited peer connections are desirable based on the node's IBD status\n+BOOST_AUTO_TEST_CASE(connections_desirable_service_flags)\n+{\n+    std::unique_ptr<PeerManager> peerman = PeerManager::make(*m_node.connman, *m_node.addrman, nullptr, *m_node.chainman, *m_node.mempool, {});\n+\n+    // Check we start connecting to full nodes\n+    ServiceFlags peer_flags{NODE_WITNESS | NODE_NETWORK_LIMITED};\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we accept network limited peers when we are out of ibd\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Now check we can go back to ibd if we are further than the limited peers threshold (NODE_NETWORK_LIMITED_MIN_BLOCKS)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378086895",
      "id" : 1378086895,
      "in_reply_to_id" : 1377784027,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SI-_v",
      "original_commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "original_line" : 30,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/test/peerman_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1707112442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378086895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T19:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378086895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378088543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378088543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. This is because we execute the stale check every 10 min, so needed to push the last stale check time forward.\r\nWill re-order the test checks so this becomes clearer.",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-10-31T19:39:03Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/miner.h>\n+#include <net_processing.h>\n+#include <pow.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(peerman_tests, RegTestingSetup)\n+\n+// Verifying when network-limited peer connections are desirable based on the node's IBD status\n+BOOST_AUTO_TEST_CASE(connections_desirable_service_flags)\n+{\n+    std::unique_ptr<PeerManager> peerman = PeerManager::make(*m_node.connman, *m_node.addrman, nullptr, *m_node.chainman, *m_node.mempool, {});\n+\n+    // Check we start connecting to full nodes\n+    ServiceFlags peer_flags{NODE_WITNESS | NODE_NETWORK_LIMITED};\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we accept network limited peers when we are out of ibd\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Now check we can go back to ibd if we are further than the limited peers threshold (NODE_NETWORK_LIMITED_MIN_BLOCKS)\n+    auto consensus = m_node.chainman->GetParams().GetConsensus();\n+    auto time_last_stale = GetTime<std::chrono::seconds>() + std::chrono::seconds{consensus.nPowTargetSpacing * 300};\n+    SetMockTime(time_last_stale);\n+    peerman->CheckForStaleTipAndEvictPeers();\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n+\n+    // Check we can get back out of ibd again\n+    SetMockTime(WITH_LOCK(::cs_main, return m_node.chainman->ActiveChain().Tip()->GetBlockTime())); // time to tip time so we are out of ibd\n+    peerman->CheckForStaleTipAndEvictPeers();  // Update ibd state\n+    BOOST_CHECK(peerman->GetDesirableServiceFlags(peer_flags) == ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS));\n+\n+    // Push the chain forward to surpass the 'STALE_CHECK_INTERVAL' (time between 'CheckForStaleTipAndEvictPeers' calls)\n+    // to move the \"initial sync finished\" state flag back to false (back to IBD state once more).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378088543",
      "id" : 1378088543,
      "in_reply_to_id" : 1377793447,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SI_Zf",
      "original_commit_id" : "3a56fe6dbb35ba809cd9611395f28d8fdd85df73",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/test/peerman_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1707115293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378088543/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T19:39:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378088543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378500641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378500641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69\r\n\r\nIs it still fair to call this state *initial* block download?",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-11-01T08:08:22Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378500641",
      "id" : 1378500641,
      "line" : 1317,
      "node_id" : "PRRC_kwDOABII585SKkAh",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 1707743315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378500641/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T08:18:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378500641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378798478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378798478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's just me trying to save few characters. Will rename it to `past_net_limited`.",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-11-01T13:23:37Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378798478",
      "id" : 1378798478,
      "in_reply_to_id" : 1378500641,
      "line" : 1317,
      "node_id" : "PRRC_kwDOABII585SLsuO",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 1708216770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378798478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T13:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378798478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378806543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378806543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to use adjusted time, when the tip update time is recorded as NodeClock?",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-11-01T13:30:54Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378806543",
      "id" : 1378806543,
      "in_reply_to_id" : 1378500641,
      "line" : 1317,
      "node_id" : "PRRC_kwDOABII585SLusP",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 1708229887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378806543/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T13:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378806543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378842023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378842023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Any reason to use adjusted time, when the tip update time is recorded as NodeClock?\r\n\r\nGood point. The idea was to considerate the peers' time too, so the node has less chances of requesting a block at the limited peers threshold that does no longer exist in the other side. In other words, if the peer's time deviates slightly from the node time, the peer could have pruned the block at the verge of the threshold.\r\nBut we could achieve the same outcome by reducing the window size by one or two blocks. Which does not require to mix `GetTime` and `GetAdjustedTime` usages.",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-11-01T14:01:09Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378842023",
      "id" : 1378842023,
      "in_reply_to_id" : 1378500641,
      "line" : 1317,
      "node_id" : "PRRC_kwDOABII585SL3Wn",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 1708287474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378842023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T14:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378842023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378907084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378907084"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In other words, if the peer's time deviates slightly from the node time\r\n\r\nI don't think `GetAdjustedTime` offers this precision even. Also, it is not a per-peer offset, but a global one.",
      "commit_id" : "78e10967424731f00dd8f2af342ebe378aef234f",
      "created_at" : "2023-11-01T14:52:26Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1378907084",
      "id" : 1378907084,
      "in_reply_to_id" : 1378500641,
      "line" : 1317,
      "node_id" : "PRRC_kwDOABII585SMHPM",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 1708392307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378907084/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T14:52:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378907084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1380107969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380107969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> > In other words, if the peer's time deviates slightly from the node time\r\n> \r\n> I don't think `GetAdjustedTime` offers this precision even. Also, it is not a per-peer offset, but a global one.\r\n\r\nYeah I know. I just thought it was better to do that than nothing.\r\nStill, I'm quite sure we cannot trigger the edge case I mentioned above only using core vanilla alone. The pruning process isn't that aggressive for the time being. It might arise across different implementations but we can revisit it in a follow-up, the limited peers connection window can be easily shortened without any problem.",
      "commit_id" : "5628ac55be42c5450c6817ba8dcfe463ceda32a9",
      "created_at" : "2023-11-02T13:29:05Z",
      "diff_hunk" : "@@ -1294,19 +1302,32 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+PeerManagerImpl::Staleness PeerManagerImpl::TipMayBeStale()\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        Assume(NODE_NETWORK_LIMITED_MIN_BLOCKS > 3);\n+        bool in_ibd = NodeSeconds{last_update_time} < GetAdjustedTime() - std::chrono::seconds{consensusParams.nPowTargetSpacing * NODE_NETWORK_LIMITED_MIN_BLOCKS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1380107969",
      "id" : 1380107969,
      "in_reply_to_id" : 1378500641,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SQsbB",
      "original_commit_id" : "636d927c4a9cd5cbf4d0c22e1c25dc44ecaf7a69",
      "original_line" : 1317,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1710249269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380107969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T13:29:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380107969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 5628ac55be42c5450c6817ba8dcfe463ceda32a9",
      "created_at" : "2023-11-05T15:47:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1793773276",
      "id" : 1793773276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585q6s7c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793773276/reactions"
      },
      "updated_at" : "2023-11-05T15:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793773276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384547974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384547974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99\r\n\r\nnit: this enum could be better... First, `StalePast` also qualifies as `Stale` (just english-wise). Second, it's a negation (non-synced).",
      "commit_id" : "5628ac55be42c5450c6817ba8dcfe463ceda32a9",
      "created_at" : "2023-11-07T08:31:58Z",
      "diff_hunk" : "@@ -892,7 +893,13 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    enum class Staleness {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384547974",
      "id" : 1384547974,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585ShoaG",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 1717094661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384547974/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T08:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384547974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384550193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384550193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm wondering, does it even make sense to keep such flag at this point? What it would take to adjust all code to going back-and-forth w.r.t. superstale?",
      "commit_id" : "5628ac55be42c5450c6817ba8dcfe463ceda32a9",
      "created_at" : "2023-11-07T08:33:52Z",
      "diff_hunk" : "@@ -2057,6 +2078,16 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\n {\n     SetBestHeight(pindexNew->nHeight);\n \n+    // Update internal sync state.\n+    // Avoid using 'fInitialDownload' alone since the flag currently cannot go backwards after passing IBD once.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384550193",
      "id" : 1384550193,
      "line" : 2081,
      "node_id" : "PRRC_kwDOABII585Sho8x",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 2082,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 1717094661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384550193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T08:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384550193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384553675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384553675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The word `initial` here is indeed confusing... Thinking about something happening only at node bootstrap, which is a more obvious version i think. Can we find a different word now that you're changing it to certainly not mean that?",
      "commit_id" : "5628ac55be42c5450c6817ba8dcfe463ceda32a9",
      "created_at" : "2023-11-07T08:36:58Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384553675",
      "id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585ShpzL",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1717094661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384553675/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T08:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384553675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384972762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384972762"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm wondering, does it even make sense to keep such flag at this point? What it would take to adjust all code to going back-and-forth w.r.t. superstale?\r\n\r\nI think that would be an oxymoron. We would be adding code to put the node back into IBD state, because of a stale tip check, when the node is updating the tip.\r\n\r\nThe `fInitialDownload` flag usage is just a speedup. We know for sure that when the flag is true, it is because the node is in IBD. So we don't need to check anything else in such case.\r\n\r\nAside from that, about the adjustments: the stale tip check uses the last tip updated time (`m_last_tip_update`) which is updated on every new block `BlockConnected` (which is executed prior to `UpdatedBlockTip`). So that would need to be moved to `UpdatedBlockTip`. Also, and more importantly for me, because the stale tip check checks the in-flight block requests map, it requires `cs_main` lock. Which I would try to avoid as much as possible as it usage slows down the net messages processing and validation thread.\r\nA little note about this last point; with something like #27837, we could guard `mapBlocksInFlight` under a different mutex and not `cs_main`. ",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-11-07T14:07:29Z",
      "diff_hunk" : "@@ -2057,6 +2078,16 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\n {\n     SetBestHeight(pindexNew->nHeight);\n \n+    // Update internal sync state.\n+    // Avoid using 'fInitialDownload' alone since the flag currently cannot go backwards after passing IBD once.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384972762",
      "id" : 1384972762,
      "in_reply_to_id" : 1384550193,
      "line" : 2081,
      "node_id" : "PRRC_kwDOABII585SjQHa",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 2082,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 1717778418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384972762/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T14:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384972762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384991649"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384991649"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The word `initial` here is indeed confusing... Thinking about something happening only at node bootstrap, which is a more obvious version i think. Can we find a different word now that you're changing it to certainly not mean that?\r\n\r\nHmm, first names coming to my mind are `m_close_to_synced` or `m_close_to_tip`? or, could use the existing term `m_can_direct_fetch`?\r\n\r\nStill, maybe better to leave it for a follow-up because, with the back-and-forth functionality, we could also use this flag instead of calling `CanDirectFetch()` which locks `cs_main`.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-11-07T14:18:57Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384991649",
      "id" : 1384991649,
      "in_reply_to_id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585SjUuh",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1717778418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384991649/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T14:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1384991649",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1385001110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1385001110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, naming is hard.\r\nAs the function is called `TipMayBeStale()`, maybe calling it `SyncState` could also work. Thoughts? Or do you have anything else in mind?",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-11-07T14:24:46Z",
      "diff_hunk" : "@@ -892,7 +893,13 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    enum class Staleness {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1385001110",
      "id" : 1385001110,
      "in_reply_to_id" : 1384547974,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585SjXCW",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 1717826616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1385001110/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-07T14:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1385001110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated per @andrewtoth feedback via dm.\r\nImproved a test comment for better clarity. Tiny [diff](https://github.com/bitcoin/bitcoin/compare/5628ac55be42c5450c6817ba8dcfe463ceda32a9..60a487dd2430145115fcd0215472a5a2ef9bb090).",
      "created_at" : "2023-11-07T14:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1798760647",
      "id" : 1798760647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585rNujH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1798760647/reactions"
      },
      "updated_at" : "2023-11-07T14:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1798760647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1386309080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386309080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`SyncState` yeah that would work if you come up with a good enum values.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-11-08T09:55:57Z",
      "diff_hunk" : "@@ -892,7 +893,13 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    enum class Staleness {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1386309080",
      "id" : 1386309080,
      "in_reply_to_id" : 1384547974,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585SoWXY",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 1719854627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386309080/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-08T09:55:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386309080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1386826811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386826811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> `SyncState` yeah that would work if you come up with a good enum values.\r\n\r\nMaybe `Synced`, `RecentStale`, `Stale`?\r\nNamed the second and third \"stale\" because these states have no in-flight block requests.\r\n\r\nStill, this could also be easily changed in the future if we come up with better names.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-11-08T15:41:02Z",
      "diff_hunk" : "@@ -892,7 +893,13 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool BlockRequested(NodeId nodeid, const CBlockIndex& block, std::list<QueuedBlock>::iterator** pit = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    enum class Staleness {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1386826811",
      "id" : 1386826811,
      "in_reply_to_id" : 1384547974,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585SqUw7",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 896,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 1720677656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386826811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-08T15:41:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1386826811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413138828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413138828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This flag is only used to connect to limited peers or not. In that case, why not remove the indirection about syncing and just call it `allow_limited_peers`?",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-12-03T15:42:18Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413138828",
      "id" : 1413138828,
      "in_reply_to_id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585UOsmM",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1761294796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413138828/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-03T15:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413138828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413143266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413143266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This flag is only used to connect to limited peers or not. In that case, why not remove the indirection about syncing and just call it `allow_limited_peers`?\r\n\r\nBecause of what I wrote above, this flag can (and most likely will) be used in other places as well, fulfilling two goals: (1) minimizing `cs_main` locks, which improves the overall node response, and (2) minimizing the usage of the chainstate IBD flag, which lacks back-and-forth functionality.\r\n\r\nAs this PR did not introduce the flag and it is fixing an issue, I think is fine to leave the flag name as is now. It could be revisited on a follow-up.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-12-03T15:55:50Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413143266",
      "id" : 1413143266,
      "in_reply_to_id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585UOtri",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1761299662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413143266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-03T16:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413143266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413149420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413149420"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, then I think `m_is_close_to_tip` would make the most sense, since it's set initially after calling `IsBlockCloseToTip`.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-12-03T16:24:19Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413149420",
      "id" : 1413149420,
      "in_reply_to_id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585UOvLs",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1761305909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413149420/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-03T16:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413149420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413843279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413843279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@naumenkogs, do you agree on the naming as well? I'm happy to change it if we all agree.\r\nBetter to be sync to not circle much around the naming here.",
      "commit_id" : "60a487dd2430145115fcd0215472a5a2ef9bb090",
      "created_at" : "2023-12-04T13:03:14Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413843279",
      "id" : 1413843279,
      "in_reply_to_id" : 1384553675,
      "line" : 5336,
      "node_id" : "PRRC_kwDOABII585URYlP",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1762353698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413843279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T13:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413843279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1415169393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415169393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah that would be better i think",
      "commit_id" : "afc29b15e262b4ff402d479ec77ab8507552bcbc",
      "created_at" : "2023-12-05T09:00:32Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1415169393",
      "id" : 1415169393,
      "in_reply_to_id" : 1384553675,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UWcVx",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1764414714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415169393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T09:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415169393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 60a487dd2430145115fcd0215472a5a2ef9bb090.\r\n\r\n[This](https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1413149420) would be an improvement.",
      "created_at" : "2023-12-05T09:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1840311256",
      "id" : 1840311256,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585tsOvY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840311256/reactions"
      },
      "updated_at" : "2023-12-05T09:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840311256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1416195304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416195304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok cool. Updated per feedback.",
      "commit_id" : "afc29b15e262b4ff402d479ec77ab8507552bcbc",
      "created_at" : "2023-12-05T19:42:03Z",
      "diff_hunk" : "@@ -5279,22 +5310,31 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n \n     EvictExtraOutboundPeers(now);\n \n+    Staleness staleness{Staleness::NotStale};\n     if (now > m_stale_tip_check_time) {\n-        // Check whether our tip is stale, and if so, allow using an extra\n-        // outbound peer\n-        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing() && TipMayBeStale()) {\n+        // Check whether our tip is stale, and if so, allow using an extra outbound peer\n+        if (!m_chainman.m_blockman.LoadingBlocks() && m_connman.GetNetworkActive() && m_connman.GetUseAddrmanOutgoing()) {\n+            staleness = TipMayBeStale();\n+        }\n+\n+        if (staleness != Staleness::NotStale) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\",\n                       count_seconds(now - m_last_tip_update.load()));\n             m_connman.SetTryNewOutboundPeer(true);\n         } else if (m_connman.GetTryNewOutboundPeer()) {\n             m_connman.SetTryNewOutboundPeer(false);\n         }\n+\n         m_stale_tip_check_time = now + STALE_CHECK_INTERVAL;\n     }\n \n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (staleness == Staleness::StalePastNetworkLimited) {\n+        // Disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_initial_sync_finished = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1416195304",
      "id" : 1416195304,
      "in_reply_to_id" : 1384553675,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UaWzo",
      "original_commit_id" : "ef4a1a44dca1af20adcc8fb0c14e8a31683a9d99",
      "original_line" : 5337,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1765972033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416195304/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T19:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416195304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated per feedback (https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1384553675). Thanks @andrewtoth and @naumenkogs.\r\nTiny diff, only renamed `m_initial_sync_finished` to `m_is_close_to_tip` in a scripted-diff commit afc29b15e262b4ff402d479ec77ab8507552bcbc.",
      "created_at" : "2023-12-05T19:44:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1841506898",
      "id" : 1841506898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585twypS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841506898/reactions"
      },
      "updated_at" : "2023-12-05T19:45:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841506898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK afc29b15e262b4ff402d479ec77ab8507552bcbc",
      "created_at" : "2023-12-06T10:10:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1842572200",
      "id" : 1842572200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585t02uo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1842572200/reactions"
      },
      "updated_at" : "2023-12-06T10:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1842572200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review vasild!. Will tackle all points in the coming days. I'm currently finishing few bug fixes priorities and will be fully here again.",
      "created_at" : "2023-12-12T19:32:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1852679820",
      "id" : 1852679820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585ubaaM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852679820/reactions"
      },
      "updated_at" : "2023-12-12T19:32:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1852679820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Would this resolve the problem?\r\n\r\n<details>\r\n<summary>[patch] update g_initial_block_download_completed periodically based on our tip age</summary>\r\n\r\n```diff\r\ndiff --git i/src/net_processing.cpp w/src/net_processing.cpp\r\nindex df54a62f28..ec9bbff8f2 100644\r\n--- i/src/net_processing.cpp\r\n+++ w/src/net_processing.cpp\r\n@@ -2045,13 +2045,12 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\r\n  * Update our best height and announce any block hashes which weren't previously\r\n  * in m_chainman.ActiveChain() to our peers.\r\n  */\r\n void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload)\r\n {\r\n     SetBestHeight(pindexNew->nHeight);\r\n-    SetServiceFlagsIBDCache(!fInitialDownload);\r\n \r\n     // Don't relay inventory during initial block download.\r\n     if (fInitialDownload) return;\r\n \r\n     // Find the hashes of all blocks that weren't previously in the best chain.\r\n     std::vector<uint256> vHashes;\r\n@@ -5265,12 +5264,19 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\r\n     }\r\n \r\n     if (!m_initial_sync_finished && CanDirectFetch()) {\r\n         m_connman.StartExtraBlockRelayPeers();\r\n         m_initial_sync_finished = true;\r\n     }\r\n+\r\n+    const std::chrono::seconds time_between_blocks{m_chainparams.GetConsensus().nPowTargetSpacing};\r\n+    const NodeSeconds limited_peers_oldest_block_time{Now<NodeSeconds>() -\r\n+                                                      time_between_blocks * NODE_NETWORK_LIMITED_MIN_BLOCKS};\r\n+    const bool tip_within_limited_peers_reach{m_chainman.ActiveChain().Tip()->Time() >\r\n+                                              limited_peers_oldest_block_time};\r\n+    SetServiceFlagsIBDCache(tip_within_limited_peers_reach);\r\n }\r\n \r\n void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::microseconds now)\r\n {\r\n     if (m_connman.ShouldRunInactivityChecks(node_to, std::chrono::duration_cast<std::chrono::seconds>(now)) &&\r\n         peer.m_ping_nonce_sent &&\r\n```\r\nagainst `master` @ f0e829022a415c7c9513e715c532079ec7756306\r\nplus maybe some renaming is warranted\r\n</details>\r\n\r\nMy addrman has 71837 addresses and from those 11795 are limited peers. The chance of getting all 10 peers limited is (11795 / 71837)<sup>10</sup> which is really small. Was this observed in practice or is it more of a theoretical problem? (I think it should be fixed even if \"theoretical\").",
      "created_at" : "2023-12-13T14:04:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#issuecomment-1853978983",
      "id" : 1853978983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28170",
      "node_id" : "IC_kwDOABII585ugXln",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853978983/reactions"
      },
      "updated_at" : "2023-12-13T14:04:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853978983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
