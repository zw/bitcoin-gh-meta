[
   {
      "author_association" : "MEMBER",
      "body" : "~Marking this draft until~\r\n1. ~~[Previous PR is merged](https://github.com/bitcoin/bitcoin/pull/23443)~~ [Follow-up is merged](https://github.com/bitcoin/bitcoin/pull/26359)\r\n2. ~There is one in-code TODO I have to resolve (it is minor, but it has to be improved)~\r\n3. ~I add unit and functional tests for these features.~\r\n\r\n~Another task is to sync [parent PR](https://github.com/bitcoin/bitcoin/pull/21515) with this version. I have a local branch that compiles, but tests of the full Erlay there needs a little care. If you want to see how this PR works in the broader context, the parent should be good enough to get it. Otherwise, I intend to update it soon.~",
      "created_at" : "2022-10-08T07:33:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1272254249",
      "id" : 1272254249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585L1Q8p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272254249/reactions"
      },
      "updated_at" : "2023-10-11T10:06:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272254249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/26283).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28463](https://github.com/bitcoin/bitcoin/pull/28463) (p2p: Increase inbound capacity for block-relay only connections by mzumsande)\n* [#21515](https://github.com/bitcoin/bitcoin/pull/21515) (Erlay: bandwidth-efficient transaction relay protocol by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-10-08T16:15:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1272351013",
      "id" : 1272351013,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585L1okl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272351013/reactions"
      },
      "updated_at" : "2023-10-11T10:06:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1272351013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998568613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998568613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/reocnciliation set/reconciliation set/g",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T18:17:12Z",
      "diff_hunk" : "@@ -5576,8 +5701,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {\n+                            bool flood_target = m_txreconciliation->ShouldFloodTo(wtxid, pto->GetId());\n+\n+                            // Special treatment for unconfirmed transactions with unconfirmed\n+                            // parents.\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            const CTxMemPoolEntry::Parents& parents = (*txiter)->GetMemPoolParentsConst();\n+                            for (const CTxMemPoolEntry& parent : parents) {\n+                                // Two situations are possible here:\n+                                // 1. The parent was fully relayed to the peer earlier.\n+                                // 2. The parent is set for reconciliation and the child is not\n+                                //    in the mempool yet. The child arrives to the mempool and is\n+                                //    flooded. The peer receives the child earlier than the parent.\n+                                // We can differentiate between the two by looking at the recon\n+                                // set: if the set (or the snapshot) contains the parent, the parent\n+                                // is being reconciled (case 2). Then, we add the child to the\n+                                // reconciliation set, so that it doesn't arrive earlier than the\n+                                // parent.\n+                                // If it's the case 1, we proceed as usual by looking at the\n+                                // child's wtxid.\n+                                const uint256 parent_wtxid = parent.GetTx().GetWitnessHash();\n+                                if (m_txreconciliation->CurrentlyReconcilingTx(pto->GetId(), parent_wtxid) ||\n+                                    std::find(txs_to_reconcile.begin(), txs_to_reconcile.end(), parent_wtxid) != txs_to_reconcile.end()) {\n+                                    // Currently reconciling parent tx.\n+                                    // We have the following options to do:\n+                                    // 1. Flood parent+child.\n+                                    // 2. Reconcile parent+child.\n+                                    // 3. Flood parent, reconcile child.\n+                                    // We choose (2) because it has the easiest implementation.\n+                                    // The latency impact is not that bad:\n+                                    // 1. If the parent is in the reocnciliation set, the two",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998568613",
      "id" : 998568613,
      "line" : 5744,
      "node_id" : "PRRC_kwDOABII5847hPKl",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5744,
      "original_position" : 297,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 297,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998568613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998568613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998588937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998588937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could be `<=` as `MAX_PEER_TX_ANNOUNCEMENTS` should be the maximum number of elements/transactions we announce to our peers. Note, while only strictly inferior transaction requests are considered L1409 in `net_processing.cpp`, this is different for the processing of `NOTFOUND`, L4793, still in `net_processing.cpp`.",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T18:41:23Z",
      "diff_hunk" : "@@ -5576,8 +5701,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {\n+                            bool flood_target = m_txreconciliation->ShouldFloodTo(wtxid, pto->GetId());\n+\n+                            // Special treatment for unconfirmed transactions with unconfirmed\n+                            // parents.\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            const CTxMemPoolEntry::Parents& parents = (*txiter)->GetMemPoolParentsConst();\n+                            for (const CTxMemPoolEntry& parent : parents) {\n+                                // Two situations are possible here:\n+                                // 1. The parent was fully relayed to the peer earlier.\n+                                // 2. The parent is set for reconciliation and the child is not\n+                                //    in the mempool yet. The child arrives to the mempool and is\n+                                //    flooded. The peer receives the child earlier than the parent.\n+                                // We can differentiate between the two by looking at the recon\n+                                // set: if the set (or the snapshot) contains the parent, the parent\n+                                // is being reconciled (case 2). Then, we add the child to the\n+                                // reconciliation set, so that it doesn't arrive earlier than the\n+                                // parent.\n+                                // If it's the case 1, we proceed as usual by looking at the\n+                                // child's wtxid.\n+                                const uint256 parent_wtxid = parent.GetTx().GetWitnessHash();\n+                                if (m_txreconciliation->CurrentlyReconcilingTx(pto->GetId(), parent_wtxid) ||\n+                                    std::find(txs_to_reconcile.begin(), txs_to_reconcile.end(), parent_wtxid) != txs_to_reconcile.end()) {\n+                                    // Currently reconciling parent tx.\n+                                    // We have the following options to do:\n+                                    // 1. Flood parent+child.\n+                                    // 2. Reconcile parent+child.\n+                                    // 3. Flood parent, reconcile child.\n+                                    // We choose (2) because it has the easiest implementation.\n+                                    // The latency impact is not that bad:\n+                                    // 1. If the parent is in the reocnciliation set, the two\n+                                    // transactions will be relayed at the same time. There is\n+                                    // no point relaying the child faster anyway.\n+                                    // 2. If the parent is in the snapshot, the child will\n+                                    // be reconcilied within the next batch. This would\n+                                    // introduce extra latency (even if by wtxid the child\n+                                    // should have been flooded over this link), but this will\n+                                    // be compensated later: if the delay is non-trivial,\n+                                    // for the next nodes this condition won't be triggered (\n+                                    // parent won't be in the reconciliation set).\n+                                    //\n+                                    // In case of the multiple unconfirmed parents, we will\n+                                    // reconcile if at least one of the parents is being\n+                                    // reconciled.\n+                                    //\n+                                    // Note, the transaction still could be flooded if the\n+                                    // reconciliation set is full (see check below). This\n+                                    // is not the general case and is likely caused by the\n+                                    // issues with the peer, and then we're not responsible\n+                                    // that the package can't pass mempool limitations.\n+                                    flood_target = false;\n+                                    break;\n+                                }\n+                            }\n+\n+                            // Check if reconciliation set is not at capacity for two reasons:\n+                            // - limit sizes of reconciliation sets and short id mappings\n+                            // - limit CPU use for sketch computations\n+                            //\n+                            // Since we reconcile frequently, reaching capacity either means:\n+                            // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+                            // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+                            // We don't care about a laggy peer (1) because we probably can't help them even if we flood transactions.\n+                            // However, exploiting (2) should not prevent us from relaying certain transactions.\n+                            //\n+                            // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+                            const size_t recon_set_size = m_txreconciliation->GetPeerSetSize(pto->GetId());\n+                            if (!flood_target && txs_to_reconcile.size() + recon_set_size < MAX_PEER_TX_ANNOUNCEMENTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998588937",
      "id" : 998588937,
      "line" : 5781,
      "node_id" : "PRRC_kwDOABII5847hUIJ",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5781,
      "original_position" : 334,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 334,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998588937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998588937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998598182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998598182"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could be called `IsAlreadyInPeerSet` or something more speaking than transaction is already in peer local set but not announced yet. ",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T18:52:19Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_TXRECONCILIATION_H\n+#define BITCOIN_NODE_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <memory>\n+#include <tuple>\n+\n+/** Whether transaction reconciliation protocol should be enabled by default. */\n+static constexpr bool DEFAULT_TXRECONCILIATION_ENABLE{false};\n+/** Supported transaction reconciliation protocol version */\n+static constexpr uint32_t TXRECONCILIATION_VERSION{1};\n+\n+enum ReconciliationRegisterResult {\n+    NOT_FOUND = 0,\n+    SUCCESS = 1,\n+    PROTOCOL_VIOLATION = 2,\n+};\n+\n+/**\n+ * Transaction reconciliation is a way for nodes to efficiently announce transactions.\n+ * This object keeps track of all txreconciliation-related communications with the peers.\n+ * The high-level protocol is:\n+ * 0.  Txreconciliation protocol handshake.\n+ * 1.  Once we receive a new transaction, add it to the set instead of announcing immediately.\n+ * 2.  At regular intervals, a txreconciliation initiator requests a sketch from a peer, where a\n+ *     sketch is a compressed representation of short form IDs of the transactions in their set.\n+ * 3.  Once the initiator received a sketch from the peer, the initiator computes a local sketch,\n+ *     and combines the two sketches to attempt finding the difference in *sets*.\n+ * 4a. If the difference was not larger than estimated, see SUCCESS below.\n+ * 4b. If the difference was larger than estimated, initial txreconciliation fails. The initiator\n+ *     requests a larger sketch via an extension round (allowed only once).\n+ *     - If extension succeeds (a larger sketch is sufficient), see SUCCESS below.\n+ *     - If extension fails (a larger sketch is insufficient), see FAILURE below.\n+ *\n+ * SUCCESS. The initiator knows full symmetrical difference and can request what the initiator is\n+ *          missing and announce to the peer what the peer is missing.\n+ *\n+ * FAILURE. The initiator notifies the peer about the failure and announces all transactions from\n+ *          the corresponding set. Once the peer received the failure notification, the peer\n+ *          announces all transactions from their set.\n+\n+ * This is a modification of the Erlay protocol (https://arxiv.org/abs/1905.10518) with two\n+ * changes (sketch extensions instead of bisections, and an extra INV exchange round), both\n+ * are motivated in BIP-330.\n+ */\n+class TxReconciliationTracker\n+{\n+private:\n+    class Impl;\n+    const std::unique_ptr<Impl> m_impl;\n+\n+public:\n+    explicit TxReconciliationTracker(uint32_t recon_version);\n+    ~TxReconciliationTracker();\n+\n+    /**\n+     * Step 0. Generates initial part of the state (salt) required to reconcile txs with the peer.\n+     * The salt is used for short ID computation required for txreconciliation.\n+     * The function returns the salt.\n+     * A peer can't participate in future txreconciliations without this call.\n+     * This function must be called only once per peer.\n+     */\n+    uint64_t PreRegisterPeer(NodeId peer_id);\n+\n+    /**\n+     * Step 0. Once the peer agreed to reconcile txs with us, generate the state required to track\n+     * ongoing reconciliations. Must be called only after pre-registering the peer and only once.\n+     */\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version, uint64_t remote_salt);\n+\n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     */\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if\n+     * the peer just announced the transaction to us.\n+     */\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove);\n+\n+    /**\n+     * Step 2. If a it's time to request a reconciliation from the peer, this function will return\n+     * the details of our local state, which should be communicated to the peer so that they better\n+     * know what we need:\n+     * - size of our reconciliation set for the peer\n+     * - our q-coefficient with the peer, formatted to be transmitted as integer value\n+     * If the peer was not previously registered for reconciliations, returns nullopt.\n+     */\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id);\n+\n+    /**\n+     * Returns the size of the reconciliation set we have locally for the given peer.\n+     * If the peer was not previously registered for reconciliations, returns nullopt.\n+     */\n+    size_t GetPeerSetSize(NodeId peer_id) const;\n+\n+    /**\n+     * Attempts to forget txreconciliation-related state of the peer (if we previously stored any).\n+     * After this, we won't be able to reconcile transactions with the peer.\n+     */\n+    void ForgetPeer(NodeId peer_id);\n+\n+    /**\n+     * Check if a peer is registered to reconcile transactions with us.\n+     */\n+    bool IsPeerRegistered(NodeId peer_id) const;\n+\n+    /**\n+     * Returns whether for the given call the peer is chosen as a low-fanout destination.\n+     */\n+    bool ShouldFloodTo(uint256 wtxid, NodeId peer_id) const;\n+\n+    /**\n+     * Check whether a particular transaction is being currently reconciled with a given peer.\n+     */\n+    bool CurrentlyReconcilingTx(NodeId peer_id, const uint256 wtxid) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998598182",
      "id" : 998598182,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5847hWYm",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 125,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 125,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998598182/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998598182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998610903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998610903"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, current inv-based transaction announcement (L5812) isn't gated on IBD being over though I agree it makes sense to save bandwidth as the node is unlikely to be able to validate most of the transactions received for inaccuracy of its local UTXO set. ",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:07:34Z",
      "diff_hunk" : "@@ -5611,11 +5822,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    // Populating local reconciliation set.\n+                    if (txs_to_reconcile.size() != 0) {\n+                        m_txreconciliation->AddToReconSet(pto->GetId(), txs_to_reconcile);\n+                    }\n                 }\n         }\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998610903",
      "id" : 998610903,
      "line" : 5839,
      "node_id" : "PRRC_kwDOABII5847hZfX",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5839,
      "original_position" : 366,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 366,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998610903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998610903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998613472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998613472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/if a it's time/if it's time/g",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:10:45Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_TXRECONCILIATION_H\n+#define BITCOIN_NODE_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <memory>\n+#include <tuple>\n+\n+/** Whether transaction reconciliation protocol should be enabled by default. */\n+static constexpr bool DEFAULT_TXRECONCILIATION_ENABLE{false};\n+/** Supported transaction reconciliation protocol version */\n+static constexpr uint32_t TXRECONCILIATION_VERSION{1};\n+\n+enum ReconciliationRegisterResult {\n+    NOT_FOUND = 0,\n+    SUCCESS = 1,\n+    PROTOCOL_VIOLATION = 2,\n+};\n+\n+/**\n+ * Transaction reconciliation is a way for nodes to efficiently announce transactions.\n+ * This object keeps track of all txreconciliation-related communications with the peers.\n+ * The high-level protocol is:\n+ * 0.  Txreconciliation protocol handshake.\n+ * 1.  Once we receive a new transaction, add it to the set instead of announcing immediately.\n+ * 2.  At regular intervals, a txreconciliation initiator requests a sketch from a peer, where a\n+ *     sketch is a compressed representation of short form IDs of the transactions in their set.\n+ * 3.  Once the initiator received a sketch from the peer, the initiator computes a local sketch,\n+ *     and combines the two sketches to attempt finding the difference in *sets*.\n+ * 4a. If the difference was not larger than estimated, see SUCCESS below.\n+ * 4b. If the difference was larger than estimated, initial txreconciliation fails. The initiator\n+ *     requests a larger sketch via an extension round (allowed only once).\n+ *     - If extension succeeds (a larger sketch is sufficient), see SUCCESS below.\n+ *     - If extension fails (a larger sketch is insufficient), see FAILURE below.\n+ *\n+ * SUCCESS. The initiator knows full symmetrical difference and can request what the initiator is\n+ *          missing and announce to the peer what the peer is missing.\n+ *\n+ * FAILURE. The initiator notifies the peer about the failure and announces all transactions from\n+ *          the corresponding set. Once the peer received the failure notification, the peer\n+ *          announces all transactions from their set.\n+\n+ * This is a modification of the Erlay protocol (https://arxiv.org/abs/1905.10518) with two\n+ * changes (sketch extensions instead of bisections, and an extra INV exchange round), both\n+ * are motivated in BIP-330.\n+ */\n+class TxReconciliationTracker\n+{\n+private:\n+    class Impl;\n+    const std::unique_ptr<Impl> m_impl;\n+\n+public:\n+    explicit TxReconciliationTracker(uint32_t recon_version);\n+    ~TxReconciliationTracker();\n+\n+    /**\n+     * Step 0. Generates initial part of the state (salt) required to reconcile txs with the peer.\n+     * The salt is used for short ID computation required for txreconciliation.\n+     * The function returns the salt.\n+     * A peer can't participate in future txreconciliations without this call.\n+     * This function must be called only once per peer.\n+     */\n+    uint64_t PreRegisterPeer(NodeId peer_id);\n+\n+    /**\n+     * Step 0. Once the peer agreed to reconcile txs with us, generate the state required to track\n+     * ongoing reconciliations. Must be called only after pre-registering the peer and only once.\n+     */\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version, uint64_t remote_salt);\n+\n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     */\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if\n+     * the peer just announced the transaction to us.\n+     */\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove);\n+\n+    /**\n+     * Step 2. If a it's time to request a reconciliation from the peer, this function will return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998613472",
      "id" : 998613472,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII5847haHg",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 91,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 91,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998613472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998613472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998619645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998619645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`reconciliation_request_data` could be called `reconciliation_request_parameters` to dissociate clearly we're sending reconciliation config info and not the set itself.",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:18:32Z",
      "diff_hunk" : "@@ -5611,11 +5822,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    // Populating local reconciliation set.\n+                    if (txs_to_reconcile.size() != 0) {\n+                        m_txreconciliation->AddToReconSet(pto->GetId(), txs_to_reconcile);\n+                    }\n                 }\n         }\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n+                if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                    auto reconciliation_request_data = m_txreconciliation->MaybeRequestReconciliation(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998619645",
      "id" : 998619645,
      "line" : 5841,
      "node_id" : "PRRC_kwDOABII5847hbn9",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5841,
      "original_position" : 368,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 368,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998619645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998619645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998628718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998628718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure what you aimed to achieve here with the `std::max` between `INBOUND_INVENTORY_BROADCAST_INTERVAL` and `INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON` as the former is always superior to the latter. Maybe could be rather a `static_assert` to enforce the order at compilation time in case of future changes.  ",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:29:51Z",
      "diff_hunk" : "@@ -143,17 +146,22 @@ static constexpr auto AVG_ADDRESS_BROADCAST_INTERVAL{30s};\n /** Delay between rotating the peers we relay a particular address to */\n static constexpr auto ROTATE_ADDR_RELAY_DEST_INTERVAL{24h};\n /** Average delay between trickled inventory transmissions for inbound peers.\n- *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this. */\n+ *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this.\n+ *  For reconciliation peers the delay is different. */\n static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL{5s};\n+static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON{2s};\n /** Average delay between trickled inventory transmissions for outbound peers.\n  *  Use a smaller delay as there is less privacy concern for them.\n- *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this. */\n+ *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this.\n+ *  For reconciliation peers the delay is different. */\n static constexpr auto OUTBOUND_INVENTORY_BROADCAST_INTERVAL{2s};\n+static constexpr auto OUTBOUND_INVENTORY_BROADCAST_INTERVAL_RECON{1s};\n /** Maximum rate of inventory items to send per second.\n  *  Limits the impact of low-fee transaction floods. */\n static constexpr unsigned int INVENTORY_BROADCAST_PER_SECOND = 7;\n /** Maximum number of inventory items to send per transmission. */\n-static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND * count_seconds(INBOUND_INVENTORY_BROADCAST_INTERVAL);\n+static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND *\n+    count_seconds(std::max(INBOUND_INVENTORY_BROADCAST_INTERVAL, INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998628718",
      "id" : 998628718,
      "line" : 164,
      "node_id" : "PRRC_kwDOABII5847hd1u",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 164,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998628718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998628718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998629668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998629668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you can develop the comment here why \"we need to make faster\" or point towards another code comment or BIP section where it's explained.",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:31:04Z",
      "diff_hunk" : "@@ -5488,12 +5589,35 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                 LOCK(tx_relay->m_tx_inventory_mutex);\n                 // Check whether periodic sends should happen\n                 bool fSendTrickle = pto->HasPermission(NetPermissionFlags::NoBan);\n+                const bool supports_recon = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());\n+\n                 if (tx_relay->m_next_inv_send_time < current_time) {\n                     fSendTrickle = true;\n                     if (pto->IsInboundConn()) {\n-                        tx_relay->m_next_inv_send_time = NextInvToInbounds(current_time, INBOUND_INVENTORY_BROADCAST_INTERVAL);\n+                        if (supports_recon) {\n+                            // Use shorter intervals for reconciliation peers because we use\n+                            // low-fanout, and 1) we need to make faster; 2) we won't get much",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998629668",
      "id" : 998629668,
      "line" : 5599,
      "node_id" : "PRRC_kwDOABII5847heEk",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5599,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 217,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998629668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998629668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998633914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998633914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could add comment if the rational behind those values selection is specified in the BIP, paper or other research.",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:36:25Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998633914",
      "id" : 998633914,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII5847hfG6",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 25,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998633914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998633914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998640600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998640600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Curious, what we care about a low transaction relay latency ? Like I would say lower latency makes it a) harder to observe original transaction broadcast by deanonymization attacker b) disincentive transaction issuers front-running the standard tx-relay rules to place their transactions first in the mempools in case of congestion and c) for instant/0confs flows improve UX, do we have more properties ?",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T19:44:50Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998640600",
      "id" : 998640600,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII5847hgvY",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 36,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998640600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998640600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998653688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998653688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"which are unlikely to game this timer in a serious way\", though is there a timeout in the rest of the patchset to evict lazy/buggy outbound peers which would stuck the reconciliation, making us stale on `Phase::INIT_REQUESTED` and which would prevent `MaybeRequestReconciliation()` to move forward due to the check L258 ?",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-18T20:00:37Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r998653688",
      "id" : 998653688,
      "line" : 136,
      "node_id" : "PRRC_kwDOABII5847hj74",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 136,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 136,
      "pull_request_review_id" : 1146311466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998653688/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998653688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005384672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005384672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1d9b1f7d4bbf5ca5a8f43180b994b7b2fc03447f\r\n```suggestion\r\n                    if (!txs_to_reconcile.empty()) {\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:36:31Z",
      "diff_hunk" : "@@ -5611,11 +5822,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    // Populating local reconciliation set.\n+                    if (txs_to_reconcile.size() != 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005384672",
      "id" : 1005384672,
      "line" : 5827,
      "node_id" : "PRRC_kwDOABII58477PPg",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5827,
      "original_position" : 354,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 354,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005384672/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005384672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005385195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005385195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5070c97459282346cdcff7af08914c702462fe0d\r\n```suggestion\r\nenum class Phase {\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:36:58Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005385195",
      "id" : 1005385195,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII58477PXr",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 43,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005385195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005385195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005386331"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005386331"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7cffb4cc0211b0494a7563d9a80a67633fa61255\r\n```suggestion\r\n                const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:38:01Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005386331",
      "id" : 1005386331,
      "line" : 139,
      "node_id" : "PRRC_kwDOABII58477Ppb",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 139,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 139,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005386331/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005386331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005387197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005387197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (!m_queue.empty()) {\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:38:49Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                if (cur_state) return cur_state->m_we_initiate;\n+                return false;\n+            });\n+        m_next_recon_request = now + (RECON_REQUEST_INTERVAL / we_initiate_to_count);\n+    }\n+\n+    public:\n+    explicit Impl(uint32_t recon_version) : m_recon_version(recon_version) {}\n+\n+    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        // We do not support txreconciliation salt/version updates.\n+        assert(m_states.find(peer_id) == m_states.end());\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Pre-register peer=%d\\n\", peer_id);\n+        const uint64_t local_salt{GetRand(UINT64_MAX)};\n+\n+        // We do this exactly once per peer (which are unique by NodeId, see GetNewNodeId) so it's\n+        // safe to assume we don't have this record yet.\n+        Assert(m_states.emplace(peer_id, local_salt).second);\n+        return local_salt;\n+    }\n+\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;\n+\n+        if (we_initiate) {\n+            m_queue.push_back(peer_id);\n+        }\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Register peer=%d with the following params: \" /* Continued */\n+                                                                    \"we_initiate=%i, they_initiate=%i.\\n\",\n+                      peer_id, we_initiate, they_initiate);\n+\n+        const uint256 full_salt{ComputeSalt(*local_salt, remote_salt)};\n+        recon_state->second = TxReconciliationState(we_initiate, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        return SUCCESS;\n+    }\n+\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_queue.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005387197",
      "id" : 1005387197,
      "line" : 249,
      "node_id" : "PRRC_kwDOABII58477P29",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 249,
      "original_position" : 249,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 249,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005387197/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005387197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005388347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005388347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4cb08ebcd6190535bc2300e35557dd8b730b8951\r\n```suggestion\r\n    bool ShouldFloodTo(const uint256& wtxid, NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:39:49Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                if (cur_state) return cur_state->m_we_initiate;\n+                return false;\n+            });\n+        m_next_recon_request = now + (RECON_REQUEST_INTERVAL / we_initiate_to_count);\n+    }\n+\n+    public:\n+    explicit Impl(uint32_t recon_version) : m_recon_version(recon_version) {}\n+\n+    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        // We do not support txreconciliation salt/version updates.\n+        assert(m_states.find(peer_id) == m_states.end());\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Pre-register peer=%d\\n\", peer_id);\n+        const uint64_t local_salt{GetRand(UINT64_MAX)};\n+\n+        // We do this exactly once per peer (which are unique by NodeId, see GetNewNodeId) so it's\n+        // safe to assume we don't have this record yet.\n+        Assert(m_states.emplace(peer_id, local_salt).second);\n+        return local_salt;\n+    }\n+\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;\n+\n+        if (we_initiate) {\n+            m_queue.push_back(peer_id);\n+        }\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Register peer=%d with the following params: \" /* Continued */\n+                                                                    \"we_initiate=%i, they_initiate=%i.\\n\",\n+                      peer_id, we_initiate, they_initiate);\n+\n+        const uint256 full_salt{ComputeSalt(*local_salt, remote_salt)};\n+        recon_state->second = TxReconciliationState(we_initiate, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        return SUCCESS;\n+    }\n+\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_queue.size() > 0) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                    \"local_set_size=%i\\n\", peer_id, local_set_size);\n+\n+                // In future, RECON_Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, RECON_Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n+    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        }\n+    }\n+\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        return (recon_state != m_states.end() &&\n+                std::holds_alternative<TxReconciliationState>(recon_state->second));\n+    }\n+\n+    bool ShouldFloodTo(uint256 wtxid, NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005388347",
      "id" : 1005388347,
      "line" : 305,
      "node_id" : "PRRC_kwDOABII58477QI7",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 305,
      "original_position" : 305,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 305,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005388347/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005388347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005389029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4cb08ebcd6190535bc2300e35557dd8b730b8951\r\n```suggestion\r\n                const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:40:23Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                if (cur_state) return cur_state->m_we_initiate;\n+                return false;\n+            });\n+        m_next_recon_request = now + (RECON_REQUEST_INTERVAL / we_initiate_to_count);\n+    }\n+\n+    public:\n+    explicit Impl(uint32_t recon_version) : m_recon_version(recon_version) {}\n+\n+    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        // We do not support txreconciliation salt/version updates.\n+        assert(m_states.find(peer_id) == m_states.end());\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Pre-register peer=%d\\n\", peer_id);\n+        const uint64_t local_salt{GetRand(UINT64_MAX)};\n+\n+        // We do this exactly once per peer (which are unique by NodeId, see GetNewNodeId) so it's\n+        // safe to assume we don't have this record yet.\n+        Assert(m_states.emplace(peer_id, local_salt).second);\n+        return local_salt;\n+    }\n+\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;\n+\n+        if (we_initiate) {\n+            m_queue.push_back(peer_id);\n+        }\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Register peer=%d with the following params: \" /* Continued */\n+                                                                    \"we_initiate=%i, they_initiate=%i.\\n\",\n+                      peer_id, we_initiate, they_initiate);\n+\n+        const uint256 full_salt{ComputeSalt(*local_salt, remote_salt)};\n+        recon_state->second = TxReconciliationState(we_initiate, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        return SUCCESS;\n+    }\n+\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_queue.size() > 0) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                    \"local_set_size=%i\\n\", peer_id, local_set_size);\n+\n+                // In future, RECON_Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, RECON_Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n+    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        }\n+    }\n+\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        return (recon_state != m_states.end() &&\n+                std::holds_alternative<TxReconciliationState>(recon_state->second));\n+    }\n+\n+    bool ShouldFloodTo(uint256 wtxid, NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the similar reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+            [&eligible_peers, we_initiate](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                const auto cur_state = std::get<TxReconciliationState>(indexed_state.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005389029",
      "id" : 1005389029,
      "line" : 320,
      "node_id" : "PRRC_kwDOABII58477QTl",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 320,
      "original_position" : 320,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 320,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005389951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4cb08ebcd6190535bc2300e35557dd8b730b8951\r\n```suggestion\r\n            [&eligible_peers, we_initiate](auto indexed_state) {\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:41:20Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                if (cur_state) return cur_state->m_we_initiate;\n+                return false;\n+            });\n+        m_next_recon_request = now + (RECON_REQUEST_INTERVAL / we_initiate_to_count);\n+    }\n+\n+    public:\n+    explicit Impl(uint32_t recon_version) : m_recon_version(recon_version) {}\n+\n+    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        // We do not support txreconciliation salt/version updates.\n+        assert(m_states.find(peer_id) == m_states.end());\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Pre-register peer=%d\\n\", peer_id);\n+        const uint64_t local_salt{GetRand(UINT64_MAX)};\n+\n+        // We do this exactly once per peer (which are unique by NodeId, see GetNewNodeId) so it's\n+        // safe to assume we don't have this record yet.\n+        Assert(m_states.emplace(peer_id, local_salt).second);\n+        return local_salt;\n+    }\n+\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;\n+\n+        if (we_initiate) {\n+            m_queue.push_back(peer_id);\n+        }\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Register peer=%d with the following params: \" /* Continued */\n+                                                                    \"we_initiate=%i, they_initiate=%i.\\n\",\n+                      peer_id, we_initiate, they_initiate);\n+\n+        const uint256 full_salt{ComputeSalt(*local_salt, remote_salt)};\n+        recon_state->second = TxReconciliationState(we_initiate, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        return SUCCESS;\n+    }\n+\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_queue.size() > 0) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                    \"local_set_size=%i\\n\", peer_id, local_set_size);\n+\n+                // In future, RECON_Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, RECON_Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n+    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        }\n+    }\n+\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        return (recon_state != m_states.end() &&\n+                std::holds_alternative<TxReconciliationState>(recon_state->second));\n+    }\n+\n+    bool ShouldFloodTo(uint256 wtxid, NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the similar reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+            [&eligible_peers, we_initiate](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005389951",
      "id" : 1005389951,
      "line" : 319,
      "node_id" : "PRRC_kwDOABII58477Qh_",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 319,
      "original_position" : 319,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 319,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005389951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005390504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005390504"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1d9b1f7d4bbf5ca5a8f43180b994b7b2fc03447f: there are other instances where wtxid is not passed by ref\r\n```suggestion\r\n    bool CurrentlyReconcilingTx(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T08:41:50Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.\n+        size_t we_initiate_to_count = std::count_if(m_states.begin(), m_states.end(),\n+            [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                if (cur_state) return cur_state->m_we_initiate;\n+                return false;\n+            });\n+        m_next_recon_request = now + (RECON_REQUEST_INTERVAL / we_initiate_to_count);\n+    }\n+\n+    public:\n+    explicit Impl(uint32_t recon_version) : m_recon_version(recon_version) {}\n+\n+    uint64_t PreRegisterPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        // We do not support txreconciliation salt/version updates.\n+        assert(m_states.find(peer_id) == m_states.end());\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Pre-register peer=%d\\n\", peer_id);\n+        const uint64_t local_salt{GetRand(UINT64_MAX)};\n+\n+        // We do this exactly once per peer (which are unique by NodeId, see GetNewNodeId) so it's\n+        // safe to assume we don't have this record yet.\n+        Assert(m_states.emplace(peer_id, local_salt).second);\n+        return local_salt;\n+    }\n+\n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;\n+\n+        if (we_initiate) {\n+            m_queue.push_back(peer_id);\n+        }\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Register peer=%d with the following params: \" /* Continued */\n+                                                                    \"we_initiate=%i, they_initiate=%i.\\n\",\n+                      peer_id, we_initiate, they_initiate);\n+\n+        const uint256 full_salt{ComputeSalt(*local_salt, remote_salt)};\n+        recon_state->second = TxReconciliationState(we_initiate, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        return SUCCESS;\n+    }\n+\n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromReconSet(NodeId peer_id, const uint256 wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_queue.size() > 0) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                    \"local_set_size=%i\\n\", peer_id, local_set_size);\n+\n+                // In future, RECON_Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, RECON_Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n+    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        }\n+    }\n+\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        return (recon_state != m_states.end() &&\n+                std::holds_alternative<TxReconciliationState>(recon_state->second));\n+    }\n+\n+    bool ShouldFloodTo(uint256 wtxid, NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the similar reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+            [&eligible_peers, we_initiate](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                const auto cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+            }\n+        );\n+\n+        // TODO: there should be a cleaner way to do this.\n+        size_t flood_index_modulo;\n+        if (we_initiate) {\n+            flood_index_modulo = 1.0 / OUTBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        } else {\n+            flood_index_modulo = 1.0 / INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        }\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        assert(it != eligible_peers.end());\n+\n+        const size_t peer_index = it - eligible_peers.begin();\n+        return txidHasher(wtxid) % flood_index_modulo == peer_index % flood_index_modulo;\n+    }\n+\n+    bool CurrentlyReconcilingTx(NodeId peer_id, const uint256 wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005390504",
      "id" : 1005390504,
      "line" : 340,
      "node_id" : "PRRC_kwDOABII58477Qqo",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 340,
      "original_position" : 340,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 340,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005390504/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005390504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005414595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005414595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c60235bacceecbe7f83bb70f761a0adb3e5bf65b\r\nnit but I think it's easier to read\r\n```suggestion\r\n        assert(!they_initiate || !we_initiate));\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T09:02:41Z",
      "diff_hunk" : "@@ -55,6 +93,50 @@ class TxReconciliationTracker::Impl\n         return local_salt;\n     }\n \n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005414595",
      "id" : 1005414595,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII58477WjD",
      "original_commit_id" : "c60235bacceecbe7f83bb70f761a0adb3e5bf65b",
      "original_line" : 126,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 100,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005414595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005414595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005415156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005415156"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c60235bacceecbe7f83bb70f761a0adb3e5bf65b\r\nnit but I think it's easier to read\r\n```suggestion\r\n        if (!they_initiate && !we_initiate) return PROTOCOL_VIOLATION;\r\n```",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-10-26T09:03:01Z",
      "diff_hunk" : "@@ -55,6 +93,50 @@ class TxReconciliationTracker::Impl\n         return local_salt;\n     }\n \n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));\n+\n+        // The peer set both flags to false, we treat it as a protocol violation.\n+        if (!(they_initiate || we_initiate)) return PROTOCOL_VIOLATION;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1005415156",
      "id" : 1005415156,
      "line" : 198,
      "node_id" : "PRRC_kwDOABII58477Wr0",
      "original_commit_id" : "c60235bacceecbe7f83bb70f761a0adb3e5bf65b",
      "original_line" : 129,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 103,
      "pull_request_review_id" : 1156088702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005415156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-26T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1005415156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013791316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013791316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Applied `<=`, but I don't get the second sentence :(",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-11-04T09:26:34Z",
      "diff_hunk" : "@@ -5576,8 +5701,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {\n+                            bool flood_target = m_txreconciliation->ShouldFloodTo(wtxid, pto->GetId());\n+\n+                            // Special treatment for unconfirmed transactions with unconfirmed\n+                            // parents.\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            const CTxMemPoolEntry::Parents& parents = (*txiter)->GetMemPoolParentsConst();\n+                            for (const CTxMemPoolEntry& parent : parents) {\n+                                // Two situations are possible here:\n+                                // 1. The parent was fully relayed to the peer earlier.\n+                                // 2. The parent is set for reconciliation and the child is not\n+                                //    in the mempool yet. The child arrives to the mempool and is\n+                                //    flooded. The peer receives the child earlier than the parent.\n+                                // We can differentiate between the two by looking at the recon\n+                                // set: if the set (or the snapshot) contains the parent, the parent\n+                                // is being reconciled (case 2). Then, we add the child to the\n+                                // reconciliation set, so that it doesn't arrive earlier than the\n+                                // parent.\n+                                // If it's the case 1, we proceed as usual by looking at the\n+                                // child's wtxid.\n+                                const uint256 parent_wtxid = parent.GetTx().GetWitnessHash();\n+                                if (m_txreconciliation->CurrentlyReconcilingTx(pto->GetId(), parent_wtxid) ||\n+                                    std::find(txs_to_reconcile.begin(), txs_to_reconcile.end(), parent_wtxid) != txs_to_reconcile.end()) {\n+                                    // Currently reconciling parent tx.\n+                                    // We have the following options to do:\n+                                    // 1. Flood parent+child.\n+                                    // 2. Reconcile parent+child.\n+                                    // 3. Flood parent, reconcile child.\n+                                    // We choose (2) because it has the easiest implementation.\n+                                    // The latency impact is not that bad:\n+                                    // 1. If the parent is in the reocnciliation set, the two\n+                                    // transactions will be relayed at the same time. There is\n+                                    // no point relaying the child faster anyway.\n+                                    // 2. If the parent is in the snapshot, the child will\n+                                    // be reconcilied within the next batch. This would\n+                                    // introduce extra latency (even if by wtxid the child\n+                                    // should have been flooded over this link), but this will\n+                                    // be compensated later: if the delay is non-trivial,\n+                                    // for the next nodes this condition won't be triggered (\n+                                    // parent won't be in the reconciliation set).\n+                                    //\n+                                    // In case of the multiple unconfirmed parents, we will\n+                                    // reconcile if at least one of the parents is being\n+                                    // reconciled.\n+                                    //\n+                                    // Note, the transaction still could be flooded if the\n+                                    // reconciliation set is full (see check below). This\n+                                    // is not the general case and is likely caused by the\n+                                    // issues with the peer, and then we're not responsible\n+                                    // that the package can't pass mempool limitations.\n+                                    flood_target = false;\n+                                    break;\n+                                }\n+                            }\n+\n+                            // Check if reconciliation set is not at capacity for two reasons:\n+                            // - limit sizes of reconciliation sets and short id mappings\n+                            // - limit CPU use for sketch computations\n+                            //\n+                            // Since we reconcile frequently, reaching capacity either means:\n+                            // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+                            // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+                            // We don't care about a laggy peer (1) because we probably can't help them even if we flood transactions.\n+                            // However, exploiting (2) should not prevent us from relaying certain transactions.\n+                            //\n+                            // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+                            const size_t recon_set_size = m_txreconciliation->GetPeerSetSize(pto->GetId());\n+                            if (!flood_target && txs_to_reconcile.size() + recon_set_size < MAX_PEER_TX_ANNOUNCEMENTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013791316",
      "id" : 1013791316,
      "in_reply_to_id" : 998588937,
      "line" : 5781,
      "node_id" : "PRRC_kwDOABII5848bTpU",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5781,
      "original_position" : 334,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 334,
      "pull_request_review_id" : 1168195546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013791316/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-04T09:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013791316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013848477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013848477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought it's kinda obvious for 0conf experience, yes. Not even accepting payment, but at least seeing it in the network... Not sure what to include in the codebase.",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-11-04T10:26:35Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013848477",
      "id" : 1013848477,
      "in_reply_to_id" : 998640600,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII5848bhmd",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 36,
      "pull_request_review_id" : 1168276941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013848477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-04T10:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013848477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013850793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013850793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think `Phase::INIT_REQUESTED` is somehow related to being stuck... if one peer stays in that state, it doesn't prevent us from requesting recon from other peers. Only will delay by `m_next_recon_request` once?",
      "commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "created_at" : "2022-11-04T10:29:12Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013850793",
      "id" : 1013850793,
      "in_reply_to_id" : 998653688,
      "line" : 136,
      "node_id" : "PRRC_kwDOABII5848biKp",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 136,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 136,
      "pull_request_review_id" : 1168280370,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013850793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-04T10:29:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013850793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013981776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013981776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure it's any better",
      "commit_id" : "4c3bf8f43148b46bf55a09ed53d47dc7aa69441b",
      "created_at" : "2022-11-04T12:46:02Z",
      "diff_hunk" : "@@ -55,6 +93,50 @@ class TxReconciliationTracker::Impl\n         return local_salt;\n     }\n \n+    ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound, bool is_peer_recon_initiator,\n+                                     bool is_peer_recon_responder, uint32_t peer_recon_version,\n+                                     uint64_t remote_salt) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+\n+        // A peer should be in the pre-registered state to proceed here.\n+        if (recon_state == m_states.end()) return NOT_FOUND;\n+        uint64_t* local_salt = std::get_if<uint64_t>(&recon_state->second);\n+        // A peer is already registered. This should be checked by the caller.\n+        Assume(local_salt);\n+\n+        // If the peer supports the version which is lower than ours, we downgrade to the version\n+        // it supports. For now, this only guarantees that nodes with future reconciliation\n+        // versions have the choice of reconciling with this current version. However, they also\n+        // have the choice to refuse supporting reconciliations if the common version is not\n+        // satisfactory (e.g. too low).\n+        const uint32_t recon_version{std::min(peer_recon_version, m_recon_version)};\n+        // v1 is the lowest version, so suggesting something below must be a protocol violation.\n+        if (recon_version < 1) return PROTOCOL_VIOLATION;\n+\n+        // Must match SENDTXRCNCL logic.\n+        const bool they_initiate = is_peer_recon_initiator && is_peer_inbound;\n+        const bool we_initiate = !is_peer_inbound && is_peer_recon_responder;\n+\n+        // If we ever announce support for both requesting and responding, this will need\n+        // tie-breaking. For now, this is mutually exclusive because both are based on the\n+        // inbound flag.\n+        assert(!(they_initiate && we_initiate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1013981776",
      "id" : 1013981776,
      "in_reply_to_id" : 1005414595,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848cCJQ",
      "original_commit_id" : "c60235bacceecbe7f83bb70f761a0adb3e5bf65b",
      "original_line" : 126,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1168466518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013981776/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-04T12:46:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013981776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-04T16:29:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1303841621",
      "id" : 1303841621,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585NtwtV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1303841621/reactions"
      },
      "updated_at" : "2022-11-04T16:29:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1303841621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1020190507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020190507"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using PRNGs is usually discouraged, is this safe here?",
      "commit_id" : "913c2cbcea58696237760c51f55acee9d91eb186",
      "created_at" : "2022-11-11T12:48:21Z",
      "diff_hunk" : "@@ -154,6 +297,77 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = floor(flood_targets);\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer, at least assuming a static list\n+        // of peers. For this function that means no randomness.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external\n+        // observer. This is achieved by hashing the txid.\n+        //\n+        // Say, we have 2.4 targets out of 20 inbound peers, the wtixd hash is 217, and our peer_id\n+        // holds peer_position in the list of inbound peers.\n+        // We will compute 217 % 20 = 17, as if it was a \"starting_point\", from which we see if\n+        // the target is within a range of 2.4. It's impossible for the range to exceed\n+        // the bounds because of how we computed them in the first place.\n+        // For that, we need to check the following:\n+        // 1. If 17 <= peer_position < 19, return true.\n+        // 2. If peer_position = 19, roll the dice with the remaining probability (0.4).\n+        // 3. Otherwise, return false.\n+        const size_t starting_point = txidHasher(wtxid) % eligible_peers.size();\n+        if (starting_point <= peer_position && peer_position < starting_point + round_down_flood_targets) {\n+            return true;\n+        } else if (peer_position == starting_point + round_down_flood_targets) {\n+            return rand() < (flood_targets - round_down_flood_targets) * RAND_MAX;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1020190507",
      "id" : 1020190507,
      "line" : 358,
      "node_id" : "PRRC_kwDOABII5848zt8r",
      "original_commit_id" : "913c2cbcea58696237760c51f55acee9d91eb186",
      "original_line" : 358,
      "original_position" : 341,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 341,
      "pull_request_review_id" : 1177296531,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020190507/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-11T12:51:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020190507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1020204771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020204771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think so âÂ since txidHasher is salted, the peer would have no control of it, and thus can't exploit this rand. But I'll keep this comment in case someone has an objection, just in case.",
      "commit_id" : "913c2cbcea58696237760c51f55acee9d91eb186",
      "created_at" : "2022-11-11T13:08:41Z",
      "diff_hunk" : "@@ -154,6 +297,77 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = floor(flood_targets);\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer, at least assuming a static list\n+        // of peers. For this function that means no randomness.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external\n+        // observer. This is achieved by hashing the txid.\n+        //\n+        // Say, we have 2.4 targets out of 20 inbound peers, the wtixd hash is 217, and our peer_id\n+        // holds peer_position in the list of inbound peers.\n+        // We will compute 217 % 20 = 17, as if it was a \"starting_point\", from which we see if\n+        // the target is within a range of 2.4. It's impossible for the range to exceed\n+        // the bounds because of how we computed them in the first place.\n+        // For that, we need to check the following:\n+        // 1. If 17 <= peer_position < 19, return true.\n+        // 2. If peer_position = 19, roll the dice with the remaining probability (0.4).\n+        // 3. Otherwise, return false.\n+        const size_t starting_point = txidHasher(wtxid) % eligible_peers.size();\n+        if (starting_point <= peer_position && peer_position < starting_point + round_down_flood_targets) {\n+            return true;\n+        } else if (peer_position == starting_point + round_down_flood_targets) {\n+            return rand() < (flood_targets - round_down_flood_targets) * RAND_MAX;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1020204771",
      "id" : 1020204771,
      "in_reply_to_id" : 1020190507,
      "line" : 358,
      "node_id" : "PRRC_kwDOABII5848zxbj",
      "original_commit_id" : "913c2cbcea58696237760c51f55acee9d91eb186",
      "original_line" : 358,
      "original_position" : 341,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 341,
      "pull_request_review_id" : 1177318100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020204771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-11T13:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020204771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-30T12:05:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1332047452",
      "id" : 1332047452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585PZW5c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332047452/reactions"
      },
      "updated_at" : "2022-11-30T12:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332047452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036137603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036137603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will lock `m_txreconciliation_mutex` inside `IsPeerRegistered()`, check the state, and unlock again. On the next line we will then lock it again, and get a reference to the actual state. I don't think that's what we want:\r\n\r\n* It doesn't guarantee that the state didn't change in between the unlocking in `IsPeerRegistered` and getting the state two lines below, so the assertion doesn't actually prevent race conditions.\r\n* It's inefficient to lock and unlock twice.\r\n\r\nYou should check the `TxReconciliationState` within the same critical section as using it (perhaps by making `IsPeerRegistered` require `m_txreconciliation_mutex` being held?).",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:45:13Z",
      "diff_hunk" : "@@ -124,6 +132,35 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036137603",
      "id" : 1036137603,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wjSD",
      "original_commit_id" : "624e0988058e90537e1d1066a9c4528e4f1eecd1",
      "original_line" : 139,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036137603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036137603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036138757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036138757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same thing here: check the state within the same critical section as using it.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:46:15Z",
      "diff_hunk" : "@@ -124,6 +132,35 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {\n+                ++added;\n+            }\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036138757",
      "id" : 1036138757,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wjkF",
      "original_commit_id" : "624e0988058e90537e1d1066a9c4528e4f1eecd1",
      "original_line" : 157,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036138757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036138757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036140210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036140210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shorter: `added += recon_state.m_local_set.insert(wtxid).second;`.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:47:27Z",
      "diff_hunk" : "@@ -124,6 +132,35 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            if (recon_state.m_local_set.insert(wtxid).second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036140210",
      "id" : 1036140210,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wj6y",
      "original_commit_id" : "624e0988058e90537e1d1066a9c4528e4f1eecd1",
      "original_line" : 145,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036140210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036140210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036141026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036141026"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Style nit (feel free to ignore, it's not in the style guide, but I don't think we use anything like this anywhere): space before `:`.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:48:05Z",
      "diff_hunk" : "@@ -124,6 +132,35 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        assert(IsPeerRegistered(peer_id));\n+        LOCK(m_txreconciliation_mutex);\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036141026",
      "id" : 1036141026,
      "line" : 217,
      "node_id" : "PRRC_kwDOABII5849wkHi",
      "original_commit_id" : "624e0988058e90537e1d1066a9c4528e4f1eecd1",
      "original_line" : 217,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 134,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036141026/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036141026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036143555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036143555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You should really use our own PRNG (`FastRandomContext`), not the standard library built-in one which has no guarantees about its quality or performance. If you really can't use FastRandomContext for some reason, use C++ RNG functions, not C ones (`rand()` is not thread-safe, in addition to possibly being poor quality).",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:50:07Z",
      "diff_hunk" : "@@ -154,6 +297,77 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = floor(flood_targets);\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer, at least assuming a static list\n+        // of peers. For this function that means no randomness.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external\n+        // observer. This is achieved by hashing the txid.\n+        //\n+        // Say, we have 2.4 targets out of 20 inbound peers, the wtixd hash is 217, and our peer_id\n+        // holds peer_position in the list of inbound peers.\n+        // We will compute 217 % 20 = 17, as if it was a \"starting_point\", from which we see if\n+        // the target is within a range of 2.4. It's impossible for the range to exceed\n+        // the bounds because of how we computed them in the first place.\n+        // For that, we need to check the following:\n+        // 1. If 17 <= peer_position < 19, return true.\n+        // 2. If peer_position = 19, roll the dice with the remaining probability (0.4).\n+        // 3. Otherwise, return false.\n+        const size_t starting_point = txidHasher(wtxid) % eligible_peers.size();\n+        if (starting_point <= peer_position && peer_position < starting_point + round_down_flood_targets) {\n+            return true;\n+        } else if (peer_position == starting_point + round_down_flood_targets) {\n+            return rand() < (flood_targets - round_down_flood_targets) * RAND_MAX;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036143555",
      "id" : 1036143555,
      "in_reply_to_id" : 1020190507,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wkvD",
      "original_commit_id" : "913c2cbcea58696237760c51f55acee9d91eb186",
      "original_line" : 360,
      "original_position" : 341,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036143555/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:58:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036143555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036145460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036145460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This creates a copy of the `TxReconciliationState`. Sure you don't want to get a reference here?",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:51:40Z",
      "diff_hunk" : "@@ -178,6 +198,69 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036145460",
      "id" : 1036145460,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wlM0",
      "original_commit_id" : "51f1c190762e9283d91297a82704e0d90fe0a8fb",
      "original_line" : 207,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036145460/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036145460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036146412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036146412"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Style: `m_txid_hasher`.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:52:15Z",
      "diff_hunk" : "@@ -72,6 +86,12 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036146412",
      "id" : 1036146412,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wlbs",
      "original_commit_id" : "51f1c190762e9283d91297a82704e0d90fe0a8fb",
      "original_line" : 93,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036146412/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036146412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036149162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036149162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for `floor()` here. Casting a floating-point type to integer type will automatically round down.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-11-30T15:54:20Z",
      "diff_hunk" : "@@ -178,6 +198,69 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        LOCK(m_txreconciliation_mutex);\n+        const auto recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = floor(flood_targets);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1036149162",
      "id" : 1036149162,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wmGq",
      "original_commit_id" : "51f1c190762e9283d91297a82704e0d90fe0a8fb",
      "original_line" : 235,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1199573032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036149162/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T15:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036149162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038334384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038334384"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment could be descriptive of actually what is contains and which protocol phase it's triggering (as other p2p messages coments). From the BIP:  \"The reqrecon message initiates a reconciliation round\" ",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T16:49:28Z",
      "diff_hunk" : "@@ -264,6 +264,11 @@ extern const char* WTXIDRELAY;\n  * txreconciliation, as described by BIP 330.\n  */\n extern const char* SENDTXRCNCL;\n+/**\n+ * Contains a 4-byte local reconciliation set size and 4-byte q-coefficient.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038334384",
      "id" : 1038334384,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII584947mw",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 268,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 1202785461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038334384/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T18:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038334384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038404614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038404614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you can use the same wording than the BIP here \"The initiator of the P2P connection assumes the role of reconciliation initiator\" otherwise it's obscure how the initiator/responder overlaps with connection direction.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T18:17:56Z",
      "diff_hunk" : "@@ -121,26 +201,181 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                     \"local_set_size=%i\\n\",\n+                         peer_id, local_set_size);\n+\n+                // In future, Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038404614",
      "id" : 1038404614,
      "line" : 314,
      "node_id" : "PRRC_kwDOABII58495MwG",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 314,
      "original_position" : 234,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 234,
      "pull_request_review_id" : 1202785461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038404614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T18:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038404614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038421101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038421101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have you considered to enforce policy checks like feefilter at `REQTXRCNCL` sending instead of at reconciliation set fulfilling in INV sending ?\r\n\r\nDue to `RECON_REQUEST_INTERVAL`, I think some transactions could become stalled, wasting bandwidth in case of fast-paced mempool congestion change (not to exclude when we see few transactions issuers on the network provoking spikes by themselves). Though if correct, more likely a marginal performance improvement better left for follow-up. ",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T18:33:42Z",
      "diff_hunk" : "@@ -53,6 +90,17 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038421101",
      "id" : 1038421101,
      "line" : 94,
      "node_id" : "PRRC_kwDOABII58495Qxt",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 94,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1202785461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038421101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T18:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038421101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038424477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038424477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can update this logger and few other to `BCLog::TXRECONCILIATION`",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T18:38:27Z",
      "diff_hunk" : "@@ -121,26 +201,181 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038424477",
      "id" : 1038424477,
      "line" : 221,
      "node_id" : "PRRC_kwDOABII58495Rmd",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 221,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 138,
      "pull_request_review_id" : 1202785461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038424477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T18:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038424477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038465392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038465392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If adding is logged, maybe also log removal similarly?",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T19:34:22Z",
      "diff_hunk" : "@@ -124,6 +132,33 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038465392",
      "id" : 1038465392,
      "line" : 232,
      "node_id" : "PRRC_kwDOABII58495blw",
      "original_commit_id" : "99acf14cf4aa66167f826de6b1d6044c5cc3dc85",
      "original_line" : 159,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 43,
      "pull_request_review_id" : 1202979648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038465392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T23:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038465392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038564473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038564473"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Using `==` to compare floating-point numbers seems not ideal due to precision issues, but it seems like we can never hit the return here anyway since we assert that `eligible_peers.size() > 0` above, so maybe the entire line could be deleted or be an assert?",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T21:42:31Z",
      "diff_hunk" : "@@ -182,6 +202,70 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038564473",
      "id" : 1038564473,
      "line" : 337,
      "node_id" : "PRRC_kwDOABII58495zx5",
      "original_commit_id" : "89beb9043ec8a32311c3e99af2f230553a3f448e",
      "original_line" : 236,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1202979648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038564473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T23:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038564473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038589117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038589117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "since you later use `insecure_rand.randrange`, \"no randomness\" seems a bit misleading.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T22:05:42Z",
      "diff_hunk" : "@@ -182,6 +202,70 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer, at least assuming a static list\n+        // of peers. For this function that means no randomness.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038589117",
      "id" : 1038589117,
      "line" : 347,
      "node_id" : "PRRC_kwDOABII584955y9",
      "original_commit_id" : "89beb9043ec8a32311c3e99af2f230553a3f448e",
      "original_line" : 246,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 88,
      "pull_request_review_id" : 1202979648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038589117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T23:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038589117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038591870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038591870"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: wtxid",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T22:09:57Z",
      "diff_hunk" : "@@ -182,6 +202,70 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer, at least assuming a static list\n+        // of peers. For this function that means no randomness.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external\n+        // observer. This is achieved by hashing the txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038591870",
      "id" : 1038591870,
      "line" : 349,
      "node_id" : "PRRC_kwDOABII584956d-",
      "original_commit_id" : "89beb9043ec8a32311c3e99af2f230553a3f448e",
      "original_line" : 248,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 90,
      "pull_request_review_id" : 1202979648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038591870/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T23:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038591870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038600759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038600759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think I understand this algorithm yet. Say we have 20 inbound peers (0...19), as in the example. What if the starting point is 19 because of the hash of the wtxid? Then we'd only flood the tx to peer 19, but not to peer 0 (because the algorithm doesn't wrap around) - so we'd flood it to 1 target out of 20, not meeting the goal of flooding to 2.4 targets even ignoring the fraction - is that intended?",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-02T22:29:22Z",
      "diff_hunk" : "@@ -182,6 +202,70 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1038600759",
      "id" : 1038600759,
      "line" : 345,
      "node_id" : "PRRC_kwDOABII584958o3",
      "original_commit_id" : "89beb9043ec8a32311c3e99af2f230553a3f448e",
      "original_line" : 244,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 86,
      "pull_request_review_id" : 1202979648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038600759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T23:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038600759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039262264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039262264"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment was outdated, i think it's not needed here at all... deleting for now.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-05T07:55:53Z",
      "diff_hunk" : "@@ -121,26 +201,181 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::NET, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                     \"local_set_size=%i\\n\",\n+                         peer_id, local_set_size);\n+\n+                // In future, Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039262264",
      "id" : 1039262264,
      "in_reply_to_id" : 1038404614,
      "line" : 314,
      "node_id" : "PRRC_kwDOABII58498eI4",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 314,
      "original_position" : 234,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 234,
      "pull_request_review_id" : 1204047515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039262264/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T07:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039262264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039265857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039265857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would largely complicate the code I think.... Policy check stuff should be moved out of `net_processing.cpp`.\r\nYeah, I see your concern (although I tested Erlay in mainnet and it was ok), let's see if other reviewers think it's needed now.",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-05T08:00:28Z",
      "diff_hunk" : "@@ -53,6 +90,17 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039265857",
      "id" : 1039265857,
      "in_reply_to_id" : 1038421101,
      "line" : 94,
      "node_id" : "PRRC_kwDOABII58498fBB",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 94,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1204052484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039265857/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T08:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039265857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039272601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039272601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The removal is currently per-tx (not batched), so it would make the logs really annoying... Which raises another question: should I refactor it to make it batched where possible (on hearing INV batch from the given peer)?",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-05T08:09:50Z",
      "diff_hunk" : "@@ -124,6 +132,33 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid: txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+            \"Now the set contains %i transactions.\\n\", added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039272601",
      "id" : 1039272601,
      "in_reply_to_id" : 1038465392,
      "line" : 232,
      "node_id" : "PRRC_kwDOABII58498gqZ",
      "original_commit_id" : "99acf14cf4aa66167f826de6b1d6044c5cc3dc85",
      "original_line" : 159,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 43,
      "pull_request_review_id" : 1204063482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039272601/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T08:09:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039272601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039308165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039308165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You are right, it is broken. At least it was documented well enough you found the issue :)\r\n",
      "commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "created_at" : "2022-12-05T08:47:43Z",
      "diff_hunk" : "@@ -182,6 +202,70 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // We assume that reconciliation is always initiated from inbound to outbound to avoid\n+        // code complexity.\n+        std::vector<NodeId> eligible_peers;\n+\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            if (flood_targets == 0) return false;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1039308165",
      "id" : 1039308165,
      "in_reply_to_id" : 1038600759,
      "line" : 345,
      "node_id" : "PRRC_kwDOABII58498pWF",
      "original_commit_id" : "89beb9043ec8a32311c3e99af2f230553a3f448e",
      "original_line" : 244,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 86,
      "pull_request_review_id" : 1204115844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039308165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-05T08:47:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1039308165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041146278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041146278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would suggest not to have an assert here. Generally (imo) we should only add asserts when crashing the node is better than continuing. In this case simply adding a `if(!IsPeerRegistered()) return;` is better than crashing if the user of the API makes a mistake. You would be treating non-existence of the peer the same as the peer having an empty set (i.e. nothing is removed as it didn't exist in the first place).\r\n\r\nAdditionally, the way you are using this API right now is not generally safe.\r\n```c++\r\nif (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pfrom.GetId())) {\r\n    m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), wtxid);\r\n}\r\n```\r\n\r\nThe peer could be de-registered from the tracker in between the `IsPeerRegistered` and `TryRemovingFromSet` calls causing the node to crash for no good reason. This is only safe right now because `cs_main` is held here as well as when a peer is forgotten from the tracker. Since the tracker has its own mutex it should not rely on another mutex such as `cs_main`.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T15:48:37Z",
      "diff_hunk" : "@@ -121,26 +201,184 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid : txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+                                          \"Now the set contains %i transactions.\\n\",\n+                 added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041146278",
      "id" : 1041146278,
      "line" : 230,
      "node_id" : "PRRC_kwDOABII584-DqGm",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 230,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 147,
      "pull_request_review_id" : 1206848088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041146278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041146278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041165539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041165539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would make sense to move this block to its own function. This entire block for the tx announcement logic in SendMessages is already quite big.\r\n\r\nMaybe this can even move to the tracker?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T16:04:46Z",
      "diff_hunk" : "@@ -5668,8 +5714,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041165539",
      "id" : 1041165539,
      "line" : 5725,
      "node_id" : "PRRC_kwDOABII584-Duzj",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5725,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 1206848088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041165539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041165539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041171241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041171241"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same thing here about the assert.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T16:09:35Z",
      "diff_hunk" : "@@ -121,26 +201,184 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041171241",
      "id" : 1041171241,
      "line" : 213,
      "node_id" : "PRRC_kwDOABII584-DwMp",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 213,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 130,
      "pull_request_review_id" : 1206848088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041171241/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041171241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041434849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041434849"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "One more conceptual question for the flooding algorithm:\r\nDoesn't this still leak internal order by flooding preferentially to adjacent nodes in `eligible_peers` if `flood_targets > 1`?\r\n\r\nWould it be a simpler alternative to have a deterministic randomizer that takes the wtxid, and then pick `flood_targets` random peers (and pick a last one only with an appropiate probability if `flood_targets` is not an integer), in the same way that way `PeerManagerImpl::RelayAddress()` picks 2 peers for addr relay? (but without the 24h reset happening there)",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T20:38:07Z",
      "diff_hunk" : "@@ -183,6 +203,72 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        std::vector<NodeId> eligible_peers;\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041434849",
      "id" : 1041434849,
      "line" : 344,
      "node_id" : "PRRC_kwDOABII584-Ewjh",
      "original_commit_id" : "ffbb2b814e82284c7c77c5a5b23058cbc7c0149c",
      "original_line" : 243,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1207285454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041434849/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T23:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041434849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041516794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041516794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Trying to understand commit 869c6824235ff2af09d24b13cfab9a6cabd52b00: \"It's possible that a parent will be scheduled to relay same time as child, but a child arrives earlier. \"\r\nIs this only possible with reconciliation? The previous commit tries to make sure that the child is also scheduled for recon, if the parent was - so can it only happen in the case where the recon set is at max capacity?\r\n\r\nAlso, since now twice as many entries will be saved in `m_recently_announced_invs`, does it need a larger capacity?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T22:16:45Z",
      "diff_hunk" : "@@ -5678,7 +5678,11 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041516794",
      "id" : 1041516794,
      "line" : 5720,
      "node_id" : "PRRC_kwDOABII584-FEj6",
      "original_commit_id" : "869c6824235ff2af09d24b13cfab9a6cabd52b00",
      "original_line" : 5684,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1207285454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041516794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T23:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041516794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041544419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041544419"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Commit 9f64cfe63e3b833e0f9faf17004cf51c4c925aec:\r\n\"Note that for privacy reasons the ratio between inbound and outbound\r\ndelays matter much more than the actual delays. That ratio is preserved\r\nhere, so it is not a privacy degradation.\"\r\nThe ratio is not exactly preserved, the old one was 5s/2s, now it's 2s/1s.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T22:45:45Z",
      "diff_hunk" : "@@ -147,12 +147,29 @@ static constexpr auto AVG_ADDRESS_BROADCAST_INTERVAL{30s};\n /** Delay between rotating the peers we relay a particular address to */\n static constexpr auto ROTATE_ADDR_RELAY_DEST_INTERVAL{24h};\n /** Average delay between trickled inventory transmissions for inbound peers.\n- *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this. */\n+ *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this.\n+ *  For reconciliation peers the delay is chosen according the following\n+ *  considerations:\n+ *  1. Reconciliation. When the transaction is reconciled, this delay is applied to adding to\n+ *     reconciliation sets, not actual reconciliation (less frequent). That should happen rather\n+ *     fast, so that sets are in sync and reconciliation is efficient. At the same time, not too\n+ *     fast to avoid privacy leaks (e.g., infer connections via set probing).\n+ *  2. Low-fanout. In rare cases when the reconciling peer is chosen for low-fanout\n+ *     flooding, it will apply to the actual broadcast. Then, regular trickle considerations apply,\n+ *     but since this is a rare occasion, the following risks are much lower:\n+ *     2a) announcing both ways simultaneously (inefficiency);\n+ *     2b) inference based on the announced transactions (privacy leak).\n+ *     That's why it's ok to make this delay low as well, and lower delay is generally good to\n+ *     facilitate good transaction relay speed when slow reconciliations prevail. */\n static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL{5s};\n+static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON{2s};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041544419",
      "id" : 1041544419,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII584-FLTj",
      "original_commit_id" : "9f64cfe63e3b833e0f9faf17004cf51c4c925aec",
      "original_line" : 165,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1207285454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041544419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T23:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041544419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041586275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041586275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it might be possible for a peer to abuse this logic and prevent us from reconciling with other peers: If an attacker sends a `SENDTXRCNCL` but stalls the `VERACK`, they would be registered and added to `m_queue` - but `SendMessages()` will never get to the part where `REQTXRCNCL` is sent for this peer because we abort early [here](https://github.com/bitcoin/bitcoin/blob/0596aa40f77a630d8a21035856fa5fd6838b292e/src/net_processing.cpp#L5367) before hanshake completion. Therefore, once that peer is in the front of the queue, it won't get cleared and prevents us from reconciling with other peers while connected (up to `DEFAULT_PEER_CONNECT_TIMEOUT = 60` seconds).",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-06T23:40:07Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1041586275",
      "id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-FVhj",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1207285454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041586275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T23:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041586275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042310934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042310934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To clarify, we're considering the scenario in which our peer's fee filter changes between adding tx to `txs_to_reconcile` and sending the `inv` after reconciliation? Given that `RECON_REQUEST_INTERVAL` is 8sec and `AVG_FEEFILTER_BROADCAST_INTERVAL` is 10min, I don't think this is too much of a concern (at least for this PR)?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T14:58:09Z",
      "diff_hunk" : "@@ -53,6 +90,17 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042310934",
      "id" : 1042310934,
      "in_reply_to_id" : 1038421101,
      "line" : 94,
      "node_id" : "PRRC_kwDOABII584-IGcW",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 94,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1208575387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042310934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T14:58:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042310934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042366525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042366525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree, though it wouldn't make sense to have txreconciliation module depend on mempool. Would probably recommend grabbing the txiter ahead of time and passing in the parent wtxids.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T15:39:47Z",
      "diff_hunk" : "@@ -5668,8 +5714,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042366525",
      "id" : 1042366525,
      "in_reply_to_id" : 1041165539,
      "line" : 5725,
      "node_id" : "PRRC_kwDOABII584-IUA9",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5725,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 1208638733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042366525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:31:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042366525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042385456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042385456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in ffbb2b814e82284c7c77c5a5b23058cbc7c0149c:\r\n\r\nBased on this, is the \"The requirements to this algorithm is the following: 1. Every transaction should be assigned to *some* peer.\" a hard requirement? If so, it seems the logic in f0685a1781 net_processing if recon parent -> recon child seems to break this, since you might have chosen just 1 peer to flood the child to, but then switch to recon because you're reconing the parent with that peer. It doesn't seem like `ShouldFloodTo` uses any state about whether we've chosen other peers for flooding, so we might end up not flooding the tx to anybody? Am I missing something / is this okay?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T15:54:24Z",
      "diff_hunk" : "@@ -17,6 +19,41 @@ namespace {\n const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n \n+/**\n+ * Announce transactions via full wtxid to a limited number of inbound and outbound peers.\n+ * Justification for these values are provided here:\n+ * https://github.com/naumenkogs/txrelaysim/issues/7#issuecomment-902165806 */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS = 1;\n+/**\n+ * If there's a chance a transaction is not streamlined along the first couple hops, it would take\n+ *  very long to relay.\n+ */\n+static_assert(OUTBOUND_FANOUT_DESTINATIONS >= 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042385456",
      "id" : 1042385456,
      "line" : 32,
      "node_id" : "PRRC_kwDOABII584-IYow",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 32,
      "original_position" : 25,
      "original_start_line" : 29,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 25,
      "pull_request_review_id" : 1208638733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042385456/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 29,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-07T16:31:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042385456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042412529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042412529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC with this PR we'll request reconciliation with each other but since no `NetMsgType::REQTXRCNCL` handling is added, we ignore the request. That's fine, but should we also have the logic for falling back to flooding the wtxids in the reconciliation set when it gets full / after a timeout?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T16:16:45Z",
      "diff_hunk" : "@@ -5703,11 +5835,28 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    if (!txs_to_reconcile.empty()) {\n+                        m_txreconciliation->AddToSet(pto->GetId(), txs_to_reconcile);\n+                    }\n                 }\n         }\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload() && m_txreconciliation) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042412529",
      "id" : 1042412529,
      "line" : 5851,
      "node_id" : "PRRC_kwDOABII584-IfPx",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5851,
      "original_position" : 220,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 220,
      "pull_request_review_id" : 1208638733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042412529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:31:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042412529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042413082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be useful if this returned the number of added wtxids.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T16:17:17Z",
      "diff_hunk" : "@@ -76,6 +76,35 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042413082",
      "id" : 1042413082,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII584-IfYa",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 84,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 9,
      "pull_request_review_id" : 1208726536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413082/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:28:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042413751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be useful if this returned whether or not the wtxid was removed.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T16:17:50Z",
      "diff_hunk" : "@@ -76,6 +76,35 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if\n+     * the peer just announced the transaction to us.\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042413751",
      "id" : 1042413751,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII584-Ifi3",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 91,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 16,
      "pull_request_review_id" : 1208726536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413751/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:28:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042413751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042417507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042417507"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n```suggestion\r\n    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id, std::chrono::microsecond now);\r\n```\r\n\r\nPassing in the time here would be nice for testing. \r\n* We only have one global mock time currently (globals are always a bit annoying when writing unit/fuzz tests, as you have to reset state after each test)\r\n* The current global mock time is only accurate in intervals of seconds",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T16:21:06Z",
      "diff_hunk" : "@@ -76,6 +76,35 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if\n+     * the peer just announced the transaction to us.\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove);\n+\n+    /**\n+     * Step 2. If it's time to request a reconciliation from the peer, this function will return\n+     * the details of our local state, which should be communicated to the peer so that they better\n+     * know what we need:\n+     * - size of our reconciliation set for the peer\n+     * - our q-coefficient with the peer, formatted to be transmitted as integer value\n+     * If the peer was not previously registered for reconciliations, returns nullopt.\n+     */\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042417507",
      "id" : 1042417507,
      "line" : 101,
      "node_id" : "PRRC_kwDOABII584-Igdj",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 101,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 26,
      "pull_request_review_id" : 1208726536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042417507/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:28:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042417507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042420561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042420561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Adding to this:\r\n\r\nAfaict it's impossible for our fuzzers to exercise this code at the moment. Encapsulating this logic within the TxReconciliationTracker would make that possible.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T16:23:45Z",
      "diff_hunk" : "@@ -5668,8 +5714,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042420561",
      "id" : 1042420561,
      "in_reply_to_id" : 1041165539,
      "line" : 5725,
      "node_id" : "PRRC_kwDOABII584-IhNR",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5725,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 1208726536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042420561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T16:28:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042420561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042464406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042464406"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This throws a `std::bad_variant_access` for peers that aren't fully registered yet (found by the fuzzer).\r\n\r\nMaybe create an internal helper method that only iterates through all fully registered peers/states to avoid this entirely?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-07T17:02:17Z",
      "diff_hunk" : "@@ -121,26 +201,184 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid : txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+                                          \"Now the set contains %i transactions.\\n\",\n+                 added, peer_id, recon_state.m_local_set.size());\n+    }\n+\n+    void TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        recon_state.m_local_set.erase(wtxid_to_remove);\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {\n+                m_queue.pop_front();\n+                m_queue.push_back(peer_id);\n+                UpdateNextReconRequest(current_time);\n+                if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+                recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+                size_t local_set_size = recon_state.m_local_set.size();\n+\n+                LogPrint(BCLog::TXRECONCILIATION, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                                  \"local_set_size=%i\\n\",\n+                         peer_id, local_set_size);\n+\n+                // In future, Q could be recomputed after every reconciliation based on the\n+                // set differences. For now, it provides good enough results without recompute\n+                // complexity, but we communicate it here to allow backward compatibility if\n+                // the value is changed or made dynamic.\n+                return std::make_pair(local_set_size, Q * Q_PRECISION);\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        std::vector<NodeId> eligible_peers;\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042464406",
      "id" : 1042464406,
      "line" : 320,
      "node_id" : "PRRC_kwDOABII584-Ir6W",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 320,
      "original_position" : 240,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 240,
      "pull_request_review_id" : 1208800680,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042464406/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T17:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042464406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1044199932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044199932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought this could happen even without explicit fee filter changes, but rather the following:\r\n1. A transaction marginally passed the given fee filter.\r\n2. In 8 seconds when it's time to send, it doesn't pass the filter, but is sent anyway.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-09T08:26:21Z",
      "diff_hunk" : "@@ -53,6 +90,17 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1044199932",
      "id" : 1044199932,
      "in_reply_to_id" : 1038421101,
      "line" : 94,
      "node_id" : "PRRC_kwDOABII584-PTn8",
      "original_commit_id" : "54777ce347a45fecbf77125d14c3099fffbfa7d4",
      "original_line" : 94,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1211290010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044199932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-09T08:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044199932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1044229932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044229932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Doesn't this still leak internal order by flooding preferentially to adjacent nodes in eligible_peers if flood_targets > 1?\r\n\r\nGood point. Yes. I should think about the fix.\r\n\r\n>Would it be a simpler alternative to have a deterministic randomizer that takes the wtxid, and then pick flood_targets random peers (and pick a last one only with an appropiate probability if flood_targets is not an integer), in the same way that way PeerManagerImpl::RelayAddress() picks 2 peers for addr relay? (but without the 24h reset happening there)\r\n\r\nI'll try.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-09T09:04:17Z",
      "diff_hunk" : "@@ -183,6 +203,72 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        std::vector<NodeId> eligible_peers;\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1044229932",
      "id" : 1044229932,
      "in_reply_to_id" : 1041434849,
      "line" : 344,
      "node_id" : "PRRC_kwDOABII584-Pa8s",
      "original_commit_id" : "ffbb2b814e82284c7c77c5a5b23058cbc7c0149c",
      "original_line" : 243,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1211334700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044229932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-09T09:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044229932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045740922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045740922"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We're talking about someone enabling the `-txreconciliation=1` CLI flag... Why do you think this would be useful for such tester?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-12T12:04:33Z",
      "diff_hunk" : "@@ -5703,11 +5835,28 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    if (!txs_to_reconcile.empty()) {\n+                        m_txreconciliation->AddToSet(pto->GetId(), txs_to_reconcile);\n+                    }\n                 }\n         }\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload() && m_txreconciliation) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045740922",
      "id" : 1045740922,
      "in_reply_to_id" : 1042412529,
      "line" : 5851,
      "node_id" : "PRRC_kwDOABII584-VL16",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5851,
      "original_position" : 220,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 220,
      "pull_request_review_id" : 1213394979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045740922/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T12:04:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045740922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045802684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045802684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see that yet. No matter what happens to this peer, it will be moved to the end of the queue, and the next peer will be requested in couple seconds.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-12T13:02:55Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045802684",
      "id" : 1045802684,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-Va68",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1213502717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045802684/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T13:02:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045802684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045978253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045978253"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I don't see that yet. No matter what happens to this peer, it will be moved to the end of the queue, and the next peer will be requested in couple seconds.\r\n\r\nI was thinking of the following:\r\n1.) Peer X gets connected, sends `SENDTXRCNCL`, RegisterPeer puts it into the back of the queue.\r\n2.) X doesn't send `VERACK`\r\n3.) We do regular reconciliation requests with all other peers of the queue, so now X is in the front of it\r\n4.) Since X is not succesfully connected, `SendMessages` aborts early and we don't reach the code where `REQTXRCNCL` is processed\r\n5.) X won't be removed from the front of the queue,  and we don't request reconciliations from any other peer because of that.\r\n\r\n\r\n",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-12T15:32:01Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045978253",
      "id" : 1045978253,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-WFyN",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1213803271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045978253/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T15:32:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045978253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045980252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045980252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ahhh good point, should be addressed indeed.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-12T15:33:43Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1045980252",
      "id" : 1045980252,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-WGRc",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1213806803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045980252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T15:33:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045980252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1046946611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046946611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a dangerous piece of code... This could also happen if the peer enters IBD again or something.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-13T10:24:05Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1046946611",
      "id" : 1046946611,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-ZyMz",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1215173615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046946611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T10:24:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046946611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1047291134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047291134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah - just to bring this alternative up, if we uncoupled peers and had every peer on its separate timer (instead of a queue), would that lead to major efficiency losses?",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-13T15:13:17Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1047291134",
      "id" : 1047291134,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-bGT-",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1215685753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047291134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T15:13:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047291134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1047538690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047538690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I started with having two separate calls âÂ one for queue management, the other for sending REQTXRCNCL.\r\nI'll submit that shortly. Then I'll think about your idea.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-13T18:04:24Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1047538690",
      "id" : 1047538690,
      "in_reply_to_id" : 1041586275,
      "line" : 250,
      "node_id" : "PRRC_kwDOABII584-cCwC",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 250,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1216141754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047538690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T18:04:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047538690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1051969326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051969326"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">Is this only possible with reconciliation? \r\n\r\nYes I think so\r\n\r\n>so can it only happen in the case where the recon set is at max capacity?\r\n\r\nNot only that. The order is lost when set difference is decoded. The decoding party only knows wtxids and will request them in random order, via a regular INV. The ordering could be handled on the responder side, but I'm afraid it would be hard and messy. I can try though.\r\n\r\nThe logic in the last commit is not super-reliable either, so I think it's better to have belt-and-suspenders like this.\r\n\r\nUnless they break something else of course.\r\n\r\n>Also, since now twice as many entries will be saved in m_recently_announced_invs, does it need a larger capacity?\r\n\r\ngood point.\r\n",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-19T09:18:01Z",
      "diff_hunk" : "@@ -5678,7 +5678,11 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1051969326",
      "id" : 1051969326,
      "in_reply_to_id" : 1041516794,
      "line" : 5720,
      "node_id" : "PRRC_kwDOABII584-s8cu",
      "original_commit_id" : "869c6824235ff2af09d24b13cfab9a6cabd52b00",
      "original_line" : 5684,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1222540790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051969326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T09:18:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1051969326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052002193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052002193"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">Every transaction should be assigned to some peer.\" a hard requirement?\r\n\r\nI meant to relay in *some way* (either flooded or reconciled), so that the transaction doesn't get stuck. That's it.\r\nThat resolves your question right? Fixing code comment for now.",
      "commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "created_at" : "2022-12-19T09:49:43Z",
      "diff_hunk" : "@@ -17,6 +19,41 @@ namespace {\n const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n \n+/**\n+ * Announce transactions via full wtxid to a limited number of inbound and outbound peers.\n+ * Justification for these values are provided here:\n+ * https://github.com/naumenkogs/txrelaysim/issues/7#issuecomment-902165806 */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS = 1;\n+/**\n+ * If there's a chance a transaction is not streamlined along the first couple hops, it would take\n+ *  very long to relay.\n+ */\n+static_assert(OUTBOUND_FANOUT_DESTINATIONS >= 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052002193",
      "id" : 1052002193,
      "in_reply_to_id" : 1042385456,
      "line" : 32,
      "node_id" : "PRRC_kwDOABII584-tEeR",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 32,
      "original_position" : 25,
      "original_start_line" : 29,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 25,
      "pull_request_review_id" : 1222589735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052002193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 29,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-19T09:49:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052002193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052114025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you review if 02e480d174e4edb1ffedb643fc454ad9b77e9001 is any better? Looking at the following commit may add some useful context 15006207099882aa73c18738e5013bf0c313be93",
      "commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "created_at" : "2022-12-19T11:46:54Z",
      "diff_hunk" : "@@ -183,6 +203,72 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool ShouldFloodTo(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        std::vector<NodeId> eligible_peers;\n+        const bool we_initiate = recon_state.m_we_initiate;\n+        // Find all peers of the same reconciliation direction.\n+        std::for_each(m_states.begin(), m_states.end(),\n+                      [&eligible_peers, we_initiate](auto indexed_state) {\n+                          const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+                          if (cur_state.m_we_initiate == we_initiate) eligible_peers.push_back(indexed_state.first);\n+                      });\n+\n+        // We found the peer above, so it must be in this list.\n+        assert(eligible_peers.size() >= 1);\n+\n+        // Flooding to a fraction (say, 10% of peers) is equivalent to taking the first 10% of\n+        // of the eligible peers. Sometimes it won't round to a \"full peer\", in that case we'll\n+        // roll the dice with the corresponding probability.\n+        double flood_targets;\n+        if (we_initiate) {\n+            flood_targets = OUTBOUND_FANOUT_DESTINATIONS;\n+        } else {\n+            flood_targets = eligible_peers.size() * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        }\n+\n+        const size_t round_down_flood_targets = flood_targets;\n+\n+        const auto it = std::find(eligible_peers.begin(), eligible_peers.end(), peer_id);\n+        Assume(it != eligible_peers.end());\n+        const size_t peer_position = it - eligible_peers.begin();\n+        // The requirements to this algorithm is the following:\n+        // 1. Every transaction should be assigned to *some* peer.\n+        // 2. The choice doesn't leak the internal order of peers (m_states) to the external",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052114025",
      "id" : 1052114025,
      "in_reply_to_id" : 1041434849,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-tfxp",
      "original_commit_id" : "ffbb2b814e82284c7c77c5a5b23058cbc7c0149c",
      "original_line" : 243,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1222752080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T11:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052114496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could your review 15006207099882aa73c18738e5013bf0c313be93 separately? If that's roughly what you're asked for and you are satisfied, I will squash into the original commit.",
      "commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "created_at" : "2022-12-19T11:47:29Z",
      "diff_hunk" : "@@ -5668,8 +5714,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052114496",
      "id" : 1052114496,
      "in_reply_to_id" : 1041165539,
      "line" : 5735,
      "node_id" : "PRRC_kwDOABII584-tf5A",
      "original_commit_id" : "e480bed66158971493c2af51a72acaec582e8f01",
      "original_line" : 5735,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 173,
      "pull_request_review_id" : 1222752746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114496/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T11:47:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052114496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052392630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052392630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e894824cea7bbb835c762fc57b9523f76c51339f\r\ncommented code here",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2022-12-19T16:16:07Z",
      "diff_hunk" : "@@ -5336,6 +5365,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     if (!peer) return false;\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // We must look into the reconciliation queue first. Since the queue applies to all peers,\n+    // this peer might block other reconciliation if we don't make this call regularly and\n+    // unconditionally.\n+    bool reconcile = false;\n+    if (m_txreconciliation) {\n+        // reconcile = m_txreconciliation->IsPeerNextToReconcileWith(pto->GetId(), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052392630",
      "id" : 1052392630,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ujy2",
      "original_commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "original_line" : 5375,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1223170187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052392630/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T18:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052392630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052393745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052393745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e894824cea7bbb835c762fc57b9523f76c51339f no need for parentheses",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2022-12-19T16:17:14Z",
      "diff_hunk" : "@@ -5703,11 +5788,30 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             tx_relay->m_tx_inventory_known_filter.insert(txid);\n                         }\n                     }\n+\n+                    if (!txs_to_reconcile.empty()) {\n+                        m_txreconciliation->AddToSet(pto->GetId(), txs_to_reconcile);\n+                    }\n                 }\n         }\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n+                if (reconcile) {\n+                    const auto reconciliation_request_params = m_txreconciliation->InitiateReconciliationRequest(pto->GetId());\n+                    if (reconciliation_request_params) {\n+                        const auto [local_set_size, local_q_formatted] = (*reconciliation_request_params);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052393745",
      "id" : 1052393745,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ukER",
      "original_commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "original_line" : 5808,
      "original_position" : 220,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1223170187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052393745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T18:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052393745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052395138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052395138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "02e480d174e4edb1ffedb643fc454ad9b77e9001\r\n```suggestion\r\n```",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2022-12-19T16:18:42Z",
      "diff_hunk" : "@@ -124,23 +204,273 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddPeerToQueue(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        auto recon_state = m_states.find(peer_id);\n+\n+        if (recon_state == m_states.end()) return;\n+\n+        if (!std::holds_alternative<TxReconciliationState>(recon_state->second)) {\n+            return;\n+        }\n+\n+        m_queue.push_back(peer_id);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added peer=%d to the queue\\n\",\n+                      peer_id);\n+    }\n+\n+    size_t AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return 0;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid : txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+                                          \"Now the set contains %i transactions.\\n\",\n+                 added, peer_id, recon_state.m_local_set.size());\n+        return added;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.erase(wtxid_to_remove) > 0;\n+    }\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        if (m_queue.empty()) return false;\n+\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_next_recon_request <= now && m_queue.front() == peer_id) {\n+            Assume(recon_state.m_we_initiate);\n+            m_queue.pop_front();\n+            m_queue.push_back(peer_id);\n+\n+            // If the phase is not NONE, the peer hasn't responded to the previous reconciliation.\n+            // A laggy peer should not affect other peers.\n+            //\n+            // This doesn't prevent from a malicious peer gaming this by staying in this state\n+            // all the time somehow.\n+            if (recon_state.m_phase_init_by_us == Phase::NONE) UpdateNextReconRequest(now);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> InitiateReconciliationRequest(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+        recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+        size_t local_set_size = recon_state.m_local_set.size();\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                          \"local_set_size=%i\\n\",\n+                 peer_id, local_set_size);\n+\n+        // In future, Q could be recomputed after every reconciliation based on the\n+        // set differences. For now, it provides good enough results without recompute\n+        // complexity, but we communicate it here to allow backward compatibility if\n+        // the value is changed or made dynamic.\n+        return std::make_pair(local_set_size, Q * Q_PRECISION);\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool IsAlreadyInPeerSet(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        return recon_state.m_local_set.count(wtxid) > 0;\n+    }\n+\n+    std::vector<NodeId> GetFloodTargets(const uint256& wtxid, CSipHasher deterministic_randomizer,\n+                                        size_t all_inbound_peers, size_t already_flooded_to_outbound) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        auto try_flood_candidate = [](CSipHasher deterministic_randomizer, std::vector<std::pair<uint64_t, NodeId>> best_peers,\n+                                      const size_t limit, const std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> candidate) {\n+            const auto& cur_state = std::get<TxReconciliationState>(candidate.second);\n+            uint64_t hash_key = std::min<uint64_t>(deterministic_randomizer.Write(cur_state.m_k0).Finalize(), 1);\n+\n+            for (size_t i = 0; i < limit; ++i) {\n+                if (hash_key > best_peers[i].first) {\n+                    std::copy(best_peers.begin() + i, best_peers.begin() + limit - 1, best_peers.begin() + i + 1);\n+                    best_peers[i] = std::make_pair(hash_key, candidate.first);\n+                    break;\n+                }\n+            }\n+        };\n+\n+        const double inbound_destinations = all_inbound_peers * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        const size_t outbound_destinations = std::min<int>(0, OUTBOUND_FANOUT_DESTINATIONS - already_flooded_to_outbound);\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_inbound_peers(size_t(inbound_destinations) + 1, std::make_pair(0, 0));\n+        std::vector<std::pair<uint64_t, NodeId>> best_outbound_peers(outbound_destinations, std::make_pair(0, 0));\n+        ;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052395138",
      "id" : 1052395138,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ukaC",
      "original_commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "original_line" : 375,
      "original_position" : 292,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1223170187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052395138/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T18:36:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052395138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052397812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052397812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e894824cea7bbb835c762fc57b9523f76c51339f Forgotten todo?",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2022-12-19T16:21:13Z",
      "diff_hunk" : "@@ -76,6 +76,44 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /** TODO */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052397812",
      "id" : 1052397812,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ulD0",
      "original_commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "original_line" : 79,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : null,
      "pull_request_review_id" : 1223170187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052397812/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-19T18:36:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052397812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052398233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052398233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15006207099882aa73c18738e5013bf0c313be93\r\nShould maybe pass by const ref for `parents_wtxids` and `wtxids_to_reconcile`, same for `TxReconciliationTracker::ShouldFloodTo`.",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2022-12-19T16:21:40Z",
      "diff_hunk" : "@@ -124,23 +204,273 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    void AddPeerToQueue(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        auto recon_state = m_states.find(peer_id);\n+\n+        if (recon_state == m_states.end()) return;\n+\n+        if (!std::holds_alternative<TxReconciliationState>(recon_state->second)) {\n+            return;\n+        }\n+\n+        m_queue.push_back(peer_id);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added peer=%d to the queue\\n\",\n+                      peer_id);\n+    }\n+\n+    size_t AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return 0;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid : txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;\n+        }\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Added %i new transactions to the reconciliation set for peer=%d. \" /* Continued */\n+                                          \"Now the set contains %i transactions.\\n\",\n+                 added, peer_id, recon_state.m_local_set.size());\n+        return added;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.erase(wtxid_to_remove) > 0;\n+    }\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        if (m_queue.empty()) return false;\n+\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_next_recon_request <= now && m_queue.front() == peer_id) {\n+            Assume(recon_state.m_we_initiate);\n+            m_queue.pop_front();\n+            m_queue.push_back(peer_id);\n+\n+            // If the phase is not NONE, the peer hasn't responded to the previous reconciliation.\n+            // A laggy peer should not affect other peers.\n+            //\n+            // This doesn't prevent from a malicious peer gaming this by staying in this state\n+            // all the time somehow.\n+            if (recon_state.m_phase_init_by_us == Phase::NONE) UpdateNextReconRequest(now);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> InitiateReconciliationRequest(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+        recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+        size_t local_set_size = recon_state.m_local_set.size();\n+\n+        LogPrint(BCLog::TXRECONCILIATION, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                          \"local_set_size=%i\\n\",\n+                 peer_id, local_set_size);\n+\n+        // In future, Q could be recomputed after every reconciliation based on the\n+        // set differences. For now, it provides good enough results without recompute\n+        // complexity, but we communicate it here to allow backward compatibility if\n+        // the value is changed or made dynamic.\n+        return std::make_pair(local_set_size, Q * Q_PRECISION);\n+    }\n+\n+    size_t GetPeerSetSize(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        assert(IsPeerRegistered(peer_id));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.size();\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool IsAlreadyInPeerSet(NodeId peer_id, const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        return recon_state.m_local_set.count(wtxid) > 0;\n+    }\n+\n+    std::vector<NodeId> GetFloodTargets(const uint256& wtxid, CSipHasher deterministic_randomizer,\n+                                        size_t all_inbound_peers, size_t already_flooded_to_outbound) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        auto try_flood_candidate = [](CSipHasher deterministic_randomizer, std::vector<std::pair<uint64_t, NodeId>> best_peers,\n+                                      const size_t limit, const std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> candidate) {\n+            const auto& cur_state = std::get<TxReconciliationState>(candidate.second);\n+            uint64_t hash_key = std::min<uint64_t>(deterministic_randomizer.Write(cur_state.m_k0).Finalize(), 1);\n+\n+            for (size_t i = 0; i < limit; ++i) {\n+                if (hash_key > best_peers[i].first) {\n+                    std::copy(best_peers.begin() + i, best_peers.begin() + limit - 1, best_peers.begin() + i + 1);\n+                    best_peers[i] = std::make_pair(hash_key, candidate.first);\n+                    break;\n+                }\n+            }\n+        };\n+\n+        const double inbound_destinations = all_inbound_peers * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        const size_t outbound_destinations = std::min<int>(0, OUTBOUND_FANOUT_DESTINATIONS - already_flooded_to_outbound);\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_inbound_peers(size_t(inbound_destinations) + 1, std::make_pair(0, 0));\n+        std::vector<std::pair<uint64_t, NodeId>> best_outbound_peers(outbound_destinations, std::make_pair(0, 0));\n+        ;\n+\n+        for (auto indexed_state : m_states) {\n+            const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);\n+            if (cur_state.m_we_initiate == true) { // corresponds to connection direction.\n+                try_flood_candidate(deterministic_randomizer, best_outbound_peers, outbound_destinations, indexed_state);\n+            } else {\n+                try_flood_candidate(deterministic_randomizer, best_inbound_peers, inbound_destinations, indexed_state);\n+            }\n+        }\n+\n+        // For inbound peers, it's possible that the last peer was added optimistically,\n+        // so we have to roll the dice now.\n+        FastRandomContext insecure_rand;\n+        if (insecure_rand.randrange(100) > (inbound_destinations - size_t(inbound_destinations)) * 100) {\n+            best_inbound_peers.pop_back();\n+        }\n+\n+\n+        best_inbound_peers.insert(best_inbound_peers.end(), best_outbound_peers.begin(), best_outbound_peers.end());\n+        std::vector<NodeId> result;\n+        std::for_each(best_inbound_peers.begin(), best_inbound_peers.end(),\n+                      [&result](auto best_peer) {\n+                          if (best_peer.first != 0) result.push_back(best_peer.second);\n+                      });\n+        return result;\n+    }\n+\n+    // For a given peer, see whether the transaction should be flooded\n+    bool ShouldFloodTo(const uint256& wtxid, const std::vector<uint256> parents_wtxids,\n+                       const std::vector<uint256> wtxids_to_reconcile, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1052398233",
      "id" : 1052398233,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-ulKZ",
      "original_commit_id" : "15006207099882aa73c18738e5013bf0c313be93",
      "original_line" : 405,
      "original_position" : 322,
      "original_start_line" : 404,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1223170187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052398233/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-19T18:36:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1052398233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@aureleoules fixed all you pointed out. Note that the last two commits are WIP, as I'm looking for a confirmation that those two are indeed an improvement. If yes, then I will squash them with the earlier commits, add tests, etc.\r\nYou could state your opinion about them too (each commit separately) :).",
      "created_at" : "2022-12-20T08:32:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1359001649",
      "id" : 1359001649,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585RALgx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1359001649/reactions"
      },
      "updated_at" : "2022-12-20T08:32:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1359001649",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114818128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114818128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't know if transaction received through BIP152's `BLOCKTXN` should be `TryRemovingFromSet()`.",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T18:53:50Z",
      "diff_hunk" : "@@ -3699,6 +3720,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\n                 }\n+                if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pfrom.GetId()) && gtxid.IsWtxid()) {\n+                    m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), gtxid.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114818128",
      "id" : 1114818128,
      "line" : 3724,
      "node_id" : "PRRC_kwDOABII585CcsZQ",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 3724,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 57,
      "pull_request_review_id" : 1309970444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114818128/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114818128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114821225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114821225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the \"fast\" (i.e 2s)  has been reasoned out in the bip or the paper, the section can be referenced too, I think. ",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T18:55:52Z",
      "diff_hunk" : "@@ -145,12 +147,29 @@ static constexpr auto AVG_ADDRESS_BROADCAST_INTERVAL{30s};\n /** Delay between rotating the peers we relay a particular address to */\n static constexpr auto ROTATE_ADDR_RELAY_DEST_INTERVAL{24h};\n /** Average delay between trickled inventory transmissions for inbound peers.\n- *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this. */\n+ *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this.\n+ *  For reconciliation peers the delay is chosen according the following\n+ *  considerations:\n+ *  1. Reconciliation. When the transaction is reconciled, this delay is applied to adding to\n+ *     reconciliation sets, not actual reconciliation (less frequent). That should happen rather\n+ *     fast, so that sets are in sync and reconciliation is efficient. At the same time, not too\n+ *     fast to avoid privacy leaks (e.g., infer connections via set probing).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114821225",
      "id" : 1114821225,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII585CctJp",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 156,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 1309970444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114821225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114821225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114835166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114835166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can add a comment about what `TxReconciliationTracker::IsPeerNextToReconcileWith()` does, like assumptions on peers queue and phase we're in.",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:04:02Z",
      "diff_hunk" : "@@ -76,6 +76,36 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add new transactions we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that those transactions will be reconciled later.\n+     * Returns the number of added transactions (already present transactions won't be added).\n+     *\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    size_t AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if\n+     * the peer just announced the transaction to us.\n+     * Returns whether the wtxid was removed.\n+     *\n+     * The caller *must* check that the peer is registered for reconciliations.\n+     */\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove);\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114835166",
      "id" : 1114835166,
      "line" : 97,
      "node_id" : "PRRC_kwDOABII585Ccwje",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 97,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 22,
      "pull_request_review_id" : 1309970444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114835166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114835166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114866248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114866248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure this new comment still holds with the introduction of `MAX_SET_SIZE=3000`. ",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:35:20Z",
      "diff_hunk" : "@@ -99,7 +99,9 @@ static constexpr int32_t MAX_PEER_TX_REQUEST_IN_FLIGHT = 100;\n /** Maximum number of transactions to consider for requesting, per peer. It provides a reasonable DoS limit to\n  *  per-peer memory usage spent on announcements, while covering peers continuously sending INVs at the maximum\n  *  rate (by our own policy, see INVENTORY_BROADCAST_PER_SECOND) for several minutes, while not receiving\n- *  the actual transaction (from any peer) in response to requests for them. */\n+ *  the actual transaction (from any peer) in response to requests for them.\n+ *  Also limits a maximum number of elements to store in the reconciliation set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114866248",
      "id" : 1114866248,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585Cc4JI",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 103,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 1309970444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114866248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114866248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114877866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114877866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Correct the max set size (`MAX_SET_SIZE`) is enforced by `ShouldFanoutTo()` which happens before the call to `AddToSet()`, don't know if it could be more conservative with another check here. ",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:47:25Z",
      "diff_hunk" : "@@ -121,26 +194,233 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        if (!is_peer_inbound) m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    size_t AddToSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        Assume(txs_to_reconcile.size() > 0);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return 0;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        size_t added = 0;\n+        for (auto& wtxid : txs_to_reconcile) {\n+            added += recon_state.m_local_set.insert(wtxid).second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114877866",
      "id" : 1114877866,
      "line" : 211,
      "node_id" : "PRRC_kwDOABII585Cc6-q",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 211,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 128,
      "pull_request_review_id" : 1309970444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114877866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114877866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114886751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114886751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well we might have some small discrepancy in old code, doesn't seem to matter here.",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:56:19Z",
      "diff_hunk" : "@@ -5576,8 +5701,94 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        // Make a transaction requestable by both txid and wtxid, to avoid making\n+                        // an assumption that a child arrives after the parent.\n+                        State(pto->GetId())->m_recently_announced_invs.insert(txid);\n+                        State(pto->GetId())->m_recently_announced_invs.insert(wtxid);\n+\n+                        bool adding_to_recon_set = false;\n+                        // Check if peer supports reconciliations.\n+                        if (supports_recon) {\n+                            bool flood_target = m_txreconciliation->ShouldFloodTo(wtxid, pto->GetId());\n+\n+                            // Special treatment for unconfirmed transactions with unconfirmed\n+                            // parents.\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            const CTxMemPoolEntry::Parents& parents = (*txiter)->GetMemPoolParentsConst();\n+                            for (const CTxMemPoolEntry& parent : parents) {\n+                                // Two situations are possible here:\n+                                // 1. The parent was fully relayed to the peer earlier.\n+                                // 2. The parent is set for reconciliation and the child is not\n+                                //    in the mempool yet. The child arrives to the mempool and is\n+                                //    flooded. The peer receives the child earlier than the parent.\n+                                // We can differentiate between the two by looking at the recon\n+                                // set: if the set (or the snapshot) contains the parent, the parent\n+                                // is being reconciled (case 2). Then, we add the child to the\n+                                // reconciliation set, so that it doesn't arrive earlier than the\n+                                // parent.\n+                                // If it's the case 1, we proceed as usual by looking at the\n+                                // child's wtxid.\n+                                const uint256 parent_wtxid = parent.GetTx().GetWitnessHash();\n+                                if (m_txreconciliation->CurrentlyReconcilingTx(pto->GetId(), parent_wtxid) ||\n+                                    std::find(txs_to_reconcile.begin(), txs_to_reconcile.end(), parent_wtxid) != txs_to_reconcile.end()) {\n+                                    // Currently reconciling parent tx.\n+                                    // We have the following options to do:\n+                                    // 1. Flood parent+child.\n+                                    // 2. Reconcile parent+child.\n+                                    // 3. Flood parent, reconcile child.\n+                                    // We choose (2) because it has the easiest implementation.\n+                                    // The latency impact is not that bad:\n+                                    // 1. If the parent is in the reocnciliation set, the two\n+                                    // transactions will be relayed at the same time. There is\n+                                    // no point relaying the child faster anyway.\n+                                    // 2. If the parent is in the snapshot, the child will\n+                                    // be reconcilied within the next batch. This would\n+                                    // introduce extra latency (even if by wtxid the child\n+                                    // should have been flooded over this link), but this will\n+                                    // be compensated later: if the delay is non-trivial,\n+                                    // for the next nodes this condition won't be triggered (\n+                                    // parent won't be in the reconciliation set).\n+                                    //\n+                                    // In case of the multiple unconfirmed parents, we will\n+                                    // reconcile if at least one of the parents is being\n+                                    // reconciled.\n+                                    //\n+                                    // Note, the transaction still could be flooded if the\n+                                    // reconciliation set is full (see check below). This\n+                                    // is not the general case and is likely caused by the\n+                                    // issues with the peer, and then we're not responsible\n+                                    // that the package can't pass mempool limitations.\n+                                    flood_target = false;\n+                                    break;\n+                                }\n+                            }\n+\n+                            // Check if reconciliation set is not at capacity for two reasons:\n+                            // - limit sizes of reconciliation sets and short id mappings\n+                            // - limit CPU use for sketch computations\n+                            //\n+                            // Since we reconcile frequently, reaching capacity either means:\n+                            // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+                            // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+                            // We don't care about a laggy peer (1) because we probably can't help them even if we flood transactions.\n+                            // However, exploiting (2) should not prevent us from relaying certain transactions.\n+                            //\n+                            // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+                            const size_t recon_set_size = m_txreconciliation->GetPeerSetSize(pto->GetId());\n+                            if (!flood_target && txs_to_reconcile.size() + recon_set_size < MAX_PEER_TX_ANNOUNCEMENTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114886751",
      "id" : 1114886751,
      "in_reply_to_id" : 998588937,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Cc9Jf",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 5781,
      "original_position" : 334,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1310071886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114886751/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:56:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114886751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114888417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114888417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's accurate with the current comment of warning about less frequent reconciliations introducing high transaction relay latency. Like some trade-off between bandwidth and 0confs UX to be aware, I would say.",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:58:03Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114888417",
      "id" : 1114888417,
      "in_reply_to_id" : 998640600,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Cc9jh",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 39,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 33,
      "pull_request_review_id" : 1310074223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114888417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114888417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114890070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114890070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gotcha, just means the malicious outbound peer will never move forward its own reconciliation. ",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-22T19:59:29Z",
      "diff_hunk" : "@@ -0,0 +1,405 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txreconciliation.h>\n+\n+#include <util/check.h>\n+#include <util/system.h>\n+\n+#include <unordered_map>\n+#include <util/hasher.h>\n+#include <variant>\n+\n+\n+namespace {\n+\n+/** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n+const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+\n+/** Announce transactions via full wtxid to a limited number of inbound and outbound peers. */\n+constexpr double INBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+constexpr double OUTBOUND_FANOUT_DESTINATIONS_FRACTION = 0.1;\n+/** Coefficient used to estimate reconciliation set differences. */\n+constexpr double RECON_Q = 0.25;\n+/**\n+ * Used to convert a floating point reconciliation coefficient q to integer for transmission.\n+ * Specified by BIP-330.\n+ */\n+constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between initiating reconciliations with peers.\n+ * This value allows to reconcile ~(7 tx/s * 8s) transactions during normal operation.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead\n+ * due to reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{8s};\n+\n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum Phase {\n+    NONE,\n+    INIT_REQUESTED,\n+};\n+\n+/**\n+ * Salt (specified by BIP-330) constructed from contributions from both peers. It is used\n+ * to compute transaction short IDs, which are then used to construct a sketch representing a set\n+ * of transactions we want to announce to the peer.\n+ */\n+uint256 ComputeSalt(uint64_t salt1, uint64_t salt2)\n+{\n+    // According to BIP-330, salts should be combined in ascending order.\n+    return (HashWriter(RECON_SALT_HASHER) << std::min(salt1, salt2) << std::max(salt1, salt2)).GetSHA256();\n+}\n+\n+/**\n+ * Keeps track of txreconciliation-related per-peer state.\n+ */\n+class TxReconciliationState\n+{\n+public:\n+    /**\n+     * TODO: This field is public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * Reconciliation protocol assumes using one role consistently: either a reconciliation\n+     * initiator (requesting sketches), or responder (sending sketches). This defines our role.\n+     *\n+     */\n+    bool m_we_initiate;\n+\n+    /**\n+     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n+     * the following commits.\n+     *\n+     * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n+     */\n+    uint64_t m_k0, m_k1;\n+\n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<uint256> m_local_set;\n+\n+    /** Keep track of the reconciliation phase with the peer. */\n+    Phase m_phase_init_by_us{Phase::NONE};\n+\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+};\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txreconciliation_mutex;\n+\n+    /**\n+     * We need a ReconciliationTracker-wide randomness to decide to which peers we should flood a\n+     * given transaction based on a (w)txid.\n+     */\n+    const SaltedTxidHasher txidHasher;\n+\n+    // Local protocol version\n+    uint32_t m_recon_version;\n+\n+    /**\n+     * Keeps track of txreconciliation states of eligible peers.\n+     * For pre-registered peers, the locally generated salt is stored.\n+     * For registered peers, the locally generated salt is forgotten, and the state (including\n+     * \"full\" salt) is stored instead.\n+     */\n+    std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set difference size.\n+     */\n+    std::deque<NodeId> m_queue GUARDED_BY(m_txreconciliation_mutex);\n+\n+    /**\n+     * Make reconciliation requests periodically to make reconciliations efficient.\n+     */\n+    std::chrono::microseconds m_next_recon_request GUARDED_BY(m_txreconciliation_mutex){0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // We have one timer for the entire queue. This is safe because we initiate reconciliations\n+        // with outbound connections, which are unlikely to game this timer in a serious way.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1114890070",
      "id" : 1114890070,
      "in_reply_to_id" : 998653688,
      "line" : 139,
      "node_id" : "PRRC_kwDOABII585Cc99W",
      "original_commit_id" : "5070c97459282346cdcff7af08914c702462fe0d",
      "original_line" : 139,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 95,
      "pull_request_review_id" : 1310077069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114890070/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T19:59:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114890070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1115299326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1115299326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What you described means that the peer clearly has the transaction, thus it can safely be removed from the corresponding set (\"try\" means it's ok if the tx is not there). What's the problem with that?",
      "commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "created_at" : "2023-02-23T07:04:14Z",
      "diff_hunk" : "@@ -3699,6 +3720,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\n                 }\n+                if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pfrom.GetId()) && gtxid.IsWtxid()) {\n+                    m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), gtxid.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1115299326",
      "id" : 1115299326,
      "in_reply_to_id" : 1114818128,
      "line" : 3724,
      "node_id" : "PRRC_kwDOABII585Ceh3-",
      "original_commit_id" : "37a471c986af620f9547d27a466250ed1988c846",
      "original_line" : 3724,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 57,
      "pull_request_review_id" : 1310699173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1115299326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-23T07:04:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1115299326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1135725988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135725988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1042464406",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-14T15:20:01Z",
      "diff_hunk" : "@@ -121,26 +194,204 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        if (!is_peer_inbound) m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added a transaction to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      peer_id, recon_state.m_local_set.size());\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.erase(wtxid_to_remove) > 0;\n+    }\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        if (m_queue.empty()) return false;\n+\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_next_recon_request <= now && m_queue.front() == peer_id) {\n+            Assume(recon_state.m_we_initiate);\n+            m_queue.pop_front();\n+            m_queue.push_back(peer_id);\n+\n+            // If the phase is not NONE, the peer hasn't responded to the previous reconciliation.\n+            // A laggy peer should not affect other peers.\n+            //\n+            // This doesn't prevent from a malicious peer gaming this by staying in this state\n+            // all the time somehow.\n+            if (recon_state.m_phase_init_by_us == Phase::NONE) UpdateNextReconRequest(now);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> InitiateReconciliationRequest(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+        recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+        size_t local_set_size = recon_state.m_local_set.size();\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                                                    \"local_set_size=%i\\n\",\n+                      peer_id, local_set_size);\n+\n+        // In future, Q could be recomputed after every reconciliation based on the\n+        // set differences. For now, it provides good enough results without recompute\n+        // complexity, but we communicate it here to allow backward compatibility if\n+        // the value is changed or made dynamic.\n+        return std::make_pair(local_set_size, Q * Q_PRECISION);\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(const uint256& wtxid, CSipHasher& deterministic_randomizer,\n+                                         bool we_initiate, float limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        // Initiate the randomness here so that it's not influenced by the following code.\n+        double fractional_peer;\n+        const size_t targets = size_t(std::modf(limit, &fractional_peer)) + 1;\n+        const bool drop_peer_if_extra = deterministic_randomizer.Finalize() > fractional_peer * float(UINT64_MAX);\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers(targets, std::make_pair(0, 0));\n+\n+        auto try_fanout_candidate = [&best_peers, &deterministic_randomizer, targets](\n+                                        const std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> candidate) {\n+            const auto& cur_state = std::get<TxReconciliationState>(candidate.second);\n+            uint64_t hash_key = std::max<uint64_t>(deterministic_randomizer.Write(cur_state.m_k0).Finalize(), 1);\n+\n+            for (size_t i = 0; i < targets; ++i) {\n+                if (hash_key > best_peers[i].first) {\n+                    std::copy(best_peers.begin() + i, best_peers.begin() + targets - 1, best_peers.begin() + i + 1);\n+                    best_peers[i] = std::make_pair(hash_key, candidate.first);\n+                    break;\n+                }\n+            }\n+        };\n+\n+        for (auto indexed_state : m_states) {\n+            const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1135725988",
      "id" : 1135725988,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII585Dsc2k",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 342,
      "original_position" : 262,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 262,
      "pull_request_review_id" : 1339558296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135725988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-14T15:31:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135725988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1135765960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135765960"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use [`std::visit`](https://en.cppreference.com/w/cpp/utility/variant/visit).",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-14T15:44:09Z",
      "diff_hunk" : "@@ -121,26 +194,204 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        if (!is_peer_inbound) m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added a transaction to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      peer_id, recon_state.m_local_set.size());\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.erase(wtxid_to_remove) > 0;\n+    }\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        if (m_queue.empty()) return false;\n+\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_next_recon_request <= now && m_queue.front() == peer_id) {\n+            Assume(recon_state.m_we_initiate);\n+            m_queue.pop_front();\n+            m_queue.push_back(peer_id);\n+\n+            // If the phase is not NONE, the peer hasn't responded to the previous reconciliation.\n+            // A laggy peer should not affect other peers.\n+            //\n+            // This doesn't prevent from a malicious peer gaming this by staying in this state\n+            // all the time somehow.\n+            if (recon_state.m_phase_init_by_us == Phase::NONE) UpdateNextReconRequest(now);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    std::optional<std::pair<uint16_t, uint16_t>> InitiateReconciliationRequest(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (recon_state.m_phase_init_by_us != Phase::NONE) return std::nullopt;\n+        recon_state.m_phase_init_by_us = Phase::INIT_REQUESTED;\n+\n+        size_t local_set_size = recon_state.m_local_set.size();\n+\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Initiate reconciliation with peer=%d with the following params: \" /* Continued */\n+                                                                    \"local_set_size=%i\\n\",\n+                      peer_id, local_set_size);\n+\n+        // In future, Q could be recomputed after every reconciliation based on the\n+        // set differences. For now, it provides good enough results without recompute\n+        // complexity, but we communicate it here to allow backward compatibility if\n+        // the value is changed or made dynamic.\n+        return std::make_pair(local_set_size, Q * Q_PRECISION);\n+    }\n+\n     void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n         if (m_states.erase(peer_id)) {\n+            m_queue.erase(std::remove(m_queue.begin(), m_queue.end(), peer_id), m_queue.end());\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(const uint256& wtxid, CSipHasher& deterministic_randomizer,\n+                                         bool we_initiate, float limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        // Initiate the randomness here so that it's not influenced by the following code.\n+        double fractional_peer;\n+        const size_t targets = size_t(std::modf(limit, &fractional_peer)) + 1;\n+        const bool drop_peer_if_extra = deterministic_randomizer.Finalize() > fractional_peer * float(UINT64_MAX);\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers(targets, std::make_pair(0, 0));\n+\n+        auto try_fanout_candidate = [&best_peers, &deterministic_randomizer, targets](\n+                                        const std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> candidate) {\n+            const auto& cur_state = std::get<TxReconciliationState>(candidate.second);\n+            uint64_t hash_key = std::max<uint64_t>(deterministic_randomizer.Write(cur_state.m_k0).Finalize(), 1);\n+\n+            for (size_t i = 0; i < targets; ++i) {\n+                if (hash_key > best_peers[i].first) {\n+                    std::copy(best_peers.begin() + i, best_peers.begin() + targets - 1, best_peers.begin() + i + 1);\n+                    best_peers[i] = std::make_pair(hash_key, candidate.first);\n+                    break;\n+                }\n+            }\n+        };\n+\n+        for (auto indexed_state : m_states) {\n+            const auto& cur_state = std::get<TxReconciliationState>(indexed_state.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1135765960",
      "id" : 1135765960,
      "in_reply_to_id" : 1135725988,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII585DsmnI",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 342,
      "original_position" : 262,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 262,
      "pull_request_review_id" : 1339614248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135765960/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-14T15:44:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1135765960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1137786018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137786018"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it might be possible that in between the spot where `txinfo` is queried, and the time we call `m_mempool.GetIter()` some other thread could remove the tx from the mempool (because no lock is held), so that this assert would be hit.",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-15T21:20:43Z",
      "diff_hunk" : "@@ -5669,7 +5679,42 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n                         State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        bool fanout = true;\n+                        if (reconciles_txs) {\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1137786018",
      "id" : 1137786018,
      "line" : 5729,
      "node_id" : "PRRC_kwDOABII585D0Tyi",
      "original_commit_id" : "dcde537b5bc0e2dd272528e3a770a768ca804955",
      "original_line" : 5687,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 131,
      "pull_request_review_id" : 1342448815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137786018/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-16T15:49:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137786018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1138793203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138793203"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having a mix of float (`limit`) and double (`fractional_peer`) is probably not ideal.",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-16T14:40:48Z",
      "diff_hunk" : "@@ -192,6 +205,87 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(const uint256& wtxid, CSipHasher& deterministic_randomizer,\n+                                         bool we_initiate, float limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        // Initiate the randomness here so that it's not influenced by the following code.\n+        double fractional_peer;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1138793203",
      "id" : 1138793203,
      "line" : 321,
      "node_id" : "PRRC_kwDOABII585D4Jrz",
      "original_commit_id" : "dcde537b5bc0e2dd272528e3a770a768ca804955",
      "original_line" : 215,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 241,
      "pull_request_review_id" : 1342448815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138793203/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-16T15:49:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138793203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1138809864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138809864"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`wtxid` is unused",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-16T14:48:46Z",
      "diff_hunk" : "@@ -192,6 +205,87 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(const uint256& wtxid, CSipHasher& deterministic_randomizer,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1138809864",
      "id" : 1138809864,
      "line" : 315,
      "node_id" : "PRRC_kwDOABII585D4NwI",
      "original_commit_id" : "dcde537b5bc0e2dd272528e3a770a768ca804955",
      "original_line" : 209,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 235,
      "pull_request_review_id" : 1342448815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138809864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-16T15:49:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138809864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1139046536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139046536"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (m_txreconciliation) m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), wtxid);\r\n```\r\n\r\nYou are already checking internally that the peer is registered.",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-16T16:49:30Z",
      "diff_hunk" : "@@ -4021,6 +4043,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pfrom.GetId())) {\n+            m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), wtxid);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1139046536",
      "id" : 1139046536,
      "line" : 4048,
      "node_id" : "PRRC_kwDOABII585D5HiI",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 4048,
      "original_position" : 57,
      "original_start_line" : 4046,
      "path" : "src/net_processing.cpp",
      "position" : 57,
      "pull_request_review_id" : 1344306348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139046536/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4046,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-16T17:34:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139046536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1139078818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139078818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                                {\r\n                                    LOCK(m_peer_mutex);\r\n                                    for (auto [id, peer] : m_peer_map) {\r\n                                        const auto state{State(id)};\r\n                                        if (!state) continue;\r\n\r\n                                        if (auto tx_relay = peer->GetTxRelay()) {\r\n                                            LOCK(tx_relay->m_bloom_filter_mutex);\r\n                                            inbounds_fanouted += state->m_is_inbound && tx_relay->m_relay_txs;\r\n                                            outbounds_fanouted += !state->m_is_inbound && tx_relay->m_relay_txs && !m_txreconciliation->IsPeerRegistered(id);\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n```\r\n\r\nSee https://github.com/bitcoin/bitcoin/pull/27270",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-16T17:08:36Z",
      "diff_hunk" : "@@ -5669,7 +5721,42 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n                         State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        bool fanout = true;\n+                        if (reconciles_txs) {\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.\n+                                fanout = true;\n+                            } else {\n+                                size_t inbounds_fanouted = 0, outbounds_fanouted = 0;\n+                                m_connman.ForEachNode([&inbounds_fanouted, &outbounds_fanouted, this](CNode* pnode) {\n+                                    inbounds_fanouted += pnode->IsInboundConn() && pnode->m_relays_txs;\n+                                    outbounds_fanouted += pnode->IsFullOutboundConn() && pnode->m_relays_txs && !m_txreconciliation->IsPeerRegistered(pnode->GetId());\n+                                });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1139078818",
      "id" : 1139078818,
      "line" : 5747,
      "node_id" : "PRRC_kwDOABII585D5Pai",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 5747,
      "original_position" : 149,
      "original_start_line" : 5744,
      "path" : "src/net_processing.cpp",
      "position" : 149,
      "pull_request_review_id" : 1344306348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139078818/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5744,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-16T17:34:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1139078818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1151979732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151979732"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                                    inbounds_fanouted += pnode->IsInboundConn() && pnode->m_relays_txs && !m_txreconciliation->IsPeerRegistered(pnode->GetId());\r\n```\r\nRight? because otherwise this includes erlay peers which we are not flooding to by default.",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-29T13:51:53Z",
      "diff_hunk" : "@@ -5669,7 +5721,42 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n                         State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        bool fanout = true;\n+                        if (reconciles_txs) {\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.\n+                                fanout = true;\n+                            } else {\n+                                size_t inbounds_fanouted = 0, outbounds_fanouted = 0;\n+                                m_connman.ForEachNode([&inbounds_fanouted, &outbounds_fanouted, this](CNode* pnode) {\n+                                    inbounds_fanouted += pnode->IsInboundConn() && pnode->m_relays_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1151979732",
      "id" : 1151979732,
      "line" : 5745,
      "node_id" : "PRRC_kwDOABII585EqdDU",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 5745,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 147,
      "pull_request_review_id" : 1363161761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151979732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-29T13:59:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151979732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1151986544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151986544"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_connman.GetNodeCount(ConnectionDirection::In)` includes all inbound connections, even ones that do want transactions relayed to them. IIUC, you want this to be \"number of all inbound peers that sent fRelay=true\" and the second member of the pair should be \"number of all non-erlay inbound peers that sent fRelay=true\"",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-03-29T13:56:22Z",
      "diff_hunk" : "@@ -5669,7 +5721,42 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n                         State(pto->GetId())->m_recently_announced_invs.insert(hash);\n-                        vInv.push_back(inv);\n+\n+                        bool fanout = true;\n+                        if (reconciles_txs) {\n+                            LOCK(m_mempool.cs);\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            assert(txiter);\n+                            if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.\n+                                fanout = true;\n+                            } else {\n+                                size_t inbounds_fanouted = 0, outbounds_fanouted = 0;\n+                                m_connman.ForEachNode([&inbounds_fanouted, &outbounds_fanouted, this](CNode* pnode) {\n+                                    inbounds_fanouted += pnode->IsInboundConn() && pnode->m_relays_txs;\n+                                    outbounds_fanouted += pnode->IsFullOutboundConn() && pnode->m_relays_txs && !m_txreconciliation->IsPeerRegistered(pnode->GetId());\n+                                });\n+\n+                                auto fanout_randomizer = m_connman.GetDeterministicRandomizer(RANDOMIZER_ID_FANOUTTARGET);\n+                                fanout = m_txreconciliation->ShouldFanoutTo(wtxid, fanout_randomizer, pto->GetId(),\n+                                                                            std::make_pair(m_connman.GetNodeCount(ConnectionDirection::In), inbounds_fanouted),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1151986544",
      "id" : 1151986544,
      "line" : 5751,
      "node_id" : "PRRC_kwDOABII585Eqetw",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 5751,
      "original_position" : 153,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 153,
      "pull_request_review_id" : 1363161761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151986544/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-29T13:59:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1151986544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1210580514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210580514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 00df0aefff938e849bdab5278d6658d5c9d5d064, If the purpose is maturing them, I think we could do:\r\n```suggestion\r\n        self.generate(self.nodes[0], COINBASE_MATURITY) # mature coinbase UTXO used later\r\n```",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-05-30T17:12:06Z",
      "diff_hunk" : "@@ -0,0 +1,84 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test REQTXRCNCL message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+class ReqTxrcnclReceiver(P2PInterface):\n+    def __init__(self):\n+        super().__init__(support_txrcncl = True)\n+        self.reqtxrcncl_msg_received = None\n+        self.received_inv_items = 0\n+\n+    def on_inv(self, message):\n+        self.received_inv_items += len(message.inv)\n+        super().on_inv(message)\n+\n+    def on_reqtxrcncl(self, message):\n+        self.reqtxrcncl_msg_received = message\n+\n+class ReqTxRcnclTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [['-txreconciliation']]\n+\n+    def run_test(self):\n+        t = int(time.time())\n+        self.nodes[0].setmocktime(t)\n+        self.generate(self.nodes[0], 200) # mature coinbase UTXO used later",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1210580514",
      "id" : 1210580514,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII585IJ_4i",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_reqtxrcncl.py",
      "position" : 36,
      "pull_request_review_id" : 1451435060,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210580514/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T17:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210580514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1210698732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210698732"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 30c39c1316a7b5c1914654f2a1487309b6e550ac: If we're in IBD, wouldn't we put that peer in the end of the queue with no need (I mean, without doing a rec request in fact)? ",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-05-30T18:55:21Z",
      "diff_hunk" : "@@ -5787,6 +5795,21 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1210698732",
      "id" : 1210698732,
      "line" : 5802,
      "node_id" : "PRRC_kwDOABII585IKcvs",
      "original_commit_id" : "30c39c1316a7b5c1914654f2a1487309b6e550ac",
      "original_line" : 5802,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 173,
      "pull_request_review_id" : 1451623963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210698732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T18:55:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210698732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1286486164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286486164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could say âlow-fanout floodingâ as itâs the term used above to describe the two transaction announcement strategy",
      "commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "created_at" : "2023-08-08T00:27:03Z",
      "diff_hunk" : "@@ -184,6 +201,8 @@ static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\n static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\n /** The compactblocks version we support. See BIP 152. */\n static constexpr uint64_t CMPCTBLOCKS_VERSION{2};\n+/** Used to determine whether to fanout or to reconcile a transaction with a given peer */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1286486164",
      "id" : 1286486164,
      "line" : 204,
      "node_id" : "PRRC_kwDOABII585MrjiU",
      "original_commit_id" : "00df0aefff938e849bdab5278d6658d5c9d5d064",
      "original_line" : 204,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 36,
      "pull_request_review_id" : 1566303719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286486164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-08T00:27:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286486164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like the functional test times out in CI?",
      "created_at" : "2023-08-17T09:19:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1681931026",
      "id" : 1681931026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585kQDsS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681931026/reactions"
      },
      "updated_at" : "2023-08-17T09:19:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681931026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298976353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298976353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note to reviewers, this is used in `AddToSet()`, which is itself called in the transaction to relay selection at message `NetMsgType::INV` generation in `SendMessages()`.\r\n\r\nThis allows one `m_txreconciliation_mutex` lock taking to cover the insert in the `m_states` entry.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T01:07:08Z",
      "diff_hunk" : "@@ -166,5 +172,5 @@ void TxReconciliationTracker::ForgetPeer(NodeId peer_id)\n \n bool TxReconciliationTracker::IsPeerRegistered(NodeId peer_id) const\n {\n-    return m_impl->IsPeerRegistered(peer_id);\n+    return m_impl->IsPeerRegisteredExternal(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298976353",
      "id" : 1298976353,
      "line" : 457,
      "node_id" : "PRRC_kwDOABII585NbM5h",
      "original_commit_id" : "9d8e2d5c55d118465bccb4fc7b3dd32b7956a9ba",
      "original_line" : 457,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 372,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298976353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298976353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298979793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298979793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"The maximum number of wtxids stored in a peer local set, bounded to protect the memory of the reconciliation sets and short ids mapping storage size and CPU used for sketch computation\" (as documented in `AddToSet`).",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T01:19:40Z",
      "diff_hunk" : "@@ -17,7 +17,7 @@ namespace {\n /** Static salt component used to compute short txids for sketch construction, see BIP-330. */\n const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n const HashWriter RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n-\n+constexpr size_t MAX_SET_SIZE = 3000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298979793",
      "id" : 1298979793,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585NbNvR",
      "original_commit_id" : "194e2559fc701d8c89b7f3b052862f6f1b8f09b8",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 20,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298979793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298979793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298984863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298984863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `wtxid` could be added to the `LogPrintLevel` to ease debug.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T01:34:52Z",
      "diff_hunk" : "@@ -125,6 +133,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added a transaction to the reconciliation set for peer=%d. \" /* Continued */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298984863",
      "id" : 1298984863,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NbO-f",
      "original_commit_id" : "194e2559fc701d8c89b7f3b052862f6f1b8f09b8",
      "original_line" : 157,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298984863/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298984863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298994712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298994712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `LOCK2` could be used.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T01:54:37Z",
      "diff_hunk" : "@@ -5650,9 +5657,13 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.\n+                LOCK(m_mempool.cs);\n+                LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1298994712",
      "id" : 1298994712,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NbRYY",
      "original_commit_id" : "dfde4393b3b7483d40b6551ceee133ff7dd31408",
      "original_line" : 5662,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298994712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298994712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1299012891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299012891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note to reviewers, intersections with #27463 and BIP331.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T02:13:57Z",
      "diff_hunk" : "@@ -5739,7 +5750,51 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                    // If a transaction has in-mempool children, always fanout it.\n+                                    // Until package relay is implemented, this is needed to avoid\n+                                    // breaking parent+child relay expectations in some cases.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1299012891",
      "id" : 1299012891,
      "line" : 5824,
      "node_id" : "PRRC_kwDOABII585NbV0b",
      "original_commit_id" : "dfde4393b3b7483d40b6551ceee133ff7dd31408",
      "original_line" : 5824,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 173,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299012891/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299012891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1299018722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299018722"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the issue can be even worst if you're considering the receiver-initiated approach, where the receiver might have already the child from another peer and the BIP331's `getskgtxns` is in-flight. Both the parent and child wtxid reconciliation set entries are going to be wasted, I think.\r\n\r\nI believe the best approach to combine it with package relay support for now is just to look if it doesn't raise privacy or CPU robustness approach for now (at least until one is finalized and deployed), and swallow the bullet in term of bandwidth savings performance.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-19T02:33:49Z",
      "diff_hunk" : "@@ -5739,7 +5750,51 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                    // If a transaction has in-mempool children, always fanout it.\n+                                    // Until package relay is implemented, this is needed to avoid\n+                                    // breaking parent+child relay expectations in some cases.\n+                                    //\n+                                    // Potentially reconciling parent+child would mean that for every\n+                                    // child we need to to check if any of the parents is currently\n+                                    // reconciled so that the child isn't fanouted ahead. But then\n+                                    // it gets tricky when reconciliation sets are full: a) the child\n+                                    // can't just be added; b) removing parents from reconciliation\n+                                    // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1299018722",
      "id" : 1299018722,
      "line" : 5831,
      "node_id" : "PRRC_kwDOABII585NbXPi",
      "original_commit_id" : "dfde4393b3b7483d40b6551ceee133ff7dd31408",
      "original_line" : 5831,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 180,
      "pull_request_review_id" : 1585375079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299018722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-19T02:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1299018722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sounds `p2p_reqtxrcncl.py` is the source of failing checks for all the unsuccessful CI tasks.",
      "created_at" : "2023-08-22T23:09:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1689039609",
      "id" : 1689039609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585krLL5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1689039609/reactions"
      },
      "updated_at" : "2023-08-22T23:09:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1689039609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "All checks good, will review more.",
      "created_at" : "2023-08-25T15:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1693550930",
      "id" : 1693550930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585k8YlS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693550930/reactions"
      },
      "updated_at" : "2023-08-25T15:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693550930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307548349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307548349"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If my understanding is correct, if we have a too low number of inbound / outbound connections and given the limit is absolute not relative, we might have reconciliations failure and weâll fall back to `vInv` announcement. A node operator could have a low `maxconnections`.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-28T15:03:40Z",
      "diff_hunk" : "@@ -193,6 +206,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                         bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        const size_t targets = size_t(integer_part) + 1;\n+        const bool drop_peer_if_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        for (size_t i = 0; i < targets; ++i) {\n+            best_peers.push_back(std::make_pair(0, 0));\n+        }\n+\n+        auto try_fanout_candidate = [&best_peers, &deterministic_randomizer_with_wtxid, targets](\n+                                        const TxReconciliationState& candidate_state, const NodeId& candidate_id) {\n+            uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(candidate_state.m_k0).Finalize();\n+\n+            for (size_t i = 0; i < targets; ++i) {\n+                if (hash_key > best_peers[i].first) {\n+                    best_peers.insert(best_peers.begin() + i, std::make_pair(hash_key, candidate_id));\n+                    break;\n+                }\n+            }\n+        };\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                try_fanout_candidate(*cur_state, indexed_state.first);\n+            }\n+        }\n+\n+        best_peers.erase(best_peers.begin() + targets, best_peers.end());\n+\n+        std::vector<NodeId> result;\n+        std::for_each(best_peers.begin(), best_peers.end(),\n+                      [&result](auto best_peer) {\n+                          if (best_peer.first != 0) result.push_back(best_peer.second);\n+                      });\n+\n+        if (result.size() > limit && drop_peer_if_extra) {\n+            result.pop_back();\n+        }\n+\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307548349",
      "id" : 1307548349,
      "line" : 406,
      "node_id" : "PRRC_kwDOABII585N75q9",
      "original_commit_id" : "5b886367c80a293ef2e1c37b1ecab42b057d873b",
      "original_line" : 300,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 324,
      "pull_request_review_id" : 1598489137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307548349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T16:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307548349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307569696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307569696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `INBOUND_INVENTORY_BROADCAST_INTERVAL` superior to `INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON` it can be `static_assert` too.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-28T15:21:26Z",
      "diff_hunk" : "@@ -138,12 +138,29 @@ static constexpr auto AVG_ADDRESS_BROADCAST_INTERVAL{30s};\n /** Delay between rotating the peers we relay a particular address to */\n static constexpr auto ROTATE_ADDR_RELAY_DEST_INTERVAL{24h};\n /** Average delay between trickled inventory transmissions for inbound peers.\n- *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this. */\n+ *  Blocks and peers with NetPermissionFlags::NoBan permission bypass this.\n+ *  For reconciliation peers the delay is chosen according the following\n+ *  considerations:\n+ *  1. Reconciliation. When the transaction is reconciled, this delay is applied to adding to\n+ *     reconciliation sets, not actual reconciliation (less frequent). That should happen rather\n+ *     fast, so that sets are in sync and reconciliation is efficient. At the same time, not too\n+ *     fast to avoid privacy leaks (e.g., infer connections via set probing).\n+ *  2. Low-fanout. In rare cases when the reconciling peer is chosen for low-fanout\n+ *     flooding, it will apply to the actual broadcast. Then, regular trickle considerations apply,\n+ *     but since this is a rare occasion, the following risks are much lower:\n+ *     2a) announcing both ways simultaneously (inefficiency);\n+ *     2b) inference based on the announced transactions (privacy leak).\n+ *     That's why it's ok to make this delay low as well, and lower delay is generally good to\n+ *     facilitate good transaction relay speed when slow reconciliations prevail. */\n static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL{5s};\n+static constexpr auto INBOUND_INVENTORY_BROADCAST_INTERVAL_RECON{2s};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307569696",
      "id" : 1307569696,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII585N7-4g",
      "original_commit_id" : "89de0f71dce11e29c4c115a3021e97da62ba3ce6",
      "original_line" : 156,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1598489137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307569696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T16:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307569696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307642719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307642719"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment could be more precised and if Iâm understanding correctly it could say the order of reconciliating peers should be maintained between each reconciliation.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-08-28T16:19:49Z",
      "diff_hunk" : "@@ -97,6 +97,13 @@ class TxReconciliationTracker::Impl\n      */\n     std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n \n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1307642719",
      "id" : 1307642719,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585N8Qtf",
      "original_commit_id" : "0ec1b427ece095bc9f42bede8152fab50a22e2c9",
      "original_line" : 102,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 82,
      "pull_request_review_id" : 1598489137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307642719/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-28T16:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307642719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1323478916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323478916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 180052c214738a15e1f027cae96ff2f1431ef4cd: Do we really need to mature them?",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-09-12T19:39:19Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test REQTXRCNCL message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.blocktools import COINBASE_MATURITY\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+class ReqTxrcnclReceiver(P2PInterface):\n+    def __init__(self):\n+        super().__init__(support_txrcncl = True)\n+        self.reqtxrcncl_msg_received = None\n+        self.received_inv_items = 0\n+\n+    def on_inv(self, message):\n+        self.received_inv_items += len(message.inv)\n+        super().on_inv(message)\n+\n+    def on_reqtxrcncl(self, message):\n+        self.reqtxrcncl_msg_received = message\n+\n+class ReqTxRcnclTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [['-txreconciliation']]\n+\n+    def run_test(self):\n+        t = int(time.time())\n+        self.nodes[0].setmocktime(t)\n+        self.generate(self.nodes[0], COINBASE_MATURITY) # mature coinbase UTXO used later",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1323478916",
      "id" : 1323478916,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII585O4q-E",
      "original_commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_reqtxrcncl.py",
      "position" : 37,
      "pull_request_review_id" : 1622988180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323478916/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T19:39:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323478916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1333346029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333346029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the pair of values returned by `InitiateReconciliationRequest` is `std::optional<std::pair<uint16_t, uint16_t>>` so should say 2-byte local reconciliation set size and 2-byte q-coefficient.",
      "commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "created_at" : "2023-09-21T16:40:06Z",
      "diff_hunk" : "@@ -265,6 +265,12 @@ extern const char* WTXIDRELAY;\n  * txreconciliation, as described by BIP 330.\n  */\n extern const char* SENDTXRCNCL;\n+/**\n+ * Contains a 4-byte local reconciliation set size and 4-byte q-coefficient",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1333346029",
      "id" : 1333346029,
      "line" : 269,
      "node_id" : "PRRC_kwDOABII585PeT7t",
      "original_commit_id" : "180052c214738a15e1f027cae96ff2f1431ef4cd",
      "original_line" : 269,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 1638298169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333346029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T16:49:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333346029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Still have to review a couple of comments, especially the fuzzing [suggested](https://github.com/dergoegge/bitcoin/commits/2022-10-erlay2) by @dergoegge ",
      "created_at" : "2023-10-13T11:19:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1761347444",
      "id" : 1761347444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585o_Ad0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761347444/reactions"
      },
      "updated_at" : "2023-10-13T11:19:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761347444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1360307545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360307545"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I assume what you're saying is that \"your code works, but the problem it solves is harder than what the comment says\". Correct me if I'm wrong.",
      "commit_id" : "80dc9c46cf257ebd4da51464bde8e84077446f25",
      "created_at" : "2023-10-16T08:29:24Z",
      "diff_hunk" : "@@ -5739,7 +5750,51 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                    // If a transaction has in-mempool children, always fanout it.\n+                                    // Until package relay is implemented, this is needed to avoid\n+                                    // breaking parent+child relay expectations in some cases.\n+                                    //\n+                                    // Potentially reconciling parent+child would mean that for every\n+                                    // child we need to to check if any of the parents is currently\n+                                    // reconciled so that the child isn't fanouted ahead. But then\n+                                    // it gets tricky when reconciliation sets are full: a) the child\n+                                    // can't just be added; b) removing parents from reconciliation\n+                                    // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1360307545",
      "id" : 1360307545,
      "in_reply_to_id" : 1299018722,
      "line" : 5833,
      "node_id" : "PRRC_kwDOABII585RFKVZ",
      "original_commit_id" : "dfde4393b3b7483d40b6551ceee133ff7dd31408",
      "original_line" : 5833,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 182,
      "pull_request_review_id" : 1679412019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360307545/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T08:29:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360307545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1360391841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360391841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I made this code extra safe:\r\n- it's very early in `SendMessages`;\r\n- it's called even if in IBD;\r\n\r\nAlso reminding that this only applies to outbound. \r\n\r\nHaving separate queues for every peer would nullify all our previous tuning and performance benchmarks (both mine and from others), that's why I'd rather stick to the current approach.",
      "commit_id" : "80dc9c46cf257ebd4da51464bde8e84077446f25",
      "created_at" : "2023-10-16T09:35:48Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1360391841",
      "id" : 1360391841,
      "in_reply_to_id" : 1041586275,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RFe6h",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 239,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1679544859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360391841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T09:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1360391841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1361921456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361921456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "After all, I decided to introduce independent timers, because my previous idea became too ugly. I think the way i implemented it it doesn't nullify previous benchmarks, and should be robust to manipulations.",
      "commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "created_at" : "2023-10-17T10:57:37Z",
      "diff_hunk" : "@@ -216,6 +233,43 @@ class TxReconciliationTracker::Impl\n         recon_state.m_local_set.erase(wtxid_to_remove);\n     }\n \n+    std::optional<std::pair<uint16_t, uint16_t>> MaybeRequestReconciliation(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return std::nullopt;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (!recon_state.m_we_initiate) return std::nullopt;\n+\n+        if (!m_queue.empty()) {\n+            // Request transaction reconciliation periodically to efficiently exchange transactions.\n+            // To make reconciliation predictable and efficient, we reconcile with peers in order\n+            // based on the queue, taking a delay between requests.\n+            auto current_time = GetTime<std::chrono::seconds>();\n+            if (m_next_recon_request <= current_time && m_queue.front() == peer_id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1361921456",
      "id" : 1361921456,
      "in_reply_to_id" : 1041586275,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RLUWw",
      "original_commit_id" : "ef5a0457ae3d473fad3c79e169373bb8f9ef2c8c",
      "original_line" : 239,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1682013985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361921456/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T10:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361921456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This PR is good for review. Fuzzing will come in a separate PR.",
      "created_at" : "2023-10-18T16:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#issuecomment-1768887600",
      "id" : 1768887600,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26283",
      "node_id" : "IC_kwDOABII585pbxUw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1768887600/reactions"
      },
      "updated_at" : "2023-10-18T16:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1768887600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1364844929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364844929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "naming is ambiguous as could be understood as `their_time_passed` we-jump-their-reconciliation round until next time. though okay itâs âenough time has passed-since-last-txrcnlcâ.",
      "commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "created_at" : "2023-10-19T03:53:10Z",
      "diff_hunk" : "@@ -122,26 +194,226 @@ class TxReconciliationTracker::Impl\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n         recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+        if (!is_peer_inbound) m_queue.push_back(peer_id);\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const uint256& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        return recon_state.m_local_set.erase(wtxid_to_remove) > 0;\n+    }\n+\n+    bool IsPeerNextToReconcileWith(NodeId peer_id, std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        if (m_queue.empty()) return false;\n+\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        if (m_next_request_global <= now && m_queue.front() == peer_id) {\n+            Assume(recon_state.m_we_initiate);\n+            m_queue.pop_front();\n+            m_queue.push_back(peer_id);\n+\n+            // It is possible that the front-queue peer is not ready for a reconciliation yet:\n+            // - either it's own timer has not passed;\n+            // - or it's currently in reconciliation.\n+            //\n+            // In both cases, we should not delay our reconciliations, but these peers should\n+            // be moved to the end of the queue to get the next chance.\n+            //\n+            // Otherwise, we should bump the global timer and allow to proceed for reconciliation.\n+            const bool their_time_passed = recon_state.m_last_txrcncl + RECON_REQUEST_INTERVAL < now;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1364844929",
      "id" : 1364844929,
      "line" : 261,
      "node_id" : "PRRC_kwDOABII585RWeGB",
      "original_commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "original_line" : 261,
      "original_position" : 176,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 176,
      "pull_request_review_id" : 1686610121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364844929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T03:53:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1364844929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1369459008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369459008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note the call to `IsPeerNextToReconcileWith` is before `MaybeDiscourageAndDisconnect`. if a peer is misbehaving and candidate for disconnection, maybe we should disconnect first and let the reconciliation slot be used by another peer",
      "commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "created_at" : "2023-10-24T01:50:53Z",
      "diff_hunk" : "@@ -5509,8 +5535,22 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n     PeerRef peer = GetPeerRef(pto->GetId());\n     if (!peer) return false;\n+\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // We must look into the reconciliation queue early. Since the queue applies to all peers,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1369459008",
      "id" : 1369459008,
      "line" : 5543,
      "node_id" : "PRRC_kwDOABII585RoElA",
      "original_commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "original_line" : 5543,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 71,
      "pull_request_review_id" : 1693801266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369459008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T01:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369459008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1370269478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370269478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 3ec03ffa35a37625ff66fcf135f851c1220cde99: Shouldn't it be into `if (AlreadyHaveTx(GenTxid::Wtxid(wtxid)))`?",
      "commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "created_at" : "2023-10-24T14:20:25Z",
      "diff_hunk" : "@@ -4241,6 +4246,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        if (m_txreconciliation) m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1370269478",
      "id" : 1370269478,
      "line" : 4268,
      "node_id" : "PRRC_kwDOABII585RrKcm",
      "original_commit_id" : "3ec03ffa35a37625ff66fcf135f851c1220cde99",
      "original_line" : 4249,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 57,
      "pull_request_review_id" : 1695022484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370269478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370269478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1371681916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1371681916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 863a334daeac9489e8a09c9a9f651f97081e4b87: I think you could use `send_self_transfer_multi` to send all utxos.\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_reqtxrcncl.py b/test/functional/p2p_reqtxrcncl.py\r\nindex d43267f8ba..ed8d1e0fb4 100755\r\n--- a/test/functional/p2p_reqtxrcncl.py\r\n+++ b/test/functional/p2p_reqtxrcncl.py\r\n@@ -65,9 +65,7 @@ class ReqTxRcnclTest(BitcoinTestFramework):\r\n         self.wallet = MiniWallet(self.nodes[0])\r\n         self.wallet.rescan_utxos()\r\n         utxos = self.wallet.get_utxos()\r\n-        for utxo in utxos:\r\n-            # We want all transactions to be childless.\r\n-            self.wallet.send_self_transfer(from_node=self.nodes[0], utxo_to_spend=utxo)\r\n+        self.wallet.send_self_transfer_multi(from_node=self.nodes[0], utxos_to_spend=utxos, fee_per_output=1310)\r\n```",
      "commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "created_at" : "2023-10-25T12:33:20Z",
      "diff_hunk" : "@@ -0,0 +1,83 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test REQTXRCNCL message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+class ReqTxrcnclReceiver(P2PInterface):\n+    def __init__(self):\n+        super().__init__(support_txrcncl = True)\n+        self.reqtxrcncl_msg_received = None\n+        self.received_inv_items = 0\n+\n+    def on_inv(self, message):\n+        self.received_inv_items += len(message.inv)\n+        super().on_inv(message)\n+\n+    def on_reqtxrcncl(self, message):\n+        self.reqtxrcncl_msg_received = message\n+\n+class ReqTxRcnclTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [['-txreconciliation']]\n+\n+    def run_test(self):\n+        t = int(time.time())\n+        self.nodes[0].setmocktime(t)\n+        # Check everything about *sending* REQTXRCNCL.\n+        self.log.info('REQTXRCNCL sent to an outbound #1')\n+        peer = self.nodes[0].add_outbound_p2p_connection(ReqTxrcnclReceiver(), wait_for_verack=True, p2p_idx=0)\n+        self.nodes[0].setmocktime(t + 8 + 1)\n+        self.wait_until(lambda: peer.reqtxrcncl_msg_received)\n+        assert_equal(peer.reqtxrcncl_msg_received.set_size, 0)\n+        assert_equal(peer.reqtxrcncl_msg_received.q, int(32767 * 0.25))\n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info('REQTXRCNCL sent to an outbound #1 again, even though we added #2')\n+        with self.nodes[0].assert_debug_log([\"Register peer=1\", \"Register peer=2\"]):\n+            peer1 = self.nodes[0].add_outbound_p2p_connection(ReqTxrcnclReceiver(), wait_for_verack=True, p2p_idx=1)\n+            peer2 = self.nodes[0].add_outbound_p2p_connection(ReqTxrcnclReceiver(), wait_for_verack=True, p2p_idx=2)\n+        self.nodes[0].setmocktime(t + 16 + 1)\n+        self.wait_until(lambda: peer1.reqtxrcncl_msg_received)\n+        assert not peer2.reqtxrcncl_msg_received\n+        self.log.info('REQTXRCNCL sent to an outbound #2')\n+        peer1.reqtxrcncl_msg_received = None\n+        # Since there are two peers, it's half the delay.\n+        self.nodes[0].setmocktime(t + 20 + 1)\n+        self.wait_until(lambda: peer2.reqtxrcncl_msg_received)\n+        assert not peer1.reqtxrcncl_msg_received\n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info('Check transactions announced (either low-fanout or reconciliation)')\n+        with self.nodes[0].assert_debug_log([\"Register peer=3\", \"Register peer=4\"]):\n+            peer1 = self.nodes[0].add_outbound_p2p_connection(ReqTxrcnclReceiver(), wait_for_verack=True, p2p_idx=3)\n+            peer2 = self.nodes[0].add_outbound_p2p_connection(ReqTxrcnclReceiver(), wait_for_verack=True, p2p_idx=4)\n+\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+        utxos = self.wallet.get_utxos()\n+        for utxo in utxos:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1371681916",
      "id" : 1371681916,
      "line" : 68,
      "node_id" : "PRRC_kwDOABII585RwjR8",
      "original_commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_reqtxrcncl.py",
      "position" : 68,
      "pull_request_review_id" : 1697214399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1371681916/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-25T12:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1371681916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374259401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374259401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would make a difference only once, which is fine for (lower-risk) outbound peers I think.\r\n\r\nThe problem with latter `IsPeerNextToReconcileWith` is that the queue won't be queried. Say, a peer finds a way to exploit `MaybeDiscourageAndDisconnect` (say in combination with something else)Â â so that it always returns, but never disconnects. In that case the peer will be stuck at the front of the queue forever.\r\n\r\nI don't think what i described is currently possible (fDisconnect only can go from false to true), but I'm afraid it might be in the future.",
      "commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "created_at" : "2023-10-27T08:41:51Z",
      "diff_hunk" : "@@ -5509,8 +5535,22 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n     PeerRef peer = GetPeerRef(pto->GetId());\n     if (!peer) return false;\n+\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // We must look into the reconciliation queue early. Since the queue applies to all peers,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374259401",
      "id" : 1374259401,
      "in_reply_to_id" : 1369459008,
      "line" : 5543,
      "node_id" : "PRRC_kwDOABII585R6YjJ",
      "original_commit_id" : "863a334daeac9489e8a09c9a9f651f97081e4b87",
      "original_line" : 5543,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 71,
      "pull_request_review_id" : 1701285547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374259401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-27T08:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374259401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374269760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374269760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This code should certainly go earlier than the `return` in that `if`. I will move it.\r\nThis looks like a bug, although it only brings some moderate corner-case inefficiency. I should see whether I can test it in latter PRs.",
      "commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "created_at" : "2023-10-27T08:50:55Z",
      "diff_hunk" : "@@ -4241,6 +4246,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        if (m_txreconciliation) m_txreconciliation->TryRemovingFromSet(pfrom.GetId(), wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374269760",
      "id" : 1374269760,
      "in_reply_to_id" : 1370269478,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585R6bFA",
      "original_commit_id" : "3ec03ffa35a37625ff66fcf135f851c1220cde99",
      "original_line" : 4249,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1701302445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374269760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-27T08:50:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374269760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374432183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374432183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: For new code it may be good to use the built-in `int.(to/from)_bytes` helper, which has the following benefits:\r\n* No tuples returned in unpack\r\n* Number of bytes and endianness is expressed in normal integral values or normal English words, instead of cryptic single-character ascii symbols\r\n* No import is needed",
      "commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "created_at" : "2023-10-27T11:25:10Z",
      "diff_hunk" : "@@ -1889,6 +1889,28 @@ def __repr__(self):\n         return \"msg_sendtxrcncl(version=%lu, salt=%lu)\" %\\\n             (self.version, self.salt)\n \n+class msg_reqtxrcncl:\n+    __slots__ = (\"set_size\", \"q\")\n+    msgtype = b\"reqtxrcncl\"\n+\n+    def __init__(self):\n+        self.set_size = 0\n+        self.q = 0\n+\n+    def deserialize(self, f):\n+        self.set_size = struct.unpack(\"<H\", f.read(2))[0]\n+        self.q = struct.unpack(\"<H\", f.read(2))[0]\n+\n+    def serialize(self):\n+        r = b\"\"\n+        r += struct.pack(\"<I\", self.set_size)\n+        r += struct.pack(\"<I\", self.q)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374432183",
      "id" : 1374432183,
      "line" : 1907,
      "node_id" : "PRRC_kwDOABII585R7Cu3",
      "original_commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "original_line" : 1907,
      "original_position" : 19,
      "original_start_line" : 1901,
      "path" : "test/functional/test_framework/messages.py",
      "position" : 19,
      "pull_request_review_id" : 1701558397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374432183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1901,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-27T11:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374432183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374433032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374433032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "question: Does the `%lu` do anything? Could just use modern f-strings instead for new code?",
      "commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "created_at" : "2023-10-27T11:26:07Z",
      "diff_hunk" : "@@ -1889,6 +1889,28 @@ def __repr__(self):\n         return \"msg_sendtxrcncl(version=%lu, salt=%lu)\" %\\\n             (self.version, self.salt)\n \n+class msg_reqtxrcncl:\n+    __slots__ = (\"set_size\", \"q\")\n+    msgtype = b\"reqtxrcncl\"\n+\n+    def __init__(self):\n+        self.set_size = 0\n+        self.q = 0\n+\n+    def deserialize(self, f):\n+        self.set_size = struct.unpack(\"<H\", f.read(2))[0]\n+        self.q = struct.unpack(\"<H\", f.read(2))[0]\n+\n+    def serialize(self):\n+        r = b\"\"\n+        r += struct.pack(\"<I\", self.set_size)\n+        r += struct.pack(\"<I\", self.q)\n+        return r\n+\n+    def __repr__(self):\n+        return \"msg_reqtxrcncl(set_size=%lu, q=%lu)\" %\\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374433032",
      "id" : 1374433032,
      "line" : 1911,
      "node_id" : "PRRC_kwDOABII585R7C8I",
      "original_commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "original_line" : 1911,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/messages.py",
      "position" : 23,
      "pull_request_review_id" : 1701558397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374433032/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-27T11:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374433032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374571395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374571395"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In ec61607c77f23b819c6803489808af0a9a916694: Why do we have to check IBD here again? I think `reconcile` will only be `true` whether we're not in IBD.",
      "commit_id" : "3637986f0c3c3f83303ed8dd43660a55ef95162b",
      "created_at" : "2023-10-27T13:24:24Z",
      "diff_hunk" : "@@ -5953,6 +5965,21 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         if (!vInv.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n+        //\n+        // Message: reconciliation request\n+        //\n+        {\n+            if (!m_chainman.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26283#discussion_r1374571395",
      "id" : 1374571395,
      "line" : 5972,
      "node_id" : "PRRC_kwDOABII585R7kuD",
      "original_commit_id" : "ec61607c77f23b819c6803489808af0a9a916694",
      "original_line" : 5972,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 213,
      "pull_request_review_id" : 1701783155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26283",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374571395/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-27T13:24:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1374571395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
