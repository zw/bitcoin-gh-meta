[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Resurrects #21527",
      "created_at" : "2022-10-11T09:10:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1274367087",
      "id" : 1274367087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585L9Uxv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274367087/reactions"
      },
      "updated_at" : "2022-10-11T09:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274367087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r992131947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992131947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it intentional to split the annotations on two different lines?",
      "commit_id" : "5d59755168fa4c47cd709775a0ca764a28c352d4",
      "created_at" : "2022-10-11T10:17:29Z",
      "diff_hunk" : "@@ -589,8 +586,17 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n-    void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans)\n-        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    /**\n+     * Reconsider orphan transactions after a parent has been accepted to the mempool.\n+     *\n+     * @peer[in]  peer     The peer whose orphan transactions we will reconsider. Generally only one\n+     *                     orphan will be reconsidered on each call of this function. This set\n+     *                     may be added to if accepting an orphan causes its children to be\n+     *                     reconsidered.\n+     * @return             True if there are still orphans in this peer's work set.\n+     */\n+    bool ProcessOrphanTx(Peer& peer) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r992131947",
      "id" : 992131947,
      "line" : 599,
      "node_id" : "PRRC_kwDOABII5847Irtr",
      "original_commit_id" : "5d59755168fa4c47cd709775a0ca764a28c352d4",
      "original_line" : 599,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 1137209946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992131947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-11T10:17:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992131947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2022-10-11T11:15:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1274522306",
      "id" : 1274522306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585L96rC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274522306/reactions"
      },
      "updated_at" : "2022-10-11T11:15:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1274522306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r992348696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992348696"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It wasn't, I just keep not noticing it. Fixed.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-11T13:45:42Z",
      "diff_hunk" : "@@ -589,8 +586,17 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n-    void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans)\n-        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    /**\n+     * Reconsider orphan transactions after a parent has been accepted to the mempool.\n+     *\n+     * @peer[in]  peer     The peer whose orphan transactions we will reconsider. Generally only one\n+     *                     orphan will be reconsidered on each call of this function. This set\n+     *                     may be added to if accepting an orphan causes its children to be\n+     *                     reconsidered.\n+     * @return             True if there are still orphans in this peer's work set.\n+     */\n+    bool ProcessOrphanTx(Peer& peer) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r992348696",
      "id" : 992348696,
      "in_reply_to_id" : 992131947,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847JgoY",
      "original_commit_id" : "5d59755168fa4c47cd709775a0ca764a28c352d4",
      "original_line" : 599,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1137526683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992348696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-11T13:45:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/992348696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26151](https://github.com/bitcoin/bitcoin/pull/26151) (refactor: Guard TxRequestTracker by its own lock instead of cs_main by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-10-11T17:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1275034740",
      "id" : 1275034740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585L_3x0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1275034740/reactions"
      },
      "updated_at" : "2022-10-21T17:05:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1275034740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2022-10-12T11:37:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1276018107",
      "id" : 1276018107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585MDn27",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276018107/reactions"
      },
      "updated_at" : "2022-10-12T11:37:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276018107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r993429250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993429250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "89e2e0da0bcd0b0757d7b42907e2d2214da9f68b\r\n\r\nAdd `AssertLockHeld(g_msgproc_mutex);` into implementation code?",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-12T12:58:38Z",
      "diff_hunk" : "@@ -924,14 +930,14 @@ class PeerManagerImpl final : public PeerManager\n     /** Storage for orphan information */\n     TxOrphanage m_orphanage;\n \n-    void AddToCompactExtraTransactions(const CTransactionRef& tx) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void AddToCompactExtraTransactions(const CTransactionRef& tx) EXCLUSIVE_LOCKS_REQUIRED(g_msgproc_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r993429250",
      "id" : 993429250,
      "line" : 933,
      "node_id" : "PRRC_kwDOABII5847NocC",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 933,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 1139045515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993429250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-12T13:18:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/993429250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It does not look like a justification. An access to the extra txs ring buffer should be synced with its own mutex\r\n\r\nNo, it shouldn't have its own mutex: it's always better to have fewer locks than more, as that uses fewer resources and means there are fewer things to keep in your head when following the logic. The only time when more locks are better is when that enables more parallelism, and improves performance -- that is, a justification is needed when introducing new locks.",
      "created_at" : "2022-10-17T05:19:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1280302316",
      "id" : 1280302316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585MT9zs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1280302316/reactions"
      },
      "updated_at" : "2022-10-17T05:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1280302316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > It does not look like a justification. An access to the extra txs ring buffer should be synced with its own mutex\r\n> \r\n> No, it shouldn't have its own mutex... The only time when more locks are better is when that enables more parallelism, and improves performance -- that is, a justification is needed when introducing new locks.\r\n\r\nThis implies that in future design changes the `vExtraTxnForCompact` cannot be processed by any other thread except for the message processing one. Do we really want such a restriction for an ideal networking code?\r\n\r\n> it's always better to have fewer locks than more, as that uses fewer resources and means there are fewer things to keep in your head when following the logic.\r\n\r\nI cannot agree with \"it's always better\".\r\n\r\nMaking it use \"fewer resources\" is a kind of optimization, and \"premature optimization is the root of all evilâ.\r\n\r\n> it's always better to have fewer locks than more, as ... there are fewer things to keep in your head when following the logic.\r\n\r\nPerhaps, we are talking about personal biases, but, when following the logic, it's better to keep things structured, to have small classes which implement data structures with internal locking and thread-safe interfaces.",
      "created_at" : "2022-10-17T11:55:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1280739195",
      "id" : 1280739195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585MVod7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1280739195/reactions"
      },
      "updated_at" : "2022-10-17T11:55:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1280739195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This implies that in future design changes the `vExtraTxnForCompact` cannot be processed by any other thread except for the message processing one.\r\n\r\nWhat are you talking about? If we can put extra transactions under a different lock now, we certainly can in the future. This isn't an API that we have to support indefinitely.",
      "created_at" : "2022-10-18T02:47:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1281743152",
      "id" : 1281743152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585MZdkw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281743152/reactions"
      },
      "updated_at" : "2022-10-18T02:47:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281743152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998436721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998436721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::optional<TxToReconsider> GetTxToReconsider(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\r\n```\r\nWith `TxToReconsider` being:\r\n```c++\r\nstruct TxToReconsider {\r\n    const CTransactionRef tx;\r\n    const NodeId originator;\r\n    const bool more;\r\n};\r\n```\r\n\r\nThat would seem a little cleaner  to me because `originator` and `more` only have meaning if the returned transaction is not `nullptr`, so bundling the three would make sense imo. ",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-18T16:03:25Z",
      "diff_hunk" : "@@ -21,40 +21,46 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns nullptr and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns the transaction reference, removes\n+     *  the transaction from the work set, and populates its arguments with\n+     *  the originating peer, and whether there are more orphans for this peer\n+     *  to work on after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    CTransactionRef GetTxToReconsider(NodeId peer, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998436721",
      "id" : 998436721,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII5847gu9x",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 36,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 33,
      "pull_request_review_id" : 1146120937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998436721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T16:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998436721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998443622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998443622"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just wanted to note that you moved this check above the `m_getdata_requests.empty()` check. Any reason behind that? (Don't see how this changes anything, so feel free to just mark as resolved if there was no reason.)",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-18T16:10:07Z",
      "diff_hunk" : "@@ -4767,28 +4766,24 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n         }\n     }\n \n+    bool has_more_orphans;\n     {\n-        LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n-        }\n+        LOCK(cs_main);\n+        has_more_orphans = ProcessOrphanTx(*peer);\n     }\n \n     if (pfrom->fDisconnect)\n         return false;\n \n+    if (has_more_orphans) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998443622",
      "id" : 998443622,
      "line" : 4778,
      "node_id" : "PRRC_kwDOABII5847gwpm",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 4778,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 161,
      "pull_request_review_id" : 1146120937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998443622/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T16:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998443622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998447598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998447598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    // Get this peer's work set, emplacing an empty set if it didn't exist\r\n```",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-18T16:13:55Z",
      "diff_hunk" : "@@ -132,15 +139,19 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->first);\n+        _EraseTx(m_orphan_list[randompos]->first);\n         ++nEvicted;\n     }\n     if (nEvicted > 0) LogPrint(BCLog::MEMPOOL, \"orphanage overflow, removed %u tx\\n\", nEvicted);\n }\n \n-void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    // Get this peer's work set, emplacing an empty set it didn't exist",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998447598",
      "id" : 998447598,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII5847gxnu",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 152,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 83,
      "pull_request_review_id" : 1146120937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998447598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T16:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998447598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998456864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998456864"
         }
      },
      "author_association" : "MEMBER",
      "body" : "After the work set is moved to the orphanage, `ProcessOrphanTx` really only needs the id of the peer not the entire `Peer`.\r\n\r\nMaybe pass `NodeId` to `ProcessOrphanTx` instead of `Peer` in 9910ed755c3dfd7669707b44d993a20030dd7477 and have it look up the needed `Peer`.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-18T16:22:54Z",
      "diff_hunk" : "@@ -2878,20 +2878,20 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n /**\n  * Reconsider orphan transactions after a parent has been accepted to the mempool.\n  *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n+ * @peer[in]  peer                  The peer whose orphan transactions we will reconsider. Generally only one\n  *                                  orphan will be reconsidered on each call of this function. This set\n  *                                  may be added to if accepting an orphan causes its children to be\n  *                                  reconsidered.\n  */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+void PeerManagerImpl::ProcessOrphanTx(Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998456864",
      "id" : 998456864,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847gz4g",
      "original_commit_id" : "9910ed755c3dfd7669707b44d993a20030dd7477",
      "original_line" : 2886,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1146120937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998456864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T16:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998456864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998968477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998968477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It avoids taking the `m_getdata_requests_mutex` without changing the behaviour otherwise.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-19T05:52:36Z",
      "diff_hunk" : "@@ -4767,28 +4766,24 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n         }\n     }\n \n+    bool has_more_orphans;\n     {\n-        LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n-        }\n+        LOCK(cs_main);\n+        has_more_orphans = ProcessOrphanTx(*peer);\n     }\n \n     if (pfrom->fDisconnect)\n         return false;\n \n+    if (has_more_orphans) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r998968477",
      "id" : 998968477,
      "in_reply_to_id" : 998443622,
      "line" : 4778,
      "node_id" : "PRRC_kwDOABII5847iwyd",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 4778,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 161,
      "pull_request_review_id" : 1146883944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998968477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T05:52:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998968477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-10-30T13:01:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#issuecomment-1296253339",
      "id" : 1296253339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26295",
      "node_id" : "IC_kwDOABII585NQ0Gb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1296253339/reactions"
      },
      "updated_at" : "2022-10-30T13:01:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1296253339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/24590067?v=4",
         "events_url" : "https://api.github.com/users/chinggg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/chinggg/followers",
         "following_url" : "https://api.github.com/users/chinggg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/chinggg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/chinggg",
         "id" : 24590067,
         "login" : "chinggg",
         "node_id" : "MDQ6VXNlcjI0NTkwMDY3",
         "organizations_url" : "https://api.github.com/users/chinggg/orgs",
         "received_events_url" : "https://api.github.com/users/chinggg/received_events",
         "repos_url" : "https://api.github.com/users/chinggg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/chinggg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/chinggg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/chinggg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1008872657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008872657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I used to be confused about the different lock granularity for these methods. Thanks for moving all the locks inside the function. \r\nBut can we use `LOCKS_EXCLUDED(m_mutex)` as this line used to be instead of `EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)` for these methods?\r\nsee https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#excludes",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-30T14:18:56Z",
      "diff_hunk" : "@@ -21,40 +21,46 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1008872657",
      "id" : 1008872657,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII5848IizR",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 27,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 23,
      "pull_request_review_id" : 1161143708,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008872657/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-30T14:19:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008872657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/24590067?v=4",
         "events_url" : "https://api.github.com/users/chinggg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/chinggg/followers",
         "following_url" : "https://api.github.com/users/chinggg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/chinggg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/chinggg",
         "id" : 24590067,
         "login" : "chinggg",
         "node_id" : "MDQ6VXNlcjI0NTkwMDY3",
         "organizations_url" : "https://api.github.com/users/chinggg/orgs",
         "received_events_url" : "https://api.github.com/users/chinggg/received_events",
         "repos_url" : "https://api.github.com/users/chinggg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/chinggg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/chinggg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/chinggg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1008977187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008977187"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Using a negative annotation (`EXCLUSIVE_LOCKS_REQUIRED(!foo)`) is preferable in order to avoid \"false negatives in some cases\" that that link warns about (ie, the compiler not giving warnings about code that could result in double locking occurring), and `Mutex` is set up to require the use of negative annotations. That means making the change you suggest results in the error:\r\n\r\n```\r\ntxorphanage.cpp:167:5: error: calling function 'MaybeCheckNotHeld' requires negative capability '!m_mutex' [-Werror,-Wthread-safety-analysis]\r\n    LOCK(m_mutex);\r\n```",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-10-31T02:05:41Z",
      "diff_hunk" : "@@ -21,40 +21,46 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1008977187",
      "id" : 1008977187,
      "in_reply_to_id" : 1008872657,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII5848I8Uj",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 27,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 23,
      "pull_request_review_id" : 1161253409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008977187/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-31T02:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008977187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1022392642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022392642"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you already have a `Peer`, I don't think there's really any reason not to pass in.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-15T07:11:34Z",
      "diff_hunk" : "@@ -2878,20 +2878,20 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n /**\n  * Reconsider orphan transactions after a parent has been accepted to the mempool.\n  *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n+ * @peer[in]  peer                  The peer whose orphan transactions we will reconsider. Generally only one\n  *                                  orphan will be reconsidered on each call of this function. This set\n  *                                  may be added to if accepting an orphan causes its children to be\n  *                                  reconsidered.\n  */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+void PeerManagerImpl::ProcessOrphanTx(Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1022392642",
      "id" : 1022392642,
      "in_reply_to_id" : 998456864,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58488HlC",
      "original_commit_id" : "9910ed755c3dfd7669707b44d993a20030dd7477",
      "original_line" : 2886,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1180302492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022392642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-15T07:11:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022392642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025364390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025364390"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in 0027174b396cacbaac5fd52f13be3dca9fcbbfb8:\r\n\r\nIt's a bit confusing what \"This set\" refers to.\r\n\r\n```suggestion\r\n     *                     orphan will be reconsidered on each call of this function. The peer's orphan work set\r\n```",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-17T15:43:38Z",
      "diff_hunk" : "@@ -589,6 +589,14 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /**\n+     * Reconsider orphan transactions after a parent has been accepted to the mempool.\n+     *\n+     * @peer[in]  peer     The peer whose orphan transactions we will reconsider. Generally only one\n+     *                     orphan will be reconsidered on each call of this function. This set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025364390",
      "id" : 1025364390,
      "line" : 593,
      "node_id" : "PRRC_kwDOABII5849HdGm",
      "original_commit_id" : "0027174b396cacbaac5fd52f13be3dca9fcbbfb8",
      "original_line" : 596,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1184568433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025364390/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T18:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025364390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025481949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025481949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in 733d85f79cde353d8c9b54370f296b1031fa33d9 Note to self, my understanding here is:\r\n\r\n- The two threads that may access orphanage are (1) msg proc and (2) scheduler for calling `m_orphanage.EraseForBlock()` in `BlockConnected()`.\r\n- Previously, we held `g_cs_orphans` through the entirety of `ProcessOrphanTx`, and now we are grabbing the lock for each call here (`AddChildrenToWorkSet(*porphanTx, peer.m_id)`, `EraseTx(orphanHash)`).\r\n\r\nAnd this is fine. The \"problem\" would be if we called `BlockConnected` and e.g. evicted an orphan that was just confirmed. It's fine since `EraseTx()` handles if a tx is already gone, and `AddChildrenToworkSet()` will wait on `g_cs_orphans` for `EraseForBlock()` to be done updating `m_outpoint_to_orphan_it`.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-17T17:24:37Z",
      "diff_hunk" : "@@ -2885,7 +2885,6 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(g_msgproc_mutex);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025481949",
      "id" : 1025481949,
      "line" : 2889,
      "node_id" : "PRRC_kwDOABII5849H5zd",
      "original_commit_id" : "733d85f79cde353d8c9b54370f296b1031fa33d9",
      "original_line" : 2888,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 1184568433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025481949/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T18:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025481949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025498339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025498339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Was going to comment the same thing, this seems like a better interface given that we only want `originator`/`more` if there is a tx to work on, and generally avoiding in-out params is cleaner. (non-blocking)",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-17T17:41:06Z",
      "diff_hunk" : "@@ -21,40 +21,46 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns nullptr and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns the transaction reference, removes\n+     *  the transaction from the work set, and populates its arguments with\n+     *  the originating peer, and whether there are more orphans for this peer\n+     *  to work on after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    CTransactionRef GetTxToReconsider(NodeId peer, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025498339",
      "id" : 1025498339,
      "in_reply_to_id" : 998436721,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII5849H9zj",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 36,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 33,
      "pull_request_review_id" : 1184568433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025498339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T18:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025498339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025513432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025513432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're touching this, I think it's quite strange that we do this in a `while(!work_set.empty())` loop when we're trying to make sure that we only ever process 1 orphan at a time. Perhaps a remnant of pre-#15644 code? My suggestion is to take this out of the while loop and replace the `break`s with returns... but non-blocking of course, can do in another PR.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-17T17:54:12Z",
      "diff_hunk" : "@@ -2875,33 +2881,24 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(g_msgproc_mutex);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n-\n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n+    while (CTransactionRef porphanTx = m_orphanage.GetTxToReconsider(peer.m_id, from_peer, more)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1025513432",
      "id" : 1025513432,
      "line" : 2893,
      "node_id" : "PRRC_kwDOABII5849IBfY",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 2893,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1184568433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025513432/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T18:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025513432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1026077087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026077087"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's three \"loops\" I guess:\r\n\r\n * ThreadMessageHandler repeatedly calls ProcessMessages calls ProcessMessage calls ProcessOrphanTx; if ProcessOrphanTx returns true, ProcessMessage exits early so the next run of the ThreadMessageHandler loop for this peer immediately goes back to ProcessOrphanTx\r\n * `while (GetTxToReconsider)` here loops until it actually does some work (ProcessTransaction returns VALID or something other than TX_MISSING_INPUTS, returning `true` if the `while` loop could have continued\r\n * `GetTxToReconsider` loops over the peer's workset, returning the first entry in the workset that still exists as an orphan\r\n\r\nRemoving the `while (GetTxToReconsider)` loop would mean that we'd immediately switch to the next peer anytime we came across an orphan that needed two parents, rather than just one, despite that not taking much time to determine (it's part of MemPoolAccept::PreChecks). I don't think that would be wrong, but the way it is seems better to me.\r\n\r\nRemoving the internal loop for `GetTxToReconsider` would mean you'd need to return a new result: \"there's more work to do, but the first bit of work was a no-op\", and you'd be re-querying `m_peer_work_set.find(peer)` repeatedly.",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-18T06:42:49Z",
      "diff_hunk" : "@@ -2875,33 +2881,24 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(g_msgproc_mutex);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n-\n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n+    while (CTransactionRef porphanTx = m_orphanage.GetTxToReconsider(peer.m_id, from_peer, more)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1026077087",
      "id" : 1026077087,
      "in_reply_to_id" : 1025513432,
      "line" : 2893,
      "node_id" : "PRRC_kwDOABII5849KLGf",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 2893,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1185569972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026077087/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-18T06:42:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026077087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1026084766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026084766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There was some other followup ideas in the previous PR, particularly https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601221165 -- the idea there is that if Alice sends orphan tx Y which has a missing parent X, instead of immediately processing Y when X arrives (which might have arrived from Bob), just put it in Alice's workset, and delay processing of the orphan until it's Alice's turn. Then you'd have `peer == originator` and not need it to be returned as a result. At least last time I looked at this (the 202104-whohandlesorphans branch), it ended up simplifying the function to just `CTransactionRef GetTxToReconsider(NodeId peer)` (using `nullptr` as the \"there's nothing to consider\" indicator).",
      "commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "created_at" : "2022-11-18T06:57:58Z",
      "diff_hunk" : "@@ -21,40 +21,46 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns nullptr and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns the transaction reference, removes\n+     *  the transaction from the work set, and populates its arguments with\n+     *  the originating peer, and whether there are more orphans for this peer\n+     *  to work on after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    CTransactionRef GetTxToReconsider(NodeId peer, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26295#discussion_r1026084766",
      "id" : 1026084766,
      "in_reply_to_id" : 998436721,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII5849KM-e",
      "original_commit_id" : "7082ce3e88d77456d60a5a66bd38807fbd66f311",
      "original_line" : 36,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 33,
      "pull_request_review_id" : 1185581292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026084766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-18T06:58:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1026084766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
