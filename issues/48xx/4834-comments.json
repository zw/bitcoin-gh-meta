[
   {
      "body" : "Strange, test_bitcoin works perfectly here - even under valgrind.",
      "created_at" : "2014-09-04T13:04:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-54471481",
      "id" : 54471481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-04T13:04:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54471481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Bug fixed.\r\n\r\nLet it be known that\r\n```\r\nunordered_map::iterator it = mapA.find(x);\r\nif (it != mapB.end()) {\r\n```\r\nworks in recent Boost, but not in older Boost... (I assume that in newer ones, end() returns a map-independent constant).",
      "created_at" : "2014-09-04T19:10:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-54529133",
      "id" : 54529133,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-04T19:10:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54529133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253674"
         }
      },
      "body" : "Unrelated question, fDummy looks unused to me (even my compiler sais that ^^). Why is that flag there in the first place?",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-08T17:41:00Z",
      "diff_hunk" : "@@ -53,71 +53,76 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253674",
      "id" : 17253674,
      "original_commit_id" : "0cda129b675a2702108684816f2ebda70719f2d4",
      "original_position" : 25,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253792"
         }
      },
      "body" : "That's the point of a dummy :).\r\n\r\nThe reason it's there is to avoid having the compiler think that this is a copy constructor, IIRC.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-08T17:42:44Z",
      "diff_hunk" : "@@ -53,71 +53,76 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253792",
      "id" : 17253792,
      "original_commit_id" : "0cda129b675a2702108684816f2ebda70719f2d4",
      "original_position" : 25,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253912"
         }
      },
      "body" : "Thanks for clarification ^^, is there a comment about that fact or is this common pratcise in C++ anyway?",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-08T17:44:27Z",
      "diff_hunk" : "@@ -53,71 +53,76 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17253912",
      "id" : 17253912,
      "original_commit_id" : "0cda129b675a2702108684816f2ebda70719f2d4",
      "original_position" : 25,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17253912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Added a large randomized test for CCoinsViewCache that hopefully triggers all edge cases.",
      "created_at" : "2014-09-17T00:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-55831762",
      "id" : 55831762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-17T00:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55831762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@laanwj Can you have a look at this? Are the tests sufficient?",
      "created_at" : "2014-09-22T19:58:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-56431811",
      "id" : 56431811,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-22T19:58:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56431811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17899618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17899618"
         }
      },
      "body" : "Wouldn't \"explicit\" be enough to convince the compiler of that?\r\n",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T09:51:02Z",
      "diff_hunk" : "@@ -53,71 +53,76 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17899618",
      "id" : 17899618,
      "original_commit_id" : "0cda129b675a2702108684816f2ebda70719f2d4",
      "original_position" : 25,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17899618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17899969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17899969"
         }
      },
      "body" : "We no longer check the result of Spend() here. Is this on purpose?",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T10:02:03Z",
      "diff_hunk" : "@@ -1348,22 +1348,17 @@ void static InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state\n \n void UpdateCoins(const CTransaction& tx, CValidationState &state, CCoinsViewCache &inputs, CTxUndo &txundo, int nHeight)\n {\n-    bool ret;\n     // mark inputs spent\n     if (!tx.IsCoinBase()) {\n         txundo.vprevout.reserve(tx.vin.size());\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            const CTxIn &txin = tx.vin[i];\n-            CCoins &coins = inputs.GetCoins(txin.prevout.hash);\n+        BOOST_FOREACH(const CTxIn &txin, tx.vin) {\n             txundo.vprevout.push_back(CTxInUndo());\n-            ret = coins.Spend(txin.prevout, txundo.vprevout.back());\n-            assert(ret);\n+            inputs.ModifyCoins(txin.prevout.hash)->Spend(txin.prevout, txundo.vprevout.back());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17899969",
      "id" : 17899969,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17899969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17900205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17900205"
         }
      },
      "body" : "Do we need a flag/bitfield here to distinguish the cases\r\n\r\na) expect an entry to be already there for txid, creating a new one would be a mistake \r\n\r\nb) expect to create a new entry for txid, having one there already would be a mistake\r\n\r\nc) entry could be already there or be created anew, don't care\r\n\r\nIt appears we're slightly weakening the integrity checks in that regard.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T10:09:42Z",
      "diff_hunk" : "@@ -53,61 +53,67 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }\n \n-bool CCoinsViewCache::GetCoins(const uint256 &txid, CCoins &coins) const {\n-    if (cacheCoins.count(txid)) {\n-        coins = cacheCoins[txid];\n-        return true;\n-    }\n-    if (base->GetCoins(txid, coins)) {\n-        cacheCoins[txid] = coins;\n-        return true;\n-    }\n-    return false;\n-}\n-\n-CCoinsMap::iterator CCoinsViewCache::FetchCoins(const uint256 &txid) {\n+CCoinsMap::const_iterator CCoinsViewCache::FetchCoins(const uint256 &txid) const {\n     CCoinsMap::iterator it = cacheCoins.find(txid);\n     if (it != cacheCoins.end())\n         return it;\n     CCoins tmp;\n-    if (!base->GetCoins(txid,tmp))\n+    if (!base->GetCoins(txid, tmp))\n         return cacheCoins.end();\n-    CCoinsMap::iterator ret = cacheCoins.insert(it, std::make_pair(txid, CCoins()));\n-    tmp.swap(ret->second);\n+    CCoinsMap::iterator ret = cacheCoins.insert(std::make_pair(txid, CCoinsCacheEntry())).first;\n+    tmp.swap(ret->second.coins);\n+    if (ret->second.coins.IsPruned()) {\n+        // The parent only has an empty entry for this txid; we can consider our\n+        // version as fresh.\n+        ret->second.flags = CCoinsCacheEntry::FRESH;\n+    }\n     return ret;\n }\n \n-CCoinsMap::const_iterator CCoinsViewCache::FetchCoins(const uint256 &txid) const {\n-    /* Avoid redundant implementation with the const-cast.  */\n-    return const_cast<CCoinsViewCache*>(this)->FetchCoins(txid);\n+bool CCoinsViewCache::GetCoins(const uint256 &txid, CCoins &coins) const {\n+    CCoinsMap::const_iterator it = FetchCoins(txid);\n+    if (it != cacheCoins.end()) {\n+        coins = it->second.coins;\n+        return true;\n+    }\n+    return false;\n }\n \n-CCoins &CCoinsViewCache::GetCoins(const uint256 &txid) {\n-    CCoinsMap::iterator it = FetchCoins(txid);\n-    assert(it != cacheCoins.end());\n-    return it->second;\n+CCoinsModifier CCoinsViewCache::ModifyCoins(const uint256 &txid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17900205",
      "id" : 17900205,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 76,
      "path" : "src/coins.cpp",
      "position" : 80,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17900205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17900510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17900510"
         }
      },
      "body" : "We could add `assert(!hasModifier);` in the CCoinsViewCache destructor, to assert that the modifier never outlives the cache.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T10:19:16Z",
      "diff_hunk" : "@@ -313,20 +335,39 @@ class CCoinsViewBacked : public CCoinsView\n public:\n     CCoinsViewBacked(CCoinsView &viewIn);\n     bool GetCoins(const uint256 &txid, CCoins &coins) const;\n-    bool SetCoins(const uint256 &txid, const CCoins &coins);\n     bool HaveCoins(const uint256 &txid) const;\n     uint256 GetBestBlock() const;\n-    bool SetBestBlock(const uint256 &hashBlock);\n     void SetBackend(CCoinsView &viewIn);\n     bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\n     bool GetStats(CCoinsStats &stats) const;\n };\n \n \n+class CCoinsViewCache;\n+\n+/** A reference to a mutable cache entry. Encapsulating it allows us to run\n+ *  cleanup code after the modification is finished, and keeping track of\n+ *  concurrent modifications. */\n+class CCoinsModifier\n+{\n+private:\n+    CCoinsViewCache& cache;\n+    CCoinsMap::iterator it;\n+    CCoinsModifier(CCoinsViewCache& cache_, CCoinsMap::iterator it_);\n+\n+public:\n+    CCoins* operator->() { return &it->second.coins; }\n+    CCoins& operator*() { return it->second.coins; }\n+    ~CCoinsModifier();\n+    friend class CCoinsViewCache;\n+};\n+\n /** CCoinsView that adds a memory cache for transactions to another CCoinsView */\n class CCoinsViewCache : public CCoinsViewBacked",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17900510",
      "id" : 17900510,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 107,
      "path" : "src/coins.h",
      "position" : 110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17900510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17901060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17901060"
         }
      },
      "body" : "Does this mean that the test can randomly fail? (ie, if due to randomness it does not hit a branch?)\r\n",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T10:35:26Z",
      "diff_hunk" : "@@ -0,0 +1,178 @@\n+// Copyright (c) 2014 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coins.h\"\n+#include \"random.h\"\n+#include \"uint256.h\"\n+\n+#include <vector>\n+#include <map>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace\n+{\n+class CCoinsViewTest : public CCoinsView\n+{\n+    uint256 hashBestBlock_;\n+    std::map<uint256, CCoins> map_;\n+\n+public:\n+    bool GetCoins(const uint256& txid, CCoins& coins) const\n+    {\n+        std::map<uint256, CCoins>::const_iterator it = map_.find(txid);\n+        if (it == map_.end()) {\n+            return false;\n+        }\n+        coins = it->second;\n+        if (coins.IsPruned() && insecure_rand() % 2 == 0) {\n+            // Randomly return false in case of an empty entry.\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    bool HaveCoins(const uint256& txid) const\n+    {\n+        CCoins coins;\n+        return GetCoins(txid, coins);\n+    }\n+\n+    uint256 GetBestBlock() const { return hashBestBlock_; }\n+\n+    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock)\n+    {\n+        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); ) {\n+            map_[it->first] = it->second.coins;\n+            if (it->second.coins.IsPruned() && insecure_rand() % 3 == 0) {\n+                // Randomly delete empty entries on write.\n+                map_.erase(it->first);\n+            }\n+            mapCoins.erase(it++);\n+        }\n+        mapCoins.clear();\n+        hashBestBlock_ = hashBlock;\n+        return true;\n+    }\n+\n+    bool GetStats(CCoinsStats& stats) const { return false; }\n+};\n+}\n+\n+BOOST_AUTO_TEST_SUITE(coins_tests)\n+\n+static const unsigned int NUM_SIMULATION_ITERATIONS = 40000;\n+\n+// This is a large randomized insert/remove simulation test on a variable-size\n+// stack of caches on top of CCoinsViewTest.\n+//\n+// It will randomly create/update/delete CCoins entries to a tip of caches, with\n+// txids picked from a limited list of random 256-bit hashes. Occasionally, a\n+// new tip is added to the stack of caches, or the tip is flushed and removed.\n+//\n+// During the process, booleans are kept to make sure that the randomized\n+// operation hits all branches.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17901060",
      "id" : 17901060,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 75,
      "path" : "src/test/coins_tests.cpp",
      "position" : 75,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17901060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17935751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17935751"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T20:12:34Z",
      "diff_hunk" : "@@ -1348,22 +1348,17 @@ void static InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state\n \n void UpdateCoins(const CTransaction& tx, CValidationState &state, CCoinsViewCache &inputs, CTxUndo &txundo, int nHeight)\n {\n-    bool ret;\n     // mark inputs spent\n     if (!tx.IsCoinBase()) {\n         txundo.vprevout.reserve(tx.vin.size());\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            const CTxIn &txin = tx.vin[i];\n-            CCoins &coins = inputs.GetCoins(txin.prevout.hash);\n+        BOOST_FOREACH(const CTxIn &txin, tx.vin) {\n             txundo.vprevout.push_back(CTxInUndo());\n-            ret = coins.Spend(txin.prevout, txundo.vprevout.back());\n-            assert(ret);\n+            inputs.ModifyCoins(txin.prevout.hash)->Spend(txin.prevout, txundo.vprevout.back());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17935751",
      "id" : 17935751,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17935751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17942381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17942381"
         }
      },
      "body" : "Done.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T21:58:00Z",
      "diff_hunk" : "@@ -313,20 +335,39 @@ class CCoinsViewBacked : public CCoinsView\n public:\n     CCoinsViewBacked(CCoinsView &viewIn);\n     bool GetCoins(const uint256 &txid, CCoins &coins) const;\n-    bool SetCoins(const uint256 &txid, const CCoins &coins);\n     bool HaveCoins(const uint256 &txid) const;\n     uint256 GetBestBlock() const;\n-    bool SetBestBlock(const uint256 &hashBlock);\n     void SetBackend(CCoinsView &viewIn);\n     bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\n     bool GetStats(CCoinsStats &stats) const;\n };\n \n \n+class CCoinsViewCache;\n+\n+/** A reference to a mutable cache entry. Encapsulating it allows us to run\n+ *  cleanup code after the modification is finished, and keeping track of\n+ *  concurrent modifications. */\n+class CCoinsModifier\n+{\n+private:\n+    CCoinsViewCache& cache;\n+    CCoinsMap::iterator it;\n+    CCoinsModifier(CCoinsViewCache& cache_, CCoinsMap::iterator it_);\n+\n+public:\n+    CCoins* operator->() { return &it->second.coins; }\n+    CCoins& operator*() { return it->second.coins; }\n+    ~CCoinsModifier();\n+    friend class CCoinsViewCache;\n+};\n+\n /** CCoinsView that adds a memory cache for transactions to another CCoinsView */\n class CCoinsViewCache : public CCoinsViewBacked",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17942381",
      "id" : 17942381,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 107,
      "path" : "src/coins.h",
      "position" : 110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17942381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17942448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17942448"
         }
      },
      "body" : "Given that we're doing 40000 iterations of it, that should be exceedingly unlikely (plus the random numbers are deterministic, so it would only break after actual code changes).",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T21:59:18Z",
      "diff_hunk" : "@@ -0,0 +1,178 @@\n+// Copyright (c) 2014 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coins.h\"\n+#include \"random.h\"\n+#include \"uint256.h\"\n+\n+#include <vector>\n+#include <map>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace\n+{\n+class CCoinsViewTest : public CCoinsView\n+{\n+    uint256 hashBestBlock_;\n+    std::map<uint256, CCoins> map_;\n+\n+public:\n+    bool GetCoins(const uint256& txid, CCoins& coins) const\n+    {\n+        std::map<uint256, CCoins>::const_iterator it = map_.find(txid);\n+        if (it == map_.end()) {\n+            return false;\n+        }\n+        coins = it->second;\n+        if (coins.IsPruned() && insecure_rand() % 2 == 0) {\n+            // Randomly return false in case of an empty entry.\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    bool HaveCoins(const uint256& txid) const\n+    {\n+        CCoins coins;\n+        return GetCoins(txid, coins);\n+    }\n+\n+    uint256 GetBestBlock() const { return hashBestBlock_; }\n+\n+    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock)\n+    {\n+        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); ) {\n+            map_[it->first] = it->second.coins;\n+            if (it->second.coins.IsPruned() && insecure_rand() % 3 == 0) {\n+                // Randomly delete empty entries on write.\n+                map_.erase(it->first);\n+            }\n+            mapCoins.erase(it++);\n+        }\n+        mapCoins.clear();\n+        hashBestBlock_ = hashBlock;\n+        return true;\n+    }\n+\n+    bool GetStats(CCoinsStats& stats) const { return false; }\n+};\n+}\n+\n+BOOST_AUTO_TEST_SUITE(coins_tests)\n+\n+static const unsigned int NUM_SIMULATION_ITERATIONS = 40000;\n+\n+// This is a large randomized insert/remove simulation test on a variable-size\n+// stack of caches on top of CCoinsViewTest.\n+//\n+// It will randomly create/update/delete CCoins entries to a tip of caches, with\n+// txids picked from a limited list of random 256-bit hashes. Occasionally, a\n+// new tip is added to the stack of caches, or the tip is flushed and removed.\n+//\n+// During the process, booleans are kept to make sure that the randomized\n+// operation hits all branches.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17942448",
      "id" : 17942448,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 75,
      "path" : "src/test/coins_tests.cpp",
      "position" : 75,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17942448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Replaced the dummy arg with an explicit constructor.",
      "created_at" : "2014-09-23T23:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-56605404",
      "id" : 56605404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-23T23:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56605404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17946444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17946444"
         }
      },
      "body" : "This really complicates things. We're in many cases already treating no-entry as empty-CCoins, and have had problems with incorrectly treating differences between them (on a reorg we may replace added entries with empties, for example).\r\n\r\nPerhaps we already have problems in this space; I'm more in favor of an interface that explicitly treats them identically for this reason.\r\n\r\nAre there any use sites where you think we reduced sanity checking?",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-23T23:38:43Z",
      "diff_hunk" : "@@ -53,61 +53,67 @@ bool CCoins::Spend(int nPos) {\n \n \n bool CCoinsView::GetCoins(const uint256 &txid, CCoins &coins) const { return false; }\n-bool CCoinsView::SetCoins(const uint256 &txid, const CCoins &coins) { return false; }\n bool CCoinsView::HaveCoins(const uint256 &txid) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(0); }\n-bool CCoinsView::SetBestBlock(const uint256 &hashBlock) { return false; }\n bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return false; }\n bool CCoinsView::GetStats(CCoinsStats &stats) const { return false; }\n \n \n CCoinsViewBacked::CCoinsViewBacked(CCoinsView &viewIn) : base(&viewIn) { }\n bool CCoinsViewBacked::GetCoins(const uint256 &txid, CCoins &coins) const { return base->GetCoins(txid, coins); }\n-bool CCoinsViewBacked::SetCoins(const uint256 &txid, const CCoins &coins) { return base->SetCoins(txid, coins); }\n bool CCoinsViewBacked::HaveCoins(const uint256 &txid) const { return base->HaveCoins(txid); }\n uint256 CCoinsViewBacked::GetBestBlock() const { return base->GetBestBlock(); }\n-bool CCoinsViewBacked::SetBestBlock(const uint256 &hashBlock) { return base->SetBestBlock(hashBlock); }\n void CCoinsViewBacked::SetBackend(CCoinsView &viewIn) { base = &viewIn; }\n bool CCoinsViewBacked::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) { return base->BatchWrite(mapCoins, hashBlock); }\n bool CCoinsViewBacked::GetStats(CCoinsStats &stats) const { return base->GetStats(stats); }\n \n CCoinsKeyHasher::CCoinsKeyHasher() : salt(GetRandHash()) {}\n \n-CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hashBlock(0) { }\n+CCoinsViewCache::CCoinsViewCache(CCoinsView &baseIn, bool fDummy) : CCoinsViewBacked(baseIn), hasModifier(false), hashBlock(0) { }\n \n-bool CCoinsViewCache::GetCoins(const uint256 &txid, CCoins &coins) const {\n-    if (cacheCoins.count(txid)) {\n-        coins = cacheCoins[txid];\n-        return true;\n-    }\n-    if (base->GetCoins(txid, coins)) {\n-        cacheCoins[txid] = coins;\n-        return true;\n-    }\n-    return false;\n-}\n-\n-CCoinsMap::iterator CCoinsViewCache::FetchCoins(const uint256 &txid) {\n+CCoinsMap::const_iterator CCoinsViewCache::FetchCoins(const uint256 &txid) const {\n     CCoinsMap::iterator it = cacheCoins.find(txid);\n     if (it != cacheCoins.end())\n         return it;\n     CCoins tmp;\n-    if (!base->GetCoins(txid,tmp))\n+    if (!base->GetCoins(txid, tmp))\n         return cacheCoins.end();\n-    CCoinsMap::iterator ret = cacheCoins.insert(it, std::make_pair(txid, CCoins()));\n-    tmp.swap(ret->second);\n+    CCoinsMap::iterator ret = cacheCoins.insert(std::make_pair(txid, CCoinsCacheEntry())).first;\n+    tmp.swap(ret->second.coins);\n+    if (ret->second.coins.IsPruned()) {\n+        // The parent only has an empty entry for this txid; we can consider our\n+        // version as fresh.\n+        ret->second.flags = CCoinsCacheEntry::FRESH;\n+    }\n     return ret;\n }\n \n-CCoinsMap::const_iterator CCoinsViewCache::FetchCoins(const uint256 &txid) const {\n-    /* Avoid redundant implementation with the const-cast.  */\n-    return const_cast<CCoinsViewCache*>(this)->FetchCoins(txid);\n+bool CCoinsViewCache::GetCoins(const uint256 &txid, CCoins &coins) const {\n+    CCoinsMap::const_iterator it = FetchCoins(txid);\n+    if (it != cacheCoins.end()) {\n+        coins = it->second.coins;\n+        return true;\n+    }\n+    return false;\n }\n \n-CCoins &CCoinsViewCache::GetCoins(const uint256 &txid) {\n-    CCoinsMap::iterator it = FetchCoins(txid);\n-    assert(it != cacheCoins.end());\n-    return it->second;\n+CCoinsModifier CCoinsViewCache::ModifyCoins(const uint256 &txid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17946444",
      "id" : 17946444,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 76,
      "path" : "src/coins.cpp",
      "position" : 80,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:35:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17946444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Nope, that didn't work - the compiler still uses the explicit constructor for assignment (because the type is different). Solved it now by passing a pointer rather than a reference (in a separate commit).",
      "created_at" : "2014-09-24T01:19:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-56613389",
      "id" : 56613389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-24T01:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56613389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4834_7c70438dc67547e83953ba0343a071fae304ce65/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-09-24T01:34:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-56614283",
      "id" : 56614283,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-24T01:34:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56614283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17950444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17950444"
         }
      },
      "body" : "Just a 1000 iterations is enough to trigger all branches, by the way.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-24T01:51:10Z",
      "diff_hunk" : "@@ -0,0 +1,178 @@\n+// Copyright (c) 2014 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coins.h\"\n+#include \"random.h\"\n+#include \"uint256.h\"\n+\n+#include <vector>\n+#include <map>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace\n+{\n+class CCoinsViewTest : public CCoinsView\n+{\n+    uint256 hashBestBlock_;\n+    std::map<uint256, CCoins> map_;\n+\n+public:\n+    bool GetCoins(const uint256& txid, CCoins& coins) const\n+    {\n+        std::map<uint256, CCoins>::const_iterator it = map_.find(txid);\n+        if (it == map_.end()) {\n+            return false;\n+        }\n+        coins = it->second;\n+        if (coins.IsPruned() && insecure_rand() % 2 == 0) {\n+            // Randomly return false in case of an empty entry.\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    bool HaveCoins(const uint256& txid) const\n+    {\n+        CCoins coins;\n+        return GetCoins(txid, coins);\n+    }\n+\n+    uint256 GetBestBlock() const { return hashBestBlock_; }\n+\n+    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock)\n+    {\n+        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); ) {\n+            map_[it->first] = it->second.coins;\n+            if (it->second.coins.IsPruned() && insecure_rand() % 3 == 0) {\n+                // Randomly delete empty entries on write.\n+                map_.erase(it->first);\n+            }\n+            mapCoins.erase(it++);\n+        }\n+        mapCoins.clear();\n+        hashBestBlock_ = hashBlock;\n+        return true;\n+    }\n+\n+    bool GetStats(CCoinsStats& stats) const { return false; }\n+};\n+}\n+\n+BOOST_AUTO_TEST_SUITE(coins_tests)\n+\n+static const unsigned int NUM_SIMULATION_ITERATIONS = 40000;\n+\n+// This is a large randomized insert/remove simulation test on a variable-size\n+// stack of caches on top of CCoinsViewTest.\n+//\n+// It will randomly create/update/delete CCoins entries to a tip of caches, with\n+// txids picked from a limited list of random 256-bit hashes. Occasionally, a\n+// new tip is added to the stack of caches, or the tip is flushed and removed.\n+//\n+// During the process, booleans are kept to make sure that the randomized\n+// operation hits all branches.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17950444",
      "id" : 17950444,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 75,
      "path" : "src/test/coins_tests.cpp",
      "position" : 75,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T01:51:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17950444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17961163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17961163"
         }
      },
      "body" : "OK - good idea to make it determinisic, so at least in the case that it fails it will fail every time.",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-09-24T09:13:23Z",
      "diff_hunk" : "@@ -0,0 +1,178 @@\n+// Copyright (c) 2014 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coins.h\"\n+#include \"random.h\"\n+#include \"uint256.h\"\n+\n+#include <vector>\n+#include <map>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace\n+{\n+class CCoinsViewTest : public CCoinsView\n+{\n+    uint256 hashBestBlock_;\n+    std::map<uint256, CCoins> map_;\n+\n+public:\n+    bool GetCoins(const uint256& txid, CCoins& coins) const\n+    {\n+        std::map<uint256, CCoins>::const_iterator it = map_.find(txid);\n+        if (it == map_.end()) {\n+            return false;\n+        }\n+        coins = it->second;\n+        if (coins.IsPruned() && insecure_rand() % 2 == 0) {\n+            // Randomly return false in case of an empty entry.\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    bool HaveCoins(const uint256& txid) const\n+    {\n+        CCoins coins;\n+        return GetCoins(txid, coins);\n+    }\n+\n+    uint256 GetBestBlock() const { return hashBestBlock_; }\n+\n+    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock)\n+    {\n+        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); ) {\n+            map_[it->first] = it->second.coins;\n+            if (it->second.coins.IsPruned() && insecure_rand() % 3 == 0) {\n+                // Randomly delete empty entries on write.\n+                map_.erase(it->first);\n+            }\n+            mapCoins.erase(it++);\n+        }\n+        mapCoins.clear();\n+        hashBestBlock_ = hashBlock;\n+        return true;\n+    }\n+\n+    bool GetStats(CCoinsStats& stats) const { return false; }\n+};\n+}\n+\n+BOOST_AUTO_TEST_SUITE(coins_tests)\n+\n+static const unsigned int NUM_SIMULATION_ITERATIONS = 40000;\n+\n+// This is a large randomized insert/remove simulation test on a variable-size\n+// stack of caches on top of CCoinsViewTest.\n+//\n+// It will randomly create/update/delete CCoins entries to a tip of caches, with\n+// txids picked from a limited list of random 256-bit hashes. Occasionally, a\n+// new tip is added to the stack of caches, or the tip is flushed and removed.\n+//\n+// During the process, booleans are kept to make sure that the randomized\n+// operation hits all branches.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r17961163",
      "id" : 17961163,
      "original_commit_id" : "3067f33ec986eeb2b6fd7014cae0ad98be931bfe",
      "original_position" : 75,
      "path" : "src/test/coins_tests.cpp",
      "position" : 75,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-09-24T09:13:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/17961163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Works for me, tested ACK",
      "created_at" : "2014-09-24T10:42:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-56652851",
      "id" : 56652851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-24T10:42:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56652851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@gmaxwell @jgarzik Comments?",
      "created_at" : "2014-09-26T18:47:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-57004196",
      "id" : 57004196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-09-26T18:47:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/57004196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ACK. (tested a previous version but moving my test hosts to the current version now)",
      "created_at" : "2014-10-08T08:35:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#issuecomment-58326510",
      "id" : 58326510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4834",
      "updated_at" : "2014-10-08T08:35:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58326510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r21580505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21580505"
         }
      },
      "body" : "How useful is this extra debug info? Can it be made optional perhaps?",
      "commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "created_at" : "2014-12-10T02:22:00Z",
      "diff_hunk" : "@@ -1804,10 +1797,10 @@ void static UpdateTip(CBlockIndex *pindexNew) {\n     nTimeBestReceived = GetTime();\n     mempool.AddTransactionsUpdated(1);\n \n-    LogPrintf(\"UpdateTip: new best=%s  height=%d  log2_work=%.8g  tx=%lu  date=%s progress=%f\\n\",\n+    LogPrintf(\"UpdateTip: new best=%s  height=%d  log2_work=%.8g  tx=%lu  date=%s progress=%f  cache=%u\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4834#discussion_r21580505",
      "id" : 21580505,
      "original_commit_id" : "7c70438dc67547e83953ba0343a071fae304ce65",
      "original_position" : 126,
      "path" : "src/main.cpp",
      "position" : 126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4834",
      "updated_at" : "2014-12-10T02:22:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21580505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
