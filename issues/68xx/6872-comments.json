[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956177"
         }
      },
      "body" : "You can do slightly better:\r\n```if (it != cacheCoins.end() && (((it->second.flags & CCoinsCacheEntry::DIRTY) == 0) || ((it->second.flags & CCoinsCacheEntry::FRESH) && it->second.coins.IsPruned())))```\r\n\r\nThis will also allow removing entries that were created and spent entirely within a cache.",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T02:38:41Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956177",
      "id" : 42956177,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956355"
         }
      },
      "body" : "Such an entry should probably be removed without a call to Uncache, no?",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T02:45:11Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956355",
      "id" : 42956355,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956411"
         }
      },
      "body" : "Uh, right, and it already is... never mind!",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T02:46:51Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956411",
      "id" : 42956411,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956567"
         }
      },
      "body" : "Even if HaveCoins returns false, the entry may have been pulled into the cache (the parent cache may have a pruned entry), so this probably works better outside of the else branch.",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T02:51:00Z",
      "diff_hunk" : "@@ -830,18 +850,22 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         view.SetBackend(viewMemPool);\n \n         // do we already have it?\n-        if (view.HaveCoins(hash))\n+        if (view.HaveCoins(hash)) {\n+            vHashTxnToUncache.push_back(hash);\n             return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-known\");\n+        }\n \n         // do all inputs exist?\n         // Note that this does not check for the presence of actual outputs (see the next check for that),\n         // and only helps with filling in pfMissingInputs (to determine missing vs spent).\n         BOOST_FOREACH(const CTxIn txin, tx.vin) {\n+            bool fMaybeUncache = !view.HaveCoinsInCache(txin.prevout.hash);\n             if (!view.HaveCoins(txin.prevout.hash)) {\n                 if (pfMissingInputs)\n                     *pfMissingInputs = true;\n                 return false; // fMissingInputs and !state.IsInvalid() is used to detect this condition, don't set state.Invalid()\n-            }\n+            } else if (fMaybeUncache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956567",
      "id" : 42956567,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 67,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956863"
         }
      },
      "body" : "If coinsUsage is larger than nCoinCacheUsage + limit, this results in an infinite loop?\r\n",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T03:00:20Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956863",
      "id" : 42956863,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956959"
         }
      },
      "body" : "Huh? I could have sworn I deleted the loop as it is too easy for an attacker to fuck with your mempool, even if it did work.",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T03:04:11Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956959",
      "id" : 42956959,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Do you feel like pulling in https://github.com/sipa/bitcoin/commit/4186ac95f8283206874af50f9754e894823df66d ?",
      "created_at" : "2015-10-26T03:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151013314",
      "id" : 151013314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T03:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151013314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42957654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42957654"
         }
      },
      "body" : "Yeah, I think that loop and the link with coincache size should go away. The coincache size shouldn't exceed its own limit, and the mempool shouldn't exceed its own limit. We may want to move to a model where the size for both is set using a single limit, but that will require other changes elsewhere too.",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T03:32:38Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42957654",
      "id" : 42957654,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T05:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42957654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "https://github.com/sipa/bitcoin/commit/4186ac95f8283206874af50f9754e894823df66d seems pretty nasty to me....completely clearing the cache when we add a transaction that pushes our cache over 90% usage seems like a really bad idea.",
      "created_at" : "2015-10-26T05:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151026142",
      "id" : 151026142,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151026142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt it's a last resort. If the cache size can grow outside of its\nset bounds, we have to do something or there is no limit. Furthermore, it's\nthe same as what will happen anyway after the next block.\n\nI considered it unacceptable on its own, as it would makr transaction\nspamming result in more or less synchronized wiping of the cache across the\nnetwork, which could interfere with relay. Hopefully the rest of your patch\nshould reduce the risk of that.\n",
      "created_at" : "2015-10-26T05:08:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151026525",
      "id" : 151026525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151026525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Wiping the cache sounds like a dirty hack to me. I'd rather evict random elements until the cache is reasonably-sized than that.",
      "created_at" : "2015-10-26T05:10:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151026635",
      "id" : 151026635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151026635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Also, we should fix it to not dump the entire cache after each new block.",
      "created_at" : "2015-10-26T05:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151026688",
      "id" : 151026688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151026688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "That, or some for of LRU or priority tracking in the coin cache would be a\nsignificant improvement for sure.\n\nBut we need a means to limit memory usage at all costs IMHO, and this\nsolution is simple and doesn't worsen things on average, I think, as the\ncache would be flushed anyway at the next block - potentially even in\nbetween blocks in a reorg if the usage passed 100% by that time.\n",
      "created_at" : "2015-10-26T05:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151026879",
      "id" : 151026879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:13:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151026879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Sure, making the cache smarter would be nice, but lets not rush to fix it with a dirty hack when we're not even gonna ship the fix for a few months anyway.",
      "created_at" : "2015-10-26T05:15:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151027027",
      "id" : 151027027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:15:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151027027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "It's orthogonal. We need to enforce memory usage limits after each\ntransaction, so let's call the function to do that at that time.\n\nHow that function works is a different matter, and can be arbitrarily\nimproved later.\n\nI don't understand your resistance here. I think it's the only solution.\n",
      "created_at" : "2015-10-26T05:17:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151027242",
      "id" : 151027242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T05:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151027242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Have you guys looked into how expensive all this work is?\r\n\r\n@sipa Once we've made it so that you can't bloat memory usage with txs that aren't accepted (as accomplished by this pull) then it seems to me the right approach is to just set your maxmempool size low enough that the unknown and variable multiple of that that is the size of your cache is also small enough for you.  IMHO, the default dbcache size is too small.  I'm with @TheBlueMatt that it seems bad to randomly wipe it unless we think that'll be very rare.\r\n\r\nI'd actually argue we might not even need to remove cache entries that are due to evicted tx's, because there is a relay cost that is paid to create those.",
      "created_at" : "2015-10-26T13:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151139005",
      "id" : 151139005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T13:49:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151139005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42995095"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42995095"
         }
      },
      "body" : "If I understand correctly, then we might remove this transaction from the cache even though there may be in-mempool spends of it, right?  I think we want some kind of check like you have in `TrimToSize`, where you only uncache if there's nothing in the mempool that spends it.\r\n\r\n(Alternatively, if `HaveCoins` somehow reported whether any new caching happened, that might be helpful, but that seems like a harder change to make.)",
      "commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "created_at" : "2015-10-26T13:55:03Z",
      "diff_hunk" : "@@ -830,13 +842,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         view.SetBackend(viewMemPool);\n \n         // do we already have it?\n-        if (view.HaveCoins(hash))\n+        if (view.HaveCoins(hash)) {\n+            vHashTxnToUncache.push_back(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42995095",
      "id" : 42995095,
      "original_commit_id" : "d5b4e90270bea8020642bb448e5e63ff0ec76220",
      "original_position" : 45,
      "path" : "src/main.cpp",
      "position" : 45,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T13:55:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42995095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Sure, if the eventual solution is to tweak FlushStateToDisk to be\nsmarter (LRU or some priority metric based on what's in mempool), then\nthat would be reasonable. I am, however, worried we'd merge it and\nforget to tweak the coins cache, making it even easier (maybe, though\nmaybe there are easier ways anyway) for an attacker to cause lots of\nrandom disk I/O.\n\nOn 10/26/15 05:17, Pieter Wuille wrote:\n> It's orthogonal. We need to enforce memory usage limits after each\n> transaction, so let's call the function to do that at that time.\n> \n> How that function works is a different matter, and can be arbitrarily\n> improved later.\n> \n> I don't understand your resistance here. I think it's the only solution.\n> \n> Ã¢ÂÂ\n> Reply to this email directly or view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151027242>.\n> \n",
      "created_at" : "2015-10-27T00:31:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151324479",
      "id" : 151324479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T00:31:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151324479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I think we should move to a model of thinking where exceeding some reasonable but fixed memory limit is equivalent in badness to crashing. People need to be able to rely on the memory usage to remain bounded. So if it's a choice between more I/O and that, I think the first is far better.",
      "created_at" : "2015-10-27T01:11:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151331090",
      "id" : 151331090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T01:11:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151331090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I think thats a fine idea...except that we're so far away from it, it seems a bit premature to be optimizing for it now.",
      "created_at" : "2015-10-27T01:40:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151339635",
      "id" : 151339635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T01:40:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151339635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "concept ACK",
      "created_at" : "2015-10-27T03:15:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151360117",
      "id" : 151360117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T03:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151360117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "Observation:\r\n```\r\n2015-10-27 20:49:07 dd310afee248d4699e462e5d3826e879cc19d1d2d34e9de0070811d1d5f6e64a from peer=15 was not accepted: rate limited free transaction (code 66)\r\n2015-10-27 20:49:07 ATMT increases coincache by 159 (to 614694) KiB\r\n```\r\n\r\nSo when ATMT rejects due to rate limiting, the coincache entries pulled in don't seem to be removed.",
      "created_at" : "2015-10-27T20:50:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151639641",
      "id" : 151639641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T20:50:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151639641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Observation:\r\n```\r\n2015-10-27 20:52:57 a94894230e8c647d11dc67c2f7d56e91913aab8c6b3f7257f36d2cea30ddfbeb from peer=5 was not accepted: non-mandatory-script-verify-flag (No error) (code 64)\r\n2015-10-27 20:52:57 ATMT increases coincache by 329 (to 991099) KiB\r\n```\r\n",
      "created_at" : "2015-10-27T20:55:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151640859",
      "id" : 151640859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T20:55:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151640859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "My observations are likely explained by this patch not updating coinsCachedUsage, so the pcoinsTip->DynamicMemoryUsage() going off the charts.",
      "created_at" : "2015-10-27T21:07:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151644381",
      "id" : 151644381,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T21:07:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151644381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "New observation:\r\n```\r\n2015-10-27 21:27:43 cd55b134090117cc7fbf4ad8d1039642f1dd63460daa27c59d1c0ae2aba3e582 from peer=14 was not accepted: mempool min fee not met, 15000 < 24788 (code 66)\r\n2015-10-27 21:27:43 ATMT decreases coincache by 105 (to 67916) KiB\r\n```\r\n",
      "created_at" : "2015-10-27T21:29:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151650422",
      "id" : 151650422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-27T21:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151650422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Tested ACK.",
      "created_at" : "2015-10-30T20:54:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-152648799",
      "id" : 152648799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-30T20:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/152648799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I'm a bit hesitant to merge this instead of a cleaner way of smart flushing and I'd still like to see some performance analysis.\r\n",
      "created_at" : "2015-10-30T21:28:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-152655551",
      "id" : 152655551,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-30T21:28:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/152655551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Without this, my mining node with an elevated relay fee (and running mempool limiting) and default dbcache is at 4GB RES.  We do need to do more to control the size of the coins cache, if not precisely this change.",
      "created_at" : "2015-11-08T00:13:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-154766772",
      "id" : 154766772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-11-08T00:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/154766772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I did some benchmarking on this pull.  I built it on top of all the other improvements in #6976 except I tried it with and without the hot cache.  It caused a significant performance boost to ConnectBlock.  Unfortunately on my test days, 10/6 and 10/7 and using 100 M mempool and 200 M dbcache, the total cpu time shot up by over 10%.   This seems to be entirely due to the 15kb very low fee transaction spam and increased time to reject these txs.  I did not break down where the time was spent, but my guess is that it is not all in the uncaching code and that part of the problem is that these large txs often spent from the same prev hashes.  So by uncaching them we cause more time to be spent just calculating the fee of new txs before we can reject them.  \r\nIt also had the desired effect of reducing cache size, and reduced cache flushes from 38 to 16 over the 2 days.\r\n\r\nHere is a summary of the results.  I haven't fully reviewed the code yet, but I think this might be a performance hit we could tolerate.\r\n\r\n\r\nCode | Avg time for tx rejected by ATMP (ms) | Avg time to connect block (ms)\r\n--- | --- | ---\r\nbaseline (#6976 except #6936) | 1.7 | 134\r\nbaseline + #6936 | 1.7 | 128\r\nbaseline + this PR | 2.9 | 109\r\nbaseline + this PR + #6936 | 2.9 | 104\r\n\r\n\r\n",
      "created_at" : "2015-11-09T21:40:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-155206819",
      "id" : 155206819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-11-09T21:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155206819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2015-11-28T13:23:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-160295897",
      "id" : 160295897,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-11-28T13:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160295897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Still needs rebase",
      "created_at" : "2015-12-01T08:42:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-160895230",
      "id" : 160895230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-12-01T08:42:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160895230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Yes, sorry, I thought the plan was to go forward with #6936 and skip this one entirely, but it seems there is some consensus to do this as an intermediate until #6936 is fully ready to replace it (probably 0.13). Will try to rebase this tomorrow.",
      "created_at" : "2015-12-01T09:19:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-160904856",
      "id" : 160904856,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-12-01T09:19:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160904856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased, squashed, pulled in https://github.com/sipa/bitcoin/commit/4186ac95f8283206874af50f9754e894823df66d for 0.12.",
      "created_at" : "2015-12-01T10:22:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-160926684",
      "id" : 160926684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-12-01T10:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160926684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt Needs rebase. (Travis fail is unrelated:  #6540)",
      "created_at" : "2015-12-01T12:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-160954436",
      "id" : 160954436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-12-01T12:30:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160954436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
