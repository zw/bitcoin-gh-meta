[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1743756406) |\n| Concept ACK | [D33r-Gee](https://github.com/bitcoin/bitcoin/pull/27596#pullrequestreview-1516971308), [Sjors](https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1727846633) |\n| Stale ACK | [pablomartin4btc](https://github.com/bitcoin/bitcoin/pull/27596#pullrequestreview-1640753506), [fjahr](https://github.com/bitcoin/bitcoin/pull/27596#pullrequestreview-1651722959), [naumenkogs](https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1742695834), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/27596#pullrequestreview-1652917347) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28550](https://github.com/bitcoin/bitcoin/pull/28550) (Covenant tools softfork by jamesob)\n* [#28453](https://github.com/bitcoin/bitcoin/pull/28453) (wallet: Receive silent payment transactions by achow101)\n* [#28368](https://github.com/bitcoin/bitcoin/pull/28368) (Fee Estimator updates from Validation Interface/CScheduler thread by ismaelsadeeq)\n* [#28120](https://github.com/bitcoin/bitcoin/pull/28120) (p2p: make block download logic aware of limited peers threshold by furszy)\n* [#28031](https://github.com/bitcoin/bitcoin/pull/28031) (Package Relay 1/3: Introduce TxDownloadManager and improve orphan-handling by glozow)\n* [#27837](https://github.com/bitcoin/bitcoin/pull/27837) (net: introduce block tracker to retry to download blocks after failure by furszy)\n* [#27770](https://github.com/bitcoin/bitcoin/pull/27770) (Introduce 'getblockfileinfo' RPC command by furszy)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (bugfix: Make `CCheckQueue` RAII-styled (attempt 2) by hebasto)\n* [#26045](https://github.com/bitcoin/bitcoin/pull/26045) (rpc: Optimize serialization disk space of dumptxoutset by aureleoules)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-08T15:08:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1538523343",
      "id" : 1538523343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585btADP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538523343/reactions"
      },
      "updated_at" : "2023-10-02T20:59:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538523343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI's passing after a silent conflict in the rebase. I've added a link to @Sjors' snapshot torrent in the PR description.\r\n\r\nNo known outstanding issues here; ready for testing!",
      "created_at" : "2023-05-08T17:26:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1538759099",
      "id" : 1538759099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585bt5m7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538759099/reactions"
      },
      "updated_at" : "2023-05-08T17:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538759099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2023-05-09T15:30:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1540397377",
      "id" : 1540397377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b0JlB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540397377/reactions"
      },
      "updated_at" : "2023-05-09T15:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540397377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When running 8f431ad3b600a8f7e6dff83354ac3475b8936505 I noticed (and reproduced) that `-prune` is not fully honored when loading a snapshot and doing background validation. When I set `-prune=550` the blocks dir ends up somewhere between 3 and 5 GB. Judging by the blkâ¦.dat timestamps it seems that both the snapshot and background IBD hold on to more blocks than they should. Tested on Ubuntu 23.04 and with coinstats- and blockfilterindex enabled. The first time I tested I allowed the node to sync for a few hours before loading the snapshot, the second time I loaded the snapshot almost immediately.",
      "created_at" : "2023-05-10T07:10:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1541467462",
      "id" : 1541467462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b4O1G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1541467462/reactions"
      },
      "updated_at" : "2023-05-10T07:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1541467462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob What's your feeling on how important figuring out the fix for the pruning issue is at the moment? People don't consider it blocking #24008, right? Just curious about where to spend review time right now. FWIW, I noted the same issue on `getblockfrompeer` and wrote a test for it back then, in case you haven't seen it, it might come in handy: https://github.com/bitcoin/bitcoin/pull/23813",
      "created_at" : "2023-05-10T12:58:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542165949",
      "id" : 1542165949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b65W9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542165949/reactions"
      },
      "updated_at" : "2023-05-10T12:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542165949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> What's your feeling on how important figuring out the fix for the pruning issue is at the moment? People don't consider it blocking https://github.com/bitcoin/bitcoin/pull/24008, right?\r\n\r\nRight, pruning issues shouldn't block #24008 - those changes need to happen regardless of how we manage pruning with snapshots.\r\n\r\nI'll reproduce/investigate the pruning issues over the coming days. But it's worth noting that @Sjors didn't see any regressions in pruning on this branch _before_ loading the snapshot, meaning the degraded pruning behavior only kicks in if the user loads a snapshot. And even though, the code just doesn't prune as aggressively as it seems it should.",
      "created_at" : "2023-05-10T15:05:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542375384",
      "id" : 1542375384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b7sfY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542375384/reactions"
      },
      "updated_at" : "2023-05-10T15:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542375384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hm, for what it's worth, pruning is working as expected for me on this branch.\r\n\r\n![image](https://github.com/bitcoin/bitcoin/assets/73197/95b5615a-f4ca-4af5-96e4-30969fdc6940)\r\n\r\n```\r\nEvery 2.0s: cat <(./src/bitcoin-cli -datadir=/home/james/tmp/bitcoin-au-testing getmempoolinfo) <( ./src/bitcoin-cli -datadir=/home/james/tmp/bitcoin-au-testing getchainstates)                                                                                                                                                                         fido: Wed May 10 11:16:49 2023\r\n\r\n{\r\n  \"loaded\": true,\r\n  \"size\": 108146,\r\n  \"bytes\": 42192499,\r\n  \"usage\": 234882016,\r\n  \"total_fee\": 23.04459003,\r\n  \"maxmempool\": 300000000,\r\n  \"mempoolminfee\": 0.00013381,\r\n  \"minrelaytxfee\": 0.00001000,\r\n  \"incrementalrelayfee\": 0.00001000,\r\n  \"unbroadcastcount\": 0,\r\n  \"fullrbf\": false\r\n}\r\n{\r\n  \"active_chain_type\": \"validated_snapshot\",\r\n  \"validated_snapshot\": {\r\n    \"blocks\": 789094,\r\n    \"bestblockhash\": \"00000000000000000002dad6b3cd82fc00075978eb0d63dcbf6bce3bdc2c3f32\",\r\n    \"difficulty\": 48005534313578.78,\r\n    \"verificationprogress\": 0.9999931560421257,\r\n    \"snapshot_blockhash\": \"00000000000000000001f3fa1b4c03c877740778f56b0d5456b18dd88f7f695e\",\r\n    \"initialblockdownload\": false,\r\n    \"coins_db_cache_bytes\": 8388608,\r\n    \"coins_tip_cache_bytes\": 11498684416,\r\n    \"has_mempool\": true\r\n  },\r\n  \"headers\": 789094\r\n}\r\n```\r\n\r\nWill attempt to repro with a fresh run, I guess?\r\n",
      "created_at" : "2023-05-10T15:17:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542394306",
      "id" : 1542394306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b7xHC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542394306/reactions"
      },
      "updated_at" : "2023-05-10T15:17:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542394306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-11T10:24:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1543736177",
      "id" : 1543736177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cA4tx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543736177/reactions"
      },
      "updated_at" : "2023-05-11T10:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543736177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2023-05-12T01:22:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1544970920",
      "id" : 1544970920,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cFmKo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544970920/reactions"
      },
      "updated_at" : "2023-05-12T01:22:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544970920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've done a number of runs here with some combination of indexing and pruning, and I think this is in about as good a shape as it can be, with the following caveat:\r\n\r\nWhen using assumeutxo with pruning and indexing, the snapshot chainstate cannot be pruned because of how we handle indexing during bg sync. Since the snapshot chainstate isn't indexed until after the background sync completes (in order to avoid out-of-order indexation), we aren't able to prune the snapshot chainstate based upon the prune blocks that the indices configure.\r\n\r\nSo the upshot of all this is that pruning, when used with assumeutxo and indexing, is basically best-effort. I think that's an okay state as long as we're clear about it to end users. Probably merits some kind of GUI alert which I think can be done later.\r\n\r\nAfter bg sync completes, we're in a pretty good state (`-blockfilterindex` + `-coinstatsindex` + `-prune=550`):\r\n```\r\n777M    /home/james/tmp/bitcoin-au-testing/blocks\r\ntotal 667M\r\ndrwx------ 3 james users 4.0K May 12 07:02 .\r\ndrwx------ 5 james users 4.0K May 12 10:34 ..\r\n-rw------- 1 james users 128M May 11 21:24 blk00014.dat\r\n-rw------- 1 james users 128M May 11 21:24 blk00015.dat\r\n-rw------- 1 james users 127M May 11 21:24 blk00016.dat\r\n-rw------- 1 james users 128M May 12 05:04 blk00017.dat\r\n-rw------- 1 james users  32M May 12 06:41 blk02910.dat\r\n-rw------- 1 james users  48M May 12 10:31 blk03593.dat\r\ndrwx------ 2 james users 4.0K May 12 10:34 index\r\n-rw------- 1 james users  18M May 11 21:24 rev00014.dat\r\n-rw------- 1 james users  18M May 11 21:24 rev00015.dat\r\n-rw------- 1 james users  18M May 11 21:24 rev00016.dat\r\n-rw------- 1 james users  16M May 12 05:04 rev00017.dat\r\n-rw------- 1 james users 3.3M May 12 06:41 rev02910.dat\r\n-rw------- 1 james users 6.0M May 12 10:31 rev03593.dat\r\n```\r\n\r\n---\r\n\r\nThrough the last few days of testing, I did find that I forgot to the divide the prune target by the number of chainstates outstanding, so that may have created some of the weirdness @Sjors was seeing. But otherwise I just think that enabling all these features together results in the necessary trade-off of blowing out the pruning budget.\r\n\r\nAlso worth noting that based on the current size of blocks over the last few weeks, the 244 block trailing prune window is potentially going to result in over 550MB of block data, which is our lowest allowable target.",
      "created_at" : "2023-05-12T14:43:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135",
      "id" : 1545856135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cI-SH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545856135/reactions"
      },
      "updated_at" : "2023-05-12T14:43:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545856135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here's a signet snapshot torrent: `magnet:?xt=urn:btih:0e1a61b4ed9a57c41d98f1ddd5061bc088c857b6&dn=utxo-signet-140000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nCan be added to `kernel/chainparams.cpp` with:\r\n\r\n```cpp\r\nm_assumeutxo_data = MapAssumeutxo{\r\n            {\r\n                140'000,\r\n                {AssumeutxoHash{uint256S(\"0x91412d7018c8564beef1938eef2bfe18feee53674fd26bea425daa4280437641\")}, 2233882},\r\n            },\r\n        };\r\n```\r\n\r\nThis basically gets you to the signet tip faster than you can hit enter :-)",
      "created_at" : "2023-05-16T10:42:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1549423309",
      "id" : 1549423309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cWlLN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549423309/reactions"
      },
      "updated_at" : "2023-05-16T10:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549423309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-17T19:12:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1551921618",
      "id" : 1551921618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cgHHS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551921618/reactions"
      },
      "updated_at" : "2023-05-17T19:12:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551921618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1197159021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right now if a non-existing file path is passed, a rather cryptic error message appears:\r\n```\r\n$ ./src/bitcoin-cli loadtxoutset jslkdf \r\nerror code: -1\r\nerror message:\r\nCAutoFile::operator>>: file handle is nullptr: unspecified iostream_category error\r\n```\r\n\r\nShould ensure that `afile` is not null and throw an explicit error if it is (like `dumptxoutset` already does), e.g.:\r\n```suggestion\r\n    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\r\n    if (afile.IsNull()) {\r\n        throw JSONRPCError(\r\n            RPC_INVALID_PARAMETER,\r\n            \"Couldn't open file \" + path.u8string() + \" for reading.\");\r\n    }\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-17T23:25:38Z",
      "diff_hunk" : "@@ -2700,6 +2700,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1197159021",
      "id" : 1197159021,
      "line" : 2727,
      "node_id" : "PRRC_kwDOABII585HWzJt",
      "original_commit_id" : "bbaa5812258e33ca8a5a63f28c7da6b1d78433a1",
      "original_line" : 2727,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 28,
      "pull_request_review_id" : 1431794725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-18T00:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing, @theStack!\r\n\r\n> So far so good, everything went quite smooth and nothing unexpected happened! The only disappointment was finding that apparently the provided prune target of 800MB was not respected:\r\n\r\nYes, this is unfortunately expected behavior. Since you have `-blockfilterindex` enabled and the background sync hasn't yet completed, prune locks are preventing any pruning from happening on the snapshot chainstate. I mentioned this obliquely here: https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135\r\n\r\nThe only way around this would be to mark indexes which can be built out of order (i.e. everything except coinstats) and only halt snapshot indexation for those that can't. But this is something that could be done after the initial assumeutxo feature.\r\n",
      "created_at" : "2023-05-18T14:15:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1553127188",
      "id" : 1553127188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cktcU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553127188/reactions"
      },
      "updated_at" : "2023-05-18T14:15:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553127188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">>So far so good, everything went quite smooth and nothing unexpected happened! The only disappointment was finding that apparently the provided prune target of 800MB was not respected:\r\n>\r\n>Yes, this is unfortunately expected behavior. Since you have -blockfilterindex enabled and the background sync hasn't yet completed, prune locks are preventing any pruning from happening on the snapshot chainstate. I mentioned this obliquely here: https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135\r\n\r\n@jamesob: Thanks for clarifying (admittedly I didn't read your comment just a few posts above before posting my test results), it makes sense that we have to keep the blocks from the snapshot chainstate for the indexer at least until background sync completes. I'd agree that this is not a problem as long as it is clearly communicated to the user, e.g. by putting a well-visible warning into the `loadtxoutset` RPC help. The ultra-conservative approach here would be to simply throw an error if a snapshot is loaded on a node that was started with both pruning and an index enabled (if keeping the `-prune` target promise has absolute highest priority), but that seems to be too limiting.\r\n\r\n",
      "created_at" : "2023-05-22T23:55:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1558205497",
      "id" : 1558205497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c4FQ5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1558205497/reactions"
      },
      "updated_at" : "2023-05-22T23:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1558205497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2023-05-23T16:12:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1559752787",
      "id" : 1559752787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c9_BT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559752787/reactions"
      },
      "updated_at" : "2023-05-23T16:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559752787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Cross-linking to some discussion on how we load the block index that @sdaftuar has surfaced: https://github.com/bitcoin/bitcoin/pull/23174/files#r1198450499\r\n\r\nIf anyone has encountered an issue like this while testing this branch, a comment would be welcome.",
      "created_at" : "2023-05-23T16:48:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1559813326",
      "id" : 1559813326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c-NzO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559813326/reactions"
      },
      "updated_at" : "2023-05-23T16:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559813326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "New bug, albeit pretty minor:\r\n\r\n- [x] ~~if you restart the node after activating the snapshot but before connecting any blocks to the snapshot chainstate, `ReadBlockFromDisk` checks fail when calling `VerifyDB()` during chainstate initialization. I'm not sure when this would happen in practice, but it's an annoying edge case.~~\r\n\r\nEdit: fixed this.",
      "created_at" : "2023-05-23T19:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1560035238",
      "id" : 1560035238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c_D-m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1560035238/reactions"
      },
      "updated_at" : "2023-05-25T20:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1560035238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\nI've made a few changes/improvements that I think fixes the bug @sdaftuar found (not adding all potential tips to `setBlockIndexCandidates`), albeit I'm not yet integrating the changes in #27746.\r\n\r\n- More comprehensive functional tests: the tests now stop and start at more points throughout the sync process, including immediately after snapshot load and before bg validation completes.\r\n- We now include the blockhash of the snapshot base in `m_assumeutxo_data`; this allows us to move the `nChainTx` reconstruction where it belongs, into `BlockManager::LoadBlockIndex()`.\r\n- All blocks for which we have data (or are assumedvalid) are added to all chainstates' `setBlockIndexCandidates`.\r\n  - Some related changes in `CheckBlockIndex()` needed to be made to update some outdated assertions.\r\n\r\nI'm going to be taking a close look at @sdaftuar's proposed changes over the next few days to see if I can integrate them here.",
      "created_at" : "2023-05-25T20:16:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1563455744",
      "id" : 1563455744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dMHEA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563455744/reactions"
      },
      "updated_at" : "2023-05-25T20:16:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563455744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> All blocks for which we have data (or are assumedvalid) are added to all chainstates' setBlockIndexCandidates.\r\n\r\nBeing assumedvalid is unrelated to whether we should add an entry to `setBlockIndexCandidates`; `setBlockIndexCandidates` should have the current tip and any block for which we HAVE_DATA and for which we HAVE_DATA for all the blocks that we'd need to connect, in order to get from our current tip to that target block.  \r\n\r\nThe assumedvalid bit is really just something we're using to help with adjusting the invariants in `CheckBlockIndex()`; it should have no bearing on any of the actual validation logic outside of that.",
      "created_at" : "2023-05-25T22:13:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1563571639",
      "id" : 1563571639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dMjW3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563571639/reactions"
      },
      "updated_at" : "2023-05-25T22:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563571639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210211360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360"
         }
      },
      "author_association" : "NONE",
      "body" : "Getting `syntax error: operand expected (error token is \"\"30000\" + \"20000\"\")` on macOS\r\n```suggestion\r\nFINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T12:38:57Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210211360",
      "id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IIlwg",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1450841472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T12:38:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210212400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400"
         }
      },
      "author_association" : "NONE",
      "body" : "Missing the second \"t\" of \"Starting\"\r\n```suggestion\r\necho \"-- Starting the server node to provide blocks to the client node...\"\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T12:39:49Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -connect=0 -listen=0 >/dev/null &\n+SERVER_PID=\"$!\"\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+server_sleep_til_boot\n+server_rpc dumptxoutset \"$UTXO_DAT_FILE\" > \"$DUMP_OUTPUT\"\n+cat \"$DUMP_OUTPUT\"\n+kill -9 \"$SERVER_PID\"\n+\n+RPC_BASE_HEIGHT=$(jq -r .base_height < \"$DUMP_OUTPUT\")\n+RPC_AU=$(jq -r .txoutset_hash < \"$DUMP_OUTPUT\")\n+RPC_NCHAINTX=$(jq -r .nchaintx < \"$DUMP_OUTPUT\")\n+RPC_BLOCKHASH=$(jq -r .base_hash < \"$DUMP_OUTPUT\")\n+\n+# Wait for server to shutdown...\n+while server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+\n+echo\n+echo \"-- Now: add the following to CMainParams::m_assumeutxo_data\"\n+echo \"   in src/kernel/chainparams.cpp, and recompile:\"\n+echo\n+echo \"   {${RPC_BASE_HEIGHT}, AssumeutxoHash{uint256S(\\\"0x${RPC_AU}\\\")}, ${RPC_NCHAINTX}, uint256S(\\\"0x${RPC_BLOCKHASH}\\\")},\"\n+echo\n+echo\n+echo \"-- IBDing more blocks to the server node (height=$FINAL_HEIGHT) so there is a diff between snapshot and tip...\"\n+./src/bitcoind $SERVER_PORTS -logthreadnames=1 -datadir=\"$SERVER_DATADIR\" \\\n+    $CHAIN_HACK_FLAGS -stopatheight=\"$FINAL_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Staring the server node to provide blocks to the client node...\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210212400",
      "id" : 1210212400,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII585IImAw",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 141,
      "original_position" : 141,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 141,
      "pull_request_review_id" : 1450842970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T12:39:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210397176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Which version of Python are you using?",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T14:45:25Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210397176",
      "id" : 1210397176,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJTH4",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451142607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T14:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210425053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@Sjors this is bash :). If he's on macOS, probably some kind of zsh?",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T15:05:14Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210425053",
      "id" : 1210425053,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJZ7d",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451192866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T15:05:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210488998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "macOS ships an ancient version of bash",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T15:52:07Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210488998",
      "id" : 1210488998,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJpim",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451289875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T15:52:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211504043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043"
         }
      },
      "author_association" : "NONE",
      "body" : "@jamesob line 1 (`#!/usr/bin/env bash`) sets the interpreter to Bash regardless of what the system default is.\r\n\r\n@MarcoFalke you were right! macOS comes with an outdated version of bash (`3.2.57`). I have updated to `5.2.15`. Script runs like a charm now. \r\n\r\nThanks for the help!",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-31T10:41:26Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211504043",
      "id" : 1211504043,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585INhWr",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1452852799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T10:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211763951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @Sjors this is bash :)\r\n\r\n*bashes head against table*",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T13:56:41Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211763951",
      "id" : 1211763951,
      "in_reply_to_id" : 1210211360,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IOgzv",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453295026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T13:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T15:13:11Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -connect=0 -listen=0 >/dev/null &\n+SERVER_PID=\"$!\"\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+server_sleep_til_boot\n+server_rpc dumptxoutset \"$UTXO_DAT_FILE\" > \"$DUMP_OUTPUT\"\n+cat \"$DUMP_OUTPUT\"\n+kill -9 \"$SERVER_PID\"\n+\n+RPC_BASE_HEIGHT=$(jq -r .base_height < \"$DUMP_OUTPUT\")\n+RPC_AU=$(jq -r .txoutset_hash < \"$DUMP_OUTPUT\")\n+RPC_NCHAINTX=$(jq -r .nchaintx < \"$DUMP_OUTPUT\")\n+RPC_BLOCKHASH=$(jq -r .base_hash < \"$DUMP_OUTPUT\")\n+\n+# Wait for server to shutdown...\n+while server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+\n+echo\n+echo \"-- Now: add the following to CMainParams::m_assumeutxo_data\"\n+echo \"   in src/kernel/chainparams.cpp, and recompile:\"\n+echo\n+echo \"   {${RPC_BASE_HEIGHT}, AssumeutxoHash{uint256S(\\\"0x${RPC_AU}\\\")}, ${RPC_NCHAINTX}, uint256S(\\\"0x${RPC_BLOCKHASH}\\\")},\"\n+echo\n+echo\n+echo \"-- IBDing more blocks to the server node (height=$FINAL_HEIGHT) so there is a diff between snapshot and tip...\"\n+./src/bitcoind $SERVER_PORTS -logthreadnames=1 -datadir=\"$SERVER_DATADIR\" \\\n+    $CHAIN_HACK_FLAGS -stopatheight=\"$FINAL_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Staring the server node to provide blocks to the client node...\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880620",
      "id" : 1211880620,
      "in_reply_to_id" : 1210212400,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IO9Ss",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 141,
      "original_position" : 141,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453503822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T15:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks all.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T15:13:24Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880971",
      "id" : 1211880971,
      "in_reply_to_id" : 1210211360,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IO9YL",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453504505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T15:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased\r\n\r\nAlso fixed the minor issues with the `test_utxo_snapshots.sh` demo script.\r\n\r\nSince last push, I've completed a full test of the mainnet snapshot; after a few days having finished the background sync, `-prune=550` (and everything else) working as expected.\r\n\r\n```\r\n759M    /home/james/tmp/bitcoin-au-testing/blocks\r\ntotal 650M\r\ndrwx------ 3 james users 4.0K May 31 10:54 .\r\ndrwx------ 5 james users 4.0K May 31 11:09 ..\r\n-rw------- 1 james users 127M May 29 15:33 blk03626.dat\r\n-rw------- 1 james users 128M May 30 02:38 blk03627.dat\r\n-rw------- 1 james users 128M May 30 17:29 blk03628.dat\r\n-rw------- 1 james users 128M May 31 06:05 blk03629.dat\r\n-rw------- 1 james users  64M May 31 10:57 blk03630.dat\r\ndrwx------ 2 james users 4.0K May 31 10:54 index\r\n-rw------- 1 james users  17M May 29 15:30 rev03626.dat\r\n-rw------- 1 james users  15M May 30 02:36 rev03627.dat\r\n-rw------- 1 james users  19M May 30 17:23 rev03628.dat\r\n-rw------- 1 james users  18M May 31 06:01 rev03629.dat\r\n-rw------- 1 james users 8.0M May 31 10:57 rev03630.dat\r\n```",
      "created_at" : "2023-05-31T15:16:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1570432290",
      "id" : 1570432290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dmuUi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570432290/reactions"
      },
      "updated_at" : "2023-05-31T15:16:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570432290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2023-05-31T19:21:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1570801767",
      "id" : 1570801767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585doIhn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570801767/reactions"
      },
      "updated_at" : "2023-05-31T19:21:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570801767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Related minor issue: https://github.com/bitcoin/bitcoin/issues/27841. I don't think it matters but posting for visibility in case it happens to be helpful to someone.",
      "created_at" : "2023-06-09T00:05:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1583637570",
      "id" : 1583637570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585eZGRC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1583637570/reactions"
      },
      "updated_at" : "2023-06-09T00:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1583637570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22148308?v=4",
         "events_url" : "https://api.github.com/users/hazeycode/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hazeycode/followers",
         "following_url" : "https://api.github.com/users/hazeycode/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hazeycode/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hazeycode",
         "id" : 22148308,
         "login" : "hazeycode",
         "node_id" : "MDQ6VXNlcjIyMTQ4MzA4",
         "organizations_url" : "https://api.github.com/users/hazeycode/orgs",
         "received_events_url" : "https://api.github.com/users/hazeycode/received_events",
         "repos_url" : "https://api.github.com/users/hazeycode/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hazeycode/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hazeycode/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hazeycode"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This may look like a lot to review, but note that\r\n> \r\n>     * 200 lines are duplicated in #24008\r\n\r\nThis should refer to #27746 now, shouldn't it?\r\n",
      "created_at" : "2023-06-10T09:45:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1585587421",
      "id" : 1585587421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585egiTd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1585587421/reactions"
      },
      "updated_at" : "2023-06-10T09:45:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1585587421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-12T12:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1587284696",
      "id" : 1587284696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585enArY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587284696/reactions"
      },
      "updated_at" : "2023-06-12T12:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587284696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Marcus Maurice Williams\r\n\r\nOn Mon, May 8, 2023, 10:12 AM jamesob ***@***.***> wrote:\r\n\r\n>\r\n>    - Background and FAQ:\r\n>    https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal\r\n>    - Prior progress/project:\r\n>    https://github.com/bitcoin/bitcoin/projects/11\r\n>    - Replaces #15606 <https://github.com/bitcoin/bitcoin/pull/15606>,\r\n>    which was closed due to Github slowness. Original description and\r\n>    commentary can be found there.\r\n>\r\n> ------------------------------\r\n>\r\n> This changeset finishes the first phase of the assumeutxo project. It\r\n> makes UTXO snapshots loadable via RPC (loadtxoutset) and adds assumeutxo\r\n> parameters to chainparams. It contains all the remaining changes necessary\r\n> to both use an assumedvalid snapshot chainstate and do a full validation\r\n> sync in the background.\r\n>\r\n> This may look like a lot to review, but note that\r\n>\r\n>    - 200 lines are duplicated in #24008\r\n>    <https://github.com/bitcoin/bitcoin/pull/24008>\r\n>    - ~200 lines are a demo shell script\r\n>    - Many lines are functional test, documentation, and relatively dilute\r\n>    RPC code.\r\n>\r\n> So it shouldn't be as burdensome to review as the linecount might suggest.\r\n>\r\n>    - *P2P*: minor changes are made to init.cpp and net_processing.cpp to\r\n>    make simultaneous IBD across multiple chainstates work.\r\n>       - #24008 <https://github.com/bitcoin/bitcoin/pull/24008>\r\n>    - *Pruning*: implement correct pruning behavior when using a\r\n>    background chainstate\r\n>    - *Blockfile separation*: to prevent \"fragmentation\" in blockfile\r\n>    storage, have background chainstates use separate blockfiles from active\r\n>    snapshot chainstates to avoid interleaving heights and impairing pruning.\r\n>    - *Indexing*: all existing CValidationInterface events are given with\r\n>    an additional parameter, ChainstateRole, and all indexers ignore events\r\n>    from ChainstateRole::ASSUMEDVALID so that indexation only happens\r\n>    sequentially.\r\n>    - Raise error when both -reindex and assumeutxo are in use.\r\n>    - *RPC*: introduce RPC commands loadtxoutset and (hidden)\r\n>    getchainstates.\r\n>    - *Release docs & first assumeutxo commitment*: add notes and a\r\n>    particular assumeutxo hash value for first AU-enabled release.\r\n>       - This will complete the project and allow use of UTXO snapshots\r\n>       for faster node bootstrap.\r\n>\r\n> The next phase, if it were to be pursued, would be coming up with a way to\r\n> distribute the UTXO snapshots over the P2P network.\r\n> ------------------------------\r\n> Testing For fun (~5min)\r\n>\r\n> If you want to do a quick test, you can run\r\n> ./contrib/devtools/test_utxo_snapshots.sh and follow the instructions.\r\n> This is mostly obviated by the functional tests, though.\r\n> For real (longer)\r\n>\r\n> If you'd like to experience a real usage of assumeutxo, you can do that\r\n> too.\r\n> I've cut a new snapshot at height 788'000 (\r\n> http://img.jameso.be/utxo-788000.dat - but you can do it yourself with\r\n> ./contrib/devtools/utxo_snapshot.sh if you want). Download that, and then\r\n> create a datadir for testing:\r\n>\r\n> $ cd ~/src/bitcoin  # or whatever\r\n> # get the snapshot\r\n> $ curl http://img.jameso.be/utxo-788000.dat > utxo-788000.dat\r\n> # you'll want to do this if you like copy/pasting\r\n> $ export AU_DATADIR=/home/${USER}/au-test # or wherever\r\n>\r\n> $ mkdir ${AU_DATADIR}\r\n> $ vim ${AU_DATADIR}/bitcoin.conf\r\n>\r\n> dbcache=8000  # or, you know, something high\r\n> blockfilterindex=1\r\n> coinstatsindex=1\r\n> prune=3000\r\n> logthreadnames=1\r\n>\r\n> Obtain this branch, build it, and then start bitcoind:\r\n>\r\n> $ git remote add jamesob https://github.com/jamesob/bitcoin\r\n> $ git fetch jamesob utxo-dumpload-compressed\r\n> $ git checkout jamesob/utxo-dumpload-compressed\r\n>\r\n> $ ./configure $conf_args && make  # (whatever you like to do here)\r\n> # start 'er up and watch the logs\r\n> $ ./src/bitcoind -datadir=${AU_DATADIR}\r\n>\r\n> Then, in some other window, load the snapshot\r\n>\r\n> $ ./src/bitcoin-cli -datadir=${AU_DATADIR} loadtxoutset $(pwd)/utxo-788000.dat\r\n>\r\n> You'll see some log messages about headers retrieval and waiting to see\r\n> the snapshot in the headers chain. Once you get the full headers chain,\r\n> you'll spend a decent amount of time (~10min) loading the snapshot,\r\n> checking it, and flushing it to disk. After all that happens, you should be\r\n> syncing to tip in pretty short order, and you'll see the occasional [background\r\n> validation] log message go by.\r\n>\r\n> In yet another window, you can check out chainstate status with\r\n>\r\n> $ ./src/bitcoin-cli -datadir=${AU_DATADIR} getchainstates\r\n>\r\n> as well as usual favorites like getblockchaininfo.\r\n> ------------------------------\r\n> You can view, comment on, or merge this pull request online at:\r\n>\r\n>   https://github.com/bitcoin/bitcoin/pull/27596\r\n> Commit Summary\r\n>\r\n>    - 862346f\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/862346f870d73fc3d11fead1afc8b3379984bdfb>\r\n>    validation: introduce ChainstateManager::GetChainstateForNewBlock\r\n>    - 89fe4b3\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/89fe4b3a2c4480573598f865757c9a36e75d2864>\r\n>    validation: add ChainstateManager::GetAllForBlockDownload()\r\n>    - 4b68a3a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/4b68a3a85fca3fbc4befa58bd8ac3c91a6d58c79>\r\n>    doc: add docstring for CanDirectFetch()\r\n>    - 86d5cfd\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/86d5cfdd78fd70250fb5b96d3c5e85e8afb5c71f>\r\n>    net_processing: work with multiple chainstates\r\n>    - a966a54\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/a966a54df5032f4a01d4d2f5eb006d41cea31c7c>\r\n>    p2p: don't advertise until we finish all IBDs\r\n>    - 84a7c15\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/84a7c15ef835f4846ccffca663d194de071ed49a>\r\n>    net_processing: add commentary describing IsIBD use\r\n>    - 1899c76\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/1899c76609ab1ec38947201227e6872a2c47f5a8>\r\n>    assumeutxo: disallow -reindex when background syncing\r\n>    - 5cdc31a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/5cdc31a25279fdf5d434d36a360d256db48a6a44>\r\n>    validation: MaybeRebalanceCaches when chain leaves IBD\r\n>    - fb817f7\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/fb817f71e8565b71394b21e036ad1235c679bd5e>\r\n>    validation: add ChainstateRole\r\n>    - a284813\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/a284813336cd29862a24b95c283795c8b89d5549>\r\n>    validation: pass ChainstateRole for validationinterface calls\r\n>    - deea1c0\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/deea1c0b946887d57709c34bc7a96383de11f5ee>\r\n>    validationinterface: only send zmq notifications for active\r\n>    - cc59c06\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/cc59c060d05c3c8a2a949e1bcfe58ef0d2cbd6b8>\r\n>    wallet: validationinterface: only handle active chain notifications\r\n>    - fec9c9a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/fec9c9aaf920bba6f519dd34d950d5a8a2a5b424>\r\n>    net_processing: validationinterface: ignore some events for bg chain\r\n>    - 460978b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/460978b778df9f9a56242bf16e78230b1d5cb566>\r\n>    index: cache indexer references on ChainstateManager\r\n>    - e73fc1b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/e73fc1b56dc7a8700e46e3c7d0f78af81c81d4bf>\r\n>    validation: indexing changes for assumeutxo\r\n>    - c0fe191\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/c0fe1918480ff7aedef274b72e1fb58eee1bd98b>\r\n>    validation: pruning for multiple chainstates\r\n>    - 8d887bc\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/8d887bcb023ae57a43d4753592bb19fc1595392f>\r\n>    blockstorage: segment normal/assumedvalid blockfiles\r\n>    - 1375263\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/13752635f8544b517ad0a701e0a3871126f9cf4e>\r\n>    validation: run CheckBlockIndex on all chainstates during ProcessNewHeaders\r\n>    - 501633d\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/501633da24c0c976062e6731fe4cfff6e57da265>\r\n>    validation: populate nChainTx value for assumedvalid chainstates\r\n>    - eae8d5b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/eae8d5bcfbc74a8f294fc0ea5bf7b15557d9e0a3>\r\n>    validation: assumeutxo: swap m_mempool on snapshot activation\r\n>    - ff1d1d2\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/ff1d1d265422698dfa83934f8562cbfbe0176bcb>\r\n>    rpc: add loadtxoutset\r\n>    - 386ddcb\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/386ddcb05ab67f27147e7bdba7271ef7b0f0a6d8>\r\n>    rpc: add getchainstates\r\n>    - 5f19585\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/5f19585e6a0f983ed4977fc4848810471c122a4d>\r\n>    test: add feature_assumeutxo functional test\r\n>    - 39c2438\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/39c2438b8806800b6c30749c0ea7f915cea5dc21>\r\n>    contrib: add script to demo/test assumeutxo\r\n>    - 86aa9f5\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/86aa9f506dd79d9bdc7a9acb682a0e68a2651af5>\r\n>    doc: update release-process.md for assumeutxo\r\n>    - e546c77\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/e546c77f6344dd5e156db8fbef568b376b16b36c>\r\n>    chainparams: add assumeutxo param at height 788_000\r\n>\r\n> File Changes\r\n>\r\n> (38 files <https://github.com/bitcoin/bitcoin/pull/27596/files>)\r\n>\r\n>    - *A* contrib/devtools/test_utxo_snapshots.sh\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-bf5041637049f714f9770cd1fdbeb8c56113ba445158afe4d15df32b5b393c5e>\r\n>    (201)\r\n>    - *M* doc/release-process.md\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-723b9eeeb819047ef03f827ee8a3ccfef48ce7ef6a340a068a68b551993fe70b>\r\n>    (5)\r\n>    - *M* src/bench/wallet_create_tx.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-e9fe86a6cb5a18f8bf472c45e9d02cca8aea5dac8e3d2a0b81ce25a734458139>\r\n>    (2)\r\n>    - *M* src/bitcoin-chainstate.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-04e685224f1ac5bfd91d47d8d7528a2e44f94fab5535d4b6b5af79b5a13aeb93>\r\n>    (2)\r\n>    - *M* src/index/base.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-5251d93616c116c364d2d502ad2a59e901a3512194462fabacc9756f96fd8ddd>\r\n>    (45)\r\n>    - *M* src/index/base.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-7788bdbad32d436bca22d0c729b136d185852f2f06bf389de660a27209605b1e>\r\n>    (16)\r\n>    - *M* src/init.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69d>\r\n>    (28)\r\n>    - *M* src/interfaces/chain.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-8e9fef4d0718d085f31da382899d97e3bbefc8d6a72ede95916a0e2fbd1a532f>\r\n>    (7)\r\n>    - *M* src/kernel/chain.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d3d6e652e68e3ef8083f804a2d9bf6bbe6f56d8be131ec27caa2d22aadd26308>\r\n>    (16)\r\n>    - *M* src/kernel/chainparams.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-e20339c384d6f19b519ea2de7f4ba4fed92a36d66a80f0339b09927c3fa38d6d>\r\n>    (10)\r\n>    - *M* src/net_processing.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3>\r\n>    (192)\r\n>    - *M* src/node/blockstorage.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-114c2880ec1ff2c5293ac65ceda0637bf92c05745b74b58410585a549464a33f>\r\n>    (171)\r\n>    - *M* src/node/blockstorage.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ed3f90693a242b38b9719af171de8f55183576957676dfa358945bea22276bd5>\r\n>    (51)\r\n>    - *M* src/node/chainstate.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-2d7b280e97018679cac8dc4fc7a1f172c4a7784196a6563814c2720a5fe4f5cf>\r\n>    (9)\r\n>    - *M* src/node/chainstate.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-5c4b54b8e7e79dc69ba8718a3560a500c3ee188cb41ef2d871f1618430ed05ab>\r\n>    (1)\r\n>    - *M* src/node/interfaces.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-0ef8ae12c6e9ef2accc78537f42612b3267e8a7c45dc7e9eb998f797e79f2e95>\r\n>    (12)\r\n>    - *M* src/rpc/blockchain.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-decae4be02fb8a47ab4557fe74a9cb853bdfa3ec0fa1b515c0a1e5de91f4ad0b>\r\n>    (145)\r\n>    - *M* src/rpc/mining.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ccc24453c13307f815879738d3bf00eec351417537fbf10dde1468180cacd2f1>\r\n>    (2)\r\n>    - *M* src/test/blockmanager_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d6d633592a40f5f3d8b03863e41547de8751b874c1d20f129a616b9dd719b999>\r\n>    (22)\r\n>    - *M* src/test/coinstatsindex_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-3a52da0f780b7496cbd3be5349331f223c59c0744a4e9250b4ce9447af49cc3f>\r\n>    (2)\r\n>    - *M* src/test/fuzz/rpc.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ee7cf727299bfa316da96e98513ee31af263b0e7a6d11c4ab4925c4d39cf8f26>\r\n>    (2)\r\n>    - *M* src/test/util/validation.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-064350ac182b83003193c123be2641ccf8193acc345ffe414a296564abae8ba5>\r\n>    (8)\r\n>    - *M* src/test/util/validation.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-fc320b912f26bb38bdf2dbfa04eff079171998213bb4613c70fde3ba55633011>\r\n>    (6)\r\n>    - *M* src/test/validation_block_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-c51ca52621176697b8a93a05bcf50f4d6e9918858c2e7f433a5643d5f8cfcb49>\r\n>    (4)\r\n>    - *M* src/test/validation_chainstatemanager_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9b>\r\n>    (51)\r\n>    - *M* src/test/validationinterface_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-f3c4c9b3d62db182f8504262b16a60e355c147f24cc4b68a9d22d2f73478c2c8>\r\n>    (9)\r\n>    - *M* src/validation.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98>\r\n>    (186)\r\n>    - *M* src/validation.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d3c243938494b10666b44404a27af7d84b44a72b85a27431e0c89e181462ca6e>\r\n>    (59)\r\n>    - *M* src/validationinterface.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-cd341be4887e632ceba211aee03c948d964396f7aed0146435163844fbcbad42>\r\n>    (27)\r\n>    - *M* src/validationinterface.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-b169bd0694e8b0a87fd1097c8cfc1d6c8a926b49b375bb4141d37dcc624f975e>\r\n>    (38)\r\n>    - *M* src/wallet/test/fuzz/notifications.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-56ec91afa7041341aa4d260eae3e38f4ce0593b3d099e84ae3a3ac23c364825a>\r\n>    (5)\r\n>    - *M* src/wallet/wallet.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-1f2db0e4d5c12d109c7f0962333c245b49b696cb39ff432da048e9d6c08944d8>\r\n>    (20)\r\n>    - *M* src/wallet/wallet.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-9ce137cd784ea308778842120aa2af6d2bb8369485b71f25e72b2a32cf0a5b21>\r\n>    (6)\r\n>    - *M* src/zmq/zmqnotificationinterface.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ac4b2d3a8de2c4dd41ad9d75505ea6ce4dc87a476710a9ebee8acf9bebf5cca2>\r\n>    (11)\r\n>    - *M* src/zmq/zmqnotificationinterface.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ac02747459d343f20f8f722042856d31d6a4af8db84da8c761f56a3c04356df1>\r\n>    (4)\r\n>    - *A* test/functional/feature_assumeutxo.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-8eaa6b77b4e4f242deb67950425cb6b6b7de5370c56a1e8fa7e3a12e95df0a9d>\r\n>    (145)\r\n>    - *M* test/functional/test_runner.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-437d7f6e9f2229879b60aae574a8217f14c643bbf3cfa9225d8011d6d52df00c>\r\n>    (1)\r\n>    - *M* test/lint/lint-shell.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-91d0650eb13c42e4373349f80200ea548b560a916ddc11decaba31d04bf6addf>\r\n>    (8)\r\n>\r\n> Patch Links:\r\n>\r\n>    - https://github.com/bitcoin/bitcoin/pull/27596.patch\r\n>    - https://github.com/bitcoin/bitcoin/pull/27596.diff\r\n>\r\n> â\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/pull/27596>, or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/ASHJW56YS762NMBB2GGDN6DXFEENXANCNFSM6AAAAAAX2CKYPM>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n",
      "created_at" : "2023-06-28T22:30:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1612199588",
      "id" : 1612199588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585gGDak",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1612199588/reactions"
      },
      "updated_at" : "2023-06-28T22:30:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1612199588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76454775?v=4",
         "events_url" : "https://api.github.com/users/MarcusMWilliams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcusMWilliams/followers",
         "following_url" : "https://api.github.com/users/MarcusMWilliams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcusMWilliams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcusMWilliams",
         "id" : 76454775,
         "login" : "MarcusMWilliams",
         "node_id" : "MDQ6VXNlcjc2NDU0Nzc1",
         "organizations_url" : "https://api.github.com/users/MarcusMWilliams/orgs",
         "received_events_url" : "https://api.github.com/users/MarcusMWilliams/received_events",
         "repos_url" : "https://api.github.com/users/MarcusMWilliams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcusMWilliams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcusMWilliams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcusMWilliams"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "With #24008 landed this would a great time for a rebase (I briefly tried but it's non-trivial).",
      "created_at" : "2023-08-01T08:11:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1659794915",
      "id" : 1659794915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585i7nXj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659794915/reactions"
      },
      "updated_at" : "2023-08-01T08:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659794915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In the process of rebasing now.",
      "created_at" : "2023-08-01T18:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1660856546",
      "id" : 1660856546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585i_qji",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660856546/reactions"
      },
      "updated_at" : "2023-08-01T18:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660856546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased [`au.027`](https://github.com/jamesob/bitcoin/tree/au.027) -> [`au.029`](https://github.com/jamesob/bitcoin/tree/au.029)\r\n\r\nThe merge of #27607 really made that difficult.\r\n\r\nThis rebase fixes merge conflicts as well as incorporates @sdaftuar's changes from #27746. His net changes are in the first commit here.\r\n\r\nI'm very tired of this project and hope we can focus effort on getting this changeset reviewed and merged to be done with the development of this feature.",
      "created_at" : "2023-08-07T19:36:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1668468059",
      "id" : 1668468059,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585jcs1b",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668468059/reactions"
      },
      "updated_at" : "2023-08-07T19:36:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668468059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-07T20:45:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1668555204",
      "id" : 1668555204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585jdCHE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 1,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668555204/reactions"
      },
      "updated_at" : "2023-08-07T20:45:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668555204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(The next rebase should be trivial, only a one-line include conflict, I think)",
      "created_at" : "2023-08-08T07:29:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1669064576",
      "id" : 1669064576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585je-eA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669064576/reactions"
      },
      "updated_at" : "2023-08-08T07:29:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669064576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This look suspiciously similar to `FindNextBlocksToDownload`, is there no way to unify the two?\r\n\r\n(sorry if I missed previous discussion on this)",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:30:00Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497",
      "id" : 1290225497,
      "line" : 1413,
      "node_id" : "PRRC_kwDOABII585M50dZ",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1413,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290237668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`NewPoWValidBlock` is already gated with `m_highest_fast_announce` but I think it would make sense to also ignore bg chainstate events explicitly.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:38:37Z",
      "diff_hunk" : "@@ -1901,7 +1970,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290237668",
      "id" : 1290237668,
      "line" : 1973,
      "node_id" : "PRRC_kwDOABII585M53bk",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1973,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 136,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290241176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "propbably not worth it to pass the chainstate role then?",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:41:03Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290241176",
      "id" : 1290241176,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585M54SY",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Better to be precise and ask them to only recommend deleting `blocks`, `chainstate` and `indexes`. Or alternatively add a reminder that they should backup their wallet before deleting the whole datadir.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T14:42:31Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426",
      "id" : 1291426426,
      "line" : 193,
      "node_id" : "PRRC_kwDOABII585M-Zp6",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 10,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291431562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't `std::find_if` work for this?",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T14:46:56Z",
      "diff_hunk" : "@@ -49,4 +51,15 @@ inline V Cat(V v1, const V& v2)\n     return v1;\n }\n \n+template<typename V, typename L>\n+inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291431562",
      "id" : 1291431562,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585M-a6K",
      "original_commit_id" : "cdb73e44b7f0d4ea186ba657ddf7809434f0a12a",
      "original_line" : 55,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/vector.h",
      "position" : 15,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291620032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, might be good to update ZMQ and wallet docs as a follow-up that blocks that are connected to the background chain will not be notified...",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T17:31:20Z",
      "diff_hunk" : "@@ -173,6 +174,9 @@ void CZMQNotificationInterface::TransactionRemovedFromMempool(const CTransaction\n \n void CZMQNotificationInterface::BlockConnected(const ChainstateRole role, const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected)\n {\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291620032",
      "id" : 1291620032,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585M_I7A",
      "original_commit_id" : "f2a15428277090d6ad387de6d517303b9bc4e2af",
      "original_line" : 177,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 28,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291649621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure it makes sense to distribute the prune budget between all chainstates equally. Ideally we would sync the background chainstate block by block and throw them away instantly because if we are pruning the likelihood that we keep the bg blocks at the end of IBD is much lower. I'm not sure what the perfect distribution would be but I would shift it more towards the assumed chainstate.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T18:09:07Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291649621",
      "id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585M_QJV",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 194,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291670706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A bit simpler approach for this RPC would be to return to the user that the headers are not synced yet immediately and tell them they should try again when the headers are fully synced. I would be interested if others favor this approach as well.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T18:37:08Z",
      "diff_hunk" : "@@ -2699,6 +2699,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291670706",
      "id" : 1291670706,
      "line" : 2740,
      "node_id" : "PRRC_kwDOABII585M_VSy",
      "original_commit_id" : "8ac7427b41fdec1dbc7e06d0aa2c0e469b879ba2",
      "original_line" : 2740,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 42,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Test failure for a66790c662d6516b9fec9ca2cc97e410a72fe899 on Ubuntu 23.04 (gcc 12.3.0) \r\n\r\n```\r\n$ src/test/test_bitcoin --run_test=validation_chainstatemanager_tests\r\nRunning 7 test cases...\r\nnode/blockstorage.cpp:307 LoadBlockIndex: Assertion `GetParams().AssumeutxoForBlockhash(*snapshot_blockhash)' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_loadblockindex\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(441): last checkpoint\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_init\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(508): last checkpoint: \"chainstatemanager_snapshot_init\" fixture ctor\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_completion\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(577): last checkpoint: \"chainstatemanager_snapshot_completion\" fixture ctor\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_completion_hash_mismatch\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(660): last checkpoint: \"chainstatemanager_snapshot_completion_hash_mismatch\" fixture ctor\r\n```\r\n\r\nIt's happy again the next commit fe735572d05b95569e9c82fa1b1767c7da23b423.\r\n\r\n\r\nâ\r\nHere's a torrent for 800,000: `magnet:?xt=urn:btih:50ee955bef37f5ec3e5b0df4cf0288af3d715a2e&dn=utxo-800000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nYou'll need this:\r\n\r\n```json\r\n{\r\n  \"coins_written\": 111535121,\r\n  \"base_hash\": \"00000000000000000002a7c4c1e48d76c5a37902165a270156b7a8d72728a054\",\r\n  \"base_height\": 800000,\r\n  \"txoutset_hash\": \"7d69b87512db3d13b9758ea32b93ce468d18cf7456fb5d250c9e1bed9339e4d2\",\r\n  \"nchaintx\": 868965226\r\n}\r\n```\r\n\r\nI'll try a sync with this shortly. _Update_: ran successful IBD on Intel macOS and on Ubuntu 23. With the latter I first had it sync until 2013 so the dbcache would be 1 GB, before loading the snapshot. \r\n\r\nâ\r\n\r\nOn macOS the shutdown (a day) after completing background sync seems gets stuck:\r\n\r\n```\r\n023-08-16T07:48:43Z [msghand] [net] Saw new cmpctblock header hash=0000000000000000000229118fcb007fc035045c3a3394233116aa25d496129e peer=398\r\n2023-08-16T07:48:44Z [msghand] UpdateTip: new best=0000000000000000000229118fcb007fc035045c3a3394233116aa25d496129e height=803421 version=0x20000000 log2_work=94.362393 tx=879900343 date='2023-08-16T07:48:37Z' progress=1.000000 cache=114.9MiB(924996txo)\r\n2023-08-16T07:49:00Z [msghand] New outbound peer connected: version: 70016, blocks=803421, peer=491 (block-relay-only)\r\n^C2023-08-16T07:50:33Z [addcon] addcon thread exit\r\n2023-08-16T07:50:33Z [opencon] opencon thread exit\r\n2023-08-16T07:50:33Z [init] Shutdown: In progress...\r\n2023-08-16T07:50:33Z [net] net thread exit\r\n2023-08-16T07:50:33Z [msghand] msghand thread exit\r\n2023-08-16T07:55:12Z [scheduler] Flushed fee estimates to fee_estimates.dat.\r\n2023-08-16T08:23:36Z [scheduler] Potential stale tip detected, will try using extra outbound peer (last tip update: 2092 seconds ago)\r\n```\r\n\r\nI didn't run with useful debug flags unfortunately. It was a pruned node. Despite `kill -9` it was able to restart in good shape though:\r\n\r\n```\r\n2023-08-16T09:03:57Z [init] [snapshot] cleaning up unneeded background chainstate, then reinitializing\r\n```",
      "created_at" : "2023-08-14T11:17:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1677134971",
      "id" : 1677134971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585j9wx7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1677134971/reactions"
      },
      "updated_at" : "2023-08-16T09:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1677134971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294582794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497\r\n\r\n> This look suspiciously similar to `FindNextBlocksToDownload`, is there no way to unify the two?\r\n\r\nThis seems pretty bad. The most complicated part of the function is copied and pasted basically verbatim, and to make things worse, the comments which explain how it works are removed in the duplicated code.\r\n\r\nWould suggest 43b322188de227c1161fe3ee2dfd7b3a019cfc6a ([branch](https://github.com/ryanofsky/bitcoin/commits/pr/assumedl)) as a simpler alternative. It also add a commit description and a doxygen comment to explain all the variables which I found confusing. Feel free to add it to this PR or adopt anything there.\r\n\r\n\r\n",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T13:14:53Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294582794",
      "id" : 1294582794,
      "in_reply_to_id" : 1290225497,
      "line" : 1413,
      "node_id" : "PRRC_kwDOABII585NKcQK",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1413,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 1578539655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294850766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nThis code is just copied and pasted from previous code which was added back in #4468, but `std::max` seems like a bug here, and I would expect it to be `std::min` if the point is to read up to 128 successors of pIndexWalk at a time.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T16:30:39Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain\n+        // our assumeutxo target.\n+        // Presumably this peer's chain has less work than our ActiveChain()'s tip, or else we\n+        // will eventually crash when we try to reorg to it. Let other logic\n+        // deal with whether we disconnect this peer.\n+        return;\n+    }\n+\n+    const CBlockIndex *pindexWalk = from_tip;\n+\n+    int nWindowEnd = pindexWalk->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+    int nMaxHeight = std::min<int>(target_block->nHeight, nWindowEnd + 1);\n+\n+    std::vector<const CBlockIndex*> vToFetch;\n+\n+    while (pindexWalk->nHeight < nMaxHeight) {\n+        int nToFetch = std::min(nMaxHeight-pindexWalk->nHeight, std::max<int>(count-vBlocks.size(), 128));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294850766",
      "id" : 1294850766,
      "line" : 1440,
      "node_id" : "PRRC_kwDOABII585NLdrO",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1439,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 1578539655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nThis is an exaggeration, right? Peer doesn't seem completely useless if it doesn't contain the snapshot block because it could contain blocks leading up the snapshot block. It this is right it would be good to clarify, or maybe change to allow requesting blocks from the peer.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T16:58:54Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351",
      "id" : 1294879351,
      "line" : 1424,
      "node_id" : "PRRC_kwDOABII585NLkp3",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1423,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 1579020103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296088099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"assumeutxo: disallow -reindex when background syncing\" (3b9d3d63d9ccb609ec08da34776f7c5f29d21a20)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426\r\n\r\nI don't understand the advice to \"wait for background sync to complete\" in this error message. I thought use-cases for reindex were mostly things like recovering from data corruption or restoring from backup. Is there a case where you would ever want to wait for a sync to complete and then reindex after that?\r\n\r\nAlso, I'm not sure why it needs be an error to reindex when a snapshot is loaded. The reindex options are supposed delete the UTXO database (and optionally other databases) without deleting block data, and rebuild using whatever data is left over. So if a snapshot is loaded it seems like the -reindex implementation could just delete both UTXO databases and then continue as normal without the snapshot. If the user still had a copy of the snapshot, they could reload it with the `loadtxoutset` RPC later and reuse the blocks that were already downloaded.\r\n\r\nIt seems like implementing this making making reindex work cleanly with assumeutxo would not be much harder than adding this error message.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-16T15:29:08Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296088099",
      "id" : 1296088099,
      "in_reply_to_id" : 1291426426,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQLwj",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1580896920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T18:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296254459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: MaybeRebalanceCaches when chain leaves IBD\" (5ea9abfbac3543f2d2cef90a1528abed35623822)\r\n\r\nIt seems dangerous if just calling IsInitialBlockDownload to find out IBD state could now block and resize caches and flush state to disk. It also makes the codebase hard to understand if you can't answer a basic question like \"when do caches get resized\" without having to look up IsInitialBlockDownload() calls all over the codebase.\r\n\r\nI think it would be better to choose one place where it would be logical to check for the end of IBD and rebalance caches, like after a block is connected or after a header is received, and put the MaybeRebalanceCaches in a specific place instead of letting it happen anywhere.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-16T17:56:03Z",
      "diff_hunk" : "@@ -1642,6 +1642,9 @@ bool Chainstate::IsInitialBlockDownload() const\n     }\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n     m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+    // Important that this comes *after* the previous line, else we'll wind up in an\n+    // infinite recursion.\n+    m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296254459",
      "id" : 1296254459,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQ0X7",
      "original_commit_id" : "5ea9abfbac3543f2d2cef90a1528abed35623822",
      "original_line" : 1647,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1580896920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T18:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-21T11:18:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1686138366",
      "id" : 1686138366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585kgG3-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1686138366/reactions"
      },
      "updated_at" : "2023-08-21T11:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1686138366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303334266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nWould suggest moving this change to a separate commit. Otherwise adding the chainstate check here is a behavior change in a refactoring commit. Also it doesn't seem directly related to the other changes here ",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:28:41Z",
      "diff_hunk" : "@@ -3178,15 +3179,16 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n             if (pindexFork != pindexNewTip) {\n                 // Notify ValidationInterface subscribers\n-                GetMainSignals().UpdatedBlockTip(pindexNewTip, pindexFork, fInitialDownload);\n-\n-                // Always notify the UI if a new block tip was connected\n-                if (kernel::IsInterrupted(m_chainman.GetNotifications().blockTip(GetSynchronizationState(fInitialDownload), *pindexNewTip))) {\n-                    // Just breaking and returning success for now. This could\n-                    // be changed to bubble up the kernel::Interrupted value to\n-                    // the caller so the caller could distinguish between\n-                    // completed and interrupted operations.\n-                    break;\n+                GetMainSignals().UpdatedBlockTip(this->GetRole(), pindexNewTip, pindexFork, fInitialDownload);\n+\n+                if (this == &m_chainman.ActiveChainstate() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303334266",
      "id" : 1303334266,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr016",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 3184,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303337523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nI don't see the BlockChecked `role` parameter being used later in the PR, and I don't know another reason why it should be added. It seems like it would be simpler to not add the parameter and get rid of the code above, which is not very straightforward and seems to basically be making up the `role` value.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:31:56Z",
      "diff_hunk" : "@@ -4057,7 +4060,18 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n             ret = AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n         }\n         if (!ret) {\n-            GetMainSignals().BlockChecked(*block, state);\n+            const auto& snapshot = this->SnapshotBlockhash();\n+            ChainstateRole role{ChainstateRole::NORMAL};\n+\n+            // Determine whether or not this block belongs to an assumedvalid chainstate, which\n+            // will affect block storage.\n+            if (snapshot) {\n+                const auto au_data = Assert(GetParams().AssumeutxoForBlockhash(*snapshot));\n+                role = (pindex->nHeight >= au_data->height) ?\n+                    ChainstateRole::ASSUMEDVALID : ChainstateRole::BACKGROUND;\n+            }\n+\n+            GetMainSignals().BlockChecked(role, *block, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303337523",
      "id" : 1303337523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr1oz",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 4074,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303342871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nThese TransactionAddedToMempool and TransactionRemovedFromMempool comments are a little confusing because I wouldn't expect the background chainstate to have a mempool, and even if there were multiple mempools, I wouldn't think knowing what chainstate they build on to be enough to identify them. I think it would be better to drop this new comment and avoid mixing up chainstate/mempool concepts.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:37:17Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.\n      */\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n+    virtual void UpdatedBlockTip(const ChainstateRole, const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n     /**\n      * Notifies listeners of a transaction having been added to mempool.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303342871",
      "id" : 1303342871,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr28X",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 97,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:26:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304837385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks - fixed and added you as a coauther.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:34:19Z",
      "diff_hunk" : "@@ -2700,6 +2700,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304837385",
      "id" : 1304837385,
      "in_reply_to_id" : 1197159021,
      "line" : 2726,
      "node_id" : "PRRC_kwDOABII585Nxj0J",
      "original_commit_id" : "bbaa5812258e33ca8a5a63f28c7da6b1d78433a1",
      "original_line" : 2726,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 28,
      "pull_request_review_id" : 1594414348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304838783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks guys - I've taken https://github.com/bitcoin/bitcoin/commit/43b322188de227c1161fe3ee2dfd7b3a019cfc6a and made a cosmetic refactoring change.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:36:01Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304838783",
      "id" : 1304838783,
      "in_reply_to_id" : 1290225497,
      "line" : 1384,
      "node_id" : "PRRC_kwDOABII585NxkJ_",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1384,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 84,
      "pull_request_review_id" : 1594416523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:36:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304845272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea; done.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:42:27Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304845272",
      "id" : 1304845272,
      "in_reply_to_id" : 1290241176,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585NxlvY",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1594426081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good find! I'll remove this unused parameter.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:47:00Z",
      "diff_hunk" : "@@ -4057,7 +4060,18 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n             ret = AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n         }\n         if (!ret) {\n-            GetMainSignals().BlockChecked(*block, state);\n+            const auto& snapshot = this->SnapshotBlockhash();\n+            ChainstateRole role{ChainstateRole::NORMAL};\n+\n+            // Determine whether or not this block belongs to an assumedvalid chainstate, which\n+            // will affect block storage.\n+            if (snapshot) {\n+                const auto au_data = Assert(GetParams().AssumeutxoForBlockhash(*snapshot));\n+                role = (pindex->nHeight >= au_data->height) ?\n+                    ChainstateRole::ASSUMEDVALID : ChainstateRole::BACKGROUND;\n+            }\n+\n+            GetMainSignals().BlockChecked(role, *block, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849279",
      "id" : 1304849279,
      "in_reply_to_id" : 1303337523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nxmt_",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 4074,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1594432267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:47:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, that's fair criticism. I've moved this potential rebalance to within `ActivateBestChain()`, which requires a little bit of extra code but is as you say much more explicit.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:47:45Z",
      "diff_hunk" : "@@ -1642,6 +1642,9 @@ bool Chainstate::IsInitialBlockDownload() const\n     }\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n     m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+    // Important that this comes *after* the previous line, else we'll wind up in an\n+    // infinite recursion.\n+    m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849858",
      "id" : 1304849858,
      "in_reply_to_id" : 1296254459,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nxm3C",
      "original_commit_id" : "5ea9abfbac3543f2d2cef90a1528abed35623822",
      "original_line" : 1647,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1594433276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, but only part of the way addressing all feedback so far.\r\n\r\n- Took @ryanofsky's net_processing cleanup commit\r\n- Better error handling in loadtxoutset (@theStack)\r\n- Cleaned up unnecessary chainstate roles (@dergoegge, @ryanofsky)\r\n  - Refactoring and behavior changes are now separate commits\r\n",
      "created_at" : "2023-08-24T21:11:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1692415097",
      "id" : 1692415097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585k4DR5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1692415097/reactions"
      },
      "updated_at" : "2023-08-24T21:11:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1692415097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305702150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, makes sense. Done!",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T14:01:32Z",
      "diff_hunk" : "@@ -1901,7 +1970,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305702150",
      "id" : 1305702150,
      "in_reply_to_id" : 1290237668,
      "line" : 1965,
      "node_id" : "PRRC_kwDOABII585N028G",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1965,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 160,
      "pull_request_review_id" : 1595799643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T14:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305760028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay, good points. I've removed this error message completely and instead have implemented the behavior that the snapshot chainstate is completely removed during `-reindex{-chainstate}`. This is consistent with the spirit of the existing reindex operation, I think. The change is also about as simple as this one.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T14:45:34Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305760028",
      "id" : 1305760028,
      "in_reply_to_id" : 1291426426,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N1FEc",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305781595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I went to change this and found that, surprisingly, massaging `find_if` into a `std::optional` output was actually wordier than the current approach:\r\n```diff\r\ndiff --git a/src/util/vector.h b/src/util/vector.h\r\nindex 9cd5e118a6..32d1e7f933 100644\r\n--- a/src/util/vector.h\r\n+++ b/src/util/vector.h\r\n@@ -54,12 +54,12 @@ inline V Cat(V v1, const V& v2)\r\n template<typename V, typename L>\r\n inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)\r\n {\r\n-    for (const auto& el : vec) {\r\n-        if (fnc(el)) {\r\n-            return el;\r\n-        }\r\n+    auto got = std::find_if(vec.begin(), vec.end(), fnc);\r\n+    if (got != vec.end()) {\r\n+        return *got;\r\n+    } else {\r\n+        return std::nullopt;\r\n     }\r\n-    return std::nullopt;\r\n }\r\n \r\n #endif // BITCOIN_UTIL_VECTOR_H\r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T15:03:12Z",
      "diff_hunk" : "@@ -49,4 +51,15 @@ inline V Cat(V v1, const V& v2)\n     return v1;\n }\n \n+template<typename V, typename L>\n+inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305781595",
      "id" : 1305781595,
      "in_reply_to_id" : 1291431562,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585N1KVb",
      "original_commit_id" : "cdb73e44b7f0d4ea186ba657ddf7809434f0a12a",
      "original_line" : 55,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/vector.h",
      "position" : 15,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305885944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, added release notes for ZMQ.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T16:28:30Z",
      "diff_hunk" : "@@ -173,6 +174,9 @@ void CZMQNotificationInterface::TransactionRemovedFromMempool(const CTransaction\n \n void CZMQNotificationInterface::BlockConnected(const ChainstateRole role, const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected)\n {\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305885944",
      "id" : 1305885944,
      "in_reply_to_id" : 1291620032,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585N1jz4",
      "original_commit_id" : "f2a15428277090d6ad387de6d517303b9bc4e2af",
      "original_line" : 177,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 25,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305946231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, agree this is weirdly implicit and am open to alternative approaches here. Since we expect headers to sync within a relatively short amount of time, I can see the utility of waiting. If anyone has strong feelings here please chime in.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:27:01Z",
      "diff_hunk" : "@@ -2699,6 +2699,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305946231",
      "id" : 1305946231,
      "in_reply_to_id" : 1291670706,
      "line" : 2745,
      "node_id" : "PRRC_kwDOABII585N1yh3",
      "original_commit_id" : "8ac7427b41fdec1dbc7e06d0aa2c0e469b879ba2",
      "original_line" : 2745,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 47,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305947674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I definitely think we can be smarter about pruning, but because we do it chainstate-by-chainstate I think that better management of the prune budget between chainstates might take a little more rework. Maybe something for a follow-up?",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:28:38Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305947674",
      "id" : 1305947674,
      "in_reply_to_id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585N1y4a",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 195,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305951844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:32:42Z",
      "diff_hunk" : "@@ -3178,15 +3179,16 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n             if (pindexFork != pindexNewTip) {\n                 // Notify ValidationInterface subscribers\n-                GetMainSignals().UpdatedBlockTip(pindexNewTip, pindexFork, fInitialDownload);\n-\n-                // Always notify the UI if a new block tip was connected\n-                if (kernel::IsInterrupted(m_chainman.GetNotifications().blockTip(GetSynchronizationState(fInitialDownload), *pindexNewTip))) {\n-                    // Just breaking and returning success for now. This could\n-                    // be changed to bubble up the kernel::Interrupted value to\n-                    // the caller so the caller could distinguish between\n-                    // completed and interrupted operations.\n-                    break;\n+                GetMainSignals().UpdatedBlockTip(this->GetRole(), pindexNewTip, pindexFork, fInitialDownload);\n+\n+                if (this == &m_chainman.ActiveChainstate() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305951844",
      "id" : 1305951844,
      "in_reply_to_id" : 1303334266,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N1z5k",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 3184,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305965612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, I think these are a vestige when mempool ownership wasn't so clear. I've removed them.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:45:09Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.\n      */\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n+    virtual void UpdatedBlockTip(const ChainstateRole, const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n     /**\n      * Notifies listeners of a transaction having been added to mempool.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305965612",
      "id" : 1305965612,
      "in_reply_to_id" : 1303342871,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N13Qs",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 97,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, the latest rebase is pushed, and I believe I've addressed all outstanding feedback (with the exception of two marginal comments from @ryanofsky relating to the first commit here, which perhaps I'll leave to @sdaftuar... unless he doesn't get back in some amount of time, in which case I'll take a look myself).\r\n\r\nI've iterated through all commits to ensure they build and pass the chainstate unittests. I've also fixed the intermediate-commit test failure that @Sjors discovered, which was based on not updating the unittest to use a \"recognized\" snapshot early enough. I've introduced a commit that fixes that sequencing.\r\n\r\nFor anyone curious, the tag updates here are [`au.029`](https://github.com/jamesob/bitcoin/tree/au.029) -> [`au.031`](https://github.com/jamesob/bitcoin/tree/au.031) ([GitHub range diff](https://github.com/jamesob/bitcoin/compare/au.029..au.031)) but the diff is kind of useless because of the rebase.\r\n\r\nMuch more useful is doing the range-diff locally yourself:\r\n```sh\r\ngit range-diff master jamesob/au.029 jamesob/au.031\r\n```\r\n\r\nThanks again for continued review and testing @ryanofsky @dergoegge @fjahr @Sjors @theStack @achow101 @D33r-Gee @ismaelsadeeq @alexanderwiederin @mzumsande @hazeycode and anyone else I forgot.",
      "created_at" : "2023-08-25T18:20:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1693764004",
      "id" : 1693764004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585k9Mmk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693764004/reactions"
      },
      "updated_at" : "2023-08-25T18:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693764004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Small update, I did a lot of manual testing on 157e510bc6deaaca43401f15f10105e44926ca68 while also monitoring stats like the size of the datadir etc. I mostly created my own snapshots on the current tip and then patched chainparams myself to be able to use them to push the limit a bit. It worked well and I didn't run into any issues aside from what I mention in #28350 which is not only an assumeutxo problem.",
      "created_at" : "2023-08-27T12:50:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1694660622",
      "id" : 1694660622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585lAngO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1694660622/reactions"
      },
      "updated_at" : "2023-08-27T12:50:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1694660622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307949616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nSuggested comment updates to clarify effect of passing `activeChain` and better describe what it means for a `nodeStaller` value to be returned:\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -906,18 +906,20 @@ private:\r\n     * \\param nWindowEnd   Maximum height of blocks to allow in vBlocks. No\r\n     *                     blocks will be added above this height.\r\n     * \\param activeChain  Optional pointer to a chain to compare against. If\r\n-    *                     provided, any blocks contained by this chain will only\r\n-    *                     be used to update state->pindexLastCommonBlock, and\r\n-    *                     will not be appended to vBlocks.\r\n+    *                     provided, any next blocks which are already contained\r\n+    *                     in this chain will not be appended to vBlocks, but\r\n+    *                     instead will be used to update the\r\n+    *                     state->pindexLastCommonBlock pointer.\r\n     * \\param nodeStaller  Optional pointer to a NodeId variable that will receive\r\n     *                     the ID of another peer that might be causing this peer\r\n     *                     to stall. This is set to the ID of the peer which\r\n     *                     first requested the first in-flight block in the\r\n     *                     download window. It is only set if vBlocks is empty at\r\n     *                     the end of this function call and if increasing\r\n-    *                     nWindowEnd by 1 would have caused it to be non-empty\r\n-    *                     (which indicates the download might be stalled since\r\n-    *                     every block in the window is in flight.)\r\n+    *                     nWindowEnd by 1 would cause it to be non-empty (which\r\n+    *                     indicates the download might be stalled because every\r\n+    *                     block in the window is in flight and no other peer is\r\n+    *                     trying to download the next block).\r\n     */\r\n     void FindNextBlocks(std::vector<const CBlockIndex*>& vBlocks, const Peer& peer, CNodeState *state, const CBlockIndex *pindexWalk, unsigned int count, int nWindowEnd, const CChain* activeChain=nullptr, NodeId* nodeStaller=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:04:29Z",
      "diff_hunk" : "@@ -892,6 +892,35 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /**\n+    * \\brief Find next blocks to download from a peer after a starting block.\n+    *\n+    * \\param vBlocks      Vector of blocks to download which will be appended to.\n+    * \\param peer         ID of peer which blocks will be downloaded from.\n+    * \\param state        Pointer to the state of the peer.\n+    * \\param pindexWalk   Pointer to the starting block to add to vBlocks.\n+    * \\param count        Maximum number of blocks to allow in vBlocks. No more\n+    *                     blocks will be added if it reaches this size.\n+    * \\param nWindowEnd   Maximum height of blocks to allow in vBlocks. No\n+    *                     blocks will be added above this height.\n+    * \\param activeChain  Optional pointer to a chain to compare against. If\n+    *                     provided, any blocks contained by this chain will only\n+    *                     be used to update state->pindexLastCommonBlock, and\n+    *                     will not be appended to vBlocks.\n+    * \\param nodeStaller  Optional pointer to a NodeId variable that will receive\n+    *                     the ID of another peer that might be causing this peer\n+    *                     to stall. This is set to the ID of the peer which\n+    *                     first requested the first in-flight block in the\n+    *                     download window. It is only set if vBlocks is empty at\n+    *                     the end of this function call and if increasing\n+    *                     nWindowEnd by 1 would have caused it to be non-empty\n+    *                     (which indicates the download might be stalled since\n+    *                     every block in the window is in flight.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307949616",
      "id" : 1307949616,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585N9bow",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 920,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307955088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351\r\n\r\n> This is an exaggeration, right?\r\n\r\nIn commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nStill curious about this and think it would be good to either explain it more, or change the behavior, or just s/useless/less useful/ if that would be more accurate to avoid confusion.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:11:24Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307955088",
      "id" : 1307955088,
      "in_reply_to_id" : 1294879351,
      "line" : 1395,
      "node_id" : "PRRC_kwDOABII585N9c-Q",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1395,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 95,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307957163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nAny reason these two lines are moving? This change seems like it have been accidentally added in a rebase. Would probably be good to revert.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:14:12Z",
      "diff_hunk" : "@@ -1036,12 +1033,25 @@ class ChainstateManager\n     //! Otherwise, revert to using the ibd chainstate and shutdown.\n     SnapshotCompletionResult MaybeCompleteSnapshotValidation() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307957163",
      "id" : 1307957163,
      "line" : 1046,
      "node_id" : "PRRC_kwDOABII585N9der",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 1037,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 60,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307968803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\n`background_sync_state` variable is not actually referenced below, and code which locks and unlocks cs_main twice seems potentially racy. Would suggest cleaning this up with:\r\n\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -4070,10 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\r\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\r\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\r\n     }\r\n-    BlockValidationState background_sync_state;\r\n-    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&\r\n-            !WITH_LOCK(::cs_main, return *m_ibd_chainstate).ActivateBestChain(state, block)) {\r\n-        return error(\"%s: [background] ActivateBestChain failed (%s)\", __func__, state.ToString());\r\n+\r\n+    Chainstate* bg_chain{WITH_LOCK(cs_main, return BackgroundSyncInProgress() ? m_ibd_chainstate.get() : nullptr)};\r\n+    BlockValidationState bg_state;\r\n+    if (bg_chain && !bg_chain->ActivateBestChain(bg_state, block)) {\r\n+        return error(\"%s: [background] ActivateBestChain failed (%s)\", __func__, bg_state.ToString());\r\n     }\r\n \r\n     return true;\r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:24:09Z",
      "diff_hunk" : "@@ -4070,6 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n+    BlockValidationState background_sync_state;\n+    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307968803",
      "id" : 1307968803,
      "line" : 4117,
      "node_id" : "PRRC_kwDOABII585N9gUj",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 4074,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 174,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307984332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nIt seems impossible that target could be nullptr here if condition above is true and cs_main is held. Would be clearer to just `assert(target)` rather than checking for this condition which should be impossible. Or if this is actually expected would be good to add a comment saying when target may be null.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:35:54Z",
      "diff_hunk" : "@@ -5831,6 +5889,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n             FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+                const CBlockIndex *target = m_chainman.GetSnapshotBaseBlock();\n+                if (target != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307984332",
      "id" : 1307984332,
      "line" : 5911,
      "node_id" : "PRRC_kwDOABII585N9kHM",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 5894,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 178,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307996274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"assumeutxo: remove snapshot during -reindex{-chainstate}\" (1755c53365d53693213a721138a44bdd889d8794)\r\n\r\nReturn value from this delete is being ignored. I think DeleteSnapshotChainstate should return a bool and return false if this fails. It would also be good to mark both functions [[nodiscard]] and exit with InitError if the DeleteSnapshotChainstate call fails. I don't think it makes sense to ignore the failure and do a partial reindexing of the background chain only.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:52:22Z",
      "diff_hunk" : "@@ -5712,6 +5717,18 @@ util::Result<void> Chainstate::InvalidateCoinsDBOnDisk()\n     return {};\n }\n \n+void ChainstateManager::DeleteSnapshotChainstate()\n+{\n+    AssertLockHeld(::cs_main);\n+    Assert(m_snapshot_chainstate);\n+    Assert(m_ibd_chainstate);\n+\n+    fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*m_snapshot_chainstate);\n+    DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307996274",
      "id" : 1307996274,
      "line" : 5767,
      "node_id" : "PRRC_kwDOABII585N9nBy",
      "original_commit_id" : "1755c53365d53693213a721138a44bdd889d8794",
      "original_line" : 5727,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 320,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308014826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: MaybeRebalanceCaches when chain leaves IBD\" (3e7d3537fc06c8aff8a48edc8f179a70af46e04c)\r\n\r\nI think it would be helpful to have a reminder about why this is necessary, maybe \"// Call MaybeRebalanceCaches in case background and snapshot chainstates both exist, and the snapshot chainstate is almost finished downloading blocks, so more resources can be shifted to the background download.\"",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:21:44Z",
      "diff_hunk" : "@@ -3195,6 +3202,11 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n         }\n         // When we reach this point, we switched to a new tip (stored in pindexNewTip).\n \n+        if (exited_ibd) {\n+            LOCK(::cs_main);\n+            m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308014826",
      "id" : 1308014826,
      "line" : 3217,
      "node_id" : "PRRC_kwDOABII585N9rjq",
      "original_commit_id" : "3e7d3537fc06c8aff8a48edc8f179a70af46e04c",
      "original_line" : 3207,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308025208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateRole\" (95f45e38b5e47eaef56468909d04418b93e9c962)\r\n\r\nI don't have a specific suggestion here, just an observation that this method seems like it is called from multiple threads but it doesn't require cs_main. So potentially there could be a race condition where a snapshot is loaded during this call, or validated during this call and it returns a stale value. I think this is not a new issue, since returning stale values also seems to be characteristic of the existing `GetAll()` and `ActiveChainstate()` methods. But in the long term it would probably be better if all of these methods were marked `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` and stopped acquiring `cs_main` internally so they could not return stale values and create potential race conditions.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:38:42Z",
      "diff_hunk" : "@@ -5729,6 +5729,16 @@ void ChainstateManager::DeleteSnapshotChainstate()\n     m_snapshot_chainstate.reset();\n }\n \n+ChainstateRole Chainstate::GetRole() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308025208",
      "id" : 1308025208,
      "line" : 5772,
      "node_id" : "PRRC_kwDOABII585N9uF4",
      "original_commit_id" : "95f45e38b5e47eaef56468909d04418b93e9c962",
      "original_line" : 5732,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308029027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: only call UpdatedBlockTip for active chainstate\" (9eda8224119450b8614837e0c8decfc81a6b9915)\r\n\r\nCould update commit message to mention that in addition to skipping `CValidationInterface::UpdatedBlockTip` notifications for the background chainstate, it also skips `kernel::Notifications::blockTip` notifications.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:45:57Z",
      "diff_hunk" : "@@ -3186,7 +3186,7 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n \n             // Notify external listeners about the new tip.\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n-            if (pindexFork != pindexNewTip) {\n+            if (this == &m_chainman.ActiveChainstate() && pindexFork != pindexNewTip) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308029027",
      "id" : 1308029027,
      "line" : 3199,
      "node_id" : "PRRC_kwDOABII585N9vBj",
      "original_commit_id" : "9eda8224119450b8614837e0c8decfc81a6b9915",
      "original_line" : 3189,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 105,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308031241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nArgument order here is a little weird. It would make more sense for it to be `obj, role` rather than `role, obj` so the object is still first and so `role` is right before `block` just like everywhere else.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:50:05Z",
      "diff_hunk" : "@@ -19,7 +19,11 @@ struct TestChainstateManager : public ChainstateManager {\n class ValidationInterfaceTest\n {\n public:\n-    static void BlockConnected(CValidationInterface& obj, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex);\n+    static void BlockConnected(\n+        const ChainstateRole role,\n+        CValidationInterface& obj,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308031241",
      "id" : 1308031241,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585N9vkJ",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 24,
      "original_position" : 7,
      "original_start_line" : 23,
      "path" : "src/test/util/validation.h",
      "position" : 7,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 23,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308032026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nWould make more sense to update this comment in the previous commit \"validation: only call UpdatedBlockTip for active chainstate\" (9eda8224119450b8614837e0c8decfc81a6b9915) instead of this commit.\r\n",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:51:43Z",
      "diff_hunk" : "@@ -87,7 +88,7 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308032026",
      "id" : 1308032026,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585N9vwa",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308039060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nIgnore this comment if this was intentional, but it seems unusual to make the `ChainstateRole` parameter const, when the codebase doesn't use const value parameters in general or in this interface for other parameters like `MemPoolRemovalReason`. IMO the `const` just adds noise without being more safe, and makes the method less convenient to implement. But not a problem if this is just a style difference and was intended.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:05:30Z",
      "diff_hunk" : "@@ -199,11 +205,11 @@ class CMainSignals {\n     void UpdatedBlockTip(const CBlockIndex *, const CBlockIndex *, bool fInitialDownload);\n     void TransactionAddedToMempool(const CTransactionRef&, uint64_t mempool_sequence);\n     void TransactionRemovedFromMempool(const CTransactionRef&, MemPoolRemovalReason, uint64_t mempool_sequence);\n-    void BlockConnected(const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);\n+    void BlockConnected(const ChainstateRole, const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308039060",
      "id" : 1308039060,
      "line" : 208,
      "node_id" : "PRRC_kwDOABII585N9xeU",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 208,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 64,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308042767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validationinterface: only send zmq notifications for active\" (b48729144fba1dbc64d603b2644a76c3f00d44eb)\r\n\r\nI'm surprised to see this release note. It seems like no observable behavior change could be happening with this PR because it wasn't possible to load a snapshot previously. If this is the case, I think putting this information in release notes could only be confusing and it would be better to document this behavior in `doc/zmq.md` instead",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:13:14Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+ZMQ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308042767",
      "id" : 1308042767,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585N9yYP",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 1,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308047801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validationinterface: only send zmq notifications for active\" (b48729144fba1dbc64d603b2644a76c3f00d44eb)\r\n\r\nThis seems like no-op change that could be reverted. Or if this is supposed to be a style cleanup, would probably make sense to add {} and modernize it since the line is changing anyway.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:22:33Z",
      "diff_hunk" : "@@ -144,7 +144,8 @@ void TryForEachAndRemoveFailed(std::list<std::unique_ptr<CZMQAbstractNotifier>>&\n \n void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload)\n {\n-    if (fInitialDownload || pindexNew == pindexFork) // In IBD or blocks were disconnected without any new ones\n+    // In IBD or blocks were disconnected without any new ones\n+    if (fInitialDownload || pindexNew == pindexFork)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308047801",
      "id" : 1308047801,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII585N9zm5",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 148,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 14,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308053648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: cache indexer references on ChainstateManager\" (688b68f34fe061c3064a516cdf77d4c155bfcafd)\r\n\r\nHaven't reviewed later commits yet, but it seems not ideal for ChainstateManager to be aware of indexes. I think it would might be better to add a new ValidationInterface method that indexes (and wallets) could handle to start resyncing themselves whenever the background download finishes. \r\n\r\nMinor: Since this is a member, should be prefixed with `m_`. Also would be good to `s/indexer/index/` everywhere for consistency with `NodeContext::indexes and other index variables. (In general I think \"index\" sounds better than \"indexer\" and \"indexing\" sounds better than \"indexation\" to stick to more common terms.)\r\n\r\n",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:35:37Z",
      "diff_hunk" : "@@ -909,6 +910,8 @@ class ChainstateManager\n \n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n+    std::vector<BaseIndex*> indexers{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308053648",
      "id" : 1308053648,
      "line" : 909,
      "node_id" : "PRRC_kwDOABII585N91CQ",
      "original_commit_id" : "688b68f34fe061c3064a516cdf77d4c155bfcafd",
      "original_line" : 913,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 46,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nThis could probably loop over `node.indexes` instead of `chainman.indexers` and then the `chainman.indexers` variable could be eliminated.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:04:25Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");\n+\n+            // Drain the validation interface queue to ensure that the old indexers\n+            // don't have any pending work.\n+            SyncWithValidationInterfaceQueue();\n+\n+            for (auto* indexer : chainman.indexers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066452",
      "id" : 1308066452,
      "line" : 1486,
      "node_id" : "PRRC_kwDOABII585N94KU",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1486,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 14,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nWould be nice to s/indexers/indexes/, s/indexer/s/index/ /s/indexation/indexing/ everywhere.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:05:37Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066973",
      "id" : 1308066973,
      "line" : 1480,
      "node_id" : "PRRC_kwDOABII585N94Sd",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1480,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 8,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308070723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nWould suggest simplifying function type to `std::function<void()>` because handler should be able to determine what state is needs to run and capture it explicitly. Also the reference might be unnecessary if the m_indexers variable is removed as suggested.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:13:48Z",
      "diff_hunk" : "@@ -911,6 +911,10 @@ class ChainstateManager\n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n     std::vector<BaseIndex*> indexers{};\n+    //! Function to restart active indexers; set dynamically to avoid a circular\n+    //! dependency on `base/index.cpp`.\n+    std::function<void(const ChainstateManager&)> restart_indexers =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308070723",
      "id" : 1308070723,
      "line" : 912,
      "node_id" : "PRRC_kwDOABII585N95ND",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 916,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 49,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308071774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nI'm surprised this method can't just return `m_ibd_chainstate.get()`. It would be good to simplify this code if possible or else add some explanation for the logic, which seems pretty complicated.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:16:15Z",
      "diff_hunk" : "@@ -5838,3 +5848,9 @@ bool ChainstateManager::ValidatedSnapshotCleanup()\n     }\n     return true;\n }\n+\n+Chainstate& ChainstateManager::GetChainstateForIndexing()\n+{\n+    return (IsSnapshotActive() && !IsSnapshotValidated()) ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308071774",
      "id" : 1308071774,
      "line" : 5882,
      "node_id" : "PRRC_kwDOABII585N95de",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 5854,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 345,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308075373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nI think it would be good `assert(snapshot_height)` or else add a comment saying when `snapshot_height` is expected to be `nullopt`, rather than write code that seems like it is trying to handle an impossible condition.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:25:06Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308075373",
      "id" : 1308075373,
      "line" : 5895,
      "node_id" : "PRRC_kwDOABII585N96Vt",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5876,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 358,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308076179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nSeems like the code would be a little simpler if this said `if (this->GetAll().size() > 1 && &chainstate == m_snapshot_chainstate.get())` so relevant conditions would be stated up front, and nested if statement below could go away",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:26:50Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308076179",
      "id" : 1308076179,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585N96iT",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5875,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 357,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308082844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould definitely suggest using plain `int` instead of `unsigned int` for heights everywhere to avoid overflow bugs and extra type casts. The rest of the code represents block heights with ints, and unsigned types are great for representing bits but less great at representing quantities you would like to perform arithmetic on.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:42:46Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.\n+    std::pair<unsigned int, unsigned int> GetPruneRange(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308082844",
      "id" : 1308082844,
      "line" : 1251,
      "node_id" : "PRRC_kwDOABII585N98Kc",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1251,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 110,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308085308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nProbably doesn't matter in practice, but according to the function documentation, this would indicate the pruning range includes the genesis block. Would suggest returning `{1, 0}` here and also initializing `prune_start` to 1 instead of 0 below.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:48:47Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308085308",
      "id" : 1308085308,
      "line" : 5890,
      "node_id" : "PRRC_kwDOABII585N98w8",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5871,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 353,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308096895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nNo reason to pass `m_chain.Height()` here anymore now this is passing `*this` chainstate reference. Having the redundant parameter makes code in the function more complicated and hard to follow because there are multiple variables referring to the same height.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:16:55Z",
      "diff_hunk" : "@@ -2474,11 +2475,19 @@ bool Chainstate::FlushStateToDisk(\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(\n+                    setFilesToPrune,\n+                    std::min(last_prune, nManualPruneHeight),\n+                    m_chain.Height(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308096895",
      "id" : 1308096895,
      "line" : 2481,
      "node_id" : "PRRC_kwDOABII585N9_l_",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 2481,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 33,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308104549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nSame as earlier comment, but again it is confusing to keep this `chain_tip_height` parameter which is redundant with the `chain` parameter and makes the implementation more complicated because there are multiple variables referring to the same height.\r\n\r\nAlso would suggest calling the `prune_height` parameter `last_prune` to be be more descriptive, and consistent with the argument that is passed in validation.cpp. Also could add documentation for the parameter as \"the last height we can prune\" or something similar.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:31:48Z",
      "diff_hunk" : "@@ -122,7 +128,13 @@ class BlockManager\n      *\n      * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\n      */\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd);\n+    void FindFilesToPrune(\n+        std::set<int>& setFilesToPrune,\n+        uint64_t nPruneAfterHeight,\n+        int chain_tip_height,\n+        int prune_height,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308104549",
      "id" : 1308104549,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585N-Bdl",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 135,
      "original_position" : 31,
      "original_start_line" : 134,
      "path" : "src/node/blockstorage.h",
      "position" : 86,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 160,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308108294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould be good to say that `start > end` is possible and indicates prune range is empty.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:40:36Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308108294",
      "id" : 1308108294,
      "line" : 1247,
      "node_id" : "PRRC_kwDOABII585N-CYG",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1247,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 106,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308114692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nI think if you divide by 2 you also need to take max with MIN_DISK_SPACE_FOR_BLOCK_FILES to avoid going below the minimum supported pruning size.\r\n\r\nMaybe the easiest and most conservative thing to do for now would just be to keep the pruning target the same and just write documentation that says if you load a snapshot, you may temporarily need twice as much disk space as otherwise,",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:55:59Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308114692",
      "id" : 1308114692,
      "in_reply_to_id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585N-D8E",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 195,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308119179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nCode would be simpler if this line were dropped and `nManualPruneHeight` was passed as the parameter to `GetPruneRange` above instead of `chain_tip_height`. Passing `chain_tip_height` above has no effect because `GetPruneRange` already takes the min with the `chain.m_chain.Height()`.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T02:07:57Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308119179",
      "id" : 1308119179,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585N-FCL",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 167,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 34,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308128467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould suggest compressing this all down to:\r\n\r\n```c++\r\n// Set the end of the prune range to the maximum height which is at least\r\n// MIN_BLOCKS_TO_KEEP blocks away from the chain tip, and is not higher than the\r\n// highest block that is allowed to be pruned according to the caller.\r\nprune_end = std::min(std::max<int>(0, chain_height - MIN_BLOCKS_TO_KEEP), last_prune);\r\n```\r\n\r\nAssuming `prune_height` is renamed back to `last_prune` as suggested earlier and made into an int.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T02:29:53Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};\n+\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        if (&chainstate == m_snapshot_chainstate.get() && snapshot_height) {\n+            prune_start = *snapshot_height + 1;\n+        }\n+    }\n+\n+    unsigned int prune_end{0};\n+    unsigned int chain_height{static_cast<unsigned int>(chainstate.m_chain.Height())};\n+\n+    if (MIN_BLOCKS_TO_KEEP > chain_height) {\n+        // Prevent underflow.\n+        prune_end = 0;\n+    } else {\n+        // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n+        //\n+        // While you might be tempted to prune the background chainstate more\n+        // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index\n+        // building - specifically blockfilterindex requires undo data, and if\n+        // we don't maintain this trailing window, we hit indexation failures.\n+        prune_end = std::min(prune_height, chain_height - MIN_BLOCKS_TO_KEEP);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308128467",
      "id" : 1308128467,
      "line" : 5918,
      "node_id" : "PRRC_kwDOABII585N-HTT",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5899,
      "original_position" : 67,
      "original_start_line" : 5888,
      "path" : "src/validation.cpp",
      "position" : 381,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5907,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308540550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308540550"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">seems potentially racy\r\n\r\nHow so?",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T10:13:04Z",
      "diff_hunk" : "@@ -4070,6 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n+    BlockValidationState background_sync_state;\n+    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308540550",
      "id" : 1308540550,
      "in_reply_to_id" : 1307968803,
      "line" : 4117,
      "node_id" : "PRRC_kwDOABII585N_r6G",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 4074,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 174,
      "pull_request_review_id" : 1600003600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308540550/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T10:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308540550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Did code review at e44815e9a754c967415402b34807633625393084. Most of the @ryanofsky I think are worth addressing. Once these are addressed or resolved I will do my own clean path.\r\n\r\nI also spotted a couple of typos along the way.",
      "created_at" : "2023-08-29T11:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1697226564",
      "id" : 1697226564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585lKZ9E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697226564/reactions"
      },
      "updated_at" : "2023-08-29T11:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697226564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308696215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308696215"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> > seems potentially racy\r\n> \r\n> How so?\r\n\r\nI don't think there is a real race condition here because if stale a BackgroundSyncInProgress value were used, it wouldn't cause any harm. By \"potentially racy\" I just meant that any time I see a mutex being unlocked and immediately relocked I have to turn on the part of my brain that thinks about race conditions, so it's nicer to use one lock than worry about what state can change in the gap between locks.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T11:49:09Z",
      "diff_hunk" : "@@ -4070,6 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n+    BlockValidationState background_sync_state;\n+    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308696215",
      "id" : 1308696215,
      "in_reply_to_id" : 1307968803,
      "line" : 4117,
      "node_id" : "PRRC_kwDOABII585OAR6X",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 4074,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 174,
      "pull_request_review_id" : 1600221022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308696215/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T11:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308696215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309104196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309104196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep - this method now must be public to be made use of in [`PeerManagerImpl::SendMessages()`](https://github.com/bitcoin/bitcoin/commit/08a34e56ba7aa8714982d352238f1cb6eba43e29#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R5893) (which was a refactoring from the commit you offered in an earlier review - the content of this function had been reproduced).",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T16:47:21Z",
      "diff_hunk" : "@@ -1036,12 +1033,25 @@ class ChainstateManager\n     //! Otherwise, revert to using the ibd chainstate and shutdown.\n     SnapshotCompletionResult MaybeCompleteSnapshotValidation() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309104196",
      "id" : 1309104196,
      "in_reply_to_id" : 1307957163,
      "line" : 1044,
      "node_id" : "PRRC_kwDOABII585OB1hE",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 1044,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 51,
      "pull_request_review_id" : 1600876009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309104196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T16:47:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309104196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309108048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309108048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T16:50:42Z",
      "diff_hunk" : "@@ -892,6 +892,35 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /**\n+    * \\brief Find next blocks to download from a peer after a starting block.\n+    *\n+    * \\param vBlocks      Vector of blocks to download which will be appended to.\n+    * \\param peer         ID of peer which blocks will be downloaded from.\n+    * \\param state        Pointer to the state of the peer.\n+    * \\param pindexWalk   Pointer to the starting block to add to vBlocks.\n+    * \\param count        Maximum number of blocks to allow in vBlocks. No more\n+    *                     blocks will be added if it reaches this size.\n+    * \\param nWindowEnd   Maximum height of blocks to allow in vBlocks. No\n+    *                     blocks will be added above this height.\n+    * \\param activeChain  Optional pointer to a chain to compare against. If\n+    *                     provided, any blocks contained by this chain will only\n+    *                     be used to update state->pindexLastCommonBlock, and\n+    *                     will not be appended to vBlocks.\n+    * \\param nodeStaller  Optional pointer to a NodeId variable that will receive\n+    *                     the ID of another peer that might be causing this peer\n+    *                     to stall. This is set to the ID of the peer which\n+    *                     first requested the first in-flight block in the\n+    *                     download window. It is only set if vBlocks is empty at\n+    *                     the end of this function call and if increasing\n+    *                     nWindowEnd by 1 would have caused it to be non-empty\n+    *                     (which indicates the download might be stalled since\n+    *                     every block in the window is in flight.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309108048",
      "id" : 1309108048,
      "in_reply_to_id" : 1307949616,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OB2dQ",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 920,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309108048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309108048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309115860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309115860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've rephrased the comment and added a note about potentially requesting partial subset of blocks in the future.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T16:57:46Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309115860",
      "id" : 1309115860,
      "in_reply_to_id" : 1294879351,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OB4XU",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1395,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309115860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309115860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309121965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309121965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good, since we've ensured that the snapshot base block index exists prior to snapshot activation (`PopulateAndValidateSnapshot()`).",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T17:03:31Z",
      "diff_hunk" : "@@ -5831,6 +5889,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n             FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+                const CBlockIndex *target = m_chainman.GetSnapshotBaseBlock();\n+                if (target != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309121965",
      "id" : 1309121965,
      "in_reply_to_id" : 1307984332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OB52t",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 5894,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309121965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309121965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309141159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309141159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point and thanks for the suggestion; took your diff.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T17:21:56Z",
      "diff_hunk" : "@@ -4070,6 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n+    BlockValidationState background_sync_state;\n+    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309141159",
      "id" : 1309141159,
      "in_reply_to_id" : 1307968803,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OB-in",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 4074,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309141159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309141159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309155137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309155137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good points, fixed per your advice.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T17:35:52Z",
      "diff_hunk" : "@@ -5712,6 +5717,18 @@ util::Result<void> Chainstate::InvalidateCoinsDBOnDisk()\n     return {};\n }\n \n+void ChainstateManager::DeleteSnapshotChainstate()\n+{\n+    AssertLockHeld(::cs_main);\n+    Assert(m_snapshot_chainstate);\n+    Assert(m_ibd_chainstate);\n+\n+    fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*m_snapshot_chainstate);\n+    DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309155137",
      "id" : 1309155137,
      "in_reply_to_id" : 1307996274,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCB9B",
      "original_commit_id" : "1755c53365d53693213a721138a44bdd889d8794",
      "original_line" : 5727,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309155137/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309155137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309161936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309161936"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment that's slightly more vague because I think the logic for how we balance the caches should be confined to `MaybeRebalanceCaches()` so that this comment doesn't fall out of date.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T17:42:56Z",
      "diff_hunk" : "@@ -3195,6 +3202,11 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n         }\n         // When we reach this point, we switched to a new tip (stored in pindexNewTip).\n \n+        if (exited_ibd) {\n+            LOCK(::cs_main);\n+            m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309161936",
      "id" : 1309161936,
      "in_reply_to_id" : 1308014826,
      "line" : 3214,
      "node_id" : "PRRC_kwDOABII585OCDnQ",
      "original_commit_id" : "3e7d3537fc06c8aff8a48edc8f179a70af46e04c",
      "original_line" : 3214,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 110,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309161936/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309161936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309196765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309196765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Definitely agree here, but it'd be nice to tackle this as a follow-up since inverting all the `cs_main` acquisitions for `ActiveChainstate()` will be a big diff (if not mechanical).\r\n\r\nFor now I can add `EXCLUSIVE_LOCKS_REQUIRED` annotations to `GetRole()`, which compiles okay at the HEAD of this branch.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T18:19:40Z",
      "diff_hunk" : "@@ -5729,6 +5729,16 @@ void ChainstateManager::DeleteSnapshotChainstate()\n     m_snapshot_chainstate.reset();\n }\n \n+ChainstateRole Chainstate::GetRole() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309196765",
      "id" : 1309196765,
      "in_reply_to_id" : 1308025208,
      "line" : 5765,
      "node_id" : "PRRC_kwDOABII585OCMHd",
      "original_commit_id" : "95f45e38b5e47eaef56468909d04418b93e9c962",
      "original_line" : 5765,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 285,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309196765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309196765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309270401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309270401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:30:34Z",
      "diff_hunk" : "@@ -3186,7 +3186,7 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n \n             // Notify external listeners about the new tip.\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n-            if (pindexFork != pindexNewTip) {\n+            if (this == &m_chainman.ActiveChainstate() && pindexFork != pindexNewTip) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309270401",
      "id" : 1309270401,
      "in_reply_to_id" : 1308029027,
      "line" : 3194,
      "node_id" : "PRRC_kwDOABII585OCeGB",
      "original_commit_id" : "9eda8224119450b8614837e0c8decfc81a6b9915",
      "original_line" : 3194,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 91,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309270401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309270401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309271332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309271332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I figured that since we'd immediately be filtering on `role` for many of these notifications it kind of made sense going first. I can change it but I won't do that unless you really want me to because I'm lazy.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:31:38Z",
      "diff_hunk" : "@@ -19,7 +19,11 @@ struct TestChainstateManager : public ChainstateManager {\n class ValidationInterfaceTest\n {\n public:\n-    static void BlockConnected(CValidationInterface& obj, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex);\n+    static void BlockConnected(\n+        const ChainstateRole role,\n+        CValidationInterface& obj,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309271332",
      "id" : 1309271332,
      "in_reply_to_id" : 1308031241,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCeUk",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 24,
      "original_position" : 7,
      "original_start_line" : 23,
      "path" : "src/test/util/validation.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309271332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309271332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309272443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309272443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:33:02Z",
      "diff_hunk" : "@@ -87,7 +88,7 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309272443",
      "id" : 1309272443,
      "in_reply_to_id" : 1308032026,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585OCel7",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309272443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309272443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309274440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309274440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed. Just dumb muscle memory on my part.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:35:34Z",
      "diff_hunk" : "@@ -199,11 +205,11 @@ class CMainSignals {\n     void UpdatedBlockTip(const CBlockIndex *, const CBlockIndex *, bool fInitialDownload);\n     void TransactionAddedToMempool(const CTransactionRef&, uint64_t mempool_sequence);\n     void TransactionRemovedFromMempool(const CTransactionRef&, MemPoolRemovalReason, uint64_t mempool_sequence);\n-    void BlockConnected(const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);\n+    void BlockConnected(const ChainstateRole, const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309274440",
      "id" : 1309274440,
      "in_reply_to_id" : 1308039060,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCfFI",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 208,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309274440/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309274440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309281888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:44:14Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+ZMQ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309281888",
      "id" : 1309281888,
      "in_reply_to_id" : 1308042767,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCg5g",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281888/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309281932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:44:17Z",
      "diff_hunk" : "@@ -144,7 +144,8 @@ void TryForEachAndRemoveFailed(std::list<std::unique_ptr<CZMQAbstractNotifier>>&\n \n void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload)\n {\n-    if (fInitialDownload || pindexNew == pindexFork) // In IBD or blocks were disconnected without any new ones\n+    // In IBD or blocks were disconnected without any new ones\n+    if (fInitialDownload || pindexNew == pindexFork)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309281932",
      "id" : 1309281932,
      "in_reply_to_id" : 1308047801,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCg6M",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 148,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309281932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309289948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309289948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We can't just return `m_ibd_chainstate` because we want the indexes to switch to the active (snapshot) chainstate once the background validation completes (but before a restart has happened). I'll make a note.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:53:38Z",
      "diff_hunk" : "@@ -5838,3 +5848,9 @@ bool ChainstateManager::ValidatedSnapshotCleanup()\n     }\n     return true;\n }\n+\n+Chainstate& ChainstateManager::GetChainstateForIndexing()\n+{\n+    return (IsSnapshotActive() && !IsSnapshotValidated()) ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309289948",
      "id" : 1309289948,
      "in_reply_to_id" : 1308071774,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCi3c",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 5854,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309289948/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309289948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309291356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:55:20Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");\n+\n+            // Drain the validation interface queue to ensure that the old indexers\n+            // don't have any pending work.\n+            SyncWithValidationInterfaceQueue();\n+\n+            for (auto* indexer : chainman.indexers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309291356",
      "id" : 1309291356,
      "in_reply_to_id" : 1308066452,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCjNc",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1486,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291356/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309291418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:55:24Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309291418",
      "id" : 1309291418,
      "in_reply_to_id" : 1308066973,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCjOa",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1480,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309291418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309294877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309294877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is resolved after removing `ChainstateManager.indexers`.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T19:59:12Z",
      "diff_hunk" : "@@ -909,6 +910,8 @@ class ChainstateManager\n \n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n+    std::vector<BaseIndex*> indexers{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309294877",
      "id" : 1309294877,
      "in_reply_to_id" : 1308053648,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCkEd",
      "original_commit_id" : "688b68f34fe061c3064a516cdf77d4c155bfcafd",
      "original_line" : 913,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309294877/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309294877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309295887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309295887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:00:22Z",
      "diff_hunk" : "@@ -911,6 +911,10 @@ class ChainstateManager\n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n     std::vector<BaseIndex*> indexers{};\n+    //! Function to restart active indexers; set dynamically to avoid a circular\n+    //! dependency on `base/index.cpp`.\n+    std::function<void(const ChainstateManager&)> restart_indexers =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309295887",
      "id" : 1309295887,
      "in_reply_to_id" : 1308070723,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCkUP",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 916,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309295887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309295887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309300988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309300988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.\r\n\r\nEdit: Initializing `prune_start` to 1 prevents the pruning of the blockfile with block height=0 in it, which causes the `feature_pruning.py` functional test to fail, so I'm keeping that part as-is.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:05:49Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309300988",
      "id" : 1309300988,
      "in_reply_to_id" : 1308085308,
      "line" : 5884,
      "node_id" : "PRRC_kwDOABII585OClj8",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5884,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 314,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309300988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309300988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309303935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309303935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:09:13Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309303935",
      "id" : 1309303935,
      "in_reply_to_id" : 1308075373,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCmR_",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5876,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309303935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309303935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309313670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309313670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point @ryanofsky. I'm taking your first recommendation here because doubling the prune budget in all cases feels excessive to me.\r\n\r\nI've added release notes describing this issue.\r\n",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:19:44Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309313670",
      "id" : 1309313670,
      "in_reply_to_id" : 1291649621,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCoqG",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 195,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309313670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309313670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309314011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309314011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:20:06Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309314011",
      "id" : 1309314011,
      "in_reply_to_id" : 1308119179,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCovb",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 167,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309314011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309314011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309318603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309318603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:25:28Z",
      "diff_hunk" : "@@ -122,7 +128,13 @@ class BlockManager\n      *\n      * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\n      */\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd);\n+    void FindFilesToPrune(\n+        std::set<int>& setFilesToPrune,\n+        uint64_t nPruneAfterHeight,\n+        int chain_tip_height,\n+        int prune_height,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309318603",
      "id" : 1309318603,
      "in_reply_to_id" : 1308104549,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCp3L",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 135,
      "original_position" : 31,
      "original_start_line" : 134,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309318603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309318603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309320282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:27:23Z",
      "diff_hunk" : "@@ -2474,11 +2475,19 @@ bool Chainstate::FlushStateToDisk(\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(\n+                    setFilesToPrune,\n+                    std::min(last_prune, nManualPruneHeight),\n+                    m_chain.Height(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309320282",
      "id" : 1309320282,
      "in_reply_to_id" : 1308096895,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCqRa",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 2481,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309320508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:27:38Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309320508",
      "id" : 1309320508,
      "in_reply_to_id" : 1308076179,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCqU8",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5875,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320508/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309320508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:40:33Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};\n+\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        if (&chainstate == m_snapshot_chainstate.get() && snapshot_height) {\n+            prune_start = *snapshot_height + 1;\n+        }\n+    }\n+\n+    unsigned int prune_end{0};\n+    unsigned int chain_height{static_cast<unsigned int>(chainstate.m_chain.Height())};\n+\n+    if (MIN_BLOCKS_TO_KEEP > chain_height) {\n+        // Prevent underflow.\n+        prune_end = 0;\n+    } else {\n+        // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n+        //\n+        // While you might be tempted to prune the background chainstate more\n+        // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index\n+        // building - specifically blockfilterindex requires undo data, and if\n+        // we don't maintain this trailing window, we hit indexation failures.\n+        prune_end = std::min(prune_height, chain_height - MIN_BLOCKS_TO_KEEP);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332220",
      "id" : 1309332220,
      "in_reply_to_id" : 1308128467,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCtL8",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5899,
      "original_position" : 67,
      "original_start_line" : 5888,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332321"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:40:40Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332321",
      "id" : 1309332321,
      "in_reply_to_id" : 1308108294,
      "line" : 1245,
      "node_id" : "PRRC_kwDOABII585OCtNh",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1245,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 97,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-29T20:40:44Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.\n+    std::pair<unsigned int, unsigned int> GetPruneRange(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309332387",
      "id" : 1309332387,
      "in_reply_to_id" : 1308082844,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OCtOj",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1251,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1600882627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T21:44:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309332387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Had to push a small commit to fix underflow in pruning calculations.\r\n```\r\ngit range-diff upstream/master jamesob/au.033 jamesob/au.034\r\n```",
      "created_at" : "2023-08-30T14:36:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1699307923",
      "id" : 1699307923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585lSWGT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699307923/reactions"
      },
      "updated_at" : "2023-08-30T14:36:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699307923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310404663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310404663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (5e4c824433fb4bf8b380d0f61a0aa424dc5456d4)\r\n\r\nWould s/user-specified/caller-specified/. In the manual pruning case it is actually user-specified, but in the automatic case it depends on prune locks.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T14:51:31Z",
      "diff_hunk" : "@@ -5864,3 +5871,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);\n+\n+    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310404663",
      "id" : 1310404663,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OGzA3",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 5890,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310404663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310404663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310410195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310410195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (5e4c824433fb4bf8b380d0f61a0aa424dc5456d4)\r\n\r\nIt looks like there was an overflow bug here previously which is fixed now? If chain_tip_height was less than MIN_BLOCKS_TO_KEEP, that would overflow and produce a large unsigned integer, so it would have been possible to manually prune chain data very close to the tip which the chain height was low previously, IIUC",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T14:55:17Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310410195",
      "id" : 1310410195,
      "line" : 157,
      "node_id" : "PRRC_kwDOABII585OG0XT",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 157,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 28,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310410195/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310410195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310423116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310423116"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (5e4c824433fb4bf8b380d0f61a0aa424dc5456d4)\r\n\r\nI think it would simplify the code more to drop the nPruneAfterHeight parameter and replace it directly with `_chainman.GetParams().PruneAfterHeight()` to make it obvious this is a hardcoded parameter.\r\n\r\nAlso maybe replace the C cast with a static cast if this line is changing anyway.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T15:03:57Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    int height = chain.m_chain.Height();\n+    if (height < 0 || target == 0) {\n         return;\n     }\n-    if ((uint64_t)chain_tip_height <= nPruneAfterHeight) {\n+    if ((uint64_t)height <= nPruneAfterHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310423116",
      "id" : 1310423116,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OG3hM",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 193,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310423116/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310423116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310432926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310432926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (5e4c824433fb4bf8b380d0f61a0aa424dc5456d4)\r\n\r\nSuggest keeping the name \"chain_tip_height\" instead of \"height\" for this variable. There are a lot of heights in this function so easy to forget what the the generic \"height\" is.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T15:10:35Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    int height = chain.m_chain.Height();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310432926",
      "id" : 1310432926,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OG56e",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 189,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310432926/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310432926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310435694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310435694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (5e4c824433fb4bf8b380d0f61a0aa424dc5456d4)\r\n\r\nLast remaining s/indexation/indexing/",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T15:12:29Z",
      "diff_hunk" : "@@ -5864,3 +5871,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);\n+\n+    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n+    //\n+    // While you might be tempted to prune the background chainstate more\n+    // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index\n+    // building - specifically blockfilterindex requires undo data, and if\n+    // we don't maintain this trailing window, we hit indexation failures.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310435694",
      "id" : 1310435694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OG6lu",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 5895,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310435694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310435694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310871911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310871911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: adjust chainstate tests to use recognized snapshot base\" (76d616c957522e7be52eaf10b3ac33accaf75c45)\r\n\r\nSeems pointless to call ActivateBestChain twice in a row here. Would be good to remove this line and simplify test setup or add a comment explaining why this is necessary.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T21:55:44Z",
      "diff_hunk" : "@@ -76,16 +71,21 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     Chainstate& c2 = WITH_LOCK(::cs_main, return manager.ActivateExistingSnapshot(\n         &mempool, snapshot_blockhash));\n     chainstates.push_back(&c2);\n-\n-    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n-\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    WITH_LOCK(::cs_main, c2.InitCoinsCache(1 << 23));\n-    c2.m_chain.SetTip(*active_tip);\n+    {\n+        LOCK(::cs_main);\n+        c2.InitCoinsCache(1 << 23);\n+        c2.m_chain.SetTip(*active_tip);\n+        c2.CoinsTip().SetBestBlock(active_tip->GetBlockHash());\n+        c2.setBlockIndexCandidates.insert(manager.m_blockman.LookupBlockIndex(active_tip->GetBlockHash()));\n+        c2.LoadChainTip();\n+    }\n     BlockValidationState _;\n     BOOST_CHECK(c2.ActivateBestChain(_, nullptr));\n \n+    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n+    BOOST_CHECK(c2.ActivateBestChain(_));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310871911",
      "id" : 1310871911,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OIlFn",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 88,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310871911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310871911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310877098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310877098"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: adjust chainstate tests to use recognized snapshot base\" (76d616c957522e7be52eaf10b3ac33accaf75c45)\r\n\r\nThis SetTip call seems pointless now because the LoadChainTip call below will overwrite the chain tip. Would suggest removing this line or adding more explanation in a comment.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T22:01:46Z",
      "diff_hunk" : "@@ -76,16 +71,21 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     Chainstate& c2 = WITH_LOCK(::cs_main, return manager.ActivateExistingSnapshot(\n         &mempool, snapshot_blockhash));\n     chainstates.push_back(&c2);\n-\n-    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n-\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    WITH_LOCK(::cs_main, c2.InitCoinsCache(1 << 23));\n-    c2.m_chain.SetTip(*active_tip);\n+    {\n+        LOCK(::cs_main);\n+        c2.InitCoinsCache(1 << 23);\n+        c2.m_chain.SetTip(*active_tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310877098",
      "id" : 1310877098,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OImWq",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 79,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310877098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310877098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310888128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310888128"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: adjust chainstate tests to use recognized snapshot base\" (76d616c957522e7be52eaf10b3ac33accaf75c45)\r\n\r\nI think it would be good to clarify this code and verify both tips are set correctly at the end of the test.\r\n\r\nWould suggest:\r\n\r\n```diff\r\n-    auto exp_tip2 = c2.m_chain.Tip();\r\n-    BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\r\n+    BOOST_CHECK_EQUAL(active_tip, active_tip2->pprev);\r\n+    BOOST_CHECK_EQUAL(active_tip, c1.m_chain.Tip());\r\n+    BOOST_CHECK_EQUAL(active_tip2, c2.m_chain.Tip());\r\n```",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T22:14:51Z",
      "diff_hunk" : "@@ -96,14 +96,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto& active_chain2 = WITH_LOCK(manager.GetMutex(), return manager.ActiveChain());\n     BOOST_CHECK_EQUAL(&active_chain2, &c2.m_chain);\n \n-    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 0);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 110);\n+    mineBlocks(1);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 111);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return c1.m_chain.Height()), 110);\n \n     auto active_tip2 = WITH_LOCK(manager.GetMutex(), return manager.ActiveTip());\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    BOOST_CHECK_EQUAL(exp_tip, exp_tip2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310888128",
      "id" : 1310888128,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585OIpDA",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 105,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 82,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310888128/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310888128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310901739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310901739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: adjust chainstate tests to use recognized snapshot base\" (76d616c957522e7be52eaf10b3ac33accaf75c45)\r\n\r\nWhat is going on here and in on line 499 below? It seems strange to advance the snapshot chain all the way to the chain tip if the point of the test below is to make sure setBlockIndexCandidates is initialized correctly after loading the snapshot, and setBlockIndexCandidates is supposed to be use to work towards the chain tip.\r\n\r\nAlso changing assumed_base to assumed_tip here and below seems contrary to the comments \"Set tip of the assume-valid-based chain to the assume-valid block\"\r\n\r\nIf I revert the changes this line and on line 499 the test still passes as of b6b62a96bd6d1eccaf6bd9eadfa1c60232aadeed, so I think they may be unnecessary",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T22:33:55Z",
      "diff_hunk" : "@@ -488,13 +490,13 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n-        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_tip->phashBlock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310901739",
      "id" : 1310901739,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OIsXr",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 493,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310901739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310901739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310947552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310947552"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: populate nChainTx value for assumedvalid chainstates\" (9df91113b8bbab8c98924bef61da388a8141b4e6)\r\n\r\nIt seems like this might be broken if a user loaded a snapshot and then quit before the snapshot block was successfully downloaded. In this case I think `pindex->nTx` for the snapshot block on line 291 would be 0 so the new code would not run.\r\n\r\nA good way to fix this might be to add something like `if (snapshot_blockhash) LookupBlockIndex(hash)->nChainTx = AssumeutxoForBlockhash(*snapshot_blockhash)` right after the LoadBlockIndexGuts call, before the for-loop.\r\n\r\nThe other advantage setting `nChainTx` before the for-loop would be that the for-loop can remain simpler and unchanged, and also be more efficient because it will no longer be need to compare `pindex->GetBlockHash() == *snapshot_blockhash)` for each block.\r\n\r\n\r\n",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T23:38:38Z",
      "diff_hunk" : "@@ -290,7 +290,13 @@ bool BlockManager::LoadBlockIndex()\n         // Pruned nodes may have deleted the block.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->nChainTx > 0) {\n+                if (snapshot_blockhash && pindex->GetBlockHash() == *snapshot_blockhash) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310947552",
      "id" : 1310947552,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OI3jg",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 293,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310947552/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310947552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310950827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310950827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: populate nChainTx value for assumedvalid chainstates\" (9df91113b8bbab8c98924bef61da388a8141b4e6)\r\n\r\nCould you assert not that just that it increases monotonically, but that it increases by the number of transactions?\r\n\r\n```c++\r\n assert(pindex->nChainTx == pindex->nTx + pindex->pprev->nChainTx);\r\n```\r\n\r\nOr maybe add a comment if there's a special case where this does not hold.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-30T23:44:37Z",
      "diff_hunk" : "@@ -4765,6 +4765,10 @@ void ChainstateManager::CheckBlockIndex()\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindex->pprev && pindex->nTx > 0) {\n+            // nChainTx should increase monotonically\n+            assert(pindex->pprev->nChainTx <= pindex->nChainTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310950827",
      "id" : 1310950827,
      "line" : 4766,
      "node_id" : "PRRC_kwDOABII585OI4Wr",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 4766,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 165,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310950827/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310950827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310965708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310965708"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: assumeutxo: swap m_mempool on snapshot activation\" (f2dd7a0c1b67d3e4a6e086a619eff34fe6625263)\r\n\r\nThis is still referencing ` m_last_blockfile` instead of `last_blockfile`, which does not make sense. I think it would be a good idea to remove the ` m_last_blockfile` member because this appears to be the only remaining usage.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T00:12:41Z",
      "diff_hunk" : "@@ -680,13 +753,14 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n         pos.nPos = m_blockfile_info[nFile].nSize;\n     }\n \n-    if ((int)nFile != m_last_blockfile) {\n+    if (nFile != last_blockfile) {\n         if (!fKnown) {\n-            LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s (onto %i) (height %i)\\n\",\n+                m_last_blockfile, m_blockfile_info[last_blockfile].ToString(), nFile, nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310965708",
      "id" : 1310965708,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OI7_M",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 759,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310965708/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:22:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310965708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310971801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310971801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nThis comment appears to be copied from an old version of PR #27746 (commit 6b5b53eafefa38250bb4e5d914e5ad5743416563) that was updated later. The final version of the #27746 had a more complete comment which can be found on line 178 below documenting the `m_undo_height_in_last_blockfile` member.\r\n\r\nI think to avoid confusion and bugs it's pretty important to delete the `m_last_blockfile` and `m_undo_height_in_last_blockfile` members below fully replace them with new members in this struct and move the latest `m_undo_height_in_last_blockfile` comment over here. I also do think the old names `last_blockfile` and `undo_height_in_last_blockfile` are more descriptive than the new names `file_num` and `undo_height`, but I guess there was some reasoning for changing them, so not sure about that.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T00:27:40Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.\n+    NORMAL,\n+    ASSUMED,\n+};\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type);\n+\n+struct BlockfileCursor {\n+    // The latest blockfile number.\n+    int file_num{0};\n+\n+    // Track the largest height block whose undo data is in `file_num` blockfile.\n+    // When we move to the next blockfile, if the undo data is keeping up then\n+    // we know we can trim the size of the file and truncate any excess\n+    // allocations. If not, we assume that eventually we'll add more undo data\n+    // to this file, and when we revisit it we'll trim it then.\n+    int undo_height{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310971801",
      "id" : 1310971801,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OI9eZ",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 96,
      "original_position" : 30,
      "original_start_line" : 87,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310971801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310971801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310979704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310979704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nI think it would make sense to move this comment to the `BlockfileTypeForRole` function. The comment seems out of context here since the enum isn't used yet here and the purpose isn't described until the `m_blockfile_cursors` comment 100 lines below.\r\n\r\n",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T00:46:53Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310979704",
      "id" : 1310979704,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585OI_Z4",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 75,
      "original_position" : 14,
      "original_start_line" : 75,
      "path" : "src/node/blockstorage.h",
      "position" : 14,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310979704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 74,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310979704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310985324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310985324"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nThis seems like it is going to create log spam if it is printing an intermediate cursor value for each block file on disk. I think it would make more sense just to print two final NORMAL and ASSUMED last file numbers after the loop, than all the intermediate last file numbers during the loop.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T01:00:23Z",
      "diff_hunk" : "@@ -377,6 +380,42 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    std::optional<unsigned int> snapshot_base_height{std::nullopt};\n+    if (snapshot_blockhash) {\n+        const auto au_data = GetParams().AssumeutxoForBlockhash(*snapshot_blockhash);\n+        snapshot_base_height = Assert(au_data)->height;\n+    }\n+\n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto& fileinfo = m_blockfile_info[i];\n+            BlockfileType blockfile_type{BlockfileType::NORMAL};\n+\n+            // If we have a snapshot and the last height tracked by this blockfile\n+            // is in the chain region above the snapshot, updated the ASSUMED cursor.\n+            if (snapshot_base_height && fileinfo.nHeightLast > *snapshot_base_height) {\n+                blockfile_type = BlockfileType::ASSUMED;\n+            }\n+            m_blockfile_cursors[blockfile_type] = {static_cast<int>(i), 0};\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Set blockfile cursor %s to %i\\n\",\n+                blockfile_type, *m_blockfile_cursors[blockfile_type]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310985324",
      "id" : 1310985324,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OJAxs",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 403,
      "original_position" : 84,
      "original_start_line" : 402,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310985324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310985324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310990937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310990937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nI was confused by this at first about why it was not an error for the cursor to be null here. Would be helpful to add comment saying it is safe to skip flushing if the cursor does not exist, because this only happens when a new snapshot has been loaded and and no blocks have been downloaded or written yet.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T01:09:59Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(ChainstateRole chainstate_role, bool finalize, bool finalize_undo)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForRole(chainstate_role)];\n+    if (cursor) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310990937",
      "id" : 1310990937,
      "line" : 625,
      "node_id" : "PRRC_kwDOABII585OJCJZ",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 625,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 267,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310990937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310990937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310992182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310992182"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nIt seems pointless and little wasteful to create this cursor and increment the max block number before any blocl data is downloaded. Wouldn't it be simpler to just delete this code and let the code in BlockManager::FindBlockPos create the cursor when there is actually data ready to be written?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T01:13:02Z",
      "diff_hunk" : "@@ -377,6 +380,42 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    std::optional<unsigned int> snapshot_base_height{std::nullopt};\n+    if (snapshot_blockhash) {\n+        const auto au_data = GetParams().AssumeutxoForBlockhash(*snapshot_blockhash);\n+        snapshot_base_height = Assert(au_data)->height;\n+    }\n+\n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto& fileinfo = m_blockfile_info[i];\n+            BlockfileType blockfile_type{BlockfileType::NORMAL};\n+\n+            // If we have a snapshot and the last height tracked by this blockfile\n+            // is in the chain region above the snapshot, updated the ASSUMED cursor.\n+            if (snapshot_base_height && fileinfo.nHeightLast > *snapshot_base_height) {\n+                blockfile_type = BlockfileType::ASSUMED;\n+            }\n+            m_blockfile_cursors[blockfile_type] = {static_cast<int>(i), 0};\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Set blockfile cursor %s to %i\\n\",\n+                blockfile_type, *m_blockfile_cursors[blockfile_type]);\n+        }\n+\n+        // If we haven't yet seen an ASSUMED blockfile, plan to use the one past the\n+        // last NORMAL blockfile.\n+        if (snapshot_blockhash && !m_blockfile_cursors[BlockfileType::ASSUMED]) {\n+            const auto newcursor = BlockfileCursor{this->MaxBlockfileNum() + 1, 0};\n+            m_blockfile_cursors[BlockfileType::ASSUMED] = newcursor;\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Initialized empty assumed blockfile cursor to %i\\n\", newcursor);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310992182",
      "id" : 1310992182,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OJCc2",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 392,
      "original_position" : 93,
      "original_start_line" : 406,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310992182/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310992182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310998317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310998317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nnFile was already unsigned previously, but I think it's a small regression to change last_blockfile variable from unsigned to signed and have this implicit cast. I think ideally all these numbers would just be signed and it would be better to move in that direction instead of the other way.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T01:27:07Z",
      "diff_hunk" : "@@ -644,11 +699,22 @@ fs::path BlockManager::GetBlockPosFilename(const FlatFilePos& pos) const\n     return BlockFileSeq().FileName(pos);\n }\n \n-bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, uint64_t nTime, bool fKnown)\n+bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, ChainstateRole chainstate_role, uint64_t nTime, bool fKnown)\n {\n     LOCK(cs_LastBlockFile);\n \n-    unsigned int nFile = fKnown ? pos.nFile : m_last_blockfile;\n+    const BlockfileType chain_type = BlockfileTypeForRole(chainstate_role);\n+\n+    if (!m_blockfile_cursors[chain_type]) {\n+        // If a snapshot is loaded during runtime, we may not have initialized this cursor yet.\n+        assert(chain_type == BlockfileType::ASSUMED);\n+        const auto new_cursor = BlockfileCursor{this->MaxBlockfileNum() + 1, 0};\n+        m_blockfile_cursors[chain_type] = new_cursor;\n+        LogPrint(BCLog::BLOCKSTORAGE, \"[%s] initializing blockfile cursor to %s\\n\", chainstate_role, new_cursor);\n+    }\n+    const unsigned int last_blockfile = m_blockfile_cursors[chain_type]->file_num;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310998317",
      "id" : 1310998317,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OJD8t",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 715,
      "original_position" : 180,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310998317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1310998317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311007889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311007889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (1c668b690eeb4b98899be7e0ff33373b79932f2a)\r\n\r\nThis seems like like as soon as the snapshot is validated, the new blocks from the snapshot chainstate will start being added to the last background block file, preventing that file from being pruned potentially for a long time.\r\n\r\nThis really makes me think it is a mistake expose `ChainstateRole` to all these individual `BlockManager` methods and try to use it as a heuristic for selecting the cursor. I think a better approach that would keep block files more tidy and simplify the BlockManager API would be to give BlockManager an `int  m_snapshot_base_height` variable that could be initialized in `BlockManager::LoadBlockIndexDB` and used internally to derive the `BlockfileType` value without requiring ChainstateRole chainstate_role parameters to be passed around everywhere. This would also simplify the validation code, avoiding the need to change `ChainstateManager::AcceptBlock`.\r\n\r\nI think the new BlockManager::FlushChainstateBlockFile method would still need to be added, but the rest of the BlockManager API changes could be reverted, and FlushChainstateBlockFile could take a chain tip height instead of a ChainstateRole, so the same cursor select code could be used everywhere.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T01:50:13Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311007889",
      "id" : 1311007889,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OJGSR",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 640,
      "original_position" : 148,
      "original_start_line" : 639,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1602900172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311007889/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T02:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311007889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311331956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311331956"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7b93d4adc976bdb32306951b21d7c98d9dacc972\r\n\r\nCould use an assert this can't underflow",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T09:08:00Z",
      "diff_hunk" : "@@ -5831,6 +5898,13 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n             FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+                TryDownloadingHistoricalBlocks(\n+                    *peer,\n+                    MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311331956",
      "id" : 1311331956,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OKVZ0",
      "original_commit_id" : "7b93d4adc976bdb32306951b21d7c98d9dacc972",
      "original_line" : 5904,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1604300972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311331956/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T09:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311331956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311353331"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311353331"
         }
      },
      "author_association" : "MEMBER",
      "body" : "288dd732b5c0085618598fe3dbba23ac6d194173\r\n\r\nI wish the chainstate state machine was briefly mentioned here, or referenced where it's defined.\r\nA reviewer needs a way to understand why it's impossible to have 2+ chainstates, one of them being NORMAL (and others being something).",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T09:25:03Z",
      "diff_hunk" : "@@ -5737,6 +5737,16 @@ bool ChainstateManager::DeleteSnapshotChainstate()\n     return true;\n }\n \n+ChainstateRole Chainstate::GetRole() const\n+{\n+    if (m_chainman.GetAll().size() <= 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311353331",
      "id" : 1311353331,
      "line" : 5767,
      "node_id" : "PRRC_kwDOABII585OKanz",
      "original_commit_id" : "288dd732b5c0085618598fe3dbba23ac6d194173",
      "original_line" : 5767,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 287,
      "pull_request_review_id" : 1604300972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311353331/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T09:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311353331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311360137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311360137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d3b533d3f1e80addca2ab0b3ee97215d5d03d984\r\n\r\ncould add an assert for the invariant: can't be BACKGROUND role.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T09:30:05Z",
      "diff_hunk" : "@@ -1961,7 +1965,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311360137",
      "id" : 1311360137,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OKcSJ",
      "original_commit_id" : "d3b533d3f1e80addca2ab0b3ee97215d5d03d984",
      "original_line" : 1968,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1604300972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311360137/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T09:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311360137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311369580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311369580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is done later in fbd05a9eed1e40be0c4915e2aef98b3771d7af6c, although in a `return` way for some reason?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T09:37:54Z",
      "diff_hunk" : "@@ -1961,7 +1965,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311369580",
      "id" : 1311369580,
      "in_reply_to_id" : 1311360137,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OKels",
      "original_commit_id" : "d3b533d3f1e80addca2ab0b3ee97215d5d03d984",
      "original_line" : 1968,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1604300972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311369580/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T09:53:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311369580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311371973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311371973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fbd05a9eed1e40be0c4915e2aef98b3771d7af6c\r\n\r\nI see why we don't care about mempool stuff here, but `m_block_stalling_timeout` I'm not so sure. Is this logic completely irrelevant for background sync?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T09:39:53Z",
      "diff_hunk" : "@@ -1916,9 +1916,15 @@ void PeerManagerImpl::BlockConnected(\n     const std::shared_ptr<const CBlock>& pblock,\n     const CBlockIndex* pindex)\n {\n-    m_orphanage.EraseForBlock(*pblock);\n+    // Update this for all chainstate roles so that we don't mistakenly see peers\n+    // helping us do background IBD as having a stale tip.\n     m_last_tip_update = GetTime<std::chrono::seconds>();\n \n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311371973",
      "id" : 1311371973,
      "line" : 1933,
      "node_id" : "PRRC_kwDOABII585OKfLF",
      "original_commit_id" : "fbd05a9eed1e40be0c4915e2aef98b3771d7af6c",
      "original_line" : 1933,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1604300972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311371973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T09:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311371973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311525906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311525906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"bugfix: correct is_snapshot_cs in VerifyDB\" (b85530c18bfe24ff434f32f959d8dd843afca54d)\r\n\r\nWould it make sense to put this fix or other fixes into a backport PR? If this PR were merged and released with Bitcoin Core 26, would it be possible for someone to load an assumeutxo snapshot with Bitcoin Core 26, then downgrade to Bitcoin Core 25 or 24 and run into bugs processing the snapshot chainstate?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T12:03:21Z",
      "diff_hunk" : "@@ -4204,7 +4204,7 @@ VerifyDBResult CVerifyDB::VerifyDB(\n     bool skipped_l3_checks{false};\n     LogPrintf(\"Verification progress: 0%%\\n\");\n \n-    const bool is_snapshot_cs{!chainstate.m_from_snapshot_blockhash};\n+    const bool is_snapshot_cs{chainstate.m_from_snapshot_blockhash};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311525906",
      "id" : 1311525906,
      "line" : 4236,
      "node_id" : "PRRC_kwDOABII585OLEwS",
      "original_commit_id" : "b85530c18bfe24ff434f32f959d8dd843afca54d",
      "original_line" : 4236,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 1604598585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311525906/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T12:28:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311525906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311642246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311642246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, looks so to me. Although `MIN_BLOCKS_TO_KEEP` is 288, so probably this would never be able to happen because of how quickly that part of the chain connects.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:34:08Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311642246",
      "id" : 1311642246,
      "in_reply_to_id" : 1310410195,
      "line" : 157,
      "node_id" : "PRRC_kwDOABII585OLhKG",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 157,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 28,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311642246/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311642246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311643402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311643402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:35:00Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    int height = chain.m_chain.Height();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311643402",
      "id" : 1311643402,
      "in_reply_to_id" : 1310432926,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLhcK",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 189,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311643402/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311643402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311645346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311645346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, good point. Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:36:28Z",
      "diff_hunk" : "@@ -144,40 +144,58 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    int height = chain.m_chain.Height();\n+    if (height < 0 || target == 0) {\n         return;\n     }\n-    if ((uint64_t)chain_tip_height <= nPruneAfterHeight) {\n+    if ((uint64_t)height <= nPruneAfterHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311645346",
      "id" : 1311645346,
      "in_reply_to_id" : 1310423116,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLh6i",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 193,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311645346/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311645346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311646878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311646878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.\r\n",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:37:39Z",
      "diff_hunk" : "@@ -5864,3 +5871,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);\n+\n+    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311646878",
      "id" : 1311646878,
      "in_reply_to_id" : 1310404663,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLiSe",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 5890,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311646878/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311646878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311647326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311647326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:37:57Z",
      "diff_hunk" : "@@ -5864,3 +5871,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);\n+\n+    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n+    //\n+    // While you might be tempted to prune the background chainstate more\n+    // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index\n+    // building - specifically blockfilterindex requires undo data, and if\n+    // we don't maintain this trailing window, we hit indexation failures.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311647326",
      "id" : 1311647326,
      "in_reply_to_id" : 1310435694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLiZe",
      "original_commit_id" : "5e4c824433fb4bf8b380d0f61a0aa424dc5456d4",
      "original_line" : 5895,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311647326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311647326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311651383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:40:43Z",
      "diff_hunk" : "@@ -76,16 +71,21 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     Chainstate& c2 = WITH_LOCK(::cs_main, return manager.ActivateExistingSnapshot(\n         &mempool, snapshot_blockhash));\n     chainstates.push_back(&c2);\n-\n-    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n-\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    WITH_LOCK(::cs_main, c2.InitCoinsCache(1 << 23));\n-    c2.m_chain.SetTip(*active_tip);\n+    {\n+        LOCK(::cs_main);\n+        c2.InitCoinsCache(1 << 23);\n+        c2.m_chain.SetTip(*active_tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311651383",
      "id" : 1311651383,
      "in_reply_to_id" : 1310877098,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLjY3",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 79,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311651919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:41:08Z",
      "diff_hunk" : "@@ -76,16 +71,21 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     Chainstate& c2 = WITH_LOCK(::cs_main, return manager.ActivateExistingSnapshot(\n         &mempool, snapshot_blockhash));\n     chainstates.push_back(&c2);\n-\n-    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n-\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    WITH_LOCK(::cs_main, c2.InitCoinsCache(1 << 23));\n-    c2.m_chain.SetTip(*active_tip);\n+    {\n+        LOCK(::cs_main);\n+        c2.InitCoinsCache(1 << 23);\n+        c2.m_chain.SetTip(*active_tip);\n+        c2.CoinsTip().SetBestBlock(active_tip->GetBlockHash());\n+        c2.setBlockIndexCandidates.insert(manager.m_blockman.LookupBlockIndex(active_tip->GetBlockHash()));\n+        c2.LoadChainTip();\n+    }\n     BlockValidationState _;\n     BOOST_CHECK(c2.ActivateBestChain(_, nullptr));\n \n+    BOOST_CHECK_EQUAL(manager.SnapshotBlockhash().value(), snapshot_blockhash);\n+    BOOST_CHECK(c2.ActivateBestChain(_));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311651919",
      "id" : 1311651919,
      "in_reply_to_id" : 1310871911,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLjhP",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 88,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651919/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311651919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311653393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311653393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Makes sense, done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:42:15Z",
      "diff_hunk" : "@@ -96,14 +96,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto& active_chain2 = WITH_LOCK(manager.GetMutex(), return manager.ActiveChain());\n     BOOST_CHECK_EQUAL(&active_chain2, &c2.m_chain);\n \n-    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 0);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 110);\n+    mineBlocks(1);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return manager.ActiveHeight()), 111);\n+    BOOST_CHECK_EQUAL(WITH_LOCK(manager.GetMutex(), return c1.m_chain.Height()), 110);\n \n     auto active_tip2 = WITH_LOCK(manager.GetMutex(), return manager.ActiveTip());\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    BOOST_CHECK_EQUAL(exp_tip, exp_tip2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311653393",
      "id" : 1311653393,
      "in_reply_to_id" : 1310888128,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585OLj4R",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 105,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 82,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311653393/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311653393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311661327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311661327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch. I think I was grasping at straws trying to get the tests to pass having changed heights to match up with the recognized chainparams snapshots. Not sure what I was thinking.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T13:47:56Z",
      "diff_hunk" : "@@ -488,13 +490,13 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n-        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_tip->phashBlock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311661327",
      "id" : 1311661327,
      "in_reply_to_id" : 1310901739,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLl0P",
      "original_commit_id" : "76d616c957522e7be52eaf10b3ac33accaf75c45",
      "original_line" : 493,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311661327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311661327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311698766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311698766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh wow, that's a great simplification - thanks. Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T14:10:49Z",
      "diff_hunk" : "@@ -290,7 +290,13 @@ bool BlockManager::LoadBlockIndex()\n         // Pruned nodes may have deleted the block.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->nChainTx > 0) {\n+                if (snapshot_blockhash && pindex->GetBlockHash() == *snapshot_blockhash) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311698766",
      "id" : 1311698766,
      "in_reply_to_id" : 1310947552,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OLu9O",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 293,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311698766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311698766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311708335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311708335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Getting test failures with this change, not certain why:\r\n```\r\n10:17:24 james@fido src/bitcoin (?Â± 11555828ee 1155582) % ./src/test/test_bitcoin\r\nRunning 578 test cases...\r\ntest_bitcoin: validation.cpp:4767: void ChainstateManager::CheckBlockIndex(): Assertion `pindex->nChainTx == pindex->nTx + pindex->pprev->nChainTx' failed.\r\nunknown location(0): fatal error: in \"validation_block_tests/processnewblock_signals_ordering\": signal: SIGABRT (application abort requested)\r\ntest/validation_block_tests.cpp(160): last checkpoint\r\nunknown location(0): fatal error: in \"validation_block_tests/mempool_locks_reorg\": memory access violation at address: 0x5824eadac8d1: no mapping at fault address\r\ntest/validation_block_tests.cpp(224): last checkpoint: \"mempool_locks_reorg\" fixture ctor\r\n\r\n*** 2 failures are detected in the test module \"Bitcoin Core Test Suite\"\r\ntest_bitcoin: checkqueue.h:198: CCheckQueue<CScriptCheck>::~CCheckQueue() [T = CScriptCheck]: Assertion `m_worker_threads.empty()' failed.\r\nzsh: IOT instruction (core dumped)  ./src/test/test_bitcoin\r\n./src/test/test_bitcoin  18.78s user 2.94s system 118% cpu 18.291 total\r\n```\r\n\r\nMaybe worth doing this improvement as a follow-up.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T14:17:38Z",
      "diff_hunk" : "@@ -4765,6 +4765,10 @@ void ChainstateManager::CheckBlockIndex()\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindex->pprev && pindex->nTx > 0) {\n+            // nChainTx should increase monotonically\n+            assert(pindex->pprev->nChainTx <= pindex->nChainTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311708335",
      "id" : 1311708335,
      "in_reply_to_id" : 1310950827,
      "line" : 4766,
      "node_id" : "PRRC_kwDOABII585OLxSv",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 4766,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 165,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311708335/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311708335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311755065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311755065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T14:50:31Z",
      "diff_hunk" : "@@ -377,6 +380,42 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    std::optional<unsigned int> snapshot_base_height{std::nullopt};\n+    if (snapshot_blockhash) {\n+        const auto au_data = GetParams().AssumeutxoForBlockhash(*snapshot_blockhash);\n+        snapshot_base_height = Assert(au_data)->height;\n+    }\n+\n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto& fileinfo = m_blockfile_info[i];\n+            BlockfileType blockfile_type{BlockfileType::NORMAL};\n+\n+            // If we have a snapshot and the last height tracked by this blockfile\n+            // is in the chain region above the snapshot, updated the ASSUMED cursor.\n+            if (snapshot_base_height && fileinfo.nHeightLast > *snapshot_base_height) {\n+                blockfile_type = BlockfileType::ASSUMED;\n+            }\n+            m_blockfile_cursors[blockfile_type] = {static_cast<int>(i), 0};\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Set blockfile cursor %s to %i\\n\",\n+                blockfile_type, *m_blockfile_cursors[blockfile_type]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311755065",
      "id" : 1311755065,
      "in_reply_to_id" : 1310985324,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OL8s5",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 403,
      "original_position" : 84,
      "original_start_line" : 402,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311755065/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311755065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311785924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311785924"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hey thanks for this feedback, this has led to a big simplification in this commit. I had tried to do something like this earlier, but got hung up on the \"snapshot activated during runtime\" case. I forgot that ChainstateManager can just reach into the BlockManager and set the snapshot height dynamically.\r\n\r\nSo that's what I'm doing here, without trying to adapt ChainstateRole to BlockManager behavior. The result is a lot simpler and - as you point out - less buggy!",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T15:10:29Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311785924",
      "id" : 1311785924,
      "in_reply_to_id" : 1311007889,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OMEPE",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 640,
      "original_position" : 148,
      "original_start_line" : 639,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311785924/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311785924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311789064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311789064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, added.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T15:12:16Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(ChainstateRole chainstate_role, bool finalize, bool finalize_undo)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForRole(chainstate_role)];\n+    if (cursor) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311789064",
      "id" : 1311789064,
      "in_reply_to_id" : 1310990937,
      "line" : 625,
      "node_id" : "PRRC_kwDOABII585OMFAI",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 625,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 267,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311789064/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311789064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311984213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311984213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay, sounds good.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T17:43:32Z",
      "diff_hunk" : "@@ -644,11 +699,22 @@ fs::path BlockManager::GetBlockPosFilename(const FlatFilePos& pos) const\n     return BlockFileSeq().FileName(pos);\n }\n \n-bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, uint64_t nTime, bool fKnown)\n+bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, ChainstateRole chainstate_role, uint64_t nTime, bool fKnown)\n {\n     LOCK(cs_LastBlockFile);\n \n-    unsigned int nFile = fKnown ? pos.nFile : m_last_blockfile;\n+    const BlockfileType chain_type = BlockfileTypeForRole(chainstate_role);\n+\n+    if (!m_blockfile_cursors[chain_type]) {\n+        // If a snapshot is loaded during runtime, we may not have initialized this cursor yet.\n+        assert(chain_type == BlockfileType::ASSUMED);\n+        const auto new_cursor = BlockfileCursor{this->MaxBlockfileNum() + 1, 0};\n+        m_blockfile_cursors[chain_type] = new_cursor;\n+        LogPrint(BCLog::BLOCKSTORAGE, \"[%s] initializing blockfile cursor to %s\\n\", chainstate_role, new_cursor);\n+    }\n+    const unsigned int last_blockfile = m_blockfile_cursors[chain_type]->file_num;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311984213",
      "id" : 1311984213,
      "in_reply_to_id" : 1310998317,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OM0pV",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 715,
      "original_position" : 180,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311984213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311984213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311986681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311986681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, done.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T17:45:40Z",
      "diff_hunk" : "@@ -680,13 +753,14 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n         pos.nPos = m_blockfile_info[nFile].nSize;\n     }\n \n-    if ((int)nFile != m_last_blockfile) {\n+    if (nFile != last_blockfile) {\n         if (!fKnown) {\n-            LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s (onto %i) (height %i)\\n\",\n+                m_last_blockfile, m_blockfile_info[last_blockfile].ToString(), nFile, nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311986681",
      "id" : 1311986681,
      "in_reply_to_id" : 1310965708,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OM1P5",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 759,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311986681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311986681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311988064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311988064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've just removed the comment because I don't think it adds much anymore.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T17:46:33Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311988064",
      "id" : 1311988064,
      "in_reply_to_id" : 1310979704,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585OM1lg",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 75,
      "original_position" : 14,
      "original_start_line" : 75,
      "path" : "src/node/blockstorage.h",
      "position" : 14,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311988064/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 74,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311988064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311990281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311990281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, silent merge conflict. Fixed.\r\n\r\n`m_last_blockfile` just didn't make much sense to me when you're already in the context of a blockfile cursor; within that scope, `file_num` felt like it was a complete description. Same rationale for the other.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T17:47:53Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.\n+    NORMAL,\n+    ASSUMED,\n+};\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type);\n+\n+struct BlockfileCursor {\n+    // The latest blockfile number.\n+    int file_num{0};\n+\n+    // Track the largest height block whose undo data is in `file_num` blockfile.\n+    // When we move to the next blockfile, if the undo data is keeping up then\n+    // we know we can trim the size of the file and truncate any excess\n+    // allocations. If not, we assume that eventually we'll add more undo data\n+    // to this file, and when we revisit it we'll trim it then.\n+    int undo_height{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311990281",
      "id" : 1311990281,
      "in_reply_to_id" : 1310971801,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OM2IJ",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 96,
      "original_position" : 30,
      "original_start_line" : 87,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311990281/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1311990281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312004094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312004094"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: assumeutxo: swap m_mempool on snapshot activation\" (f2dd7a0c1b67d3e4a6e086a619eff34fe6625263)\r\n\r\nCan this code assert that the mempool is empty, or clear it, or else explain why contents of the mempool transactions are compatible with m_snapshot_chainstate?\r\n\r\nIt would also be good to assert existing m_snapshot_chainstate pointer is not set, and make the `ActivateSnapshot` and `ActivateExistingSnapshot` versions of this code the same.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T17:59:11Z",
      "diff_hunk" : "@@ -5205,6 +5205,9 @@ bool ChainstateManager::ActivateSnapshot(\n         const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n         assert(chaintip_loaded);\n \n+        // Transfer possession of the mempool to the snapshot chianstate.\n+        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312004094",
      "id" : 1312004094,
      "line" : 5195,
      "node_id" : "PRRC_kwDOABII585OM5f-",
      "original_commit_id" : "f2dd7a0c1b67d3e4a6e086a619eff34fe6625263",
      "original_line" : 5195,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 196,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312004094/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312004094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312011711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312011711"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, now avoiding underflow with cast + max.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:06:58Z",
      "diff_hunk" : "@@ -5831,6 +5898,13 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n             FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+                TryDownloadingHistoricalBlocks(\n+                    *peer,\n+                    MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312011711",
      "id" : 1312011711,
      "in_reply_to_id" : 1311331956,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OM7W_",
      "original_commit_id" : "7b93d4adc976bdb32306951b21d7c98d9dacc972",
      "original_line" : 5904,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312011711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312011711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312013386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312013386"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a pointer to the ChainstateManager documentation this.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:08:39Z",
      "diff_hunk" : "@@ -5737,6 +5737,16 @@ bool ChainstateManager::DeleteSnapshotChainstate()\n     return true;\n }\n \n+ChainstateRole Chainstate::GetRole() const\n+{\n+    if (m_chainman.GetAll().size() <= 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312013386",
      "id" : 1312013386,
      "in_reply_to_id" : 1311353331,
      "line" : 5767,
      "node_id" : "PRRC_kwDOABII585OM7xK",
      "original_commit_id" : "288dd732b5c0085618598fe3dbba23ac6d194173",
      "original_line" : 5767,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 287,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312013386/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312013386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312025166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312025166"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (82a8744f1384f07dc30aaa6339b0b8fb32dc3af0)\r\n\r\nWould be good to simplify and remove gArgs reference:\r\n\r\n```diff\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -2718,10 +2718,8 @@ static RPCHelpMan loadtxoutset()\r\n         },\r\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\r\n {\r\n-    fs::path path = fs::PathFromString(request.params[0].get_str());\r\n-    if (path.is_relative()) {\r\n-        path = gArgs.GetDataDirNet() / path;\r\n-    }\r\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\r\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\r\n     FILE* file{fsbridge::fopen(path, \"rb\")};\r\n     CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\r\n     if (afile.IsNull()) {\r\n@@ -2739,7 +2737,6 @@ static RPCHelpMan loadtxoutset()\r\n     LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\r\n         base_blockhash.ToString());\r\n \r\n-    NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     ChainstateManager& chainman = *node.chainman;\r\n \r\n     while (max_secs_to_wait_for_headers > 0) {\r\n\r\n```",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:13:20Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312025166",
      "id" : 1312025166,
      "line" : 2723,
      "node_id" : "PRRC_kwDOABII585OM-pO",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2723,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 25,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312025166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312025166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312027712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312027712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Unclear if clients only want to know about NewPoWValidBlocks for background chainstate, but since the only usage is ignored (`PeerManagerImpl`) I'll just remove the role parameter and avoiding sending the notification from non-active chainstates.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:14:00Z",
      "diff_hunk" : "@@ -1961,7 +1965,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312027712",
      "id" : 1312027712,
      "in_reply_to_id" : 1311360137,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OM_RA",
      "original_commit_id" : "d3b533d3f1e80addca2ab0b3ee97215d5d03d984",
      "original_line" : 1968,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312027712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312027712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312036195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312036195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (82a8744f1384f07dc30aaa6339b0b8fb32dc3af0)\r\n\r\nShould probably remove this if testing code which isn't assuming cs_main is locked.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:18:13Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        {\n+            LOCK(cs_main);\n+            snapshot_start_block = chainman.m_blockman.LookupBlockIndex(base_blockhash);\n+        }\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (snapshot_start_block == nullptr) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+\n+    // TODO jamesob: no real need to lock cs_main here, but during testing it makes it\n+    // easier to follow the logs. We may want to remove this before merge.\n+    //\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312036195",
      "id" : 1312036195,
      "line" : 2770,
      "node_id" : "PRRC_kwDOABII585ONBVj",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2770,
      "original_position" : 72,
      "original_start_line" : 2767,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 72,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312036195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2767,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312036195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312037894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312037894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (82a8744f1384f07dc30aaa6339b0b8fb32dc3af0)\r\n\r\nMissing result description",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:19:59Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312037894",
      "id" : 1312037894,
      "line" : 2715,
      "node_id" : "PRRC_kwDOABII585ONBwG",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2715,
      "original_position" : 17,
      "original_start_line" : 2713,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 17,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312037894/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2713,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312037894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312038932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312038932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (82a8744f1384f07dc30aaa6339b0b8fb32dc3af0)\r\n\r\nShould dumptxoutset and loadtxoutset still be hidden?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:21:07Z",
      "diff_hunk" : "@@ -2729,6 +2814,7 @@ void RegisterBlockchainRPCCommands(CRPCTable& t)\n         {\"hidden\", &waitforblockheight},\n         {\"hidden\", &syncwithvalidationinterfacequeue},\n         {\"hidden\", &dumptxoutset},\n+        {\"hidden\", &loadtxoutset},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312038932",
      "id" : 1312038932,
      "line" : 2880,
      "node_id" : "PRRC_kwDOABII585ONCAU",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2880,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 159,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312038932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312038932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312040274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312040274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (555206238129c6ed9fcbbc498c81455c7fe6d851)\r\n\r\nMissing documentation for return value",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:22:28Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312040274",
      "id" : 1312040274,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585ONCVS",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2794,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 96,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312040274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312040274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312045678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312045678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (555206238129c6ed9fcbbc498c81455c7fe6d851)\r\n\r\nProbably would be a little better to make this null instead of \"\" if unset",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:27:14Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312045678",
      "id" : 1312045678,
      "line" : 2821,
      "node_id" : "PRRC_kwDOABII585ONDpu",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2821,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 123,
      "pull_request_review_id" : 1605373711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312045678/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312045678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312046441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312046441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! The `m_block_stalling_timeout` was added about a year ago, so when preparing these changes I didn't consider it. It looks like we should keep it up to date for both chainstates. Fixed.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:28:03Z",
      "diff_hunk" : "@@ -1916,9 +1916,15 @@ void PeerManagerImpl::BlockConnected(\n     const std::shared_ptr<const CBlock>& pblock,\n     const CBlockIndex* pindex)\n {\n-    m_orphanage.EraseForBlock(*pblock);\n+    // Update this for all chainstate roles so that we don't mistakenly see peers\n+    // helping us do background IBD as having a stale tip.\n     m_last_tip_update = GetTime<std::chrono::seconds>();\n \n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312046441",
      "id" : 1312046441,
      "in_reply_to_id" : 1311371973,
      "line" : 1933,
      "node_id" : "PRRC_kwDOABII585OND1p",
      "original_commit_id" : "fbd05a9eed1e40be0c4915e2aef98b3771d7af6c",
      "original_line" : 1933,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312046441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312046441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312047335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312047335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My inclination is to say that if the user begins snapshot use with a client that has this changeset, they won't be able to downgrade without issue until the snapshot is validated (based on e.g. the net_processing changes here). I'm not sure where the best place to convey that would be... release notes?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T18:29:07Z",
      "diff_hunk" : "@@ -4204,7 +4204,7 @@ VerifyDBResult CVerifyDB::VerifyDB(\n     bool skipped_l3_checks{false};\n     LogPrintf(\"Verification progress: 0%%\\n\");\n \n-    const bool is_snapshot_cs{!chainstate.m_from_snapshot_blockhash};\n+    const bool is_snapshot_cs{chainstate.m_from_snapshot_blockhash};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312047335",
      "id" : 1312047335,
      "in_reply_to_id" : 1311525906,
      "line" : 4236,
      "node_id" : "PRRC_kwDOABII585ONEDn",
      "original_commit_id" : "b85530c18bfe24ff434f32f959d8dd843afca54d",
      "original_line" : 4236,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 1604775714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312047335/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T18:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312047335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312095629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312095629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It would also be good to assert existing m_snapshot_chainstate pointer is not set, and make the ActivateSnapshot and ActivateExistingSnapshot versions of this code the same.\r\n\r\nThat assertion happens here: https://github.com/bitcoin/bitcoin/blob/1b1d7110e67da11752ae1efadb1c12a9054eb867/src/validation.cpp#L5189\r\n\r\nEdit: oh oops, you're probably talking about `m_snapshot_chainstate->m_mempool`, which isn't checked.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T19:10:01Z",
      "diff_hunk" : "@@ -5205,6 +5205,9 @@ bool ChainstateManager::ActivateSnapshot(\n         const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n         assert(chaintip_loaded);\n \n+        // Transfer possession of the mempool to the snapshot chianstate.\n+        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312095629",
      "id" : 1312095629,
      "in_reply_to_id" : 1312004094,
      "line" : 5195,
      "node_id" : "PRRC_kwDOABII585ONP2N",
      "original_commit_id" : "f2dd7a0c1b67d3e4a6e086a619eff34fe6625263",
      "original_line" : 5195,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 196,
      "pull_request_review_id" : 1605519579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312095629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T19:39:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312095629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312115645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312115645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T19:16:48Z",
      "diff_hunk" : "@@ -377,6 +380,42 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    std::optional<unsigned int> snapshot_base_height{std::nullopt};\n+    if (snapshot_blockhash) {\n+        const auto au_data = GetParams().AssumeutxoForBlockhash(*snapshot_blockhash);\n+        snapshot_base_height = Assert(au_data)->height;\n+    }\n+\n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto& fileinfo = m_blockfile_info[i];\n+            BlockfileType blockfile_type{BlockfileType::NORMAL};\n+\n+            // If we have a snapshot and the last height tracked by this blockfile\n+            // is in the chain region above the snapshot, updated the ASSUMED cursor.\n+            if (snapshot_base_height && fileinfo.nHeightLast > *snapshot_base_height) {\n+                blockfile_type = BlockfileType::ASSUMED;\n+            }\n+            m_blockfile_cursors[blockfile_type] = {static_cast<int>(i), 0};\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Set blockfile cursor %s to %i\\n\",\n+                blockfile_type, *m_blockfile_cursors[blockfile_type]);\n+        }\n+\n+        // If we haven't yet seen an ASSUMED blockfile, plan to use the one past the\n+        // last NORMAL blockfile.\n+        if (snapshot_blockhash && !m_blockfile_cursors[BlockfileType::ASSUMED]) {\n+            const auto newcursor = BlockfileCursor{this->MaxBlockfileNum() + 1, 0};\n+            m_blockfile_cursors[BlockfileType::ASSUMED] = newcursor;\n+            LogPrint(BCLog::BLOCKSTORAGE, \"Initialized empty assumed blockfile cursor to %i\\n\", newcursor);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312115645",
      "id" : 1312115645,
      "in_reply_to_id" : 1310992182,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ONUu9",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 392,
      "original_position" : 93,
      "original_start_line" : 406,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1605548247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312115645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-31T19:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312115645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312293323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312293323"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312047335\r\n\r\n> My inclination is to say that if the user begins snapshot use with a client that has this changeset, they won't be able to downgrade without issue until the snapshot is validated (based on e.g. the net_processing changes here). I'm not sure where the best place to convey that would be... release notes?\r\n\r\nI think the most helpful place would be the `loadtxoutset` RPC documentation, saying that using the  `loadtxoutset`  RPC will make it temporarily not possible to downgrade the node software until the snapshot is validated, and then after that it will be safe to downgrade again.\r\n\r\nI wonder if we can do something simple to avoid this problem, though, like tweaking the snapshot chainstate directory name before releasing, so old software ignores it, or backporting a patch to the stable branches that  makes them ignore the directory.\r\n\r\n",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-08-31T21:18:08Z",
      "diff_hunk" : "@@ -4204,7 +4204,7 @@ VerifyDBResult CVerifyDB::VerifyDB(\n     bool skipped_l3_checks{false};\n     LogPrintf(\"Verification progress: 0%%\\n\");\n \n-    const bool is_snapshot_cs{!chainstate.m_from_snapshot_blockhash};\n+    const bool is_snapshot_cs{chainstate.m_from_snapshot_blockhash};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312293323",
      "id" : 1312293323,
      "in_reply_to_id" : 1311525906,
      "line" : 4236,
      "node_id" : "PRRC_kwDOABII585OOAHL",
      "original_commit_id" : "b85530c18bfe24ff434f32f959d8dd843afca54d",
      "original_line" : 4236,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 1605787687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312293323/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-31T21:18:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1312293323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314295003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314295003"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (51622e9c1f7ed16f65844817a4a5e9bcbc157b4f)\r\n\r\nThis line gives a compilation warning. Checking if a `uint64_t` is negative is always false, and the `static_cast<uint64_t>` is also a possible underflow error if `chain.m_chain.Height() == -1`.\r\n\r\nPerhaps check if `chain.m_chain.Height() < 0` first and then assign to `chain_tip_height` after this line?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-09-03T17:51:21Z",
      "diff_hunk" : "@@ -144,40 +144,57 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    auto chain_tip_height = static_cast<uint64_t>(chain.m_chain.Height());\n+    if (chain_tip_height < 0 || target == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314295003",
      "id" : 1314295003,
      "line" : 190,
      "node_id" : "PRRC_kwDOABII585OVozb",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 189,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 63,
      "pull_request_review_id" : 1608559074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314295003/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-03T17:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314295003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314610529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314610529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f\r\n\r\nIt might be helpful to be more precise here (and in the prune doc). This is what a user (not a dev) will need to know assuming they have limited memory, no?\r\n\r\nHow large the exceeding can be?",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-09-04T08:33:57Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded. Prune budget is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314610529",
      "id" : 1314610529,
      "line" : 4,
      "node_id" : "PRRC_kwDOABII585OW11h",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 4,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 4,
      "pull_request_review_id" : 1609034756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314610529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-04T08:35:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314610529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314618726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314618726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f\r\n\r\nit's better to have std::max at this line, not below. This way I spend much less time thinking about the underflow, so does a future reviewer.",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-09-04T08:39:00Z",
      "diff_hunk" : "@@ -5863,3 +5867,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314618726",
      "id" : 1314618726,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585OW31m",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 5884,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 324,
      "pull_request_review_id" : 1609046035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314618726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-04T08:39:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314618726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314635072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314635072"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well in theory that code is certainly prone to overflows, but I'm not sure whether that's the cause of a failure :)",
      "commit_id" : "1b1d7110e67da11752ae1efadb1c12a9054eb867",
      "created_at" : "2023-09-04T08:52:30Z",
      "diff_hunk" : "@@ -4765,6 +4765,10 @@ void ChainstateManager::CheckBlockIndex()\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindex->pprev && pindex->nTx > 0) {\n+            // nChainTx should increase monotonically\n+            assert(pindex->pprev->nChainTx <= pindex->nChainTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1314635072",
      "id" : 1314635072,
      "in_reply_to_id" : 1310950827,
      "line" : 4766,
      "node_id" : "PRRC_kwDOABII585OW71A",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 4766,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 165,
      "pull_request_review_id" : 1609071331,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314635072/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-04T08:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314635072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reviewed everything 1b1d7110e67da11752ae1efadb1c12a9054eb867.\r\nACK once some remaining comments are addressed.",
      "created_at" : "2023-09-04T09:27:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1704925919",
      "id" : 1704925919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585lnxrf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1704925919/reactions"
      },
      "updated_at" : "2023-09-04T09:27:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1704925919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319642325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319642325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added an assertion and comments. In practice, the mempool will be empty here because we wouldn't activate a snapshot outside of IBD, and acceptance to the mempool is closed until IBD completes. I'll add assertions elsewhere for that.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T09:52:36Z",
      "diff_hunk" : "@@ -5205,6 +5205,9 @@ bool ChainstateManager::ActivateSnapshot(\n         const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n         assert(chaintip_loaded);\n \n+        // Transfer possession of the mempool to the snapshot chianstate.\n+        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319642325",
      "id" : 1319642325,
      "in_reply_to_id" : 1312004094,
      "line" : 5205,
      "node_id" : "PRRC_kwDOABII585OqCTV",
      "original_commit_id" : "f2dd7a0c1b67d3e4a6e086a619eff34fe6625263",
      "original_line" : 5205,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 213,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319642325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319642325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319668545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668545"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:17:02Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319668545",
      "id" : 1319668545,
      "in_reply_to_id" : 1312025166,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqItB",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2723,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668545/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319668643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:17:08Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319668643",
      "id" : 1319668643,
      "in_reply_to_id" : 1312037894,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqIuj",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2721,
      "original_position" : 17,
      "original_start_line" : 2713,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319668643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319670355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:18:56Z",
      "diff_hunk" : "@@ -2699,6 +2699,91 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        {\n+            LOCK(cs_main);\n+            snapshot_start_block = chainman.m_blockman.LookupBlockIndex(base_blockhash);\n+        }\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (snapshot_start_block == nullptr) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+\n+    // TODO jamesob: no real need to lock cs_main here, but during testing it makes it\n+    // easier to follow the logs. We may want to remove this before merge.\n+    //\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319670355",
      "id" : 1319670355,
      "in_reply_to_id" : 1312036195,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqJJT",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2770,
      "original_position" : 72,
      "original_start_line" : 2767,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319670520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, good point. Fixed.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:19:06Z",
      "diff_hunk" : "@@ -2729,6 +2814,7 @@ void RegisterBlockchainRPCCommands(CRPCTable& t)\n         {\"hidden\", &waitforblockheight},\n         {\"hidden\", &syncwithvalidationinterfacequeue},\n         {\"hidden\", &dumptxoutset},\n+        {\"hidden\", &loadtxoutset},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319670520",
      "id" : 1319670520,
      "in_reply_to_id" : 1312038932,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqJL4",
      "original_commit_id" : "82a8744f1384f07dc30aaa6339b0b8fb32dc3af0",
      "original_line" : 2880,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319670520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319700227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319700227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually have no idea how to express \"std::string or null\" in our RPC framework... is this possible?",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:51:02Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319700227",
      "id" : 1319700227,
      "in_reply_to_id" : 1312045678,
      "line" : 2842,
      "node_id" : "PRRC_kwDOABII585OqQcD",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2842,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 144,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319700227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319700227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319702230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319702230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:53:20Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319702230",
      "id" : 1319702230,
      "in_reply_to_id" : 1312040274,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqQ7W",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2794,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319702230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319702230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319704895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319704895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, good catch. Fixed.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:56:15Z",
      "diff_hunk" : "@@ -144,40 +144,57 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    auto chain_tip_height = static_cast<uint64_t>(chain.m_chain.Height());\n+    if (chain_tip_height < 0 || target == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319704895",
      "id" : 1319704895,
      "in_reply_to_id" : 1314295003,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqRk_",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 189,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319704895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319704895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319707355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319707355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mentioned specific values here.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T10:58:07Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded. Prune budget is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319707355",
      "id" : 1319707355,
      "in_reply_to_id" : 1314610529,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqSLb",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 4,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319707355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319707355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319709536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319709536"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-08T11:00:05Z",
      "diff_hunk" : "@@ -5863,3 +5867,29 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;\n+    }\n+\n+    int max_prune = chainstate.m_chain.Height() - static_cast<int>(MIN_BLOCKS_TO_KEEP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1319709536",
      "id" : 1319709536,
      "in_reply_to_id" : 1314618726,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OqStg",
      "original_commit_id" : "51622e9c1f7ed16f65844817a4a5e9bcbc157b4f",
      "original_line" : 5884,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1617109738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319709536/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-08T14:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1319709536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1320930329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320930329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: adjust chainstate tests to use recognized snapshot base\" (64f431029f04cc47889dbe8fad55ccc139af9c07)\r\n\r\nOne problem with this change is that it makes the test less meaningful, now the snapshot block is the tip of the chain, and there are no blocks after it, so the test can no longer check that blocks after the snapshot block are added to the snapshot chain's setBlockIndex set. But it seems like if you just mine 20 blocks on line 435 and check for 120 blocks on line 440, the test will pass with no other changes and cover these blocks.\r\n\r\nAlso just in general I've been finding this test and the code around it very confusing, and think some extra comments and checks could help clarify it without having to change the existing code:\r\n\r\n```diff\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -422,17 +422,20 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n \r\n     int num_indexes{0};\r\n     int num_assumed_valid{0};\r\n+    // Blocks in range [assumed_valid_start_idx, last_assumed_valid_idx) will be\r\n+    // marked as assumed-valid and not having data.\r\n     const int expected_assumed_valid{20};\r\n     const int last_assumed_valid_idx{111};\r\n     const int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\r\n \r\n-    // Get to a valid assumeutxo snapshot\r\n-    mineBlocks(10);\r\n+    // Mine to height 120, past the hardcoded regtest assumeutxo snapshot at\r\n+    // height 110\r\n+    mineBlocks(20);\r\n \r\n     CBlockIndex* validated_tip{nullptr};\r\n     CBlockIndex* assumed_base{nullptr};\r\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\r\n-    BOOST_CHECK_EQUAL(assumed_tip->nHeight, 110);\r\n+    BOOST_CHECK_EQUAL(assumed_tip->nHeight, 120);\r\n \r\n     auto reload_all_block_indexes = [&]() {\r\n         // For completeness, we also reset the block sequence counters to\r\n@@ -458,7 +461,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         LOCK(::cs_main);\r\n         auto index = cs1.m_chain[i];\r\n \r\n-        // Blocks with heights in range [90, 110] are marked ASSUMED_VALID\r\n+        // Blocks with heights in range [91, 110] are marked ASSUMED_VALID\r\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\r\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\r\n         }\r\n@@ -492,10 +495,36 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     // Set tip of the assume-valid-based chain to the assume-valid block\r\n     cs2.m_chain.SetTip(*assumed_base);\r\n \r\n+    // Sanity check test variables.\r\n+    BOOST_CHECK_EQUAL(num_indexes, 121); // 121 total blocks, including genesis\r\n+    BOOST_CHECK_EQUAL(assumed_tip->nHeight, 120);  // original chain has height 120\r\n+    BOOST_CHECK_EQUAL(validated_tip->nHeight, 90); // current cs1 chain has height 90\r\n+    BOOST_CHECK_EQUAL(assumed_base->nHeight, 110); // current cs2 chain has height 110\r\n+\r\n+    // Regenerate cs1.setBlockIndexCandidates and cs2.setBlockIndexCandidate and\r\n+    // check contents below.\r\n     reload_all_block_indexes();\r\n \r\n-    // The fully validated chain should have the current validated tip\r\n-    // and the assumed valid base as candidates.\r\n+    // The fully validated chain should only have the current validated tip and\r\n+    // the assumed valid base as candidates, blocks 90 and 110. Specifically:\r\n+    //\r\n+    // - It does not have blocks 0-89 because they contain less work than the\r\n+    //   chain tip.\r\n+    //\r\n+    // - It has block 90 because it has data and equal work to the chain tip,\r\n+    //   (since it is the chain tip).\r\n+    //\r\n+    // - It does not have blocks 91-109 because they do not contain data.\r\n+    //\r\n+    // - It has block 110 even though it does not have data, because\r\n+    //   LoadBlockIndex has a special case to always add the snapshot block as a\r\n+    //   candidate. The special case is only actually intended to apply to the\r\n+    //   snapshot chainstate cs2, not the background chainstate cs1, but it is\r\n+    //   written broadly and applies to both.\r\n+    //\r\n+    // - It does not have any blocks after height 110 because cs1 is a background\r\n+    //   chainstate, and only blocks where are ancestors of the snapshot block\r\n+    //   are added as candidates for the background chainstate.\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\r\n@@ -503,8 +532,25 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     // The assumed-valid tolerant chain has the assumed valid base as a\r\n     // candidate, but otherwise has none of the assumed-valid (which do not\r\n     // HAVE_DATA) blocks as candidates.\r\n+    //\r\n+    // Specifically:\r\n+    // - All blocks below height 110 are not candidates, because cs2 chain tip\r\n+    //   has height 110 and they have less work than it does.\r\n+    //\r\n+    // - Block 110 is a candidate even though it does not have data, because it\r\n+    //   is the snapshot block, which is assumed valid.\r\n+    //\r\n+    // - Blocks 111-120 are added because they have data.\r\n+\r\n+    // Check that block 90 is absent\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);\r\n+    // Check that block 109 is absent\r\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base->pprev), 0);\r\n+    // Check that block 110 is present\r\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base), 1);\r\n+    // Check that block 120 is present\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\r\n+    // Check that 11 blocks total are present.\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes - last_assumed_valid_idx + 1);\r\n }\r\n \r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f77325daedb5..9c8815914a57 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3462,7 +3462,8 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\r\n void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\r\n {\r\n     AssertLockHeld(cs_main);\r\n-    // The block only is a candidate for the most-work-chain if it has more work than our current tip.\r\n+    // The block only is a candidate for the most-work-chain if it has the same\r\n+    // or more work than our current tip.\r\n     if (m_chain.Tip() != nullptr && setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\r\n         return;\r\n     }\r\n```\r\n\r\nI think it would be possible to make other improvements to the test beyond just adding comments. For example, I think it would be good to get rid of most of the variables and constants and just refer to blocks directly by height. Also, it would be good to add a fork to the chain below the snapshot height, to make sure blocks not leading up to the snapshot are not added as candidates to the background chainstate.",
      "commit_id" : "9634d71e8b2f9cdccb437e2a689ac298c05c0583",
      "created_at" : "2023-09-11T02:21:12Z",
      "diff_hunk" : "@@ -431,12 +428,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n     int num_indexes{0};\n     int num_assumed_valid{0};\n     const int expected_assumed_valid{20};\n-    const int last_assumed_valid_idx{40};\n+    const int last_assumed_valid_idx{111};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1320930329",
      "id" : 1320930329,
      "line" : 426,
      "node_id" : "PRRC_kwDOABII585Ou8wZ",
      "original_commit_id" : "64f431029f04cc47889dbe8fad55ccc139af9c07",
      "original_line" : 431,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 147,
      "pull_request_review_id" : 1618712088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320930329/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-11T02:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320930329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed an update adding @ryanofsky's good test changes, an import fix for the RPC code, and a documentation commit describing the confusing naming of `HaveTxsDownloaded()`.\r\n\r\n[`au.037`](https://github.com/jamesob/bitcoin/releases/tag/au.037)\r\n```\r\n( git remote -v | grep jamesob ) || git remote add jamesob https://github.com/jamesob/bitcoin\r\ngit fetch jamesob\r\ngit range-diff upstream/master jamesob/au.036 jamesob/au.037\r\n```\r\n\r\nI've run this locally for a few IBD cycles.",
      "created_at" : "2023-09-11T20:10:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1714510045",
      "id" : 1714510045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585mMVjd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1714510045/reactions"
      },
      "updated_at" : "2023-09-11T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1714510045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T07:13:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1715132009",
      "id" : 1715132009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585mOtZp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715132009/reactions"
      },
      "updated_at" : "2023-09-12T07:13:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1715132009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323131550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323131550"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\ns/m_last_blockfile/file_num/",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T14:27:10Z",
      "diff_hunk" : "@@ -70,6 +70,35 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.\n+    NORMAL,\n+    ASSUMED,\n+};\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type);\n+\n+struct BlockfileCursor {\n+    // The latest blockfile number.\n+    int file_num{0};\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323131550",
      "id" : 1323131550,
      "line" : 86,
      "node_id" : "PRRC_kwDOABII585O3WKe",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 86,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 25,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323131550/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323131550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323219325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323219325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nPrepending new parameter to a method with default arguments can be dangerous because it can lead to silent merge conflicts. (Argument value intended as the `fFinalize` parameter could be interpreted as the `blockfile_num` parameter).\r\n\r\nIt would be pretty easy to just drop all the default arguments and make the code explicit:\r\n\r\n```diff\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -121,8 +121,8 @@ private:\r\n      */\r\n     bool LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\r\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n-    void FlushBlockFile(int blockfile_num, bool fFinalize = false, bool finalize_undo = false);\r\n-    void FlushChainstateBlockFile(int tip_height, bool fFinalize = false, bool finalize_undo = false);\r\n+    void FlushBlockFile(int blockfile_num, bool fFinalize, bool finalize_undo);\r\n+    void FlushChainstateBlockFile(int tip_height);\r\n     void FlushUndoFile(int block_file, bool finalize = false);\r\n     bool FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, uint64_t nTime, bool fKnown);\r\n     bool FindUndoPos(BlockValidationState& state, int nFile, FlatFilePos& pos, unsigned int nAddSize);\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -630,14 +630,14 @@ BlockfileType BlockManager::BlockfileTypeForHeight(int height)\r\n     return (height >= *m_snapshot_height) ? BlockfileType::ASSUMED : BlockfileType::NORMAL;\r\n }\r\n \r\n-void BlockManager::FlushChainstateBlockFile(int tip_height, bool finalize, bool finalize_undo)\r\n+void BlockManager::FlushChainstateBlockFile(int tip_height)\r\n {\r\n     LOCK(cs_LastBlockFile);\r\n     auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\r\n     if (cursor) {\r\n         // The cursor may not exist after a snapshot has been loaded but before any\r\n         // blocks have been downloaded.\r\n-        return FlushBlockFile(cursor->file_num, finalize, finalize_undo);\r\n+        return FlushBlockFile(cursor->file_num, /*fFinalize=*/false, /*finalize_undo=*/false);\r\n     }\r\n }\r\n \r\n```",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T15:27:55Z",
      "diff_hunk" : "@@ -92,7 +121,8 @@ class BlockManager\n      */\n     bool LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    void FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n+    void FlushBlockFile(int blockfile_num, bool fFinalize = false, bool finalize_undo = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323219325",
      "id" : 1323219325,
      "line" : 124,
      "node_id" : "PRRC_kwDOABII585O3rl9",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 124,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 52,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323219325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323219325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323226418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323226418"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310950827\r\n\r\nIn commit \"validation: populate nChainTx value for assumedvalid chainstates\" (e3cae85738c8bf4116547af8d868c6c01577b80f)\r\n\r\nIt seems like one thing that was causing this assert to fail is that the hardcoded regtest `nChainTx` value is wrong. If I change the snapshot `nChainTx` value from `110` to `111` tests are able to pass.\r\n\r\nAnother problem is that some tests avoid storing blocks, so leave the `nChainTx` value unset. If I update the assert to allow `nChainTx` to still be unset, all tests seem to pass.\r\n\r\nSo I think the following changes would be make the check stronger and clarify the code:\r\n\r\n```diff\r\n--- a/src/kernel/chainparams.cpp\r\n+++ b/src/kernel/chainparams.cpp\r\n@@ -493,7 +493,7 @@ public:\r\n             {\r\n                 .height = 110,\r\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x1ebbf5850204c0bdb15bf030f47c7fe91d45c44c712697e4509ba67adb01c618\")},\r\n-                .nChainTx = 110,\r\n+                .nChainTx = 111,\r\n                 .blockhash = uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\")\r\n             },\r\n             {\r\n--- a/src/test/validation_tests.cpp\r\n+++ b/src/test/validation_tests.cpp\r\n@@ -138,11 +138,11 @@ BOOST_AUTO_TEST_CASE(test_assumeutxo)\r\n \r\n     const auto out110 = *params->AssumeutxoForHeight(110);\r\n     BOOST_CHECK_EQUAL(out110.hash_serialized.ToString(), \"1ebbf5850204c0bdb15bf030f47c7fe91d45c44c712697e4509ba67adb01c618\");\r\n-    BOOST_CHECK_EQUAL(out110.nChainTx, 110U);\r\n+    BOOST_CHECK_EQUAL(out110.nChainTx, 111U);\r\n \r\n     const auto out110_2 = *params->AssumeutxoForBlockhash(uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\"));\r\n     BOOST_CHECK_EQUAL(out110_2.hash_serialized.ToString(), \"1ebbf5850204c0bdb15bf030f47c7fe91d45c44c712697e4509ba67adb01c618\");\r\n-    BOOST_CHECK_EQUAL(out110_2.nChainTx, 110U);\r\n+    BOOST_CHECK_EQUAL(out110_2.nChainTx, 111U);\r\n }\r\n \r\n BOOST_AUTO_TEST_SUITE_END()\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -4762,10 +4762,15 @@ void ChainstateManager::CheckBlockIndex()\r\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\r\n     while (pindex != nullptr) {\r\n         nNodes++;\r\n-        if (pindex->pprev && pindex->nTx > 0) {\r\n-            // nChainTx should increase monotonically\r\n-            assert(pindex->pprev->nChainTx <= pindex->nChainTx);\r\n-        }\r\n+\r\n+        // Make sure nChainTx sum is correctly computed.\r\n+        unsigned int prev_chain_tx = pindex->pprev ? pindex->pprev->nChainTx : 0;\r\n+        assert((pindex->nChainTx == pindex->nTx + prev_chain_tx)\r\n+               // For testing, allow transaction counts to be completely unset.\r\n+               || (pindex->nChainTx == 0 && pindex->nTx == 0)\r\n+               // For testing, allow this nChainTx to be unset if previous is also unset.\r\n+               || (pindex->nChainTx == 0 && prev_chain_tx == 0 && pindex->pprev));\r\n+\r\n         if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\r\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\r\n         if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\r\n```",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T15:32:59Z",
      "diff_hunk" : "@@ -4765,6 +4765,10 @@ void ChainstateManager::CheckBlockIndex()\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindex->pprev && pindex->nTx > 0) {\n+            // nChainTx should increase monotonically\n+            assert(pindex->pprev->nChainTx <= pindex->nChainTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323226418",
      "id" : 1323226418,
      "in_reply_to_id" : 1310950827,
      "line" : 4767,
      "node_id" : "PRRC_kwDOABII585O3tUy",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 4767,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 175,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323226418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323226418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323283485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323283485"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nNo need to change, but if you wanted an easy way to avoid repeatedly looking up the same two map elements in a loop, you could just replace the `m_blockfile_cursors` map with a fixed size array like @ajtowns recently suggested for https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1281498873. I think the benefits would be similar: not just more efficiency but also more straightforward code where you don't have think about the `[]` operator default constructing elements or `at` method throwing exceptions.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T16:18:51Z",
      "diff_hunk" : "@@ -386,6 +395,15 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto last_height_in_file = m_blockfile_info[i].nHeightLast;\n+            m_blockfile_cursors[BlockfileTypeForHeight(last_height_in_file)] = {static_cast<int>(i), 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323283485",
      "id" : 1323283485,
      "line" : 403,
      "node_id" : "PRRC_kwDOABII585O37Qd",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 403,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 227,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323283485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323283485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323297281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323297281"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nCan the comment also say what happens after the snapshot is validated?",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T16:31:13Z",
      "diff_hunk" : "@@ -187,6 +226,19 @@ class BlockManager\n \n     BlockMap m_block_index GUARDED_BY(cs_main);\n \n+    /**\n+     * The height of the base block of an assumeutxo snapshot, if one is in use.\n+     *\n+     * This controls how blockfiles are segmented by chainstate type to avoid\n+     * comingling different height regions of the chain when an assumedvalid chainstate\n+     * is in use. If heights are drastically different in the same blockfile, pruning\n+     * suffers.\n+     *\n+     * This is set during ActivateSnapshot() or upon LoadBlockIndex() if a snapshot\n+     * had been previously loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323297281",
      "id" : 1323297281,
      "line" : 238,
      "node_id" : "PRRC_kwDOABII585O3-oB",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 238,
      "original_position" : 123,
      "original_start_line" : 237,
      "path" : "src/node/blockstorage.h",
      "position" : 142,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323297281/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 237,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323297281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323311919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323311919"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nHere and other places in this PR, I think it would be nice avoid hardcoding these 0's, and just use the default values that are already assigned in the struct definition. Alternately, if you think it is better to explicitly assign every field, it might be better to remove the default assignments in the struct so the compiler can warn when the assignments are missing.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T16:45:01Z",
      "diff_hunk" : "@@ -136,19 +166,26 @@ class BlockManager\n \n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n-    int m_last_blockfile = 0;\n \n-    // Track the height of the highest block in m_last_blockfile whose undo\n-    // data has been written. Block data is written to block files in download\n-    // order, but is written to undo files in validation order, which is\n-    // usually in order by height. To avoid wasting disk space, undo files will\n-    // be trimmed whenever the corresponding block file is finalized and\n-    // the height of the highest block written to the block file equals the\n-    // height of the highest block written to the undo file. This is a\n-    // heuristic and can sometimes preemptively trim undo files that will write\n-    // more data later, and sometimes fail to trim undo files that can't have\n-    // more data written later.\n-    unsigned int m_undo_height_in_last_blockfile = 0;\n+    //! Since assumedvalid chainstates may be syncing a range of the chain that is very\n+    //! far away from the normal/background validation process, we should segment blockfiles\n+    //! for assumed chainstates. Otherwise, we might have wildly different height ranges\n+    //! mixed into the same block files, which would impair our ability to prune\n+    //! effectively.\n+    //!\n+    //! This data structure maintains separate blockfile number cursors for each\n+    //! BlockfileType. The ASSUMED state is initialized, when necessary, in FindBlockPos().\n+    std::map<BlockfileType, std::optional<BlockfileCursor>> m_blockfile_cursors GUARDED_BY(cs_LastBlockFile) = {\n+        {BlockfileType::NORMAL, BlockfileCursor{}},\n+        {BlockfileType::ASSUMED, std::nullopt},\n+    };\n+    int MaxBlockfileNum() const EXCLUSIVE_LOCKS_REQUIRED(cs_LastBlockFile)\n+    {\n+        static const BlockfileCursor empty_cursor{0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323311919",
      "id" : 1323311919,
      "line" : 184,
      "node_id" : "PRRC_kwDOABII585O4CMv",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 184,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 112,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323311919/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323311919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323314721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323314721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nstatic_cast\\<int> here and below seems unnecessary because file_num should already be an int.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T16:47:41Z",
      "diff_hunk" : "@@ -783,10 +843,10 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // in the block file info as below; note that this does not catch the case where the undo writes are keeping up\n         // with the block writes (usually when a synced up node is getting newly mined blocks) -- this case is caught in\n         // the FindBlockPos function\n-        if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n+        if (_pos.nFile < static_cast<int>(cursor.file_num) && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323314721",
      "id" : 1323314721,
      "line" : 846,
      "node_id" : "PRRC_kwDOABII585O4C4h",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 846,
      "original_position" : 256,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 377,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323314721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323314721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323325683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323325683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1310990937\r\n\r\nIn commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\nWould suggest following change to mention it should be safe not to flush and also move the comment to be clearer it is describing the `if` condition not the flush call:\r\n\r\n```diff\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -634,9 +634,10 @@ void BlockManager::FlushChainstateBlockFile(int tip_height, bool finalize, bool\r\n {\r\n     LOCK(cs_LastBlockFile);\r\n     auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\r\n+    // If the cursor does not exist, it means an assumeutxo snapshot is loaded,\r\n+    // but no blocks past the snapshot height have been written yet, so there\r\n+    // is no data associated with the chainstate, and it is safe not to flush.\r\n     if (cursor) {\r\n-        // The cursor may not exist after a snapshot has been loaded but before any\r\n-        // blocks have been downloaded.\r\n         return FlushBlockFile(cursor->file_num, finalize, finalize_undo);\r\n     }\r\n }\r\n```",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T16:57:49Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(ChainstateRole chainstate_role, bool finalize, bool finalize_undo)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForRole(chainstate_role)];\n+    if (cursor) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323325683",
      "id" : 1323325683,
      "in_reply_to_id" : 1310990937,
      "line" : 637,
      "node_id" : "PRRC_kwDOABII585O4Fjz",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 637,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 288,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323325683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323325683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323346256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323346256"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\n`static_cast<int>(nFile)` cast here and blow seems unnecessary since nFile is already an int",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T17:18:47Z",
      "diff_hunk" : "@@ -675,27 +724,35 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n             }\n         }\n         assert(nAddSize < max_blockfile_size);\n+\n         while (m_blockfile_info[nFile].nSize + nAddSize >= max_blockfile_size) {\n             // when the undo file is keeping up with the block file, we want to flush it explicitly\n             // when it is lagging behind (more blocks arrive than are being connected), we let the\n             // undo block write case handle it\n-            finalize_undo = (m_blockfile_info[nFile].nHeightLast == m_undo_height_in_last_blockfile);\n-            nFile++;\n-            if (m_blockfile_info.size() <= nFile) {\n+            finalize_undo = (static_cast<int>(m_blockfile_info[nFile].nHeightLast) ==\n+                    Assert(m_blockfile_cursors[chain_type])->undo_height);\n+\n+            // Try the next unclaimed blockfile number\n+            nFile = this->MaxBlockfileNum() + 1;\n+            // Set to increment MaxBlockfileNum() for next iteration\n+            m_blockfile_cursors[chain_type] = BlockfileCursor{static_cast<int>(nFile), 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323346256",
      "id" : 1323346256,
      "line" : 738,
      "node_id" : "PRRC_kwDOABII585O4KlQ",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 738,
      "original_position" : 215,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 336,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323346256/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323346256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323349847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323349847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1311988064\r\n\r\nIn commit \"blockstorage: segment normal/assumedvalid blockfiles\" (3ff26bc73374b53550dc2dd17dd3e1c58258fc30)\r\n\r\n> I've just removed the comment because I don't think it adds much anymore.\r\n\r\nComment seems to be here still (and would be good to remove)",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T17:22:44Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323349847",
      "id" : 1323349847,
      "in_reply_to_id" : 1310979704,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585O4LdX",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 75,
      "original_position" : 14,
      "original_start_line" : 75,
      "path" : "src/node/blockstorage.h",
      "position" : 14,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323349847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 74,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323349847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323352284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323352284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: populate nChainTx value for assumedvalid chainstates\" (e3cae85738c8bf4116547af8d868c6c01577b80f)\r\n\r\nestimated",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-12T17:25:15Z",
      "diff_hunk" : "@@ -265,13 +265,26 @@ CBlockIndex* BlockManager::InsertBlockIndex(const uint256& hash)\n     return pindex;\n }\n \n-bool BlockManager::LoadBlockIndex()\n+bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n {\n     if (!m_block_tree_db->LoadBlockIndexGuts(\n             GetConsensus(), [this](const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this->InsertBlockIndex(hash); }, m_interrupt)) {\n         return false;\n     }\n \n+    int snapshot_height = -1;\n+    if (snapshot_blockhash) {\n+        const AssumeutxoData au_data = *Assert(GetParams().AssumeutxoForBlockhash(*snapshot_blockhash));\n+        snapshot_height = au_data.height;\n+        CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n+\n+        // Since nChainTx (responsible for estiamted progress) isn't persisted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323352284",
      "id" : 1323352284,
      "line" : 281,
      "node_id" : "PRRC_kwDOABII585O4MDc",
      "original_commit_id" : "e3cae85738c8bf4116547af8d868c6c01577b80f",
      "original_line" : 281,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 149,
      "pull_request_review_id" : 1622395165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323352284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T17:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323352284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325166462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325166462"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: assumeutxo: swap m_mempool on snapshot activation\" (0958f11c18c615c83632129e7f9d010c71f480ea)\r\n\r\nWould be nice  to add asserts here and above to back up the \"Mempool is empty at this point\" comment.\r\n\r\n```c++\r\nassert(m_active_chainstate->m_mempool->size() == 0);\r\n```\r\n\r\nI see there is another check added earlier in the code b9448bb8059208807492300bc84294a7f2f38edf, but this seems like a pretty important invariant to check in the actual places where the mempool swaps are happening.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-13T23:27:09Z",
      "diff_hunk" : "@@ -5671,16 +5676,20 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n         fs::PathToString(*path));\n \n-    this->ActivateExistingSnapshot(mempool, *base_blockhash);\n+    this->ActivateExistingSnapshot(*base_blockhash);\n     return true;\n }\n \n-Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)\n+Chainstate& ChainstateManager::ActivateExistingSnapshot(uint256 base_blockhash)\n {\n     assert(!m_snapshot_chainstate);\n     m_snapshot_chainstate =\n-        std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n+        std::make_unique<Chainstate>(nullptr, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n+    Assert(!m_snapshot_chainstate->m_mempool);\n+    // Mempool is empty at this point because we're still in IBD.\n+    m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325166462",
      "id" : 1325166462,
      "line" : 5699,
      "node_id" : "PRRC_kwDOABII585O_G9-",
      "original_commit_id" : "0958f11c18c615c83632129e7f9d010c71f480ea",
      "original_line" : 5691,
      "original_position" : 31,
      "original_start_line" : 5690,
      "path" : "src/validation.cpp",
      "position" : 276,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325166462/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5698,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325166462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325169631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325169631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (d9405fe1b7ea30861be7b84515e13a149109be36)\r\n\r\nThis information is nice to have in release notes, but it would be even more useful to have in the `loadtxoutset` RPC documentation. Right now the help text just consists of \"Load the serialized UTXO set from disk\" which does not provide much context.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-13T23:34:17Z",
      "diff_hunk" : "@@ -5,3 +5,22 @@ When using assumeutxo with `-prune`, the prune budget may be exceeded if it is s\n lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally\n split evenly across each chainstate, unless the resulting prune budget per chainstate\n is beneath `MIN_DISK_SPACE_FOR_BLOCK_FILES` in which case that value will be used.\n+\n+RPC\n+---\n+\n+`loadtxoutset` has been added, which allows loading a UTXO snapshot of the format\n+generated by `dumptxoutset`. Once this snapshot is loaded, its contents will be\n+deserialized into a second chainstate data structure, which is then used to sync to\n+the network's tip under a security model very much like `assumevalid`.\n+\n+Meanwhile, the original chainstate will complete the initial block download process in\n+the background, eventually validating up to the block that the snapshot is based upon.\n+\n+The result is a usable bitcoind instance that is current with the network tip in a\n+matter of minutes rather than hours. UTXO snapshot are typically obtained sources\n+third-party (HTTP, torrent, etc.) which is allowable since their contents are always\n+checked by hash.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325169631",
      "id" : 1325169631,
      "line" : 23,
      "node_id" : "PRRC_kwDOABII585O_Hvf",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 23,
      "original_position" : 19,
      "original_start_line" : 12,
      "path" : "doc/release-notes-27596.md",
      "position" : 23,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325169631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 12,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325169631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325175909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325175909"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (d9405fe1b7ea30861be7b84515e13a149109be36)\r\n\r\nWould be good check `IsRPCRunning` and raise RPC_CLIENT_NOT_CONNECTED if it returns false so this doesn't delay shutdown.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-13T23:48:38Z",
      "diff_hunk" : "@@ -2699,6 +2700,95 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325175909",
      "id" : 1325175909,
      "line" : 2751,
      "node_id" : "PRRC_kwDOABII585O_JRl",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 2751,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 60,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325175909/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325175909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325193433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325193433"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (d9405fe1b7ea30861be7b84515e13a149109be36)\r\n\r\nIs there a race here? It seems good to check the height of the snapshot to provide a user friendly error if there is an attempt to download a snapshot that would not speed up synchronization, but because the check is done so early, before `PopulateAndValidateSnapshot` runs, it seems like the background chain could exceed this height by the time the snapshot is activated. I don't see currently see another check in ActivateSnapshot that would prevent this (though I didn't look exhaustively).\r\n\r\nIn any case, I think it would be good to move this check to the `ActivateSnapshot` function so it could be implemented without any race, and good to have `ActivateSnapshot` return `util::Result` instead of bool. This would let `ActivateSnapshot` return other descriptive errors to the RPC caller like the \"can't activate a snapshot-based chainstate more than once\" error. This would also make a GUI assumeutxo feature easier to implement, so GUI code wouldn't have to duplicate RPC code.\r\n",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T00:10:17Z",
      "diff_hunk" : "@@ -2699,6 +2700,95 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    int active_height{WITH_LOCK(::cs_main, return chainman.ActiveHeight())};\n+    if (active_height >= snapshot_start_block->nHeight) {\n+        throw JSONRPCError(\n+            RPC_MISC_ERROR,\n+            \"Cannot activate a snapshot after the active chain has passed its base block.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325193433",
      "id" : 1325193433,
      "line" : 2774,
      "node_id" : "PRRC_kwDOABII585O_NjZ",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 2774,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 83,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325193433/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325193433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325201611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325201611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536)\r\n\r\nWould suggest dropping this field from chainstate information. I don't think it makes sense anymore after #28218",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T00:22:36Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325201611",
      "id" : 1325201611,
      "line" : 2798,
      "node_id" : "PRRC_kwDOABII585O_PjL",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2798,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 107,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325201611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325201611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325204093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204093"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1312045678\r\n\r\nIn commit \"rpc: add getchainstates\" (51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536)\r\n\r\n> Actually have no idea how to express \"std::string or null\" in our RPC framework... is this possible?\r\n\r\nI think you already did it on the documentation side `/*optional=*/true` above, since in general we treat null and missing values the same.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T00:28:11Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325204093",
      "id" : 1325204093,
      "in_reply_to_id" : 1312045678,
      "line" : 2843,
      "node_id" : "PRRC_kwDOABII585O_QJ9",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2843,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 152,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325204659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204659"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536)\r\n\r\nDescriptions for these 3 fields aren't right, same one is copied over",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T00:29:47Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::STR, \"active_chain_type\", \"one of \\\"ibd\\\", \\\"snapshot\\\", \\\"validated_snapshot\\\"\"},\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"ibd\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"validated_snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325204659",
      "id" : 1325204659,
      "line" : 2815,
      "node_id" : "PRRC_kwDOABII585O_QSz",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2815,
      "original_position" : 27,
      "original_start_line" : 2813,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 124,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2813,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325204659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325221867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325221867"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536)\r\n\r\nIMO, it is confusing and not useful to expose this \"ibd chainstate\" and \"validated_snapshot\" and \"active chainstate\" jargon to users. \r\n\r\nI would suggest dropping the \"active_chainstate\" field because it is trivial to infer which chainstate is \"active\" from the chainstate type. Having this field just adds ambiguity about what states are possible. I would also get rid of the 3-way \"validated_snapshot\" / \"snapshot\" / \"ibd\" split. The name \"ibd\" seems especially unhelpful because it seems to refer to a phase of download, not an chainstate or UTXO state.\r\n\r\nWould suggest returning just two chainstate fields:\r\n\r\n- One called \"normal\", which is always present, providing information about the fully validated chainstate.\r\n- One called \"snapshot\", which is only present when a snapshot is being validated, providing information about the partially validated chainstate based on the snapshot.\r\n\r\nAfter the snapshot chainstate is validated it should disappear, and there should just a \"normal\" chainstate.\r\n\r\nI don't think after snapshot is validated the RPC should enter a weird transient state where it is exposing information about an unused chainstate that is about to be deleted. The fact that the unused chainstate is not deleted until the next startup is a kludge we should fix, not a characteristic that should be baked into the terminology and UI.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:10:52Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::STR, \"active_chain_type\", \"one of \\\"ibd\\\", \\\"snapshot\\\", \\\"validated_snapshot\\\"\"},\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"ibd\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"validated_snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());\n+        data.pushKV(\"initialblockdownload\",  chainman.IsInitialBlockDownload());\n+        data.pushKV(\"coins_db_cache_bytes\",  cs->m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs->m_coinstip_cache_size_bytes);\n+        return data;\n+    };\n+\n+    auto get_chain_type = [&chainman](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        if (cs->m_from_snapshot_blockhash) {\n+            return (chainman.IsSnapshotValidated() ? \"validated_snapshot\" : \"snapshot\");\n+        }\n+        return \"ibd\";\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325221867",
      "id" : 1325221867,
      "line" : 2856,
      "node_id" : "PRRC_kwDOABII585O_Ufr",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2856,
      "original_position" : 68,
      "original_start_line" : 2850,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 165,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325221867/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2850,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325221867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325243993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325243993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add feature_assumeutxo functional test\" (3c7dacb823b0c226c02302b2c12cfe37121e0b0d)\r\n\r\nThis does seem like to a good idea to test to make sure snapshot is functional",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:38:57Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `ibd` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('ibd'))\n+\n+        # Ensure indexes have synced.\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n1.getindexinfo() == completed_idx_state)\n+\n+        # TODO: test submitting a transaction and verifying it appears in mempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325243993",
      "id" : 1325243993,
      "line" : 147,
      "node_id" : "PRRC_kwDOABII585O_Z5Z",
      "original_commit_id" : "3c7dacb823b0c226c02302b2c12cfe37121e0b0d",
      "original_line" : 147,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 147,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325243993/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325243993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325246788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325246788"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add feature_assumeutxo functional test\" (3c7dacb823b0c226c02302b2c12cfe37121e0b0d)\r\n\r\nMight be good to test what happens with -reindex and -reindex-chainstate before the snapshot is validated, and make sure it's deleted successfully (or just add it as another TODO for improving the test later)",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:42:39Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `ibd` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('ibd'))\n+\n+        # Ensure indexes have synced.\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n1.getindexinfo() == completed_idx_state)\n+\n+        # TODO: test submitting a transaction and verifying it appears in mempool\n+\n+        for i in (0, 1):\n+            n = self.nodes[i]\n+            self.log.info(f\"Restarting node {i} to ensure (Check|Load)BlockIndex passes\")\n+            self.restart_node(i, extra_args=self.extra_args[i])\n+\n+            assert_equal(n.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+            assert_equal(n.getchainstates()['ibd']['blocks'], FINAL_HEIGHT)\n+            assert_equal(n.getchainstates().get('snapshot'), None)\n+\n+            if i != 0:\n+                # Ensure indexes have synced for the assumeutxo node\n+                self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n+\n+\n+        # Node 2: all indexes + reindex\n+        # -----------------------------\n+\n+        self.log.info(\"-- Testing all indexes + reindex\")\n+        assert_equal(n2.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into third node from {dump_output['path']}\")\n+        loaded = n2.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n2.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        self.connect_nodes(0, 2)\n+        wait_until_helper(lambda: n2.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        wait_until_helper(lambda: not n2.getchainstates().get('ibd'))\n+\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+            'txindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n2.getindexinfo() == completed_idx_state)\n+\n+        for i in (0, 2):\n+            n = self.nodes[i]\n+            self.log.info(f\"Restarting node {i} to ensure (Check|Load)BlockIndex passes\")\n+            self.restart_node(i, extra_args=self.extra_args[i])\n+\n+            assert_equal(n.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+            assert_equal(n.getchainstates()['ibd']['blocks'], FINAL_HEIGHT)\n+            assert_equal(n.getchainstates().get('snapshot'), None)\n+\n+            if i != 0:\n+                # Ensure indexes have synced for the assumeutxo node\n+                self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n+\n+        self.log.info(\"Test -reindex-chainstate of an assumeutxo-synced node\")\n+        self.restart_node(2, extra_args=[\n+            '-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(n2.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+        wait_until_helper(lambda: n2.getblockcount() == FINAL_HEIGHT)\n+\n+        self.log.info(\"Test -reindex of an assumeutxo-synced node\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325246788",
      "id" : 1325246788,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585O_alE",
      "original_commit_id" : "3c7dacb823b0c226c02302b2c12cfe37121e0b0d",
      "original_line" : 214,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 214,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325246788/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325246788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325249448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325249448"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"contrib: add script to demo/test assumeutxo\" (b6f6eabfd84e14a1d621121e3cd841ac3ce91932)\r\n\r\nCan comment clarify why? It's not clear if something later in the script needs these enabled or if this it just trying to hit more code paths for testing",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:48:09Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325249448",
      "id" : 1325249448,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII585O_bOo",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 36,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325249448/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325249448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325250465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325250465"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"contrib: add script to demo/test assumeutxo\" (b6f6eabfd84e14a1d621121e3cd841ac3ce91932)\r\n\r\nWould be good to initialize DUMP_OUTPUT variable before this function so it is clear what path is being `rm -f'ed. Also so test environment doesn't cause something strange to happen.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:50:33Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325250465",
      "id" : 1325250465,
      "line" : 49,
      "node_id" : "PRRC_kwDOABII585O_beh",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 49,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 49,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325250465/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325250465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325252702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325252702"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"contrib: add script to demo/test assumeutxo\" (b6f6eabfd84e14a1d621121e3cd841ac3ce91932)\r\n\r\nCan comment explain these more? They seem to be passed to all client and server commands, so I'm curious which one(s) they are actually necessary for.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T01:55:16Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325252702",
      "id" : 1325252702,
      "line" : 58,
      "node_id" : "PRRC_kwDOABII585O_cBe",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 58,
      "original_position" : 58,
      "original_start_line" : 56,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 58,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325252702/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 56,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325252702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325255387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325255387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"contrib: add script to demo/test assumeutxo\" (b6f6eabfd84e14a1d621121e3cd841ac3ce91932)\r\n\r\nDoes it matter for the purposes of this script if -stopatheight is imprecise? (See https://github.com/bitcoin/bitcoin/issues/13477). Would be good to clarify in comment.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T02:00:33Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325255387",
      "id" : 1325255387,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585O_crb",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 105,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 105,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325255387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325255387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325261488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325261488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"doc: update release-process.md for assumeutxo\" (27adc36a173d5636e82dfca27364dbda34f3b022)\r\n\r\nThis seems a little too vague for release instructions. Maybe this can be made more specific, or just marked as optional / TBD to distinguish it from the more well defined parts of the release process.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T02:11:33Z",
      "diff_hunk" : "@@ -43,6 +43,11 @@ Release Process\n     - On mainnet, the selected value must not be orphaned, so it may be useful to set the height two blocks back from the tip.\n     - Testnet should be set with a height some tens of thousands back from the tip, due to reorgs there.\n   - `nMinimumChainWork` with the \"chainwork\" value of RPC `getblockheader` using the same height as that selected for the previous step.\n+  - `m_assumeutxo_data` with the updated assumeutxo hash and nChainTx count.\n+    - You can obtain this information, and the corresponding snapshot, by running\n+      `./contrib/devtools/utxo_snapshot.sh <blockheight> <snapshot-out-path>`.\n+    - The height used should probably the be same as the assumevalid height chosen.\n+    - Ensure the resulting snapshot is uploaded somewhere publicly accessible (torrent, HTTP server, etc.).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325261488",
      "id" : 1325261488,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585O_eKw",
      "original_commit_id" : "27adc36a173d5636e82dfca27364dbda34f3b022",
      "original_line" : 50,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "doc/release-process.md",
      "position" : 8,
      "pull_request_review_id" : 1625584894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325261488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T02:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325261488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1326535112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326535112"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a42510ba9656aada250c5fdf402e3914ba6f51db: definition could use a short doc",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-14T21:29:09Z",
      "diff_hunk" : "@@ -892,6 +892,37 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1326535112",
      "id" : 1326535112,
      "line" : 896,
      "node_id" : "PRRC_kwDOABII585PEVHI",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 895,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 21,
      "pull_request_review_id" : 1627779274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326535112/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-16T23:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326535112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-15T09:54:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1721001277",
      "id" : 1721001277,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585mlGU9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721001277/reactions"
      },
      "updated_at" : "2023-09-15T09:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721001277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328019543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328019543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a42510ba9656aada250c5fdf402e3914ba6f51db: I find the term \"usable\" in `IsUsable` a bit ambiguous. The doc also only explains what `false` means. Maybe expand it a bit, so it's easier to understand why the background state must be in progress when both states are \"usable\".",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-16T23:17:13Z",
      "diff_hunk" : "@@ -1036,12 +1033,25 @@ class ChainstateManager\n     //! Otherwise, revert to using the ibd chainstate and shutdown.\n     SnapshotCompletionResult MaybeCompleteSnapshotValidation() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     //! The most-work chain.\n     Chainstate& ActiveChainstate() const;\n     CChain& ActiveChain() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChainstate().m_chain; }\n     int ActiveHeight() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChain().Height(); }\n     CBlockIndex* ActiveTip() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChain().Tip(); }\n \n+    //! The state of a background sync (for net processing)\n+    bool BackgroundSyncInProgress() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) {\n+        return IsUsable(m_snapshot_chainstate.get()) && IsUsable(m_ibd_chainstate.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328019543",
      "id" : 1328019543,
      "line" : 1054,
      "node_id" : "PRRC_kwDOABII585PJ_hX",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1047,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 61,
      "pull_request_review_id" : 1627779274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328019543/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-16T23:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328019543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a42510ba9656aada250c5fdf402e3914ba6f51db: maybe add a comment above here that we prioritize new blocks in the snapshot chainstate by adding them to `vToDownload` first.",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-16T23:31:33Z",
      "diff_hunk" : "@@ -5830,7 +5897,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.IsInitialBlockDownload()) && state.vBlocksInFlight.size() < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            auto get_inflight_budget = [&state]() {\n+                return std::max(0, MAX_BLOCKS_IN_TRANSIT_PER_PEER - static_cast<int>(state.vBlocksInFlight.size()));\n+            };\n+\n+            FindNextBlocksToDownload(*peer, get_inflight_budget(), vToDownload, staller);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020510",
      "id" : 1328020510,
      "line" : 5914,
      "node_id" : "PRRC_kwDOABII585PJ_we",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 5904,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 191,
      "pull_request_review_id" : 1627779274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020510/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-16T23:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a42510ba9656aada250c5fdf402e3914ba6f51db: maybe rename to `FindHistoricalBlocksToDownload`? Since the actual downloading is done by `FindNextBlocks`, which in turn probably should be called `FindAndRequestBlocks`. Then again, maybe not worth renaming...",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-16T23:35:13Z",
      "diff_hunk" : "@@ -1341,12 +1373,47 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n         return;\n \n-    std::vector<const CBlockIndex*> vToFetch;\n     const CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n     // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last\n     // linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to\n     // download that next block if the window were 1 larger.\n     int nWindowEnd = state->pindexLastCommonBlock->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+\n+    FindNextBlocks(vBlocks, peer, state, pindexWalk, count, nWindowEnd, &m_chainman.ActiveChain(), &nodeStaller);\n+}\n+\n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020790",
      "id" : 1328020790,
      "line" : 1386,
      "node_id" : "PRRC_kwDOABII585PJ_02",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1385,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 77,
      "pull_request_review_id" : 1627779274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020790/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-16T23:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a42510ba9656aada250c5fdf402e3914ba6f51db: do I understand correctly that in the case of an alien reorg - that goes below the assumeutxo height - we depend on some other node having all the blocks for the original chain. Since with this code we can only do a deep reorg _after_ finishing background validation? ",
      "commit_id" : "9f9ffb655e4236f8d567b961102f53c5933e8aa8",
      "created_at" : "2023-09-16T23:38:10Z",
      "diff_hunk" : "@@ -1341,12 +1373,47 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n         return;\n \n-    std::vector<const CBlockIndex*> vToFetch;\n     const CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n     // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last\n     // linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to\n     // download that next block if the window were 1 larger.\n     int nWindowEnd = state->pindexLastCommonBlock->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+\n+    FindNextBlocks(vBlocks, peer, state, pindexWalk, count, nWindowEnd, &m_chainman.ActiveChain(), &nodeStaller);\n+}\n+\n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    Assert(from_tip);\n+    Assert(target_block);\n+\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = Assert(State(peer.m_id));\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer can't provide us the complete series of blocks leading up to the\n+        // assumeutxo snapshot base.\n+        //\n+        // Presumably this peer's chain has less work than our ActiveChain()'s tip, or else we\n+        // will eventually crash when we try to reorg to it. Let other logic\n+        // deal with whether we disconnect this peer.\n+        //\n+        // TODO at some point in the future, we might choose to request what blocks\n+        // this peer does have from the historical chain, despite it not having a\n+        // complete history beneath the snapshot base.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328020935",
      "id" : 1328020935,
      "line" : 1408,
      "node_id" : "PRRC_kwDOABII585PJ_3H",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1407,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 99,
      "pull_request_review_id" : 1627779274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-16T23:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328020935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116700"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:49:12Z",
      "diff_hunk" : "@@ -265,13 +265,26 @@ CBlockIndex* BlockManager::InsertBlockIndex(const uint256& hash)\n     return pindex;\n }\n \n-bool BlockManager::LoadBlockIndex()\n+bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n {\n     if (!m_block_tree_db->LoadBlockIndexGuts(\n             GetConsensus(), [this](const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this->InsertBlockIndex(hash); }, m_interrupt)) {\n         return false;\n     }\n \n+    int snapshot_height = -1;\n+    if (snapshot_blockhash) {\n+        const AssumeutxoData au_data = *Assert(GetParams().AssumeutxoForBlockhash(*snapshot_blockhash));\n+        snapshot_height = au_data.height;\n+        CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n+\n+        // Since nChainTx (responsible for estiamted progress) isn't persisted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116700",
      "id" : 1328116700,
      "in_reply_to_id" : 1323352284,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXPc",
      "original_commit_id" : "e3cae85738c8bf4116547af8d868c6c01577b80f",
      "original_line" : 281,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116700/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good suggestion! Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:49:19Z",
      "diff_hunk" : "@@ -386,6 +395,15 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);\n+        for (size_t i = 0; i < m_blockfile_info.size(); ++i) {\n+            const auto last_height_in_file = m_blockfile_info[i].nHeightLast;\n+            m_blockfile_cursors[BlockfileTypeForHeight(last_height_in_file)] = {static_cast<int>(i), 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116726",
      "id" : 1328116726,
      "in_reply_to_id" : 1323283485,
      "line" : 516,
      "node_id" : "PRRC_kwDOABII585PKXP2",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 516,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 227,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah good catch, thanks. Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:52:11Z",
      "diff_hunk" : "@@ -675,27 +724,35 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n             }\n         }\n         assert(nAddSize < max_blockfile_size);\n+\n         while (m_blockfile_info[nFile].nSize + nAddSize >= max_blockfile_size) {\n             // when the undo file is keeping up with the block file, we want to flush it explicitly\n             // when it is lagging behind (more blocks arrive than are being connected), we let the\n             // undo block write case handle it\n-            finalize_undo = (m_blockfile_info[nFile].nHeightLast == m_undo_height_in_last_blockfile);\n-            nFile++;\n-            if (m_blockfile_info.size() <= nFile) {\n+            finalize_undo = (static_cast<int>(m_blockfile_info[nFile].nHeightLast) ==\n+                    Assert(m_blockfile_cursors[chain_type])->undo_height);\n+\n+            // Try the next unclaimed blockfile number\n+            nFile = this->MaxBlockfileNum() + 1;\n+            // Set to increment MaxBlockfileNum() for next iteration\n+            m_blockfile_cursors[chain_type] = BlockfileCursor{static_cast<int>(nFile), 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116994",
      "id" : 1328116994,
      "in_reply_to_id" : 1323346256,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXUC",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 738,
      "original_position" : 215,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:52:15Z",
      "diff_hunk" : "@@ -783,10 +843,10 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // in the block file info as below; note that this does not catch the case where the undo writes are keeping up\n         // with the block writes (usually when a synced up node is getting newly mined blocks) -- this case is caught in\n         // the FindBlockPos function\n-        if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n+        if (_pos.nFile < static_cast<int>(cursor.file_num) && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328116997",
      "id" : 1328116997,
      "in_reply_to_id" : 1323314721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXUF",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 846,
      "original_position" : 256,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116997/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328116997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops! Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:52:51Z",
      "diff_hunk" : "@@ -70,6 +71,30 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117048",
      "id" : 1328117048,
      "in_reply_to_id" : 1310979704,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXU4",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 75,
      "original_position" : 14,
      "original_start_line" : 75,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117072"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:53:12Z",
      "diff_hunk" : "@@ -70,6 +70,35 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum class BlockfileType {\n+    // For the purposes of blockfile fragmentation, treat background IBD chainstates\n+    // as normal.\n+    NORMAL,\n+    ASSUMED,\n+};\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type);\n+\n+struct BlockfileCursor {\n+    // The latest blockfile number.\n+    int file_num{0};\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117072",
      "id" : 1328117072,
      "in_reply_to_id" : 1323131550,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXVQ",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 86,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117072/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, easy to do and done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:55:30Z",
      "diff_hunk" : "@@ -92,7 +121,8 @@ class BlockManager\n      */\n     bool LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    void FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n+    void FlushBlockFile(int blockfile_num, bool fFinalize = false, bool finalize_undo = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117373",
      "id" : 1328117373,
      "in_reply_to_id" : 1323219325,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXZ9",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 124,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117373/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T16:59:39Z",
      "diff_hunk" : "@@ -136,19 +166,26 @@ class BlockManager\n \n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n-    int m_last_blockfile = 0;\n \n-    // Track the height of the highest block in m_last_blockfile whose undo\n-    // data has been written. Block data is written to block files in download\n-    // order, but is written to undo files in validation order, which is\n-    // usually in order by height. To avoid wasting disk space, undo files will\n-    // be trimmed whenever the corresponding block file is finalized and\n-    // the height of the highest block written to the block file equals the\n-    // height of the highest block written to the undo file. This is a\n-    // heuristic and can sometimes preemptively trim undo files that will write\n-    // more data later, and sometimes fail to trim undo files that can't have\n-    // more data written later.\n-    unsigned int m_undo_height_in_last_blockfile = 0;\n+    //! Since assumedvalid chainstates may be syncing a range of the chain that is very\n+    //! far away from the normal/background validation process, we should segment blockfiles\n+    //! for assumed chainstates. Otherwise, we might have wildly different height ranges\n+    //! mixed into the same block files, which would impair our ability to prune\n+    //! effectively.\n+    //!\n+    //! This data structure maintains separate blockfile number cursors for each\n+    //! BlockfileType. The ASSUMED state is initialized, when necessary, in FindBlockPos().\n+    std::map<BlockfileType, std::optional<BlockfileCursor>> m_blockfile_cursors GUARDED_BY(cs_LastBlockFile) = {\n+        {BlockfileType::NORMAL, BlockfileCursor{}},\n+        {BlockfileType::ASSUMED, std::nullopt},\n+    };\n+    int MaxBlockfileNum() const EXCLUSIVE_LOCKS_REQUIRED(cs_LastBlockFile)\n+    {\n+        static const BlockfileCursor empty_cursor{0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328117840",
      "id" : 1328117840,
      "in_reply_to_id" : 1323311919,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXhQ",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 184,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328117840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328118025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T17:01:05Z",
      "diff_hunk" : "@@ -187,6 +226,19 @@ class BlockManager\n \n     BlockMap m_block_index GUARDED_BY(cs_main);\n \n+    /**\n+     * The height of the base block of an assumeutxo snapshot, if one is in use.\n+     *\n+     * This controls how blockfiles are segmented by chainstate type to avoid\n+     * comingling different height regions of the chain when an assumedvalid chainstate\n+     * is in use. If heights are drastically different in the same blockfile, pruning\n+     * suffers.\n+     *\n+     * This is set during ActivateSnapshot() or upon LoadBlockIndex() if a snapshot\n+     * had been previously loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328118025",
      "id" : 1328118025,
      "in_reply_to_id" : 1323297281,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXkJ",
      "original_commit_id" : "3ff26bc73374b53550dc2dd17dd3e1c58258fc30",
      "original_line" : 238,
      "original_position" : 123,
      "original_start_line" : 237,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328118875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T17:08:25Z",
      "diff_hunk" : "@@ -5671,16 +5676,20 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n         fs::PathToString(*path));\n \n-    this->ActivateExistingSnapshot(mempool, *base_blockhash);\n+    this->ActivateExistingSnapshot(*base_blockhash);\n     return true;\n }\n \n-Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)\n+Chainstate& ChainstateManager::ActivateExistingSnapshot(uint256 base_blockhash)\n {\n     assert(!m_snapshot_chainstate);\n     m_snapshot_chainstate =\n-        std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n+        std::make_unique<Chainstate>(nullptr, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n+    Assert(!m_snapshot_chainstate->m_mempool);\n+    // Mempool is empty at this point because we're still in IBD.\n+    m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328118875",
      "id" : 1328118875,
      "in_reply_to_id" : 1325166462,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKXxb",
      "original_commit_id" : "0958f11c18c615c83632129e7f9d010c71f480ea",
      "original_line" : 5790,
      "original_position" : 31,
      "original_start_line" : 5690,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118875/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328118875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328122437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, added to the RPC def.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T17:41:43Z",
      "diff_hunk" : "@@ -5,3 +5,22 @@ When using assumeutxo with `-prune`, the prune budget may be exceeded if it is s\n lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally\n split evenly across each chainstate, unless the resulting prune budget per chainstate\n is beneath `MIN_DISK_SPACE_FOR_BLOCK_FILES` in which case that value will be used.\n+\n+RPC\n+---\n+\n+`loadtxoutset` has been added, which allows loading a UTXO snapshot of the format\n+generated by `dumptxoutset`. Once this snapshot is loaded, its contents will be\n+deserialized into a second chainstate data structure, which is then used to sync to\n+the network's tip under a security model very much like `assumevalid`.\n+\n+Meanwhile, the original chainstate will complete the initial block download process in\n+the background, eventually validating up to the block that the snapshot is based upon.\n+\n+The result is a usable bitcoind instance that is current with the network tip in a\n+matter of minutes rather than hours. UTXO snapshot are typically obtained sources\n+third-party (HTTP, torrent, etc.) which is allowable since their contents are always\n+checked by hash.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328122437",
      "id" : 1328122437,
      "in_reply_to_id" : 1325169631,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKYpF",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 23,
      "original_position" : 19,
      "original_start_line" : 12,
      "path" : "doc/release-notes-27596.md",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328122787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T17:44:59Z",
      "diff_hunk" : "@@ -2699,6 +2700,95 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328122787",
      "id" : 1328122787,
      "in_reply_to_id" : 1325175909,
      "line" : 2764,
      "node_id" : "PRRC_kwDOABII585PKYuj",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 2764,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 73,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122787/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328122787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328123875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328123875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! I think a user loading a snapshot just before IBD completes is pretty unlikely, but definitely something we should handle. Although if it gives everyone any comfort, `MaybeCompleteSnapshotValidation()` (as called by ABC) would have handled this case [by simply deleting/deactivating the snapshot](https://github.com/jamesob/bitcoin/blob/b9448bb8059208807492300bc84294a7f2f38edf/src/validation.cpp#L5475-L5521). \r\n\r\nI've added a commit with the check in `ActivateSnapshot`, but maybe we can do the `util::Result` return as a followup.\r\n\r\nNote that because of the difficulty inherent in generating snapshots in unittests, I had to include a hack in `test/util/chainstate/CreateAndActivateUTXOSnapshot()` as a result of this change that rewinds the active chain while activating a snapshot. I don't see an easy way around this.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T17:54:17Z",
      "diff_hunk" : "@@ -2699,6 +2700,95 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    int active_height{WITH_LOCK(::cs_main, return chainman.ActiveHeight())};\n+    if (active_height >= snapshot_start_block->nHeight) {\n+        throw JSONRPCError(\n+            RPC_MISC_ERROR,\n+            \"Cannot activate a snapshot after the active chain has passed its base block.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328123875",
      "id" : 1328123875,
      "in_reply_to_id" : 1325193433,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKY_j",
      "original_commit_id" : "d9405fe1b7ea30861be7b84515e13a149109be36",
      "original_line" : 2774,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328123875/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328123875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130342"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130342"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:51:22Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130342",
      "id" : 1328130342,
      "in_reply_to_id" : 1325201611,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKakm",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2798,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130342/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:52:19Z",
      "diff_hunk" : "@@ -2784,6 +2784,69 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130421",
      "id" : 1328130421,
      "in_reply_to_id" : 1312045678,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKal1",
      "original_commit_id" : "555206238129c6ed9fcbbc498c81455c7fe6d851",
      "original_line" : 2843,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, good points. This RPC originally began as a debugging aid for development, but I think that use isn't necessary anymore.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:53:05Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::STR, \"active_chain_type\", \"one of \\\"ibd\\\", \\\"snapshot\\\", \\\"validated_snapshot\\\"\"},\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"ibd\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"validated_snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs || !cs->m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs->m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"snapshot_blockhash\",    cs->m_from_snapshot_blockhash.value_or(uint256{}).ToString());\n+        data.pushKV(\"initialblockdownload\",  chainman.IsInitialBlockDownload());\n+        data.pushKV(\"coins_db_cache_bytes\",  cs->m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs->m_coinstip_cache_size_bytes);\n+        return data;\n+    };\n+\n+    auto get_chain_type = [&chainman](Chainstate* cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        if (cs->m_from_snapshot_blockhash) {\n+            return (chainman.IsSnapshotValidated() ? \"validated_snapshot\" : \"snapshot\");\n+        }\n+        return \"ibd\";\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328130516",
      "id" : 1328130516,
      "in_reply_to_id" : 1325221867,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKanU",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2856,
      "original_position" : 68,
      "original_start_line" : 2850,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328130516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131014"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:57:28Z",
      "diff_hunk" : "@@ -2789,6 +2789,85 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::BOOL, \"initialblockdownload\", \"is this chainstate in IBD\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::STR, \"active_chain_type\", \"one of \\\"ibd\\\", \\\"snapshot\\\", \\\"validated_snapshot\\\"\"},\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"ibd\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"validated_snapshot\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131014",
      "id" : 1328131014,
      "in_reply_to_id" : 1325204659,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKavG",
      "original_commit_id" : "51dbde2bb73bcd03f73e3d5eb6c998e5e01b5536",
      "original_line" : 2815,
      "original_position" : 27,
      "original_start_line" : 2813,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Followup?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:57:48Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `ibd` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('ibd'))\n+\n+        # Ensure indexes have synced.\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n1.getindexinfo() == completed_idx_state)\n+\n+        # TODO: test submitting a transaction and verifying it appears in mempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131057",
      "id" : 1328131057,
      "in_reply_to_id" : 1325243993,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKavx",
      "original_commit_id" : "3c7dacb823b0c226c02302b2c12cfe37121e0b0d",
      "original_line" : 147,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131083"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added TODO.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T18:57:56Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `ibd` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('ibd'))\n+\n+        # Ensure indexes have synced.\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n1.getindexinfo() == completed_idx_state)\n+\n+        # TODO: test submitting a transaction and verifying it appears in mempool\n+\n+        for i in (0, 1):\n+            n = self.nodes[i]\n+            self.log.info(f\"Restarting node {i} to ensure (Check|Load)BlockIndex passes\")\n+            self.restart_node(i, extra_args=self.extra_args[i])\n+\n+            assert_equal(n.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+            assert_equal(n.getchainstates()['ibd']['blocks'], FINAL_HEIGHT)\n+            assert_equal(n.getchainstates().get('snapshot'), None)\n+\n+            if i != 0:\n+                # Ensure indexes have synced for the assumeutxo node\n+                self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n+\n+\n+        # Node 2: all indexes + reindex\n+        # -----------------------------\n+\n+        self.log.info(\"-- Testing all indexes + reindex\")\n+        assert_equal(n2.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into third node from {dump_output['path']}\")\n+        loaded = n2.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n2.getchainstates()\n+        assert_equal(monitor['ibd']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        self.connect_nodes(0, 2)\n+        wait_until_helper(lambda: n2.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        wait_until_helper(lambda: not n2.getchainstates().get('ibd'))\n+\n+        completed_idx_state = {\n+            'basic block filter index': COMPLETE_IDX,\n+            'coinstatsindex': COMPLETE_IDX,\n+            'txindex': COMPLETE_IDX,\n+        }\n+        self.wait_until(lambda: n2.getindexinfo() == completed_idx_state)\n+\n+        for i in (0, 2):\n+            n = self.nodes[i]\n+            self.log.info(f\"Restarting node {i} to ensure (Check|Load)BlockIndex passes\")\n+            self.restart_node(i, extra_args=self.extra_args[i])\n+\n+            assert_equal(n.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+            assert_equal(n.getchainstates()['ibd']['blocks'], FINAL_HEIGHT)\n+            assert_equal(n.getchainstates().get('snapshot'), None)\n+\n+            if i != 0:\n+                # Ensure indexes have synced for the assumeutxo node\n+                self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n+\n+        self.log.info(\"Test -reindex-chainstate of an assumeutxo-synced node\")\n+        self.restart_node(2, extra_args=[\n+            '-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(n2.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+        wait_until_helper(lambda: n2.getblockcount() == FINAL_HEIGHT)\n+\n+        self.log.info(\"Test -reindex of an assumeutxo-synced node\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328131083",
      "id" : 1328131083,
      "in_reply_to_id" : 1325246788,
      "line" : 239,
      "node_id" : "PRRC_kwDOABII585PKawL",
      "original_commit_id" : "3c7dacb823b0c226c02302b2c12cfe37121e0b0d",
      "original_line" : 239,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 239,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131083/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328131083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Coverage; clarified in comment.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:20:06Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153191",
      "id" : 1328153191,
      "in_reply_to_id" : 1325249448,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKgJn",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:20:32Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153252",
      "id" : 1328153252,
      "in_reply_to_id" : 1325250465,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII585PKgKk",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 52,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 52,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, also renamed variable.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:21:59Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153353",
      "id" : 1328153353,
      "in_reply_to_id" : 1325252702,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKgMJ",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 58,
      "original_position" : 58,
      "original_start_line" : 56,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Script expects that this is imprecise.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:22:48Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153426",
      "id" : 1328153426,
      "in_reply_to_id" : 1325255387,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKgNS",
      "original_commit_id" : "b6f6eabfd84e14a1d621121e3cd841ac3ce91932",
      "original_line" : 105,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reworded.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:25:06Z",
      "diff_hunk" : "@@ -43,6 +43,11 @@ Release Process\n     - On mainnet, the selected value must not be orphaned, so it may be useful to set the height two blocks back from the tip.\n     - Testnet should be set with a height some tens of thousands back from the tip, due to reorgs there.\n   - `nMinimumChainWork` with the \"chainwork\" value of RPC `getblockheader` using the same height as that selected for the previous step.\n+  - `m_assumeutxo_data` with the updated assumeutxo hash and nChainTx count.\n+    - You can obtain this information, and the corresponding snapshot, by running\n+      `./contrib/devtools/utxo_snapshot.sh <blockheight> <snapshot-out-path>`.\n+    - The height used should probably the be same as the assumevalid height chosen.\n+    - Ensure the resulting snapshot is uploaded somewhere publicly accessible (torrent, HTTP server, etc.).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153712",
      "id" : 1328153712,
      "in_reply_to_id" : 1325261488,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PKgRw",
      "original_commit_id" : "27adc36a173d5636e82dfca27364dbda34f3b022",
      "original_line" : 50,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "doc/release-process.md",
      "position" : null,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See the docstring for `IsUsable()`.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:27:00Z",
      "diff_hunk" : "@@ -1036,12 +1033,25 @@ class ChainstateManager\n     //! Otherwise, revert to using the ibd chainstate and shutdown.\n     SnapshotCompletionResult MaybeCompleteSnapshotValidation() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     //! The most-work chain.\n     Chainstate& ActiveChainstate() const;\n     CChain& ActiveChain() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChainstate().m_chain; }\n     int ActiveHeight() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChain().Height(); }\n     CBlockIndex* ActiveTip() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) { return ActiveChain().Tip(); }\n \n+    //! The state of a background sync (for net processing)\n+    bool BackgroundSyncInProgress() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex()) {\n+        return IsUsable(m_snapshot_chainstate.get()) && IsUsable(m_ibd_chainstate.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328153951",
      "id" : 1328153951,
      "in_reply_to_id" : 1328019543,
      "line" : 1053,
      "node_id" : "PRRC_kwDOABII585PKgVf",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1053,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 61,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328153951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Followup if at all.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:27:33Z",
      "diff_hunk" : "@@ -1341,12 +1373,47 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n         return;\n \n-    std::vector<const CBlockIndex*> vToFetch;\n     const CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n     // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last\n     // linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to\n     // download that next block if the window were 1 larger.\n     int nWindowEnd = state->pindexLastCommonBlock->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+\n+    FindNextBlocks(vBlocks, peer, state, pindexWalk, count, nWindowEnd, &m_chainman.ActiveChain(), &nodeStaller);\n+}\n+\n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154010",
      "id" : 1328154010,
      "in_reply_to_id" : 1328020790,
      "line" : 1387,
      "node_id" : "PRRC_kwDOABII585PKgWa",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1387,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154010/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:28:56Z",
      "diff_hunk" : "@@ -5830,7 +5897,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.IsInitialBlockDownload()) && state.vBlocksInFlight.size() < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            auto get_inflight_budget = [&state]() {\n+                return std::max(0, MAX_BLOCKS_IN_TRANSIT_PER_PEER - static_cast<int>(state.vBlocksInFlight.size()));\n+            };\n+\n+            FindNextBlocksToDownload(*peer, get_inflight_budget(), vToDownload, staller);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154139",
      "id" : 1328154139,
      "in_reply_to_id" : 1328020510,
      "line" : 5934,
      "node_id" : "PRRC_kwDOABII585PKgYb",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 5934,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 194,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Either peer is in alien reorg that doesn't include the snapshot base in its best chain or they don't have complete blocks up to the snapshot base.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-17T22:31:14Z",
      "diff_hunk" : "@@ -1341,12 +1373,47 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     if (state->pindexLastCommonBlock == state->pindexBestKnownBlock)\n         return;\n \n-    std::vector<const CBlockIndex*> vToFetch;\n     const CBlockIndex *pindexWalk = state->pindexLastCommonBlock;\n     // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last\n     // linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to\n     // download that next block if the window were 1 larger.\n     int nWindowEnd = state->pindexLastCommonBlock->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+\n+    FindNextBlocks(vBlocks, peer, state, pindexWalk, count, nWindowEnd, &m_chainman.ActiveChain(), &nodeStaller);\n+}\n+\n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    Assert(from_tip);\n+    Assert(target_block);\n+\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = Assert(State(peer.m_id));\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer can't provide us the complete series of blocks leading up to the\n+        // assumeutxo snapshot base.\n+        //\n+        // Presumably this peer's chain has less work than our ActiveChain()'s tip, or else we\n+        // will eventually crash when we try to reorg to it. Let other logic\n+        // deal with whether we disconnect this peer.\n+        //\n+        // TODO at some point in the future, we might choose to request what blocks\n+        // this peer does have from the historical chain, despite it not having a\n+        // complete history beneath the snapshot base.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1328154370",
      "id" : 1328154370,
      "in_reply_to_id" : 1328020935,
      "line" : 1409,
      "node_id" : "PRRC_kwDOABII585PKgcC",
      "original_commit_id" : "a42510ba9656aada250c5fdf402e3914ba6f51db",
      "original_line" : 1409,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 100,
      "pull_request_review_id" : 1630102347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154370/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-17T22:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328154370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1329992346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329992346"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (f7f446f750146d74114e72b27c6cba0bf59473bb)\r\n\r\nWould suggest adding `NUM_TYPES = 2` enum value here, and replacing hardcoded `2` on line 206. This might be a little less fragile and make it a little easier to add new types.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-19T11:52:33Z",
      "diff_hunk" : "@@ -97,6 +97,34 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum BlockfileType {\n+    // Values used as array indexes - do not change carelessly.\n+    NORMAL = 0,\n+    ASSUMED = 1,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1329992346",
      "id" : 1329992346,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585PRhKa",
      "original_commit_id" : "f7f446f750146d74114e72b27c6cba0bf59473bb",
      "original_line" : 103,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 15,
      "pull_request_review_id" : 1633063450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329992346/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T01:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329992346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330422758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330422758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: do not activate snapshot if behind active chain\" (f09536af610b8eaca13f38e24825b5f62f55c968)\r\n\r\nIt seems like it would be better to verify that the snapshot block has more work than the chain tip, instead of verifying that it has a bigger height. In theory it would be possible for the chain tip to be pointing at a block with a large height but less work, and then the snapshot might incorrectly refuse to load.\r\n\r\nAlso, it seems like there is a race condition here because cs_main is released after this check, and potentially more blocks could be attached when this happens. It looks like a better place for this check would be on line 5275 after `cs_main` is locked but before `m_snapshot_chainstate` is assigned. Moving the check there would be a slightly bigger code change because it would require moving the !snapshot_ok DeleteCoinsDBFromDisk cleanup call to the bottom of the function, but moving cleanup to the end of the function would probably make sense anyway.\r\n\r\n",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-19T16:42:02Z",
      "diff_hunk" : "@@ -5238,6 +5238,18 @@ bool ChainstateManager::ActivateSnapshot(\n             snapshot_ok = false;\n         }\n     }\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually at a more\n+    // advanced height than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    {\n+        LOCK(::cs_main);\n+        if (snapshot_chainstate->m_chain.Height() <= ActiveHeight()) {\n+            LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");\n+            snapshot_ok = false;\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330422758",
      "id" : 1330422758,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PTKPm",
      "original_commit_id" : "f09536af610b8eaca13f38e24825b5f62f55c968",
      "original_line" : 5251,
      "original_position" : 14,
      "original_start_line" : 5242,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1633063450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330422758/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-20T01:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330422758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330426193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330426193"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: do not activate snapshot if behind active chain\" (f09536af610b8eaca13f38e24825b5f62f55c968)\r\n\r\nIt's a little surprising to see this check here because this function is just trying to load the snapshot data, and otherwise doesn't care at all about the state of the active chain. Might be good to clarify with a comment that is just an early check to avoid slow loading of a snapshot that won't be usable, and another check will happen later before the snapshot is activated.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-19T16:45:22Z",
      "diff_hunk" : "@@ -5339,6 +5351,11 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    if (au_data.height <= WITH_LOCK(::cs_main, return ActiveHeight())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330426193",
      "id" : 1330426193,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PTLFR",
      "original_commit_id" : "f09536af610b8eaca13f38e24825b5f62f55c968",
      "original_line" : 5354,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1633063450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330426193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T01:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330426193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330505053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330505053"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add loadtxoutset\" (ef7da5ffce66afa7c3e5f7b3951ecbf0b5f4fe57)\r\n\r\nProbably should say \"obtained from third-party sources\"",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-19T17:50:26Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained sources \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330505053",
      "id" : 1330505053,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PTeVd",
      "original_commit_id" : "ef7da5ffce66afa7c3e5f7b3951ecbf0b5f4fe57",
      "original_line" : 2715,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1633063450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330505053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T01:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330505053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330506362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330506362"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: add getchainstates\" (8a69ed3425bf807625f15d0d3f910d5cabfc4c24)\r\n\r\nWould suggest changing this to avoid the phrase \"initial block download chainstate.\" I've gotten a little used to this phrase from reviewing assumeutxo PRs, but I don't actually see how it makes sense as a description. The main distinction between the two chainstates, I think, is that one chainstate is fully validated and the other is partially validated. So maybe would make the documentation say:\r\n\r\n* \"normal\" - Fully validated chainstate containing blocks this node has validated starting from the genesis block.\r\n* \"snapshot\" - Only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the \"normal\" chainstate advances far enough to validate it), this chainstate will replace and become the \"normal\" chainstate.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-19T17:51:48Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a chainstate that is assumed valid based upon a UTXO snapshot\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1330506362",
      "id" : 1330506362,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PTep6",
      "original_commit_id" : "8a69ed3425bf807625f15d0d3f910d5cabfc4c24",
      "original_line" : 2822,
      "original_position" : 24,
      "original_start_line" : 2821,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1633063450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330506362/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-20T09:47:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330506362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331194085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331194085"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a9ea542e8aed092f45dab2d9a66da56aba742f51\r\n\r\nnit: This probably used to be an `ID`, but now it's just a peer?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T08:06:11Z",
      "diff_hunk" : "@@ -892,6 +892,38 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /** Request blocks for the background chainstate, if one is in use. */\n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /**\n+    * \\brief Find next blocks to download from a peer after a starting block.\n+    *\n+    * \\param vBlocks      Vector of blocks to download which will be appended to.\n+    * \\param peer         ID of peer which blocks will be downloaded from.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331194085",
      "id" : 1331194085,
      "line" : 903,
      "node_id" : "PRRC_kwDOABII585PWGjl",
      "original_commit_id" : "a9ea542e8aed092f45dab2d9a66da56aba742f51",
      "original_line" : 902,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331194085/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331194085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331240905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331240905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "00129799d97c746e77d929c323b689aae72b46b2\r\n\r\n    //! Once this pointer is set to a corresponding chainstate, it will not\r\n    //! be reset until init.cpp:Shutdown().\r\n\r\nShould be updated?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T08:31:05Z",
      "diff_hunk" : "@@ -5786,6 +5791,23 @@ util::Result<void> Chainstate::InvalidateCoinsDBOnDisk()\n     return {};\n }\n \n+bool ChainstateManager::DeleteSnapshotChainstate()\n+{\n+    AssertLockHeld(::cs_main);\n+    Assert(m_snapshot_chainstate);\n+    Assert(m_ibd_chainstate);\n+\n+    fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*m_snapshot_chainstate);\n+    if (!DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true)) {\n+        LogPrintf(\"Deletion of %s failed. Please remove it manually to continue reindexing.\\n\",\n+                  fs::PathToString(snapshot_datadir));\n+        return false;\n+    }\n+    m_active_chainstate = m_ibd_chainstate.get();\n+    m_snapshot_chainstate.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331240905",
      "id" : 1331240905,
      "line" : 5865,
      "node_id" : "PRRC_kwDOABII585PWR_J",
      "original_commit_id" : "00129799d97c746e77d929c323b689aae72b46b2",
      "original_line" : 5807,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 409,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331240905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331240905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331255670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331255670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3661b4b085b9501cecd55f606c3da40e38193455\r\n\r\nit's impossible to have `!was_in_ibd & still_in_ibd` right?\r\n`Assume` invariant could be added for the clarity of code.\r\n\r\nAlso, that's implied by the var name `still`, but i'd prefer `now_in_ibd` to lower the expectations.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T08:42:00Z",
      "diff_hunk" : "@@ -3248,16 +3250,21 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n             if (!blocks_connected) return true;\n \n             const CBlockIndex* pindexFork = m_chain.FindFork(starting_tip);\n-            bool fInitialDownload = m_chainman.IsInitialBlockDownload();\n+            bool still_in_ibd = m_chainman.IsInitialBlockDownload();\n+\n+            if (was_in_ibd && !still_in_ibd) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331255670",
      "id" : 1331255670,
      "line" : 3260,
      "node_id" : "PRRC_kwDOABII585PWVl2",
      "original_commit_id" : "3661b4b085b9501cecd55f606c3da40e38193455",
      "original_line" : 3255,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 83,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331255670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331255670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331258939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331258939"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When would it be 0?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T08:44:28Z",
      "diff_hunk" : "@@ -5810,6 +5810,16 @@ bool ChainstateManager::DeleteSnapshotChainstate()\n     return true;\n }\n \n+ChainstateRole Chainstate::GetRole() const\n+{\n+    if (m_chainman.GetAll().size() <= 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331258939",
      "id" : 1331258939,
      "line" : 5871,
      "node_id" : "PRRC_kwDOABII585PWWY7",
      "original_commit_id" : "6d5aca2340f85d4bace786463ac8f33d8d579d7f",
      "original_line" : 5815,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 415,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331258939/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331258939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331521797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331521797"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add feature_assumeutxo functional test\" (7deed0f9f05e9efc9526bc419c7f0a887f991d1f)\r\n\r\nTest seems to have pretty good coverage for the happy case, but it would be good to have coverage for pathological cases to make sure checks in the code written to handle them work correctly.\r\n\r\nIt should be possible to write a test using `itertools.product` or something similar to test different cases and starting states.\r\n\r\nInteresting test cases could be loading an assumeutxo snapshot file with:\r\n\r\n1. An invalid hash\r\n2. Valid hash but invalid snapshot file (bad coin height or truncated file or bad other serialization)\r\n3. Valid snapshot file, but referencing an unknown block\r\n4. Valid snapshot file, but referencing a snapshot block that turns out to be invalid, or has an invalid parent\r\n5. Valid snapshot file and snapshot block, but the block is not on the most-work chain\r\n\r\nInteresting starting states could be loading a snapshot when the current chain tip is:\r\n\r\n1. An ancestor of snapshot block                                                                                                                                                      \r\n2. Not an ancestor of the snapshot block but has less work\r\n3. The snapshot block\r\n4. A descendant of the snapshot block\r\n5. Not an ancestor or a descendant of the snapshot block and has more work\r\n\r\nMost combinations of test cases / starting states above should be possible. I don't think a test like this needs to be part of this PR, but would be nice as a followup. It might make sense to include a consolidated TODO comment in this PR documenting ways the test could be improved (also mentioning other test ideas\r\nhttps://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325243993\r\nhttps://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325246788)",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T11:58:35Z",
      "diff_hunk" : "@@ -0,0 +1,223 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331521797",
      "id" : 1331521797,
      "line" : 47,
      "node_id" : "PRRC_kwDOABII585PXWkF",
      "original_commit_id" : "7deed0f9f05e9efc9526bc419c7f0a887f991d1f",
      "original_line" : 47,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 47,
      "pull_request_review_id" : 1635464665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331521797/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T13:01:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331521797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK (probably already did that in the previous incarnation).\r\n\r\nAfter some offline discussion, I'd like to suggest that we replace 3ed4f1f8ddbe39a2ecacb0d73e174ffd77efbe00 with a commit that adds params for testnet and signet, but not for mainnet. I made a note to generate snapshots and torrents for these.\r\n\r\nThis allows anyone to test the full functionality without a recompile on these test networks. And anyone who knows how to compile can test it on mainnet.\r\n\r\nAdding the first mainnet hash can be done in a later more focussed PR (easier to review for more people). I also think we should use that opportunity to reevaluate the trade-off between committing to a snapshot in the code or having the RPC accept anything (file + checksum argument). The latter would allow anyone to create and promote fake snapshots, but the former could motivate someone to release a compromised binary by claiming they \"only changed the hash, so it's faster\".\r\n\r\nI still plan to review the full code of this PR, but not sure when.",
      "created_at" : "2023-09-20T14:28:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1727846633",
      "id" : 1727846633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585m_Njp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727846633/reactions"
      },
      "updated_at" : "2023-09-20T14:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727846633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> After some offline discussion, I'd like to suggest that we replace https://github.com/bitcoin/bitcoin/commit/3ed4f1f8ddbe39a2ecacb0d73e174ffd77efbe00 with a commit that adds params for testnet and signet, but not for mainnet.\r\n>\r\n> I also think we should use that opportunity to reevaluate the trade-off between committing to a snapshot in the code or having the RPC accept anything (file + checksum argument).\r\n\r\nI'm happy to merge a regtest/signet-only activated version of this PR and defer mainnet parameters. Though it's worth noting that, as it stands, to use this feature you have to know how to interact with the RPC interface - so from that standpoint it still feels pretty opt-in to me.\r\n\r\nWhat I'm not happy to do is rebase this PR for the next few months while we decide on what the latest iteration of the conceptually-perfect approach is with little new information from the last 3 years. I'm about done working on this feature - I have other things I'd like to do - and given the broad nature of the changes here, the rebase burden is pretty hefty.\r\n\r\nI'm not saying we shortcircuit review, but if faced with the prospect of rebasing indefinitely without some kind of concerted effort to actually get this functionality in, I'll probably just close this PR and let someone else pick it up if/when the feature actually matters enough to clear the activation-energy-hurdle of this project.",
      "created_at" : "2023-09-20T14:37:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1727862849",
      "id" : 1727862849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585m_RhB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727862849/reactions"
      },
      "updated_at" : "2023-09-20T14:37:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727862849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I also prefer to merge this and then change things later. By leaving the mainnet params empty, I suspect it will be easier to get this merged. I think it's fine to e.g. change from a hardcoded chain param to an RPC method later, that shouldn't involve any rebase on your end. ",
      "created_at" : "2023-09-20T15:05:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1727914355",
      "id" : 1727914355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585m_eFz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727914355/reactions"
      },
      "updated_at" : "2023-09-20T15:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727914355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree with Sjors it would be good to move commit 3ed4f1f8ddbe39a2ecacb0d73e174ffd77efbe00 to another PR. I think there is value in getting the assumeutxo feature and bugfixes here merged so they can be tested by developers and users who are able to tweak the source and experiment. Adding the literal block and snapshot hashes for block 788,000 to the source code seems like a separate thing that would be easy to do later.\r\n\r\n(Also, in terms of review, I acked the PR but didn't spend much time looking at commit 3ed4f1f8ddbe39a2ecacb0d73e174ffd77efbe00, and I didn't verify the hash values).\r\n\r\nI have some notes about the offline discussion sjors referenced which I'll paste below. I don't think the discussion covered anything new, just familiar topics. I think the main takeaway is that the code is in good shape and once it is merged we should be able to make incremental progress rolling the feature out.\r\n\r\n---\r\n\r\n### assumeUTXO Update Discussion\r\n\r\n* One remaining PR\r\n   * https://github.com/bitcoin/bitcoin/pull/27596\r\n   * Adds loadtxoutset and getchainstate RPC, documentation, scripts, tests\r\n   * Adds critical functionality needed for assumeutxo validation to work: net processing updates, validation interface updates, verifydb bugfix, cache rebalancing\r\n   * Makes other improvements so pruning, indexing, -reindex features are compatible with assumeutxo and work nicely\r\n   * Adds hardcoded assumeutxo hash at height 788,000\r\n      * Probably this should be moved to separate PR?\r\n* Questions about initial next steps (unanswered):\r\n   * Which release is this PRed target for?\r\n   * Does it make sense to merge code changes first, then hash later?\r\n   * Maybe staged rollout makes sense? First merge code changes, then merge hash, then distribute snapshots?\r\n      * Assumeutxo is a new feature which needs testing.\r\n      * Start by merging functionality but require modifying source to actually use it.\r\n      * Then add hardcoded hash and let binary users create snapshots, verify snapshots, and load snapshots.\r\n      * Later work on distributing snapshot files, making the feature more accessible.\r\n* Longer term questions\r\n   * Should snapshots hash be configurable, allowed to be specified on command line?\r\n      * Potentially risky to allow but not allowing might incentivize using unofficial builds\r\n   * Should other hashes by added or supported?\r\n      * Muhash would make it a easier for someone running a node to verify snapshot hashes hardcoded in source code are correct, because no it will no longer require rolling back chainstate\r\n      * Bittorrent infohash could be distributed outside of source so user can know they are using the right torrent without having to download the whole thing and try to load it with the RPC\r\n   * Should hashes eventually be removed from source code?\r\n      * Having snapshot hashes could be considered a regression, since we are in the process of removing checkpoint hashes\r\n      * Having snapshot hashes potentially incentivizes modified Bitcoin Core binaries that provide more recent snapshots that could be malicious\r\n   * Should source code contain only one snapshot hash, or historical snapshots?\r\n   * Concerns about no one validating the hash\r\n      * Future Bitcoin developers could provide invalid hashes\r\n      * The attack would be a public, non stealth attack\r\n      * Switching to muhash could make it easier for more people to verify the hash\r\n   * P2P way of distributing snapshots and hashes separate from source distribution\r\n      * Have a new hash every 50,000 block\r\n      * Or some other fixed N blocks\r\n      * Release would have the most recent one\r\n      * One of the original ideas was distributing over the P2P network\r\n* Misc\r\n   * Reliability of stop at height\r\n      * Jameobâs makesnapshot script resolves this",
      "created_at" : "2023-09-20T15:17:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1727936044",
      "id" : 1727936044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585m_jYs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727936044/reactions"
      },
      "updated_at" : "2023-09-20T15:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1727936044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331808617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331808617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T15:26:01Z",
      "diff_hunk" : "@@ -97,6 +97,34 @@ struct PruneLockInfo {\n     int height_first{std::numeric_limits<int>::max()}; //! Height of earliest block that should be kept and not pruned\n };\n \n+enum BlockfileType {\n+    // Values used as array indexes - do not change carelessly.\n+    NORMAL = 0,\n+    ASSUMED = 1,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331808617",
      "id" : 1331808617,
      "in_reply_to_id" : 1329992346,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585PYclp",
      "original_commit_id" : "f7f446f750146d74114e72b27c6cba0bf59473bb",
      "original_line" : 103,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 15,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331808617/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331808617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331819174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331819174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It seems like it would be better to verify that the snapshot block has more work than the chain tip\r\n\r\nYep, good point. Fixed.\r\n\r\nI've refactored the structure a bit to perform all checks (work comparison, blockhash file write) atomically w.r.t. cs_main and the chainstate swaps.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T15:33:29Z",
      "diff_hunk" : "@@ -5238,6 +5238,18 @@ bool ChainstateManager::ActivateSnapshot(\n             snapshot_ok = false;\n         }\n     }\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually at a more\n+    // advanced height than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    {\n+        LOCK(::cs_main);\n+        if (snapshot_chainstate->m_chain.Height() <= ActiveHeight()) {\n+            LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");\n+            snapshot_ok = false;\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331819174",
      "id" : 1331819174,
      "in_reply_to_id" : 1330422758,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PYfKm",
      "original_commit_id" : "f09536af610b8eaca13f38e24825b5f62f55c968",
      "original_line" : 5251,
      "original_position" : 14,
      "original_start_line" : 5242,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331819174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331819174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331862702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331862702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed to work comparison and added an explanatory comment, thanks. Have also made you co-author of this commit since conceptually a lot of it is yours.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T15:54:47Z",
      "diff_hunk" : "@@ -5339,6 +5351,11 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    if (au_data.height <= WITH_LOCK(::cs_main, return ActiveHeight())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331862702",
      "id" : 1331862702,
      "in_reply_to_id" : 1330426193,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PYpyu",
      "original_commit_id" : "f09536af610b8eaca13f38e24825b5f62f55c968",
      "original_line" : 5354,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331862702/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331862702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331925624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331925624"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T16:47:09Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained sources \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331925624",
      "id" : 1331925624,
      "in_reply_to_id" : 1330505053,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY5J4",
      "original_commit_id" : "ef7da5ffce66afa7c3e5f7b3951ecbf0b5f4fe57",
      "original_line" : 2715,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331925624/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331925624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331927201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331927201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, and made you co-author since at this point a lot of your ideas (and words) are in this commit.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T16:48:37Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"a traditional initial block download chainstate\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"a chainstate that is assumed valid based upon a UTXO snapshot\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331927201",
      "id" : 1331927201,
      "in_reply_to_id" : 1330506362,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY5ih",
      "original_commit_id" : "8a69ed3425bf807625f15d0d3f910d5cabfc4c24",
      "original_line" : 2822,
      "original_position" : 24,
      "original_start_line" : 2821,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331927201/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331927201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331929870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Interesting test cases could be loading an assumeutxo snapshot file with:\r\n\r\nAs you probably know, a lot of these cases are already covered by the unittests. I definitely agree it would be nice to test them from within the functional tests, but actually generating such invalid snapshots will require some thought.\r\n\r\nI've consolidated all the TODOs in the test's docstring.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-20T16:51:16Z",
      "diff_hunk" : "@@ -0,0 +1,223 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331929870",
      "id" : 1331929870,
      "in_reply_to_id" : 1331521797,
      "line" : 47,
      "node_id" : "PRRC_kwDOABII585PY6MO",
      "original_commit_id" : "7deed0f9f05e9efc9526bc419c7f0a887f991d1f",
      "original_line" : 47,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 47,
      "pull_request_review_id" : 1635926855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929870/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332550768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332550768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8cfd27186d7f54c03e7cf928b4723608a39c656b\r\n\r\nnit: What's the use of exposing this to the caller? I'd rather return {0, 0} in this case after handling it internally. Unless the caller needs to know.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T06:43:54Z",
      "diff_hunk" : "@@ -1245,6 +1241,19 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! start > end is possible, meaning no blocks can be pruned.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332550768",
      "id" : 1332550768,
      "line" : 1245,
      "node_id" : "PRRC_kwDOABII585PbRxw",
      "original_commit_id" : "8cfd27186d7f54c03e7cf928b4723608a39c656b",
      "original_line" : 1246,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 104,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332550768/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332550768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332552609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332552609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8cfd27186d7f54c03e7cf928b4723608a39c656b\r\n\r\nIs this addressed to the caller of this function? If yes, it's not 100% clear why this is the case.\r\nI think the potential issue here better be expanded.\r\n\r\nAnd then, can't this be handled internally then?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T06:45:58Z",
      "diff_hunk" : "@@ -1245,6 +1241,19 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! start > end is possible, meaning no blocks can be pruned.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332552609",
      "id" : 1332552609,
      "line" : 1248,
      "node_id" : "PRRC_kwDOABII585PbSOh",
      "original_commit_id" : "8cfd27186d7f54c03e7cf928b4723608a39c656b",
      "original_line" : 1249,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 107,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332552609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332552609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332554860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332554860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a7a5debb6a6bdc4f7217050e043cebb1c6e0d33a\r\n\r\n`estiamted` still not fixed",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T06:48:23Z",
      "diff_hunk" : "@@ -265,13 +265,26 @@ CBlockIndex* BlockManager::InsertBlockIndex(const uint256& hash)\n     return pindex;\n }\n \n-bool BlockManager::LoadBlockIndex()\n+bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n {\n     if (!m_block_tree_db->LoadBlockIndexGuts(\n             GetConsensus(), [this](const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this->InsertBlockIndex(hash); }, m_interrupt)) {\n         return false;\n     }\n \n+    int snapshot_height = -1;\n+    if (snapshot_blockhash) {\n+        const AssumeutxoData au_data = *Assert(GetParams().AssumeutxoForBlockhash(*snapshot_blockhash));\n+        snapshot_height = au_data.height;\n+        CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n+\n+        // Since nChainTx (responsible for estiamted progress) isn't persisted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332554860",
      "id" : 1332554860,
      "in_reply_to_id" : 1323352284,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PbSxs",
      "original_commit_id" : "e3cae85738c8bf4116547af8d868c6c01577b80f",
      "original_line" : 281,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332554860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332554860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332568561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332568561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a7a5debb6a6bdc4f7217050e043cebb1c6e0d33a\r\n\r\nwhat's the use of this Assert? it is implied by `if (pindex->nTx > 0) {` above i guess.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T07:02:02Z",
      "diff_hunk" : "@@ -401,7 +414,11 @@ bool BlockManager::LoadBlockIndex()\n         // Pruned nodes may have deleted the block.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->nChainTx > 0) {\n+                if (snapshot_blockhash && pindex->nHeight == snapshot_height &&\n+                        pindex->GetBlockHash() == *snapshot_blockhash) {\n+                    // Should have been set above; don't disturb it with code below.\n+                    Assert(pindex->nChainTx > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332568561",
      "id" : 1332568561,
      "line" : 427,
      "node_id" : "PRRC_kwDOABII585PbWHx",
      "original_commit_id" : "a7a5debb6a6bdc4f7217050e043cebb1c6e0d33a",
      "original_line" : 420,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 174,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332568561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332568561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332571729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332571729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, fixed later in bd770ff59075fa2fd0441311ef1c02439ed68fdd",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T07:05:18Z",
      "diff_hunk" : "@@ -265,13 +265,26 @@ CBlockIndex* BlockManager::InsertBlockIndex(const uint256& hash)\n     return pindex;\n }\n \n-bool BlockManager::LoadBlockIndex()\n+bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n {\n     if (!m_block_tree_db->LoadBlockIndexGuts(\n             GetConsensus(), [this](const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this->InsertBlockIndex(hash); }, m_interrupt)) {\n         return false;\n     }\n \n+    int snapshot_height = -1;\n+    if (snapshot_blockhash) {\n+        const AssumeutxoData au_data = *Assert(GetParams().AssumeutxoForBlockhash(*snapshot_blockhash));\n+        snapshot_height = au_data.height;\n+        CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n+\n+        // Since nChainTx (responsible for estiamted progress) isn't persisted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332571729",
      "id" : 1332571729,
      "in_reply_to_id" : 1323352284,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PbW5R",
      "original_commit_id" : "e3cae85738c8bf4116547af8d868c6c01577b80f",
      "original_line" : 281,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332571729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332571729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332579498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332579498"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bd770ff59075fa2fd0441311ef1c02439ed68fdd\r\n\r\nnit: return here is confusing.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T07:12:34Z",
      "diff_hunk" : "@@ -705,15 +724,34 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+BlockfileType BlockManager::BlockfileTypeForHeight(int height)\n+{\n+    if (!m_snapshot_height) {\n+        return BlockfileType::NORMAL;\n+    }\n+    return (height >= *m_snapshot_height) ? BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(int tip_height)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\n+    if (cursor) {\n+        // The cursor may not exist after a snapshot has been loaded but before any\n+        // blocks have been downloaded.\n+        return FlushBlockFile(cursor->file_num, /*fFinalize=*/false, /*finalize_undo=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332579498",
      "id" : 1332579498,
      "line" : 753,
      "node_id" : "PRRC_kwDOABII585PbYyq",
      "original_commit_id" : "bd770ff59075fa2fd0441311ef1c02439ed68fdd",
      "original_line" : 753,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 291,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332579498/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332579498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332580222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332580222"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bd770ff59075fa2fd0441311ef1c02439ed68fdd\r\n\r\nI agree with this suggested change.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T07:13:10Z",
      "diff_hunk" : "@@ -583,15 +623,30 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+static BlockfileType BlockfileTypeForRole(ChainstateRole chainstate_role)\n+{\n+    return chainstate_role == ChainstateRole::ASSUMEDVALID ?\n+        BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(ChainstateRole chainstate_role, bool finalize, bool finalize_undo)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForRole(chainstate_role)];\n+    if (cursor) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332580222",
      "id" : 1332580222,
      "in_reply_to_id" : 1310990937,
      "line" : 750,
      "node_id" : "PRRC_kwDOABII585PbY9-",
      "original_commit_id" : "1c668b690eeb4b98899be7e0ff33373b79932f2a",
      "original_line" : 750,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 288,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332580222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332580222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332985164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332985164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0f34fc74a7cf738167d788616fc9a24a581bc9fb\r\n\r\nthis is technically not necessary because we override it on the next line anyway, right?",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T12:37:23Z",
      "diff_hunk" : "@@ -5744,16 +5750,22 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n         fs::PathToString(*path));\n \n-    this->ActivateExistingSnapshot(mempool, *base_blockhash);\n+    this->ActivateExistingSnapshot(*base_blockhash);\n     return true;\n }\n \n-Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)\n+Chainstate& ChainstateManager::ActivateExistingSnapshot(uint256 base_blockhash)\n {\n     assert(!m_snapshot_chainstate);\n     m_snapshot_chainstate =\n-        std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n+        std::make_unique<Chainstate>(nullptr, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n+\n+    // Mempool is empty at this point because we're still in IBD.\n+    Assert(m_active_chainstate->m_mempool->size() == 0);\n+    Assert(!m_snapshot_chainstate->m_mempool);\n+    m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n+    m_active_chainstate->m_mempool = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332985164",
      "id" : 1332985164,
      "line" : 5791,
      "node_id" : "PRRC_kwDOABII585Pc71M",
      "original_commit_id" : "0f34fc74a7cf738167d788616fc9a24a581bc9fb",
      "original_line" : 5768,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 363,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332985164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332985164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332991240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332991240"
         }
      },
      "author_association" : "MEMBER",
      "body" : "126d7171a75c3a9ef4bbbb6687ba2c95fcf6750a\r\n\r\ntypo: `chainstate`",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T12:41:59Z",
      "diff_hunk" : "@@ -5256,30 +5245,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");\n+    }\n+    // If not in-memory, persist the base blockhash for use during subsequent\n+    // initialization.\n+    if (!in_memory) {\n+        if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {\n+            return cleanup_bad_snapshot(\"could not write base blockhash\");\n+        }\n     }\n+\n+    assert(!m_snapshot_chainstate);\n+    m_snapshot_chainstate.swap(snapshot_chainstate);\n+    const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n+    assert(chaintip_loaded);\n+\n+    // Transfer possession of the mempool to the snapshot chianstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332991240",
      "id" : 1332991240,
      "line" : 5284,
      "node_id" : "PRRC_kwDOABII585Pc9UI",
      "original_commit_id" : "126d7171a75c3a9ef4bbbb6687ba2c95fcf6750a",
      "original_line" : 5276,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 282,
      "pull_request_review_id" : 1634958794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332991240/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T12:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332991240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333155611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333155611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332568561\r\n\r\n> [a7a5deb](https://github.com/bitcoin/bitcoin/commit/a7a5debb6a6bdc4f7217050e043cebb1c6e0d33a)\r\n> \r\n> what's the use of this Assert? it is implied by `if (pindex->nTx > 0) {` above i guess.\r\n\r\nOne use would be if someone modifies the `base->nChainTx = au_data.nChainTx` code earlier in this function and accidentally breaks it. The Assert could trigger and make it easier to debug the problem.\r\n",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T14:29:46Z",
      "diff_hunk" : "@@ -401,7 +414,11 @@ bool BlockManager::LoadBlockIndex()\n         // Pruned nodes may have deleted the block.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->nChainTx > 0) {\n+                if (snapshot_blockhash && pindex->nHeight == snapshot_height &&\n+                        pindex->GetBlockHash() == *snapshot_blockhash) {\n+                    // Should have been set above; don't disturb it with code below.\n+                    Assert(pindex->nChainTx > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333155611",
      "id" : 1333155611,
      "in_reply_to_id" : 1332568561,
      "line" : 427,
      "node_id" : "PRRC_kwDOABII585Pdlcb",
      "original_commit_id" : "a7a5debb6a6bdc4f7217050e043cebb1c6e0d33a",
      "original_line" : 420,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 174,
      "pull_request_review_id" : 1637992647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333155611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T15:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333155611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333171036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333171036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332552609\r\n\r\n> [8cfd271](https://github.com/bitcoin/bitcoin/commit/8cfd27186d7f54c03e7cf928b4723608a39c656b)\r\n> \r\n> Is this addressed to the caller of this function? If yes, it's not 100% clear why this is the case. I think the potential issue here better be expanded.\r\n> \r\n> And then, can't this be handled internally then?\r\n\r\nAgree this is a little confusing. I think it is handled internally and the comment is just describing how the return range is determined. Probably it could be made a little clearer.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T14:36:29Z",
      "diff_hunk" : "@@ -1245,6 +1241,19 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! start > end is possible, meaning no blocks can be pruned.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333171036",
      "id" : 1333171036,
      "in_reply_to_id" : 1332552609,
      "line" : 1248,
      "node_id" : "PRRC_kwDOABII585PdpNc",
      "original_commit_id" : "8cfd27186d7f54c03e7cf928b4723608a39c656b",
      "original_line" : 1249,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 107,
      "pull_request_review_id" : 1637992647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333171036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T15:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333171036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333204587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333204587"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1332550768\r\n\r\n> [8cfd271](https://github.com/bitcoin/bitcoin/commit/8cfd27186d7f54c03e7cf928b4723608a39c656b)\r\n> \r\n> nit: What's the use of exposing this to the caller? I'd rather return {0, 0} in this case after handling it internally. Unless the caller needs to know.\r\n\r\nI suggested adding this comment. I thought it was important to clarify how an empty prune range would be represented, because with an inclusive [start, end] style range, it is not really obvious. By definition, returning {0,0} would mean \"prune the genesis block\", not \"prune no blocks\". The distinction is actually meaningful because it turns out this function does need to return {0, 0} and prune the genesis block. Otherwise pruning is less effective and tests fail: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1309300988\r\n\r\nOne way to represent empty ranges more straightforwardly would be to switch to a half-open [start, end) range style, but I think either style is fine as long as it's documented clearly.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-21T14:56:39Z",
      "diff_hunk" : "@@ -1245,6 +1241,19 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! start > end is possible, meaning no blocks can be pruned.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1333204587",
      "id" : 1333204587,
      "in_reply_to_id" : 1332550768,
      "line" : 1245,
      "node_id" : "PRRC_kwDOABII585PdxZr",
      "original_commit_id" : "8cfd27186d7f54c03e7cf928b4723608a39c656b",
      "original_line" : 1246,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 104,
      "pull_request_review_id" : 1637992647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333204587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-21T15:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1333204587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Chainparams for testnet and signet are here #28516, also links to a branch with mainnet chainparams for 800,000. ",
      "created_at" : "2023-09-21T15:25:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1729810102",
      "id" : 1729810102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nGs62",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729810102/reactions"
      },
      "updated_at" : "2023-09-21T15:25:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729810102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "IRC meeting mentioned that this might be ready for merge. I think it could use some more review, but would be helpful to know:\r\n\r\n- Who else is planning to review this\r\n- Whether it would be ok to merge before the 26.0 feature freeze\r\n- Whether there are any objections to merging this in its current form\r\n\r\nCurrent PR (32b797f37ecd25b0cda5a0ab927852bcd3284500) adds the `loadtxoutset` RPC but it still can't be called on mainnet without modifying the source to add the snapshot hash.",
      "created_at" : "2023-09-28T14:29:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1739365466",
      "id" : 1739365466,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nrJxa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739365466/reactions"
      },
      "updated_at" : "2023-09-28T14:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739365466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Who else is planning to review this\r\n\r\nI will review it early next week (unless it's merged before).",
      "created_at" : "2023-09-28T14:53:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1739437788",
      "id" : 1739437788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nrbbc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739437788/reactions"
      },
      "updated_at" : "2023-09-28T14:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739437788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If we want to merge it before 26.0 then the main review priority should be to ensure it can't break non-snapshot IBD. Generally I think it's safer to merge this after the branch-off so it can stew in master for a bit.\r\n\r\nIf we do merge it earlier, then we should also merge #28516; there's no point in (slightly) increasing the risk if there's no benefit. Without that PR the new functionality can only be tested with a recompile, which you might as well do on master.\r\n\r\nI also still plan to review it.",
      "created_at" : "2023-09-28T14:53:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1739438212",
      "id" : 1739438212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nrbiE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739438212/reactions"
      },
      "updated_at" : "2023-09-28T14:53:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739438212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it could use some more review\r\n\r\nI agree, I assumed that @pablomartin4btc 's ACK was on the latest version, two ACKs on the latest version is not enough. I am re-reviewing this week. And I agree with Sjors we should also get #28516 in.",
      "created_at" : "2023-09-28T15:15:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1739501274",
      "id" : 1739501274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nrq7a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739501274/reactions"
      },
      "updated_at" : "2023-09-28T15:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739501274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I assumed that @pablomartin4btc 's ACK was on the latest version\r\n\r\n@fjahr, no, sorry, was on a previous one, and as I mentioned, something I noticed was that at the very end of the process, the node/ `bitcoind` was unresponsive and the `cli` commands (eg `getchainstates`) were giving timeout, until it seems it got unstuck and it was finally synced to the tip, not sure if it was during the flushing to disk. \r\n\r\nI'll re-test on the latest asap and will provide more details. ",
      "created_at" : "2023-09-28T23:18:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1740115240",
      "id" : 1740115240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nuA0o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1740115240/reactions"
      },
      "updated_at" : "2023-09-28T23:18:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1740115240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/110166421?v=4",
         "events_url" : "https://api.github.com/users/pablomartin4btc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pablomartin4btc/followers",
         "following_url" : "https://api.github.com/users/pablomartin4btc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pablomartin4btc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pablomartin4btc",
         "id" : 110166421,
         "login" : "pablomartin4btc",
         "node_id" : "U_kgDOBpEBlQ",
         "organizations_url" : "https://api.github.com/users/pablomartin4btc/orgs",
         "received_events_url" : "https://api.github.com/users/pablomartin4btc/received_events",
         "repos_url" : "https://api.github.com/users/pablomartin4btc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pablomartin4btc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pablomartin4btc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pablomartin4btc"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Who else is planning to review this\r\n\r\nI am currently testing the latest commit https://github.com/bitcoin/bitcoin/commit/32b797f37ecd25b0cda5a0ab927852bcd3284500\r\n\r\nAnd to be clear we are now testing on `signet` and `testnet` only?\r\n\r\n`mainnet` testing will happen on https://github.com/bitcoin/bitcoin/pull/28516 ?",
      "created_at" : "2023-09-29T16:29:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1741178883",
      "id" : 1741178883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nyEgD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741178883/reactions"
      },
      "updated_at" : "2023-09-29T16:29:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741178883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/111142327?v=4",
         "events_url" : "https://api.github.com/users/D33r-Gee/events{/privacy}",
         "followers_url" : "https://api.github.com/users/D33r-Gee/followers",
         "following_url" : "https://api.github.com/users/D33r-Gee/following{/other_user}",
         "gists_url" : "https://api.github.com/users/D33r-Gee/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/D33r-Gee",
         "id" : 111142327,
         "login" : "D33r-Gee",
         "node_id" : "U_kgDOBp_ltw",
         "organizations_url" : "https://api.github.com/users/D33r-Gee/orgs",
         "received_events_url" : "https://api.github.com/users/D33r-Gee/received_events",
         "repos_url" : "https://api.github.com/users/D33r-Gee/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/D33r-Gee/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/D33r-Gee/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/D33r-Gee"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-29T18:54:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1741348711",
      "id" : 1741348711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nyt9n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741348711/reactions"
      },
      "updated_at" : "2023-09-29T18:54:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741348711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> And to be clear we are now testing on `signet` and `testnet` only?\r\n> \r\n> `mainnet` testing will happen on #28516 ?\r\n\r\nYes, it probably does make a little more sense to test on signet and testnet for now, but any testing should be useful if you're calling the rpcs, restarting, interrupting, reindexing, etc. #28516 should be useful testing signet and testnet since it adds those hashes",
      "created_at" : "2023-09-29T19:08:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1741363606",
      "id" : 1741363606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nyxmW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741363606/reactions"
      },
      "updated_at" : "2023-09-29T19:08:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741363606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Yes, it probably does make a little more sense to test on signet and testnet for now, but any testing should be useful if you're calling the rpcs, restarting, interrupting, reindexing, etc. #28516 should be useful testing signet and testnet since it adds those hashes\r\n\r\nGreat, thanks for clarifying, I'll go ahead and test the whole workflow at the current commit and post results here\r\n\r\nThen will test #28516 and post results there",
      "created_at" : "2023-09-30T00:41:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1741606642",
      "id" : 1741606642,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585nzs7y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741606642/reactions"
      },
      "updated_at" : "2023-09-30T00:41:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741606642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/111142327?v=4",
         "events_url" : "https://api.github.com/users/D33r-Gee/events{/privacy}",
         "followers_url" : "https://api.github.com/users/D33r-Gee/followers",
         "following_url" : "https://api.github.com/users/D33r-Gee/following{/other_user}",
         "gists_url" : "https://api.github.com/users/D33r-Gee/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/D33r-Gee",
         "id" : 111142327,
         "login" : "D33r-Gee",
         "node_id" : "U_kgDOBp_ltw",
         "organizations_url" : "https://api.github.com/users/D33r-Gee/orgs",
         "received_events_url" : "https://api.github.com/users/D33r-Gee/received_events",
         "repos_url" : "https://api.github.com/users/D33r-Gee/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/D33r-Gee/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/D33r-Gee/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/D33r-Gee"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'll go ahead and test the whole workflow at the current commit and post results here\r\n\r\n> Then will test https://github.com/bitcoin/bitcoin/pull/28516 and post results there\r\n\r\nYou'll need #28516 to test most of the changes introduced here. Otherwise you can only test that nothing changed when you _don't_ load a snapshot (which is also important).\r\n\r\nThe reason the hashes are in a separate PR is to save @jamesob some work on having to maintain them. And also because the hashes themselves are much easier to review than this pull request, so I'd like to see (many) more people do that - without creating too much noise on this PR.\r\n\r\nThe PR contains a link to mainnet parameters as well. Since you're able to compile code, you can also test with that. Mainnet params are only kept seperate because we're not ready to ship them (in my opinion), but they're certainly ready for testing.",
      "created_at" : "2023-09-30T07:01:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1741699148",
      "id" : 1741699148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n0DhM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741699148/reactions"
      },
      "updated_at" : "2023-09-30T07:03:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741699148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341937735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341937735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, because that chainstate will still be used as the `m_ibd_chainstate`.",
      "commit_id" : "32b797f37ecd25b0cda5a0ab927852bcd3284500",
      "created_at" : "2023-09-30T09:41:30Z",
      "diff_hunk" : "@@ -5744,16 +5750,22 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n         fs::PathToString(*path));\n \n-    this->ActivateExistingSnapshot(mempool, *base_blockhash);\n+    this->ActivateExistingSnapshot(*base_blockhash);\n     return true;\n }\n \n-Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)\n+Chainstate& ChainstateManager::ActivateExistingSnapshot(uint256 base_blockhash)\n {\n     assert(!m_snapshot_chainstate);\n     m_snapshot_chainstate =\n-        std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n+        std::make_unique<Chainstate>(nullptr, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n+\n+    // Mempool is empty at this point because we're still in IBD.\n+    Assert(m_active_chainstate->m_mempool->size() == 0);\n+    Assert(!m_snapshot_chainstate->m_mempool);\n+    m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n+    m_active_chainstate->m_mempool = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341937735",
      "id" : 1341937735,
      "in_reply_to_id" : 1332985164,
      "line" : 5791,
      "node_id" : "PRRC_kwDOABII585P_FhH",
      "original_commit_id" : "0f34fc74a7cf738167d788616fc9a24a581bc9fb",
      "original_line" : 5768,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 363,
      "pull_request_review_id" : 1651670387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341937735/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T09:41:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341937735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341938065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341938065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. Removed this outdated comment (not sure it was ever actually correct).",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T09:45:17Z",
      "diff_hunk" : "@@ -5786,6 +5791,23 @@ util::Result<void> Chainstate::InvalidateCoinsDBOnDisk()\n     return {};\n }\n \n+bool ChainstateManager::DeleteSnapshotChainstate()\n+{\n+    AssertLockHeld(::cs_main);\n+    Assert(m_snapshot_chainstate);\n+    Assert(m_ibd_chainstate);\n+\n+    fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*m_snapshot_chainstate);\n+    if (!DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true)) {\n+        LogPrintf(\"Deletion of %s failed. Please remove it manually to continue reindexing.\\n\",\n+                  fs::PathToString(snapshot_datadir));\n+        return false;\n+    }\n+    m_active_chainstate = m_ibd_chainstate.get();\n+    m_snapshot_chainstate.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341938065",
      "id" : 1341938065,
      "in_reply_to_id" : 1331240905,
      "line" : 5868,
      "node_id" : "PRRC_kwDOABII585P_FmR",
      "original_commit_id" : "00129799d97c746e77d929c323b689aae72b46b2",
      "original_line" : 5868,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 409,
      "pull_request_review_id" : 1651670722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341938065/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T10:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341938065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed this comment as it's internal logic not relevant to the caller.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T10:38:25Z",
      "diff_hunk" : "@@ -1245,6 +1241,19 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! start > end is possible, meaning no blocks can be pruned.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943097",
      "id" : 1341943097,
      "in_reply_to_id" : 1332552609,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P_G05",
      "original_commit_id" : "8cfd27186d7f54c03e7cf928b4723608a39c656b",
      "original_line" : 1249,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1651670722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T10:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T10:39:12Z",
      "diff_hunk" : "@@ -5256,30 +5245,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");\n+    }\n+    // If not in-memory, persist the base blockhash for use during subsequent\n+    // initialization.\n+    if (!in_memory) {\n+        if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {\n+            return cleanup_bad_snapshot(\"could not write base blockhash\");\n+        }\n     }\n+\n+    assert(!m_snapshot_chainstate);\n+    m_snapshot_chainstate.swap(snapshot_chainstate);\n+    const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n+    assert(chaintip_loaded);\n+\n+    // Transfer possession of the mempool to the snapshot chianstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943153",
      "id" : 1341943153,
      "in_reply_to_id" : 1332991240,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P_G1x",
      "original_commit_id" : "126d7171a75c3a9ef4bbbb6687ba2c95fcf6750a",
      "original_line" : 5276,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1651670722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T10:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T10:39:37Z",
      "diff_hunk" : "@@ -892,6 +892,38 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /** Request blocks for the background chainstate, if one is in use. */\n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /**\n+    * \\brief Find next blocks to download from a peer after a starting block.\n+    *\n+    * \\param vBlocks      Vector of blocks to download which will be appended to.\n+    * \\param peer         ID of peer which blocks will be downloaded from.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341943181",
      "id" : 1341943181,
      "in_reply_to_id" : 1331194085,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P_G2N",
      "original_commit_id" : "a9ea542e8aed092f45dab2d9a66da56aba742f51",
      "original_line" : 902,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1651670722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T10:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341943181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341985254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341985254"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Should be above `utility`",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T16:33:37Z",
      "diff_hunk" : "@@ -69,6 +69,7 @@\n #include <optional>\n #include <string>\n #include <utility>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341985254",
      "id" : 1341985254,
      "line" : 72,
      "node_id" : "PRRC_kwDOABII585P_RHm",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 72,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341985254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341985254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341994207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341994207"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, since there is still only one BlockManager I guess the two chainstate cursors block each other by holding this lock. That seems unnecessary and could be improved in a follow-up, giving each cursor it's own lock, I think.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T18:11:51Z",
      "diff_hunk" : "@@ -499,6 +508,15 @@ bool BlockManager::LoadBlockIndexDB(const std::optional<uint256>& snapshot_block\n         }\n     }\n \n+    {\n+        // Initialize the blockfile cursors.\n+        LOCK(cs_LastBlockFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341994207",
      "id" : 1341994207,
      "line" : 513,
      "node_id" : "PRRC_kwDOABII585P_TTf",
      "original_commit_id" : "7fcd21544a333ffdf1910b65c573579860be6a36",
      "original_line" : 513,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 224,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341994207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341994207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341995611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341995611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's kind of confusing that here in the results the ibd chainstate is also called normal. It might be good to add a comment on that.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T18:28:37Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"coins_db_cache_bytes\",  cs.m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs.m_coinstip_cache_size_bytes);\n+        if (cs.m_from_snapshot_blockhash) {\n+            data.pushKV(\"snapshot_blockhash\", cs.m_from_snapshot_blockhash->ToString());\n+        }\n+        return data;\n+    };\n+\n+    if (chainman.GetAll().size() > 1) {\n+        for (Chainstate* chainstate : chainman.GetAll()) {\n+            obj.pushKV(\n+                chainstate->m_from_snapshot_blockhash ? \"snapshot\" : \"normal\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341995611",
      "id" : 1341995611,
      "line" : 2861,
      "node_id" : "PRRC_kwDOABII585P_Tpb",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2861,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 170,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341995611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341995611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341996092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341996092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The normal chainstate (aka ibd maybe) is always present, right? So it would not be  `/*optional=*/true`.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T18:34:01Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341996092",
      "id" : 1341996092,
      "line" : 2821,
      "node_id" : "PRRC_kwDOABII585P_Tw8",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2821,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 130,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341996092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341996092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342009057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342009057"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could adapt the error above to also include the name of the chainstate.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T21:07:43Z",
      "diff_hunk" : "@@ -4148,6 +4148,12 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n \n+    Chainstate* bg_chain{WITH_LOCK(cs_main, return BackgroundSyncInProgress() ? m_ibd_chainstate.get() : nullptr)};\n+    BlockValidationState bg_state;\n+    if (bg_chain && !bg_chain->ActivateBestChain(bg_state, block)) {\n+        return error(\"%s: [background] ActivateBestChain failed (%s)\", __func__, bg_state.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342009057",
      "id" : 1342009057,
      "line" : 4184,
      "node_id" : "PRRC_kwDOABII585P_W7h",
      "original_commit_id" : "b73d3bbd23220857bf17cbb6401275bf58013b72",
      "original_line" : 4154,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 145,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342009057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342009057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342010458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010458"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It was added previously but as far as I can see the mempool param is unused in `DetectSnapshotChainstate()`.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T21:26:30Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342010458",
      "id" : 1342010458,
      "line" : 188,
      "node_id" : "PRRC_kwDOABII585P_XRa",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 188,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342010737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010737"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be worth mentioning this in the reindexing documentation as well.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T21:29:42Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        LogPrintf(\"[snapshot] deleting snapshot chainstate due to reindexing\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342010737",
      "id" : 1342010737,
      "line" : 191,
      "node_id" : "PRRC_kwDOABII585P_XVx",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 191,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 8,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342010737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342011998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342011998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would checking `m_from_snapshot_blockhash` not be simpler here? We seem to use it in other places like this as well.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T21:46:18Z",
      "diff_hunk" : "@@ -5813,6 +5813,16 @@ bool ChainstateManager::DeleteSnapshotChainstate()\n     return true;\n }\n \n+ChainstateRole Chainstate::GetRole() const\n+{\n+    if (m_chainman.GetAll().size() <= 1) {\n+        return ChainstateRole::NORMAL;\n+    }\n+    return (this != &m_chainman.ActiveChainstate()) ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342011998",
      "id" : 1342011998,
      "line" : 5877,
      "node_id" : "PRRC_kwDOABII585P_Xpe",
      "original_commit_id" : "c6af23c5179cc383f8e6c275373af8d11e6a989f",
      "original_line" : 5821,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 418,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342011998/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342011998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342013328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342013328"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Adding a small note here would be great, i.e. `The following task can be skipped since we don't maintain a mempool for the background chainstate.`",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T22:02:40Z",
      "diff_hunk" : "@@ -1917,9 +1917,25 @@ void PeerManagerImpl::BlockConnected(\n     const std::shared_ptr<const CBlock>& pblock,\n     const CBlockIndex* pindex)\n {\n-    m_orphanage.EraseForBlock(*pblock);\n+    // Update this for all chainstate roles so that we don't mistakenly see peers\n+    // helping us do background IBD as having a stale tip.\n     m_last_tip_update = GetTime<std::chrono::seconds>();\n \n+    // In case the dynamic timeout was doubled once or more, reduce it slowly back to its default value\n+    auto stalling_timeout = m_block_stalling_timeout.load();\n+    Assume(stalling_timeout >= BLOCK_STALLING_TIMEOUT_DEFAULT);\n+    if (stalling_timeout != BLOCK_STALLING_TIMEOUT_DEFAULT) {\n+        const auto new_timeout = std::max(std::chrono::duration_cast<std::chrono::seconds>(stalling_timeout * 0.85), BLOCK_STALLING_TIMEOUT_DEFAULT);\n+        if (m_block_stalling_timeout.compare_exchange_strong(stalling_timeout, new_timeout)) {\n+            LogPrint(BCLog::NET, \"Decreased stalling timeout to %d seconds\\n\", count_seconds(new_timeout));\n+        }\n+    }\n+\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342013328",
      "id" : 1342013328,
      "line" : 1934,
      "node_id" : "PRRC_kwDOABII585P_X-Q",
      "original_commit_id" : "1fffdd76a1bca908f55d73b64983655b14cf7432",
      "original_line" : 1934,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 158,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342013328/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342013328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342014745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342014745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As a follow-up it might be worth thinking about either erroring or printing a warning if <1100MB is configured. After all, if the user really doesn't have that much space they are risking a crash and a full disk might also effect other software.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T22:17:35Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded if it is set\n+lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342014745",
      "id" : 1342014745,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII585P_YUZ",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 5,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342014745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342014745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342015923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342015923"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We need the `+ 1` only because we still need its data for when the background chainstate catches up to the snapshot base and we make sure all is well, right?",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T22:35:35Z",
      "diff_hunk" : "@@ -5939,3 +5943,30 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     // indexed.\n     return (this->GetAll().size() > 1) ? *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<int, int> ChainstateManager::GetPruneRange(const Chainstate& chainstate, int last_height_can_prune)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    int prune_start{0};\n+\n+    if (this->GetAll().size() > 1 && m_snapshot_chainstate.get() == &chainstate) {\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        prune_start = *Assert(GetSnapshotBaseHeight()) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342015923",
      "id" : 1342015923,
      "line" : 5998,
      "node_id" : "PRRC_kwDOABII585P_Ymz",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 5957,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 449,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342015923/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342015923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342017833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342017833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `chainstate`",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T23:09:06Z",
      "diff_hunk" : "@@ -5268,6 +5268,12 @@ bool ChainstateManager::ActivateSnapshot(\n         const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n         assert(chaintip_loaded);\n \n+        // Transfer possession of the mempool to the snapshot chianstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342017833",
      "id" : 1342017833,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P_ZEp",
      "original_commit_id" : "9511fb3616b7bbe1d0d2f54a45ea0a650ba0367b",
      "original_line" : 5271,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342017833/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342017833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342018556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342018556"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks to me like the inside of this `if` block also works for the case `chainman.GetAll().size() == 1`, so I think the if-else could be removed and only the for loop kept.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-09-30T23:19:40Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"coins_db_cache_bytes\",  cs.m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs.m_coinstip_cache_size_bytes);\n+        if (cs.m_from_snapshot_blockhash) {\n+            data.pushKV(\"snapshot_blockhash\", cs.m_from_snapshot_blockhash->ToString());\n+        }\n+        return data;\n+    };\n+\n+    if (chainman.GetAll().size() > 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342018556",
      "id" : 1342018556,
      "line" : 2858,
      "node_id" : "PRRC_kwDOABII585P_ZP8",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2858,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 167,
      "pull_request_review_id" : 1651722959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342018556/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T00:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342018556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342035181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342035181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341995611\r\n\r\n> It's kind of confusing that here in the results the ibd chainstate is also called normal. It might be good to add a comment on that.\r\n\r\n@fjahr could you maybe suggest specific changes that you would recommend here? I'm confused by this comment and the one about removing the if block https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342018556. Removing the if-block would not work (as far as I know) because it would cause the \"snapshot\" chainstate to stick around after it is validated, and the \"normal\" chainstate to disappear, instead of the \"snapshot\" chainstate replacing the \"normal\" chainstate when it is fully validated as intended.\r\n\r\nThe idea is for the \"normal\" chainstate to refer to a typical fully validated chainstate, and for the \"snapshot\" to refer to a temporarily assumed-valid chainstate loaded from a snapshot.\r\n\r\nI think the term \"IBD chainstate\" is basically meaningless because both chainstates are downloaded during IBD. Even though the term is used internally in code, I think it would be good to move away from it and not expose it in the RPC interface.\r\n\r\n\r\n\r\n",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-10-01T01:17:41Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"coins_db_cache_bytes\",  cs.m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs.m_coinstip_cache_size_bytes);\n+        if (cs.m_from_snapshot_blockhash) {\n+            data.pushKV(\"snapshot_blockhash\", cs.m_from_snapshot_blockhash->ToString());\n+        }\n+        return data;\n+    };\n+\n+    if (chainman.GetAll().size() > 1) {\n+        for (Chainstate* chainstate : chainman.GetAll()) {\n+            obj.pushKV(\n+                chainstate->m_from_snapshot_blockhash ? \"snapshot\" : \"normal\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342035181",
      "id" : 1342035181,
      "in_reply_to_id" : 1341995611,
      "line" : 2861,
      "node_id" : "PRRC_kwDOABII585P_dTt",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2861,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 170,
      "pull_request_review_id" : 1651784367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342035181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T01:17:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342035181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-10-02T09:34:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1742695834",
      "id" : 1742695834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n322a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742695834/reactions"
      },
      "updated_at" : "2023-10-02T09:34:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742695834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We've got a few ACKs on HEAD now. I'm happy to either address the outstanding comments in followups to avoid invalidation or just fix them here... any preferences?",
      "created_at" : "2023-10-02T11:40:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1742859965",
      "id" : 1742859965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n4e69",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742859965/reactions"
      },
      "updated_at" : "2023-10-02T11:40:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742859965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> We've got a few ACKs on HEAD now. I'm happy to either address the outstanding comments in followups to avoid invalidation or just fix them here... any preferences?\r\n\r\nNo preference either way, personally.\r\n\r\nI think the main question is whether it makes sense to merge this PR before the 26.0 feature freeze on [2023-10-07](https://github.com/bitcoin/bitcoin/issues/27758). I think it would be a good idea to include this in 26.0 since it includes signet and testnet parameters, but not mainnet parameters, so merging it should make the feature easy to test in a safe way that should not cause problems. **But I don't know if there is agreement about this, so it would be really helpful to know what people think.**",
      "created_at" : "2023-10-02T14:15:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1743100285",
      "id" : 1743100285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n5Zl9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743100285/reactions"
      },
      "updated_at" : "2023-10-02T14:15:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743100285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the sentiment at the CoreDev two weeks ago was to merge it before feature freeze if there is enough review and I personally agree with that. The only unclear question was about the chainparameters but I feel we have resolved that now. As I said, I don't think my own feedback needs to be addressed before merge. And if anyone else thinks they are serious enough they could still be merged shortly after feature freeze (as serious = bug fix probably). I would be happy to take care of follow-ups quickly after merge. Would be great to get 1-2 more explicit ACKs on the latest version from @ryanofsky , @Sjors or @pablomartin4btc . With that, I think it would be RFM, and if there is still doubt we could also bring it up in the meeting on Thursday. But I feel like the picture was pretty clear at CoreDev among those who participated in the assumeutxo conversation.",
      "created_at" : "2023-10-02T14:32:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1743133949",
      "id" : 1743133949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n5hz9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743133949/reactions"
      },
      "updated_at" : "2023-10-02T14:42:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743133949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342789587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342789587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed this in a previous revision. :+1: ",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-10-02T14:45:45Z",
      "diff_hunk" : "@@ -5268,6 +5268,12 @@ bool ChainstateManager::ActivateSnapshot(\n         const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n         assert(chaintip_loaded);\n \n+        // Transfer possession of the mempool to the snapshot chianstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342789587",
      "id" : 1342789587,
      "in_reply_to_id" : 1342017833,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QCVfT",
      "original_commit_id" : "9511fb3616b7bbe1d0d2f54a45ea0a650ba0367b",
      "original_line" : 5271,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1652908444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342789587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T14:45:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342789587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342795165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342795165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"assumeutxo: remove snapshot during -reindex{-chainstate}\" (c711ca186f8d8a28810be0beedcb615ddcf93163)\r\n\r\nIf you're deleting this sentence, you also should delete the following \"This is especially important when\" following it.\r\n\r\nIMO it would also be good to clarify the previous 2 instances of \"This is especially important\" as well because they are pretty confusing. It sounds like they are saying \"It is especially important to _know_ that the pointer is not reset because cs_main is not held before calling ActivateBestChain,\" which doesn't make any sense. But the real meaning is \"It is important for the pointer to not _be_ deleted until shutdown, because cs_main is not always held when the pointer is accessed, for example when calling ActivateBestChain, so there's no way you could prevent code from using the pointer while deleting it.\"",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-10-02T14:50:18Z",
      "diff_hunk" : "@@ -848,9 +848,6 @@ class ChainstateManager\n     //! Points to either the ibd or snapshot chainstate; indicates our\n     //! most-work chain.\n     //!\n-    //! Once this pointer is set to a corresponding chainstate, it will not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342795165",
      "id" : 1342795165,
      "line" : 851,
      "node_id" : "PRRC_kwDOABII585QCW2d",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 851,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1652917347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342795165/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T15:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342795165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342809382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342809382"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: segment normal/assumedvalid blockfiles\" (7fcd21544a333ffdf1910b65c573579860be6a36)\r\n\r\nI think you need to return `true` here to avoid spurious \"Failed to flush block file\" warnings. Also could reconsider suggested change https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323325683 to make try to make this clearer.",
      "commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "created_at" : "2023-10-02T15:02:03Z",
      "diff_hunk" : "@@ -708,23 +727,43 @@ bool BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return true;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n         success = false;\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n     if (!fFinalize || finalize_undo) {\n-        if (!FlushUndoFile(m_last_blockfile, finalize_undo)) {\n+        if (!FlushUndoFile(blockfile_num, finalize_undo)) {\n             success = false;\n         }\n     }\n     return success;\n }\n \n+BlockfileType BlockManager::BlockfileTypeForHeight(int height)\n+{\n+    if (!m_snapshot_height) {\n+        return BlockfileType::NORMAL;\n+    }\n+    return (height >= *m_snapshot_height) ? BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+bool BlockManager::FlushChainstateBlockFile(int tip_height)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\n+    if (cursor) {\n+        // The cursor may not exist after a snapshot has been loaded but before any\n+        // blocks have been downloaded.\n+        return FlushBlockFile(cursor->file_num, /*fFinalize=*/false, /*finalize_undo=*/false);\n+    }\n+    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1342809382",
      "id" : 1342809382,
      "line" : 764,
      "node_id" : "PRRC_kwDOABII585QCaUm",
      "original_commit_id" : "7fcd21544a333ffdf1910b65c573579860be6a36",
      "original_line" : 764,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 299,
      "pull_request_review_id" : 1652917347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342809382/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T15:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342809382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343112029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 62ac519e718eb7a31dca1102a96ba219fbc7f95d \"validation: do not activate snapshot if behind active chain\"\r\n\r\nnit: work, not height.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:15:22Z",
      "diff_hunk" : "@@ -5342,6 +5349,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    // This work comparison is a duplicate check with the one performed later in\n+    // ActivateSnapshot(), but is done so that we avoid doing the long work of staging\n+    // a snapshot that isn't actually usable.\n+    if (WITH_LOCK(::cs_main, return !CBlockIndexWorkComparator()(ActiveTip(), snapshot_start_block))) {\n+        LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343112029",
      "id" : 1343112029,
      "line" : 5364,
      "node_id" : "PRRC_kwDOABII585QDkNd",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5356,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1653426165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343112529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 42cae39356fd20d521aaf99aff1ed85856f3c9f3 \"test: add feature_assumeutxo functional test\"\r\n\r\nnit: `self.no_op` already exists for this.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:15:53Z",
      "diff_hunk" : "@@ -0,0 +1,246 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\n+## Possible test improvements\n+\n+- TODO: test submitting a transaction and verifying it appears in mempool\n+- TODO: test what happens with -reindex and -reindex-chainstate before the\n+      snapshot is validated, and make sure it's deleted successfully.\n+\n+Interesting test cases could be loading an assumeutxo snapshot file with:\n+\n+- TODO: An invalid hash\n+- TODO: Valid hash but invalid snapshot file (bad coin height or truncated file or\n+      bad other serialization)\n+- TODO: Valid snapshot file, but referencing an unknown block\n+- TODO: Valid snapshot file, but referencing a snapshot block that turns out to be\n+      invalid, or has an invalid parent\n+- TODO: Valid snapshot file and snapshot block, but the block is not on the\n+      most-work chain\n+\n+Interesting starting states could be loading a snapshot when the current chain tip is:\n+\n+- TODO: An ancestor of snapshot block\n+- TODO: Not an ancestor of the snapshot block but has less work\n+- TODO: The snapshot block\n+- TODO: A descendant of the snapshot block\n+- TODO: Not an ancestor or a descendant of the snapshot block and has more work\n+\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343112529",
      "id" : 1343112529,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585QDkVR",
      "original_commit_id" : "42cae39356fd20d521aaf99aff1ed85856f3c9f3",
      "original_line" : 84,
      "original_position" : 84,
      "original_start_line" : 83,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 84,
      "pull_request_review_id" : 1653426165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 83,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343112529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343154441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343154441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 13c2066a17ba3e1dd0b81905625d1539d6e7a4f3 \"chainparams: add testnet assumeutxo param at height 2_500_000\"\r\n\r\nThis is `txouts`/`coins_written` (depending on which RPC you used), not the actual `nChainTx`. It should be 66484552.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:53:41Z",
      "diff_hunk" : "@@ -267,7 +267,12 @@ class CTestNetParams : public CChainParams {\n         };\n \n         m_assumeutxo_data = {\n-            // TODO to be specified in a future patch.\n+            {\n+                .height = 2'500'000,\n+                .hash_serialized = AssumeutxoHash{uint256S(\"0x2a8fdefef3bf75fa00540ccaaaba4b5281bea94229327bdb0f7416ef1e7a645c\")},\n+                .nChainTx = 29324631,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343154441",
      "id" : 1343154441,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QDukJ",
      "original_commit_id" : "13c2066a17ba3e1dd0b81905625d1539d6e7a4f3",
      "original_line" : 273,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/kernel/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 1653426165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343154441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343154441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343155336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343155336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d9e41a0f92081979764aee420a8ccb80898da862 \"chainparams: add signet assumeutxo param at height 160_000\"\r\n\r\nThis is `txouts`/`coins_written` (depending on which RPC you used), not the actual `nChainTx`. It should be 2289496.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:54:49Z",
      "diff_hunk" : "@@ -375,6 +375,15 @@ class SigNetParams : public CChainParams {\n \n         vFixedSeeds.clear();\n \n+        m_assumeutxo_data = {\n+            {\n+                .height = 160'000,\n+                .hash_serialized = AssumeutxoHash{uint256S(\"0x5225141cb62dee63ab3be95f9b03d60801f264010b1816d4bd00618b2736e7be\")},\n+                .nChainTx = 1278002,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343155336",
      "id" : 1343155336,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QDuyI",
      "original_commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "original_line" : 382,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/kernel/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 1653426165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343155336/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343155336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343157918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good find, fixed.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:58:01Z",
      "diff_hunk" : "@@ -267,7 +267,12 @@ class CTestNetParams : public CChainParams {\n         };\n \n         m_assumeutxo_data = {\n-            // TODO to be specified in a future patch.\n+            {\n+                .height = 2'500'000,\n+                .hash_serialized = AssumeutxoHash{uint256S(\"0x2a8fdefef3bf75fa00540ccaaaba4b5281bea94229327bdb0f7416ef1e7a645c\")},\n+                .nChainTx = 29324631,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343157918",
      "id" : 1343157918,
      "in_reply_to_id" : 1343154441,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QDvae",
      "original_commit_id" : "13c2066a17ba3e1dd0b81905625d1539d6e7a4f3",
      "original_line" : 273,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/kernel/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 1653504135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157918/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:58:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343158009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343158009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T20:58:07Z",
      "diff_hunk" : "@@ -375,6 +375,15 @@ class SigNetParams : public CChainParams {\n \n         vFixedSeeds.clear();\n \n+        m_assumeutxo_data = {\n+            {\n+                .height = 160'000,\n+                .hash_serialized = AssumeutxoHash{uint256S(\"0x5225141cb62dee63ab3be95f9b03d60801f264010b1816d4bd00618b2736e7be\")},\n+                .nChainTx = 1278002,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343158009",
      "id" : 1343158009,
      "in_reply_to_id" : 1343155336,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QDvb5",
      "original_commit_id" : "d9e41a0f92081979764aee420a8ccb80898da862",
      "original_line" : 382,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/kernel/chainparams.cpp",
      "position" : null,
      "pull_request_review_id" : 1653504277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343158009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343158009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK edbed31066e3674ba52b8c093ab235625527f383\r\n\r\nGiven that the only difference between the commit that has 3 ACKs and the latest push was a minor fix to the chainparams to use the correct `nChainTx` values, I think this is fine for merging.",
      "created_at" : "2023-10-02T20:58:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1743756406",
      "id" : 1743756406,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585n75x2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 6,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 6,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743756406/reactions"
      },
      "updated_at" : "2023-10-02T20:58:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743756406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343167013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343167013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 42cae39356fd20d521aaf99aff1ed85856f3c9f3 \"test: add feature_assumeutxo functional test\"\r\n\r\nThese `wait_until_helper`s and `self.wait_until` can timeout if the machine is kinda slow, or if running in valgrind.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T21:09:12Z",
      "diff_hunk" : "@@ -0,0 +1,246 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\n+## Possible test improvements\n+\n+- TODO: test submitting a transaction and verifying it appears in mempool\n+- TODO: test what happens with -reindex and -reindex-chainstate before the\n+      snapshot is validated, and make sure it's deleted successfully.\n+\n+Interesting test cases could be loading an assumeutxo snapshot file with:\n+\n+- TODO: An invalid hash\n+- TODO: Valid hash but invalid snapshot file (bad coin height or truncated file or\n+      bad other serialization)\n+- TODO: Valid snapshot file, but referencing an unknown block\n+- TODO: Valid snapshot file, but referencing a snapshot block that turns out to be\n+      invalid, or has an invalid parent\n+- TODO: Valid snapshot file and snapshot block, but the block is not on the\n+      most-work chain\n+\n+Interesting starting states could be loading a snapshot when the current chain tip is:\n+\n+- TODO: An ancestor of snapshot block\n+- TODO: Not an ancestor of the snapshot block but has less work\n+- TODO: The snapshot block\n+- TODO: A descendant of the snapshot block\n+- TODO: Not an ancestor or a descendant of the snapshot block and has more work\n+\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['normal']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `snapshot` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('snapshot'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343167013",
      "id" : 1343167013,
      "line" : 164,
      "node_id" : "PRRC_kwDOABII585QDxol",
      "original_commit_id" : "42cae39356fd20d521aaf99aff1ed85856f3c9f3",
      "original_line" : 164,
      "original_position" : 164,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 164,
      "pull_request_review_id" : 1653519081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343167013/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T21:09:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343167013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343213786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343213786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky Sure, first of all it sounds like we are on the same page that naming of the chainstates isnât ideal. I think it will be harder for future developers to understand how assumeutxo works when snapshot and assumed_valid are used interchangably as well as ibd and background. In my mind is an area of improvement for the future but obviously the ship has sailed for this PR if we want to merge it any time soon and for Jamesâ sanity also (and especially if this is merged while I write this :D ).\r\n\r\nI think it makes sense to hide that complexity from the users but that rationale should be documented for developers in a comment here, and thatâs what I was asking for. In the future I think we should try to make chainstate naming consistent and if we believe that calling ibd chainstates normal both in the context of assume UTXO as well as outside of it, then we may want to even think about a DDD approach and rename ibd/background chainstate to something like normal_background.\r\n\r\nFor the if-else: right, I didnât take that transition period when we are fully synced but both chainstates are still around into account correctly. I guess it can still work with a guard clause but itâs not much of an improvement anymore then. ",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T22:12:00Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"coins_db_cache_bytes\",  cs.m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs.m_coinstip_cache_size_bytes);\n+        if (cs.m_from_snapshot_blockhash) {\n+            data.pushKV(\"snapshot_blockhash\", cs.m_from_snapshot_blockhash->ToString());\n+        }\n+        return data;\n+    };\n+\n+    if (chainman.GetAll().size() > 1) {\n+        for (Chainstate* chainstate : chainman.GetAll()) {\n+            obj.pushKV(\n+                chainstate->m_from_snapshot_blockhash ? \"snapshot\" : \"normal\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343213786",
      "id" : 1343213786,
      "in_reply_to_id" : 1341995611,
      "line" : 2861,
      "node_id" : "PRRC_kwDOABII585QD9Da",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2861,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 170,
      "pull_request_review_id" : 1653593116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343213786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T22:12:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343213786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343216646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343216646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not actually an improvement, as discussed above https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1341995611",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T22:16:45Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());\n+        data.pushKV(\"bestblockhash\",         tip->GetBlockHash().GetHex());\n+        data.pushKV(\"difficulty\",            (double)GetDifficulty(tip));\n+        data.pushKV(\"verificationprogress\",  GuessVerificationProgress(Params().TxData(), tip));\n+        data.pushKV(\"coins_db_cache_bytes\",  cs.m_coinsdb_cache_size_bytes);\n+        data.pushKV(\"coins_tip_cache_bytes\", cs.m_coinstip_cache_size_bytes);\n+        if (cs.m_from_snapshot_blockhash) {\n+            data.pushKV(\"snapshot_blockhash\", cs.m_from_snapshot_blockhash->ToString());\n+        }\n+        return data;\n+    };\n+\n+    if (chainman.GetAll().size() > 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343216646",
      "id" : 1343216646,
      "in_reply_to_id" : 1342018556,
      "line" : 2858,
      "node_id" : "PRRC_kwDOABII585QD9wG",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2858,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 167,
      "pull_request_review_id" : 1653597408,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343216646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T22:16:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343216646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343266877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343266877"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "a9ea542e8aed092f45dab2d9a66da56aba742f51: it's probably not significant, but if we split up the two `if`s we could avoid creating `bg_state` object each time a new block comes in when not using AssumeUtxo.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-02T23:56:37Z",
      "diff_hunk" : "@@ -4148,6 +4148,12 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n \n+    Chainstate* bg_chain{WITH_LOCK(cs_main, return BackgroundSyncInProgress() ? m_ibd_chainstate.get() : nullptr)};\n+    BlockValidationState bg_state;\n+    if (bg_chain && !bg_chain->ActivateBestChain(bg_state, block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343266877",
      "id" : 1343266877,
      "line" : 4183,
      "node_id" : "PRRC_kwDOABII585QEKA9",
      "original_commit_id" : "b73d3bbd23220857bf17cbb6401275bf58013b72",
      "original_line" : 4153,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 1653763136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343266877/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T22:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343266877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343273598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343273598"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe mention that if an index is enabled when pruning, also the 1100MB might not be sufficient because the prune locks wouldn't allow us to prune anything from the snapshot CS until the background CS has finished loading.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T00:11:58Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded if it is set\n+lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343273598",
      "id" : 1343273598,
      "in_reply_to_id" : 1342014745,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII585QELp-",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 5,
      "pull_request_review_id" : 1653763136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343273598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T22:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343273598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343846377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343846377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce585a9a158476b0ad3296477b922e79f308e795: maybe drop \"under a security model very much like `assumevalid`\" - it seems better to discuss the security properties and trade-off in `assumeutxo.md`.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T10:02:41Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343846377",
      "id" : 1343846377,
      "line" : 2710,
      "node_id" : "PRRC_kwDOABII585QGXfp",
      "original_commit_id" : "ce585a9a158476b0ad3296477b922e79f308e795",
      "original_line" : 2710,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 19,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343846377/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343846377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343848899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343848899"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce585a9a158476b0ad3296477b922e79f308e795 \"which is reasonable since their contents are always checked\" -> \"and verified\"\r\n\r\n(re both comments: I'm trying to make the RPC doc sound a bit less like an advertisement)",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T10:04:36Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343848899",
      "id" : 1343848899,
      "line" : 2716,
      "node_id" : "PRRC_kwDOABII585QGYHD",
      "original_commit_id" : "ce585a9a158476b0ad3296477b922e79f308e795",
      "original_line" : 2716,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 25,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343848899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343848899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343857210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343857210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any automated tool that loads a snapshot (e.g. for a server deployment) needs to wait for _something_ before calling this RPC, since they're not available immediately upon startup.\r\n\r\nSo they'll probably just end up waiting a little bit and then repeatedly calling it until it no long throws an error.\r\n\r\nWith that in mind, it seems fine to just fail if header sync is in progress. At the same time these 10 lines of RPC code seem fine and convenient.\r\n\r\nA more thorough improvement would be to make the call return immediately and have another method to track progress. E.g. the loading progress could be shoehorned into `getchainstates`. Having a way to poll for progress is nice for any UI as well (including our GUI).\r\n\r\nA `loadtxoutset` progress RPC also helps regular command-line users, because the logs are currently much too noisy to easily follow what's happening; if you call this very early on the node will be churning through early mainnet blocks at breakneck pace.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T10:11:33Z",
      "diff_hunk" : "@@ -2699,6 +2699,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343857210",
      "id" : 1343857210,
      "in_reply_to_id" : 1291670706,
      "line" : 2764,
      "node_id" : "PRRC_kwDOABII585QGaI6",
      "original_commit_id" : "8ac7427b41fdec1dbc7e06d0aa2c0e469b879ba2",
      "original_line" : 2764,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 73,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343857210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343857210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343911171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343911171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bb0585779472962f40d9cdd9c6532132850d371c  For this and similiar erors, it would be good if a followup PR has them returned via RPC.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T10:55:07Z",
      "diff_hunk" : "@@ -5185,6 +5185,14 @@ bool ChainstateManager::ActivateSnapshot(\n         return false;\n     }\n \n+    {\n+        LOCK(::cs_main);\n+        if (Assert(m_active_chainstate->GetMempool())->size() > 0) {\n+            LogPrintf(\"[snapshot] can't activate a snapshot when mempool not empty\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343911171",
      "id" : 1343911171,
      "line" : 5191,
      "node_id" : "PRRC_kwDOABII585QGnUD",
      "original_commit_id" : "bb0585779472962f40d9cdd9c6532132850d371c",
      "original_line" : 5191,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 208,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343911171/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343911171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343913819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343913819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d: additionally, if we can do this before the mempool check (bb0585779472962f40d9cdd9c6532132850d371c) we'd have a less cryptic error message when a user tries to load a snapshot into an already synced node.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T10:57:30Z",
      "diff_hunk" : "@@ -5342,6 +5349,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    // This work comparison is a duplicate check with the one performed later in\n+    // ActivateSnapshot(), but is done so that we avoid doing the long work of staging\n+    // a snapshot that isn't actually usable.\n+    if (WITH_LOCK(::cs_main, return !CBlockIndexWorkComparator()(ActiveTip(), snapshot_start_block))) {\n+        LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343913819",
      "id" : 1343913819,
      "in_reply_to_id" : 1343112029,
      "line" : 5364,
      "node_id" : "PRRC_kwDOABII585QGn9b",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5356,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343913819/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343913819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343917159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343917159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(I tested that I can reach this error on a node that's synced well past the snapshot height, by deleting `mempool.dat` and running `-blocksonly`)",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T11:00:34Z",
      "diff_hunk" : "@@ -5342,6 +5349,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    // This work comparison is a duplicate check with the one performed later in\n+    // ActivateSnapshot(), but is done so that we avoid doing the long work of staging\n+    // a snapshot that isn't actually usable.\n+    if (WITH_LOCK(::cs_main, return !CBlockIndexWorkComparator()(ActiveTip(), snapshot_start_block))) {\n+        LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343917159",
      "id" : 1343917159,
      "in_reply_to_id" : 1343112029,
      "line" : 5364,
      "node_id" : "PRRC_kwDOABII585QGoxn",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5356,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343917159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343917159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343920324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343920324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d: I managed to hit this as follows:\r\n\r\n1. call `invalidateblock` at height 799_900\r\n2. call `reconsiderblock`\r\n3. quickly shut down the node\r\n4. erase mempool.dat\r\n5. start node with `-blocksonly`\r\n6. load snapshot (bypassing the preliminary check below)\r\n7. watch the chain catch up beyond block 800_000 while it's still loading coins, and then flushing the snapshot\r\n8. see `loadtxoutset` fail and the above log message\r\n\r\nAs an aside, it would be nice to have a `rollback` RPC that just takes a height argument, _doesn't_ involve invalidating a block and optionally deletes the downloaded block.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T11:03:31Z",
      "diff_hunk" : "@@ -5259,30 +5248,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343920324",
      "id" : 1343920324,
      "line" : 5272,
      "node_id" : "PRRC_kwDOABII585QGpjE",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5264,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 267,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343920324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343920324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343952455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343952455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: May be good to add a comment why this is needed.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T11:33:01Z",
      "diff_hunk" : "@@ -0,0 +1,200 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes to test that snapshot use works\n+# properly with indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from, otherwise the default values prevent IBD from the server node.\n+EARLY_IBD_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $EARLY_IBD_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343952455",
      "id" : 1343952455,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII585QGxZH",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 112,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343952455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343952455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343985564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343985564"
         }
      },
      "author_association" : "MEMBER",
      "body" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d: not if we finished IBD while the snapshot was loading and its chainstate finished flushing, as I did above. The `CBlockIndexWorkComparator` check above catches that, but it seems better to do another explicit (non fatal) check.\r\n\r\nSee also earlier discussion: https://github.com/bitcoin/bitcoin/pull/27596/commits/9511fb3616b7bbe1d0d2f54a45ea0a650ba0367b#r1319642325",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T11:59:59Z",
      "diff_hunk" : "@@ -5259,30 +5248,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");\n+    }\n+    // If not in-memory, persist the base blockhash for use during subsequent\n+    // initialization.\n+    if (!in_memory) {\n+        if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {\n+            return cleanup_bad_snapshot(\"could not write base blockhash\");\n+        }\n     }\n+\n+    assert(!m_snapshot_chainstate);\n+    m_snapshot_chainstate.swap(snapshot_chainstate);\n+    const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n+    assert(chaintip_loaded);\n+\n+    // Transfer possession of the mempool to the snapshot chainstate.\n+    // Mempool is empty at this point because we're still in IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343985564",
      "id" : 1343985564,
      "line" : 5288,
      "node_id" : "PRRC_kwDOABII585QG5ec",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5280,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 283,
      "pull_request_review_id" : 1654826157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343985564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T14:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343985564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343998883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343998883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Not sure about adding `TODO` that are unclear on how to fix. I think it should be clear *first* that this will offer a user-facing benefit, before someone `grep`s for this and starts working on it.\r\n\r\nSeems fine to remove completely or replace with `This could be parameterized on whether ...\"",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T12:12:01Z",
      "diff_hunk" : "@@ -250,8 +259,19 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     return true;\n }\n \n-void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n+void BaseIndex::BlockConnected(ChainstateRole role, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    // Ignore events from the assumed-valid chain; we will process its blocks\n+    // (sequentially) after it is fully verified by the background chainstate. This\n+    // is to avoid any out-of-order indexing.\n+    //\n+    // TODO at some point we could parameterize whether a particular index can be",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343998883",
      "id" : 1343998883,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585QG8uj",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 268,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 56,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343998883/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343998883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344002707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344002707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this be a fatal `InitError`?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T12:15:17Z",
      "diff_hunk" : "@@ -1478,6 +1478,25 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexes = [&node]() {\n+            LogPrintf(\"[snapshot] restarting indexes\\n\");\n+\n+            // Drain the validation interface queue to ensure that the old indexes\n+            // don't have any pending work.\n+            SyncWithValidationInterfaceQueue();\n+\n+            for (auto* index : node.indexes) {\n+                index->Interrupt();\n+                index->Stop();\n+                if (!(index->Init() && index->StartBackgroundSync())) {\n+                    LogPrintf(\"[snapshot] WARNING failed to restart index %s on snapshot chain\\n\", index->GetName());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344002707",
      "id" : 1344002707,
      "line" : 1495,
      "node_id" : "PRRC_kwDOABII585QG9qT",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 1495,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 18,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344002707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344002707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344006030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344006030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: Not sure if it makes sense to use the release notes to compare this with `assumevalid`. In any case, `assumevalid` has POW built on top of it, and this one doesn't, so the security model seems different?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T12:18:02Z",
      "diff_hunk" : "@@ -0,0 +1,28 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded if it is set\n+lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally\n+split evenly across each chainstate, unless the resulting prune budget per chainstate\n+is beneath `MIN_DISK_SPACE_FOR_BLOCK_FILES` in which case that value will be used.\n+\n+RPC\n+---\n+\n+`loadtxoutset` has been added, which allows loading a UTXO snapshot of the format\n+generated by `dumptxoutset`. Once this snapshot is loaded, its contents will be\n+deserialized into a second chainstate data structure, which is then used to sync to\n+the network's tip under a security model very much like `assumevalid`.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344006030",
      "id" : 1344006030,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585QG-eO",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 15,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344006030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344006030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344010377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344010377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: May be more consistent to use `index_chain` here as well, over `chainman.ActiveChain()`.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T12:21:40Z",
      "diff_hunk" : "@@ -1932,7 +1952,7 @@ bool StartIndexBackgroundSync(NodeContext& node)\n         LOCK(::cs_main);\n         const CBlockIndex* start_block = *indexes_start_block;\n         if (!start_block) start_block = chainman.ActiveChain().Genesis();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344010377",
      "id" : 1344010377,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII585QG_iJ",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 1954,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 53,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344010377/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344010377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344017553"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344017553"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This disables compiler warnings. May be better to use the style recommended in the dev notes. Also, `assert(0)` may be better than an exception, which is unclear whether it will be thrown at all and whether or where it will be caught.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T12:26:46Z",
      "diff_hunk" : "@@ -25,3 +26,13 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     return info;\n }\n } // namespace kernel\n+\n+std::ostream& operator<<(std::ostream& os, const ChainstateRole& role) {\n+    switch(role) {\n+        case ChainstateRole::NORMAL: os << \"normal\"; break;\n+        case ChainstateRole::ASSUMEDVALID: os << \"assumedvalid\"; break;\n+        case ChainstateRole::BACKGROUND: os << \"background\"; break;\n+        default: os.setstate(std::ios_base::failbit);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344017553",
      "id" : 1344017553,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585QHBSR",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 35,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/kernel/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344017553/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344017553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344433079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344433079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors The link to the earlier discussion doesn't seem to work ",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T16:51:59Z",
      "diff_hunk" : "@@ -5259,30 +5248,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");\n+    }\n+    // If not in-memory, persist the base blockhash for use during subsequent\n+    // initialization.\n+    if (!in_memory) {\n+        if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {\n+            return cleanup_bad_snapshot(\"could not write base blockhash\");\n+        }\n     }\n+\n+    assert(!m_snapshot_chainstate);\n+    m_snapshot_chainstate.swap(snapshot_chainstate);\n+    const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n+    assert(chaintip_loaded);\n+\n+    // Transfer possession of the mempool to the snapshot chainstate.\n+    // Mempool is empty at this point because we're still in IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344433079",
      "id" : 1344433079,
      "in_reply_to_id" : 1343985564,
      "line" : 5288,
      "node_id" : "PRRC_kwDOABII585QImu3",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5280,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 283,
      "pull_request_review_id" : 1655698150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344433079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T16:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344433079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344605396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344605396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why would `target==0` ever be hit? `std::max(MIN_DISK_SPACE_FOR_BLOCK_FILES, 0)` shouldn't be `0`. ",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T19:10:53Z",
      "diff_hunk" : "@@ -257,40 +258,56 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n-    for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+    for (int fileNumber = 0; fileNumber < this->MaxBlockfileNum(); fileNumber++) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    if (chain.m_chain.Height() < 0 || target == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344605396",
      "id" : 1344605396,
      "line" : 302,
      "node_id" : "PRRC_kwDOABII585QJQzU",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 302,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 62,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344605396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344605396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344617893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344617893"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `CBlockIndex& base{*Assert(LookupBlockIndex(*snapshot_blockhash))};` to avoid UB in the presence of bugs?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T19:22:21Z",
      "diff_hunk" : "@@ -360,13 +379,32 @@ CBlockIndex* BlockManager::InsertBlockIndex(const uint256& hash)\n     return pindex;\n }\n \n-bool BlockManager::LoadBlockIndex()\n+bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockhash)\n {\n     if (!m_block_tree_db->LoadBlockIndexGuts(\n             GetConsensus(), [this](const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return this->InsertBlockIndex(hash); }, m_interrupt)) {\n         return false;\n     }\n \n+    if (snapshot_blockhash) {\n+        const AssumeutxoData au_data = *Assert(GetParams().AssumeutxoForBlockhash(*snapshot_blockhash));\n+        m_snapshot_height = au_data.height;\n+        CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344617893",
      "id" : 1344617893,
      "line" : 392,
      "node_id" : "PRRC_kwDOABII585QJT2l",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 392,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 147,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344617893/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344617893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344629969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344629969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T19:32:35Z",
      "diff_hunk" : "@@ -1091,4 +1187,18 @@ void ImportBlocks(ChainstateManager& chainman, std::vector<fs::path> vImportFile\n         }\n     } // End scope of ImportingNow\n }\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type) {\n+    switch(type) {\n+        case BlockfileType::NORMAL: os << \"normal\"; break;\n+        case BlockfileType::ASSUMED: os << \"assumed\"; break;\n+        default: os.setstate(std::ios_base::failbit);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344629969",
      "id" : 1344629969,
      "line" : 1195,
      "node_id" : "PRRC_kwDOABII585QJWzR",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 1195,
      "original_position" : 421,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 421,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344629969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344629969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344648372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344648372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't really understand the use of an array, but then require indexing each type here. I wonder if it was easier to just have two member fields for the two types. Otherwise it would be better to use a for-loop here and iterate over the array?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T19:46:46Z",
      "diff_hunk" : "@@ -154,24 +189,39 @@ class BlockManager\n      * A db flag records the fact that at least some block files have been pruned.\n      *\n      * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\n+     * @param        last_prune        The last height we're able to prune, according to the prune locks\n      */\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd);\n+    void FindFilesToPrune(\n+        std::set<int>& setFilesToPrune,\n+        int last_prune,\n+        const Chainstate& chain,\n+        ChainstateManager& chainman);\n \n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n-    int m_last_blockfile = 0;\n \n-    // Track the height of the highest block in m_last_blockfile whose undo\n-    // data has been written. Block data is written to block files in download\n-    // order, but is written to undo files in validation order, which is\n-    // usually in order by height. To avoid wasting disk space, undo files will\n-    // be trimmed whenever the corresponding block file is finalized and\n-    // the height of the highest block written to the block file equals the\n-    // height of the highest block written to the undo file. This is a\n-    // heuristic and can sometimes preemptively trim undo files that will write\n-    // more data later, and sometimes fail to trim undo files that can't have\n-    // more data written later.\n-    unsigned int m_undo_height_in_last_blockfile = 0;\n+    //! Since assumedvalid chainstates may be syncing a range of the chain that is very\n+    //! far away from the normal/background validation process, we should segment blockfiles\n+    //! for assumed chainstates. Otherwise, we might have wildly different height ranges\n+    //! mixed into the same block files, which would impair our ability to prune\n+    //! effectively.\n+    //!\n+    //! This data structure maintains separate blockfile number cursors for each\n+    //! BlockfileType. The ASSUMED state is initialized, when necessary, in FindBlockPos().\n+    //!\n+    //! The first element is the NORMAL cursor, second is ASSUMED.\n+    std::array<std::optional<BlockfileCursor>, BlockfileType::NUM_TYPES>\n+        m_blockfile_cursors GUARDED_BY(cs_LastBlockFile) = {\n+            BlockfileCursor{},\n+            std::nullopt,\n+    };\n+    int MaxBlockfileNum() const EXCLUSIVE_LOCKS_REQUIRED(cs_LastBlockFile)\n+    {\n+        static const BlockfileCursor empty_cursor;\n+        const auto& normal = m_blockfile_cursors[BlockfileType::NORMAL].value_or(empty_cursor);\n+        const auto& assumed = m_blockfile_cursors[BlockfileType::ASSUMED].value_or(empty_cursor);\n+        return std::max(normal.file_num, assumed.file_num);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344648372",
      "id" : 1344648372,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585QJbS0",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 223,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 125,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344648372/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344648372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344688088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344688088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't think the security model is similar, because assumevalid must be covered by POW. This one not.\r\nIt may be better to omit this sentence, or just explain the security trade-offs, if there is any value and need for it.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:17:38Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344688088",
      "id" : 1344688088,
      "line" : 2710,
      "node_id" : "PRRC_kwDOABII585QJk_Y",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2710,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 19,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344688088/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344688088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344694600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344694600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems racy. Why would `new_tip` be equal to `snapshot_start_block` when blocks can be received on the network thread? Also, why is there a need to get this at all, when the existing `snapshot_start_block` can be used?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:23:23Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!IsRPCRunning()) {\n+            throw JSONRPCError(RPC_CLIENT_NOT_CONNECTED, \"Shutting down\");\n+        }\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    }\n+    CBlockIndex* new_tip{WITH_LOCK(::cs_main, return chainman.ActiveTip())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344694600",
      "id" : 1344694600,
      "line" : 2790,
      "node_id" : "PRRC_kwDOABII585QJmlI",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2790,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 99,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344694600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344694600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344696121"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344696121"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Could remove the `file` symbol and inline the fopen call to avoid having to symbols refer to the same resource?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:24:58Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344696121",
      "id" : 1344696121,
      "line" : 2745,
      "node_id" : "PRRC_kwDOABII585QJm85",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2745,
      "original_position" : 54,
      "original_start_line" : 2744,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 54,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344696121/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2744,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344696121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344698532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`Ensure(any)Chainman` to avoid UB?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:27:05Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344698532",
      "id" : 1344698532,
      "line" : 2762,
      "node_id" : "PRRC_kwDOABII585QJnik",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2762,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 71,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344698747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:27:17Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!IsRPCRunning()) {\n+            throw JSONRPCError(RPC_CLIENT_NOT_CONNECTED, \"Shutting down\");\n+        }\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    }\n+    CBlockIndex* new_tip{WITH_LOCK(::cs_main, return chainman.ActiveTip())};\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"coins_loaded\", metadata.m_coins_count);\n+    result.pushKV(\"tip_hash\", new_tip->GetBlockHash().ToString());\n+    result.pushKV(\"base_height\", new_tip->nHeight);\n+    result.pushKV(\"path\", fs::PathToString(path));\n+    return result;\n+},\n+    };\n+}\n+\n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344698747",
      "id" : 1344698747,
      "line" : 2835,
      "node_id" : "PRRC_kwDOABII585QJnl7",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2835,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 144,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698747/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344698747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344699944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344699944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Any reason for the c-style cast here?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:28:24Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!IsRPCRunning()) {\n+            throw JSONRPCError(RPC_CLIENT_NOT_CONNECTED, \"Shutting down\");\n+        }\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    }\n+    CBlockIndex* new_tip{WITH_LOCK(::cs_main, return chainman.ActiveTip())};\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"coins_loaded\", metadata.m_coins_count);\n+    result.pushKV(\"tip_hash\", new_tip->GetBlockHash().ToString());\n+    result.pushKV(\"base_height\", new_tip->nHeight);\n+    result.pushKV(\"path\", fs::PathToString(path));\n+    return result;\n+},\n+    };\n+}\n+\n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    auto make_chain_data = [&](const Chainstate& cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        AssertLockHeld(::cs_main);\n+        UniValue data(UniValue::VOBJ);\n+        if (!cs.m_chain.Tip()) {\n+            return data;\n+        }\n+        const CChain& chain = cs.m_chain;\n+        const CBlockIndex* tip = chain.Tip();\n+\n+        data.pushKV(\"blocks\",                (int)chain.Height());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344699944",
      "id" : 1344699944,
      "line" : 2846,
      "node_id" : "PRRC_kwDOABII585QJn4o",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2846,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 155,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344699944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344699944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344707056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344707056"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: It may be better to explain why and what needs to be improved, otherwise this seems hard to act on.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:33:27Z",
      "diff_hunk" : "@@ -109,7 +109,23 @@ CreateAndActivateUTXOSnapshot(\n             0 == WITH_LOCK(node.chainman->GetMutex(), return node.chainman->ActiveHeight()));\n     }\n \n-    return node.chainman->ActivateSnapshot(auto_infile, metadata, in_memory_chainstate);\n+    auto& new_active = node.chainman->ActiveChainstate();\n+    auto* tip = new_active.m_chain.Tip();\n+\n+    // Disconnect a block so that the snapshot chainstate will be ahead, otherwise\n+    // it will refuse to activate.\n+    //\n+    // TODO this is a unittest-specific hack, and we should probably rethink how to\n+    // better generate/activate snapshots in unittests.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344707056",
      "id" : 1344707056,
      "line" : 119,
      "node_id" : "PRRC_kwDOABII585QJpnw",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 119,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 12,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344707056/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344707056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344713537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344713537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could add a functional test for this?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:39:57Z",
      "diff_hunk" : "@@ -5157,6 +5185,14 @@ bool ChainstateManager::ActivateSnapshot(\n         return false;\n     }\n \n+    {\n+        LOCK(::cs_main);\n+        if (Assert(m_active_chainstate->GetMempool())->size() > 0) {\n+            LogPrintf(\"[snapshot] can't activate a snapshot when mempool not empty\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344713537",
      "id" : 1344713537,
      "line" : 5191,
      "node_id" : "PRRC_kwDOABII585QJrNB",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 5191,
      "original_position" : 208,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 208,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344713537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344713537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344722098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344722098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: why not use `node.blocksdir_path`?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:48:30Z",
      "diff_hunk" : "@@ -979,3 +979,7 @@ def is_sqlite_compiled(self):\n     def is_bdb_compiled(self):\n         \"\"\"Checks whether the wallet module was compiled with BDB support.\"\"\"\n         return self.config[\"components\"].getboolean(\"USE_BDB\")\n+\n+    def has_blockfile(self, node, filenum: str):\n+        blocksdir = os.path.join(node.datadir, self.chain, 'blocks', '')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344722098",
      "id" : 1344722098,
      "line" : 984,
      "node_id" : "PRRC_kwDOABII585QJtSy",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 984,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 6,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344722098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344722098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344725060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344725060"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure about excluding this. If it is included it would be good to have it checked by `shellcheck` to aid reviewers and maintenance, unless there is a reason not to.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T20:51:35Z",
      "diff_hunk" : "@@ -67,9 +67,13 @@ def main():\n         '*.sh',\n     ]\n     files = get_files(files_cmd)\n-    # remove everything that doesn't match this regex\n     reg = re.compile(r'src/[leveldb,secp256k1,minisketch]')\n-    files[:] = [file for file in files if not reg.match(file)]\n+\n+    def should_exclude(fname: str) -> bool:\n+        return bool(reg.match(fname)) or 'test_utxo_snapshots.sh' in fname",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344725060",
      "id" : 1344725060,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585QJuBE",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 73,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/lint/lint-shell.py",
      "position" : 9,
      "pull_request_review_id" : 1654978564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344725060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344725060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Left some low level review comments. I guess the only question I have so far is why `-prune=0` isn't broken: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344605396\r\n\r\nI'll try to compile and test later.",
      "created_at" : "2023-10-03T20:55:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1745711906",
      "id" : 1745711906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585oDXMi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1745711906/reactions"
      },
      "updated_at" : "2023-10-03T20:55:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1745711906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344764519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344764519"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There is a reason described in the commit message: `Add the script to the shellcheck exception list since the quoted variables rule needs to be violated in order to get bitcoind to pick up on $CHAIN_HACK_FLAGS.`",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T21:28:43Z",
      "diff_hunk" : "@@ -67,9 +67,13 @@ def main():\n         '*.sh',\n     ]\n     files = get_files(files_cmd)\n-    # remove everything that doesn't match this regex\n     reg = re.compile(r'src/[leveldb,secp256k1,minisketch]')\n-    files[:] = [file for file in files if not reg.match(file)]\n+\n+    def should_exclude(fname: str) -> bool:\n+        return bool(reg.match(fname)) or 'test_utxo_snapshots.sh' in fname",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344764519",
      "id" : 1344764519,
      "in_reply_to_id" : 1344725060,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585QJ3pn",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 73,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/lint/lint-shell.py",
      "position" : 9,
      "pull_request_review_id" : 1656162642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344764519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T21:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344764519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344780851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344780851"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is possible to put a single exclude in the line prior to the violation instead of excluding the whole file",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-03T21:48:16Z",
      "diff_hunk" : "@@ -67,9 +67,13 @@ def main():\n         '*.sh',\n     ]\n     files = get_files(files_cmd)\n-    # remove everything that doesn't match this regex\n     reg = re.compile(r'src/[leveldb,secp256k1,minisketch]')\n-    files[:] = [file for file in files if not reg.match(file)]\n+\n+    def should_exclude(fname: str) -> bool:\n+        return bool(reg.match(fname)) or 'test_utxo_snapshots.sh' in fname",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344780851",
      "id" : 1344780851,
      "in_reply_to_id" : 1344725060,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585QJ7oz",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 73,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/lint/lint-shell.py",
      "position" : 9,
      "pull_request_review_id" : 1656183959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344780851/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-03T21:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344780851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1345406481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345406481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mmm, I'm not sure what I was referring too.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-04T08:27:20Z",
      "diff_hunk" : "@@ -5259,30 +5248,48 @@ bool ChainstateManager::ActivateSnapshot(\n             }\n         }\n         return false;\n-    }\n+    };\n \n-    {\n+    if (!this->PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)) {\n         LOCK(::cs_main);\n-        assert(!m_snapshot_chainstate);\n-        m_snapshot_chainstate.swap(snapshot_chainstate);\n-        const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n-        assert(chaintip_loaded);\n-\n-        // Transfer possession of the mempool to the snapshot chianstate.\n-        // Mempool is empty at this point because we're still in IBD.\n-        Assert(m_active_chainstate->m_mempool->size() == 0);\n-        Assert(!m_snapshot_chainstate->m_mempool);\n-        m_snapshot_chainstate->m_mempool = m_active_chainstate->m_mempool;\n-        m_active_chainstate->m_mempool = nullptr;\n-        m_active_chainstate = m_snapshot_chainstate.get();\n-        m_blockman.m_snapshot_height = this->GetSnapshotBaseHeight();\n-\n-        LogPrintf(\"[snapshot] successfully activated snapshot %s\\n\", base_blockhash.ToString());\n-        LogPrintf(\"[snapshot] (%.2f MB)\\n\",\n-            m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\n+        return cleanup_bad_snapshot(\"population failed\");\n+    }\n \n-        this->MaybeRebalanceCaches();\n+    LOCK(::cs_main);  // cs_main required for rest of snapshot activation.\n+\n+    // Do a final check to ensure that the snapshot chainstate is actually a more\n+    // work chain than the active chainstate; a user could have loaded a snapshot\n+    // very late in the IBD process, and we wouldn't want to load a useless chainstate.\n+    if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate->m_chain.Tip())) {\n+        return cleanup_bad_snapshot(\"work does not exceed active chainstate\");\n+    }\n+    // If not in-memory, persist the base blockhash for use during subsequent\n+    // initialization.\n+    if (!in_memory) {\n+        if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {\n+            return cleanup_bad_snapshot(\"could not write base blockhash\");\n+        }\n     }\n+\n+    assert(!m_snapshot_chainstate);\n+    m_snapshot_chainstate.swap(snapshot_chainstate);\n+    const bool chaintip_loaded = m_snapshot_chainstate->LoadChainTip();\n+    assert(chaintip_loaded);\n+\n+    // Transfer possession of the mempool to the snapshot chainstate.\n+    // Mempool is empty at this point because we're still in IBD.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1345406481",
      "id" : 1345406481,
      "in_reply_to_id" : 1343985564,
      "line" : 5288,
      "node_id" : "PRRC_kwDOABII585QMUYR",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5280,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 283,
      "pull_request_review_id" : 1656957470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345406481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-04T08:27:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345406481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1345866623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345866623"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess this was or is dead code to begin with?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-04T14:11:30Z",
      "diff_hunk" : "@@ -257,40 +258,56 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n     m_dirty_fileinfo.insert(fileNumber);\n }\n \n-void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nManualPruneHeight, int chain_tip_height)\n+void BlockManager::FindFilesToPruneManual(\n+    std::set<int>& setFilesToPrune,\n+    int nManualPruneHeight,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     assert(IsPruneMode() && nManualPruneHeight > 0);\n \n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0) {\n+    if (chain.m_chain.Height() < 0) {\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    const auto [min_block_to_prune, last_block_can_prune] = chainman.GetPruneRange(chain, nManualPruneHeight);\n+\n     int count = 0;\n-    for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+    for (int fileNumber = 0; fileNumber < this->MaxBlockfileNum(); fileNumber++) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > (unsigned)last_block_can_prune || fileinfo.nHeightFirst < (unsigned)min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), last_block_can_prune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    int last_prune,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = std::max(\n+        MIN_DISK_SPACE_FOR_BLOCK_FILES, GetPruneTarget() / chainman.GetAll().size());\n+\n+    if (chain.m_chain.Height() < 0 || target == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1345866623",
      "id" : 1345866623,
      "in_reply_to_id" : 1344605396,
      "line" : 302,
      "node_id" : "PRRC_kwDOABII585QOEt_",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 302,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 62,
      "pull_request_review_id" : 1657642134,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345866623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-04T14:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1345866623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1346097648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346097648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This might have been related to #28589, if not #28586 can be reopened to address this",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-04T15:45:12Z",
      "diff_hunk" : "@@ -0,0 +1,246 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\n+## Possible test improvements\n+\n+- TODO: test submitting a transaction and verifying it appears in mempool\n+- TODO: test what happens with -reindex and -reindex-chainstate before the\n+      snapshot is validated, and make sure it's deleted successfully.\n+\n+Interesting test cases could be loading an assumeutxo snapshot file with:\n+\n+- TODO: An invalid hash\n+- TODO: Valid hash but invalid snapshot file (bad coin height or truncated file or\n+      bad other serialization)\n+- TODO: Valid snapshot file, but referencing an unknown block\n+- TODO: Valid snapshot file, but referencing a snapshot block that turns out to be\n+      invalid, or has an invalid parent\n+- TODO: Valid snapshot file and snapshot block, but the block is not on the\n+      most-work chain\n+\n+Interesting starting states could be loading a snapshot when the current chain tip is:\n+\n+- TODO: An ancestor of snapshot block\n+- TODO: Not an ancestor of the snapshot block but has less work\n+- TODO: The snapshot block\n+- TODO: A descendant of the snapshot block\n+- TODO: Not an ancestor or a descendant of the snapshot block and has more work\n+\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass\n+\n+        # Generate a series of blocks that `n0` will have in the snapshot,\n+        # but that n1 doesn't yet see. In order for the snapshot to activate,\n+        # though, we have to ferry over the new headers to n1 so that it\n+        # isn't waiting forever to see the header of the snapshot's base block\n+        # while disconnected from n0.\n+        for i in range(100):\n+            self.generate(n0, nblocks=1, sync_fun=no_sync)\n+            newblock = n0.getblock(n0.getbestblockhash(), 0)\n+\n+            # make n1 aware of the new header, but don't give it the block.\n+            n1.submitheader(newblock)\n+            n2.submitheader(newblock)\n+\n+        # Ensure everyone is seeing the same headers.\n+        for n in self.nodes:\n+            assert_equal(n.getblockchaininfo()[\"headers\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        self.log.info(\"-- Testing assumeutxo + some indexes + pruning\")\n+\n+        assert_equal(n0.getblockcount(), SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Creating a UTXO snapshot at height {SNAPSHOT_BASE_HEIGHT}\")\n+        dump_output = n0.dumptxoutset('utxos.dat')\n+\n+        assert_equal(\n+            dump_output['txoutset_hash'],\n+            'ef45ccdca5898b6c2145e4581d2b88c56564dd389e4bd75a1aaf6961d3edd3c0')\n+        assert_equal(dump_output['nchaintx'], 300)\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Mine more blocks on top of the snapshot that n1 hasn't yet seen. This\n+        # will allow us to test n1's sync-to-tip on top of a snapshot.\n+        self.generate(n0, nblocks=100, sync_fun=no_sync)\n+\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n1.getblockcount(), START_HEIGHT)\n+\n+        assert_equal(n0.getblockchaininfo()[\"blocks\"], FINAL_HEIGHT)\n+\n+        self.log.info(f\"Loading snapshot into second node from {dump_output['path']}\")\n+        loaded = n1.loadtxoutset(dump_output['path'])\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        monitor = n1.getchainstates()\n+        assert_equal(monitor['normal']['blocks'], START_HEIGHT)\n+        assert_equal(monitor['snapshot']['blocks'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(monitor['snapshot']['snapshot_blockhash'], dump_output['base_hash'])\n+\n+        assert_equal(n1.getblockchaininfo()[\"blocks\"], SNAPSHOT_BASE_HEIGHT)\n+\n+        PAUSE_HEIGHT = FINAL_HEIGHT - 40\n+\n+        self.log.info(\"Restarting node to stop at height %d\", PAUSE_HEIGHT)\n+        self.restart_node(1, extra_args=[\n+            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n+\n+        # Finally connect the nodes and let them sync.\n+        self.connect_nodes(0, 1)\n+\n+        n1.wait_until_stopped(timeout=5)\n+\n+        self.log.info(\"Checking that blocks are segmented on disk\")\n+        assert self.has_blockfile(n1, \"00000\"), \"normal blockfile missing\"\n+        assert self.has_blockfile(n1, \"00001\"), \"assumed blockfile missing\"\n+        assert not self.has_blockfile(n1, \"00002\"), \"too many blockfiles\"\n+\n+        self.log.info(\"Restarted node before snapshot validation completed, reloading...\")\n+        self.restart_node(1, extra_args=self.extra_args[1])\n+        self.connect_nodes(0, 1)\n+\n+        self.log.info(f\"Ensuring snapshot chain syncs to tip. ({FINAL_HEIGHT})\")\n+        wait_until_helper(lambda: n1.getchainstates()['snapshot']['blocks'] == FINAL_HEIGHT)\n+        self.sync_blocks(nodes=(n0, n1))\n+\n+        self.log.info(\"Ensuring background validation completes\")\n+        # N.B.: the `snapshot` key disappears once the background validation is complete.\n+        wait_until_helper(lambda: not n1.getchainstates().get('snapshot'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1346097648",
      "id" : 1346097648,
      "in_reply_to_id" : 1343167013,
      "line" : 164,
      "node_id" : "PRRC_kwDOABII585QO9Hw",
      "original_commit_id" : "42cae39356fd20d521aaf99aff1ed85856f3c9f3",
      "original_line" : 164,
      "original_position" : 164,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 164,
      "pull_request_review_id" : 1657958289,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346097648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:40:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1346097648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "tACK on WSL Ubuntu 22.04.\r\n\r\nI tested `signet` and `testnet` by generating snapshots using the ./contrib/devtools/utxo_snapshot.sh script.\r\nBoth snapshots had the correct SHA-256 sums.\r\n\r\nOn `signet`, I loaded the snapshot and it verified very quickly.\r\n\r\nOn `testnet`, I did the same thing, but it took a while because the Testnet blockchain is much larger.\r\n\r\nBoth `signet` and `testnet` synced successfully and the `getchainstates` command returned \"normal\".\r\n\r\nThe only difference I found is that the `testnet3/chainstate` folder is about **1.53 GB** and the `testnet3/blocks` folder is about **1.91 GB**, while the `signet/chainstate` folder is about **97.6 MB** and the `signet/blocks` folder is about **915 MB**.\r\nAre those the expected folder sizes once the snapshots are synced?",
      "created_at" : "2023-10-04T17:05:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1747308922",
      "id" : 1747308922,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585oJdF6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747308922/reactions"
      },
      "updated_at" : "2023-10-04T17:05:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747308922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/111142327?v=4",
         "events_url" : "https://api.github.com/users/D33r-Gee/events{/privacy}",
         "followers_url" : "https://api.github.com/users/D33r-Gee/followers",
         "following_url" : "https://api.github.com/users/D33r-Gee/following{/other_user}",
         "gists_url" : "https://api.github.com/users/D33r-Gee/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/D33r-Gee",
         "id" : 111142327,
         "login" : "D33r-Gee",
         "node_id" : "U_kgDOBp_ltw",
         "organizations_url" : "https://api.github.com/users/D33r-Gee/orgs",
         "received_events_url" : "https://api.github.com/users/D33r-Gee/received_events",
         "repos_url" : "https://api.github.com/users/D33r-Gee/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/D33r-Gee/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/D33r-Gee/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/D33r-Gee"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348475707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348475707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In general a user for who 0.5 GB makes a difference is going to have a problem. The downloaded snapshot itself is multiple GB and the chainstate (even without assumeutxo) is growing at 0.5 GB per month. We could add a hint that it's safe to delete `utxo-xxxxxx.dat` once the RPC returns (if there's no crash).",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T09:28:30Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded if it is set\n+lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348475707",
      "id" : 1348475707,
      "in_reply_to_id" : 1342014745,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII585QYBs7",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 5,
      "pull_request_review_id" : 1661470533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348475707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T14:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348475707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348772716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348772716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "373cf91531b84bfdd06fdf8abf4dca228029ce6b being able to build out of order is necessary for a pruned node.\r\n\r\n[note: currently running an IBD on mainnet with `-prune=2000` and `-blockfilterindex=1` to see what happensâ¦ I'm guessing it will be missing a range of blocks above the snapshot? If so then we should either refuse to load a snapshot or delay pruning with this combination. If we delay pruning, we should warn the user that enabling the index will temporarily require a lot of extra storage (x GB per month of how old the snapshot is)]",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T14:08:58Z",
      "diff_hunk" : "@@ -250,8 +259,19 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     return true;\n }\n \n-void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n+void BaseIndex::BlockConnected(ChainstateRole role, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    // Ignore events from the assumed-valid chain; we will process its blocks\n+    // (sequentially) after it is fully verified by the background chainstate. This\n+    // is to avoid any out-of-order indexing.\n+    //\n+    // TODO at some point we could parameterize whether a particular index can be",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348772716",
      "id" : 1348772716,
      "in_reply_to_id" : 1343998883,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585QZKNs",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 268,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 56,
      "pull_request_review_id" : 1661470533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348772716/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T14:37:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348772716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348806713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348806713"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it syncs ok, but just doesn't prune anything in the snapshot chainstate until the background chainstate has caught up (because of the prune locks introduced in #21726). This should probably be mentioned in some documentation (because users could run into disk space problems with it), see my comment below.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T14:35:21Z",
      "diff_hunk" : "@@ -250,8 +259,19 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     return true;\n }\n \n-void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n+void BaseIndex::BlockConnected(ChainstateRole role, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    // Ignore events from the assumed-valid chain; we will process its blocks\n+    // (sequentially) after it is fully verified by the background chainstate. This\n+    // is to avoid any out-of-order indexing.\n+    //\n+    // TODO at some point we could parameterize whether a particular index can be",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348806713",
      "id" : 1348806713,
      "in_reply_to_id" : 1343998883,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585QZSg5",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 268,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 56,
      "pull_request_review_id" : 1662004717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348806713/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T14:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348806713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348929759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348929759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:14:53Z",
      "diff_hunk" : "@@ -0,0 +1,246 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test for assumeutxo, a means of quickly bootstrapping a node using\n+a serialized version of the UTXO set at a certain height, which corresponds\n+to a hash that has been compiled into bitcoind.\n+\n+The assumeutxo value generated and used here is committed to in\n+`CRegTestParams::m_assumeutxo_data` in `src/chainparams.cpp`.\n+\n+## Possible test improvements\n+\n+- TODO: test submitting a transaction and verifying it appears in mempool\n+- TODO: test what happens with -reindex and -reindex-chainstate before the\n+      snapshot is validated, and make sure it's deleted successfully.\n+\n+Interesting test cases could be loading an assumeutxo snapshot file with:\n+\n+- TODO: An invalid hash\n+- TODO: Valid hash but invalid snapshot file (bad coin height or truncated file or\n+      bad other serialization)\n+- TODO: Valid snapshot file, but referencing an unknown block\n+- TODO: Valid snapshot file, but referencing a snapshot block that turns out to be\n+      invalid, or has an invalid parent\n+- TODO: Valid snapshot file and snapshot block, but the block is not on the\n+      most-work chain\n+\n+Interesting starting states could be loading a snapshot when the current chain tip is:\n+\n+- TODO: An ancestor of snapshot block\n+- TODO: Not an ancestor of the snapshot block but has less work\n+- TODO: The snapshot block\n+- TODO: A descendant of the snapshot block\n+- TODO: Not an ancestor or a descendant of the snapshot block and has more work\n+\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, wait_until_helper\n+\n+START_HEIGHT = 199\n+SNAPSHOT_BASE_HEIGHT = 299\n+FINAL_HEIGHT = 399\n+COMPLETE_IDX = {'synced': True, 'best_block_height': FINAL_HEIGHT}\n+\n+\n+class AssumeutxoTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        \"\"\"Use the pregenerated, deterministic chain up to height 199.\"\"\"\n+        self.num_nodes = 3\n+        self.rpc_timeout = 120\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            [\"-txindex=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+        ]\n+\n+    def setup_network(self):\n+        \"\"\"Start with the nodes disconnected so that one can generate a snapshot\n+        including blocks the other hasn't yet seen.\"\"\"\n+        self.add_nodes(3)\n+        self.start_nodes(extra_args=self.extra_args)\n+\n+    def run_test(self):\n+        \"\"\"\n+        Bring up two (disconnected) nodes, mine some new blocks on the first,\n+        and generate a UTXO snapshot.\n+\n+        Load the snapshot into the second, ensure it syncs to tip and completes\n+        background validation when connected to the first.\n+        \"\"\"\n+        n0 = self.nodes[0]\n+        n1 = self.nodes[1]\n+        n2 = self.nodes[2]\n+\n+        # Mock time for a deterministic chain\n+        for n in self.nodes:\n+            n.setmocktime(n.getblockheader(n.getbestblockhash())['time'])\n+\n+        self.sync_blocks()\n+\n+        def no_sync():\n+            pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348929759",
      "id" : 1348929759,
      "in_reply_to_id" : 1343112529,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585QZwjf",
      "original_commit_id" : "42cae39356fd20d521aaf99aff1ed85856f3c9f3",
      "original_line" : 84,
      "original_position" : 84,
      "original_start_line" : 83,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 84,
      "pull_request_review_id" : 1662228499,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348929759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 83,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348929759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348930102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348930102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> nit: work, not height.\r\n\r\nThis is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:15:09Z",
      "diff_hunk" : "@@ -5342,6 +5349,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     const AssumeutxoData& au_data = *maybe_au_data;\n \n+    // This work comparison is a duplicate check with the one performed later in\n+    // ActivateSnapshot(), but is done so that we avoid doing the long work of staging\n+    // a snapshot that isn't actually usable.\n+    if (WITH_LOCK(::cs_main, return !CBlockIndexWorkComparator()(ActiveTip(), snapshot_start_block))) {\n+        LogPrintf(\"[snapshot] activation failed - height does not exceed active chainstate\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348930102",
      "id" : 1348930102,
      "in_reply_to_id" : 1343112029,
      "line" : 5364,
      "node_id" : "PRRC_kwDOABII585QZwo2",
      "original_commit_id" : "62ac519e718eb7a31dca1102a96ba219fbc7f95d",
      "original_line" : 5356,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1662229164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348930102/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:15:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348930102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348934486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348934486"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not relevant anymore due to #28590",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:19:10Z",
      "diff_hunk" : "@@ -2799,6 +2799,79 @@ static RPCHelpMan loadtxoutset()\n     };\n }\n \n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348934486",
      "id" : 1348934486,
      "in_reply_to_id" : 1341996092,
      "line" : 2821,
      "node_id" : "PRRC_kwDOABII585QZxtW",
      "original_commit_id" : "0f64bac6030334d798ae205cd7af4bf248feddd9",
      "original_line" : 2821,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 130,
      "pull_request_review_id" : 1662237980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348934486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:19:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348934486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348935011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348935011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:19:38Z",
      "diff_hunk" : "@@ -69,6 +69,7 @@\n #include <optional>\n #include <string>\n #include <utility>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348935011",
      "id" : 1348935011,
      "in_reply_to_id" : 1341985254,
      "line" : 72,
      "node_id" : "PRRC_kwDOABII585QZx1j",
      "original_commit_id" : "1019c399825b0d512c1fd751c376d46fed4992b9",
      "original_line" : 72,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 1662238980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348935011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348935011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348939181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348939181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:23:29Z",
      "diff_hunk" : "@@ -4765,6 +4765,10 @@ void ChainstateManager::CheckBlockIndex()\n     CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindex->pprev && pindex->nTx > 0) {\n+            // nChainTx should increase monotonically\n+            assert(pindex->pprev->nChainTx <= pindex->nChainTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348939181",
      "id" : 1348939181,
      "in_reply_to_id" : 1310950827,
      "line" : 4843,
      "node_id" : "PRRC_kwDOABII585QZy2t",
      "original_commit_id" : "9df91113b8bbab8c98924bef61da388a8141b4e6",
      "original_line" : 4843,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 175,
      "pull_request_review_id" : 1662245295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348939181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348939181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348959202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348959202"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:34:33Z",
      "diff_hunk" : "@@ -705,15 +724,34 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n-    if (!fFinalize || finalize_undo) FlushUndoFile(m_last_blockfile, finalize_undo);\n+    if (!fFinalize || finalize_undo) FlushUndoFile(blockfile_num, finalize_undo);\n+}\n+\n+BlockfileType BlockManager::BlockfileTypeForHeight(int height)\n+{\n+    if (!m_snapshot_height) {\n+        return BlockfileType::NORMAL;\n+    }\n+    return (height >= *m_snapshot_height) ? BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+void BlockManager::FlushChainstateBlockFile(int tip_height)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\n+    if (cursor) {\n+        // The cursor may not exist after a snapshot has been loaded but before any\n+        // blocks have been downloaded.\n+        return FlushBlockFile(cursor->file_num, /*fFinalize=*/false, /*finalize_undo=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348959202",
      "id" : 1348959202,
      "in_reply_to_id" : 1332579498,
      "line" : 762,
      "node_id" : "PRRC_kwDOABII585QZ3vi",
      "original_commit_id" : "bd770ff59075fa2fd0441311ef1c02439ed68fdd",
      "original_line" : 762,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 297,
      "pull_request_review_id" : 1662278300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348959202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:34:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348959202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348960162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348960162"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:35:40Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348960162",
      "id" : 1348960162,
      "in_reply_to_id" : 1342010458,
      "line" : 188,
      "node_id" : "PRRC_kwDOABII585QZ3-i",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 188,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1662280003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348960162/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:35:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348960162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348961870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348961870"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:37:26Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        LogPrintf(\"[snapshot] deleting snapshot chainstate due to reindexing\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348961870",
      "id" : 1348961870,
      "in_reply_to_id" : 1342010737,
      "line" : 191,
      "node_id" : "PRRC_kwDOABII585QZ4ZO",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 191,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 8,
      "pull_request_review_id" : 1662283000,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348961870/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:37:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348961870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348962182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348962182"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:37:46Z",
      "diff_hunk" : "@@ -1917,9 +1917,25 @@ void PeerManagerImpl::BlockConnected(\n     const std::shared_ptr<const CBlock>& pblock,\n     const CBlockIndex* pindex)\n {\n-    m_orphanage.EraseForBlock(*pblock);\n+    // Update this for all chainstate roles so that we don't mistakenly see peers\n+    // helping us do background IBD as having a stale tip.\n     m_last_tip_update = GetTime<std::chrono::seconds>();\n \n+    // In case the dynamic timeout was doubled once or more, reduce it slowly back to its default value\n+    auto stalling_timeout = m_block_stalling_timeout.load();\n+    Assume(stalling_timeout >= BLOCK_STALLING_TIMEOUT_DEFAULT);\n+    if (stalling_timeout != BLOCK_STALLING_TIMEOUT_DEFAULT) {\n+        const auto new_timeout = std::max(std::chrono::duration_cast<std::chrono::seconds>(stalling_timeout * 0.85), BLOCK_STALLING_TIMEOUT_DEFAULT);\n+        if (m_block_stalling_timeout.compare_exchange_strong(stalling_timeout, new_timeout)) {\n+            LogPrint(BCLog::NET, \"Decreased stalling timeout to %d seconds\\n\", count_seconds(new_timeout));\n+        }\n+    }\n+\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348962182",
      "id" : 1348962182,
      "in_reply_to_id" : 1342013328,
      "line" : 1934,
      "node_id" : "PRRC_kwDOABII585QZ4eG",
      "original_commit_id" : "1fffdd76a1bca908f55d73b64983655b14cf7432",
      "original_line" : 1934,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 158,
      "pull_request_review_id" : 1662283483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348962182/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348962182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348963687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:39:34Z",
      "diff_hunk" : "@@ -848,9 +848,6 @@ class ChainstateManager\n     //! Points to either the ibd or snapshot chainstate; indicates our\n     //! most-work chain.\n     //!\n-    //! Once this pointer is set to a corresponding chainstate, it will not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348963687",
      "id" : 1348963687,
      "in_reply_to_id" : 1342795165,
      "line" : 851,
      "node_id" : "PRRC_kwDOABII585QZ41n",
      "original_commit_id" : "c711ca186f8d8a28810be0beedcb615ddcf93163",
      "original_line" : 851,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1662286001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963687/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:39:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348963927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:39:49Z",
      "diff_hunk" : "@@ -708,23 +727,43 @@ bool BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n         return true;\n     }\n-    assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n+    assert(static_cast<int>(m_blockfile_info.size()) > blockfile_num);\n \n-    FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n+    FlatFilePos block_pos_old(blockfile_num, m_blockfile_info[blockfile_num].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n         success = false;\n     }\n     // we do not always flush the undo file, as the chain tip may be lagging behind the incoming blocks,\n     // e.g. during IBD or a sync after a node going offline\n     if (!fFinalize || finalize_undo) {\n-        if (!FlushUndoFile(m_last_blockfile, finalize_undo)) {\n+        if (!FlushUndoFile(blockfile_num, finalize_undo)) {\n             success = false;\n         }\n     }\n     return success;\n }\n \n+BlockfileType BlockManager::BlockfileTypeForHeight(int height)\n+{\n+    if (!m_snapshot_height) {\n+        return BlockfileType::NORMAL;\n+    }\n+    return (height >= *m_snapshot_height) ? BlockfileType::ASSUMED : BlockfileType::NORMAL;\n+}\n+\n+bool BlockManager::FlushChainstateBlockFile(int tip_height)\n+{\n+    LOCK(cs_LastBlockFile);\n+    auto& cursor = m_blockfile_cursors[BlockfileTypeForHeight(tip_height)];\n+    if (cursor) {\n+        // The cursor may not exist after a snapshot has been loaded but before any\n+        // blocks have been downloaded.\n+        return FlushBlockFile(cursor->file_num, /*fFinalize=*/false, /*finalize_undo=*/false);\n+    }\n+    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348963927",
      "id" : 1348963927,
      "in_reply_to_id" : 1342809382,
      "line" : 764,
      "node_id" : "PRRC_kwDOABII585QZ45X",
      "original_commit_id" : "7fcd21544a333ffdf1910b65c573579860be6a36",
      "original_line" : 764,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 299,
      "pull_request_review_id" : 1662286433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:39:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348963927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348968869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348968869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am dropping the reference in #28562 for now since that was also requested in IRC.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:44:45Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348968869",
      "id" : 1348968869,
      "in_reply_to_id" : 1343846377,
      "line" : 2710,
      "node_id" : "PRRC_kwDOABII585QZ6Gl",
      "original_commit_id" : "ce585a9a158476b0ad3296477b922e79f308e795",
      "original_line" : 2710,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 19,
      "pull_request_review_id" : 1662294447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348968869/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:44:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348968869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348971899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348971899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you meant to replace the first test snipped with the second one, I'm not sure how this improves the docs. It just makes it less precise but not less of an advertisement? ",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:48:09Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348971899",
      "id" : 1348971899,
      "in_reply_to_id" : 1343848899,
      "line" : 2716,
      "node_id" : "PRRC_kwDOABII585QZ617",
      "original_commit_id" : "ce585a9a158476b0ad3296477b922e79f308e795",
      "original_line" : 2716,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 25,
      "pull_request_review_id" : 1662299684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348971899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348971899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348974421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348974421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562 (dropping the reference)",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:50:30Z",
      "diff_hunk" : "@@ -0,0 +1,28 @@\n+Pruning\n+-------\n+\n+When using assumeutxo with `-prune`, the prune budget may be exceeded if it is set\n+lower than 1100MB (i.e. `MIN_DISK_SPACE_FOR_BLOCK_FILES * 2`). Prune budget is normally\n+split evenly across each chainstate, unless the resulting prune budget per chainstate\n+is beneath `MIN_DISK_SPACE_FOR_BLOCK_FILES` in which case that value will be used.\n+\n+RPC\n+---\n+\n+`loadtxoutset` has been added, which allows loading a UTXO snapshot of the format\n+generated by `dumptxoutset`. Once this snapshot is loaded, its contents will be\n+deserialized into a second chainstate data structure, which is then used to sync to\n+the network's tip under a security model very much like `assumevalid`.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348974421",
      "id" : 1348974421,
      "in_reply_to_id" : 1344006030,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585QZ7dV",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 15,
      "pull_request_review_id" : 1662304317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348974421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:50:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348974421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348982459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348982459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Does this exist? When I grep for `blocksdir_path` I only find a local variable.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:58:44Z",
      "diff_hunk" : "@@ -979,3 +979,7 @@ def is_sqlite_compiled(self):\n     def is_bdb_compiled(self):\n         \"\"\"Checks whether the wallet module was compiled with BDB support.\"\"\"\n         return self.config[\"components\"].getboolean(\"USE_BDB\")\n+\n+    def has_blockfile(self, node, filenum: str):\n+        blocksdir = os.path.join(node.datadir, self.chain, 'blocks', '')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348982459",
      "id" : 1348982459,
      "in_reply_to_id" : 1344722098,
      "line" : 984,
      "node_id" : "PRRC_kwDOABII585QZ9a7",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 984,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 6,
      "pull_request_review_id" : 1662317009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348982459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:58:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348982459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348983269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348983269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562 (dropping reference for now)",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T16:59:41Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1348983269",
      "id" : 1348983269,
      "in_reply_to_id" : 1344688088,
      "line" : 2710,
      "node_id" : "PRRC_kwDOABII585QZ9nl",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2710,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 19,
      "pull_request_review_id" : 1662318409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348983269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T16:59:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1348983269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349006892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349006892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This would be resolved by @ryanofsky 's effort to remove the chainstate names/types entirely, as discussed here and linked at the bottom: https://github.com/bitcoin/bitcoin/pull/28562#discussion_r1344824078",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:11:14Z",
      "diff_hunk" : "@@ -1091,4 +1187,18 @@ void ImportBlocks(ChainstateManager& chainman, std::vector<fs::path> vImportFile\n         }\n     } // End scope of ImportingNow\n }\n+\n+std::ostream& operator<<(std::ostream& os, const BlockfileType& type) {\n+    switch(type) {\n+        case BlockfileType::NORMAL: os << \"normal\"; break;\n+        case BlockfileType::ASSUMED: os << \"assumed\"; break;\n+        default: os.setstate(std::ios_base::failbit);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349006892",
      "id" : 1349006892,
      "in_reply_to_id" : 1344629969,
      "line" : 1195,
      "node_id" : "PRRC_kwDOABII585QaDYs",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 1195,
      "original_position" : 421,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 421,
      "pull_request_review_id" : 1662355460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349006892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:11:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349006892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349008575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349008575"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This would be resolved by @ryanofsky 's effort to remove the chainstate names/types entirely, as discussed here and linked at the bottom: https://github.com/bitcoin/bitcoin/pull/28562#discussion_r1344824078",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:11:29Z",
      "diff_hunk" : "@@ -25,3 +26,13 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     return info;\n }\n } // namespace kernel\n+\n+std::ostream& operator<<(std::ostream& os, const ChainstateRole& role) {\n+    switch(role) {\n+        case ChainstateRole::NORMAL: os << \"normal\"; break;\n+        case ChainstateRole::ASSUMEDVALID: os << \"assumedvalid\"; break;\n+        case ChainstateRole::BACKGROUND: os << \"background\"; break;\n+        default: os.setstate(std::ios_base::failbit);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349008575",
      "id" : 1349008575,
      "in_reply_to_id" : 1344017553,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585QaDy_",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 35,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/kernel/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 1662357578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349008575/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349008575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349131589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349131589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The phrase \"which is reasonable\" seems wrong for an RPC doc. It's part of the security discussion that seems more appropriate for the doc.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:30:51Z",
      "diff_hunk" : "@@ -2699,6 +2700,105 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349131589",
      "id" : 1349131589,
      "in_reply_to_id" : 1343848899,
      "line" : 2716,
      "node_id" : "PRRC_kwDOABII585Qah1F",
      "original_commit_id" : "ce585a9a158476b0ad3296477b922e79f308e795",
      "original_line" : 2716,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 25,
      "pull_request_review_id" : 1662509498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349131589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:30:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349131589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349132562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349132562"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was wondering if those prune locks would kick in. I'll find out.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:31:43Z",
      "diff_hunk" : "@@ -250,8 +259,19 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     return true;\n }\n \n-void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n+void BaseIndex::BlockConnected(ChainstateRole role, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    // Ignore events from the assumed-valid chain; we will process its blocks\n+    // (sequentially) after it is fully verified by the background chainstate. This\n+    // is to avoid any out-of-order indexing.\n+    //\n+    // TODO at some point we could parameterize whether a particular index can be",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349132562",
      "id" : 1349132562,
      "in_reply_to_id" : 1343998883,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585QaiES",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 268,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 56,
      "pull_request_review_id" : 1662510921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349132562/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349132562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349138655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349138655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I tend to agree that there should be an error but it's tricky here because this function is defined during init but then only later called during `ActivateBestChain`. Do `InitError` is probably not appropriate?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:37:17Z",
      "diff_hunk" : "@@ -1478,6 +1478,25 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexes = [&node]() {\n+            LogPrintf(\"[snapshot] restarting indexes\\n\");\n+\n+            // Drain the validation interface queue to ensure that the old indexes\n+            // don't have any pending work.\n+            SyncWithValidationInterfaceQueue();\n+\n+            for (auto* index : node.indexes) {\n+                index->Interrupt();\n+                index->Stop();\n+                if (!(index->Init() && index->StartBackgroundSync())) {\n+                    LogPrintf(\"[snapshot] WARNING failed to restart index %s on snapshot chain\\n\", index->GetName());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349138655",
      "id" : 1349138655,
      "in_reply_to_id" : 1344002707,
      "line" : 1495,
      "node_id" : "PRRC_kwDOABII585Qajjf",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 1495,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 18,
      "pull_request_review_id" : 1662520320,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349138655/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:37:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349138655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349144430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:44:26Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {\n+        snapshot_start_block = WITH_LOCK(::cs_main,\n+            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n+        max_secs_to_wait_for_headers -= 1;\n+\n+        if (!IsRPCRunning()) {\n+            throw JSONRPCError(RPC_CLIENT_NOT_CONNECTED, \"Shutting down\");\n+        }\n+\n+        if (!snapshot_start_block) {\n+            std::this_thread::sleep_for(std::chrono::seconds(1));\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    if (!snapshot_start_block) {\n+        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n+            base_blockhash.ToString());\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"Timed out waiting for base block header to appear in headers chain\");\n+    }\n+    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    }\n+    CBlockIndex* new_tip{WITH_LOCK(::cs_main, return chainman.ActiveTip())};\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"coins_loaded\", metadata.m_coins_count);\n+    result.pushKV(\"tip_hash\", new_tip->GetBlockHash().ToString());\n+    result.pushKV(\"base_height\", new_tip->nHeight);\n+    result.pushKV(\"path\", fs::PathToString(path));\n+    return result;\n+},\n+    };\n+}\n+\n+const std::vector<RPCResult> RPCHelpForChainstate{\n+    {RPCResult::Type::NUM, \"blocks\", \"number of blocks in this chainstate\"},\n+    {RPCResult::Type::STR_HEX, \"bestblockhash\", \"blockhash of the tip\"},\n+    {RPCResult::Type::NUM, \"difficulty\", \"difficulty of the tip\"},\n+    {RPCResult::Type::NUM, \"verificationprogress\", \"progress towards the network tip\"},\n+    {RPCResult::Type::STR_HEX, \"snapshot_blockhash\", /*optional=*/true, \"the base block of the snapshot this chainstate is based on, if any\"},\n+    {RPCResult::Type::NUM, \"coins_db_cache_bytes\", \"size of the coinsdb cache\"},\n+    {RPCResult::Type::NUM, \"coins_tip_cache_bytes\", \"size of the coinstip cache\"},\n+};\n+\n+static RPCHelpMan getchainstates()\n+{\n+return RPCHelpMan{\n+        \"getchainstates\",\n+        \"\\nReturn information about chainstates.\\n\",\n+        {},\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\", {\n+                {RPCResult::Type::NUM, \"headers\", \"the number of headers seen so far\"},\n+                {RPCResult::Type::OBJ, \"normal\", /*optional=*/true, \"fully validated chainstate containing blocks this node has validated starting from the genesis block\", RPCHelpForChainstate},\n+                {RPCResult::Type::OBJ, \"snapshot\", /*optional=*/true, \"only present if an assumeutxo snapshot is loaded. Partially validated chainstate containing blocks this node has validated starting from the snapshot. After the snapshot is validated (when the 'normal' chainstate advances far enough to validate it), this chainstate will replace and become the 'normal' chainstate.\", RPCHelpForChainstate},\n+            }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"getchainstates\", \"\")\n+    + HelpExampleRpc(\"getchainstates\", \"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    LOCK(cs_main);\n+    UniValue obj(UniValue::VOBJ);\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349144430",
      "id" : 1349144430,
      "in_reply_to_id" : 1344698747,
      "line" : 2835,
      "node_id" : "PRRC_kwDOABII585Qak9u",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2835,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 144,
      "pull_request_review_id" : 1662529554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:44:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349144474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is addressed in #28562",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:44:29Z",
      "diff_hunk" : "@@ -2699,6 +2700,178 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\\n\"\n+        \"Once this snapshot is loaded, its contents will be \"\n+        \"deserialized into a second chainstate data structure, which is then used to sync to \"\n+        \"the network's tip under a security model very much like `assumevalid`. \"\n+        \"Meanwhile, the original chainstate will complete the initial block download process in \"\n+        \"the background, eventually validating up to the block that the snapshot is based upon.\\n\\n\"\n+\n+        \"The result is a usable bitcoind instance that is current with the network tip in a \"\n+        \"matter of minutes rather than hours. UTXO snapshot are typically obtained from \"\n+        \"third-party sources (HTTP, torrent, etc.) which is reasonable since their \"\n+        \"contents are always checked by hash.\\n\\n\"\n+\n+        \"You can find more information on this process in the `assumeutxo` design \"\n+        \"document (<https://github.com/bitcoin/bitcoin/blob/master/doc/design/assumeutxo.md>).\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::NUM, \"coins_loaded\", \"the number of coins loaded from the snapshot\"},\n+                    {RPCResult::Type::STR_HEX, \"tip_hash\", \"the hash of the base of the snapshot\"},\n+                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n+                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was loaded from\"},\n+                }\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    fs::path path{AbsPathForConfigVal(EnsureArgsman(node), fs::u8path(request.params[0].get_str()))};\n+\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    AutoFile afile{file};\n+    if (afile.IsNull()) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            \"Couldn't open file \" + path.u8string() + \" for reading.\");\n+    }\n+\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    ChainstateManager& chainman = *node.chainman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349144474",
      "id" : 1349144474,
      "in_reply_to_id" : 1344698532,
      "line" : 2762,
      "node_id" : "PRRC_kwDOABII585Qak-a",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 2762,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 71,
      "pull_request_review_id" : 1662529634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144474/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:44:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349144474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349148631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349148631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This should also be made obsolete by getting rid of chainstate names/types I suppose (see https://github.com/bitcoin/bitcoin/pull/28562#discussion_r1344824078, draft linked at the bottom).",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-06T17:49:35Z",
      "diff_hunk" : "@@ -154,24 +189,39 @@ class BlockManager\n      * A db flag records the fact that at least some block files have been pruned.\n      *\n      * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\n+     * @param        last_prune        The last height we're able to prune, according to the prune locks\n      */\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd);\n+    void FindFilesToPrune(\n+        std::set<int>& setFilesToPrune,\n+        int last_prune,\n+        const Chainstate& chain,\n+        ChainstateManager& chainman);\n \n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n-    int m_last_blockfile = 0;\n \n-    // Track the height of the highest block in m_last_blockfile whose undo\n-    // data has been written. Block data is written to block files in download\n-    // order, but is written to undo files in validation order, which is\n-    // usually in order by height. To avoid wasting disk space, undo files will\n-    // be trimmed whenever the corresponding block file is finalized and\n-    // the height of the highest block written to the block file equals the\n-    // height of the highest block written to the undo file. This is a\n-    // heuristic and can sometimes preemptively trim undo files that will write\n-    // more data later, and sometimes fail to trim undo files that can't have\n-    // more data written later.\n-    unsigned int m_undo_height_in_last_blockfile = 0;\n+    //! Since assumedvalid chainstates may be syncing a range of the chain that is very\n+    //! far away from the normal/background validation process, we should segment blockfiles\n+    //! for assumed chainstates. Otherwise, we might have wildly different height ranges\n+    //! mixed into the same block files, which would impair our ability to prune\n+    //! effectively.\n+    //!\n+    //! This data structure maintains separate blockfile number cursors for each\n+    //! BlockfileType. The ASSUMED state is initialized, when necessary, in FindBlockPos().\n+    //!\n+    //! The first element is the NORMAL cursor, second is ASSUMED.\n+    std::array<std::optional<BlockfileCursor>, BlockfileType::NUM_TYPES>\n+        m_blockfile_cursors GUARDED_BY(cs_LastBlockFile) = {\n+            BlockfileCursor{},\n+            std::nullopt,\n+    };\n+    int MaxBlockfileNum() const EXCLUSIVE_LOCKS_REQUIRED(cs_LastBlockFile)\n+    {\n+        static const BlockfileCursor empty_cursor;\n+        const auto& normal = m_blockfile_cursors[BlockfileType::NORMAL].value_or(empty_cursor);\n+        const auto& assumed = m_blockfile_cursors[BlockfileType::ASSUMED].value_or(empty_cursor);\n+        return std::max(normal.file_num, assumed.file_num);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1349148631",
      "id" : 1349148631,
      "in_reply_to_id" : 1344648372,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585Qal_X",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 223,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 125,
      "pull_request_review_id" : 1662535988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349148631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-06T17:49:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349148631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "post merge ACK . I've been testing thoroughly on mainnet, and everything worked as expected. I 'll provide more detalied feedback on follow ups.",
      "created_at" : "2023-10-06T21:10:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1751406642",
      "id" : 1751406642,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585oZFgy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751406642/reactions"
      },
      "updated_at" : "2023-10-06T21:10:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751406642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/87907936?v=4",
         "events_url" : "https://api.github.com/users/hernanmarino/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hernanmarino/followers",
         "following_url" : "https://api.github.com/users/hernanmarino/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hernanmarino/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hernanmarino",
         "id" : 87907936,
         "login" : "hernanmarino",
         "node_id" : "MDQ6VXNlcjg3OTA3OTM2",
         "organizations_url" : "https://api.github.com/users/hernanmarino/orgs",
         "received_events_url" : "https://api.github.com/users/hernanmarino/received_events",
         "repos_url" : "https://api.github.com/users/hernanmarino/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hernanmarino/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hernanmarino/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hernanmarino"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1350273252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350273252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like they did. Documented in #28618.",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-09T12:56:05Z",
      "diff_hunk" : "@@ -250,8 +259,19 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     return true;\n }\n \n-void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n+void BaseIndex::BlockConnected(ChainstateRole role, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex)\n {\n+    // Ignore events from the assumed-valid chain; we will process its blocks\n+    // (sequentially) after it is fully verified by the background chainstate. This\n+    // is to avoid any out-of-order indexing.\n+    //\n+    // TODO at some point we could parameterize whether a particular index can be",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1350273252",
      "id" : 1350273252,
      "in_reply_to_id" : 1343998883,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585Qe4jk",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 268,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 56,
      "pull_request_review_id" : 1664392850,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350273252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T12:56:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350273252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1350274812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350274812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You mean the `sleep` command?",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-09T12:57:33Z",
      "diff_hunk" : "@@ -0,0 +1,200 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes to test that snapshot use works\n+# properly with indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from, otherwise the default values prevent IBD from the server node.\n+EARLY_IBD_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $EARLY_IBD_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1350274812",
      "id" : 1350274812,
      "in_reply_to_id" : 1343952455,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII585Qe478",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 112,
      "pull_request_review_id" : 1664395493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350274812/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T12:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350274812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Imo most post-merge comments have now been addressed in either followup PRs or open issues: #28608, #28616, #28618, #28620, #28621, #28619,  (already merged: #28590, #28589, #28562) \r\n\r\nThe tracing issue could be updated to point to them.\r\n\r\nThese seem unaddressed:\r\n* https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1344694600 (something racy)\r\n* https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1345866623 (dead code to begin with?)\r\nhttps://github.com/bitcoin/bitcoin/pull/27596#discussion_r1343985564 (extra empty mempool check for clearer error message)\r\n\r\n",
      "created_at" : "2023-10-09T13:28:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1753015375",
      "id" : 1753015375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585ofORP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1753015375/reactions"
      },
      "updated_at" : "2023-10-09T13:29:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1753015375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351819194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351819194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry I meant `blocks_path`",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-10T08:14:38Z",
      "diff_hunk" : "@@ -979,3 +979,7 @@ def is_sqlite_compiled(self):\n     def is_bdb_compiled(self):\n         \"\"\"Checks whether the wallet module was compiled with BDB support.\"\"\"\n         return self.config[\"components\"].getboolean(\"USE_BDB\")\n+\n+    def has_blockfile(self, node, filenum: str):\n+        blocksdir = os.path.join(node.datadir, self.chain, 'blocks', '')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351819194",
      "id" : 1351819194,
      "in_reply_to_id" : 1344722098,
      "line" : 984,
      "node_id" : "PRRC_kwDOABII585Qkx-6",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 984,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 6,
      "pull_request_review_id" : 1666683330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351819194/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T08:14:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351819194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351823533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351823533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For example, grep for `# shellcheck disable=SC2086`",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-10T08:15:35Z",
      "diff_hunk" : "@@ -67,9 +67,13 @@ def main():\n         '*.sh',\n     ]\n     files = get_files(files_cmd)\n-    # remove everything that doesn't match this regex\n     reg = re.compile(r'src/[leveldb,secp256k1,minisketch]')\n-    files[:] = [file for file in files if not reg.match(file)]\n+\n+    def should_exclude(fname: str) -> bool:\n+        return bool(reg.match(fname)) or 'test_utxo_snapshots.sh' in fname",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351823533",
      "id" : 1351823533,
      "in_reply_to_id" : 1344725060,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585QkzCt",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 73,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/lint/lint-shell.py",
      "position" : 9,
      "pull_request_review_id" : 1666691685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351823533/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T08:15:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351823533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351827477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351827477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-10T08:16:35Z",
      "diff_hunk" : "@@ -0,0 +1,200 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes to test that snapshot use works\n+# properly with indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from, otherwise the default values prevent IBD from the server node.\n+EARLY_IBD_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $EARLY_IBD_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1351827477",
      "id" : 1351827477,
      "in_reply_to_id" : 1343952455,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII585Qk0AV",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 112,
      "pull_request_review_id" : 1666699922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351827477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T08:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1351827477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1352027886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352027886"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, addressed with #28628",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-10T09:38:58Z",
      "diff_hunk" : "@@ -67,9 +67,13 @@ def main():\n         '*.sh',\n     ]\n     files = get_files(files_cmd)\n-    # remove everything that doesn't match this regex\n     reg = re.compile(r'src/[leveldb,secp256k1,minisketch]')\n-    files[:] = [file for file in files if not reg.match(file)]\n+\n+    def should_exclude(fname: str) -> bool:\n+        return bool(reg.match(fname)) or 'test_utxo_snapshots.sh' in fname",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1352027886",
      "id" : 1352027886,
      "in_reply_to_id" : 1344725060,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585Qlk7u",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 73,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/lint/lint-shell.py",
      "position" : 9,
      "pull_request_review_id" : 1667062555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352027886/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T09:38:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352027886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1352256777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352256777"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed with #28631",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2023-10-10T11:02:15Z",
      "diff_hunk" : "@@ -0,0 +1,200 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes to test that snapshot use works\n+# properly with indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from, otherwise the default values prevent IBD from the server node.\n+EARLY_IBD_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $EARLY_IBD_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1352256777",
      "id" : 1352256777,
      "in_reply_to_id" : 1343952455,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII585Qmc0J",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 112,
      "pull_request_review_id" : 1667327591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352256777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T11:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1352256777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1480923337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480923337"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I> Could add a functional test for this?\r\n\r\nI just did, see https://github.com/bitcoin/bitcoin/pull/29394",
      "commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "created_at" : "2024-02-07T05:42:02Z",
      "diff_hunk" : "@@ -5157,6 +5185,14 @@ bool ChainstateManager::ActivateSnapshot(\n         return false;\n     }\n \n+    {\n+        LOCK(::cs_main);\n+        if (Assert(m_active_chainstate->GetMempool())->size() > 0) {\n+            LogPrintf(\"[snapshot] can't activate a snapshot when mempool not empty\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1480923337",
      "id" : 1480923337,
      "in_reply_to_id" : 1344713537,
      "line" : 5191,
      "node_id" : "PRRC_kwDOABII585YRRjJ",
      "original_commit_id" : "edbed31066e3674ba52b8c093ab235625527f383",
      "original_line" : 5191,
      "original_position" : 208,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 208,
      "pull_request_review_id" : 1866945244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480923337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-07T05:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1480923337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/87907936?v=4",
         "events_url" : "https://api.github.com/users/hernanmarino/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hernanmarino/followers",
         "following_url" : "https://api.github.com/users/hernanmarino/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hernanmarino/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hernanmarino",
         "id" : 87907936,
         "login" : "hernanmarino",
         "node_id" : "MDQ6VXNlcjg3OTA3OTM2",
         "organizations_url" : "https://api.github.com/users/hernanmarino/orgs",
         "received_events_url" : "https://api.github.com/users/hernanmarino/received_events",
         "repos_url" : "https://api.github.com/users/hernanmarino/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hernanmarino/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hernanmarino/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hernanmarino"
      }
   }
]
