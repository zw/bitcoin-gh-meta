[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29436).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/29436#pullrequestreview-1885261790), [naumenkogs](https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1953718864), [Empact](https://github.com/bitcoin/bitcoin/pull/29436#pullrequestreview-1904808402) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29043](https://github.com/bitcoin/bitcoin/pull/29043) (fuzz: make FuzzedDataProvider usage deterministic by martinus)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-02-14T18:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1944404918",
      "id" : 1944404918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII585z5UO2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1944404918/reactions"
      },
      "updated_at" : "2024-03-05T09:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1944404918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "cc: @vasild @naumenkogs @amitiuttarwar @mzumsande ",
      "created_at" : "2024-02-14T18:52:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1944409727",
      "id" : 1944409727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII585z5VZ_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1944409727/reactions"
      },
      "updated_at" : "2024-02-14T18:52:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1944409727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490381331"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490381331"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "instead of an optional of a vector, you could have the default value explicitly be all networks, or an empty vector be interpreted as all networks. probably the first one is clearer. ",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T05:04:26Z",
      "diff_hunk" : "@@ -154,12 +154,12 @@ class AddrMan\n      *                     an address from the new table or an empty pair. Passing `false` will return an\n      *                     empty pair or an address from either the new or tried table (it does not\n      *                     guarantee a tried entry).\n-     * @param[in] network  Select only addresses of this network (nullopt = all). Passing a network may\n+     * @param[in] networks Select only addresses of these networks (nullopt = all). Passing networks may\n      *                     slow down the search.\n      * @return    CAddress The record for the selected peer.\n      *            seconds  The last time we attempted to connect to that peer.\n      */\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<Network> network = std::nullopt) const;\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<std::vector<Network>> networks = std::nullopt) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490381331",
      "id" : 1490381331,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585Y1WoT",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 162,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 11,
      "pull_request_review_id" : 1881775768,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490381331/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-15T05:04:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490381331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490757436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490757436"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This should be `continue;`? If addrman has 0 addresses from some of the requested networks, it can still return an address from another requested network.\r\n\r\n```suggestion\r\n            if (it == m_network_counts.end()) {\r\n                continue;\r\n            }\r\n```",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:11:26Z",
      "diff_hunk" : "@@ -717,13 +717,17 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n+    if (networks.has_value()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : *networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) return {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490757436",
      "id" : 1490757436,
      "line" : 725,
      "node_id" : "PRRC_kwDOABII585Y2yc8",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 725,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 21,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490757436/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490757436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490766626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490766626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This code is correct, but is doing linear search in the list of networks. For values of up to 6 that is irrelevant, but if it is changed from `vector` to `unordered_set` then lookup is also shorter to write, in addition to being `O(1)`:\r\n\r\n```suggestion\r\n                    if (Assume(it != mapInfo.end()) && networks->contains(it->second.GetNetwork())) break;\r\n```",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:18:41Z",
      "diff_hunk" : "@@ -756,9 +760,10 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n             position = (initial_position + i) % ADDRMAN_BUCKET_SIZE;\n             node_id = GetEntry(search_tried, bucket, position);\n             if (node_id != -1) {\n-                if (network.has_value()) {\n+                if (networks.has_value()) {\n                     const auto it{mapInfo.find(node_id)};\n-                    if (Assume(it != mapInfo.end()) && it->second.GetNetwork() == *network) break;\n+                    auto& nets = *networks;\n+                    if (Assume(it != mapInfo.end()) && std::find(nets.begin(), nets.end(), it->second.GetNetwork()) != nets.end()) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490766626",
      "id" : 1490766626,
      "line" : 766,
      "node_id" : "PRRC_kwDOABII585Y20si",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 766,
      "original_position" : 42,
      "original_start_line" : 765,
      "path" : "src/addrman.cpp",
      "position" : 42,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490766626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 765,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490766626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490770478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490770478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This should work as well (untested):\r\n\r\n```cpp\r\n(void)addrman.Select(/*new_only=*/false, {NET_I2P});\r\n```\r\n\r\nSame in `src/test/addrman_tests.cpp`.",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:21:32Z",
      "diff_hunk" : "@@ -126,8 +126,10 @@ static void AddrManSelectByNetwork(benchmark::Bench& bench)\n \n     FillAddrMan(addrman);\n \n+    std::vector<Network> net_i2p = {NET_I2P};\n+\n     bench.run([&] {\n-        (void)addrman.Select(/*new_only=*/false, NET_I2P);\n+        (void)addrman.Select(/*new_only=*/false, net_i2p);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490770478",
      "id" : 1490770478,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII585Y21ou",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 132,
      "original_position" : 8,
      "original_start_line" : 129,
      "path" : "src/bench/addrman.cpp",
      "position" : 8,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490770478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 129,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490770478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490780583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490780583"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could be shorter (untested):\r\n\r\n```cpp\r\nstd::tie(addr, addr_last_try) = preferred_net.has_value()\r\n    ? addrman.Select(false, {*preferred_net})\r\n    : addrman.Select(false, g_reachable_nets.All());\r\n```",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:29:15Z",
      "diff_hunk" : "@@ -2672,14 +2680,17 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                     // a currently-connected peer.\n                     addrman.Good(addr);\n                     // Select a new table address for our feeler instead.\n-                    std::tie(addr, addr_last_try) = addrman.Select(true);\n+                    std::tie(addr, addr_last_try) = addrman.Select(true, networks);\n                 }\n             } else {\n                 // Not a feeler\n                 // If preferred_net has a value set, pick an extra outbound\n                 // peer from that network. The eviction logic in net_processing\n                 // ensures that a peer from another network will be evicted.\n-                std::tie(addr, addr_last_try) = addrman.Select(false, preferred_net);\n+                if (preferred_net.has_value()) {\n+                    networks = {*preferred_net};\n+                }\n+                std::tie(addr, addr_last_try) = addrman.Select(false, networks);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490780583",
      "id" : 1490780583,
      "line" : 2693,
      "node_id" : "PRRC_kwDOABII585Y24Gn",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 2693,
      "original_position" : 40,
      "original_start_line" : 2682,
      "path" : "src/net.cpp",
      "position" : 40,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490780583/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2682,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490780583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490794321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490794321"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could end up passing an empty container (`vector` or `unordered_set` if you decide to change it). Maybe this:\r\n\r\n```cpp\r\nif (nets.empty()) {\r\n    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool());\r\n} else {\r\n    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool(), nets);\r\n}",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:39:13Z",
      "diff_hunk" : "@@ -275,7 +275,16 @@ FUZZ_TARGET(addrman, .init = initialize_addrman)\n         /*max_pct=*/fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, 4096),\n         network,\n         /*filtered=*/fuzzed_data_provider.ConsumeBool());\n-    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool(), network);\n+\n+    auto all_networks = ALL_NETWORKS;\n+    FastRandomContext fast_random_context{ConsumeUInt256(fuzzed_data_provider)};\n+    Shuffle(all_networks.begin(), all_networks.end(), fast_random_context);\n+    std::vector<Network> nets;\n+    for (size_t i = 0; i < all_networks.size() && fuzzed_data_provider.ConsumeBool(); i++) {\n+        nets.push_back(all_networks[i]);\n+    }\n+    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool(), nets);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490794321",
      "id" : 1490794321,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585Y27dR",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 286,
      "original_position" : 13,
      "original_start_line" : 282,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 13,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490794321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 282,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490794321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490807334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490807334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you extend the `ReachableNets` class like this:\r\n\r\n```diff\r\n--- i/src/netbase.h\r\n+++ w/src/netbase.h\r\n@@ -102,12 +102,18 @@ public:\r\n     [[nodiscard]] bool Contains(const CNetAddr& addr) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\r\n     {   \r\n         AssertLockNotHeld(m_mutex);\r\n         return Contains(addr.GetNetwork());\r\n     }\r\n\r\n+    [[nodiscard]] std::unordered_set<Network> All() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\r\n+    {\r\n+        LOCK(m_mutex);\r\n+        return m_reachable;\r\n+    }\r\n+\r\n private:\r\n     mutable Mutex m_mutex;\r\n\r\n     std::unordered_set<Network> m_reachable GUARDED_BY(m_mutex){\r\n```\r\n\r\nThen you can pass directly `g_reachable_nets.All()` to `Select()` without an intermediate variable.",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T10:46:54Z",
      "diff_hunk" : "@@ -2564,6 +2564,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         bool fFeeler = false;\n         std::optional<Network> preferred_net;\n \n+        std::vector<Network> networks;\n+        for (int i = 0; i != NET_MAX; i++) {\n+            Network net = static_cast<Network>(i);\n+            if (g_reachable_nets.Contains(net)) {\n+                networks.push_back(net);\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490807334",
      "id" : 1490807334,
      "line" : 2573,
      "node_id" : "PRRC_kwDOABII585Y2-om",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 2573,
      "original_position" : 10,
      "original_start_line" : 2567,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_review_id" : 1882354205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490807334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2567,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T10:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490807334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490857252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490857252"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "With this PR all production code passes both arguments. No need anymore for defaults. This compiles:\r\n\r\n```diff\r\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<std::vector<Network>> networks = std::nullopt) const;\r\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only, std::vector<Network> networks) const;\r\n```\r\n\r\nSome tests use `Select()` and I adjusted them to do `Select(false, {})` just to check that the compilation will succeed. They can be adjusted to\r\n`Select(false, g_reachable_nets.All())`\r\nor\r\n`Select(false, {NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS})`\r\nif you decide to drop the defaults.",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T11:22:18Z",
      "diff_hunk" : "@@ -154,12 +154,12 @@ class AddrMan\n      *                     an address from the new table or an empty pair. Passing `false` will return an\n      *                     empty pair or an address from either the new or tried table (it does not\n      *                     guarantee a tried entry).\n-     * @param[in] network  Select only addresses of this network (nullopt = all). Passing a network may\n+     * @param[in] networks Select only addresses of these networks (nullopt = all). Passing networks may\n      *                     slow down the search.\n      * @return    CAddress The record for the selected peer.\n      *            seconds  The last time we attempted to connect to that peer.\n      */\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<Network> network = std::nullopt) const;\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<std::vector<Network>> networks = std::nullopt) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490857252",
      "id" : 1490857252,
      "in_reply_to_id" : 1490381331,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585Y3K0k",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 162,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 11,
      "pull_request_review_id" : 1882520607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490857252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-15T11:22:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490857252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490912711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490912711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, nice catch. I'll address it.",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T12:06:54Z",
      "diff_hunk" : "@@ -717,13 +717,17 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n+    if (networks.has_value()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : *networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) return {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490912711",
      "id" : 1490912711,
      "in_reply_to_id" : 1490757436,
      "line" : 725,
      "node_id" : "PRRC_kwDOABII585Y3YXH",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 725,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 21,
      "pull_request_review_id" : 1882608433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490912711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-15T12:06:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490912711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490938595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490938595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It doesn't work with vector I guess. But since I'll change it to `unordered_set`, it will work.",
      "commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "created_at" : "2024-02-15T12:30:17Z",
      "diff_hunk" : "@@ -126,8 +126,10 @@ static void AddrManSelectByNetwork(benchmark::Bench& bench)\n \n     FillAddrMan(addrman);\n \n+    std::vector<Network> net_i2p = {NET_I2P};\n+\n     bench.run([&] {\n-        (void)addrman.Select(/*new_only=*/false, NET_I2P);\n+        (void)addrman.Select(/*new_only=*/false, net_i2p);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490938595",
      "id" : 1490938595,
      "in_reply_to_id" : 1490770478,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII585Y3erj",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 132,
      "original_position" : 8,
      "original_start_line" : 129,
      "path" : "src/bench/addrman.cpp",
      "position" : 8,
      "pull_request_review_id" : 1882650103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490938595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 129,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T12:30:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1490938595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491007792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491007792"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Empty container and nothing means the same, all networks.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-15T13:26:52Z",
      "diff_hunk" : "@@ -275,7 +275,16 @@ FUZZ_TARGET(addrman, .init = initialize_addrman)\n         /*max_pct=*/fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, 4096),\n         network,\n         /*filtered=*/fuzzed_data_provider.ConsumeBool());\n-    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool(), network);\n+\n+    auto all_networks = ALL_NETWORKS;\n+    FastRandomContext fast_random_context{ConsumeUInt256(fuzzed_data_provider)};\n+    Shuffle(all_networks.begin(), all_networks.end(), fast_random_context);\n+    std::vector<Network> nets;\n+    for (size_t i = 0; i < all_networks.size() && fuzzed_data_provider.ConsumeBool(); i++) {\n+        nets.push_back(all_networks[i]);\n+    }\n+    (void)const_addr_man.Select(fuzzed_data_provider.ConsumeBool(), nets);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491007792",
      "id" : 1491007792,
      "in_reply_to_id" : 1490794321,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Y3vkw",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 286,
      "original_position" : 13,
      "original_start_line" : 282,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 1882761408,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491007792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T13:45:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491007792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491008021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice idea! I'll address it.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-15T13:27:02Z",
      "diff_hunk" : "@@ -2564,6 +2564,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         bool fFeeler = false;\n         std::optional<Network> preferred_net;\n \n+        std::vector<Network> networks;\n+        for (int i = 0; i != NET_MAX; i++) {\n+            Network net = static_cast<Network>(i);\n+            if (g_reachable_nets.Contains(net)) {\n+                networks.push_back(net);\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491008021",
      "id" : 1491008021,
      "in_reply_to_id" : 1490807334,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Y3voV",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 2573,
      "original_position" : 10,
      "original_start_line" : 2567,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1882761728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008021/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T13:27:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491008584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008584"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice, I'll address it.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-15T13:27:28Z",
      "diff_hunk" : "@@ -756,9 +760,10 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n             position = (initial_position + i) % ADDRMAN_BUCKET_SIZE;\n             node_id = GetEntry(search_tried, bucket, position);\n             if (node_id != -1) {\n-                if (network.has_value()) {\n+                if (networks.has_value()) {\n                     const auto it{mapInfo.find(node_id)};\n-                    if (Assume(it != mapInfo.end()) && it->second.GetNetwork() == *network) break;\n+                    auto& nets = *networks;\n+                    if (Assume(it != mapInfo.end()) && std::find(nets.begin(), nets.end(), it->second.GetNetwork()) != nets.end()) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1491008584",
      "id" : 1491008584,
      "in_reply_to_id" : 1490766626,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Y3vxI",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 766,
      "original_position" : 42,
      "original_start_line" : 765,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 1882762615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008584/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-15T13:27:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1491008584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed addressing:\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490381331\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490757436\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490780583\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490807334\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1490770478\r\n\r\nThanks @vasild and @amitiuttarwar for reviewing!\r\n",
      "created_at" : "2024-02-15T13:45:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1946127103",
      "id" : 1946127103,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII585z_4r_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1946127103/reactions"
      },
      "updated_at" : "2024-02-15T13:45:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1946127103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1492529744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1492529744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Does not matter now, but it should work with vector as well.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-16T14:18:45Z",
      "diff_hunk" : "@@ -126,8 +126,10 @@ static void AddrManSelectByNetwork(benchmark::Bench& bench)\n \n     FillAddrMan(addrman);\n \n+    std::vector<Network> net_i2p = {NET_I2P};\n+\n     bench.run([&] {\n-        (void)addrman.Select(/*new_only=*/false, NET_I2P);\n+        (void)addrman.Select(/*new_only=*/false, net_i2p);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1492529744",
      "id" : 1492529744,
      "in_reply_to_id" : 1490770478,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Y9jJQ",
      "original_commit_id" : "2096aeabec288bd2852593f0c965a2a9d22ad0c8",
      "original_line" : 132,
      "original_position" : 8,
      "original_start_line" : 129,
      "path" : "src/bench/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 1885264596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1492529744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-16T14:18:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1492529744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> About the graph in the OP: \"... until it finds an address from a network that compose 20% ...\". The chance of not getting the result after N tries is (8/10)^N. For example for N=25 that is less than 0.004. What is the explanation of having so many dots so high? Uneven distribution within addrman?\r\n\r\nThat was what I was expecting too. I'll investigate but yes I think it might be an uneven distribution. Btw, this is not deterministic.",
      "created_at" : "2024-02-16T19:45:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1949222350",
      "id" : 1949222350,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5850LsXO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1949222350/reactions"
      },
      "updated_at" : "2024-02-16T19:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1949222350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494214557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494214557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3f99f5a6e58fae4981228929045ed7be32463381\r\n\r\nMight be worth making this overflow-safe?",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-19T09:02:54Z",
      "diff_hunk" : "@@ -717,13 +717,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) {\n+                continue;\n+            }\n+            auto counts = it->second;\n+            new_count += counts.n_new;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494214557",
      "id" : 1494214557,
      "line" : 729,
      "node_id" : "PRRC_kwDOABII585ZD-ed",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 729,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 29,
      "pull_request_review_id" : 1887888527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494214557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T10:32:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494214557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494332423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494332423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Might as well fix `    if (new_count + tried_count == 0) return {};` above. While it seems like a bug in the existing code, it's really hard to trigger.... feeding addrman with that much garbage would be a failure probably before the size_t limit is hit :)",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-19T10:25:14Z",
      "diff_hunk" : "@@ -717,13 +717,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) {\n+                continue;\n+            }\n+            auto counts = it->second;\n+            new_count += counts.n_new;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494332423",
      "id" : 1494332423,
      "in_reply_to_id" : 1494214557,
      "line" : 729,
      "node_id" : "PRRC_kwDOABII585ZEbQH",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 729,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 29,
      "pull_request_review_id" : 1887888527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494332423/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T10:32:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494332423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494903447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494903447"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Might be worth making this overflow-safe?\r\n\r\nI don't know, I don't see a viable way of reaching that.\r\n\r\n> it's really hard to trigger.... feeding addrman with that much garbage would be a failure probably before the size_t limit is hit :)\r\n\r\nI believe that's impractical due to the limited size of addrman.\r\n",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-19T18:10:34Z",
      "diff_hunk" : "@@ -717,13 +717,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) {\n+                continue;\n+            }\n+            auto counts = it->second;\n+            new_count += counts.n_new;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1494903447",
      "id" : 1494903447,
      "in_reply_to_id" : 1494214557,
      "line" : 729,
      "node_id" : "PRRC_kwDOABII585ZGmqX",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 729,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 29,
      "pull_request_review_id" : 1888979988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494903447/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T18:10:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1494903447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1495427464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495427464"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">I believe that's impractical due to the limited size of addrman.\r\n\r\nRight, probably fine to keep it this way for both cases.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-20T08:38:55Z",
      "diff_hunk" : "@@ -717,13 +717,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {\n+        new_count = 0;\n+        tried_count = 0;\n+        for (auto& network : networks) {\n+            auto it = m_network_counts.find(network);\n+            if (it == m_network_counts.end()) {\n+                continue;\n+            }\n+            auto counts = it->second;\n+            new_count += counts.n_new;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1495427464",
      "id" : 1495427464,
      "in_reply_to_id" : 1494214557,
      "line" : 729,
      "node_id" : "PRRC_kwDOABII585ZImmI",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 729,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 29,
      "pull_request_review_id" : 1889779417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495427464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T08:38:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495427464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-20T08:39:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1953718864",
      "id" : 1953718864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5850c2JQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1953718864/reactions"
      },
      "updated_at" : "2024-02-20T08:39:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1953718864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1496276836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496276836"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks like the case of empty networks is no longer used outside of tests after this PR. In that case, should we drop the default args and simplify the implementation?",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-20T18:07:12Z",
      "diff_hunk" : "@@ -154,12 +155,12 @@ class AddrMan\n      *                     an address from the new table or an empty pair. Passing `false` will return an\n      *                     empty pair or an address from either the new or tried table (it does not\n      *                     guarantee a tried entry).\n-     * @param[in] network  Select only addresses of this network (nullopt = all). Passing a network may\n+     * @param[in] networks Select only addresses of these networks (empty = all). Passing networks may\n      *                     slow down the search.\n      * @return    CAddress The record for the selected peer.\n      *            seconds  The last time we attempted to connect to that peer.\n      */\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<Network> network = std::nullopt) const;\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::unordered_set<Network> networks = {}) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1496276836",
      "id" : 1496276836,
      "line" : 163,
      "node_id" : "PRRC_kwDOABII585ZL19k",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 163,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 19,
      "pull_request_review_id" : 1891133220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496276836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T18:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496276836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1497744510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497744510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is this supposed to do? :/",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-21T15:02:52Z",
      "diff_hunk" : "@@ -275,7 +279,8 @@ BOOST_AUTO_TEST_CASE(addrman_select_special)\n     // since the only ipv4 address is on the new table, ensure that the new\n     // table gets selected even if new_only is false. if the table was being\n     // selected at random, this test will sporadically fail\n-    BOOST_CHECK(addrman->Select(/*new_only=*/false, NET_IPV4).first == addr1);\n+    std::unordered_set<Network> {NET_IPV4} = {NET_IPV4};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1497744510",
      "id" : 1497744510,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII585ZRcR-",
      "original_commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "original_line" : 282,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/addrman_tests.cpp",
      "position" : 84,
      "pull_request_review_id" : 1893454940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497744510/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T15:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1497744510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1499270150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499270150"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Leftover from previous changes, thanks, I'll remove it.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-22T13:48:38Z",
      "diff_hunk" : "@@ -275,7 +279,8 @@ BOOST_AUTO_TEST_CASE(addrman_select_special)\n     // since the only ipv4 address is on the new table, ensure that the new\n     // table gets selected even if new_only is false. if the table was being\n     // selected at random, this test will sporadically fail\n-    BOOST_CHECK(addrman->Select(/*new_only=*/false, NET_IPV4).first == addr1);\n+    std::unordered_set<Network> {NET_IPV4} = {NET_IPV4};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1499270150",
      "id" : 1499270150,
      "in_reply_to_id" : 1497744510,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII585ZXQwG",
      "original_commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "original_line" : 282,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/addrman_tests.cpp",
      "position" : 84,
      "pull_request_review_id" : 1895900755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499270150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T13:48:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499270150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1499286213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499286213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, sure! I'll address it.",
      "commit_id" : "7edb07ca800991f7c88d582b880a392efe17f31d",
      "created_at" : "2024-02-22T13:59:38Z",
      "diff_hunk" : "@@ -154,12 +155,12 @@ class AddrMan\n      *                     an address from the new table or an empty pair. Passing `false` will return an\n      *                     empty pair or an address from either the new or tried table (it does not\n      *                     guarantee a tried entry).\n-     * @param[in] network  Select only addresses of this network (nullopt = all). Passing a network may\n+     * @param[in] networks Select only addresses of these networks (empty = all). Passing networks may\n      *                     slow down the search.\n      * @return    CAddress The record for the selected peer.\n      *            seconds  The last time we attempted to connect to that peer.\n      */\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::optional<Network> network = std::nullopt) const;\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::unordered_set<Network> networks = {}) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1499286213",
      "id" : 1499286213,
      "in_reply_to_id" : 1496276836,
      "line" : 163,
      "node_id" : "PRRC_kwDOABII585ZXUrF",
      "original_commit_id" : "3f99f5a6e58fae4981228929045ed7be32463381",
      "original_line" : 163,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 19,
      "pull_request_review_id" : 1895926041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499286213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T13:59:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499286213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> the performance goes down by a factor of ~5 for me\r\n\r\nIf this is correct and can be reproduced by others, I think that something should be done about it. If this PR would increase performance for a  rare and transient case (right after the users switched their onlynet parameters) but decrease performance for each `Select()` call in the typical scenario (addrman has mostly addrs from reachable networks), the overall impact on performance of this PR would be clearly negative.\r\nOne possibility might be to track the percentage of non-reachable addrs while loading AddrMan (we can't get more unreachable addrs afterwards) and only execute the slower logic if that is larger than some threshold (for example, 50%).",
      "created_at" : "2024-02-22T16:09:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1959775549",
      "id" : 1959775549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5850z809",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959775549/reactions"
      },
      "updated_at" : "2024-02-22T16:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959775549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> If this is correct and can be reproduced by others, I think that something should be done about it. If this PR would increase performance for a rare and transient case (right after the users switched their onlynet parameters) but decrease performance for each Select() call in the typical scenario (addrman has mostly addrs from reachable networks), the overall impact on performance of this PR would be clearly negative.\r\nOne possibility might be to track the percentage of non-reachable addrs while loading AddrMan (we can't get more unreachable addrs afterwards) and only execute the slower logic if that is larger than some threshold (for example, 50%).\r\n\r\nI'm reproducing it to check it.",
      "created_at" : "2024-02-22T16:46:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1959849246",
      "id" : 1959849246,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII58500O0e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959849246/reactions"
      },
      "updated_at" : "2024-02-22T16:46:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959849246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/21977629586</sub>",
      "created_at" : "2024-02-26T11:02:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1963866552",
      "id" : 1963866552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5851Djm4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1963866552/reactions"
      },
      "updated_at" : "2024-02-26T11:02:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1963866552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mzumsande you're right! \r\n\r\nI checked the performance goes down when calling `Select` when addrman only has addrs for reachable nets. So, I changed the approach to call `Select` with networks only whether the number of addresses from reachable networks in the addrman is less than 50%. This should be enough to cover the cases where this is an issue.\r\n\r\nSo, when initializing `CConnman`, we check whether the number of addresses from reachable networks in the addrman is less than 50%, if so, we call `Select` passing the networks.\r\n\r\ncc: @vasild @naumenkogs (due previous ACK)",
      "created_at" : "2024-02-26T11:06:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1963873765",
      "id" : 1963873765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5851DlXl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1963873765/reactions"
      },
      "updated_at" : "2024-02-26T11:06:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1963873765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503659916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503659916"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: [`contains`](https://en.cppreference.com/w/cpp/container/unordered_set/contains) is equivalent but more semantically correct here",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T05:31:47Z",
      "diff_hunk" : "@@ -1016,6 +1021,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)\n+{\n+    AssertLockHeld(cs);\n+\n+    if (m_network_counts.empty()) {\n+        return false;\n+    }\n+\n+    int total_size{0};\n+    int reachable_size{0};\n+\n+    for (const auto& item : m_network_counts) {\n+        const auto& net{item.first};\n+        const auto& count{item.second};\n+\n+        total_size += (count.n_new + count.n_tried);\n+\n+        if (networks.count(net)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503659916",
      "id" : 1503659916,
      "line" : 1041,
      "node_id" : "PRRC_kwDOABII585ZoAeM",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 1041,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 68,
      "pull_request_review_id" : 1902554269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503659916/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T05:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503659916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503668606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503668606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: could inline these",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T05:45:09Z",
      "diff_hunk" : "@@ -3285,6 +3288,12 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n         scheduler.scheduleEvery([this] { ASMapHealthCheck(); }, ASMAP_HEALTH_CHECK_INTERVAL);\n     }\n \n+    auto reachable_nets{g_reachable_nets.All()};\n+    const bool has_few_addresses{addrman.HasFewReachableAddresses(reachable_nets)};\n+    if (has_few_addresses) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503668606",
      "id" : 1503668606,
      "line" : 3293,
      "node_id" : "PRRC_kwDOABII585ZoCl-",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 3293,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 1902566839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503668606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T05:45:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503668606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503672316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503672316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: could return this directly",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T05:50:42Z",
      "diff_hunk" : "@@ -1016,6 +1021,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)\n+{\n+    AssertLockHeld(cs);\n+\n+    if (m_network_counts.empty()) {\n+        return false;\n+    }\n+\n+    int total_size{0};\n+    int reachable_size{0};\n+\n+    for (const auto& item : m_network_counts) {\n+        const auto& net{item.first};\n+        const auto& count{item.second};\n+\n+        total_size += (count.n_new + count.n_tried);\n+\n+        if (networks.count(net)) {\n+            reachable_size += (count.n_new + count.n_tried);\n+        }\n+    }\n+\n+    if (reachable_size < total_size / 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503672316",
      "id" : 1503672316,
      "line" : 1046,
      "node_id" : "PRRC_kwDOABII585ZoDf8",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 1046,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 73,
      "pull_request_review_id" : 1902572174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503672316/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T05:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503672316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503675942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503675942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be [`m_networks_with_addrs`](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c)",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T05:56:07Z",
      "diff_hunk" : "@@ -1396,6 +1396,9 @@ class CConnman\n     // P2P timeout in seconds\n     std::chrono::seconds m_peer_connect_timeout;\n \n+    // Reachable networks that have addresses in the addrman\n+    std::unordered_set<Network> networks_with_addrs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503675942",
      "id" : 1503675942,
      "line" : 1400,
      "node_id" : "PRRC_kwDOABII585ZoEYm",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 1400,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 5,
      "pull_request_review_id" : 1902578690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503675942/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T05:56:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503675942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503683117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503683117"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`networks` could be a const reference throughout, no?",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T06:06:02Z",
      "diff_hunk" : "@@ -712,7 +712,7 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\n     }\n }\n \n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::optional<Network> network) const\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::unordered_set<Network> networks) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503683117",
      "id" : 1503683117,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII585ZoGIt",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 715,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 5,
      "pull_request_review_id" : 1902590359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503683117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T06:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503683117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503704858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503704858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So, to be explicit, this uses `g_reachable_nets` if `reachable_size < total_size / 2` otherwise all nets. The switch is to avoid the cost of the filtering if the filtering doesn't much reduce the set size, yes?\r\n\r\nA comment to that effect might be helpful, as I had to puzzle out a bit why the value was set only in this case.",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T06:32:14Z",
      "diff_hunk" : "@@ -3285,6 +3288,12 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n         scheduler.scheduleEvery([this] { ASMapHealthCheck(); }, ASMAP_HEALTH_CHECK_INTERVAL);\n     }\n \n+    auto reachable_nets{g_reachable_nets.All()};\n+    const bool has_few_addresses{addrman.HasFewReachableAddresses(reachable_nets)};\n+    if (has_few_addresses) {\n+        networks_with_addrs = reachable_nets;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503704858",
      "id" : 1503704858,
      "line" : 3294,
      "node_id" : "PRRC_kwDOABII585ZoLca",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 3294,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 43,
      "pull_request_review_id" : 1902627837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503704858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T06:33:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503704858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503979427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503979427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "An outside node easily influences the outcome by feeding garbage, right? Then I'd suggest commenting along the following lines: \"Should not be used for anything critical since it's easily [...]\"",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T10:13:01Z",
      "diff_hunk" : "@@ -1016,6 +1016,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503979427",
      "id" : 1503979427,
      "line" : 1024,
      "node_id" : "PRRC_kwDOABII585ZpOej",
      "original_commit_id" : "44aba6cbff49c034703d79b86dc5995d6a7b6c1f",
      "original_line" : 1019,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 51,
      "pull_request_review_id" : 1903087340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503979427/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T10:15:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503979427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503982139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503982139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Another improvement could be differentiating new/tried here, since tried is harder to influence.",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T10:14:45Z",
      "diff_hunk" : "@@ -1016,6 +1016,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503982139",
      "id" : 1503982139,
      "in_reply_to_id" : 1503979427,
      "line" : 1024,
      "node_id" : "PRRC_kwDOABII585ZpPI7",
      "original_commit_id" : "44aba6cbff49c034703d79b86dc5995d6a7b6c1f",
      "original_line" : 1019,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 51,
      "pull_request_review_id" : 1903087340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503982139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T10:15:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503982139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504053273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504053273"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The switch is to avoid the cost of the filtering if the filtering doesn't much reduce the set size, yes?\r\n\r\nYes, I'll put a comment explaining that.",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T11:07:47Z",
      "diff_hunk" : "@@ -3285,6 +3288,12 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n         scheduler.scheduleEvery([this] { ASMapHealthCheck(); }, ASMAP_HEALTH_CHECK_INTERVAL);\n     }\n \n+    auto reachable_nets{g_reachable_nets.All()};\n+    const bool has_few_addresses{addrman.HasFewReachableAddresses(reachable_nets)};\n+    if (has_few_addresses) {\n+        networks_with_addrs = reachable_nets;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504053273",
      "id" : 1504053273,
      "in_reply_to_id" : 1503704858,
      "line" : 3294,
      "node_id" : "PRRC_kwDOABII585ZpggZ",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 3294,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 43,
      "pull_request_review_id" : 1903207043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504053273/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T11:07:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504053273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504084907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504084907"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> An outside node easily influences the outcome by feeding garbage, right? \r\n\r\nI don't think so, since we're checking by network and we do not store addresses from unreachable networks.",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T11:34:48Z",
      "diff_hunk" : "@@ -1016,6 +1016,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504084907",
      "id" : 1504084907,
      "in_reply_to_id" : 1503979427,
      "line" : 1024,
      "node_id" : "PRRC_kwDOABII585ZpoOr",
      "original_commit_id" : "44aba6cbff49c034703d79b86dc5995d6a7b6c1f",
      "original_line" : 1019,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 51,
      "pull_request_review_id" : 1903258061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504084907/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504084907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504085425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504085425"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Another improvement could be differentiating new/tried here, since tried is harder to influence.\r\n\r\nSure! ",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T11:35:19Z",
      "diff_hunk" : "@@ -1016,6 +1016,35 @@ std::optional<AddressPosition> AddrManImpl::FindAddressEntry_(const CAddress& ad\n     }\n }\n \n+bool AddrManImpl::HasFewReachableAddresses_(const std::unordered_set<Network>& networks)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504085425",
      "id" : 1504085425,
      "in_reply_to_id" : 1503979427,
      "line" : 1024,
      "node_id" : "PRRC_kwDOABII585ZpoWx",
      "original_commit_id" : "44aba6cbff49c034703d79b86dc5995d6a7b6c1f",
      "original_line" : 1019,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 51,
      "pull_request_review_id" : 1903258973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504085425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T11:35:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504085425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504125116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504125116"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I'll address it.",
      "commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "created_at" : "2024-02-27T12:09:59Z",
      "diff_hunk" : "@@ -712,7 +712,7 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\n     }\n }\n \n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::optional<Network> network) const\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::unordered_set<Network> networks) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504125116",
      "id" : 1504125116,
      "in_reply_to_id" : 1503683117,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII585ZpyC8",
      "original_commit_id" : "7b4b9535a7da91627eefc331b50d3b173af185fd",
      "original_line" : 715,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 5,
      "pull_request_review_id" : 1903326025,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504125116/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T12:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504125116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed addressing:\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503982139\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503704858\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503683117\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503675942\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503672316\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503668606\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#discussion_r1503659916\r\n\r\nI changed the approach to know verify new and tried table isolated, so if there is less than 50% of reachable addresses than we filter the selection (selecting from new table will consider data from new table only, for example).\r\n\r\nThanks, @empact and @naumenkogs.\r\n",
      "created_at" : "2024-02-27T17:31:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1967260020",
      "id" : 1967260020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5851QgF0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967260020/reactions"
      },
      "updated_at" : "2024-02-27T17:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967260020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504723525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504723525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: IMO the code will be more self-documenting if you use 2 separate variables for new vs tried, rather than a pair here, because to make sense of the pair you have to refer back to the definition, while new vs tried in the variable name will be immediately apparent.\r\n\r\nCould still return a pair from `NetworksWithAddresses`, and unpack it for assignment.",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-02-27T18:08:49Z",
      "diff_hunk" : "@@ -1396,6 +1396,13 @@ class CConnman\n     // P2P timeout in seconds\n     std::chrono::seconds m_peer_connect_timeout;\n \n+    /**\n+     * Reachable networks that have addresses in the addrman (new, tried). It is filled when there\n+     * are few reachable addresses in addrman and used to filter the addrman's selection.\n+     * Otherwise, we avoid the cost of the filtering.\n+     */\n+    std::pair<std::unordered_set<Network>, std::unordered_set<Network>>  m_networks_with_addrs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504723525",
      "id" : 1504723525,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZsEJF",
      "original_commit_id" : "ef1cd394bbee37e3674a68378245f56dcba154d1",
      "original_line" : 1404,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1904420269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504723525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T18:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504723525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504744682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504744682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sounds good, I'll address it.",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-02-27T18:25:33Z",
      "diff_hunk" : "@@ -1396,6 +1396,13 @@ class CConnman\n     // P2P timeout in seconds\n     std::chrono::seconds m_peer_connect_timeout;\n \n+    /**\n+     * Reachable networks that have addresses in the addrman (new, tried). It is filled when there\n+     * are few reachable addresses in addrman and used to filter the addrman's selection.\n+     * Otherwise, we avoid the cost of the filtering.\n+     */\n+    std::pair<std::unordered_set<Network>, std::unordered_set<Network>>  m_networks_with_addrs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504744682",
      "id" : 1504744682,
      "in_reply_to_id" : 1504723525,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZsJTq",
      "original_commit_id" : "ef1cd394bbee37e3674a68378245f56dcba154d1",
      "original_line" : 1404,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1904474929,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504744682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T18:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504744682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed addressing https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1504723525.",
      "created_at" : "2024-02-27T18:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1967349101",
      "id" : 1967349101,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII5851Q11t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967349101/reactions"
      },
      "updated_at" : "2024-02-27T18:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967349101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1506916729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having an `unordered_set` to choose a subset of 7 values from an enum seems a bit overkill. Doing:\r\n\r\n```c++\r\n    std::bitset<NET_MAX> network_bitset;\r\n    for (net : networks) { if (0 <= net && net < NET_MAX) network_bitset.set(net); }\r\n\r\n    ...\r\n\r\n    if (network_bitset.test(it->second.GetNetwork())) { /* this is one of the networks i wanted!! */ }\r\n```\r\n\r\nseems like it would be better. The `network_bitset` value could be set as part of initializing addrman, and the test should be fast enough to do it always, I think?",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-02-29T02:26:02Z",
      "diff_hunk" : "@@ -712,7 +712,7 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\n     }\n }\n \n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::optional<Network> network) const\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, const std::unordered_set<Network>& networks) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1506916729",
      "id" : 1506916729,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII585Z0bl5",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 715,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 5,
      "pull_request_review_id" : 1907816563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T02:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506916729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1507697656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1507697656"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`unordered_set` is the most semantically sound container for this. It is also the most convenient and easy to use. For the same reasons we use `std::string` to store fixed strings or string literals. IMO a deviation from that with a more verbose alternative is justified only if it provides a noticeable performance improvement.",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-02-29T14:41:40Z",
      "diff_hunk" : "@@ -712,7 +712,7 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\n     }\n }\n \n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::optional<Network> network) const\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, const std::unordered_set<Network>& networks) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1507697656",
      "id" : 1507697656,
      "in_reply_to_id" : 1506916729,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII585Z3aP4",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 715,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 5,
      "pull_request_review_id" : 1909069268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1507697656/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T14:41:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1507697656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1510609846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1510609846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am trying to understand better the performance of this. Posting here to avoid cluttering the PR's main discussion thread.\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/29436#pullrequestreview-1891096814:\r\n> I tried to test the performance impact on the \"normal\" case of an addrman that only has addrs for reachable nets:\r\nIf I change the AddrManSelect benchmark to use addrman.Select(false, g_reachable_nets.All()); the performance goes down by a factor of ~5 for me\r\n\r\nOne thing to note here is that the benchmark fills addrman solely with IPv6 addresses. That's not representative. So I borrowed the `peers.dat` from my mainnet node and ran the tests below.\r\n\r\nAs a start I began from 7edb07ca80 (this PR before the performance related tweaks). My aim was to 1. confirm that there is indeed a performance issue and 2. to understand where exactly it comes from so it can be addressed in the best way. Then I compared with the PR and then I compared with the PR + a change to make the last argument of `Select()` const ref.\r\n\r\naddrman size:\r\n```\r\nIPV4: 49123\r\nIPV6: 11071\r\nONION:15096\r\nI2P:   1863\r\nCJDNS:    2\r\n```\r\n\r\nNumbers in ns/op (bigger number => slower).\r\n\r\n\\ | Baseline (master @ `7edb07ca80~3`) | PR (`7edb07ca80`) | PR (`7edb07ca80`) + const ref argument\r\n --- | ---: | ---: | ---:\r\nany (empty optional or empty map) | 130  | 140 <sup>A</sup> | 135\r\nIPV4 or {IPV4} | 190 | 320 | 200\r\nIPV6 or {IPV6} | 490 | 640 | 510\r\nONION or {ONION} | 1200 | 1370 | 1270\r\nI2P or {I2P} | 2500 | 2650 | 2550\r\nCJDNS or {CJDNS} | 1500000 | 1700000 | 1600000\r\n{IPV4, IPV6, ONION, I2P, CJDNS} | - | 550 <sup>B</sup> | 150 <sup>C</sup>\r\n\r\n<sup>A</sup> vs <sup>B</sup> is probably what @mzumsande observed in https://github.com/bitcoin/bitcoin/pull/29436#pullrequestreview-1891096814. But fixing the arg changes that to <sup>A</sup> vs <sup>C</sup>.\r\n\r\nBased on the above, I think that it is best to go back to `7edb07ca80` and only fix the `Select()` argument.\r\n\r\n<details>\r\n<summary>benchmark for Select() to read real peers.dat</summary>\r\n\r\n```diff\r\ndiff --git a/src/bench/addrman.cpp b/src/bench/addrman.cpp\r\nindex f044feebba..dd45b9e69b 100644\r\n--- a/src/bench/addrman.cpp\r\n+++ b/src/bench/addrman.cpp\r\n@@ -1,12 +1,15 @@\r\n // Copyright (c) 2020-2022 The Bitcoin Core developers\r\n // Distributed under the MIT software license, see the accompanying\r\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n \r\n+#include <addrdb.h>\r\n #include <addrman.h>\r\n #include <bench/bench.h>\r\n+#include <chainparams.h>\r\n+#include <common/args.h>\r\n #include <netbase.h>\r\n #include <netgroup.h>\r\n #include <random.h>\r\n #include <util/check.h>\r\n #include <util/time.h>\r\n \r\n@@ -81,12 +84,37 @@ static void AddrManAdd(benchmark::Bench& bench)\r\n     bench.run([&] {\r\n         AddrMan addrman{EMPTY_NETGROUPMAN, /*deterministic=*/false, ADDRMAN_CONSISTENCY_CHECK_RATIO};\r\n         AddAddressesToAddrMan(addrman);\r\n     });\r\n }\r\n \r\n+static void AddrManSelectMain(benchmark::Bench& bench)\r\n+{\r\n+    SelectParams(ChainType::MAIN);\r\n+    gArgs.ForceSetArg(\"checkaddrman\", \"0\");\r\n+    gArgs.ForceSetArg(\"datadir\", \"/tmp\");\r\n+    auto result = LoadAddrman(EMPTY_NETGROUPMAN, gArgs);\r\n+    AddrMan& addrman = *(*result).get();\r\n+\r\n+    std::cout << \"addrman size:\\n\";\r\n+    std::cout << \"IPv4: \" << addrman.Size(NET_IPV4) << \"\\n\";\r\n+    std::cout << \"IPv6: \" << addrman.Size(NET_IPV6) << \"\\n\";\r\n+    std::cout << \"Tor:  \" << addrman.Size(NET_ONION) << \"\\n\";\r\n+    std::cout << \"I2P:  \" << addrman.Size(NET_I2P) << \"\\n\";\r\n+    std::cout << \"CJDNS:\" << addrman.Size(NET_CJDNS) << \"\\n\";\r\n+\r\n+    //const std::optional<Network> n{NET_CJDNS};\r\n+    //const std::unordered_set<Network> n{NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS};\r\n+    //const std::unordered_set<Network> n{};\r\n+    //const std::unordered_set<Network> n{g_reachable_nets.All()};\r\n+    bench.run([&] {\r\n+        const auto& address = addrman.Select(/*new_only=*/false, n);\r\n+        assert(address.first.IsValid());\r\n+    });\r\n+}\r\n+\r\n static void AddrManSelect(benchmark::Bench& bench)\r\n {\r\n     AddrMan addrman{EMPTY_NETGROUPMAN, /*deterministic=*/false, ADDRMAN_CONSISTENCY_CHECK_RATIO};\r\n \r\n     FillAddrMan(addrman);\r\n \r\n@@ -167,11 +195,12 @@ static void AddrManAddThenGood(benchmark::Bench& bench)\r\n \r\n         markSomeAsGood(addrman);\r\n     });\r\n }\r\n \r\n BENCHMARK(AddrManAdd, benchmark::PriorityLevel::HIGH);\r\n+BENCHMARK(AddrManSelectMain, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelect, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelectFromAlmostEmpty, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelectByNetwork, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManGetAddr, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManAddThenGood, benchmark::PriorityLevel::HIGH);\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Fix Select() argument</summary>\r\n\r\n```diff\r\ndiff --git i/src/addrman.cpp w/src/addrman.cpp\r\nindex 4e551e81c3..bde2d90ef2 100644\r\n--- i/src/addrman.cpp\r\n+++ w/src/addrman.cpp\r\n@@ -705,13 +705,13 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\r\n     if (fCountFailure && info.m_last_count_attempt < m_last_good) {\r\n         info.m_last_count_attempt = time;\r\n         info.nAttempts++;\r\n     }\r\n }\r\n \r\n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::unordered_set<Network> networks) const\r\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, const std::unordered_set<Network>& networks) const\r\n {\r\n     AssertLockHeld(cs);\r\n \r\n     if (vRandom.empty()) return {};\r\n \r\n     size_t new_count = nNew;\r\n@@ -1208,13 +1208,13 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::SelectTriedCollision()\r\n     Check();\r\n     auto ret = SelectTriedCollision_();\r\n     Check();\r\n     return ret;\r\n }\r\n \r\n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select(bool new_only, std::unordered_set<Network> networks) const\r\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select(bool new_only, const std::unordered_set<Network>& networks) const\r\n {\r\n     LOCK(cs);\r\n     Check();\r\n     auto addrRet = Select_(new_only, networks);\r\n     Check();\r\n     return addrRet;\r\n@@ -1315,13 +1315,13 @@ void AddrMan::ResolveCollisions()\r\n \r\n std::pair<CAddress, NodeSeconds> AddrMan::SelectTriedCollision()\r\n {\r\n     return m_impl->SelectTriedCollision();\r\n }\r\n \r\n-std::pair<CAddress, NodeSeconds> AddrMan::Select(bool new_only, std::unordered_set<Network> networks) const\r\n+std::pair<CAddress, NodeSeconds> AddrMan::Select(bool new_only, const std::unordered_set<Network>& networks) const\r\n {\r\n     return m_impl->Select(new_only, networks);\r\n }\r\n \r\n std::vector<CAddress> AddrMan::GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network, const bool filtered) const\r\n {\r\ndiff --git i/src/addrman.h w/src/addrman.h\r\nindex 2d2846993a..b6fdb07f82 100644\r\n--- i/src/addrman.h\r\n+++ w/src/addrman.h\r\n@@ -157,13 +157,13 @@ public:\r\n      *                     guarantee a tried entry).\r\n      * @param[in] networks Select only addresses of these networks (empty = all). Passing networks may\r\n      *                     slow down the search.\r\n      * @return    CAddress The record for the selected peer.\r\n      *            seconds  The last time we attempted to connect to that peer.\r\n      */\r\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, std::unordered_set<Network> networks = {}) const;\r\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only = false, const std::unordered_set<Network>& networks = {}) const;\r\n \r\n     /**\r\n      * Return all or many randomly selected addresses, optionally by network.\r\n      *\r\n      * @param[in] max_addresses  Maximum number of addresses to return (0 = all).\r\n      * @param[in] max_pct        Maximum percentage of addresses to return (0 = all).\r\ndiff --git i/src/addrman_impl.h w/src/addrman_impl.h\r\nindex bb89213bb7..2a4596e81f 100644\r\n--- i/src/addrman_impl.h\r\n+++ w/src/addrman_impl.h\r\n@@ -123,13 +123,13 @@ public:\r\n         EXCLUSIVE_LOCKS_REQUIRED(!cs);\r\n \r\n     void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\r\n \r\n     std::pair<CAddress, NodeSeconds> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\r\n \r\n-    std::pair<CAddress, NodeSeconds> Select(bool new_only, std::unordered_set<Network> networks) const\r\n+    std::pair<CAddress, NodeSeconds> Select(bool new_only, const std::unordered_set<Network>& networks) const\r\n         EXCLUSIVE_LOCKS_REQUIRED(!cs);\r\n \r\n     std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network, const bool filtered = true) const\r\n         EXCLUSIVE_LOCKS_REQUIRED(!cs);\r\n \r\n     std::vector<std::pair<AddrInfo, AddressPosition>> GetEntries(bool from_tried) const\r\n@@ -250,13 +250,13 @@ private:\r\n     bool Good_(const CService& addr, bool test_before_evict, NodeSeconds time) EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n \r\n     bool Add_(const std::vector<CAddress>& vAddr, const CNetAddr& source, std::chrono::seconds time_penalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n \r\n     void Attempt_(const CService& addr, bool fCountFailure, NodeSeconds time) EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n \r\n-    std::pair<CAddress, NodeSeconds> Select_(bool new_only, std::unordered_set<Network> networks) const EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n+    std::pair<CAddress, NodeSeconds> Select_(bool new_only, const std::unordered_set<Network>& networks) const EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n \r\n     /** Helper to generalize looking up an addrman entry from either table.\r\n      *\r\n      *  @return  int The nid of the entry. If the addrman position is empty or not found, returns -1.\r\n      * */\r\n     int GetEntry(bool use_tried, size_t bucket, size_t position) const EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n```\r\n</details>",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-03-04T05:36:32Z",
      "diff_hunk" : "@@ -721,13 +721,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1510609846",
      "id" : 1510609846,
      "line" : 724,
      "node_id" : "PRRC_kwDOABII585aChO2",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 724,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 20,
      "pull_request_review_id" : 1913404137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1510609846/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-04T10:09:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1510609846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511064348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511064348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll leave as it for now, but free to change if other reviewers agree.",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-03-04T12:13:42Z",
      "diff_hunk" : "@@ -712,7 +712,7 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, NodeSeconds\n     }\n }\n \n-std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::optional<Network> network) const\n+std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, const std::unordered_set<Network>& networks) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511064348",
      "id" : 1511064348,
      "in_reply_to_id" : 1506916729,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII585aEQMc",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 715,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 5,
      "pull_request_review_id" : 1914158512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511064348/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-04T12:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511064348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511246190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246190"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for it, @vasild ",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-03-04T14:24:05Z",
      "diff_hunk" : "@@ -721,13 +721,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511246190",
      "id" : 1511246190,
      "in_reply_to_id" : 1510609846,
      "line" : 724,
      "node_id" : "PRRC_kwDOABII585aE8lu",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 724,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 20,
      "pull_request_review_id" : 1914449900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-04T14:24:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511246671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246671"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "About:\r\n> I tried to test the performance impact on the \"normal\" case of an addrman that only has addrs for reachable nets:\r\nIf I change the AddrManSelect benchmark to use addrman.Select(false, g_reachable_nets.All());  the performance goes down by a factor of ~5 for me (from ~160ns/op to ~770 ns/op). Do you see a similar effect?\r\n\r\nIn fact, I just realized that the performance issue is related to `g_reachable_nets.All()`. With the following diff I realized the performance is not relevantly affected. cc: @mzumsande \r\n\r\n```diff\r\ndiff --git a/src/bench/addrman.cpp b/src/bench/addrman.cpp\r\nindex ee4070b07a..8760f134ca 100644\r\n--- a/src/bench/addrman.cpp\r\n+++ b/src/bench/addrman.cpp\r\n@@ -96,6 +96,31 @@ static void AddrManSelect(benchmark::Bench& bench)\r\n     });\r\n }\r\n \r\n+static void AddrManSelect1(benchmark::Bench& bench)\r\n+{\r\n+    AddrMan addrman{EMPTY_NETGROUPMAN, /*deterministic=*/false, ADDRMAN_CONSISTENCY_CHECK_RATIO};\r\n+\r\n+    FillAddrMan(addrman);\r\n+    const auto nets{g_reachable_nets.All()};\r\n+\r\n+    bench.run([&] {\r\n+        const auto& address = addrman.Select(false, nets);\r\n+        assert(address.first.GetPort() > 0);\r\n+    });\r\n+}\r\n+\r\n+static void AddrManSelect2(benchmark::Bench& bench)\r\n+{\r\n+    AddrMan addrman{EMPTY_NETGROUPMAN, /*deterministic=*/false, ADDRMAN_CONSISTENCY_CHECK_RATIO};\r\n+\r\n+    FillAddrMan(addrman);\r\n+\r\n+    bench.run([&] {\r\n+        const auto& address = addrman.Select(false, g_reachable_nets.All());\r\n+        assert(address.first.GetPort() > 0);\r\n+    });\r\n+}\r\n+\r\n // The worst case performance of the Select() function is when there is only\r\n // one address on the table, because it linearly searches every position of\r\n // several buckets before identifying the correct bucket\r\n@@ -171,6 +196,8 @@ static void AddrManAddThenGood(benchmark::Bench& bench)\r\n \r\n BENCHMARK(AddrManAdd, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelect, benchmark::PriorityLevel::HIGH);\r\n+BENCHMARK(AddrManSelect1, benchmark::PriorityLevel::HIGH);\r\n+BENCHMARK(AddrManSelect2, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelectFromAlmostEmpty, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManSelectByNetwork, benchmark::PriorityLevel::HIGH);\r\n BENCHMARK(AddrManGetAddr, benchmark::PriorityLevel::HIGH);\r\n```\r\n\r\n```\r\n|               84.73 |       11,801,666.44 |    5.2% |      0.01 | :wavy_dash: `AddrManSelect` (Unstable with ~11,349.7 iters. Increase `minEpochIterations` to e.g. 113497)\r\n|              110.53 |        9,047,580.50 |    3.0% |      0.01 | `AddrManSelect1`\r\n|              558.40 |        1,790,829.47 |    6.7% |      0.01 | :wavy_dash: `AddrManSelect2` (Unstable with ~1,690.3 iters. Increase `minEpochIterations` to e.g. 16903)\r\n```",
      "commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "created_at" : "2024-03-04T14:24:24Z",
      "diff_hunk" : "@@ -721,13 +721,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1511246671",
      "id" : 1511246671,
      "in_reply_to_id" : 1510609846,
      "line" : 724,
      "node_id" : "PRRC_kwDOABII585aE8tP",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 724,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 20,
      "pull_request_review_id" : 1914450689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-04T14:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1511246671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed simplifying the approach. I changed the last argument of Select() to be a `const` ref and now we just call `Select` with reachable networks since it does not significantly impact the performance (see https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1510609846).\r\n\r\nThanks @vasild for the benchmarking and review. ",
      "created_at" : "2024-03-05T09:42:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#issuecomment-1978342064",
      "id" : 1978342064,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29436",
      "node_id" : "IC_kwDOABII58516xqw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1978342064/reactions"
      },
      "updated_at" : "2024-03-05T09:42:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1978342064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1512506563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1512506563"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Based on the above, I think that it is best to go back to 7edb07ca80 and only fix the Select() argument.\r\n\r\nSince it is simpler and does not impact the performance, I just addressed this suggestion. Thanks.",
      "commit_id" : "e66b32b2f49b71b37f48191afb761538a52e8f08",
      "created_at" : "2024-03-05T09:43:19Z",
      "diff_hunk" : "@@ -721,13 +721,18 @@ std::pair<CAddress, NodeSeconds> AddrManImpl::Select_(bool new_only, std::option\n     size_t new_count = nNew;\n     size_t tried_count = nTried;\n \n-    if (network.has_value()) {\n-        auto it = m_network_counts.find(*network);\n-        if (it == m_network_counts.end()) return {};\n-\n-        auto counts = it->second;\n-        new_count = counts.n_new;\n-        tried_count = counts.n_tried;\n+    if (!networks.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29436#discussion_r1512506563",
      "id" : 1512506563,
      "in_reply_to_id" : 1510609846,
      "line" : 724,
      "node_id" : "PRRC_kwDOABII585aJwTD",
      "original_commit_id" : "b85893ca02c9a7f872f2f0428e0f709a6d45906c",
      "original_line" : 724,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 20,
      "pull_request_review_id" : 1916394513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29436",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1512506563/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-05T09:43:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1512506563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
