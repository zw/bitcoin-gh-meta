[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29412).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1935947181), [epiccurious](https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1936033190), [instagibbs](https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1936047945), [sr-gi](https://github.com/bitcoin/bitcoin/pull/29412#pullrequestreview-1873071547), [glozow](https://github.com/bitcoin/bitcoin/pull/29412#pullrequestreview-1873261879), [fjahr](https://github.com/bitcoin/bitcoin/pull/29412#pullrequestreview-1891184515), [naumenkogs](https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1958901201) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28710](https://github.com/bitcoin/bitcoin/pull/28710) (Remove the legacy wallet and BDB dependency by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-02-08T17:18:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1934588826",
      "id" : 1934588826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zT3ua",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1934588826/reactions"
      },
      "updated_at" : "2024-02-22T08:05:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1934588826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/21374346056</sub>",
      "created_at" : "2024-02-08T18:22:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1934698387",
      "id" : 1934698387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zUSeT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1934698387/reactions"
      },
      "updated_at" : "2024-02-08T18:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1934698387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "How do you define a mutated block? What are the known forms of mutated blocks?",
      "created_at" : "2024-02-09T03:38:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1935287441",
      "id" : 1935287441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zWiSR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935287441/reactions"
      },
      "updated_at" : "2024-02-09T03:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935287441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/109078515?v=4",
         "events_url" : "https://api.github.com/users/epiccurious/events{/privacy}",
         "followers_url" : "https://api.github.com/users/epiccurious/followers",
         "following_url" : "https://api.github.com/users/epiccurious/following{/other_user}",
         "gists_url" : "https://api.github.com/users/epiccurious/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/epiccurious",
         "id" : 109078515,
         "login" : "epiccurious",
         "node_id" : "U_kgDOBoBn8w",
         "organizations_url" : "https://api.github.com/users/epiccurious/orgs",
         "received_events_url" : "https://api.github.com/users/epiccurious/received_events",
         "repos_url" : "https://api.github.com/users/epiccurious/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/epiccurious/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/epiccurious/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/epiccurious"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> How do you define a mutated block? What are the known forms of mutated blocks?\r\n\r\nLooking at `IsBlockMutated` in this PR should provide the answers for these questions, but to recap:\r\n\r\n* When we receive a block it contains a header and a list of transactions. The header contains a merkle root hash (`CBlock::hashMerkleRoot`) which should commit to the list of transactions but [if it doesn't the block is considered mutated](https://github.com/bitcoin/bitcoin/blob/b2b2b1e9e415c3b5f74d517eaebfc2073cef5175/src/validation.cpp#L3660-L3671).\r\n* The coinbase transaction (post segwit) contains a commitment (very similar to the merkle root in the header) to the witness data in a block. [If that commitment does not actually commit to the witnesses that were received, the block is considered mutated](https://github.com/bitcoin/bitcoin/blob/b2b2b1e9e415c3b5f74d517eaebfc2073cef5175/src/validation.cpp#L3861-L3896).\r\n* Our merkle root algorithm has several flaws which allow for further malleation, see [here](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf) for a great overview.",
      "created_at" : "2024-02-09T10:05:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1935643125",
      "id" : 1935643125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zX5H1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935643125/reactions"
      },
      "updated_at" : "2024-02-09T10:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935643125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2024-02-09T13:36:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1935947181",
      "id" : 1935947181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zZDWt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935947181/reactions"
      },
      "updated_at" : "2024-02-09T13:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1935947181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK.",
      "created_at" : "2024-02-09T14:28:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1936033190",
      "id" : 1936033190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zZYWm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936033190/reactions"
      },
      "updated_at" : "2024-02-09T14:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936033190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/109078515?v=4",
         "events_url" : "https://api.github.com/users/epiccurious/events{/privacy}",
         "followers_url" : "https://api.github.com/users/epiccurious/followers",
         "following_url" : "https://api.github.com/users/epiccurious/following{/other_user}",
         "gists_url" : "https://api.github.com/users/epiccurious/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/epiccurious",
         "id" : 109078515,
         "login" : "epiccurious",
         "node_id" : "U_kgDOBoBn8w",
         "organizations_url" : "https://api.github.com/users/epiccurious/orgs",
         "received_events_url" : "https://api.github.com/users/epiccurious/received_events",
         "repos_url" : "https://api.github.com/users/epiccurious/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/epiccurious/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/epiccurious/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/epiccurious"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "concept ACK\r\n\r\nmight be good to recap why it was only added in BLOCK processing but not other `ProcessBlocks`: In every other case we already don't punish the sender of compact blocks for failing these higher level checks, while full blocks allow for punishment.",
      "created_at" : "2024-02-09T14:37:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1936047945",
      "id" : 1936047945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zZb9J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936047945/reactions"
      },
      "updated_at" : "2024-02-09T14:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936047945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> might be good to recap why it was only added in BLOCK processing but not other ProcessBlocks: In every other case we already don't punish the sender of compact blocks for failing these higher level checks, while full blocks allow for punishment.\r\n\r\nWe call `ProcessBlock` when we receive a `block` message (handled in this PR) or as the result of a compact block reconstruction. Compact blocks are relayed before full validation occurs, therefore we don't punish peers for sending us invalid blocks through compact block relay. Block mutation might also occur randomly during compact bock relay due to short-id collisions, which is another reason not to punish.",
      "created_at" : "2024-02-09T16:12:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1936203492",
      "id" : 1936203492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII585zaB7k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936203492/reactions"
      },
      "updated_at" : "2024-02-09T16:12:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936203492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484551682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484551682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should we be checking PoW first before doing potentially a lot of hashing?",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T16:31:56Z",
      "diff_hunk" : "@@ -4719,6 +4719,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         LogPrint(BCLog::NET, \"received block %s peer=%d\\n\", pblock->GetHash().ToString(), pfrom.GetId());\n \n+        const CBlockIndex* prev_block{WITH_LOCK(m_chainman.GetMutex(), return m_chainman.m_blockman.LookupBlockIndex(pblock->hashPrevBlock))};\n+\n+        if (IsBlockMutated(/*block=*/*pblock,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484551682",
      "id" : 1484551682,
      "line" : 4724,
      "node_id" : "PRRC_kwDOABII585YfHYC",
      "original_commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "original_line" : 4724,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 1872786752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484551682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T16:31:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484551682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484725603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484725603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as for `ContextualCheckBlock`, this can be simplified to:\r\n\r\n```cpp\r\nif (valid_opt.value_or(true)) {\r\n```",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T19:31:43Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        // Consider the block mutated if any transaction is 64 bytes in size\n+        // (see 3.1: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).\n+        return std::any_of(block.vtx.begin(), block.vtx.end(),\n+                           [](auto& tx) { return GetSerializeSize(TX_NO_WITNESS(tx)) == 64; });\n+    } else {\n+        // Theoretically it is still possible for a block with a 64 byte\n+        // coinbase transaction to be mutated but we neglect that possibility\n+        // here as it requires at least 224 bits of work.\n+    }\n+\n+    if (check_witness_root) {\n+        const auto valid_opt = CheckWitnessCommitment(block, state);\n+        if (valid_opt.has_value() && !valid_opt.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484725603",
      "id" : 1484725603,
      "line" : 3838,
      "node_id" : "PRRC_kwDOABII585Yfx1j",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3832,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 117,
      "pull_request_review_id" : 1873071547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484725603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T20:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484725603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484728486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484728486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should be able to simplify this as:\r\n\r\n```cpp\r\nif (!valid_opt.value_or(true)) return false;\r\n```",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T19:35:22Z",
      "diff_hunk" : "@@ -3868,22 +3918,9 @@ static bool ContextualCheckBlock(const CBlock& block, BlockValidationState& stat\n     //   multiple, the last one is used.\n     bool fHaveWitness = false;\n     if (DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_SEGWIT)) {\n-        int commitpos = GetWitnessCommitmentIndex(block);\n-        if (commitpos != NO_WITNESS_COMMITMENT) {\n-            bool malleated = false;\n-            uint256 hashWitness = BlockWitnessMerkleRoot(block, &malleated);\n-            // The malleation check is ignored; as the transaction tree itself\n-            // already does not permit it, it is impossible to trigger in the\n-            // witness tree.\n-            if (block.vtx[0]->vin[0].scriptWitness.stack.size() != 1 || block.vtx[0]->vin[0].scriptWitness.stack[0].size() != 32) {\n-                return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-witness-nonce-size\", strprintf(\"%s : invalid witness reserved value size\", __func__));\n-            }\n-            CHash256().Write(hashWitness).Write(block.vtx[0]->vin[0].scriptWitness.stack[0]).Finalize(hashWitness);\n-            if (memcmp(hashWitness.begin(), &block.vtx[0]->vout[commitpos].scriptPubKey[6], 32)) {\n-                return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-witness-merkle-match\", strprintf(\"%s : witness merkle commitment mismatch\", __func__));\n-            }\n-            fHaveWitness = true;\n-        }\n+        const auto valid_opt = CheckWitnessCommitment(block, state);\n+        fHaveWitness = valid_opt.has_value();\n+        if (fHaveWitness && !valid_opt.value()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484728486",
      "id" : 1484728486,
      "line" : 3959,
      "node_id" : "PRRC_kwDOABII585Yfyim",
      "original_commit_id" : "a74c3972bf8d0fa51e8f9672422bc34945b66ca7",
      "original_line" : 3923,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 151,
      "pull_request_review_id" : 1873071547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484728486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T20:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484728486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484744076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484744076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Basically performing `CheckBlockHeader` here too?\r\n\r\nThat sounds reasonable to me, and the outcome is the same IIRC: `Misbehaving(*peer, 100, ...`\r\n\r\nAlso, this is cheap enough that it may not matter if we do it again later (?), so we may not even need to cache it (correct me if I'm wrong)",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T19:52:49Z",
      "diff_hunk" : "@@ -4719,6 +4719,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         LogPrint(BCLog::NET, \"received block %s peer=%d\\n\", pblock->GetHash().ToString(), pfrom.GetId());\n \n+        const CBlockIndex* prev_block{WITH_LOCK(m_chainman.GetMutex(), return m_chainman.m_blockman.LookupBlockIndex(pblock->hashPrevBlock))};\n+\n+        if (IsBlockMutated(/*block=*/*pblock,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484744076",
      "id" : 1484744076,
      "in_reply_to_id" : 1484551682,
      "line" : 4724,
      "node_id" : "PRRC_kwDOABII585Yf2WM",
      "original_commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "original_line" : 4724,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 1873071547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484744076/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T20:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484744076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484773525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484773525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It may be good to assert the debug log for the specific disconnection reason:\r\n\r\n```suggestion\r\nwith self.nodes[0].assert_debug_log(expected_msgs=[\"bad-txnmrklroot, hashMerkleRoot mismatch\"]):\r\n    attacker.send_message(msg_block(mutated_block))\r\n```",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T20:27:16Z",
      "diff_hunk" : "@@ -0,0 +1,96 @@\n+#!/usr/bin/env python3\n+# Copyright (c) The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"\n+Test that an attacker can't degrade compact block relay by sending unsolicited\n+mutated blocks to clear in-flight blocktxn requests from other honest peers.\n+\"\"\"\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.messages import (\n+    BlockTransactions,\n+    msg_cmpctblock,\n+    msg_block,\n+    msg_blocktxn,\n+    HeaderAndShortIDs,\n+    tx_from_hex,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.blocktools import (\n+    COINBASE_MATURITY,\n+    create_block,\n+    add_witness_commitment,\n+    NORMAL_GBT_REQUEST_PARAMS,\n+)\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+import copy\n+\n+class MutatedBlocksTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.generate(self.wallet, COINBASE_MATURITY)\n+\n+        honest_relayer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        attacker = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Create new block with two transactions (coinbase + 1 self-transfer).\n+        # The self-transfer transaction is needed to trigger a compact block\n+        # `getblocktxn` roundtrip.\n+        tx = tx_from_hex(self.wallet.create_self_transfer()[\"hex\"])\n+        block = create_block(tmpl=self.nodes[0].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS), txlist=[tx])\n+        add_witness_commitment(block)\n+        block.solve()\n+\n+        # Create mutated version of the block by changing the transaction\n+        # version on the self-transfer.\n+        mutated_block = copy.deepcopy(block)\n+        mutated_block.vtx[1].nVersion = 4\n+\n+        # Announce the new block via a compact block through the honest relayer\n+        cmpctblock = HeaderAndShortIDs()\n+        cmpctblock.initialize_from_block(block, use_witness=True)\n+        honest_relayer.send_message(msg_cmpctblock(cmpctblock.to_p2p()))\n+\n+        # Wait for a `getblocktxn` that attempts to fetch the self-transfer\n+        def self_transfer_requested():\n+            if not honest_relayer.last_message.get('getblocktxn'):\n+                return False\n+\n+            get_block_txn = honest_relayer.last_message['getblocktxn']\n+            return get_block_txn.block_txn_request.blockhash == block.sha256 and \\\n+                   get_block_txn.block_txn_request.indexes == [1]\n+        honest_relayer.wait_until(self_transfer_requested, timeout=5)\n+\n+        # Block at height 101 should be the only one in flight from peer 0\n+        peer_info_prior_to_attack = self.nodes[0].getpeerinfo()\n+        assert_equal(peer_info_prior_to_attack[0]['id'], 0)\n+        assert_equal([101], peer_info_prior_to_attack[0][\"inflight\"])\n+\n+        # Attempt to clear the honest relayer's download request by sending the\n+        # mutated block (as the attacker).\n+        attacker.send_message(msg_block(mutated_block))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484773525",
      "id" : 1484773525,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585Yf9iV",
      "original_commit_id" : "5f27c9be7acf82f1630802645d3b910baf39fa90",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_mutated_blocks.py",
      "position" : 78,
      "pull_request_review_id" : 1873071547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484773525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T20:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484773525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484789046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484789046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok this doesn't seem to matter: we do this hashing even for already-known blocks we get sent unilaterally, and `MAX_PROTOCOL_MESSAGE_LENGTH` bounds the size of hashing to something reasonable, and we ban the peer anyways.",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-09T20:47:39Z",
      "diff_hunk" : "@@ -4719,6 +4719,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         LogPrint(BCLog::NET, \"received block %s peer=%d\\n\", pblock->GetHash().ToString(), pfrom.GetId());\n \n+        const CBlockIndex* prev_block{WITH_LOCK(m_chainman.GetMutex(), return m_chainman.m_blockman.LookupBlockIndex(pblock->hashPrevBlock))};\n+\n+        if (IsBlockMutated(/*block=*/*pblock,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1484789046",
      "id" : 1484789046,
      "in_reply_to_id" : 1484551682,
      "line" : 4724,
      "node_id" : "PRRC_kwDOABII585YgBU2",
      "original_commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "original_line" : 4724,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 1873173422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484789046/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-09T20:50:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1484789046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1486013425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486013425"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if that is simpler though. Yes it's less code but harder to read/understand imo (e.g. you forgot the `!` in your suggestion).\r\n\r\nI'm actually not a fan of my `std::optional<bool>` choice, so I might try to change that.",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-12T10:49:35Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        // Consider the block mutated if any transaction is 64 bytes in size\n+        // (see 3.1: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).\n+        return std::any_of(block.vtx.begin(), block.vtx.end(),\n+                           [](auto& tx) { return GetSerializeSize(TX_NO_WITNESS(tx)) == 64; });\n+    } else {\n+        // Theoretically it is still possible for a block with a 64 byte\n+        // coinbase transaction to be mutated but we neglect that possibility\n+        // here as it requires at least 224 bits of work.\n+    }\n+\n+    if (check_witness_root) {\n+        const auto valid_opt = CheckWitnessCommitment(block, state);\n+        if (valid_opt.has_value() && !valid_opt.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1486013425",
      "id" : 1486013425,
      "in_reply_to_id" : 1484725603,
      "line" : 3838,
      "node_id" : "PRRC_kwDOABII585YksPx",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3832,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 117,
      "pull_request_review_id" : 1874970504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486013425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-12T10:49:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486013425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1486199775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486199775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I may be used to the pattern due to rustlang, but I have no strong opinions about it",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-12T13:44:43Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        // Consider the block mutated if any transaction is 64 bytes in size\n+        // (see 3.1: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).\n+        return std::any_of(block.vtx.begin(), block.vtx.end(),\n+                           [](auto& tx) { return GetSerializeSize(TX_NO_WITNESS(tx)) == 64; });\n+    } else {\n+        // Theoretically it is still possible for a block with a 64 byte\n+        // coinbase transaction to be mutated but we neglect that possibility\n+        // here as it requires at least 224 bits of work.\n+    }\n+\n+    if (check_witness_root) {\n+        const auto valid_opt = CheckWitnessCommitment(block, state);\n+        if (valid_opt.has_value() && !valid_opt.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1486199775",
      "id" : 1486199775,
      "in_reply_to_id" : 1484725603,
      "line" : 3838,
      "node_id" : "PRRC_kwDOABII585YlZvf",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3832,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 117,
      "pull_request_review_id" : 1875269841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486199775/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-12T13:44:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1486199775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I would like to see this in v27, can we add it to the milestone?",
      "created_at" : "2024-02-20T11:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1954024203",
      "id" : 1954024203,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII5850eAsL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1954024203/reactions"
      },
      "updated_at" : "2024-02-20T11:32:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1954024203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1495884531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495884531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since this \"in case of non-coinbase first transaction, treat existence of 64-byte transaction as malleation\" is new behavior, would it make sense to move it to a separate commit at the end of the PR? (A clearer comment would also be helpful, because I briefly thought this was a consensus change before it was pointed out to be it only triggers in case the block would already be invalid).",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-20T14:08:57Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1495884531",
      "id" : 1495884531,
      "line" : 3825,
      "node_id" : "PRRC_kwDOABII585ZKWLz",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3819,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 104,
      "pull_request_review_id" : 1890525477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495884531/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T14:08:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495884531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1495954173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495954173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I also had the same misconception the first time I reviewed.",
      "commit_id" : "d028bb12abb041870413a3437865547cff2df653",
      "created_at" : "2024-02-20T14:50:09Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1495954173",
      "id" : 1495954173,
      "in_reply_to_id" : 1495884531,
      "line" : 3825,
      "node_id" : "PRRC_kwDOABII585ZKnL9",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3819,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 104,
      "pull_request_review_id" : 1890636850,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495954173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T14:50:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1495954173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496051696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496051696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a74c3972bf8d0fa51e8f9672422bc34945b66ca7: It would be easier to review if style changes were separate from move-only changes? Otherwise, options such as `--color-moved=dimmed-zebra  --color-moved-ws=ignore-all-space` can not be used.\r\n\r\nAlso, renaming tokens in a block of code will break the parity check used to find the introduction of the code block (https://git-scm.com/docs/git-log#Documentation/git-log.txt--Sltstringgt). So it may be easier to track the history, if the renames were done in a separate commit, at least for me. ",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-20T15:41:34Z",
      "diff_hunk" : "@@ -3639,6 +3639,65 @@ static bool CheckBlockHeader(const CBlockHeader& block, BlockValidationState& st\n     return true;\n }\n \n+static bool CheckMerkleRoot(const CBlock& block, BlockValidationState& state)\n+{\n+    bool mutated;\n+    uint256 merkle_root = BlockMerkleRoot(block, &mutated);\n+    if (block.hashMerkleRoot != merkle_root) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txnmrklroot\",\n+            /*debug_message=*/\"hashMerkleRoot mismatch\");\n+    }\n+\n+    // Check for merkle tree malleability (CVE-2012-2459): repeating sequences\n+    // of transactions in a block without affecting the merkle root of a block,\n+    // while still invalidating it.\n+    if (mutated) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txns-duplicate\",\n+            /*debug_message=*/\"duplicate transaction\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496051696",
      "id" : 1496051696,
      "line" : 3662,
      "node_id" : "PRRC_kwDOABII585ZK-_w",
      "original_commit_id" : "a74c3972bf8d0fa51e8f9672422bc34945b66ca7",
      "original_line" : 3662,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 1890785562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496051696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T15:41:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496051696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496312078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496312078"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Given the recent changes around the mailing list could also name what's behind this link? So in case it disappears people know what to search for. I know they promised to keep the links but who knows...",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-20T18:27:49Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        // Consider the block mutated if any transaction is 64 bytes in size\n+        // (see 3.1: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496312078",
      "id" : 1496312078,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZL-kO",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3821,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1891184515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496312078/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T22:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496312078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496365733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496365733"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It would also be a little bit easier to reason about if when `block.vtx.empty()` is true then we just `return false;` because in that case `std::any_of` will always return false.",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-20T19:16:50Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1496365733",
      "id" : 1496365733,
      "in_reply_to_id" : 1495884531,
      "line" : 3825,
      "node_id" : "PRRC_kwDOABII585ZMLql",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3825,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 104,
      "pull_request_review_id" : 1891184515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496365733/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T22:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496365733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Looking forward to addressing already pending comments, then i review.",
      "created_at" : "2024-02-22T08:05:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1958901201",
      "id" : 1958901201,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII5850wnXR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1958901201/reactions"
      },
      "updated_at" : "2024-02-22T08:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1958901201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split into separate commit and expanded on the comment.",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T11:55:14Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130243",
      "id" : 1499130243,
      "in_reply_to_id" : 1495884531,
      "line" : 3825,
      "node_id" : "PRRC_kwDOABII585ZWumD",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3825,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 104,
      "pull_request_review_id" : 1895668014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T11:55:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split the refactoring into a separate commit.",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T11:55:30Z",
      "diff_hunk" : "@@ -3639,6 +3639,65 @@ static bool CheckBlockHeader(const CBlockHeader& block, BlockValidationState& st\n     return true;\n }\n \n+static bool CheckMerkleRoot(const CBlock& block, BlockValidationState& state)\n+{\n+    bool mutated;\n+    uint256 merkle_root = BlockMerkleRoot(block, &mutated);\n+    if (block.hashMerkleRoot != merkle_root) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txnmrklroot\",\n+            /*debug_message=*/\"hashMerkleRoot mismatch\");\n+    }\n+\n+    // Check for merkle tree malleability (CVE-2012-2459): repeating sequences\n+    // of transactions in a block without affecting the merkle root of a block,\n+    // while still invalidating it.\n+    if (mutated) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txns-duplicate\",\n+            /*debug_message=*/\"duplicate transaction\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130527",
      "id" : 1499130527,
      "in_reply_to_id" : 1496051696,
      "line" : 3662,
      "node_id" : "PRRC_kwDOABII585ZWuqf",
      "original_commit_id" : "a74c3972bf8d0fa51e8f9672422bc34945b66ca7",
      "original_line" : 3662,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 1895668485,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T11:55:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130753"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T11:55:42Z",
      "diff_hunk" : "@@ -3808,6 +3808,36 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        // Consider the block mutated if any transaction is 64 bytes in size\n+        // (see 3.1: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499130753",
      "id" : 1499130753,
      "in_reply_to_id" : 1496312078,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZWuuB",
      "original_commit_id" : "30bdbcd561342fc9afb69830e8927b0d63f5637f",
      "original_line" : 3821,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1895668845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T11:55:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499130753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499351311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499351311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Asserting the stripped serialized size right after is nice for self-documentation/correctness of test, and maybe another case of a witness tx which witness size is not 64?",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T14:38:17Z",
      "diff_hunk" : "@@ -145,4 +147,31 @@ BOOST_AUTO_TEST_CASE(test_assumeutxo)\n     BOOST_CHECK_EQUAL(out110_2.nChainTx, 111U);\n }\n \n+BOOST_AUTO_TEST_CASE(block_malleation)\n+{\n+    // tx1: ff204bd0000000000000\n+    // tx2: 8ae53c92000000000000\n+    // 64 byte tx of the form h(tx1)||h(tx2), tx3:\n+    // cdaf22d00002c6a7f848f8ae4d30054e61dcf3303d6fe01d282163341f06feecc10032b3160fcab87bdfe3ecfb769206ef2d991b92f8a268e423a6ef4d485f06\n+\n+    CMutableTransaction tx1;\n+    BOOST_CHECK(DecodeHexTx(tx1, \"ff204bd0000000000000\", /*try_no_witness=*/true, /*try_witness=*/false));\n+    CMutableTransaction tx2;\n+    BOOST_CHECK(DecodeHexTx(tx2, \"8ae53c92000000000000\", /*try_no_witness=*/true, /*try_witness=*/false));\n+    CMutableTransaction tx3;\n+    BOOST_CHECK(DecodeHexTx(tx3, \"cdaf22d00002c6a7f848f8ae4d30054e61dcf3303d6fe01d282163341f06feecc10032b3160fcab87bdfe3ecfb769206ef2d991b92f8a268e423a6ef4d485f06\", /*try_no_witness=*/true, /*try_witness=*/false));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499351311",
      "id" : 1499351311,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585ZXkkP",
      "original_commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "original_line" : 162,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/test/validation_tests.cpp",
      "position" : 25,
      "pull_request_review_id" : 1896027563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499351311/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T14:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499351311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499355541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499355541"
         }
      },
      "author_association" : "MEMBER",
      "body" : "have you thought about having this function return an optional error string so unit tests can check expected failure reason?",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T14:40:52Z",
      "diff_hunk" : "@@ -3758,6 +3814,40 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499355541",
      "id" : 1499355541,
      "line" : 3817,
      "node_id" : "PRRC_kwDOABII585ZXlmV",
      "original_commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "original_line" : 3817,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 96,
      "pull_request_review_id" : 1896027563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499355541/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T14:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499355541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499592647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499592647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit c84db8d60e87eabc1e4f88ef05bf06fbf4db6f02\r\n\r\n```suggestion\r\n    const bool has_witness_commitment{commitpos != NO_WITNESS_COMMITMENT};\r\n```",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:12:05Z",
      "diff_hunk" : "@@ -3642,34 +3642,54 @@ static bool CheckBlockHeader(const CBlockHeader& block, BlockValidationState& st\n static bool CheckMerkleRoot(const CBlock& block, BlockValidationState& state)\n {\n     bool mutated;\n-    uint256 hashMerkleRoot2 = BlockMerkleRoot(block, &mutated);\n-    if (block.hashMerkleRoot != hashMerkleRoot2)\n-        return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-txnmrklroot\", \"hashMerkleRoot mismatch\");\n+    uint256 merkle_root = BlockMerkleRoot(block, &mutated);\n+    if (block.hashMerkleRoot != merkle_root) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txnmrklroot\",\n+            /*debug_message=*/\"hashMerkleRoot mismatch\");\n+    }\n \n     // Check for merkle tree malleability (CVE-2012-2459): repeating sequences\n     // of transactions in a block without affecting the merkle root of a block,\n     // while still invalidating it.\n-    if (mutated)\n-        return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-txns-duplicate\", \"duplicate transaction\");\n+    if (mutated) {\n+        return state.Invalid(\n+            /*result=*/BlockValidationResult::BLOCK_MUTATED,\n+            /*reject_reason=*/\"bad-txns-duplicate\",\n+            /*debug_message=*/\"duplicate transaction\");\n+    }\n \n     return true;\n }\n \n static std::optional<bool> CheckWitnessCommitment(const CBlock& block, BlockValidationState& state)\n {\n     int commitpos = GetWitnessCommitmentIndex(block);\n-    if (commitpos != NO_WITNESS_COMMITMENT) {\n-        bool malleated = false;\n-        uint256 hashWitness = BlockWitnessMerkleRoot(block, &malleated);\n+\n+    bool has_witness_commitment{commitpos != NO_WITNESS_COMMITMENT};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499592647",
      "id" : 1499592647,
      "line" : 3675,
      "node_id" : "PRRC_kwDOABII585ZYffH",
      "original_commit_id" : "c84db8d60e87eabc1e4f88ef05bf06fbf4db6f02",
      "original_line" : 3670,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 1896406510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499592647/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:30:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499592647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499595618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499595618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit c62eea853e5c5f390d58c5ad9c0ac9a688465abc\r\n```suggestion\r\n        const auto valid_opt{CheckWitnessCommitment(block, state)};\r\n```\r\n",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:14:27Z",
      "diff_hunk" : "@@ -3808,6 +3808,29 @@ bool HasValidProofOfWork(const std::vector<CBlockHeader>& headers, const Consens\n             [&](const auto& header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});\n }\n \n+bool IsBlockMutated(const CBlock& block, bool check_witness_root)\n+{\n+    BlockValidationState state;\n+    if (!CheckMerkleRoot(block, state)) {\n+        LogDebug(BCLog::VALIDATION, \"%s: %s\\n\", __func__, state.ToString());\n+        return true;\n+    }\n+\n+    if (block.vtx.empty() || !block.vtx[0]->IsCoinBase()) {\n+        return false;\n+    }\n+\n+    if (check_witness_root) {\n+        const auto valid_opt = CheckWitnessCommitment(block, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499595618",
      "id" : 1499595618,
      "line" : 3841,
      "node_id" : "PRRC_kwDOABII585ZYgNi",
      "original_commit_id" : "c62eea853e5c5f390d58c5ad9c0ac9a688465abc",
      "original_line" : 3824,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 120,
      "pull_request_review_id" : 1896406510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499595618/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:30:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499595618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499598937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499598937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cb2437307e6861e0957899345b6e9b93716c383a\r\nMaybe add comment explaining what the tristate return result means? e.g. \"bool indicating the witness commitment is correct (state is populated if any error occurs), or std::nullopt if there is no witness commitment to be checked\"",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:17:04Z",
      "diff_hunk" : "@@ -3639,6 +3639,45 @@ static bool CheckBlockHeader(const CBlockHeader& block, BlockValidationState& st\n     return true;\n }\n \n+static bool CheckMerkleRoot(const CBlock& block, BlockValidationState& state)\n+{\n+    bool mutated;\n+    uint256 hashMerkleRoot2 = BlockMerkleRoot(block, &mutated);\n+    if (block.hashMerkleRoot != hashMerkleRoot2)\n+        return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-txnmrklroot\", \"hashMerkleRoot mismatch\");\n+\n+    // Check for merkle tree malleability (CVE-2012-2459): repeating sequences\n+    // of transactions in a block without affecting the merkle root of a block,\n+    // while still invalidating it.\n+    if (mutated)\n+        return state.Invalid(BlockValidationResult::BLOCK_MUTATED, \"bad-txns-duplicate\", \"duplicate transaction\");\n+\n+    return true;\n+}\n+\n+static std::optional<bool> CheckWitnessCommitment(const CBlock& block, BlockValidationState& state)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499598937",
      "id" : 1499598937,
      "line" : 3669,
      "node_id" : "PRRC_kwDOABII585ZYhBZ",
      "original_commit_id" : "cb2437307e6861e0957899345b6e9b93716c383a",
      "original_line" : 3658,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1896406510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499598937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:30:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499598937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499599724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499599724"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@dergoegge have you considered this?",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:17:41Z",
      "diff_hunk" : "@@ -0,0 +1,96 @@\n+#!/usr/bin/env python3\n+# Copyright (c) The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"\n+Test that an attacker can't degrade compact block relay by sending unsolicited\n+mutated blocks to clear in-flight blocktxn requests from other honest peers.\n+\"\"\"\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.messages import (\n+    BlockTransactions,\n+    msg_cmpctblock,\n+    msg_block,\n+    msg_blocktxn,\n+    HeaderAndShortIDs,\n+    tx_from_hex,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.blocktools import (\n+    COINBASE_MATURITY,\n+    create_block,\n+    add_witness_commitment,\n+    NORMAL_GBT_REQUEST_PARAMS,\n+)\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+import copy\n+\n+class MutatedBlocksTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.generate(self.wallet, COINBASE_MATURITY)\n+\n+        honest_relayer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        attacker = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Create new block with two transactions (coinbase + 1 self-transfer).\n+        # The self-transfer transaction is needed to trigger a compact block\n+        # `getblocktxn` roundtrip.\n+        tx = tx_from_hex(self.wallet.create_self_transfer()[\"hex\"])\n+        block = create_block(tmpl=self.nodes[0].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS), txlist=[tx])\n+        add_witness_commitment(block)\n+        block.solve()\n+\n+        # Create mutated version of the block by changing the transaction\n+        # version on the self-transfer.\n+        mutated_block = copy.deepcopy(block)\n+        mutated_block.vtx[1].nVersion = 4\n+\n+        # Announce the new block via a compact block through the honest relayer\n+        cmpctblock = HeaderAndShortIDs()\n+        cmpctblock.initialize_from_block(block, use_witness=True)\n+        honest_relayer.send_message(msg_cmpctblock(cmpctblock.to_p2p()))\n+\n+        # Wait for a `getblocktxn` that attempts to fetch the self-transfer\n+        def self_transfer_requested():\n+            if not honest_relayer.last_message.get('getblocktxn'):\n+                return False\n+\n+            get_block_txn = honest_relayer.last_message['getblocktxn']\n+            return get_block_txn.block_txn_request.blockhash == block.sha256 and \\\n+                   get_block_txn.block_txn_request.indexes == [1]\n+        honest_relayer.wait_until(self_transfer_requested, timeout=5)\n+\n+        # Block at height 101 should be the only one in flight from peer 0\n+        peer_info_prior_to_attack = self.nodes[0].getpeerinfo()\n+        assert_equal(peer_info_prior_to_attack[0]['id'], 0)\n+        assert_equal([101], peer_info_prior_to_attack[0][\"inflight\"])\n+\n+        # Attempt to clear the honest relayer's download request by sending the\n+        # mutated block (as the attacker).\n+        attacker.send_message(msg_block(mutated_block))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499599724",
      "id" : 1499599724,
      "in_reply_to_id" : 1484773525,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585ZYhNs",
      "original_commit_id" : "5f27c9be7acf82f1630802645d3b910baf39fa90",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_mutated_blocks.py",
      "position" : 78,
      "pull_request_review_id" : 1896417728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499599724/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:17:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499599724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499609287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499609287"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e2d1eb2e2001c31b43154df47ab5be215a26774f\r\n\r\nthis is the same thing as\r\n```suggestion\r\n        tx = self.wallet.create_self_transfer()[\"tx\"]\r\n```",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:25:09Z",
      "diff_hunk" : "@@ -0,0 +1,96 @@\n+#!/usr/bin/env python3\n+# Copyright (c) The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"\n+Test that an attacker can't degrade compact block relay by sending unsolicited\n+mutated blocks to clear in-flight blocktxn requests from other honest peers.\n+\"\"\"\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.messages import (\n+    BlockTransactions,\n+    msg_cmpctblock,\n+    msg_block,\n+    msg_blocktxn,\n+    HeaderAndShortIDs,\n+    tx_from_hex,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.blocktools import (\n+    COINBASE_MATURITY,\n+    create_block,\n+    add_witness_commitment,\n+    NORMAL_GBT_REQUEST_PARAMS,\n+)\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+import copy\n+\n+class MutatedBlocksTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.generate(self.wallet, COINBASE_MATURITY)\n+\n+        honest_relayer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        attacker = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Create new block with two transactions (coinbase + 1 self-transfer).\n+        # The self-transfer transaction is needed to trigger a compact block\n+        # `getblocktxn` roundtrip.\n+        tx = tx_from_hex(self.wallet.create_self_transfer()[\"hex\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499609287",
      "id" : 1499609287,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585ZYjjH",
      "original_commit_id" : "e2d1eb2e2001c31b43154df47ab5be215a26774f",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_mutated_blocks.py",
      "position" : 46,
      "pull_request_review_id" : 1896406510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499609287/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:30:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499609287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499613815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499613815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in e2d1eb2e2001c31b43154df47ab5be215a26774f\r\ndoes this need a `with p2p_lock`?",
      "commit_id" : "0f356b0b2fb23aef96ed7396890aa36410aa1d59",
      "created_at" : "2024-02-22T17:28:55Z",
      "diff_hunk" : "@@ -0,0 +1,96 @@\n+#!/usr/bin/env python3\n+# Copyright (c) The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"\n+Test that an attacker can't degrade compact block relay by sending unsolicited\n+mutated blocks to clear in-flight blocktxn requests from other honest peers.\n+\"\"\"\n+\n+from test_framework.p2p import P2PInterface\n+from test_framework.messages import (\n+    BlockTransactions,\n+    msg_cmpctblock,\n+    msg_block,\n+    msg_blocktxn,\n+    HeaderAndShortIDs,\n+    tx_from_hex,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.blocktools import (\n+    COINBASE_MATURITY,\n+    create_block,\n+    add_witness_commitment,\n+    NORMAL_GBT_REQUEST_PARAMS,\n+)\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+import copy\n+\n+class MutatedBlocksTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.generate(self.wallet, COINBASE_MATURITY)\n+\n+        honest_relayer = self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        attacker = self.nodes[0].add_p2p_connection(P2PInterface())\n+\n+        # Create new block with two transactions (coinbase + 1 self-transfer).\n+        # The self-transfer transaction is needed to trigger a compact block\n+        # `getblocktxn` roundtrip.\n+        tx = tx_from_hex(self.wallet.create_self_transfer()[\"hex\"])\n+        block = create_block(tmpl=self.nodes[0].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS), txlist=[tx])\n+        add_witness_commitment(block)\n+        block.solve()\n+\n+        # Create mutated version of the block by changing the transaction\n+        # version on the self-transfer.\n+        mutated_block = copy.deepcopy(block)\n+        mutated_block.vtx[1].nVersion = 4\n+\n+        # Announce the new block via a compact block through the honest relayer\n+        cmpctblock = HeaderAndShortIDs()\n+        cmpctblock.initialize_from_block(block, use_witness=True)\n+        honest_relayer.send_message(msg_cmpctblock(cmpctblock.to_p2p()))\n+\n+        # Wait for a `getblocktxn` that attempts to fetch the self-transfer\n+        def self_transfer_requested():\n+            if not honest_relayer.last_message.get('getblocktxn'):\n+                return False\n+\n+            get_block_txn = honest_relayer.last_message['getblocktxn']\n+            return get_block_txn.block_txn_request.blockhash == block.sha256 and \\\n+                   get_block_txn.block_txn_request.indexes == [1]\n+        honest_relayer.wait_until(self_transfer_requested, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#discussion_r1499613815",
      "id" : 1499613815,
      "line" : 69,
      "node_id" : "PRRC_kwDOABII585ZYkp3",
      "original_commit_id" : "e2d1eb2e2001c31b43154df47ab5be215a26774f",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "test/functional/p2p_mutated_blocks.py",
      "position" : 69,
      "pull_request_review_id" : 1896406510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29412",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499613815/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T17:30:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499613815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm running this PR on my mainnet monitoring infrastructure as I was looking at the currently broadcast mutated blocks (`bad-witness-nonce-size`) in detail anyway. Can report back in a few days (currently, I receive only 1 or 2 per week). ",
      "created_at" : "2024-02-23T09:58:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29412#issuecomment-1961033803",
      "id" : 1961033803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29412",
      "node_id" : "IC_kwDOABII58504wBL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961033803/reactions"
      },
      "updated_at" : "2024-02-23T09:58:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961033803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   }
]
