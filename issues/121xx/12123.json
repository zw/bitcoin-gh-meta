{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "### Observations\r\n\r\nBitcoind startup performance (Fully synced node)\r\n\r\nWhile running procmon when starting bitcoind.exe I noticed millions of file open/read/close events to the chainstate leveldb dir. The high frequency file open/close events occurred during this: (init.cpp)\r\n\r\n`    if (!ActivateBestChain(state, chainparams)) ..`\r\n\r\nInvestigating this further led me to level DB's LRUCache. We use a value of 64 for max_open_files:\r\n\r\n`options.max_open_files = 64;` in `static leveldb::Options GetOptions(size_t nCacheSize)`\r\n\r\nAs far as I know and read online the default for LevelDB is **1000**.\r\n\r\nI've noticed some (I consider significant) performance improvements by increasing the max_open_files var to the default 1000. This avoids the overhead of many thousand (per second) open/close operations on the files in the chainstate dir. This also avoids the unnecessary high frequency allocations created each time on the heap (LevelDB's Win32RandomAccessFile objects).\r\n\r\nI am not a levelDB expert but from what I can gather this value needs to not exceed the maximum number of file handles that the process can have but 64 seems a bit on the low side.\r\n\r\n### Results\r\nHere are some of my results while doing 5 iterations of max_open_files = 64 and 1000. The timings are timing the `ActivateBestChain` function call (Using high resolution timer).\r\n\r\n![image](https://user-images.githubusercontent.com/6394033/34693985-689717b6-f4bd-11e7-87bc-873048ee2024.png)\r\n\r\n\r\n### Questions:\r\n\r\n1) Why did we chose 64 as the fixed global value of max_open_files?\r\n2) Should we expose the max_open_files via a command line option or should we be smarter with this value since it has performance benefits (Perhaps even with initial chain sync?)\r\n\r\nMy system:\r\nDell XPS 17 9560 i7-7700HQ CPU @ 2.8 GHz, 2801 Mhz, 4 Cores. 16GB Ram, 512GB PCIe SSD, Windows 10\r\n\r\nRelease build (MSVC optimizations on /O2)\r\n\r\nIt would be interesting if someone can try some tests on a Linux machine. It could be related to some overhead with Windows' CreateFile while opening the files.\r\n\r\nIf it's accepted that this is a performance bottle neck then I am happy to propose a solution or do more research on this parameter. At the minimum expose it as a setting or command line option.\r\n\r\nThanks,\r\nDonal",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12123/comments",
   "created_at" : "2018-01-08T22:01:12Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12123/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/12123",
   "id" : 286902212,
   "labels" : [
      {
         "color" : "fbca04",
         "default" : false,
         "id" : 97470796,
         "name" : "UTXO Db and Indexes",
         "node_id" : "MDU6TGFiZWw5NzQ3MDc5Ng==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12123/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyODY5MDIyMTI=",
   "number" : 12123,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "[Performance] LevelDB options.max_open_files = 64 parameter (Windows 10)",
   "updated_at" : "2018-02-22T20:44:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12123",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
      "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
      "followers_url" : "https://api.github.com/users/donaloconnor/followers",
      "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
      "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/donaloconnor",
      "id" : 6394033,
      "login" : "donaloconnor",
      "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
      "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
      "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
      "repos_url" : "https://api.github.com/users/donaloconnor/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/donaloconnor"
   }
}
