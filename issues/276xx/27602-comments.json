[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/27602#pullrequestreview-1418933543), [willcl-ark](https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164) |\n| Approach NACK | [vasild](https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1545379692) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-05-08T21:23:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539072919",
      "id" : 1539072919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGOX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919/reactions"
      },
      "updated_at" : "2023-05-12T08:32:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Motivation: this fix was discussed over IRC by @willcl-ark @glozow @sipa and @darosior \r\n\r\nhttps://gnusha.org/bitcoin-core-dev/2023-05-02.log",
      "created_at" : "2023-05-08T21:24:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539074312",
      "id" : 1539074312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGkI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312/reactions"
      },
      "updated_at" : "2023-05-08T21:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't this just change the fingerprinting vector from `GETDATA txid` to `FILTERCLEAR; FILTERADD whatever; MEMPOOL` ? In which case we're just as easily fingerprinted, but we spend more cpu while being fingerprinted?",
      "commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "created_at" : "2023-05-09T08:11:42Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489",
      "id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G09QB",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 1418112808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T08:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852"
         }
      },
      "author_association" : "NONE",
      "body" : "Do you mean keep adding what you're interested in into the filter so it triggers an `INV` from the node and, therefore, we can request it (or, similarly, keep resetting the filter and just add the one single transaction that we want to probe)? If so, isn't that equivalent to having no filter?\r\n\r\nI think in both of the aforementioned cases (which boil down to the same logic if I'm not mistaken) the patch prevents the attacker from requesting unannounced transactions straight-away, they will have to wait for `m_next_inv_send_time` to go off.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:01:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852",
      "id" : 1188745852,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G2tJ8",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1418860317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:01:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_last_mempool_req` is now unused and can be removed completely? Also, it might be good to not touch the `return` here when there is no reason, to avoid code churn and review burden.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:13:52Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337",
      "id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2xbJ",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418888189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:13:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722"
         }
      },
      "author_association" : "NONE",
      "body" : "> m_last_mempool_req is now unused and can be removed completely?\r\n\r\nLooks like it\r\n\r\n> Also, it might be good to not touch the return here when there is no reason, to avoid code churn and review burden.\r\n\r\nI thought the only reason why this was split into two lines is that it was a bit too long (?), I tried to follow the same approach as in `L2267` and, while I think it looks more compact the way it is now, I don't have a strong opinion about on styling atm, so I'm happy to amend it if there is consensus that this is best.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T18:00:47Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722",
      "id" : 1188956722,
      "in_reply_to_id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G3goy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419184844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T18:01:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Addressed comments by @MarcoFalke and fixed a couple of logs from the tests",
      "created_at" : "2023-05-09T19:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1540782565",
      "id" : 1540782565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b1nnl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565/reactions"
      },
      "updated_at" : "2023-05-09T19:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I see what you mean. That makes sense.\r\n\r\nNext point on those lines though: adding many things to `m_recently_announced_invs` can overflow the bloom filter, either causing false positives (leading to privacy bugs), or since it's a rolling bloom filter, causing overflow leading to false negatives (leading to functionality bugs where you can't get the txs from the MEMPOOL response). Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T00:46:20Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200",
      "id" : 1189250200,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G4oSY",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1419619927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T00:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ?\r\n\r\nYeah, I think that makes perfect sense, given there is no point in adding something to the filter if we are going to unconditionally serve it anyway.\r\n\r\n> Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?\r\n\r\nIt may indeed. I haven't got my head around how to properly compute what are the odds of this happening though, given it feels like it depends on how often `MEMPOOL` messages are sent to us, which may be unbounded (how many `MEMPOOL` requests can we receive in a `UNCONDITIONAL_RELAY_DELAY` period, and how full our mempool may be?). In any case, this feels detrimental for the peer implementing this behavior instead of for us (?)\r\n\r\nSomething I'm really wondering is why this is actually bound by `INVENTORY_MAX_RECENT_RELAY (3500)`  instead of by `MAX_PEER_TX_ANNOUNCEMENTS (5000)`. It feels quite inconsistent that we are able to accept up to 5000 transaction announcements from someone but we are only able to remember the last 3500 that we have announced to someone(else).\r\n\r\nI think what may make even more sense would be to reply to mempool messages only with transactions that fall into the `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` check, that way we don't really have to add transactions to `m_recently_announced_invs` here, and we are also discouraging peers bloating us with `MEMPOOL` messages. As long as they have a filter set, any transaction that matches their filter will be announced to them anyway (h/t @sdaftuar). I guess this could be done as a followup if it makes sense.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T18:56:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606",
      "id" : 1190289606,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8mDG",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421218257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? \r\n\r\nAlso wouldn't that also apply here? https://github.com/bitcoin/bitcoin/blob/27c40e3dcf280a137bcfaa787674c26781d911b8/src/net_processing.cpp#L5688\r\n",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T19:42:56Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642",
      "id" : 1190326642,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8vFy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421274926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:42:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-05-10T20:00:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164",
      "id" : 1542733164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b9D1s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164/reactions"
      },
      "updated_at" : "2023-05-10T20:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MAX_PEER_TX_ANNOUNCEMENTS` doesn't really provide a rate limit -- it stops the queue from being more than 5k at any point in time, but the flow through the queue could still be 400tx/s, for instance.  Beyond that, `m_recently_announced_invs` only tracks things we announced, not things we received, and we rate limit that (as per the static_assert on `INVENTORY_MAX_RECENT_RELAY`).\r\n\r\nDelaying MEMPOOL results for 2 minutes seems annoying. But how about just recording the timestamp of the last MEMPOOL request into the `txrelay` structure, and skipping the bloom lookup if `m_time <= max(now-2min, txrelay->last_mempool_request)` ?\r\n\r\nYou could make the inv-trickle insertion into the bloom filter conditional too, but I think that would so rarely actually have an effect that it wouldn't matter?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T00:26:46Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125",
      "id" : 1190497125,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G9Ytl",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421520316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T00:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm only a casual lurker on the net_processing side but i was under the impression we were thinking of the BIP35 as permissioned anyways. If we are already trusting the peer that sends use MEMPOOL message, why not just include everything we've got?\r\nA practical counter-argument to this could be - yeah but at this time [around 20% to 30% of reachable nodes](https://github.com/bitcoin/bitcoin/pull/27426#issuecomment-1529678174) set `peerbloomfilters` so it's still worth closing an obvious fingerprinting vector.\r\n\r\nAnother thing is whether it's breaking any usecase. Since the message is from a trusted peer a client may be relying on getting the whole mempool. For instance BTCPay/NBXplorer needs `whitelist=mempool` iirc. What's the proportion of announced vs non-announced transactions? How much would be left out with this patch?",
      "created_at" : "2023-05-11T08:20:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543552214",
      "id" : 1543552214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cALzW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543552214/reactions"
      },
      "updated_at" : "2023-05-11T08:20:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543552214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190924614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> But how about just recording the timestamp of the last MEMPOOL request ...\r\n\r\nPatch might look something like... (EDIT: Err, except that's just essentially reverting back to what we have now?)\r\n\r\n<details><summary>Details</summary>\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -295,6 +295,8 @@ struct Peer {\r\n          *  permitted if the peer has NetPermissionFlags::Mempool or we advertise\r\n          *  NODE_BLOOM. See BIP35. */\r\n         bool m_send_mempool GUARDED_BY(m_tx_inventory_mutex){false};\r\n+        std::chrono::microseconds m_last_mempool_time GUARDED_BY(m_tx_inventory_mutex){0};\r\n+\r\n         /** The next time after which we will send an `inv` message containing\r\n          *  transaction announcements to this peer. */\r\n         std::chrono::microseconds m_next_inv_send_time GUARDED_BY(m_tx_inventory_mutex){0};\r\n@@ -2258,7 +2260,7 @@ CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay,\r\n     auto txinfo = m_mempool.info(gtxid);\r\n     if (txinfo.tx) {\r\n         // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\r\n-        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\r\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY || WITH_LOCK(tx_relay.m_tx_inventory_mutex, return txinfo.m_time <= tx_relay.m_last_mempool_time)) {\r\n             return std::move(txinfo.tx);\r\n         }\r\n     }\r\n@@ -5619,6 +5621,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                     tx_relay->m_send_mempool = false;\r\n                     const CFeeRate filterrate{tx_relay->m_fee_filter_received.load()};\r\n \r\n+                    tx_relay->m_last_mempool_time = current_time;\r\n                     LOCK(tx_relay->m_bloom_filter_mutex);\r\n \r\n                     for (const auto& txinfo : vtxinfo) {\r\n@@ -5632,7 +5635,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                         if (tx_relay->m_bloom_filter) {\r\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\r\n                         }\r\n-                        tx_relay->m_tx_inventory_known_filter.insert(hash);\r\n                         tx_relay->m_recently_announced_invs.insert(hash);\r\n                         vInv.push_back(inv);\r\n                         if (vInv.size() == MAX_INV_SZ) {\r\n```\r\n</details> ",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T09:51:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190924614",
      "id" : 1190924614,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_BFG",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422203739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190966758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, other idea: how about just making sure you only send at most 3500 mempool entries younger than 2 minutes, in response to a MEMPOOL message, and add them all to the filter, and don't worry if that causes overflow on results from a previous response?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T10:28:01Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190966758",
      "id" : 1190966758,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_LXm",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422269233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> i was under the impression we were thinking of the BIP35 as permissioned anyways.\r\n> ...\r\n> For instance BTCPay/NBXplorer needs `whitelist=mempool` iirc.\r\n\r\nJust on these points, currently the MEMPOOL message will be responded to _either_ if you have the whitelist permission `mempool` on the peer **or** if you have enabled NODE_BLOOM (with `-peerbloomfilters`). In the latter case I don't think we can accurately describe these as \"trusted peers\". See the changes in [`4581a68` (#27559)](https://github.com/bitcoin/bitcoin/pull/27559/commits/4581a682d2d1fdd0e56fb4a56e6228be878a04a3) which clarify this.\r\n\r\n",
      "created_at" : "2023-05-11T10:34:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543749307",
      "id" : 1543749307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cA767",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543749307/reactions"
      },
      "updated_at" : "2023-05-11T10:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543749307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190981465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> how about just making sure you only send at most 3500 mempool entries younger than 2 minutes, in response to a MEMPOOL message\r\n\r\nWouldn't that imply that peers are now expected to send the `mempool` message in a loop (or at least twice over a span of two minutes) to detect if there were more transactions to get? If yes, I wonder if it conflicts with the idea to potentially only allow a single `mempool` message per connection.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T10:42:52Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190981465",
      "id" : 1190981465,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_O9Z",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422291699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:56:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191023800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if we can remove mapRelay and as a result can get more efficient data structures to remember (w)txids per `Peer`, knowing that only transaction in the mempool can be in them.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T11:25:18Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191023800",
      "id" : 1191023800,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_ZS4",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422357714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T11:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The title \"avoid serving non-announced txs as a result of a MEMPOOL message\" is confusing - it gives the impression that this PR will change the response to `MEMPOOL` messages, but it does not do that. Before and after the PR we would send the full mempool in a reply to `mempool` (correct me if I got it wrong).\r\n",
      "created_at" : "2023-05-11T12:34:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543917289",
      "id" : 1543917289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cBk7p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543917289/reactions"
      },
      "updated_at" : "2023-05-11T12:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543917289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  What's the proportion of announced vs non-announced transactions? How much would be left out with this patch?\r\n\r\nThe PR (as it is right now) still announces everything in response to mempool. This is saying \"I haven't even announced this to you, why are you requesting it from me?\" A normal client, who presumably does not already know what it wants to request until it receives an announcement (i.e. using `mempool` to learn about transactions), shouldn't be affected at all.",
      "created_at" : "2023-05-11T12:56:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543955685",
      "id" : 1543955685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cBuTl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543955685/reactions"
      },
      "updated_at" : "2023-05-11T19:10:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543955685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191157352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I wonder if we can remove mapRelay and as a result can get more efficient data structures to remember (w)txids per Peer, knowing that only transaction in the mempool can be in them.\r\n\r\n`mapRelay` is mostly what's in the mempool, but can also contain entries that were announced less than 15min ago + fell out of the mempool since then. This is sometimes good for fingerprinting :shrug: but also seems like largely redundant information to me.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:07:35Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191157352",
      "id" : 1191157352,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_55o",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422573948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191170092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think we can remove `mapRelay` -- we need it so we can continue to relay recently announced txs that we've removed from the mempool?\r\n\r\nHow about this approach: when we get a MEMPOOL message, at the next `fSendTrickle` time, for each tx that matches the filter, if it's older than 2 minutes, announce it immediately, otherwise just put it into `m_tx_inventory_to_send` and let it be sent out at the usual rate. Only use `m_recently_announced_invs` for txs relayed via `m_tx_inventory_to_send`. (Maybe bump the \"2 minutes\" by a small random amount)",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:17:10Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191170092",
      "id" : 1191170092,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_9As",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422594028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191189563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        self.log.info(\"Check all transactions are returned by the match-all filter\")\r\n```",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:31:23Z",
      "diff_hunk" : "@@ -135,14 +136,38 @@ def test_msg_mempool(self):\n         self.log.info(\"Check that a node with bloom filters enabled services p2p mempool messages\")\n         filter_peer = P2PBloomFilter()\n \n-        self.log.debug(\"Create a tx relevant to the peer before connecting\")\n-        txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=9 * COIN)\n+        self.log.info(\"Create two tx before connecting, one relevant to the node another that is not\")\n+        rel_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=1 * COIN)\n+        rel_wtxid = self.nodes[0].getmempoolentry(rel_txid)[\"wtxid\"]\n+        irr_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=2 * COIN)\n+        irr_wtxid = self.nodes[0].getmempoolentry(irr_txid)[\"wtxid\"]\n \n-        self.log.debug(\"Send a mempool msg after connecting and check that the tx is received\")\n+        self.log.info(\"Send a mempool msg after connecting and check that the relevant tx is received\")\n         self.nodes[0].add_p2p_connection(filter_peer)\n         filter_peer.send_and_ping(filter_peer.watch_filter_init)\n-        filter_peer.send_message(msg_mempool())\n-        filter_peer.wait_for_tx(txid)\n+        filter_peer.send_and_ping(msg_mempool())\n+        filter_peer.wait_for_tx(rel_txid)\n+\n+        self.log.info(\"Request the irrelevant transaction even though it has not being offered to us\")\n+        filter_peer.tx_received = False\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(irr_wtxid, 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Create a third transaction (that was therefore not part of the mempool message) and try to retrieve it\")\n+        add_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=3 * COIN)\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(self.nodes[0].getmempoolentry(add_txid)[\"wtxid\"], 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Check this is also sound for a peer that has a match-all filter set\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191189563",
      "id" : 1191189563,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585HABw7",
      "original_commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "original_line" : 161,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_filter.py",
      "position" : 39,
      "pull_request_review_id" : 1422624974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:31:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191190564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this log line could be removed as this seems part of the previous check?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:32:36Z",
      "diff_hunk" : "@@ -135,14 +136,38 @@ def test_msg_mempool(self):\n         self.log.info(\"Check that a node with bloom filters enabled services p2p mempool messages\")\n         filter_peer = P2PBloomFilter()\n \n-        self.log.debug(\"Create a tx relevant to the peer before connecting\")\n-        txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=9 * COIN)\n+        self.log.info(\"Create two tx before connecting, one relevant to the node another that is not\")\n+        rel_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=1 * COIN)\n+        rel_wtxid = self.nodes[0].getmempoolentry(rel_txid)[\"wtxid\"]\n+        irr_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=2 * COIN)\n+        irr_wtxid = self.nodes[0].getmempoolentry(irr_txid)[\"wtxid\"]\n \n-        self.log.debug(\"Send a mempool msg after connecting and check that the tx is received\")\n+        self.log.info(\"Send a mempool msg after connecting and check that the relevant tx is received\")\n         self.nodes[0].add_p2p_connection(filter_peer)\n         filter_peer.send_and_ping(filter_peer.watch_filter_init)\n-        filter_peer.send_message(msg_mempool())\n-        filter_peer.wait_for_tx(txid)\n+        filter_peer.send_and_ping(msg_mempool())\n+        filter_peer.wait_for_tx(rel_txid)\n+\n+        self.log.info(\"Request the irrelevant transaction even though it has not being offered to us\")\n+        filter_peer.tx_received = False\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(irr_wtxid, 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Create a third transaction (that was therefore not part of the mempool message) and try to retrieve it\")\n+        add_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=3 * COIN)\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(self.nodes[0].getmempoolentry(add_txid)[\"wtxid\"], 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Check this is also sound for a peer that has a match-all filter set\")\n+        unfilter_peer = P2PBloomFilter()\n+        self.nodes[0].add_p2p_connection(unfilter_peer)\n+        unfilter_peer.send_and_ping(msg_mempool())\n+\n+        self.log.info(\"Here the all transactions are relevant\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191190564",
      "id" : 1191190564,
      "line" : 166,
      "node_id" : "PRRC_kwDOABII585HACAk",
      "original_commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "original_line" : 166,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "test/functional/p2p_filter.py",
      "position" : 44,
      "pull_request_review_id" : 1422626564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:32:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191211092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This is sometimes good for fingerprinting\r\n\r\nfingerprinting seems bad, so another reason for removal? \r\n\r\n> I don't think we can remove mapRelay -- we need it so we can continue to relay recently announced txs that we've removed from the mempool?\r\n\r\nSure that is what it does, but if the only use case is for spy nodes to fingerprint, it may be better to remove it?\r\n\r\nSee #27625. Feel free to NACK.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:58:13Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191211092",
      "id" : 1191211092,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585HAHBU",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422659629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191220466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191220466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Knowing when a tx is removed from the mempool means you know exactly when the tx that replaced it was added to the mempool... Txs are also removed from the mempool when a block comes in; if we process the block first, then see a GETDATA for a tx in the block, replying with the tx is better for block propagation (including compact blocks) that sending a NOTFOUND... ",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T14:02:47Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191220466",
      "id" : 1191220466,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585HAJTy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422671536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191220466/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T14:02:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191220466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191317284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191317284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> >   This is sometimes good for fingerprinting\r\n\r\n> fingerprinting seems bad, so another reason for removal?\r\n\r\nSorry I meant that it's sometimes good for _preventing_ fingerprinting. In the replacement scenario which @ajtowns is describing. Timing of entry of replacement == notfound of replaced tx. With `mapRelay`, since you have the replaced tx for 15 minutes, you'll still serve it instead of immediately saying notfound. But `mapRelay` is useless against this if the spy node just waits 15 minutes before doing the replacement. So this could just be a lost cause.\r\n\r\nAnyway, will take this to #27625 instead.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T15:00:52Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191317284",
      "id" : 1191317284,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585HAg8k",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422825998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191317284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:00:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191317284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it the case that this PR will change the behavior in the following two cases (from the PR title and description I got the impression that it is wider scope):\r\n\r\n### Case 1\r\n* the node receives `MEMPOOL` request and replies to it\r\n* in the same second a new transaction enters the mempool (after the `MEMPOOL` message)\r\n* the node receives `GETDATA` for that transaction\r\n\r\nIn `master` it would send the transaction even though it never advertised it with `INV` due to the `txinfo.m_time <= mempool_req` check (both values would be equal).\r\n\r\nIn this PR it would claim \"not found\".\r\n\r\nThis can be resolved by increasing the precision of `TxRelay::m_last_mempool_req` and `TxMempoolInfo::m_time` or by changing the condition to `<`.\r\n\r\n### Case 2\r\n* the node receives `MEMPOOL` request and replies to it, but some transaction is omitted from the reply because it is not in `TxRelay::m_bloom_filter`.\r\n* the node receives `GETDATA` for that transaction\r\n\r\nIn `master` it would send the transaction even though it never advertised it with `INV` because `PeerManagerImpl::FindTxForGetData()` does not check the bloom filter.\r\n\r\nIn this PR it would claim \"not found\".\r\n\r\nIs this a problem at all? If yes, then it can be resolved by checking the bloom filter from `PeerManagerImpl::FindTxForGetData()`.",
      "created_at" : "2023-05-11T15:05:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544163035",
      "id" : 1544163035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cCg7b",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544163035/reactions"
      },
      "updated_at" : "2023-05-11T15:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544163035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I'm only a casual lurker on the net_processing side but i was under the impression we were thinking of the BIP35 as permissioned anyways. If we are already trusting the peer that sends use MEMPOOL message, why not just include everything we've got? A practical counter-argument to this could be - yeah but at this time [around 20% to 30% of reachable nodes](https://github.com/bitcoin/bitcoin/pull/27426#issuecomment-1529678174) set `peerbloomfilters` so it's still worth closing an obvious fingerprinting vector.\r\n\r\nWe still do. This is not modifying the behavior of the announcements that result from a `mempool` message, but the behavior of the node to the `getdata` messages that may follow. Before the patch, a node was able to send us a `mempool` message and, from that point on, request any transaction from our mempool (even if we haven't announced that to them at all).\r\n\r\n> \r\n> Another thing is whether it's breaking any usecase. Since the message is from a trusted peer a client may be relying on getting the whole mempool. For instance BTCPay/NBXplorer needs `whitelist=mempool` iirc. What's the proportion of announced vs non-announced transactions? How much would be left out with this patch?\r\n\r\nAs of [27c40e3](https://github.com/bitcoin/bitcoin/pull/27602/commits/27c40e3dcf280a137bcfaa787674c26781d911b8) we still do, even though I would argue that, by doing this, we are encouraging peers to spam us with mempool messages instead of waiting for us to announce the transactions that match their filters in due time.\r\n\r\n",
      "created_at" : "2023-05-11T15:07:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544165800",
      "id" : 1544165800,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cChmo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544165800/reactions"
      },
      "updated_at" : "2023-05-11T15:07:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544165800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> The title \"avoid serving non-announced txs as a result of a MEMPOOL message\" is confusing - it gives the impression that this PR will change the response to `MEMPOOL` messages, but it does not do that. Before and after the PR we would send the full mempool in a reply to `mempool` (correct me if I got it wrong).\r\n\r\nMaybe it should read \"after receiving a MEMPOOL message\" instead of \"as a result of a MEMPOOL message\".\r\n\r\nWhat this PR is trying to achieve is to prevent us from responding to getdata requests about unannounced transactions after receiving a mempool message. ",
      "created_at" : "2023-05-11T15:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544171098",
      "id" : 1544171098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cCi5a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544171098/reactions"
      },
      "updated_at" : "2023-05-11T15:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544171098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Is it the case that this PR will change the behavior in the following two cases (from the PR title and description I got the impression that it is wider scope):\r\n> \r\n> ### Case 1\r\n> * the node receives `MEMPOOL` request and replies to it\r\n> * in the same second a new transaction enters the mempool (after the `MEMPOOL` message)\r\n> * the node receives `GETDATA` for that transaction\r\n> \r\n> In `master` it would send the transaction even though it never advertised it with `INV` due to the `txinfo.m_time <= mempool_req` check (both values would be equal).\r\n> \r\n> In this PR it would claim \"not found\".\r\n> \r\n> This can be resolved by increasing the precision of `TxRelay::m_last_mempool_req` and `TxMempoolInfo::m_time` or by changing the condition to `<`.\r\n\r\nThis is exactly what we are trying to prevent, but I don't think your approach fixes the issue. This condition is checking that our inv (`txinfo`) is more recent than the last `mempool_req`, meaning that once a mempool request has been processed the peer can request any transaction from our mempool. Why is this bad? It makes transactions that enter our memopool easily probable. The node can create a transaction (`tx`), send it through any other link, and spam us with `getdata` messages until we reply with it.\r\n\r\n> \r\n> ### Case 2\r\n> * the node receives `MEMPOOL` request and replies to it, but some transaction is omitted from the reply because it is not in `TxRelay::m_bloom_filter`.\r\n> * the node receives `GETDATA` for that transaction\r\n> \r\n> In `master` it would send the transaction even though it never advertised it with `INV` because `PeerManagerImpl::FindTxForGetData()` does not check the bloom filter.\r\n> \r\n> In this PR it would claim \"not found\".\r\n> \r\n> Is this a problem at all? If yes, then it can be resolved by checking the bloom filter from `PeerManagerImpl::FindTxForGetData()`.\r\n\r\nArguably this is the expected behavior, master's is not. \r\n\r\nThe response to the mempool message didn't include an INV from that specific transaction (both in the patch nor in master's) because it didn't match the filter set by the peer, therefore, the peer should not be interested in it. With respect to why claiming `not found` after the peer requests the transaction (what makes this different from `master`) I think we can default to the same reasoning as per Case 1.",
      "created_at" : "2023-05-11T15:30:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544205452",
      "id" : 1544205452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cCrSM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544205452/reactions"
      },
      "updated_at" : "2023-05-11T15:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544205452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191396005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191396005"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think the timing of removal from `mapRelay` reveals a secret -- that's 15minutes after it was added, but the time it was added is the time it was first announced (probably to an outbound peer), which is already randomised/batched, compared to the time we received it?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T15:59:00Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191396005",
      "id" : 1191396005,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585HA0Kl",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422955631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191396005/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:59:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191396005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > `txinfo.m_time <= mempool_req`\r\n\r\n> This condition is checking that our inv (`txinfo`) is more recent than the last `mempool_req`, meaning that once a mempool request has been processed the peer can request any transaction from our mempool.\r\n\r\nI don't get it. Is it not that the condition is checking whether `txinfo` is _older_ than the last `mempool_req`? In that case the transaction has been part of the `MEMPOOL` reply, so we have sent an `INV` about it.",
      "created_at" : "2023-05-11T16:00:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544261088",
      "id" : 1544261088,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cC43g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544261088/reactions"
      },
      "updated_at" : "2023-05-11T16:00:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544261088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > > `txinfo.m_time <= mempool_req`\r\n> \r\n> > This condition is checking that our inv (`txinfo`) is more recent than the last `mempool_req`, meaning that once a mempool request has been processed the peer can request any transaction from our mempool.\r\n> \r\n> I don't get it. Is it not that the condition is checking whether `txinfo` is _older_ than the last `mempool_req`? In that case the transaction has been part of the `MEMPOOL` reply, so we have sent an `INV` about it.\r\n\r\nAh, I think you're right! So this changes Case 2, not Case 1.",
      "created_at" : "2023-05-11T19:17:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544548047",
      "id" : 1544548047,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cD-7P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544548047/reactions"
      },
      "updated_at" : "2023-05-11T19:17:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544548047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > > > `txinfo.m_time <= mempool_req`\r\n> > \r\n> > \r\n> > > This condition is checking that our inv (`txinfo`) is more recent than the last `mempool_req`, meaning that once a mempool request has been processed the peer can request any transaction from our mempool.\r\n> > \r\n> > \r\n> > I don't get it. Is it not that the condition is checking whether `txinfo` is _older_ than the last `mempool_req`? In that case the transaction has been part of the `MEMPOOL` reply, so we have sent an `INV` about it.\r\n> \r\n> Ah, I think you're right! So this changes Case 2, not Case 1.\r\n\r\nHe is indeed. The test for Case 1 was passing because both requests were processed within the same second ð ",
      "created_at" : "2023-05-11T21:16:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1544692524",
      "id" : 1544692524,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cEiMs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544692524/reactions"
      },
      "updated_at" : "2023-05-11T21:16:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544692524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "No, wait! This PR changes both Case1 and Case2, but Case1 is only about things happening in the same second.\r\n\r\nWhat I tried yesterday:\r\n* Run the newly added tests, they were passing, of course. Cool!\r\n* Revert the `net_processing.cpp` changes, both tests `Request the irrelevant transaction even though it has not being offered to us` and `Create a third transaction (that was therefore not part of the mempool message) and try to...` failed. Good! To reach the second test I disabled the `assert` from the first.\r\n\r\nBut I couldn't explain why the second test would fail (without `net_processing.cpp` changes aka on `master`). Then I suspected things happen in the same second in the test and added `time.sleep(1)` before creating the third transaction and then the test passed.\r\n\r\nConcept ACK. I agree that we should not respond to `GETDATA` asking for a transaction which we did not `INV` to that peer and this PR does that.\r\n\r\nHowever, I agree with @ajtowns's concern raised above about blowing up `m_recently_announced_invs`. That bloom filter has size 3500 and if we put 300k elements in it, then it is probably not going to work as expected.\r\nApproach NACK due to that.\r\n\r\nSo, to achieve the goal of not replying to `GETDATA` without a prior `INV` we have to remember all `INV`s sent to the peer, but that is kind of \"hard\" considering a `MEMPOOL` reply sends 300k `INV`s...",
      "created_at" : "2023-05-12T08:32:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1545379692",
      "id" : 1545379692,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cHJ9s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545379692/reactions"
      },
      "updated_at" : "2023-05-12T08:32:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545379692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Looking at the comment of `CRollingBloomFilter` if `m_recently_announced_invs` is changed from `3500` to `300000` then its size would increase from 37KB to 3MB. I guess that is too much and maybe was the reason why `MEMPOOL` replies don't use `m_recently_announced_invs` and instead use the `m_last_mempool_req` timing mechanism.",
      "created_at" : "2023-05-12T08:49:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1545400201",
      "id" : 1545400201,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cHO-J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545400201/reactions"
      },
      "updated_at" : "2023-05-12T08:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545400201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> No, wait! This PR changes both Case1 and Case2, but Case1 is only about things happening in the same second.\r\n> \r\n\r\nI meant regarding the time checks in master, the checks were indeed protecting against querying something that was in the mempool before the mempool message was received. Meaning that while this patch fixes the issues around requesting data after a mempool message is received, they are not as severe as initially assumed.\r\n\r\n> However, I agree with @ajtowns's concern raised above about blowing up `m_recently_announced_invs`. That bloom filter has size 3500 and if we put 300k elements in it, then it is probably not going to work as expected. Approach NACK due to that.\r\n\r\nI think at this point there are two easy solutions to the problem (with their corresponding tradeoffs, of course):\r\n\r\n1. Do things as stated in the patch but guarding addition to the `m_recently_announced_invs` rolling filter by checking that the data we are adding is not older than two minutes, as @ajtowns originally suggested. This will prevent us from adding data that will be served unconditionally anyway, reducing the odds of overflowing the filter. However, I'm not sure how AJ computed the odds of the filter overflowing due to high traffic, so I'm not able to convince myself this is enough.\r\n\r\n2. Keep the `m_recently_announced_invs` bypass as it is in `master`, but do check the bloom filter when deciding whether to relay something that may have been announced to a peer as a response to a `mempool` message. This has two main drawbacks: \r\n\r\n- First, we will be checking the filter twice, once when deciding whether to include the transaction announcement as part of the response to the `MEMPOOL` message (https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L5649-L5651) and again as part of the combined check in `FindTxForGetData` (https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L2271).\r\n- Second, this, potentially, can result in the two versions of the filter differing between them. A node could clear their filter after sending the `MEMPOOL` message and before requesting the data and we will end up serving something we haven't really announced. However, I cannot think of a proper use case (or attack, FWIW) that takes advantage of this in a meaningful way. If the goal was for us to include all the data we had in our mempool when sending us the `MEMPOOL` message, they could have had a clear filter to begin with. \r\n\r\n",
      "created_at" : "2023-05-12T16:14:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1545980948",
      "id" : 1545980948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cJcwU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545980948/reactions"
      },
      "updated_at" : "2023-05-12T16:14:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545980948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   }
]
