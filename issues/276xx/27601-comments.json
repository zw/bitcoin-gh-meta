[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [murchandamus](https://github.com/bitcoin/bitcoin/pull/27601#pullrequestreview-1480176356), [luke-jr](https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1604559997) |\n| Approach ACK | [S3RK](https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1637521709) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25273](https://github.com/bitcoin/bitcoin/pull/25273) (wallet: Pass through transaction locktime and preset input sequences and scripts to CreateTransaction by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-08T21:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1539047166",
      "id" : 1539047166,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27601",
      "node_id" : "IC_kwDOABII585bu_7-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539047166/reactions"
      },
      "updated_at" : "2023-07-17T07:32:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539047166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230085873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // Gather sum of recipient output amounts and count number of outputs to subtract fees from\r\n```",
      "commit_id" : "7ec42848aa6033ae982dbf90ef33348c979c83e0",
      "created_at" : "2023-06-14T19:42:33Z",
      "diff_hunk" : "@@ -884,6 +874,19 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         // change keypool ran out, but change is required.\n         CHECK_NONFATAL(IsValidDestination(dest) != scriptChange.empty());\n     }\n+\n+    // Gather total out and whether SFFO is enabled or not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230085873",
      "id" : 1230085873,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585JUZ7x",
      "original_commit_id" : "cc82f6f65a43711a36ab6b4635fc8d34082c0d4b",
      "original_line" : 878,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 32,
      "pull_request_review_id" : 1480176356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T19:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230096522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230096522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I would expect `GetChange(â¦)` to deduct the fee for the change, but if you already have a change output, wouldnât that mean that you account for the change fee twice? You might need to add the change_fee back in the case where you just increase an existing change output.",
      "commit_id" : "7ec42848aa6033ae982dbf90ef33348c979c83e0",
      "created_at" : "2023-06-14T19:54:19Z",
      "diff_hunk" : "@@ -987,14 +991,21 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n \n     const CAmount change_amount = result.GetChange(coin_selection_params.min_viable_change, coin_selection_params.m_change_fee);\n     if (change_amount > 0) {\n-        CTxOut newTxOut(change_amount, scriptChange);\n-        if (nChangePosInOut == -1) {\n-            // Insert change txn at random position:\n-            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-        } else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-            return util::Error{_(\"Transaction change output index out of range\")};\n+        if (existent_change_out_index) {\n+            // If there is an output with the change address already, increase that one instead of creating a new output\n+            txNew.vout.at(*existent_change_out_index).nValue += change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230096522",
      "id" : 1230096522,
      "line" : 996,
      "node_id" : "PRRC_kwDOABII585JUciK",
      "original_commit_id" : "6499c4c007019945f1f42c40f70c19b781a7ae64",
      "original_line" : 996,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 74,
      "pull_request_review_id" : 1480176356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230096522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T19:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230096522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230098983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230098983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps you should add a test that checks how much fees youâve paid for the change outputs. I suspect you might pay two change fees when increasing an existing change, unless that gets cleaned up in some fashion. A test that rules it out would be neat.",
      "commit_id" : "7ec42848aa6033ae982dbf90ef33348c979c83e0",
      "created_at" : "2023-06-14T19:57:07Z",
      "diff_hunk" : "@@ -315,6 +316,67 @@ def test_change_type(self):\n         dec_tx = self.nodes[2].decoderawtransaction(rawtx['hex'])\n         assert_equal('witness_v0_keyhash', dec_tx['vout'][rawtx['changepos']]['scriptPubKey']['type'])\n \n+    def test_double_change(self):\n+        self.log.info(\"Test fundrawtxn funding a tx with an existent change output and the same custom change addr\")\n+        wallet = self.nodes[0]\n+\n+        # 1) fundrawtxn shouldn't create a second change output if there is one already going to that address\n+        change_addr = wallet.getrawchangeaddress()\n+        external_addr = wallet.getnewaddress()\n+        outputs = {external_addr: Decimal(40.0), change_addr: Decimal(3)}\n+        rawtx = wallet.createrawtransaction([], outputs)\n+        funded_tx = wallet.fundrawtransaction(hexstring=rawtx, options={'changeAddress': change_addr})\n+\n+        # Verify change output existence\n+        change_pos = funded_tx['changepos']\n+        assert change_pos != -1\n+\n+        # Verify outputs now; the wallet must have increased the existent change out value instead of creating a new one\n+        dec_tx = wallet.decoderawtransaction(funded_tx['hex'])\n+        assert_equal(wallet.gettransaction(dec_tx['vin'][0]['txid'])['amount'], Decimal(50))  # assert input value\n+        assert_equal(len(dec_tx['vout']), 2)\n+        for index in range(2):\n+            out = dec_tx['vout'][index]\n+            if index == change_pos:\n+                # Change must have increased its value, change = input - outputs - fee.\n+                assert_equal(out['value'], Decimal(50) - outputs[external_addr] - funded_tx['fee'])\n+                assert_equal(out['scriptPubKey']['address'], change_addr)\n+            else:\n+                # Non-change output must remain the same\n+                assert_equal(out['value'], outputs[external_addr])\n+                assert_equal(out['scriptPubKey']['address'], external_addr)\n+\n+        # 2) Fund tx and verify that the second output going to the change address is not discarded by the wallet\n+        #    changeless txs predilection. Even when the output is \"change\" under the wallet perspective, the user has\n+        #    set it manually, so it must not be discarded.\n+        outputs = {external_addr: Decimal(\"49.998\"), change_addr: Decimal(3)}\n+        rawtx = wallet.createrawtransaction([], outputs)\n+        funded_tx = wallet.fundrawtransaction(hexstring=rawtx, options={'changeAddress': change_addr})\n+\n+        # Verify change output existence\n+        change_pos = funded_tx['changepos']\n+        assert change_pos != -1\n+\n+        # Verify outputs once more; the wallet must have increased the existent change out value instead of removing it\n+        # in favor of a changeless solution\n+        dec_tx = wallet.decoderawtransaction(funded_tx['hex'])\n+        # assert inputs value\n+        assert_equal(len(dec_tx['vin']), 2)\n+        for input in dec_tx['vin']:\n+            assert_equal(wallet.gettransaction(input['txid'])['amount'], Decimal(50))\n+\n+        assert_equal(len(dec_tx['vout']), 2)\n+        for index in range(2):\n+            out = dec_tx['vout'][index]\n+            if index == change_pos:\n+                # Change must have increased its value, change = input - outputs - fee.\n+                assert_equal(out['value'], Decimal(100) - outputs[external_addr] - funded_tx['fee'])\n+                assert_equal(out['scriptPubKey']['address'], change_addr)\n+            else:\n+                # Non-change output must remain the same\n+                assert_equal(out['value'], outputs[external_addr])\n+                assert_equal(out['scriptPubKey']['address'], external_addr)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1230098983",
      "id" : 1230098983,
      "line" : 379,
      "node_id" : "PRRC_kwDOABII585JUdIn",
      "original_commit_id" : "7ec42848aa6033ae982dbf90ef33348c979c83e0",
      "original_line" : 379,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 72,
      "pull_request_review_id" : 1480176356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230098983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T19:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230098983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2023-06-23T17:01:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1604559997",
      "id" : 1604559997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27601",
      "node_id" : "IC_kwDOABII585fo6R9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1604559997/reactions"
      },
      "updated_at" : "2023-06-23T17:01:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1604559997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247203254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247203254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It depends on how the output was crafted. If it was created manually, it will not account for the fee. And also, it will not account for it if it was created in a previous `createTransaction` call with SFFO enabled.\r\n\r\nI think that is fine to \"overpay\" the fee at this line because later in the process (50 lines below) we check if the final fee is above the needed one, automatically increasing the change by the surplus if needed.",
      "commit_id" : "ffcfe0847fde1bc3eb11528729f6276f3a8e2037",
      "created_at" : "2023-06-29T21:42:40Z",
      "diff_hunk" : "@@ -987,14 +991,21 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n \n     const CAmount change_amount = result.GetChange(coin_selection_params.min_viable_change, coin_selection_params.m_change_fee);\n     if (change_amount > 0) {\n-        CTxOut newTxOut(change_amount, scriptChange);\n-        if (nChangePosInOut == -1) {\n-            // Insert change txn at random position:\n-            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-        } else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-            return util::Error{_(\"Transaction change output index out of range\")};\n+        if (existent_change_out_index) {\n+            // If there is an output with the change address already, increase that one instead of creating a new output\n+            txNew.vout.at(*existent_change_out_index).nValue += change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247203254",
      "id" : 1247203254,
      "in_reply_to_id" : 1230096522,
      "line" : 996,
      "node_id" : "PRRC_kwDOABII585KVs-2",
      "original_commit_id" : "6499c4c007019945f1f42c40f70c19b781a7ae64",
      "original_line" : 996,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 74,
      "pull_request_review_id" : 1506174314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247203254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-29T22:00:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247203254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247950494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, it gets cleaned at the end of the tx creation process (check https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247203254).\r\n\r\nBut new tests never hurt, so just added it inside 8f49902. Thanks for pushing me to do it.",
      "commit_id" : "ffcfe0847fde1bc3eb11528729f6276f3a8e2037",
      "created_at" : "2023-06-30T14:43:38Z",
      "diff_hunk" : "@@ -315,6 +316,67 @@ def test_change_type(self):\n         dec_tx = self.nodes[2].decoderawtransaction(rawtx['hex'])\n         assert_equal('witness_v0_keyhash', dec_tx['vout'][rawtx['changepos']]['scriptPubKey']['type'])\n \n+    def test_double_change(self):\n+        self.log.info(\"Test fundrawtxn funding a tx with an existent change output and the same custom change addr\")\n+        wallet = self.nodes[0]\n+\n+        # 1) fundrawtxn shouldn't create a second change output if there is one already going to that address\n+        change_addr = wallet.getrawchangeaddress()\n+        external_addr = wallet.getnewaddress()\n+        outputs = {external_addr: Decimal(40.0), change_addr: Decimal(3)}\n+        rawtx = wallet.createrawtransaction([], outputs)\n+        funded_tx = wallet.fundrawtransaction(hexstring=rawtx, options={'changeAddress': change_addr})\n+\n+        # Verify change output existence\n+        change_pos = funded_tx['changepos']\n+        assert change_pos != -1\n+\n+        # Verify outputs now; the wallet must have increased the existent change out value instead of creating a new one\n+        dec_tx = wallet.decoderawtransaction(funded_tx['hex'])\n+        assert_equal(wallet.gettransaction(dec_tx['vin'][0]['txid'])['amount'], Decimal(50))  # assert input value\n+        assert_equal(len(dec_tx['vout']), 2)\n+        for index in range(2):\n+            out = dec_tx['vout'][index]\n+            if index == change_pos:\n+                # Change must have increased its value, change = input - outputs - fee.\n+                assert_equal(out['value'], Decimal(50) - outputs[external_addr] - funded_tx['fee'])\n+                assert_equal(out['scriptPubKey']['address'], change_addr)\n+            else:\n+                # Non-change output must remain the same\n+                assert_equal(out['value'], outputs[external_addr])\n+                assert_equal(out['scriptPubKey']['address'], external_addr)\n+\n+        # 2) Fund tx and verify that the second output going to the change address is not discarded by the wallet\n+        #    changeless txs predilection. Even when the output is \"change\" under the wallet perspective, the user has\n+        #    set it manually, so it must not be discarded.\n+        outputs = {external_addr: Decimal(\"49.998\"), change_addr: Decimal(3)}\n+        rawtx = wallet.createrawtransaction([], outputs)\n+        funded_tx = wallet.fundrawtransaction(hexstring=rawtx, options={'changeAddress': change_addr})\n+\n+        # Verify change output existence\n+        change_pos = funded_tx['changepos']\n+        assert change_pos != -1\n+\n+        # Verify outputs once more; the wallet must have increased the existent change out value instead of removing it\n+        # in favor of a changeless solution\n+        dec_tx = wallet.decoderawtransaction(funded_tx['hex'])\n+        # assert inputs value\n+        assert_equal(len(dec_tx['vin']), 2)\n+        for input in dec_tx['vin']:\n+            assert_equal(wallet.gettransaction(input['txid'])['amount'], Decimal(50))\n+\n+        assert_equal(len(dec_tx['vout']), 2)\n+        for index in range(2):\n+            out = dec_tx['vout'][index]\n+            if index == change_pos:\n+                # Change must have increased its value, change = input - outputs - fee.\n+                assert_equal(out['value'], Decimal(100) - outputs[external_addr] - funded_tx['fee'])\n+                assert_equal(out['scriptPubKey']['address'], change_addr)\n+            else:\n+                # Non-change output must remain the same\n+                assert_equal(out['value'], outputs[external_addr])\n+                assert_equal(out['scriptPubKey']['address'], external_addr)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247950494",
      "id" : 1247950494,
      "in_reply_to_id" : 1230098983,
      "line" : 394,
      "node_id" : "PRRC_kwDOABII585KYjae",
      "original_commit_id" : "7ec42848aa6033ae982dbf90ef33348c979c83e0",
      "original_line" : 394,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 87,
      "pull_request_review_id" : 1507332746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950494/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-30T15:07:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247950832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "ffcfe0847fde1bc3eb11528729f6276f3a8e2037",
      "created_at" : "2023-06-30T14:43:57Z",
      "diff_hunk" : "@@ -884,6 +874,19 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         // change keypool ran out, but change is required.\n         CHECK_NONFATAL(IsValidDestination(dest) != scriptChange.empty());\n     }\n+\n+    // Gather total out and whether SFFO is enabled or not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1247950832",
      "id" : 1247950832,
      "in_reply_to_id" : 1230085873,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KYjfw",
      "original_commit_id" : "cc82f6f65a43711a36ab6b4635fc8d34082c0d4b",
      "original_line" : 878,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1507332746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950832/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-30T14:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247950832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1250387177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250387177"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't the fee for all outputs accounted for in `not_input_fees`? It seems to me this will always overpay and then will be corrected when we detect surplus fee.\r\n\r\nMaybe a clearer way to handle this would be to pass `chnage_fee=0` to `GetChange` if `existent_change_out_index=true`. I'd prefer to minimise number of cases when we need to correct fees at the later stage of transaction building. ",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-03T07:26:13Z",
      "diff_hunk" : "@@ -987,14 +991,21 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n \n     const CAmount change_amount = result.GetChange(coin_selection_params.min_viable_change, coin_selection_params.m_change_fee);\n     if (change_amount > 0) {\n-        CTxOut newTxOut(change_amount, scriptChange);\n-        if (nChangePosInOut == -1) {\n-            // Insert change txn at random position:\n-            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-        } else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-            return util::Error{_(\"Transaction change output index out of range\")};\n+        if (existent_change_out_index) {\n+            // If there is an output with the change address already, increase that one instead of creating a new output\n+            txNew.vout.at(*existent_change_out_index).nValue += change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1250387177",
      "id" : 1250387177,
      "in_reply_to_id" : 1230096522,
      "line" : 1003,
      "node_id" : "PRRC_kwDOABII585Kh2Tp",
      "original_commit_id" : "6499c4c007019945f1f42c40f70c19b781a7ae64",
      "original_line" : 1003,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 153,
      "pull_request_review_id" : 1510542857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250387177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T07:26:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250387177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "How would it work if coinselection produced result without change output? ",
      "created_at" : "2023-07-03T07:29:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1617526433",
      "id" : 1617526433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27601",
      "node_id" : "IC_kwDOABII585gaX6h",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1617526433/reactions"
      },
      "updated_at" : "2023-07-03T07:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1617526433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1250923477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250923477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Isn't the fee for all outputs accounted for in not_input_fees? It seems to me this will always overpay and then will be corrected when we detect surplus fee.\r\n>\r\n> Maybe a clearer way to handle this would be to pass chnage_fee=0 to GetChange if existent_change_out_index=true. I'd prefer to minimise number of cases when we need to correct fees at the later stage of transaction building.\r\n\r\nGood point.\r\nCould go further and set the coin control `m_change_fee` and `min_viable_change` to 0 so coin selection produces results closer to the target (and don't drop any sats).\r\nAnd also, another improvement idea would be to set the `change_cost` to 0 as well. But.. that would need further modifications, so probably for a follow-up, because the waste calculation is not contemplating this scenario.",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-03T13:49:35Z",
      "diff_hunk" : "@@ -987,14 +991,21 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n \n     const CAmount change_amount = result.GetChange(coin_selection_params.min_viable_change, coin_selection_params.m_change_fee);\n     if (change_amount > 0) {\n-        CTxOut newTxOut(change_amount, scriptChange);\n-        if (nChangePosInOut == -1) {\n-            // Insert change txn at random position:\n-            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-        } else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-            return util::Error{_(\"Transaction change output index out of range\")};\n+        if (existent_change_out_index) {\n+            // If there is an output with the change address already, increase that one instead of creating a new output\n+            txNew.vout.at(*existent_change_out_index).nValue += change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1250923477",
      "id" : 1250923477,
      "in_reply_to_id" : 1230096522,
      "line" : 1003,
      "node_id" : "PRRC_kwDOABII585Kj5PV",
      "original_commit_id" : "6499c4c007019945f1f42c40f70c19b781a7ae64",
      "original_line" : 1003,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 153,
      "pull_request_review_id" : 1511239594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250923477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T14:09:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1250923477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From CI https://cirrus-ci.com/task/4675435070488576?logs=ci#L3365:\r\n\r\n```\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/wallet_fundrawtransaction.py\", line 337, in test_double_change\r\n                                       assert_equal(wallet.gettransaction(desc_tx['vin'][0]['txid'])['amount'], Decimal(50))  # assert input value\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/util.py\", line 57, in assert_equal\r\n                                       raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\n                                   AssertionError: not(0E-8 == 50)",
      "created_at" : "2023-07-04T17:38:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1620572868",
      "id" : 1620572868,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27601",
      "node_id" : "IC_kwDOABII585gl_rE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1620572868/reactions"
      },
      "updated_at" : "2023-07-04T17:38:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1620572868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1264962807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264962807"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 9dc5bbe042f4d1febde8753a8c56da35eedd9d3e\r\n\r\nI know this preserves current behaviour, but don't we want to use `long_term_fee_rate` to determine cost of change?\r\n\r\n@murchandamus ",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-17T07:15:21Z",
      "diff_hunk" : "@@ -919,21 +916,24 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{strprintf(_(\"Fee estimation failed. Fallbackfee is disabled. Wait a few blocks or enable %s.\"), \"-fallbackfee\")};\n     }\n \n+    // When the cost to spend a change output at the discard feerate exceeds its value, drop it to fees.\n+    CFeeRate discard_feerate = GetDiscardRate(wallet);\n+\n     // Calculate the cost of change\n     // Cost of change is the cost of creating the change output + cost of spending the change output in the future.\n     // For creating the change output now, we use the effective feerate.\n     // For spending the change output in the future, we use the discard feerate for now.\n     // So cost of change = (change output size * effective feerate) + (size of spending change output * discard feerate)\n     coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n-    coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(change_spend_size) + coin_selection_params.m_change_fee;\n+    coin_selection_params.m_cost_of_change = discard_feerate.GetFee(change_spend_size) + coin_selection_params.m_change_fee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1264962807",
      "id" : 1264962807,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LZcz3",
      "original_commit_id" : "9dc5bbe042f4d1febde8753a8c56da35eedd9d3e",
      "original_line" : 928,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1532133649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264962807/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T07:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264962807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1264968527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264968527"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in ea57562b4ab4071fd1a716f09e13d19ff68e99f1\r\n\r\nI see how it's useful for the next commit, but the contract of the method is not really clear without reading the code.",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-17T07:22:15Z",
      "diff_hunk" : "@@ -819,6 +819,41 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static void ComputeChangeParams(CoinSelectionParams& coin_selection_params, CWallet& wallet, const CScript& scriptChange, CAmount recipients_sum, size_t recipients_size)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1264968527",
      "id" : 1264968527,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII585LZeNP",
      "original_commit_id" : "ea57562b4ab4071fd1a716f09e13d19ff68e99f1",
      "original_line" : 822,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1532142635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264968527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T07:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264968527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach ACK\r\n\r\nI think setting change related params to 0 in case where we reuse existing output is the correct way to go.",
      "created_at" : "2023-07-17T07:32:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#issuecomment-1637521709",
      "id" : 1637521709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27601",
      "node_id" : "IC_kwDOABII585hmpkt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637521709/reactions"
      },
      "updated_at" : "2023-07-17T07:32:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637521709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1265351007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265351007"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Guess that you are referring to the last two args?\r\n\r\nI think that it isn't much of a problem because it is an internal static helper function.\r\n\r\nThey are needed for Knapsack min change target calculation. What maybe could do is to pass them as one: `mean_amount = std::floor(recipients_sum / recipients_size)` and document the function properly.\r\n\r\nAnd also, in a follow-up, we could go further and move the else branch of the `scriptChange` block of code inside `ComputeChangeParams` too. That part is only needed when there isn't an existent change output.",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-17T13:25:11Z",
      "diff_hunk" : "@@ -819,6 +819,41 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static void ComputeChangeParams(CoinSelectionParams& coin_selection_params, CWallet& wallet, const CScript& scriptChange, CAmount recipients_sum, size_t recipients_size)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1265351007",
      "id" : 1265351007,
      "in_reply_to_id" : 1264968527,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII585La7lf",
      "original_commit_id" : "ea57562b4ab4071fd1a716f09e13d19ff68e99f1",
      "original_line" : 822,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1532781263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265351007/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T13:26:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265351007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1266301780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266301780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Let's document which part of `CoinSelectionParams` is modified and which is not.",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-18T06:39:26Z",
      "diff_hunk" : "@@ -819,6 +819,41 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static void ComputeChangeParams(CoinSelectionParams& coin_selection_params, CWallet& wallet, const CScript& scriptChange, CAmount recipients_sum, size_t recipients_size)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1266301780",
      "id" : 1266301780,
      "in_reply_to_id" : 1264968527,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII585LejtU",
      "original_commit_id" : "ea57562b4ab4071fd1a716f09e13d19ff68e99f1",
      "original_line" : 822,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1534298080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266301780/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T06:39:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266301780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1266754466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266754466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Let's document which part of CoinSelectionParams is modified and which is not.\r\n\r\n@S3RK. `CoinSelectionParams` wasn't modified. Only change related code was moved from `CreateTransactionInternal` to `ComputeChangeParams`.",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-18T13:11:46Z",
      "diff_hunk" : "@@ -819,6 +819,41 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static void ComputeChangeParams(CoinSelectionParams& coin_selection_params, CWallet& wallet, const CScript& scriptChange, CAmount recipients_sum, size_t recipients_size)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1266754466",
      "id" : 1266754466,
      "in_reply_to_id" : 1264968527,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII585LgSOi",
      "original_commit_id" : "ea57562b4ab4071fd1a716f09e13d19ff68e99f1",
      "original_line" : 822,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1535007122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266754466/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T13:11:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266754466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1267625784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267625784"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I mean `ComputeChangeParams` computes some of `CoinSelectionParams`, but it's not immediately obvious which ones without reading the code of the function ",
      "commit_id" : "06e0248cb87db14c54bd4e4f4256ce955c150c57",
      "created_at" : "2023-07-19T07:03:17Z",
      "diff_hunk" : "@@ -819,6 +819,41 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static void ComputeChangeParams(CoinSelectionParams& coin_selection_params, CWallet& wallet, const CScript& scriptChange, CAmount recipients_sum, size_t recipients_size)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27601#discussion_r1267625784",
      "id" : 1267625784,
      "in_reply_to_id" : 1264968527,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII585Ljm84",
      "original_commit_id" : "ea57562b4ab4071fd1a716f09e13d19ff68e99f1",
      "original_line" : 822,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1536386673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27601",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267625784/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-19T07:03:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267625784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
